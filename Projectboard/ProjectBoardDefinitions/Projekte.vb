Imports Microsoft.Office.Interop
'Imports Microsoft.Office.Interop.Excel
Imports System.Windows.Forms
Imports core = Microsoft.Office.Core
Imports xlNS = Microsoft.Office.Interop.Excel
'Imports pptNS = Microsoft.Office.Interop.PowerPoint
Imports System.ComponentModel
Imports Microsoft.VisualBasic.Constants

Imports System.Globalization


Public Module Projekte


    ''' <summary>
    ''' zeigt den Vergleich zwischen zwei Items an; Ausgang können zwei Projekt-Varianten sein, aber 
    ''' auch der Vergleich zwischen zwei Konstellationen zum Beispiel 
    ''' </summary>
    ''' <param name="name1">1. Bezeichner des Vergleiches </param>
    ''' <param name="values1">Werte, bezogen auf comparisonItem, für den 1. Bezeichner</param>
    ''' <param name="name2">2. Bezeichner des Vergleiches</param>
    ''' <param name="values2">Werte, bezogen auf comparisonItem, für den 2. Bezeichner</param>
    ''' <param name="comparisonItem">wofür stehen die Werte: Rolle, Kostenart, Kennzahl, etc. </param>
    ''' <param name="massEinheit">meist entweder T€ oder MM</param>
    ''' <param name="top">Platzierungs-Info für das Chart</param>
    ''' <param name="left">Platzierungs-Info für das Chart</param>
    ''' <param name="width">Platzierungs-Info für das Chart</param>
    ''' <param name="height">Platzierungs-Info für das Chart</param>
    ''' <remarks></remarks>
    Public Sub ShowDiagramCompare(ByRef name1 As String, ByRef values1() As Double, ByRef name2 As String, ByRef values2() As Double, ByRef comparisonItem As String, ByRef massEinheit As String, _
                               ByVal top As Double, ByVal left As Double, ByVal width As Double, ByVal height As Double)
        Dim diagramtitle As String, chtTitle As String
        Dim sum1 As Double, sum2 As Double, diff As Double
        Dim array1() As Double, array2() As Double
        Dim maxlength As Integer = System.Math.Max(values1.Length, values2.Length)
        Dim minlength As Integer = System.Math.Min(values1.Length, values2.Length)
        Dim maxscale As Integer
        Dim i As Integer
        Dim Xdatenreihe() As String
        Dim anzDiagrams As Integer


        Dim majorUnit As Integer

        Dim maxValue As Double = System.Math.Max(values1.Max, values2.Max)
        height = System.Math.Max(40 + System.Math.Log(maxValue), 100)
        'majorUnit = System.Math.Max(maxValue / 5, 2)
        maxscale = CInt(System.Math.Max(10, maxValue * 1.3))

        If maxscale < 100 Then
            maxscale = CInt(System.Math.Round(maxscale / 10, MidpointRounding.ToEven) * 10)
        Else
            maxscale = CInt(System.Math.Round(maxscale / 100, MidpointRounding.ToEven) * 100)
        End If

        If maxscale < 10 Then maxscale = 10
        majorUnit = CInt(maxscale / 4)


        

        Dim formerEE As Boolean = appInstance.EnableEvents
        Dim formerSU As Boolean = appInstance.ScreenUpdating


        ReDim Xdatenreihe(maxlength - 1)

        ReDim array1(maxlength - 1)
        ReDim array2(maxlength - 1)

        ' Format(diff, "##,##0")
        sum1 = values1.Sum
        sum2 = values2.Sum
        diff = sum1 - sum2

        For i = 1 To maxlength
            'Xdatenreihe(i - 1) = StartofCalendar.AddMonths(pstart + i - 2).ToString("MMM yy")
            Xdatenreihe(i - 1) = i.ToString
        Next i


        If name2 = "" Then ' es handelt sich um den Vergleich mit der Beauftragung
            
            diagramtitle = comparisonItem & " ( " & Format(sum1, "#,###,0") & " - " & Format(sum2, "#,###,0") & " = " & Format(diff, "###,0") & " " & massEinheit & " )"

        Else

            diagramtitle = comparisonItem & " ( " & Format(sum1, "#,###,0") & " - " & Format(sum2, "#,###,0") & " = " & Format(diff, "###,0") & " " & massEinheit & " )" 

        End If

        ' Kopieren der Werte in Array1
        For i = 0 To values1.Length - 1
            array1(i) = values1(i)
        Next i

        For i = 0 To values2.Length - 1
            array2(i) = values2(i)
        Next i


        Dim found As Boolean

        If formerEE Then
            appInstance.EnableEvents = False
        End If

        If formerSU Then
            appInstance.ScreenUpdating = False
        End If

        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            found = False
            While i <= anzDiagrams And Not found
                Try
                    chtTitle = CType(.ChartObjects(i), Excel.ChartObject).Chart.ChartTitle.Text
                Catch ex As Exception
                    chtTitle = " "
                End Try
                If chtTitle = diagramtitle Then
                    found = True
                Else
                    i = i + 1
                End If

            End While

            If found Then
                appInstance.EnableEvents = formerEE
                appInstance.ScreenUpdating = formerSU
                Throw New ArgumentException("Diagramm wird schon angezeigt ...")
            Else

                With appInstance.Charts.Add
                    ' remove extra series
                    Do Until CType(.SeriesCollection, Excel.SeriesCollection).Count = 0
                        CType(.SeriesCollection(1), Excel.Series).Delete()
                    Loop



                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                        .Name = name1
                        .Interior.Color = vergleichsfarbe1
                        .Values = array1
                        .XValues = Xdatenreihe
                        ' Unterschied farblich hervorheben ...
                        For ix = 1 To maxlength
                            If array1(ix - 1) = array2(ix - 1) Then
                                With .Points(ix)
                                    .Interior.Color = vergleichsfarbe0
                                End With
                            End If
                        Next
                        .ChartType = Excel.XlChartType.xlColumnClustered
                    End With

                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                        .Name = name2
                        .Interior.Color = vergleichsfarbe2
                        .Values = array2
                        .XValues = Xdatenreihe
                        ' Unterschied farblich hervorheben ...
                        For ix = 1 To maxlength
                            If array1(ix - 1) = array2(ix - 1) Then
                                With .Points(ix)
                                    .Interior.Color = vergleichsfarbe0
                                End With
                            End If
                        Next
                        .ChartType = Excel.XlChartType.xlColumnClustered
                    End With


                    .HasAxis(Excel.XlAxisType.xlCategory) = True
                    .HasAxis(Excel.XlAxisType.xlValue) = True

                    'für test-zwecke 
                    'Dim ax As Excel.Axes
                    'With ax
                    '    .Item(Excel.XlAxisType.xlCategory).Format.TextFrame2.TextRange.Font.Size = 8
                    '    .Item(Excel.XlAxisType.xlValue).
                    'End With

                    With CType(.Axes(Excel.XlAxisType.xlCategory), Excel.Axis)
                        .HasTitle = False
                        '.MinimumScale = 0

                        '.Format.TextFrame2.TextRange.Font.Size = MsoAutoSize.msoAutoSizeTextToFitShape
                        'With .AxisTitle
                        '    .Characters.text = "Monate"
                        '    .Font.Size = 8
                        '    '.Font.Size = MsoAutoSize.msoAutoSizeTextToFitShape
                        'End With
                        'Try
                        '    .Format.TextFrame2.TextRange.Font.Size = 8
                        'Catch ex As Exception

                        'End Try
                    End With

                    With CType(.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                        .HasTitle = False
                        .MinimumScale = 0
                        .HasMinorGridlines = False
                        .HasMajorGridlines = True
                        .MajorUnit = majorUnit

                        '.Format.TextFrame2.TextRange.Font.Size = MsoAutoSize.msoAutoSizeTextToFitShape
                        'With .AxisTitle
                        '    .Characters.text = comparisonItem
                        '    .Font.Size = 8
                        '    '.Font.Size = MsoAutoSize.msoAutoSizeTextToFitShape
                        'End With
                        'Try
                        '    .Format.TextFrame2.TextRange.Font.Size = 8
                        'Catch ex As Exception

                        'End Try

                    End With

                    .HasLegend = True
                    With .Legend
                        .Position = Excel.XlLegendPosition.xlLegendPositionTop
                        .Font.Size = 10
                        '.Font.Size = MsoAutoSize.msoAutoSizeTextToFitShape
                    End With

                    .HasTitle = True
                    With .ChartTitle
                        .Text = diagramtitle
                        .Font.Size = 12
                        '.Font.Size = MsoAutoSize.msoAutoSizeTextToFitShape
                    End With


                    Dim achieved As Boolean = False
                    Dim anzahlVersuche As Integer = 0
                    Dim errmsg As String = ""
                    Do While Not achieved And anzahlVersuche < 10
                        Try
                            'Call Sleep(100)
                            .Location(Where:=xlNS.XlChartLocation.xlLocationAsObject, Name:=CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Name)
                            achieved = True
                        Catch ex As Exception
                            errmsg = ex.Message
                            'Call Sleep(100)
                            anzahlVersuche = anzahlVersuche + 1
                        End Try
                    Loop

                    If Not achieved Then
                        Throw New ArgumentException("Chart-Fehler:" & errmsg)
                    End If


                End With

                ' jetzt kommt die Korrektur der Größe; herausfinden, wieviel Raum die Axis Beschriftung einnimmt ... 
                With CType(.ChartObjects(anzDiagrams + 1), Excel.ChartObject)
                    .Top = top
                    .Height = 2 * height

                    Dim axleft As Double, axwidth As Double
                    If CBool(.Chart.HasAxis(Excel.XlAxisType.xlValue)) Then
                        With CType(.Chart.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                            axleft = .Left
                            axwidth = .Width
                        End With
                        If left - axwidth < 1 Then
                            left = 1
                            width = width + left + 9
                        Else
                            left = left - axwidth
                            width = width + axwidth + 9
                        End If

                    End If

                    .Left = left
                    .Width = width


                End With

                'With .ChartObjects(anzDiagrams + 1)
                '    .top = top
                '    .left = left
                '    .height = height
                '    .width = width
                'End With


            End If


        End With


        appInstance.EnableEvents = formerEE
        appInstance.ScreenUpdating = formerSU

    End Sub

    Public Sub ShowDiagramCompare1(ByRef name1 As String, ByRef values1() As Double, ByRef name2 As String, ByRef values2() As Double, ByRef comparisonItem As String, ByRef massEinheit As String, _
                               ByVal top As Double, ByVal left As Double, ByVal width As Double, ByVal height As Double)
        Dim diagramtitle As String, chtTitle As String
        Dim sum1 As Double, sum2 As Double, diff As Double
        Dim array0() As Double, array1() As Double, array2() As Double
        Dim maxlength As Integer = System.Math.Max(values1.Length, values2.Length)
        Dim minlength As Integer = System.Math.Min(values1.Length, values2.Length)
        Dim maxscale As Integer
        Dim i As Integer
        Dim Xdatenreihe() As String
        Dim anzDiagrams As Integer


        Dim majorUnit As Integer

        Dim maxValue As Double = System.Math.Max(values1.Max, values2.Max)
        height = System.Math.Max(40 + System.Math.Log(maxValue), 100)
        'majorUnit = System.Math.Max(maxValue / 5, 2)
        maxscale = CInt(System.Math.Max(10, maxValue * 1.3))

        If maxscale < 100 Then
            maxscale = CInt(System.Math.Round(maxscale / 10, MidpointRounding.ToEven) * 10)
        Else
            maxscale = CInt(System.Math.Round(maxscale / 100, MidpointRounding.ToEven) * 100)
        End If

        If maxscale < 10 Then maxscale = 10
        majorUnit = CInt(maxscale / 4)




        Dim formerEE As Boolean = appInstance.EnableEvents
        Dim formerSU As Boolean = appInstance.ScreenUpdating


        ReDim Xdatenreihe(maxlength - 1)
        ReDim array0(maxlength - 1)
        ReDim array1(maxlength - 1)
        ReDim array2(maxlength - 1)

        ' Format(diff, "##,##0")
        sum1 = values1.Sum
        sum2 = values2.Sum
        diff = sum1 - sum2

        For i = 1 To maxlength
            'Xdatenreihe(i - 1) = StartofCalendar.AddMonths(pstart + i - 2).ToString("MMM yy")
            Xdatenreihe(i - 1) = i.ToString
        Next i


        If name2 = "" Then ' es handelt sich um den Vergleich mit der Beauftragung
            diagramtitle = comparisonItem & " ( " & Format(sum1, "#,###,0") & " - " & Format(sum2, "#,###,0") & " = " & Format(diff, "###,0") & " " & massEinheit & " )" & vbLf & _
                                                name1 & " versus Beauftragung"
        Else

            diagramtitle = comparisonItem & " ( " & Format(sum1, "#,###,0") & " - " & Format(sum2, "#,###,0") & " = " & Format(diff, "###,0") & " " & massEinheit & " )" & vbLf & _
                                                name1 & " versus " & name2

        End If


        For i = 0 To minlength - 1
            If values1(i) >= values2(i) Then
                array0(i) = values2(i)
                array1(i) = values1(i) - values2(i)
                array2(i) = 0
            Else
                array0(i) = values1(i)
                array1(i) = 0
                array2(i) = values2(i) - values1(i)
            End If
        Next i

        If values1.Length > values2.Length Then
            For i = minlength To maxlength - 1
                array1(i) = values1(i)
            Next
        ElseIf values1.Length < values2.Length Then
            For i = minlength To maxlength - 1
                array2(i) = values2(i)
            Next
        End If

        Dim found As Boolean

        If formerEE Then
            appInstance.EnableEvents = False
        End If

        If formerSU Then
            appInstance.ScreenUpdating = False
        End If

        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            found = False
            While i <= anzDiagrams And Not found
                Try
                    chtTitle = CType(.ChartObjects(i), Excel.ChartObject).Chart.ChartTitle.Text
                Catch ex As Exception
                    chtTitle = " "
                End Try
                If chtTitle = diagramtitle Then
                    found = True
                Else
                    i = i + 1
                End If

            End While

            If found Then
                appInstance.EnableEvents = formerEE
                appInstance.ScreenUpdating = formerSU
                Throw New ArgumentException("Diagramm wird schon angezeigt ...")
            Else

                With appInstance.Charts.Add
                    ' remove extra series
                    Do Until CType(.SeriesCollection, Excel.SeriesCollection).Count = 0
                        CType(.SeriesCollection(1), Excel.Series).Delete()
                    Loop


                    'series
                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                        .Name = "identisch"
                        .Interior.Color = vergleichsfarbe0
                        .Values = array0
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlColumnStacked
                    End With


                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                        '.name = "mehr"
                        .Name = name1
                        .Interior.Color = vergleichsfarbe1
                        .Values = array1
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlColumnStacked
                    End With

                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                        '.name = "weniger"
                        .Name = name2
                        .Interior.Color = vergleichsfarbe2
                        .Values = array2
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlColumnStacked
                    End With


                    .HasAxis(Excel.XlAxisType.xlCategory) = True
                    .HasAxis(Excel.XlAxisType.xlValue) = True

                    'für test-zwecke 
                    'Dim ax As Excel.Axes
                    'With ax
                    '    .Item(Excel.XlAxisType.xlCategory).Format.TextFrame2.TextRange.Font.Size = 8
                    '    .Item(Excel.XlAxisType.xlValue).
                    'End With

                    With CType(.Axes(Excel.XlAxisType.xlCategory), Excel.Axis)
                        .HasTitle = False
                        '.MinimumScale = 0

                        '.Format.TextFrame2.TextRange.Font.Size = MsoAutoSize.msoAutoSizeTextToFitShape
                        'With .AxisTitle
                        '    .Characters.text = "Monate"
                        '    .Font.Size = 8
                        '    '.Font.Size = MsoAutoSize.msoAutoSizeTextToFitShape
                        'End With
                        'Try
                        '    .Format.TextFrame2.TextRange.Font.Size = 8
                        'Catch ex As Exception

                        'End Try
                    End With

                    With CType(.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                        .HasTitle = False
                        .MinimumScale = 0
                        .HasMinorGridlines = False
                        .HasMajorGridlines = True
                        .MajorUnit = majorUnit

                        '.Format.TextFrame2.TextRange.Font.Size = MsoAutoSize.msoAutoSizeTextToFitShape
                        'With .AxisTitle
                        '    .Characters.text = comparisonItem
                        '    .Font.Size = 8
                        '    '.Font.Size = MsoAutoSize.msoAutoSizeTextToFitShape
                        'End With
                        'Try
                        '    .Format.TextFrame2.TextRange.Font.Size = 8
                        'Catch ex As Exception

                        'End Try

                    End With

                    .HasLegend = True
                    With .Legend
                        .Position = Excel.XlLegendPosition.xlLegendPositionTop
                        .Font.Size = 10
                        '.Font.Size = MsoAutoSize.msoAutoSizeTextToFitShape
                    End With

                    .HasTitle = True
                    With .ChartTitle
                        .Text = diagramtitle
                        .Font.Size = 12
                        '.Font.Size = MsoAutoSize.msoAutoSizeTextToFitShape
                    End With

                    Dim achieved As Boolean = False
                    Dim anzahlVersuche As Integer = 0
                    Dim errmsg As String = ""
                    Do While Not achieved And anzahlVersuche < 10
                        Try
                            'Call Sleep(100)
                            .Location(Where:=xlNS.XlChartLocation.xlLocationAsObject, Name:=CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Name)
                            achieved = True
                        Catch ex As Exception
                            errmsg = ex.Message
                            'Call Sleep(100)
                            anzahlVersuche = anzahlVersuche + 1
                        End Try
                    Loop

                    If Not achieved Then
                        Throw New ArgumentException("Chart-Fehler:" & errmsg)
                    End If

                End With

                ' jetzt kommt die Korrektur der Größe; herausfinden, wieviel Raum die Axis Beschriftung einnimmt ... 
                With CType(.ChartObjects(anzDiagrams + 1), Excel.ChartObject)
                    .Top = top
                    .Height = 2 * height

                    Dim axleft As Double, axwidth As Double
                    If CBool(.Chart.HasAxis(Excel.XlAxisType.xlValue)) Then
                        With CType(.Chart.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                            axleft = .Left
                            axwidth = .Width
                        End With
                        If left - axwidth < 1 Then
                            left = 1
                            width = width + left + 9
                        Else
                            left = left - axwidth
                            width = width + axwidth + 9
                        End If

                    End If

                    .Left = left
                    .Width = width


                End With

                'With .ChartObjects(anzDiagrams + 1)
                '    .top = top
                '    .left = left
                '    .height = height
                '    .width = width
                'End With


            End If


        End With


        appInstance.EnableEvents = formerEE
        appInstance.ScreenUpdating = formerSU

    End Sub


    ''' <summary>
    ''' zeigt den Vergleich zwischen zwei Items an; Ausgang können zwei Projekt-Varianten sein, aber 
    ''' auch der Vergleich zwischen zwei Konstellationen zum Beispiel ; 
    ''' gezeigt wird nur das Delta , nicht auch der identische Anteil 
    ''' </summary>
    ''' <param name="name1">1. Bezeichner des Vergleiches </param>
    ''' <param name="values1">Werte, bezogen auf comparisonItem, für den 1. Bezeichner</param>
    ''' <param name="name2">2. Bezeichner des Vergleiches</param>
    ''' <param name="values2">Werte, bezogen auf comparisonItem, für den 2. Bezeichner</param>
    ''' <param name="comparisonItem">wofür stehen die Werte: Rolle, Kostenart, Kennzahl, etc. </param>
    ''' <param name="massEinheit">meist entweder T€ oder MM</param>
    ''' <param name="top">Platzierungs-Info für das Chart</param>
    ''' <param name="left">Platzierungs-Info für das Chart</param>
    ''' <param name="width">Platzierungs-Info für das Chart</param>
    ''' <param name="height">Platzierungs-Info für das Chart</param>
    ''' <remarks></remarks>
    Public Sub ShowDiagramCompare2(ByRef name1 As String, ByRef values1() As Double, ByRef name2 As String, ByRef values2() As Double, ByRef comparisonItem As String, ByRef massEinheit As String, _
                               ByVal top As Double, ByVal left As Double, ByVal width As Double, ByVal height As Double)
        ' wenn das weider verwendet wird: erst anpassen Berechnung left und width  wie in compareDiagram

        Dim diagramtitle As String, chtTitle As String
        Dim sum1 As Double
        Dim array0() As Double, array1() As Double, array2() As Double
        Dim maxlength As Integer = System.Math.Max(values1.Length, values2.Length)
        Dim minlength As Integer = System.Math.Min(values1.Length, values2.Length)
        Dim i As Integer
        Dim Xdatenreihe() As String
        Dim anzDiagrams As Integer

        Dim formerEE As Boolean = appInstance.EnableEvents
        Dim formerSU As Boolean = appInstance.ScreenUpdating



        'Try
        '    pstart = ShowProjekte.getProject(name1).Start
        'Catch ex As Exception
        '    Call MsgBox("Fehler in ShowDiagramCompare beim Auslesen des Starts...")
        '    Exit Sub
        'End Try

        ReDim Xdatenreihe(maxlength - 1)
        ReDim array0(maxlength - 1)
        ReDim array1(maxlength - 1)
        ReDim array2(maxlength - 1)


        'sum1 = values1.Sum
        'sum2 = values2.Sum

        'For i = 1 To maxlength
        '    Xdatenreihe(i - 1) = "" & i.ToString
        'Next

        For i = 1 To maxlength
            'Xdatenreihe(i - 1) = StartofCalendar.AddMonths(pstart + i - 2).ToString("MMM yy")
            Xdatenreihe(i - 1) = i.ToString
        Next i

        For i = 0 To minlength - 1
            array1(i) = values1(i) - values2(i)
        Next i

        If values1.Length > values2.Length Then
            For i = minlength To maxlength - 1
                array1(i) = values1(i)
            Next
        ElseIf values1.Length < values2.Length Then
            For i = minlength To maxlength - 1
                array1(i) = values2(i) * -1
            Next
        End If

        sum1 = array1.Sum
        diagramtitle = "Übersicht Mehr- bzw. Minder-Aufwände im Vergleich zur Beauftragung/Vergleichsprojekt" & vbLf _
                       & name1 & " (" & sum1.ToString & " " & massEinheit & ") " & vbLf _
                       & "bezogen auf " & comparisonItem

        ' Format(maxwert, "##,##0")

        Dim found As Boolean

        If formerEE Then
            appInstance.EnableEvents = False
        End If

        If formerSU Then
            appInstance.ScreenUpdating = False
        End If

        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            found = False
            While i <= anzDiagrams And Not found
                Try
                    chtTitle = CType(.ChartObjects(i), Excel.ChartObject).Chart.ChartTitle.Text
                Catch ex As Exception
                    chtTitle = " "
                End Try
                If chtTitle = diagramtitle Then
                    found = True
                Else
                    i = i + 1
                End If

            End While

            If found Then
                MsgBox(" Diagramm wird bereits angezeigt ...")
            Else

                With appInstance.Charts.Add
                    ' remove extra series
                    Do Until CType(.SeriesCollection, Excel.SeriesCollection).Count = 0
                        CType(.SeriesCollection(1), Excel.Series).Delete()
                    Loop


                    'series
                    'With .SeriesCollection.NewSeries
                    '    .name = "identischer Teil"
                    '    .Interior.color = vergleichsfarbe0
                    '    .Values = array0
                    '    .XValues = Xdatenreihe
                    '    .ChartType = Excel.XlChartType.xlColumnStacked
                    'End With

                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                        .Name = name1
                        .Interior.Color = vergleichsfarbe1
                        .Values = array1
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlColumnClustered
                    End With

                    'With .SeriesCollection.NewSeries
                    '    .name = name2 & " ist größer"
                    '    .Interior.color = vergleichsfarbe2
                    '    .Values = array2
                    '    .XValues = Xdatenreihe
                    '    .ChartType = Excel.XlChartType.xlColumnStacked
                    'End With


                    .HasAxis(Excel.XlAxisType.xlCategory) = False
                    .HasAxis(Excel.XlAxisType.xlValue) = True

                    With CType(.Axes(Excel.XlAxisType.xlCategory), Excel.Axis)
                        .HasTitle = True
                        '.MinimumScale = 0
                        With .AxisTitle
                            .Characters.Text = "Monate"
                            .Font.Size = 8
                        End With
                    End With

                    With CType(.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                        .HasTitle = True
                        '.MinimumScale = 0
                        With .AxisTitle
                            .Characters.Text = comparisonItem
                            .Font.Size = 8
                        End With
                    End With

                    .HasLegend = True
                    With .Legend
                        .Position = Excel.XlLegendPosition.xlLegendPositionTop
                        .Font.Size = 8
                    End With

                    .HasTitle = True
                    With .ChartTitle
                        .Text = diagramtitle
                        .Font.Size = 10
                    End With

                    Dim achieved As Boolean = False
                    Dim anzahlVersuche As Integer = 0
                    Dim errmsg As String = ""
                    Do While Not achieved And anzahlVersuche < 10
                        Try
                            'Call Sleep(100)
                            .Location(Where:=xlNS.XlChartLocation.xlLocationAsObject, Name:=CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Name)
                            achieved = True
                        Catch ex As Exception
                            errmsg = ex.Message
                            'Call Sleep(100)
                            anzahlVersuche = anzahlVersuche + 1
                        End Try
                    Loop

                    If Not achieved Then
                        Throw New ArgumentException("Chart-Fehler:" & errmsg)
                    End If



                End With

                With CType(.ChartObjects(anzDiagrams + 1), Excel.ChartObject)
                    .Top = top
                    .Left = left
                    .Height = height
                    .Width = width
                End With


            End If


        End With


        appInstance.EnableEvents = formerEE
        appInstance.ScreenUpdating = formerSU

    End Sub

    ''' <summary>
    ''' zeigt die Phasen Verläufe eines Projektes an
    ''' </summary>
    ''' <param name="noColorCollection" >enthält die Namen der Phasen, die ohne Farbe dargestellt werden sollen</param>
    ''' <param name="hproj"></param>
    ''' <param name="repObj"></param>
    ''' <param name="maxscale"></param>
    ''' <param name="top"></param>
    ''' <param name="left"></param>
    ''' <param name="height"></param>
    ''' <param name="width"></param>
    ''' <param name="auswahl"></param>
    ''' <remarks>wenn hier etwas geändert wird, muss auch in updatePhasesBalken geändert werden ... 
    ''' </remarks>
    Public Sub createPhasesBalken(ByVal noColorCollection As Collection, ByVal hproj As clsProjekt, ByRef repObj As Excel.ChartObject, ByVal maxscale As Double, _
                                      ByVal top As Double, ByVal left As Double, ByVal height As Double, ByVal width As Double, ByVal auswahl As Integer)
        Dim diagramTitle As String
        Dim anzDiagrams As Integer
        Dim anzPhasen As Integer
        Dim found As Boolean
        Dim plenInDays As Integer
        Dim i As Integer
        Dim Xdatenreihe() As String
        Dim valueColor() As Object
        Dim tdatenreihe1() As Double, mdatenreihe() As Double, tdatenreihe2() As Double, tdatenreihe3() As Double
        Dim kennung As String
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim noFarbe As Long = awinSettings.AmpelNichtBewertet
        Dim tmpcollection As New Collection
        Dim pName As String = hproj.name



        Dim formerEE As Boolean = appInstance.EnableEvents
        'Dim formerSU As Boolean = appInstance.ScreenUpdating
        appInstance.EnableEvents = False
        'appInstance.ScreenUpdating = False

        tmpcollection.Add(hproj.name & "#" & auswahl.ToString)
        kennung = calcChartKennung("pr", PTprdk.Phasen, tmpcollection)

        Try
            If auswahl = PThis.vorlage Then
                'titelTeile(0) = "Vorlage " & hproj.VorlagenName & vbLf
                titelTeile(0) = repMessages.getmsg(42) & hproj.VorlagenName & vbLf
                titelTeile(1) = " "
                'kennung = hproj.VorlagenName.Trim & "#Phasen#1"



            ElseIf auswahl = PThis.beauftragung Then
                'titelTeile(0) = "Beauftragung " & hproj.startDate.ToShortDateString & _
                '                     " - " & hproj.startDate.AddDays(hproj.dauerInDays - 1).ToShortDateString & vbLf
                titelTeile(0) = repMessages.getmsg(43) & hproj.startDate.ToShortDateString & _
                                     " - " & hproj.startDate.AddDays(hproj.dauerInDays - 1).ToShortDateString & vbLf
                titelTeile(1) = " (" & hproj.timeStamp.ToString & ") "
                'kennung = hproj.name.Trim & "Beauftragung" & "#Phasen#1"

            ElseIf auswahl = PThis.letzterStand Then
                'titelTeile(0) = "letzter Stand " & hproj.startDate.ToShortDateString & _
                '                     " - " & hproj.startDate.AddDays(hproj.dauerInDays - 1).ToShortDateString & vbLf
                titelTeile(0) = repMessages.getmsg(44) & hproj.startDate.ToShortDateString & _
                                     " - " & hproj.startDate.AddDays(hproj.dauerInDays - 1).ToShortDateString & vbLf
                titelTeile(1) = " (" & hproj.timeStamp.ToString & ") "
                'kennung = hproj.name.Trim & "letzter Stand" & "#Phasen#1"

            Else
                titelTeile(0) = hproj.getShapeText & " ,  " & hproj.startDate.ToShortDateString & _
                                     " - " & hproj.startDate.AddDays(hproj.dauerInDays - 1).ToShortDateString & vbLf

                titelTeile(1) = " (" & hproj.timeStamp.ToString & ") "
                'kennung = hproj.name.Trim & "#Phasen#1"
            End If
        Catch ex As Exception
            titelTeile(0) = hproj.getShapeText & vbLf
            titelTeile(1) = " (" & hproj.timeStamp.ToString & ") "
            'kennung = hproj.name.Trim & "#Phasen#1"
        End Try



        titelTeilLaengen(0) = titelTeile(0).Length
        titelTeilLaengen(1) = titelTeile(1).Length

        diagramTitle = titelTeile(0) & titelTeile(1)

        '
        ' hole die Projektdauer
        '
        With hproj
            plenInDays = .dauerInDays
        End With

        '
        ' hole die Anzahl Phasen, die in diesem Projekt vorkommen
        '
        anzPhasen = hproj.Liste.Count

        If anzPhasen <= 1 Then
            'MsgBox("keine Phasen definiert")
            appInstance.EnableEvents = formerEE
            'appInstance.ScreenUpdating = formerSU
            Exit Sub
        End If


        ReDim Xdatenreihe(anzPhasen - 1)
        ReDim tdatenreihe1(anzPhasen - 1)
        ReDim mdatenreihe(anzPhasen - 1)
        ReDim tdatenreihe2(anzPhasen - 1)
        ReDim tdatenreihe3(anzPhasen - 1)


        ReDim valueColor(anzPhasen - 1)


        'ReDim hsum(anzPhasen - 1)


        For i = 1 To anzPhasen

            With hproj.Liste.Item(i - 1)
                Xdatenreihe(i - 1) = .name
                tdatenreihe1(i - 1) = .startOffsetinDays
                mdatenreihe(i - 1) = tdatenreihe1(i - 1) / 365 * 12
                tdatenreihe2(i - 1) = .dauerInDays
                tdatenreihe3(i - 1) = 0

                If noColorCollection.Count > 0 Then
                    ' dann soll untersucht werden, ob die Phase in der noColorCollection ist 
                    If noColorCollection.Contains(.nameID) Then
                        valueColor(i - 1) = awinSettings.AmpelNichtBewertet
                        'valueColor(i - 1) = iProjektFarbe()
                    Else
                        Try
                            valueColor(i - 1) = .farbe
                        Catch ex As Exception
                            ' dann ist es die Farbe des Projektes
                            valueColor(i - 1) = hproj.farbe
                        End Try

                    End If
                Else
                    Try
                        valueColor(i - 1) = .farbe
                    Catch ex As Exception
                        ' dann ist es die Farbe des Projektes
                        valueColor(i - 1) = hproj.farbe
                    End Try
                End If


            End With
        Next i



        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            found = False
            While i <= anzDiagrams And Not found

                Try
                    If CType(.ChartObjects(i), Excel.ChartObject).Name = kennung Then
                        found = True
                    Else
                        i = i + 1
                    End If
                Catch ex As Exception
                    i = i + 1
                End Try

            End While

            If found Then
                'MsgBox(" Diagramm wird bereits angezeigt ...")
                repObj = CType(.ChartObjects(i), Excel.ChartObject)
            Else

                With appInstance.Charts.Add
                    ' remove extra series
                    Do Until CType(.SeriesCollection, Excel.SeriesCollection).Count = 0
                        CType(.SeriesCollection(1), Excel.Series).Delete()
                    Loop

                    'Aufbau der Series 

                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)

                        For i = 0 To anzPhasen - 1
                            mdatenreihe(i) = tdatenreihe1(i) / 365 * 12
                        Next
                        .Name = "null1"
                        .Interior.ColorIndex = -4142
                        .Values = mdatenreihe
                        .XValues = Xdatenreihe
                        .HasDataLabels = False

                        For px = 1 To anzPhasen

                            With .Points(px)
                                If tdatenreihe1(px - 1) < 90 Then
                                    .HasDataLabel = False
                                Else
                                    .HasDataLabel = True
                                    .DataLabel.Text = hproj.startDate.AddDays(tdatenreihe1(px - 1)).ToShortDateString
                                    .DataLabel.Font.Size = awinSettings.fontsizeItems + 2
                                    If mdatenreihe(px - 1) < 5 Then

                                        Try
                                            .DataLabel.Position = Excel.XlDataLabelPosition.xlLabelPositionOutsideEnd
                                            .DataLabel.Font.Size = awinSettings.fontsizeItems
                                        Catch ex As Exception
                                            .DataLabel.Position = Excel.XlDataLabelPosition.xlLabelPositionInsideEnd
                                        End Try

                                    Else
                                        .DataLabel.Position = Excel.XlDataLabelPosition.xlLabelPositionInsideEnd
                                    End If

                                End If

                            End With

                        Next

                        .ChartType = Excel.XlChartType.xlBarStacked
                    End With

                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)

                        For i = 0 To anzPhasen - 1
                            mdatenreihe(i) = tdatenreihe2(i) / 365 * 12
                        Next
                        .Name = "Phasen Zeitraum"
                        .Values = mdatenreihe
                        .XValues = Xdatenreihe

                        .HasDataLabels = True
                        CType(.DataLabels, Excel.DataLabels).Font.Size = awinSettings.fontsizeItems
                        CType(.DataLabels, Excel.DataLabels).Position = Excel.XlDataLabelPosition.xlLabelPositionCenter

                        For i = 1 To anzPhasen
                            With .Points(i)
                                .Interior.Color = valueColor(i - 1)

                                If mdatenreihe(i - 1) <= 3 Then
                                    .DataLabel.Text = tdatenreihe2(i - 1).ToString
                                Else
                                    '.DataLabel.Text = tdatenreihe2(i - 1).ToString & " Tage"
                                    .DataLabel.Text = tdatenreihe2(i - 1).ToString & repMessages.getmsg(45)
                                End If

                            End With
                        Next


                        .ChartType = Excel.XlChartType.xlBarStacked
                    End With

                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)

                        .Name = "null2"
                        .Interior.ColorIndex = -4142
                        .Values = tdatenreihe3
                        .XValues = Xdatenreihe

                        .HasDataLabels = True
                        CType(.DataLabels, Excel.DataLabels).Font.Size = awinSettings.fontsizeItems + 2
                        CType(.DataLabels, Excel.DataLabels).Position = Excel.XlDataLabelPosition.xlLabelPositionInsideBase

                        Dim bis As Integer
                        For px = 1 To anzPhasen

                            With .Points(px)

                                bis = CInt(tdatenreihe1(px - 1) + tdatenreihe2(px - 1))
                                .DataLabel.Text = hproj.startDate.AddDays(bis - 1).ToShortDateString

                            End With

                        Next

                        .ChartType = Excel.XlChartType.xlBarStacked

                    End With


                    .HasAxis(Excel.XlAxisType.xlCategory) = True
                    .HasAxis(Excel.XlAxisType.xlValue) = True

                    With CType(.Axes(Excel.XlAxisType.xlCategory), Excel.Axis)
                        .HasTitle = False
                        .ReversePlotOrder = True
                    End With


                    With CType(.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                        .HasTitle = True
                        .MinimumScale = 0
                        .MaximumScale = CInt(maxscale / 365 * 12) + 3
                        .HasMajorGridlines = True
                        .MajorUnit = 12

                        With .AxisTitle
                            '.Characters.Text = "Monate"
                            .Characters.Text = repMessages.getmsg(46)
                            .Font.Size = awinSettings.fontsizeItems + 4
                        End With
                    End With

                    .HasLegend = False

                    .HasTitle = True
                    .ChartTitle.Text = diagramTitle
                    .ChartTitle.Font.Size = awinSettings.fontsizeTitle
                    .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                                                                        titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend

                    Dim achieved As Boolean = False
                    Dim anzahlVersuche As Integer = 0
                    Dim errmsg As String = ""
                    Do While Not achieved And anzahlVersuche < 10
                        Try
                            'Call Sleep(100)
                            .Location(Where:=xlNS.XlChartLocation.xlLocationAsObject, Name:=CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Name)
                            achieved = True
                        Catch ex As Exception
                            errmsg = ex.Message
                            'Call Sleep(100)
                            anzahlVersuche = anzahlVersuche + 1
                        End Try
                    Loop

                    If Not achieved Then
                        Throw New ArgumentException("Chart-Fehler:" & errmsg)
                    End If





                End With

                ' jetzt kommt die Korrektur der Größe; herausfinden, wieviel Raum die Axis Beschriftung einnimmt ... 
                With CType(.ChartObjects(anzDiagrams + 1), Excel.ChartObject)

                    .Chart.ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                                                                   titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend
                    .Top = top
                    .Height = (anzPhasen - 1) * 20 + 110

                    Dim axCleft As Double, axCwidth As Double
                    If CBool(.Chart.HasAxis(Excel.XlAxisType.xlCategory)) Then
                        With CType(.Chart.Axes(Excel.XlAxisType.xlCategory), Excel.Axis)
                            axCleft = .Left
                            axCwidth = .Width
                        End With

                        If left - axCwidth < 1 Then
                            .Left = 1
                            .Width = width + left + 9
                        Else
                            .Left = left - axCwidth
                            .Width = width + axCwidth + 9
                        End If

                    Else
                        .Left = left
                        .Width = width
                    End If

                    .Name = kennung


                End With

                repObj = CType(.ChartObjects(anzDiagrams + 1), Excel.ChartObject)

            End If


        End With


        'Call awinScrollintoView()
        appInstance.EnableEvents = formerEE
        'appInstance.ScreenUpdating = formerSU


    End Sub


    '
    ' Prozedur zeigt die Phasen Verläufe eines Projektes an
    ' 
    '
    ''' <summary>
    ''' aktualisiert das PhasenChart (createPhasesBalken) in der Zeit-Maschine
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="chtobj"></param>
    ''' <remarks></remarks>
    Public Sub updatePhasesBalken(ByVal hproj As clsProjekt, ByRef chtobj As Excel.ChartObject, _
                                  ByVal auswahl As Integer, ByVal changeScale As Boolean)
        Dim diagramTitle As String

        Dim anzPhasen As Integer

        Dim plenInDays As Integer
        Dim i As Integer
        Dim Xdatenreihe() As String
        Dim valueColor() As Object
        Dim tdatenreihe1() As Double, mdatenreihe() As Double, tdatenreihe2() As Double, tdatenreihe3() As Double
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim tmpcollection As New Collection
        Dim kennung As String = " "
        Dim maxscale As Double

        Dim fontSize1 As Double = awinSettings.fontsizeTitle, fontSize2 As Double = awinSettings.fontsizeLegend

        Dim pname As String = hproj.name
        tmpcollection.Add(hproj.name & "#" & auswahl.ToString)
        kennung = calcChartKennung("pr", PTprdk.Phasen, tmpcollection)



        Dim formerEE As Boolean = appInstance.EnableEvents
        'Dim formerSU As Boolean = appInstance.ScreenUpdating
        appInstance.EnableEvents = False
        'appInstance.ScreenUpdating = False



        titelTeile(0) = hproj.getShapeText & " ,  " & hproj.startDate.ToShortDateString & _
                                      " - " & hproj.startDate.AddDays(hproj.dauerInDays - 1).ToShortDateString & vbLf
        titelTeile(1) = " (" & hproj.timeStamp.ToString & ") "


        titelTeilLaengen(0) = titelTeile(0).Length
        titelTeilLaengen(1) = titelTeile(1).Length

        diagramTitle = titelTeile(0) & titelTeile(1)


        '
        ' hole die Projektdauer
        '
        With hproj
            plenInDays = .dauerInDays
        End With

        '
        ' hole die Anzahl Phasen, die in diesem Projekt vorkommen
        '
        anzPhasen = hproj.Liste.Count

        ' sonst gibt es gleich 
        If anzPhasen < 1 Then
            ReDim Xdatenreihe(0)
            ReDim tdatenreihe1(0)
            ReDim mdatenreihe(0)
            ReDim tdatenreihe2(0)
            ReDim tdatenreihe3(0)
            ReDim valueColor(0)
        Else
            ReDim Xdatenreihe(anzPhasen - 1)
            ReDim tdatenreihe1(anzPhasen - 1)
            ReDim mdatenreihe(anzPhasen - 1)
            ReDim tdatenreihe2(anzPhasen - 1)
            ReDim tdatenreihe3(anzPhasen - 1)
            ReDim valueColor(anzPhasen - 1)

        End If





        'ReDim hsum(anzPhasen - 1)


        For i = 1 To anzPhasen

            With hproj.Liste.Item(i - 1)
                Xdatenreihe(i - 1) = .name
                tdatenreihe1(i - 1) = .startOffsetinDays
                tdatenreihe2(i - 1) = .dauerInDays
                tdatenreihe3(i - 1) = 0
                Try
                    valueColor(i - 1) = .farbe
                Catch ex As Exception
                    ' dann ist es die Farbe des Projektes
                    valueColor(i - 1) = hproj.farbe
                End Try

            End With
        Next i

        'Dim dlfontsize As Double

        With chtobj.Chart

            ' bestimmen der Fontsize Größen 
            Try
                If .HasTitle Then
                    Dim len As Integer = .ChartTitle.Text.Length
                    fontSize1 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=1, Length:=1).Font.Size
                    fontSize2 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=len - 1, Length:=1).Font.Size
                End If
            Catch ex As Exception

            End Try

            '' remove extra series
            'Do Until .SeriesCollection.Count = 0
            '    .SeriesCollection(1).Delete()
            'Loop

            'Aufbau der Series 

            'With .SeriesCollection.NewSeries
            With CType(.SeriesCollection(1), Excel.Series)

                For i = 0 To anzPhasen - 1
                    mdatenreihe(i) = tdatenreihe1(i) / 365 * 12
                Next
                .Name = "null1"
                .Interior.ColorIndex = -4142
                .Values = mdatenreihe
                .XValues = Xdatenreihe
                'ur: 22.07.2014: die DataLabel bleiben wie im Chart bereits definiert.
                '.HasDataLabels = False



                For px = 1 To anzPhasen

                    With .Points(px)

                        If tdatenreihe1(px - 1) < 90 Then
                            .HasDataLabel = False
                        Else

                            .HasDataLabel = True
                            .DataLabel.Text = hproj.startDate.AddDays(tdatenreihe1(px - 1)).ToShortDateString

                            '.DataLabel.Format.TextFrame2.TextRange.Characters(, ).Font.Size = dlfontsize
                            If mdatenreihe(px - 1) < 5 Then

                                Try
                                    .DataLabel.Position = Excel.XlDataLabelPosition.xlLabelPositionOutsideEnd
                                    '.DataLabel.Font.Size = awinSettings.fontsizeItems
                                Catch ex As Exception
                                    .DataLabel.Position = Excel.XlDataLabelPosition.xlLabelPositionInsideEnd
                                End Try

                            Else
                                .DataLabel.Position = Excel.XlDataLabelPosition.xlLabelPositionInsideEnd
                            End If

                        End If

                    End With

                Next

                .ChartType = Excel.XlChartType.xlBarStacked
            End With


            'With .SeriesCollection.NewSeries
            With CType(.SeriesCollection(2), Excel.Series)

                For i = 0 To anzPhasen - 1
                    mdatenreihe(i) = tdatenreihe2(i) / 365 * 12

                    If maxscale < (tdatenreihe1(i) + tdatenreihe2(i)) / 365 * 12 Then
                        maxscale = (tdatenreihe1(i) + tdatenreihe2(i)) / 365 * 12
                    End If


                Next
                .Name = "Phasen Zeitraum"
                .Values = mdatenreihe
                .XValues = Xdatenreihe

                .HasDataLabels = True

                '.DataLabels.Font.Size = awinSettings.fontsizeItems
                .DataLabels.Position = Excel.XlDataLabelPosition.xlLabelPositionCenter

                For i = 1 To anzPhasen
                    With .Points(i)
                        .Interior.Color = valueColor(i - 1)

                        If mdatenreihe(i - 1) <= 3 Then
                            .DataLabel.Text = tdatenreihe2(i - 1).ToString
                        Else
                            '.DataLabel.Text = tdatenreihe2(i - 1).ToString & " Tage"
                            .DataLabel.Text = tdatenreihe2(i - 1).ToString & repMessages.getmsg(45)
                        End If
                    End With
                Next


                .ChartType = Excel.XlChartType.xlBarStacked
            End With


            'With .SeriesCollection.NewSeries
            With CType(.SeriesCollection(3), Excel.Series)

                .Name = "null2"
                .Interior.ColorIndex = -4142

                .Values = tdatenreihe3
                .XValues = Xdatenreihe

                .HasDataLabels = True

                '.DataLabels.Font.Size = awinSettings.fontsizeItems + 2
                .DataLabels.Position = Excel.XlDataLabelPosition.xlLabelPositionInsideBase


                Dim bis As Integer
                For px = 1 To anzPhasen

                    With .Points(px)

                        bis = CInt(tdatenreihe1(px - 1) + tdatenreihe2(px - 1))
                        .DataLabel.Text = hproj.startDate.AddDays(bis - 1).ToShortDateString

                    End With

                Next

                .ChartType = Excel.XlChartType.xlBarStacked

            End With


            If CBool(.HasAxis(Excel.XlAxisType.xlValue)) Then

                With CType(.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                    ' das ist dann relevant, wenn ein anderes Projekt selektiert wird, das über die aktuelle Skalierung 
                    ' hinausgehende Werte hat 

                    If changeScale Then
                        .MinimumScale = 0
                        .MaximumScaleIsAuto = False
                        If maxscale > Math.Round(.MaximumScale + 5) Then
                            .MaximumScale = Math.Round(maxscale + 6)
                        End If


                        'If Not (.MaximumScaleIsAuto) Then

                        '    If maxscale > Math.Round(.MaximumScale + 5) Then
                        '        .MaximumScale = Math.Round(maxscale + 6)
                        '    End If
                        '    .MaximumScaleIsAuto = True
                        'End If
                    End If

                    If mdatenreihe.Max > .MaximumScale - 3 Then
                        .MaximumScale = mdatenreihe.Max + 3
                    End If

                End With

            End If

            If .HasTitle Then
                .ChartTitle.Text = diagramTitle
                ' Änderung tk: wieder mit reingenmmen, da ja jetzt zu Beginn die fontsize1, ..2 bestimmt werden 
                .ChartTitle.Font.Size = CSng(fontSize1)
                .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                    titelTeilLaengen(1)).Font.Size = CSng(fontSize2)
                ' ur: 21.07.2014 für Chart-Cockpit auskommentiert
                '.ChartTitle.Font.Size = awinSettings.fontsizeTitle
                '.ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                '        titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend
            End If


        End With

        chtobj.Name = kennung

        appInstance.EnableEvents = formerEE



    End Sub

    ''' <summary>
    ''' aktualisiert die Tabelle ProjektTabelleZiele 
    ''' </summary>
    ''' <param name="pptShape"></param>
    ''' <param name="hproj"></param>
    ''' <remarks></remarks>
    Sub updatePPTProjektTabelleZiele(ByRef pptShape As PowerPoint.Shape, ByVal hproj As clsProjekt)

        Dim heute As Date = Date.Now
        Dim anzSpalten As Integer = 0
        Dim index As Integer = 0
        Dim tabelle As PowerPoint.Table
        Dim ampelColor(3) As Integer
        Dim todoCollection As New Collection

        If pptShape.Tags.Item("NIDS").Length > 0 Then
            ' es gibt was zu tun 
            Dim tmpStr() As String = pptShape.Tags.Item("NIDS").Split(New Char() {CChar("#")})
            For i As Integer = 0 To tmpStr.Length - 1
                todoCollection.Add(tmpStr(i))
            Next
        End If

        ampelColor(0) = PowerPoint.XlRgbColor.rgbGray
        ampelColor(1) = PowerPoint.XlRgbColor.rgbGreen
        ampelColor(2) = PowerPoint.XlRgbColor.rgbYellow
        ampelColor(3) = PowerPoint.XlRgbColor.rgbRed

        Try
            If todoCollection.Count > 0 And CBool(pptShape.HasTable) Then
                tabelle = pptShape.Table
                anzSpalten = tabelle.Columns.Count

                If anzSpalten >= 5 Then

                    pptShape.Title = ""

                    Dim msNumber As Integer = 1

                    ' jetzt wird die todoListe abgearbeitet 
                    Dim tabellenzeile As Integer = 2
                    Dim rowCount As Integer = tabelle.Rows.Count

                    Try

                        For m = 1 To todoCollection.Count
                            Dim milestoneID As String = CStr(todoCollection.Item(m))
                            ' wird gar nicht benötigt ..
                            'Dim cellNameID As String = calcPPTShapeName(hproj, milestoneID)

                            Dim cResult As clsMeilenstein = hproj.getMilestoneByID(milestoneID)
                            Dim cBewertung As clsBewertung = cResult.getBewertung(1)

                            With tabelle
                                ' Farbe und laufende Nummer eintragen 
                                Dim tableCell As PowerPoint.Shape = CType(.Cell(tabellenzeile, 1), PowerPoint.Cell).Shape
                                tableCell.TextFrame2.TextRange.Text = msNumber.ToString

                                ' tk 26.6.18
                                If cBewertung.colorIndex = 2 Then
                                    CType(.Cell(tabellenzeile, 1), PowerPoint.Cell).Shape.TextFrame2.TextRange.Font.Fill.ForeColor.RGB = RGB(0, 0, 0)
                                Else
                                    CType(.Cell(tabellenzeile, 1), PowerPoint.Cell).Shape.TextFrame2.TextRange.Font.Fill.ForeColor.RGB = RGB(255, 255, 255)
                                End If

                                'CType(.Cell(tabellenzeile, 1), PowerPoint.Cell).Shape.Fill.ForeColor.RGB = CInt(cBewertung.color)
                                CType(.Cell(tabellenzeile, 1), PowerPoint.Cell).Shape.Fill.ForeColor.RGB = ampelColor(cBewertung.colorIndex)

                                ' tk 26.6.18 alt
                                'CType(.Cell(tabellenzeile, 1), PowerPoint.Cell).Shape.TextFrame2.TextRange.Font.Fill.ForeColor.RGB = RGB(255, 255, 255)
                                'CType(.Cell(tabellenzeile, 1), PowerPoint.Cell).Shape.Fill.ForeColor.RGB = ampelColor(cBewertung.colorIndex)


                                ' Name eintragen 
                                Dim bestName As String = hproj.getBestNameOfID(milestoneID, True, False)
                                tableCell = CType(.Cell(tabellenzeile, 2), PowerPoint.Cell).Shape
                                tableCell.TextFrame2.TextRange.Text = bestName

                                ' Datum eintragen 
                                tableCell = CType(.Cell(tabellenzeile, 3), PowerPoint.Cell).Shape
                                tableCell.TextFrame2.TextRange.Text = cResult.getDate.ToShortDateString

                                ' Lieferumfänge eintragen 
                                tableCell = CType(.Cell(tabellenzeile, 4), PowerPoint.Cell).Shape
                                tableCell.TextFrame2.TextRange.Text = cResult.getAllDeliverables

                                ' Ampelbewertungen eintragen
                                If anzSpalten >= 5 Then
                                    tableCell = CType(.Cell(tabellenzeile, 5), PowerPoint.Cell).Shape
                                    tableCell.TextFrame2.TextRange.Text = cBewertung.description
                                End If


                            End With

                            msNumber = msNumber + 1
                            tabellenzeile = tabellenzeile + 1

                            If tabellenzeile > rowCount And m < todoCollection.Count Then
                                tabelle.Rows.Add()
                                rowCount = rowCount + 1
                            End If


                        Next


                    Catch ex As Exception
                        'Throw New Exception("Tabelle Projektziele hat evtl unzulässige Anzahl Zeilen / Spalten ...")
                        Throw New Exception(repMessages.getmsg(30))
                    End Try

                End If

            End If
        Catch ex As Exception

        End Try



    End Sub

    ''' <summary>
    ''' diese Methode wird aus smartInfo Powerpoint Add-In aufgerufen. sie aktualisiert ein Projekt Strategie/Risiko Diagramm 
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="chtobj"></param>
    ''' <param name="chartTyp"></param>
    ''' <param name="auswahl"></param>
    ''' <remarks></remarks>
    Sub updatePPTProjectPfDiagram(ByVal hproj As clsProjekt, ByRef chtobj As Excel.ChartObject, _
                                      ByVal chartTyp As Integer, ByVal auswahl As Integer)

        Dim xlsChart As Excel.Chart = chtobj.Chart
        Dim i As Integer
        Dim pName As String
        Dim anzBubbles As Integer
        Dim riskValues() As Double, bubbleValues() As Double, tempArray() As Double
        Dim xAchsenValues() As Double
        Dim nameValues() As String
        Dim colorValues() As Object
        Dim positionValues() As String
        Dim showLabels As Boolean
        Dim showNegativeValues As Boolean = False
        Dim projektListe As New Collection
        Dim tmpstr(5) As String

        Dim bubbleColor As Integer = 0
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer

        Dim fontSize1 As Double = 12, fontSize2 As Double = 8

        projektListe.Add(hproj.name)


        pName = hproj.name


        ' es handelt sich garantiert nur um ein Projekt  
        Try
            ReDim riskValues(0)
            ReDim xAchsenValues(0)
            ReDim bubbleValues(0)
            ReDim nameValues(0)
            ReDim colorValues(0)
            ReDim PfChartBubbleNames(0)
            ReDim positionValues(0)
        Catch ex As Exception
            Throw New ArgumentException("Fehler in UpdatePortfolioDiagramm " & ex.Message)
        End Try


        ' neuer Typ: 8.3.14 Abhängigkeiten
        Dim activeDepIndex As Integer           ' Kennzahl: wieviel Projekte sind abhängig, wie stark strahlt das Projekt 
        Dim passiveDepIndex As Integer          ' Kennzahl: von wievielen Projekten abhängig
        Dim activeNumber As Integer             ' Kennzahl: auf wieviele Projekte strahlt es aus ?
        Dim passiveNumber As Integer            ' Kennzahl: von wievielen Projekten abhängig 

        anzBubbles = 0




        For i = 1 To projektListe.Count

            pName = CStr(projektListe.Item(i))

            Try

                With hproj

                    ' neuer Typ: 8.3.14 Abhängigkeiten
                    If chartTyp = PTpfdk.Dependencies Then
                        ' wird um eins erhöht , damit es nicht auf der Nullinie liegt 
                        activeDepIndex = allDependencies.activeIndex(pName, PTdpndncyType.inhalt) + 1
                        activeNumber = allDependencies.activeNumber(pName, PTdpndncyType.inhalt)
                        ' wird um eins erhöht , damit es nicht auf der Nullinie liegt 
                        passiveDepIndex = allDependencies.passiveIndex(pName, PTdpndncyType.inhalt) + 1
                        passiveNumber = allDependencies.passiveNumber(pName, PTdpndncyType.inhalt)
                        riskValues(anzBubbles) = activeDepIndex
                    Else
                        riskValues(anzBubbles) = .Risiko
                    End If

                    If bubbleColor = PTpfdk.ProjektFarbe Then

                        ' Projekttyp wird farblich gekennzeichent
                        colorValues(anzBubbles) = .farbe

                    Else ' bubbleColor ist AmpelFarbe

                        ' ProjektStatus wird farblich gekennzeichnet
                        Select Case .ampelStatus
                            Case 0
                                '"Ampel nicht bewertet"
                                'colorValues(anzBubbles) = awinSettings.AmpelNichtBewertet
                                colorValues(anzBubbles) = Excel.XlRgbColor.rgbGray

                            Case 1
                                '"Ampel Grün"
                                'colorValues(anzBubbles) = awinSettings.AmpelGruen
                                colorValues(anzBubbles) = Excel.XlRgbColor.rgbGreen
                            Case 2
                                '"Ampel Gelb"
                                'colorValues(anzBubbles) = awinSettings.AmpelGelb
                                colorValues(anzBubbles) = Excel.XlRgbColor.rgbYellow
                            Case 3
                                '"Ampel Rot"
                                'colorValues(anzBubbles) = awinSettings.AmpelRot
                                colorValues(anzBubbles) = Excel.XlRgbColor.rgbRed
                        End Select
                    End If

                    Select Case chartTyp
                        Case PTprdk.StrategieRisiko
                            'Strategie
                            xAchsenValues(anzBubbles) = .StrategicFit
                            bubbleValues(anzBubbles) = .ProjectMarge
                            nameValues(anzBubbles) = .name
                            PfChartBubbleNames(anzBubbles) = Format(bubbleValues(anzBubbles), "##0.#%")


                        Case PTprdk.FitRisikoVol

                            xAchsenValues(anzBubbles) = .StrategicFit
                            bubbleValues(anzBubbles) = .volume
                            nameValues(anzBubbles) = .name
                            PfChartBubbleNames(anzBubbles) = hproj.name & _
                                    " (" & Format(bubbleValues(anzBubbles) / 1000, "##0.#") & " T)"


                        Case PTprdk.ZeitRisiko

                            xAchsenValues(anzBubbles) = .dauerInDays / 365 * 12                    'Zeit
                            bubbleValues(anzBubbles) = System.Math.Round(.volume / 10000) * 10
                            'tmpstr = .name.Split(New Char() {" "}, 10)                             'Zeit/Risiko
                            'nameValues(anzBubbles) = tmpstr(0) & " (" & Format(bubbleValues(anzBubbles), "##0.#") & " T)" 
                            nameValues(anzBubbles) = .name & " (" & Format(bubbleValues(anzBubbles), "##0.#") & " T)"
                            PfChartBubbleNames(anzBubbles) = .name & _
                                    " (" & Format(bubbleValues(anzBubbles), "##0.#") & " T)"

                        Case PTprdk.ComplexRisiko

                            xAchsenValues(anzBubbles) = .complexity                                'Complex
                            bubbleValues(anzBubbles) = .volume                                     'Bubblegröße gemäß Volumen
                            nameValues(anzBubbles) = .name
                            PfChartBubbleNames(anzBubbles) = hproj.name & _
                             " (" & Format(bubbleValues(anzBubbles) / 1000, "##0.#") & " T)"


                        Case PTprdk.Dependencies
                            ' neuer Typ: 8.3.14 Abhängigkeiten

                            xAchsenValues(anzBubbles) = passiveDepIndex                            'Abhängigkeiten
                            bubbleValues(anzBubbles) = .StrategicFit
                            nameValues(anzBubbles) = .name

                            PfChartBubbleNames(anzBubbles) = .name & _
                                " (" & passiveNumber.ToString & ", " & activeNumber.ToString & ")"

                    End Select
                End With
                anzBubbles = anzBubbles + 1
            Catch ex As Exception

            End Try
        Next


        ' bestimmen der besten Position für die Werte ...
        Dim labelPosition(4) As String
        labelPosition(0) = "oben"
        labelPosition(1) = "rechts"
        labelPosition(2) = "unten"
        labelPosition(3) = "links"
        labelPosition(4) = "mittig"

        For i = 0 To anzBubbles - 1

            positionValues(i) = pfchartIstFrei(i, xAchsenValues, riskValues)

        Next


        ReDim tempArray(anzBubbles - 1)


        ' nur dann neue Series-Collection aufbauen, wenn auch tatsächlich was in der Projektliste ist ..

        If projektListe.Count > 0 Then

            With xlsChart

                '' bestimmen der Fontsize Größen 
                'Try
                '    If .HasTitle Then
                '        Dim len As Integer = .ChartTitle.Text.Length
                '        fontSize1 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=1, Length:=1).Font.Size
                '        fontSize2 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=len - 1, Length:=1).Font.Size
                '    End If
                'Catch ex As Exception

                'End Try

                showLabels = True

                ' Einstellungen der vorhandenen SeriesCollection merken

                Dim pts As Excel.Points = CType(.SeriesCollection(1).Points, Excel.Points)
                Dim dlFontSize As Double
                Dim dlFontBackground As Double
                Dim dlFontBold As Boolean
                Dim dlFontColorIndex As Integer
                Dim dlFontColor As Integer
                Dim dlFontFontStyle As String = ""
                Dim dlFontItalic As Boolean
                Dim dlFontStrikethrough As Boolean
                Dim dlFontSuperscript As Boolean
                Dim dlFontSubscript As Boolean
                'ur: 21.07.2015: Dim dlFontUnderline As Double

                For i = 1 To pts.Count

                    With .SeriesCollection(1).Points(i)

                        Try
                            If .HasDataLabel = True Then

                                With .DataLabel
                                    dlFontSize = CDbl(.Font.Size)
                                    dlFontBackground = CDbl(.Font.Background)
                                    dlFontBold = CBool(.Font.Bold)
                                    dlFontColorIndex = CInt(.Font.ColorIndex)
                                    dlFontFontStyle = CStr(.Font.FontStyle)
                                    dlFontItalic = CBool(.Font.Italic)
                                    dlFontStrikethrough = CBool(.Font.Strikethrough)
                                    dlFontSubscript = CBool(.Font.Subscript)
                                    dlFontSuperscript = CBool(.Font.Superscript)
                                    'ur 21.07.2015 dlFontUnderline = CDbl(.Font.Underline)

                                    dlFontSize = CDbl(.Font.Size)
                                    If .Font.Color <> awinSettings.AmpelRot Then
                                        dlFontColor = CInt(.Font.Color)
                                    End If

                                End With
                            End If

                        Catch ex As Exception

                        End Try
                    End With

                Next i



                ' remove old series
                Try
                    Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                    Do While anz > 0
                        .SeriesCollection(1).Delete()
                        anz = anz - 1
                    Loop
                Catch ex As Exception

                End Try



                .SeriesCollection.NewSeries()
                With CType(.SeriesCollection(1), Excel.Series)
                    .Name = "projectdiagram"
                    .ChartType = Excel.XlChartType.xlBubble3DEffect
                End With


                For i = 1 To anzBubbles
                    tempArray(i - 1) = xAchsenValues(i - 1)
                Next i
                .SeriesCollection(1).XValues = tempArray ' strategic

                For i = 1 To anzBubbles
                    tempArray(i - 1) = riskValues(i - 1)
                Next i
                .SeriesCollection(1).Values = tempArray

                For i = 1 To anzBubbles
                    If bubbleValues(i - 1) < 0.01 And bubbleValues(i - 1) > -0.01 Then
                        tempArray(i - 1) = 0.01
                    ElseIf bubbleValues(i - 1) < 0 Then
                        ' negative Werte werden Positiv dargestellt mit roten Beschriftung siehe unten
                        tempArray(i - 1) = System.Math.Abs(bubbleValues(i - 1))
                    Else
                        tempArray(i - 1) = bubbleValues(i - 1)
                    End If
                Next i


                .SeriesCollection(1).BubbleSizes = tempArray

                Dim series1 As Excel.Series = _
                        CType(.SeriesCollection(1),  _
                                Excel.Series)

                Dim point1 As Excel.Point = _
                            CType(series1.Points(1), Excel.Point)

                'Dim testName As String

                Dim bubblePoint As Excel.Point
                For i = 1 To anzBubbles

                    bubblePoint = CType(.SeriesCollection(1).Points(i), Excel.Point)

                    With CType(.SeriesCollection(1).Points(i), Excel.Point)
                        If showLabels Then
                            Try
                                .HasDataLabel = True

                                With .DataLabel
                                    .Text = PfChartBubbleNames(i - 1)
                                    .Font.Size = dlFontSize
                                    .Font.Background = dlFontBackground
                                    .Font.Bold = dlFontBold
                                    .Font.Color = dlFontColor
                                    .Font.ColorIndex = dlFontColorIndex
                                    .Font.FontStyle = dlFontFontStyle
                                    .Font.Italic = dlFontItalic
                                    .Font.Strikethrough = dlFontStrikethrough
                                    .Font.Subscript = dlFontSubscript
                                    .Font.Superscript = dlFontSuperscript
                                    'ur: 21.07.2015: .Font.Underline = dlFontUnderline

                                    'ur: 17.7.2014: fontsize kommt vom existierenden Chart
                                    '.Font.Size = awinSettings.CPfontsizeItems

                                    ' bei negativen Werten erfolgt die Beschriftung in roter Farbe  ..

                                    If bubbleValues(i - 1) < 0 Then
                                        .Font.Color = awinSettings.AmpelRot

                                    End If
                                    Select Case positionValues(i - 1)
                                        Case labelPosition(0)
                                            .Position = Excel.XlDataLabelPosition.xlLabelPositionAbove
                                        Case labelPosition(1)
                                            .Position = Excel.XlDataLabelPosition.xlLabelPositionRight
                                        Case labelPosition(2)
                                            .Position = Excel.XlDataLabelPosition.xlLabelPositionBelow
                                        Case labelPosition(3)
                                            .Position = Excel.XlDataLabelPosition.xlLabelPositionLeft
                                        Case Else
                                            .Position = Excel.XlDataLabelPosition.xlLabelPositionCenter
                                    End Select
                                End With
                            Catch ex As Exception

                            End Try
                        Else
                            .HasDataLabel = False
                        End If

                        .Interior.Color = colorValues(i - 1)

                        ' bei negativen Werten erfolgt die Beschriftung in roter Farbe  ..
                        If bubbleValues(i - 1) < 0 Then
                            '.DataLabel.Font.Color = awinSettings.AmpelRot
                            .DataLabel.Font.Color = Excel.XlRgbColor.rgbRed
                        ElseIf bubbleValues(i - 1) > 0 Then
                            '.DataLabel.Font.Color = awinSettings.AmpelGruen
                            .DataLabel.Font.Color = Excel.XlRgbColor.rgbGreen
                        Else
                            '.DataLabel.Font.Color = System.Drawing.Color.Black
                            .DataLabel.Font.Color = Excel.XlRgbColor.rgbBlack
                        End If

                    End With
                Next i



                '.ChartGroups(1).BubbleScale = sollte in Abhängigkeit der width gemacht werden 
                With .ChartGroups(1)

                    .BubbleScale = 20
                    .SizeRepresents = Microsoft.Office.Interop.Excel.XlSizeRepresents.xlSizeIsArea

                    If showNegativeValues Then
                        .shownegativeBubbles = True
                    Else
                        .shownegativeBubbles = False
                    End If
                End With


                'If .HasTitle Then
                '    .ChartTitle.Text = diagramTitle
                '    ' Änderung tk: wieder mit reingenmmen, da ja jetzt zu Beginn die fontsize1, ..2 bestimmt werden 
                '    .ChartTitle.Font.Size = CSng(fontSize1)
                '    .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                '        titelTeilLaengen(1)).Font.Size = CSng(fontSize2)
                '    ' ur: 21.07.2014 für Chart-Cockpit auskommentiert
                '    '.ChartTitle.Font.Size = awinSettings.fontsizeTitle
                '    '.ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                '    '        titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend
                'End If

            End With

        End If



    End Sub
    
    ''' <summary>
    ''' aktualisiert das Portfolio Einzelprojekt Chart 
    '''  
    ''' </summary>
    ''' <param name="hproj">das genau eine Projekt, das angezeigt werden soll</param>
    ''' <param name="chtobj">das Chart, das aktualisiert werden soll </param>
    ''' <param name="auswahl">gibt an, ob Projektfarbe oder AmpelFarbe angezeigt werden soll</param>
    ''' <remarks></remarks>
    Sub updateProjectPfDiagram(ByVal hproj As clsProjekt, ByRef chtobj As Excel.ChartObject, ByVal auswahl As Integer)

        Dim i As Integer
        Dim pName As String
        Dim anzBubbles As Integer
        Dim riskValues() As Double, bubbleValues() As Double, tempArray() As Double
        Dim xAchsenValues() As Double
        Dim nameValues() As String
        Dim colorValues() As Object
        Dim positionValues() As String
        Dim diagramTitle As String
        Dim showLabels As Boolean
        Dim showNegativeValues As Boolean = False
        Dim projektListe As New Collection
        Dim charttype As Integer
        Dim tmpstr(5) As String
        Dim isSingleProject As Boolean = False
        'Dim tmpcollection As New Collection
        'Dim kennung As String = " "
        Dim bubbleColor As Integer = 0
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer

        Dim fontSize1 As Double = awinSettings.fontsizeTitle, fontSize2 As Double = awinSettings.fontsizeLegend

        isSingleProject = True
        projektListe.Add(hproj.name)

        tmpstr = chtobj.Name.Trim.Split(New Char() {CChar("#")}, 4)
        charttype = CInt(tmpstr(1))

        pName = hproj.name
        'tmpcollection.Add(pName & "#" & auswahl.ToString)
        'kennung = calcChartKennung("pr", charttype, tmpcollection)

        'foundDiagramm = DiagramList.getDiagramm(chtobj.Name)
        ' event. für eine Erweiterung benötigt


        ' es handelt sich garantiert nur um ein Projekt  
        Try
            ReDim riskValues(0)
            ReDim xAchsenValues(0)
            ReDim bubbleValues(0)
            ReDim nameValues(0)
            ReDim colorValues(0)
            ReDim PfChartBubbleNames(0)
            ReDim positionValues(0)
        Catch ex As Exception
            Throw New ArgumentException("Fehler in UpdatePortfolioDiagramm " & ex.Message)
        End Try


        ' neuer Typ: 8.3.14 Abhängigkeiten
        Dim activeDepIndex As Integer           ' Kennzahl: wieviel Projekte sind abhängig, wie stark strahlt das Projekt 
        Dim passiveDepIndex As Integer          ' Kennzahl: von wievielen Projekten abhängig
        Dim activeNumber As Integer             ' Kennzahl: auf wieviele Projekte strahlt es aus ?
        Dim passiveNumber As Integer            ' Kennzahl: von wievielen Projekten abhängig 

        anzBubbles = 0




        For i = 1 To projektListe.Count

            pName = CStr(projektListe.Item(i))

            Try

                With hproj

                    ' neuer Typ: 8.3.14 Abhängigkeiten
                    If charttype = PTpfdk.Dependencies Then
                        ' wird um eins erhöht , damit es nicht auf der Nullinie liegt 
                        activeDepIndex = allDependencies.activeIndex(pName, PTdpndncyType.inhalt) + 1
                        activeNumber = allDependencies.activeNumber(pName, PTdpndncyType.inhalt)
                        ' wird um eins erhöht , damit es nicht auf der Nullinie liegt 
                        passiveDepIndex = allDependencies.passiveIndex(pName, PTdpndncyType.inhalt) + 1
                        passiveNumber = allDependencies.passiveNumber(pName, PTdpndncyType.inhalt)
                        riskValues(anzBubbles) = activeDepIndex
                    Else
                        riskValues(anzBubbles) = .Risiko
                    End If

                    If bubbleColor = PTpfdk.ProjektFarbe Then

                        ' Projekttyp wird farblich gekennzeichent
                        colorValues(anzBubbles) = .farbe

                    Else ' bubbleColor ist AmpelFarbe

                        ' ProjektStatus wird farblich gekennzeichnet
                        Select Case .ampelStatus
                            Case 0
                                '"Ampel nicht bewertet"
                                colorValues(anzBubbles) = awinSettings.AmpelNichtBewertet
                            Case 1
                                '"Ampel Grün"
                                colorValues(anzBubbles) = awinSettings.AmpelGruen
                            Case 2
                                '"Ampel Gelb"
                                colorValues(anzBubbles) = awinSettings.AmpelGelb
                            Case 3
                                '"Ampel Rot"
                                colorValues(anzBubbles) = awinSettings.AmpelRot
                        End Select
                    End If

                    Select Case charttype
                        Case PTprdk.StrategieRisiko
                            'Strategie
                            xAchsenValues(anzBubbles) = .StrategicFit
                            bubbleValues(anzBubbles) = .ProjectMarge
                            nameValues(anzBubbles) = .name
                            PfChartBubbleNames(anzBubbles) = Format(bubbleValues(anzBubbles), "##0.#%")


                        Case PTprdk.FitRisikoVol

                            xAchsenValues(anzBubbles) = .StrategicFit
                            bubbleValues(anzBubbles) = .volume
                            nameValues(anzBubbles) = .name
                            PfChartBubbleNames(anzBubbles) = hproj.name & _
                                    " (" & Format(bubbleValues(anzBubbles) / 1000, "##0.#") & " T)"


                        Case PTprdk.ZeitRisiko

                            xAchsenValues(anzBubbles) = .dauerInDays / 365 * 12                    'Zeit
                            bubbleValues(anzBubbles) = System.Math.Round(.volume / 10000) * 10
                            'tmpstr = .name.Split(New Char() {" "}, 10)                             'Zeit/Risiko
                            'nameValues(anzBubbles) = tmpstr(0) & " (" & Format(bubbleValues(anzBubbles), "##0.#") & " T)" 
                            nameValues(anzBubbles) = .name & " (" & Format(bubbleValues(anzBubbles), "##0.#") & " T)"
                            PfChartBubbleNames(anzBubbles) = .name & _
                                    " (" & Format(bubbleValues(anzBubbles), "##0.#") & " T)"

                        Case PTprdk.ComplexRisiko

                            xAchsenValues(anzBubbles) = .complexity                                'Complex
                            bubbleValues(anzBubbles) = .volume                                     'Bubblegröße gemäß Volumen
                            nameValues(anzBubbles) = .name
                            PfChartBubbleNames(anzBubbles) = hproj.name & _
                             " (" & Format(bubbleValues(anzBubbles) / 1000, "##0.#") & " T)"


                        Case PTprdk.Dependencies
                            ' neuer Typ: 8.3.14 Abhängigkeiten

                            xAchsenValues(anzBubbles) = passiveDepIndex                            'Abhängigkeiten
                            bubbleValues(anzBubbles) = .StrategicFit
                            nameValues(anzBubbles) = .name

                            PfChartBubbleNames(anzBubbles) = .name & _
                                " (" & passiveNumber.ToString & ", " & activeNumber.ToString & ")"

                    End Select
                End With
                anzBubbles = anzBubbles + 1
            Catch ex As Exception

            End Try
        Next

        Select Case charttype
            Case PTprdk.StrategieRisiko

                titelTeile(0) = summentitel2
                titelTeile(1) = ""

            Case PTpfdk.FitRisikoVol

                titelTeile(0) = portfolioDiagrammtitel(PTprdk.FitRisikoVol)
                titelTeile(1) = ""

            Case PTpfdk.ZeitRisiko

                titelTeile(0) = portfolioDiagrammtitel(PTprdk.ZeitRisiko)
                titelTeile(1) = ""

            Case PTpfdk.ComplexRisiko

                titelTeile(0) = portfolioDiagrammtitel(PTprdk.ComplexRisiko)
                titelTeile(1) = ""

            Case PTpfdk.Dependencies
                ' neuer Typ: 8.3.14 Abhängigkeiten

                titelTeile(0) = portfolioDiagrammtitel(PTprdk.Dependencies)
                titelTeile(1) = ""

            Case Else
                diagramTitle = "Chart-Typ existiert nicht"
        End Select

        titelTeilLaengen(0) = titelTeile(0).Length
        titelTeilLaengen(1) = titelTeile(1).Length

        diagramTitle = titelTeile(0) & titelTeile(1)


        ' bestimmen der besten Position für die Werte ...
        Dim labelPosition(4) As String
        labelPosition(0) = "oben"
        labelPosition(1) = "rechts"
        labelPosition(2) = "unten"
        labelPosition(3) = "links"
        labelPosition(4) = "mittig"

        For i = 0 To anzBubbles - 1

            positionValues(i) = pfchartIstFrei(i, xAchsenValues, riskValues)

        Next


        ReDim tempArray(anzBubbles - 1)

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False

        ' nur dann neue Series-Collection aufbauen, wenn auch tatsächlich was in der Projektliste ist ..

        If projektListe.Count > 0 Then

            With CType(chtobj.Chart, Excel.Chart)

                ' bestimmen der Fontsize Größen 
                Try
                    If .HasTitle Then
                        Dim len As Integer = .ChartTitle.Text.Length
                        fontSize1 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=1, Length:=1).Font.Size
                        fontSize2 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=len - 1, Length:=1).Font.Size
                    End If
                Catch ex As Exception

                End Try

                showLabels = True

                ' Einstellungen der vorhandenen SeriesCollection merken

                Dim pts As Excel.Points = CType(.SeriesCollection(1).Points, Excel.Points)
                Dim dlFontSize As Double
                Dim dlFontBackground As Double
                Dim dlFontBold As Boolean
                Dim dlFontColorIndex As Integer
                Dim dlFontColor As Integer
                Dim dlFontFontStyle As String = ""
                Dim dlFontItalic As Boolean
                Dim dlFontStrikethrough As Boolean
                Dim dlFontSuperscript As Boolean
                Dim dlFontSubscript As Boolean
                'ur: 21.07.2015: Dim dlFontUnderline As Double

                For i = 1 To pts.Count

                    With .SeriesCollection(1).Points(i)

                        Try
                            If .HasDataLabel = True Then

                                With .DataLabel
                                    dlFontSize = CDbl(.Font.Size)
                                    dlFontBackground = CDbl(.Font.Background)
                                    dlFontBold = CBool(.Font.Bold)
                                    dlFontColorIndex = CInt(.Font.ColorIndex)
                                    dlFontFontStyle = CStr(.Font.FontStyle)
                                    dlFontItalic = CBool(.Font.Italic)
                                    dlFontStrikethrough = CBool(.Font.Strikethrough)
                                    dlFontSubscript = CBool(.Font.Subscript)
                                    dlFontSuperscript = CBool(.Font.Superscript)
                                    'ur 21.07.2015 dlFontUnderline = CDbl(.Font.Underline)

                                    dlFontSize = CDbl(.Font.Size)
                                    If .Font.Color <> awinSettings.AmpelRot Then
                                        dlFontColor = CInt(.Font.Color)
                                    End If

                                End With
                            End If

                        Catch ex As Exception

                        End Try
                    End With

                Next i



                ' remove old series
                Try
                    Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                    Do While anz > 0
                        .SeriesCollection(1).Delete()
                        anz = anz - 1
                    Loop
                Catch ex As Exception

                End Try



                .SeriesCollection.NewSeries()
                .SeriesCollection(1).name = diagramTitle
                .SeriesCollection(1).ChartType = Excel.XlChartType.xlBubble3DEffect

                For i = 1 To anzBubbles
                    tempArray(i - 1) = xAchsenValues(i - 1)
                Next i
                .SeriesCollection(1).XValues = tempArray ' strategic

                For i = 1 To anzBubbles
                    tempArray(i - 1) = riskValues(i - 1)
                Next i
                .SeriesCollection(1).Values = tempArray

                For i = 1 To anzBubbles
                    If bubbleValues(i - 1) < 0.01 And bubbleValues(i - 1) > -0.01 Then
                        tempArray(i - 1) = 0.01
                    ElseIf bubbleValues(i - 1) < 0 Then
                        ' negative Werte werden Positiv dargestellt mit roten Beschriftung siehe unten
                        tempArray(i - 1) = System.Math.Abs(bubbleValues(i - 1))
                    Else
                        tempArray(i - 1) = bubbleValues(i - 1)
                    End If
                Next i


                .SeriesCollection(1).BubbleSizes = tempArray

                Dim series1 As Excel.Series = _
                        CType(.SeriesCollection(1),  _
                                Excel.Series)
                Dim point1 As Excel.Point = _
                            CType(series1.Points(1), Excel.Point)

                'Dim testName As String

                Dim bubblePoint As Excel.Point
                For i = 1 To anzBubbles

                    bubblePoint = CType(.SeriesCollection(1).Points(i), Excel.Point)

                    With CType(.SeriesCollection(1).Points(i), Excel.Point)
                        If showLabels Then
                            Try
                                .HasDataLabel = True

                                With .DataLabel
                                    .Text = PfChartBubbleNames(i - 1)
                                    .Font.Size = dlFontSize
                                    .Font.Background = dlFontBackground
                                    .Font.Bold = dlFontBold
                                    .Font.Color = dlFontColor
                                    .Font.ColorIndex = dlFontColorIndex
                                    .Font.FontStyle = dlFontFontStyle
                                    .Font.Italic = dlFontItalic
                                    .Font.Strikethrough = dlFontStrikethrough
                                    .Font.Subscript = dlFontSubscript
                                    .Font.Superscript = dlFontSuperscript
                                    'ur: 21.07.2015: .Font.Underline = dlFontUnderline

                                    'ur: 17.7.2014: fontsize kommt vom existierenden Chart
                                    '.Font.Size = awinSettings.CPfontsizeItems

                                    ' bei negativen Werten erfolgt die Beschriftung in roter Farbe  ..

                                    If bubbleValues(i - 1) < 0 Then
                                        .Font.Color = awinSettings.AmpelRot

                                    End If
                                    Select Case positionValues(i - 1)
                                        Case labelPosition(0)
                                            .Position = Excel.XlDataLabelPosition.xlLabelPositionAbove
                                        Case labelPosition(1)
                                            .Position = Excel.XlDataLabelPosition.xlLabelPositionRight
                                        Case labelPosition(2)
                                            .Position = Excel.XlDataLabelPosition.xlLabelPositionBelow
                                        Case labelPosition(3)
                                            .Position = Excel.XlDataLabelPosition.xlLabelPositionLeft
                                        Case Else
                                            .Position = Excel.XlDataLabelPosition.xlLabelPositionCenter
                                    End Select
                                End With
                            Catch ex As Exception

                            End Try
                        Else
                            .HasDataLabel = False
                        End If

                        .Interior.Color = colorValues(i - 1)

                        ' bei negativen Werten erfolgt die Beschriftung in roter Farbe  ..
                        If bubbleValues(i - 1) < 0 Then
                            .DataLabel.Font.Color = awinSettings.AmpelRot
                        ElseIf bubbleValues(i - 1) > 0 Then
                            .DataLabel.Font.Color = awinSettings.AmpelGruen
                        Else
                            .DataLabel.Font.Color = System.Drawing.Color.Black
                        End If

                    End With
                Next i



                '.ChartGroups(1).BubbleScale = sollte in Abhängigkeit der width gemacht werden 
                With .ChartGroups(1)

                    .BubbleScale = 20
                    .SizeRepresents = Microsoft.Office.Interop.Excel.XlSizeRepresents.xlSizeIsArea

                    If showNegativeValues Then
                        .shownegativeBubbles = True
                    Else
                        .shownegativeBubbles = False
                    End If
                End With


                If .HasTitle Then
                    .ChartTitle.Text = diagramTitle
                    ' Änderung tk: wieder mit reingenmmen, da ja jetzt zu Beginn die fontsize1, ..2 bestimmt werden 
                    .ChartTitle.Font.Size = CSng(fontSize1)
                    .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                        titelTeilLaengen(1)).Font.Size = CSng(fontSize2)
                    ' ur: 21.07.2014 für Chart-Cockpit auskommentiert
                    '.ChartTitle.Font.Size = awinSettings.fontsizeTitle
                    '.ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                    '        titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend
                End If

            End With

        End If

        ' tk 6.10.18 das hat doch eh schon den Namen ... 
        'chtobj.Name = kennung
        appInstance.EnableEvents = formerEE




    End Sub


    

    ''' <summary>
    ''' Voraussetzung: die Projekt-Historie des Projektes ist bereits richtig gesetzt 
    ''' zeigt Soll-/Ist zu Personalkosten, Sonstige Kosten , Gesamtkosten an 
    ''' das wird gesteuert über auswahl ; damit können auch beliebige andere angezeigt werden 
    ''' muss dann aber noch implementiert werden
    ''' 
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="reportObj"></param>
    ''' <param name="heute"></param>
    ''' <param name="auswahl"></param>
    ''' <param name="top"></param>
    ''' <param name="left"></param>
    ''' <param name="height"></param>
    ''' <param name="width"></param>
    ''' <remarks></remarks>
    Sub createSollIstOfProject(ByVal hproj As clsProjekt, ByRef reportObj As Excel.ChartObject, ByVal heute As Date, ByVal auswahl As Integer, ByVal qualifier As String, ByVal vglBaseline As Boolean, _
                                   ByVal top As Double, ByVal left As Double, ByVal height As Double, ByVal width As Double, ByVal calledFromReporting As Boolean)
        'Dim chtobj As Excel.ChartObject
        Dim anzDiagrams As Integer
        Dim i As Integer, ix As Integer = 0
        Dim found As Boolean
        Dim abbruch As Boolean = False
        Dim pname As String = hproj.name
        Dim fullname As String = hproj.getShapeText
        Dim kennung As String = " "
        Dim diagramTitle As String = " "
        Dim zE As String = "(" & awinSettings.kapaEinheit & ")"
        Dim titelTeile(2) As String
        Dim titelTeilLaengen(2) As Integer
        Dim kontrollWert As Double
        Dim vgl As Date

        
        Dim isMinMax As Boolean = False

        Dim ersteVersion As clsProjekt
        Dim letzteVersion As clsProjekt
        Dim anzSnapshots As Integer = projekthistorie.Count

        Dim currentSheetName As String = ""
        Dim maxlenTitle1 As Integer = 20
        Dim newChtObj As Excel.ChartObject = Nothing
        If visboZustaende.projectBoardMode = ptModus.graficboard Then
            If calledfromReporting Then
                currentSheetName = arrWsNames(ptTables.repCharts)
            Else
                currentSheetName = arrWsNames(ptTables.mptPrCharts)
            End If

        Else
            currentSheetName = arrWsNames(ptTables.meCharts)
        End If

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False


        ' Änderung 18.6 : Unterscheidung zwischen Soll-/Ist Vergleichen und Min/Max Vergleichen 

        If hproj.Status <> ProjektStatus(PTProjektStati.geplant) Then
            ' Soll-Ist Vergleich
            isMinMax = False


            ersteVersion = projekthistorie.beauftragung
            If IsNothing(ersteVersion) Then
                If projekthistorie.Count >= 1 Then
                    ersteVersion = projekthistorie.First
                Else
                    Throw New ArgumentException("es gibt weder Beauftragung noch ersten Stand")
                End If
            End If


            ' finde in der Projekt-Historie das Projekt, das direkt vor hproj gespeichert wurde
            ' 
            vgl = hproj.timeStamp.AddMinutes(-1)
            letzteVersion = projekthistorie.ElementAtorBefore(vgl)
            If IsNothing(letzteVersion) Then
                letzteVersion = projekthistorie.First
            End If

        Else
            ' Min-Max Vergleich 
            isMinMax = True
            Dim minIndex As Integer = 0
            Dim maxIndex As Integer = 0
            Dim minValue As Double, maxValue As Double
            Dim tmpValue As Double
            Select Case auswahl
                Case 1
                    ' Personalkosten
                    With projekthistorie.ElementAt(0)
                        minValue = .getAllPersonalKosten.Sum
                        maxValue = .getAllPersonalKosten.Sum
                    End With

                    For s = 1 To anzSnapshots - 1
                        With projekthistorie.ElementAt(s)
                            tmpValue = .getAllPersonalKosten.Sum
                            If tmpValue < minValue Then
                                minIndex = s
                                minValue = tmpValue
                            End If
                            If tmpValue > maxValue Then
                                maxIndex = s
                                maxValue = tmpValue
                            End If
                        End With
                    Next


                Case 2
                    ' Sonstige Kosten
                    With projekthistorie.ElementAt(0)
                        minValue = .getGesamtAndereKosten.Sum
                        maxValue = .getGesamtAndereKosten.Sum
                    End With

                    For s = 1 To anzSnapshots - 1
                        With projekthistorie.ElementAt(s)
                            tmpValue = .getGesamtAndereKosten.Sum
                            If tmpValue < minValue Then
                                minIndex = s
                                minValue = tmpValue
                            End If
                            If tmpValue > maxValue Then
                                maxIndex = s
                                maxValue = tmpValue
                            End If
                        End With
                    Next
                Case 3
                    ' Gesamtkosten
                    With projekthistorie.ElementAt(0)
                        minValue = .getGesamtKostenBedarf.Sum
                        maxValue = .getGesamtKostenBedarf.Sum
                    End With

                    For s = 1 To anzSnapshots - 1
                        With projekthistorie.ElementAt(s)
                            tmpValue = .getGesamtKostenBedarf.Sum
                            If tmpValue < minValue Then
                                minIndex = s
                                minValue = tmpValue
                            End If
                            If tmpValue > maxValue Then
                                maxIndex = s
                                maxValue = tmpValue
                            End If
                        End With
                    Next
                Case 4
                    ' Rollen mit Qualifier
                    With projekthistorie.ElementAt(0)
                        minValue = .getRessourcenBedarf(qualifier, inclSubRoles:=True, outPutInEuro:=True).Sum
                        maxValue = minValue
                    End With

                    For s = 1 To anzSnapshots - 1
                        With projekthistorie.ElementAt(s)
                            tmpValue = .getRessourcenBedarf(qualifier, outPutInEuro:=True).Sum
                            If tmpValue < minValue Then
                                minIndex = s
                                minValue = tmpValue
                            End If
                            If tmpValue > maxValue Then
                                maxIndex = s
                                maxValue = tmpValue
                            End If
                        End With
                    Next


                Case 5
                    ' Kostenart mit Qualifier
                    With projekthistorie.ElementAt(0)
                        minValue = .getKostenBedarf(qualifier).Sum
                        maxValue = .getKostenBedarf(qualifier).Sum
                    End With

                    For s = 1 To anzSnapshots - 1
                        With projekthistorie.ElementAt(s)
                            tmpValue = .getKostenBedarf(qualifier).Sum
                            If tmpValue < minValue Then
                                minIndex = s
                                minValue = tmpValue
                            End If
                            If tmpValue > maxValue Then
                                maxIndex = s
                                maxValue = tmpValue
                            End If
                        End With
                    Next

                Case Else
                    ' Gesamtkosten
                    With projekthistorie.ElementAt(0)
                        minValue = .getGesamtKostenBedarf.Sum
                        maxValue = .getGesamtKostenBedarf.Sum
                    End With

                    For s = 1 To anzSnapshots - 1
                        With projekthistorie.ElementAt(s)
                            tmpValue = .getGesamtKostenBedarf.Sum
                            If tmpValue < minValue Then
                                minIndex = s
                                minValue = tmpValue
                            End If
                            If tmpValue > maxValue Then
                                maxIndex = s
                                maxValue = tmpValue
                            End If
                        End With
                    Next
            End Select

            Try
                ersteVersion = projekthistorie.ElementAt(minIndex)
                letzteVersion = projekthistorie.ElementAt(maxIndex)
            Catch ex As Exception
                Throw New ArgumentException("Fehler in Min-/Max Bestimmung " & ex.Message)
            End Try

        End If



        ' Ende Ergänzung 18.6 Min/Max 


        Dim minColumn As Integer, maxColumn As Integer, heuteColumn As Integer = getColumnOfDate(heute)
        Dim pastAndFuture As Boolean = False
        Dim future As Boolean = True

        Dim werteB(ersteVersion.anzahlRasterElemente - 1) As Double
        Dim werteL(letzteVersion.anzahlRasterElemente - 1) As Double
        Dim werteC(hproj.anzahlRasterElemente - 1) As Double

        Dim Xdatenreihe() As String
        Dim tdatenreiheB() As Double
        Dim tdatenreiheL() As Double
        Dim tdatenreiheC() As Double
        Dim tmpCollection As New Collection
        tmpCollection.Add(hproj.name & "#" & auswahl.ToString)
        ' Bestimmen der Werte 

        Select Case auswahl
            Case 1
                ' Personalkosten
                If isMinMax Then
                    titelTeile(0) = repMessages.getmsg(187)
                    'titelTeile(0) = "Min/Max Personalkosten (T€)" & vbLf
                Else
                    titelTeile(0) = repMessages.getmsg(188)
                    'titelTeile(0) = "Soll/Ist Personalkosten (T€)" & vbLf
                End If
                kennung = calcChartKennung("pr", PTprdk.SollIstPersonalkosten, tmpCollection)
                'kennung = "Soll/Ist Personalkosten"
                werteB = ersteVersion.getAllPersonalKosten
                werteL = letzteVersion.getAllPersonalKosten
                werteC = hproj.getAllPersonalKosten
            Case 2
                ' Sonstige Kosten
                If isMinMax Then
                    titelTeile(0) = repMessages.getmsg(189)
                    'titelTeile(0) = "Min/Max Sonstige Kosten (T€)" & vbLf
                Else
                    titelTeile(0) = repMessages.getmsg(190)
                    'titelTeile(0) = "Soll/Ist Sonstige Kosten (T€)" & vbLf
                End If

                kennung = calcChartKennung("pr", PTprdk.SollIstSonstKosten, tmpCollection)
                werteB = ersteVersion.getGesamtAndereKosten
                werteL = letzteVersion.getGesamtAndereKosten
                werteC = hproj.getGesamtAndereKosten

            Case 3
                ' Gesamt Kosten
                If isMinMax Then
                    titelTeile(0) = repMessages.getmsg(191)
                    'titelTeile(0) = "Min/Max Gesamtkosten (T€)" & vbLf
                Else
                    titelTeile(0) = repMessages.getmsg(192)
                    'titelTeile(0) = "Soll/Ist Gesamtkosten (T€)" & vbLf
                End If

                kennung = calcChartKennung("pr", PTprdk.SollIstGesamtkosten, tmpCollection)
                werteB = ersteVersion.getGesamtKostenBedarf
                werteL = letzteVersion.getGesamtKostenBedarf
                werteC = hproj.getGesamtKostenBedarf
            Case 4
                ' Rollen mit Qualifier
                If isMinMax Then
                    titelTeile(0) = "Min/Max " & qualifier & "(" & awinSettings.kapaEinheit & ")"
                Else
                    titelTeile(0) = "Soll-/Ist " & qualifier & "(" & awinSettings.kapaEinheit & ")"
                End If

                kennung = "Rolle " & qualifier
                Try
                    werteB = ersteVersion.getRessourcenBedarf(qualifier)
                    werteL = letzteVersion.getRessourcenBedarf(qualifier)
                    werteC = hproj.getRessourcenBedarf(qualifier)
                Catch ex As Exception
                    Throw New ArgumentException(ex.Message & vbLf & qualifier & " nicht gefunden")
                End Try

            Case 5
                ' Kostenart mit Qualifier
                If isMinMax Then
                    titelTeile(0) = "Min/Max " & qualifier & " (T€)"
                Else
                    titelTeile(0) = "Soll-/Ist " & qualifier & " (T€)"
                End If

                kennung = "Kostenart " & qualifier
                Try
                    werteB = ersteVersion.getKostenBedarf(qualifier)
                    werteL = letzteVersion.getKostenBedarf(qualifier)
                    werteC = hproj.getKostenBedarf(qualifier)
                Catch ex As Exception
                    Throw New ArgumentException(ex.Message & vbLf & qualifier & " nicht gefunden")
                End Try

            Case Else
                ' Gesamt Kosten
                ' Gesamt Kosten
                If isMinMax Then
                    titelTeile(0) = repMessages.getmsg(191)
                    'titelTeile(0) = "Min/Max Gesamtkosten (T€)" & vbLf
                Else
                    titelTeile(0) = repMessages.getmsg(192)
                    'titelTeile(0) = "Soll/Ist Gesamtkosten (T€)" & vbLf
                End If

                kennung = calcChartKennung("pr", PTprdk.SollIstGesamtkosten, tmpCollection)
                werteB = ersteVersion.getGesamtKostenBedarf
                werteL = letzteVersion.getGesamtKostenBedarf
                werteC = hproj.getGesamtKostenBedarf
                auswahl = 3

        End Select

        ' neues Bestimmen der Titelzeile 


        titelTeilLaengen(0) = titelTeile(0).Length
        titelTeile(1) = ""
        'If calledFromReporting Then
        '    titelTeile(1) = vbLf & hproj.getShapeText

        '    If titelTeile(1).Length > maxlenTitle1 + 3 Then
        '        titelTeile(1) = titelTeile(1).Substring(0, maxlenTitle1) & "... (" & hproj.timeStamp.ToString & ") "
        '    Else
        '        titelTeile(1) = titelTeile(1) & " (" & hproj.timeStamp.ToString & ") "
        '    End If
        'Else
        '    titelTeile(1) = ""
        'End If

        titelTeilLaengen(1) = titelTeile(1).Length
        diagramTitle = titelTeile(0) & titelTeile(1)
        'kennung = "Personalbedarf"



        minColumn = 10000
        If ersteVersion.Start < minColumn Then
            minColumn = ersteVersion.Start
        End If

        If letzteVersion.Start < minColumn Then
            minColumn = letzteVersion.Start
        End If

        If hproj.Start < minColumn Then
            minColumn = hproj.Start
        End If


        With hproj
            maxColumn = .Start + .anzahlRasterElemente - 1
        End With

        With ersteVersion
            If maxColumn < .Start + .anzahlRasterElemente - 1 Then
                maxColumn = .Start + .anzahlRasterElemente - 1
            End If
        End With

        With letzteVersion
            If maxColumn < .Start + .anzahlRasterElemente - 1 Then
                maxColumn = .Start + .anzahlRasterElemente - 1
            End If
        End With

        If heuteColumn >= minColumn + 1 And _
            heuteColumn <= maxColumn Then

            pastAndFuture = True

        End If


        ReDim Xdatenreihe(2)
        ReDim tdatenreiheB(2)
        ReDim tdatenreiheL(2)
        ReDim tdatenreiheC(2)

        Xdatenreihe(2) = "Summe" & vbLf & textZeitraum(minColumn, maxColumn)
        If heuteColumn >= minColumn + 1 And heuteColumn <= maxColumn Then
            Xdatenreihe(0) = "Vergangenheit" & vbLf & textZeitraum(minColumn, heuteColumn - 1)
            Xdatenreihe(1) = "Zukunft" & vbLf & textZeitraum(heuteColumn, maxColumn)
        ElseIf heuteColumn > maxColumn Then
            future = False
            Xdatenreihe(0) = "Vergangenheit" & vbLf & textZeitraum(minColumn, maxColumn)
            Xdatenreihe(1) = "Zukunft" & vbLf & "existiert nicht"
        ElseIf heuteColumn <= minColumn Then
            future = True
            Xdatenreihe(0) = "Vergangenheit" & vbLf & "existiert nicht"
            Xdatenreihe(1) = "Zukunft" & vbLf & textZeitraum(minColumn, maxColumn)
        End If


        Dim hsum As Double = 0.0
        ix = 0
        Dim endeIX As Integer
        With ersteVersion

            'If werteB.Sum >= 100 Then
            '    kontrollWert = Math.Round(werteB.Sum)
            'Else
            kontrollWert = Math.Round(werteB.Sum)
            'End If

            endeIX = System.Math.Min(heuteColumn - 1, .Start + .anzahlRasterElemente - 1)
            For i = .Start To endeIX
                hsum = hsum + werteB(ix)
                ix = ix + 1
            Next
            'If hsum >= 100 Then
            '    tdatenreiheB(0) = Math.Round(hsum / 10) * 10
            'Else
            tdatenreiheB(0) = Math.Round(hsum)
            'End If

            tdatenreiheB(1) = kontrollWert - tdatenreiheB(0)
            tdatenreiheB(2) = kontrollWert

        End With

        ix = 0
        With letzteVersion

            'If werteL.Sum >= 100 Then
            '    kontrollWert = Math.Round(werteL.Sum / 10) * 10
            'Else
            kontrollWert = Math.Round(werteL.Sum)
            'End If


            hsum = 0.0
            endeIX = System.Math.Min(heuteColumn - 1, .Start + .anzahlRasterElemente - 1)
            For i = .Start To endeIX
                hsum = hsum + werteL(ix)
                ix = ix + 1
            Next

            'If hsum >= 100 Then
            '    tdatenreiheL(0) = Math.Round(hsum / 10) * 10
            'Else
            tdatenreiheL(0) = Math.Round(hsum)
            'End If

            tdatenreiheL(1) = kontrollWert - tdatenreiheL(0)
            tdatenreiheL(2) = kontrollWert
        End With

        ix = 0
        With hproj

            'If werteC.Sum >= 100 Then
            '    kontrollWert = Math.Round(werteC.Sum / 10) * 10
            'Else
            kontrollWert = Math.Round(werteC.Sum)
            'End If

            hsum = 0.0
            endeIX = System.Math.Min(heuteColumn - 1, .Start + .anzahlRasterElemente - 1)
            For i = .Start To endeIX
                hsum = hsum + werteC(ix)
                ix = ix + 1
            Next

            'If hsum >= 100 Then
            '    tdatenreiheC(0) = Math.Round(hsum / 10) * 10
            'Else
            tdatenreiheC(0) = Math.Round(hsum)
            'End If

            tdatenreiheC(1) = kontrollWert - tdatenreiheC(0)
            tdatenreiheC(2) = kontrollWert
        End With



        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(currentSheetName), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            found = False
            While i <= anzDiagrams And Not found
                Dim chtTitle As String
                Try
                    chtTitle = CType(.ChartObjects(i), Excel.ChartObject).Chart.ChartTitle.Text
                Catch ex As Exception
                    chtTitle = " "
                End Try

                If chtTitle = diagramTitle Then
                    found = True

                Else
                    i = i + 1
                End If

            End While

            If found Then
                'Call MsgBox("Chart wird bereits angezeigt ...")
                reportObj = CType(.ChartObjects(i), Excel.ChartObject)
                appInstance.EnableEvents = formerEE
                'appInstance.ScreenUpdating = formerSU
                Exit Sub
            Else
                newChtObj = CType(.ChartObjects, Excel.ChartObjects).Add(left, top, width, height)
                With CType(newChtObj.Chart, Excel.Chart)
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try

                    .HasAxis(Excel.XlAxisType.xlCategory) = True
                    .HasAxis(Excel.XlAxisType.xlValue) = True

                    'Dim ax As Excel.Axis

                    'With ax
                    '    .MajorUnit = 10000
                    'End With

                    With .Axes(Excel.XlAxisType.xlCategory)
                        .HasTitle = False
                        '.MinimumScale = 0
                        'With .AxisTitle
                        '    .Characters.text = "Monate"
                        '    .Font.Size = 8
                        'End With
                    End With

                    With .Axes(Excel.XlAxisType.xlValue)
                        .HasTitle = False
                        .HasMajorGridlines = False
                        .hasminorgridlines = False
                        '.MajorUnit = 10000
                        '.MinorUnit = 10000
                        '.MaximumScale = maxscale
                        '.MinimumScale = 0

                        'With .AxisTitle
                        '    .Characters.text = "Kosten"
                        '    .Font.Size = 8
                        'End With
                    End With

                    .HasLegend = True
                    With .Legend
                        .Position = Excel.XlLegendPosition.xlLegendPositionTop
                        .Font.Size = awinSettings.fontsizeLegend
                    End With
                    .HasTitle = True
                    .ChartTitle.Text = diagramTitle
                    .ChartTitle.Font.Size = awinSettings.fontsizeTitle


                End With

                'chtobj = CType(.ChartObjects(anzDiagrams + 1), Excel.ChartObject)
                newChtObj.Name = kennung


            End If

            With newChtObj.Chart

                '.ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + _
                '                                                   titelTeilLaengen(1) + 1, titelTeilLaengen(2)).Font.Size = awinSettings.fontsizeLegend

                'series

                If isMinMax Or vglBaseline Then

                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                        If isMinMax Then
                            .Name = repMessages.getmsg(195) & "(" & ersteVersion.timeStamp.ToString("d") & ")"
                            '.Name = "Minimum (" & ersteVersion.timeStamp.ToString("d") & ")"
                        Else
                            .Name = repMessages.getmsg(177) & " (" & ersteVersion.timeStamp.ToString("d") & ")"
                        End If

                        '.name = "Baseline"
                        .Interior.Color = awinSettings.SollIstFarbeB
                        .Values = tdatenreiheB
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlColumnClustered

                        If pastAndFuture Then
                            For i = 0 To 1
                                With .Points(i + 1)

                                    .HasDataLabel = True
                                    .DataLabel.text = Format(tdatenreiheB(i), "###,###0")
                                    .DataLabel.Font.Size = awinSettings.fontsizeItems

                                End With
                            Next
                        ElseIf future Then
                            With .Points(2)

                                .HasDataLabel = True
                                .DataLabel.text = Format(tdatenreiheB(1), "###,###0")
                                .DataLabel.Font.Size = awinSettings.fontsizeItems

                            End With
                        Else
                            With .Points(1)

                                .HasDataLabel = True
                                .DataLabel.text = Format(tdatenreiheB(0), "###,###0")
                                .DataLabel.Font.Size = awinSettings.fontsizeItems

                            End With
                        End If

                        ' jetzt muss noch der Label der Summe geschrieben werden ...
                        With .Points(3)

                            .HasDataLabel = True
                            .DataLabel.text = Format(tdatenreiheB(2), "###,###0")
                            .DataLabel.Font.Size = awinSettings.fontsizeItems

                        End With
                    End With

                End If


                If isMinMax Or Not vglBaseline Then
                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                        If isMinMax Then
                            .Name = repMessages.getmsg(198) & " (" & ersteVersion.timeStamp.ToString("d") & ")"
                            '.Name = "Maximum (" & letzteVersion.timeStamp.ToString("d") & ")"

                        Else
                            '.name = "Last (" & lastPlan.timeStamp.ToString("d") & ")"
                            .Name = repMessages.getmsg(197) & " (" & ersteVersion.timeStamp.ToString("d") & ")"
                            '.Name = "letzte Version: " & letzteVersion.timeStamp.ToString("d") & ")"

                        End If

                        .Interior.Color = awinSettings.SollIstFarbeL
                        .Values = tdatenreiheL
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlColumnClustered

                        If pastAndFuture Then
                            For i = 0 To 1
                                With .Points(i + 1)

                                    .HasDataLabel = True
                                    .DataLabel.text = Format(tdatenreiheL(i), "###,###0")
                                    .DataLabel.Font.Size = awinSettings.fontsizeItems

                                End With
                            Next
                        ElseIf future Then
                            With .Points(2)

                                .HasDataLabel = True
                                .DataLabel.text = Format(tdatenreiheL(1), "###,###0")
                                .DataLabel.Font.Size = awinSettings.fontsizeItems

                            End With
                        Else
                            With .Points(1)

                                .HasDataLabel = True
                                .DataLabel.text = Format(tdatenreiheL(0), "###,###0")
                                .DataLabel.Font.Size = awinSettings.fontsizeItems

                            End With
                        End If

                        ' jetzt muss noch der Label der Summe geschrieben werden ...
                        With .Points(3)

                            .HasDataLabel = True
                            .DataLabel.text = Format(tdatenreiheL(2), "###,###0")
                            .DataLabel.Font.Size = awinSettings.fontsizeItems

                        End With

                    End With

                End If


                With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                    '.name = "Current (" & hproj.timeStamp.ToString("d") & ")"

                    .Name = "current"
                    '.name = "Current"
                    .Interior.Color = awinSettings.SollIstFarbeC
                    .Values = tdatenreiheC
                    .XValues = Xdatenreihe
                    .ChartType = Excel.XlChartType.xlColumnClustered

                    If pastAndFuture Then
                        For i = 0 To 1
                            With .Points(i + 1)

                                .HasDataLabel = True
                                .DataLabel.text = Format(tdatenreiheC(i), "###,###0")
                                .DataLabel.Font.Size = awinSettings.fontsizeItems

                            End With
                        Next
                    ElseIf future Then
                        With .Points(2)

                            .HasDataLabel = True
                            .DataLabel.text = Format(tdatenreiheC(1), "###,###0")
                            .DataLabel.Font.Size = awinSettings.fontsizeItems

                        End With
                    Else
                        With .Points(1)

                            .HasDataLabel = True
                            .DataLabel.text = Format(tdatenreiheC(0), "###,###0")
                            .DataLabel.Font.Size = awinSettings.fontsizeItems

                        End With
                    End If

                    ' jetzt muss noch der Label der Summe geschrieben werden ...
                    With .Points(3)

                        .HasDataLabel = True
                        .DataLabel.text = Format(tdatenreiheC(2), "###,###0")
                        .DataLabel.Font.Size = awinSettings.fontsizeItems

                    End With

                End With
                .ChartGroups(1).Overlap = -50
                .ChartGroups(1).GapWidth = 150
            End With


        End With

        'With chtobj
        '    .Top = top
        '    .Left = left
        '    .Height = height
        '    .Width = width
        'End With

        appInstance.EnableEvents = formerEE
        reportObj = newChtObj

    End Sub


    ''' <summary>
    ''' Voraussetzung: die Projekt-Historie des Projektes ist bereits richtig gesetzt 
    ''' zeigt Soll-/Ist zu Personalkosten, Sonstige Kosten , Gesamtkosten an 
    ''' das wird gesteuert über auswahl ; damit können auch beliebige andere angezeigt werden 
    ''' muss dann aber noch implementiert werden
    ''' 
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="chtObj"></param>
    ''' <param name="heute"></param>
    ''' <param name="auswahl"></param>
    ''' <remarks></remarks>
    Sub updateSollIstOfProject(ByVal hproj As clsProjekt, ByRef chtObj As Excel.ChartObject, ByVal heute As Date, _
                               ByVal auswahl As Integer, ByVal qualifier As String, ByVal vglBaseline As Boolean, _
                               ByVal calledFromPPT As Boolean)

        Dim i As Integer, ix As Integer = 0
        Dim pname As String = hproj.name
        Dim fullname As String = hproj.getShapeText
        Dim kennung As String = " "
        Dim diagramTitle As String = " "
        Dim zE As String = "(" & awinSettings.kapaEinheit & ")"
        Dim titelTeile(2) As String
        Dim titelTeilLaengen(2) As Integer
        Dim kontrollWert As Double
        Dim vgl As Date


        Dim isMinMax As Boolean = False

        Dim ersteVersion As clsProjekt
        Dim letzteVersion As clsProjekt
        Dim anzSnapshots As Integer = projekthistorie.Count


        Dim maxlenTitle1 As Integer = 20

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False


        ' Änderung 18.6 : Unterscheidung zwischen Soll-/Ist Vergleichen und Min/Max Vergleichen 

        If hproj.Status <> ProjektStatus(PTProjektStati.geplant) Then
            ' Soll-Ist Vergleich
            isMinMax = False


            ersteVersion = projekthistorie.beauftragung
            If IsNothing(ersteVersion) Then
                If projekthistorie.Count >= 1 Then
                    ersteVersion = projekthistorie.First
                Else
                    Throw New ArgumentException("es gibt weder Beauftragung noch ersten Stand")
                End If
            End If


            ' finde in der Projekt-Historie das Projekt, das direkt vor hproj gespeichert wurde
            ' 
            vgl = hproj.timeStamp.AddMinutes(-1)
            letzteVersion = projekthistorie.ElementAtorBefore(vgl)
            If IsNothing(letzteVersion) Then
                letzteVersion = projekthistorie.First
            End If

        Else
            ' Min-Max Vergleich 
            isMinMax = True
            Dim minIndex As Integer = 0
            Dim maxIndex As Integer = 0
            Dim minValue As Double, maxValue As Double
            Dim tmpValue As Double
            Select Case auswahl
                Case 1
                    ' Personalkosten
                    With projekthistorie.ElementAt(0)
                        minValue = .getAllPersonalKosten.Sum
                        maxValue = .getAllPersonalKosten.Sum
                    End With

                    For s = 1 To anzSnapshots - 1
                        With projekthistorie.ElementAt(s)
                            tmpValue = .getAllPersonalKosten.Sum
                            If tmpValue < minValue Then
                                minIndex = s
                                minValue = tmpValue
                            End If
                            If tmpValue > maxValue Then
                                maxIndex = s
                                maxValue = tmpValue
                            End If
                        End With
                    Next


                Case 2
                    ' Sonstige Kosten
                    With projekthistorie.ElementAt(0)
                        minValue = .getGesamtAndereKosten.Sum
                        maxValue = .getGesamtAndereKosten.Sum
                    End With

                    For s = 1 To anzSnapshots - 1
                        With projekthistorie.ElementAt(s)
                            tmpValue = .getGesamtAndereKosten.Sum
                            If tmpValue < minValue Then
                                minIndex = s
                                minValue = tmpValue
                            End If
                            If tmpValue > maxValue Then
                                maxIndex = s
                                maxValue = tmpValue
                            End If
                        End With
                    Next
                Case 3
                    ' Gesamtkosten
                    With projekthistorie.ElementAt(0)
                        minValue = .getGesamtKostenBedarf.Sum
                        maxValue = .getGesamtKostenBedarf.Sum
                    End With

                    For s = 1 To anzSnapshots - 1
                        With projekthistorie.ElementAt(s)
                            tmpValue = .getGesamtKostenBedarf.Sum
                            If tmpValue < minValue Then
                                minIndex = s
                                minValue = tmpValue
                            End If
                            If tmpValue > maxValue Then
                                maxIndex = s
                                maxValue = tmpValue
                            End If
                        End With
                    Next
                Case 4
                    ' Rollen mit Qualifier
                    With projekthistorie.ElementAt(0)
                        minValue = .getRessourcenBedarf(qualifier, inclSubRoles:=True, outPutInEuro:=True).Sum
                        maxValue = minValue
                    End With

                    For s = 1 To anzSnapshots - 1
                        With projekthistorie.ElementAt(s)
                            tmpValue = .getRessourcenBedarf(qualifier, inclSubRoles:=True, outPutInEuro:=True).Sum
                            If tmpValue < minValue Then
                                minIndex = s
                                minValue = tmpValue
                            End If
                            If tmpValue > maxValue Then
                                maxIndex = s
                                maxValue = tmpValue
                            End If
                        End With
                    Next


                Case 5
                    ' Kostenart mit Qualifier
                    With projekthistorie.ElementAt(0)
                        minValue = .getKostenBedarf(qualifier).Sum
                        maxValue = .getKostenBedarf(qualifier).Sum
                    End With

                    For s = 1 To anzSnapshots - 1
                        With projekthistorie.ElementAt(s)
                            tmpValue = .getKostenBedarf(qualifier).Sum
                            If tmpValue < minValue Then
                                minIndex = s
                                minValue = tmpValue
                            End If
                            If tmpValue > maxValue Then
                                maxIndex = s
                                maxValue = tmpValue
                            End If
                        End With
                    Next

                Case Else
                    ' Gesamtkosten
                    With projekthistorie.ElementAt(0)
                        minValue = .getGesamtKostenBedarf.Sum
                        maxValue = .getGesamtKostenBedarf.Sum
                    End With

                    For s = 1 To anzSnapshots - 1
                        With projekthistorie.ElementAt(s)
                            tmpValue = .getGesamtKostenBedarf.Sum
                            If tmpValue < minValue Then
                                minIndex = s
                                minValue = tmpValue
                            End If
                            If tmpValue > maxValue Then
                                maxIndex = s
                                maxValue = tmpValue
                            End If
                        End With
                    Next
            End Select

            Try
                ersteVersion = projekthistorie.ElementAt(minIndex)
                letzteVersion = projekthistorie.ElementAt(maxIndex)
            Catch ex As Exception
                Throw New ArgumentException("Fehler in Min-/Max Bestimmung " & ex.Message)
            End Try

        End If



        ' Ende Ergänzung 18.6 Min/Max 


        Dim minColumn As Integer, maxColumn As Integer, heuteColumn As Integer = getColumnOfDate(heute)
        Dim pastAndFuture As Boolean = False
        Dim future As Boolean = True

        Dim werteB(ersteVersion.anzahlRasterElemente - 1) As Double
        Dim werteL(letzteVersion.anzahlRasterElemente - 1) As Double
        Dim werteC(hproj.anzahlRasterElemente - 1) As Double

        Dim Xdatenreihe() As String
        Dim tdatenreiheB() As Double
        Dim tdatenreiheL() As Double
        Dim tdatenreiheC() As Double
        Dim tmpCollection As New Collection
        tmpCollection.Add(hproj.name & "#" & auswahl.ToString)
        ' Bestimmen der Werte 

        Select Case auswahl
            Case 1
                ' Personalkosten
                If isMinMax Then
                    titelTeile(0) = repMessages.getmsg(187)
                    'titelTeile(0) = "Min/Max Personalkosten (T€)" & vbLf
                Else
                    titelTeile(0) = repMessages.getmsg(188)
                    'titelTeile(0) = "Soll/Ist Personalkosten (T€)" & vbLf
                End If
                kennung = calcChartKennung("pr", PTprdk.SollIstPersonalkosten, tmpCollection)
                'kennung = "Soll/Ist Personalkosten"
                werteB = ersteVersion.getAllPersonalKosten
                werteL = letzteVersion.getAllPersonalKosten
                werteC = hproj.getAllPersonalKosten
            Case 2
                ' Sonstige Kosten
                If isMinMax Then
                    titelTeile(0) = repMessages.getmsg(189)
                    'titelTeile(0) = "Min/Max Sonstige Kosten (T€)" & vbLf
                Else
                    titelTeile(0) = repMessages.getmsg(190)
                    'titelTeile(0) = "Soll/Ist Sonstige Kosten (T€)" & vbLf
                End If

                kennung = calcChartKennung("pr", PTprdk.SollIstSonstKosten, tmpCollection)
                werteB = ersteVersion.getGesamtAndereKosten
                werteL = letzteVersion.getGesamtAndereKosten
                werteC = hproj.getGesamtAndereKosten

            Case 3
                ' Gesamt Kosten
                If isMinMax Then
                    titelTeile(0) = repMessages.getmsg(191)
                    'titelTeile(0) = "Min/Max Gesamtkosten (T€)" & vbLf
                Else
                    titelTeile(0) = repMessages.getmsg(192)
                    'titelTeile(0) = "Soll/Ist Gesamtkosten (T€)" & vbLf
                End If

                kennung = calcChartKennung("pr", PTprdk.SollIstGesamtkosten, tmpCollection)
                werteB = ersteVersion.getGesamtKostenBedarf
                werteL = letzteVersion.getGesamtKostenBedarf
                werteC = hproj.getGesamtKostenBedarf
            Case 4
                ' Rollen mit Qualifier
                If isMinMax Then
                    titelTeile(0) = "Min/Max " & qualifier & "(" & awinSettings.kapaEinheit & ")"
                Else
                    titelTeile(0) = "Soll-/Ist " & qualifier & "(" & awinSettings.kapaEinheit & ")"
                End If

                kennung = "Rolle " & qualifier
                Try
                    werteB = ersteVersion.getRessourcenBedarf(qualifier)
                    werteL = letzteVersion.getRessourcenBedarf(qualifier)
                    werteC = hproj.getRessourcenBedarf(qualifier)
                Catch ex As Exception
                    Throw New ArgumentException(ex.Message & vbLf & qualifier & " nicht gefunden")
                End Try

            Case 5
                ' Kostenart mit Qualifier
                If isMinMax Then
                    titelTeile(0) = "Min/Max " & qualifier & " (T€)"
                Else
                    titelTeile(0) = "Soll-/Ist " & qualifier & " (T€)"
                End If

                kennung = "Kostenart " & qualifier
                Try
                    werteB = ersteVersion.getKostenBedarf(qualifier)
                    werteL = letzteVersion.getKostenBedarf(qualifier)
                    werteC = hproj.getKostenBedarf(qualifier)
                Catch ex As Exception
                    Throw New ArgumentException(ex.Message & vbLf & qualifier & " nicht gefunden")
                End Try

            Case Else
                ' Gesamt Kosten
                ' Gesamt Kosten
                If isMinMax Then
                    titelTeile(0) = repMessages.getmsg(191)
                    'titelTeile(0) = "Min/Max Gesamtkosten (T€)" & vbLf
                Else
                    titelTeile(0) = repMessages.getmsg(192)
                    'titelTeile(0) = "Soll/Ist Gesamtkosten (T€)" & vbLf
                End If

                kennung = calcChartKennung("pr", PTprdk.SollIstGesamtkosten, tmpCollection)
                werteB = ersteVersion.getGesamtKostenBedarf
                werteL = letzteVersion.getGesamtKostenBedarf
                werteC = hproj.getGesamtKostenBedarf
                auswahl = 3

        End Select

        ' neues Bestimmen der Titelzeile 


        titelTeilLaengen(0) = titelTeile(0).Length
        titelTeile(1) = ""
        titelTeilLaengen(1) = titelTeile(1).Length
        diagramTitle = titelTeile(0) & titelTeile(1)



        minColumn = 10000
        If ersteVersion.Start < minColumn Then
            minColumn = ersteVersion.Start
        End If

        If letzteVersion.Start < minColumn Then
            minColumn = letzteVersion.Start
        End If

        If hproj.Start < minColumn Then
            minColumn = hproj.Start
        End If


        With hproj
            maxColumn = .Start + .anzahlRasterElemente - 1
        End With

        With ersteVersion
            If maxColumn < .Start + .anzahlRasterElemente - 1 Then
                maxColumn = .Start + .anzahlRasterElemente - 1
            End If
        End With

        With letzteVersion
            If maxColumn < .Start + .anzahlRasterElemente - 1 Then
                maxColumn = .Start + .anzahlRasterElemente - 1
            End If
        End With

        If heuteColumn >= minColumn + 1 And _
            heuteColumn <= maxColumn Then

            pastAndFuture = True

        End If


        ReDim Xdatenreihe(2)
        ReDim tdatenreiheB(2)
        ReDim tdatenreiheL(2)
        ReDim tdatenreiheC(2)

        Xdatenreihe(2) = "Summe" & vbLf & textZeitraum(minColumn, maxColumn)
        If heuteColumn >= minColumn + 1 And heuteColumn <= maxColumn Then
            Xdatenreihe(0) = "Vergangenheit" & vbLf & textZeitraum(minColumn, heuteColumn - 1)
            Xdatenreihe(1) = "Zukunft" & vbLf & textZeitraum(heuteColumn, maxColumn)
        ElseIf heuteColumn > maxColumn Then
            future = False
            Xdatenreihe(0) = "Vergangenheit" & vbLf & textZeitraum(minColumn, maxColumn)
            Xdatenreihe(1) = "Zukunft" & vbLf & "existiert nicht"
        ElseIf heuteColumn <= minColumn Then
            future = True
            Xdatenreihe(0) = "Vergangenheit" & vbLf & "existiert nicht"
            Xdatenreihe(1) = "Zukunft" & vbLf & textZeitraum(minColumn, maxColumn)
        End If


        Dim hsum As Double = 0.0
        ix = 0
        Dim endeIX As Integer
        With ersteVersion

            'If werteB.Sum >= 100 Then
            '    kontrollWert = Math.Round(werteB.Sum)
            'Else
            kontrollWert = Math.Round(werteB.Sum)
            'End If

            endeIX = System.Math.Min(heuteColumn - 1, .Start + .anzahlRasterElemente - 1)
            For i = .Start To endeIX
                hsum = hsum + werteB(ix)
                ix = ix + 1
            Next
            'If hsum >= 100 Then
            '    tdatenreiheB(0) = Math.Round(hsum / 10) * 10
            'Else
            tdatenreiheB(0) = Math.Round(hsum)
            'End If

            tdatenreiheB(1) = kontrollWert - tdatenreiheB(0)
            tdatenreiheB(2) = kontrollWert

        End With

        ix = 0
        With letzteVersion

            'If werteL.Sum >= 100 Then
            '    kontrollWert = Math.Round(werteL.Sum / 10) * 10
            'Else
            kontrollWert = Math.Round(werteL.Sum)
            'End If


            hsum = 0.0
            endeIX = System.Math.Min(heuteColumn - 1, .Start + .anzahlRasterElemente - 1)
            For i = .Start To endeIX
                hsum = hsum + werteL(ix)
                ix = ix + 1
            Next

            'If hsum >= 100 Then
            '    tdatenreiheL(0) = Math.Round(hsum / 10) * 10
            'Else
            tdatenreiheL(0) = Math.Round(hsum)
            'End If

            tdatenreiheL(1) = kontrollWert - tdatenreiheL(0)
            tdatenreiheL(2) = kontrollWert
        End With

        ix = 0
        With hproj

            'If werteC.Sum >= 100 Then
            '    kontrollWert = Math.Round(werteC.Sum / 10) * 10
            'Else
            kontrollWert = Math.Round(werteC.Sum)
            'End If

            hsum = 0.0
            endeIX = System.Math.Min(heuteColumn - 1, .Start + .anzahlRasterElemente - 1)
            For i = .Start To endeIX
                hsum = hsum + werteC(ix)
                ix = ix + 1
            Next

            'If hsum >= 100 Then
            '    tdatenreiheC(0) = Math.Round(hsum / 10) * 10
            'Else
            tdatenreiheC(0) = Math.Round(hsum)
            'End If

            tdatenreiheC(1) = kontrollWert - tdatenreiheC(0)
            tdatenreiheC(2) = kontrollWert
        End With

        With CType(chtObj.Chart, Excel.Chart)
            ' remove old series
            Try
                Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                Do While anz > 0
                    .SeriesCollection(1).Delete()
                    anz = anz - 1
                Loop
            Catch ex As Exception

            End Try


            If .HasTitle Then
                .ChartTitle.Text = diagramTitle
                ' Änderung tk: wieder mit reingenmmen, da ja jetzt zu Beginn die fontsize1, ..2 bestimmt werden 
                '.ChartTitle.Font.Size = CSng(fontSize1)
                '.ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                '    titelTeilLaengen(1)).Font.Size = CSng(fontSize2)
                '.ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + _
                '                                               titelTeilLaengen(1) + 1, titelTeilLaengen(2)).Font.Size = awinSettings.fontsizeLegend

            End If



        End With

        chtObj.Name = kennung



        With chtObj.Chart

            'series

            If isMinMax Or vglBaseline Then

                With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                    If isMinMax Then
                        .Name = repMessages.getmsg(195) & "(" & ersteVersion.timeStamp.ToString("d") & ")"
                        '.Name = "Minimum (" & ersteVersion.timeStamp.ToString("d") & ")"
                    Else
                        .Name = repMessages.getmsg(177) & " (" & ersteVersion.timeStamp.ToString("d") & ")"
                    End If

                    '.name = "Baseline"
                    .Interior.Color = awinSettings.SollIstFarbeB
                    .Values = tdatenreiheB
                    .XValues = Xdatenreihe
                    .ChartType = Excel.XlChartType.xlColumnClustered

                    If pastAndFuture Then
                        For i = 0 To 1
                            With .Points(i + 1)

                                .HasDataLabel = True
                                .DataLabel.text = Format(tdatenreiheB(i), "###,###0")
                                .DataLabel.Font.Size = awinSettings.fontsizeItems

                            End With
                        Next
                    ElseIf future Then
                        With .Points(2)

                            .HasDataLabel = True
                            .DataLabel.text = Format(tdatenreiheB(1), "###,###0")
                            .DataLabel.Font.Size = awinSettings.fontsizeItems

                        End With
                    Else
                        With .Points(1)

                            .HasDataLabel = True
                            .DataLabel.text = Format(tdatenreiheB(0), "###,###0")
                            .DataLabel.Font.Size = awinSettings.fontsizeItems

                        End With
                    End If

                    ' jetzt muss noch der Label der Summe geschrieben werden ...
                    With .Points(3)

                        .HasDataLabel = True
                        .DataLabel.text = Format(tdatenreiheB(2), "###,###0")
                        .DataLabel.Font.Size = awinSettings.fontsizeItems

                    End With
                End With

            End If


            If isMinMax Or Not vglBaseline Then
                With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                    If isMinMax Then
                        .Name = repMessages.getmsg(198) & " (" & ersteVersion.timeStamp.ToString("d") & ")"
                        '.Name = "Maximum (" & letzteVersion.timeStamp.ToString("d") & ")"

                    Else
                        '.name = "Last (" & lastPlan.timeStamp.ToString("d") & ")"
                        .Name = repMessages.getmsg(197) & " (" & ersteVersion.timeStamp.ToString("d") & ")"
                        '.Name = "letzte Version: " & letzteVersion.timeStamp.ToString("d") & ")"

                    End If

                    .Interior.Color = awinSettings.SollIstFarbeL
                    .Values = tdatenreiheL
                    .XValues = Xdatenreihe
                    .ChartType = Excel.XlChartType.xlColumnClustered

                    If pastAndFuture Then
                        For i = 0 To 1
                            With .Points(i + 1)

                                .HasDataLabel = True
                                .DataLabel.text = Format(tdatenreiheL(i), "###,###0")
                                .DataLabel.Font.Size = awinSettings.fontsizeItems

                            End With
                        Next
                    ElseIf future Then
                        With .Points(2)

                            .HasDataLabel = True
                            .DataLabel.text = Format(tdatenreiheL(1), "###,###0")
                            .DataLabel.Font.Size = awinSettings.fontsizeItems

                        End With
                    Else
                        With .Points(1)

                            .HasDataLabel = True
                            .DataLabel.text = Format(tdatenreiheL(0), "###,###0")
                            .DataLabel.Font.Size = awinSettings.fontsizeItems

                        End With
                    End If

                    ' jetzt muss noch der Label der Summe geschrieben werden ...
                    With .Points(3)

                        .HasDataLabel = True
                        .DataLabel.text = Format(tdatenreiheL(2), "###,###0")
                        .DataLabel.Font.Size = awinSettings.fontsizeItems

                    End With

                End With

            End If


            With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                '.name = "Current (" & hproj.timeStamp.ToString("d") & ")"

                .Name = "current"
                '.name = "Current"
                .Interior.Color = awinSettings.SollIstFarbeC
                .Values = tdatenreiheC
                .XValues = Xdatenreihe
                .ChartType = Excel.XlChartType.xlColumnClustered

                If pastAndFuture Then
                    For i = 0 To 1
                        With .Points(i + 1)

                            .HasDataLabel = True
                            .DataLabel.text = Format(tdatenreiheC(i), "###,###0")
                            .DataLabel.Font.Size = awinSettings.fontsizeItems

                        End With
                    Next
                ElseIf future Then
                    With .Points(2)

                        .HasDataLabel = True
                        .DataLabel.text = Format(tdatenreiheC(1), "###,###0")
                        .DataLabel.Font.Size = awinSettings.fontsizeItems

                    End With
                Else
                    With .Points(1)

                        .HasDataLabel = True
                        .DataLabel.text = Format(tdatenreiheC(0), "###,###0")
                        .DataLabel.Font.Size = awinSettings.fontsizeItems

                    End With
                End If

                ' jetzt muss noch der Label der Summe geschrieben werden ...
                With .Points(3)

                    .HasDataLabel = True
                    .DataLabel.text = Format(tdatenreiheC(2), "###,###0")
                    .DataLabel.Font.Size = awinSettings.fontsizeItems

                End With

            End With
            .ChartGroups(1).Overlap = -50
            .ChartGroups(1).GapWidth = 150
        End With

            
        appInstance.EnableEvents = formerEE


    End Sub




    ''' <summary>
    ''' zeigt bei beauftragten Projekten den Soll-/Ist Vergleich an
    ''' zeigt bei nicht beauftragten Projekten den Vergleich zwischen Min/Max/Current an
    ''' es muss keine Historie mehr geben, es reicht wenn das Vergleichsprojekt 
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="reportObj"></param>
    ''' <param name="heute"></param>
    ''' <param name="auswahl"></param>
    ''' <param name="top"></param>
    ''' <param name="left"></param>
    ''' <param name="height"></param>
    ''' <param name="width"></param>
    ''' <remarks></remarks>
    Sub createSollIstCurveOfProject(ByVal hproj As clsProjekt, ByVal bproj As clsProjekt, ByRef reportObj As Excel.ChartObject, ByVal heute As Date, ByVal auswahl As Integer, ByVal qualifier As String, ByVal vglBaseline As Boolean,
                                           ByVal top As Double, ByVal left As Double, ByVal height As Double, ByVal width As Double)
        'Dim chtobj As Excel.ChartObject
        Dim anzDiagrams As Integer
        Dim i As Integer, ix As Integer = 0
        Dim found As Boolean
        Dim abbruch As Boolean = False
        Dim pname As String = hproj.name
        Dim fullname As String = hproj.getShapeText
        Dim kennung As String = " "
        Dim diagramTitle As String = " "
        Dim zE As String = "(" & awinSettings.kapaEinheit & ")"
        Dim titelTeile(2) As String
        Dim titelTeilLaengen(2) As Integer
        Dim sumB As Double, sumL As Double, sumC As Double
        Dim isMinMax As Boolean = False
        ' zaehleinheit ist T€ oder PT ...
        Dim zaehlEinheit As String = ""

        Dim beauftragung As clsProjekt
        Dim lastPlan As clsProjekt
        Dim anzSnapshots As Integer = projekthistorie.Count

        Dim currentSheetName As String = ""
        Dim maxlenTitle1 As Integer = 20
        Dim newChtObj As Excel.ChartObject = Nothing



        ' aktuell wird es nur von Report Generation aufgerufen ...
        Dim calledFromReporting As Boolean = True

        If visboZustaende.projectBoardMode = ptModus.graficboard Then
            If calledFromReporting Then
                currentSheetName = arrWsNames(ptTables.repCharts)
            Else
                currentSheetName = arrWsNames(ptTables.mptPrCharts)
            End If

        Else
            currentSheetName = arrWsNames(ptTables.meCharts)
        End If

        beauftragung = bproj
        lastPlan = bproj

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False


        Dim minColumn As Integer, maxColumn As Integer
        Dim gesternColumn As Integer = -1
        Dim pastAndFuture As Boolean = False

        Dim werteB(beauftragung.anzahlRasterElemente - 1) As Double
        Dim werteL(lastPlan.anzahlRasterElemente - 1) As Double
        Dim werteC(hproj.anzahlRasterElemente - 1) As Double

        Dim Xdatenreihe() As String
        ' die folgenden müssen die gleiche Dimension haben ihre Pendants oben ...
        Dim tdatenreiheB(beauftragung.anzahlRasterElemente - 1) As Double
        Dim tdatenreiheL(lastPlan.anzahlRasterElemente - 1) As Double
        Dim tdatenreiheC(hproj.anzahlRasterElemente - 1) As Double

        Dim gesterndatenreihe() As Double
        Dim Xgestern() As String

        Dim tmpCollection As New Collection
        tmpCollection.Add(hproj.name & "#" & auswahl.ToString & "#" & qualifier & "#" & CInt(vglBaseline).ToString)
        ' Bestimmen der Werte 

        ' jetzt muss bestimmt werden, ob und bis wann es Actual Data gibt ...
        If hproj.actualDataUntil > Date.MinValue Then
            If DateDiff(DateInterval.Month, hproj.startDate, hproj.actualDataUntil) > 0 Then
                gesternColumn = getColumnOfDate(hproj.actualDataUntil)
            End If
        End If

        ' wird benötigt, weil xml-texte aktuell noch nicht in DB sind - und sonst kann das nicht aktualisiert werden 
        Dim repMSg(2, 1) As String
        repMSg(0, 0) = "kumulierte Personalkosten"
        repMSg(0, 1) = "cumulated Personnel Cost"

        repMSg(1, 0) = "kumulierte Sonstige Kosten"
        repMSg(1, 1) = "cumulated Other Cost"

        repMSg(2, 0) = "kumulierte Gesamtkosten"
        repMSg(2, 1) = "cumulated Total Cost"

        Select Case auswahl
            Case 1
                ' Personalkosten
                If isMinMax Then
                    'titelTeile(0) = "Min/Max Personalkosten (T€)" & vbLf
                    titelTeile(0) = repMessages.getmsg(187)

                Else
                    'titelTeile(0) = "Soll/Ist Personalkosten (T€)" & vbLf
                    If awinSettings.englishLanguage Then
                        titelTeile(0) = repMSg(0, 1) & " " & qualifier
                    Else
                        titelTeile(0) = repMSg(0, 0) & " " & qualifier
                    End If

                End If
                zaehlEinheit = "T€"
                kennung = calcChartKennung("pr", PTprdk.SollIstPersonalkostenC, tmpCollection)
                'kennung = "Soll/Ist Kurve Personalkosten"
                If qualifier = "" Then
                    'werteB = beauftragung.getAllPersonalKosten
                    werteB = beauftragung.getRessourcenBedarf("", outPutInEuro:=True)
                    'werteL = lastPlan.getAllPersonalKosten
                    werteL = lastPlan.getRessourcenBedarf("", outPutInEuro:=True)
                    'werteC = hproj.getAllPersonalKosten
                    werteC = hproj.getRessourcenBedarf("", outPutInEuro:=True)
                Else
                    'werteB = beauftragung.getPersonalKosten(qualifier, True)
                    werteB = beauftragung.getRessourcenBedarf(qualifier, inclSubRoles:=True, outPutInEuro:=True)
                    'werteL = lastPlan.getPersonalKosten(qualifier, True)
                    werteL = lastPlan.getRessourcenBedarf(qualifier, inclSubRoles:=True, outPutInEuro:=True)
                    'werteC = hproj.getPersonalKosten(qualifier, True)
                    werteC = hproj.getRessourcenBedarf(qualifier, inclSubRoles:=True, outPutInEuro:=True)
                End If

            Case 2
                ' Sonstige Kosten
                If isMinMax Then
                    'titelTeile(0) = "Min/Max Sonstige Kosten" 
                    titelTeile(0) = repMessages.getmsg(189)
                Else
                    'titelTeile(0) = "Soll/Ist Sonstige Kosten" 
                    If awinSettings.englishLanguage Then
                        titelTeile(0) = repMSg(1, 1)
                    Else
                        titelTeile(0) = repMSg(1, 0)
                    End If

                End If
                zaehlEinheit = "T€"
                kennung = calcChartKennung("pr", PTprdk.SollIstSonstKostenC, tmpCollection)
                'kennung = "Soll/Ist Kurve Sonstige Kosten"
                werteB = beauftragung.getGesamtAndereKosten
                werteL = lastPlan.getGesamtAndereKosten
                werteC = hproj.getGesamtAndereKosten

            Case 3
                ' Gesamt Kosten
                If isMinMax Then
                    'titelTeile(0) = "Min/Max Gesamtkosten"
                    titelTeile(0) = repMessages.getmsg(191)
                Else
                    'titelTeile(0) = "Soll/Ist Gesamtkosten"
                    If awinSettings.englishLanguage Then
                        titelTeile(0) = repMSg(2, 1)
                    Else
                        titelTeile(0) = repMSg(2, 0)
                    End If
                End If
                zaehlEinheit = "T€"
                'kennung = "Soll/Ist Kurve Gesamtkosten"
                kennung = calcChartKennung("pr", PTprdk.SollIstGesamtkostenC, tmpCollection)
                werteB = beauftragung.getGesamtKostenBedarf
                werteL = lastPlan.getGesamtKostenBedarf
                werteC = hproj.getGesamtKostenBedarf

            Case 4
                ' Rollen mit Qualifier
                titelTeile(0) = qualifier
                zaehlEinheit = awinSettings.kapaEinheit

                'kennung = "Rolle " & qualifier
                kennung = calcChartKennung("pr", PTprdk.SollIstRolleC, tmpCollection)
                Try
                    werteB = beauftragung.getRessourcenBedarf(qualifier, inclSubRoles:=True)
                    werteL = lastPlan.getRessourcenBedarf(qualifier, inclSubRoles:=True)
                    werteC = hproj.getRessourcenBedarf(qualifier, inclSubRoles:=True)
                Catch ex As Exception
                    'Throw New ArgumentException(ex.Message & vbLf & qualifier & " nicht gefunden")
                    Throw New ArgumentException(ex.Message & vbLf & qualifier & repMessages.getmsg(193))
                End Try

            Case 5
                ' Kostenart mit Qualifier
                titelTeile(0) = qualifier
                zaehlEinheit = "T€"
                'kennung = "Kostenart " & qualifier
                kennung = calcChartKennung("pr", PTprdk.SollIstKostenartC, tmpCollection)
                Try
                    werteB = beauftragung.getKostenBedarf(qualifier)
                    werteL = lastPlan.getKostenBedarf(qualifier)
                    werteC = hproj.getKostenBedarf(qualifier)
                Catch ex As Exception
                    'Throw New ArgumentException(ex.Message & vbLf & qualifier & " nicht gefunden")
                    Throw New ArgumentException(ex.Message & vbLf & qualifier & repMessages.getmsg(193))
                End Try

            Case Else
                ' Gesamt Kosten
                If isMinMax Then
                    'titelTeile(0) = "Min/Max Gesamtkosten"
                    titelTeile(0) = repMessages.getmsg(191)
                Else
                    'titelTeile(0) = "Soll/Ist Gesamtkosten"
                    If awinSettings.englishLanguage Then
                        titelTeile(0) = repMSg(2, 1)
                    Else
                        titelTeile(0) = repMSg(2, 0)
                    End If
                End If

                zaehlEinheit = "T€"
                'kennung = "Soll/Ist Kurve Gesamtkosten"
                kennung = calcChartKennung("pr", PTprdk.SollIstGesamtkostenC, tmpCollection)
                werteB = beauftragung.getGesamtKostenBedarf
                werteL = lastPlan.getGesamtKostenBedarf
                werteC = hproj.getGesamtKostenBedarf
                auswahl = 3

        End Select

        ' tk, 25.1.18 
        Dim tmpSum As String
        If vglBaseline Then
            If projekthistorie.Count > 1 Then
                tmpSum = " (" & werteC.Sum.ToString("##,##0.") & " / " & werteB.Sum.ToString("##,##0.") & " " & zaehlEinheit & ")"
            Else
                tmpSum = " (" & werteC.Sum.ToString("##,##0.") & zaehlEinheit & ")"
            End If
            'tmpSum = " (" & werteB.Sum.ToString("####0.") & " / " & werteC.Sum.ToString("####0.") & " " & zaehlEinheit & ")"

        Else
            tmpSum = " (" & werteC.Sum.ToString("##,##0.") & zaehlEinheit & ")"
        End If



        titelTeile(0) = titelTeile(0) & tmpSum
        titelTeilLaengen(0) = titelTeile(0).Length
        diagramTitle = titelTeile(0)


        minColumn = 10000
        If beauftragung.Start < minColumn Then
            minColumn = beauftragung.Start
        End If

        If lastPlan.Start < minColumn Then
            minColumn = lastPlan.Start
        End If

        If hproj.Start < minColumn Then
            minColumn = hproj.Start
        End If


        With hproj
            maxColumn = .Start + .anzahlRasterElemente - 1
            ReDim tdatenreiheC(maxColumn - minColumn)
        End With

        With beauftragung
            If maxColumn < .Start + .anzahlRasterElemente - 1 Then
                maxColumn = .Start + .anzahlRasterElemente - 1
            End If
            ReDim tdatenreiheB(.Start + .anzahlRasterElemente - 1 - minColumn)
        End With

        With lastPlan
            If maxColumn < .Start + .anzahlRasterElemente - 1 Then
                maxColumn = .Start + .anzahlRasterElemente - 1
            End If
            ReDim tdatenreiheL(.Start + .anzahlRasterElemente - 1 - minColumn)
        End With

        ReDim Xdatenreihe(maxColumn - minColumn)

        sumB = 0.0
        sumL = 0.0
        sumC = 0.0
        For i = minColumn To maxColumn
            Xdatenreihe(i - minColumn) = StartofCalendar.AddMonths(i - 1).ToString("MMM yy", repCult)
            With beauftragung
                If i >= .Start And i <= .Start + .anzahlRasterElemente - 1 Then
                    tdatenreiheB(i - minColumn) = sumB + werteB(i - .Start)
                    sumB = tdatenreiheB(i - minColumn)
                Else
                    ' tk 25.1.18 nichts machen ..
                    'tdatenreiheB(i - minColumn) = sumB
                End If
            End With

            With lastPlan
                If i >= .Start And i <= .Start + .anzahlRasterElemente - 1 Then
                    tdatenreiheL(i - minColumn) = sumL + werteL(i - .Start)
                    sumL = tdatenreiheL(i - minColumn)
                Else
                    ' tk 25.1.18 nichts machen
                    ' tdatenreiheL(i - minColumn) = sumL
                End If
            End With

            With hproj
                If i >= .Start And i <= .Start + .anzahlRasterElemente - 1 Then
                    tdatenreiheC(i - minColumn) = sumC + werteC(i - .Start)
                    sumC = tdatenreiheC(i - minColumn)
                Else
                    ' tk 25.1.18 nichts machen
                    ' tdatenreiheC(i - minColumn) = sumC
                End If
            End With

        Next i


        If gesternColumn >= minColumn And
            gesternColumn <= maxColumn Then

            pastAndFuture = True
            ReDim gesterndatenreihe(gesternColumn - minColumn)
            ReDim Xgestern(gesternColumn - minColumn)
            For i = minColumn To gesternColumn
                gesterndatenreihe(i - minColumn) = tdatenreiheC(i - minColumn)
                ' tk 23.8.18
                If i < gesternColumn Then
                    tdatenreiheC(i - minColumn) = 0
                End If
                Xgestern(i - minColumn) = Xdatenreihe(i - minColumn)
            Next
        Else
            ReDim gesterndatenreihe(0)
            ReDim Xgestern(0)
            pastAndFuture = False


        End If

        ' jetzt wird das Diagramm gezeichnet 

        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(currentSheetName), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            found = False
            While i <= anzDiagrams And Not found
                Dim chtTitle As String
                Try
                    chtTitle = CType(.ChartObjects(i), Excel.ChartObject).Chart.ChartTitle.Text
                Catch ex As Exception
                    chtTitle = " "
                End Try

                If chtTitle = diagramTitle Then
                    found = True

                Else
                    i = i + 1
                End If

            End While

            If found Then
                'Call MsgBox("Chart wird bereits angezeigt ...")
                reportObj = CType(.ChartObjects(i), Excel.ChartObject)
                appInstance.EnableEvents = formerEE
                'appInstance.ScreenUpdating = formerSU
                Exit Sub
            Else
                newChtObj = CType(.ChartObjects, Excel.ChartObjects).Add(left, top, width, height)
                With CType(newChtObj.Chart, Excel.Chart)
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(.SeriesCollection.count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try

                    .HasAxis(Excel.XlAxisType.xlCategory) = True
                    .HasAxis(Excel.XlAxisType.xlValue) = True

                    'Dim ax As Excel.Axis

                    'With ax
                    '    .MajorUnit = 10000
                    'End With

                    With .Axes(Excel.XlAxisType.xlCategory)
                        .HasTitle = False
                        '.MinimumScale = 0
                        'With .AxisTitle
                        '    .Characters.text = "Monate"
                        '    .Font.Size = 8
                        'End With
                    End With

                    With .Axes(Excel.XlAxisType.xlValue)
                        .HasTitle = False
                        .HasMajorGridlines = False
                        .HasMinorGridlines = False
                    End With

                    .HasLegend = True
                    With .Legend
                        .Position = Excel.XlLegendPosition.xlLegendPositionTop
                        .Font.Size = awinSettings.fontsizeLegend
                    End With
                    .HasTitle = True
                    .ChartTitle.Text = diagramTitle
                    .ChartTitle.Font.Size = awinSettings.fontsizeTitle



                End With

                ' alt, tk 25.1.18
                'newChtObj.Name = pname & "#" & kennung & "#" & "1"
                newChtObj.Name = kennung


            End If

            With newChtObj.Chart

                '.ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + _
                '                                                   titelTeilLaengen(1) + 1, titelTeilLaengen(2)).Font.Size = awinSettings.fontsizeLegend

                'series


                ' 
                With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)

                    '.Name = repMessages.getmsg(38) & " " & hproj.timeStamp.ToString("d")
                    .Name = repMessages.getmsg(38)
                    '.Name = "Version (" & hproj.timeStamp.ToString("d") & ")"
                    '.Interior.Color = awinSettings.SollIstFarbeC
                    .Interior.Color = visboFarbeBlau
                    .Values = tdatenreiheC
                    .XValues = Xdatenreihe
                    If pastAndFuture Then
                        .Interior.Color = visboFarbeBlau
                        .ChartType = Excel.XlChartType.xlArea
                    Else
                        .ChartType = Excel.XlChartType.xlLine
                        .Format.Line.Weight = 4
                        .Format.Line.ForeColor.RGB = visboFarbeBlau
                    End If


                End With

                If Not IsNothing(bproj) Then
                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                        If isMinMax Then
                            '.name = "Minimum (" & beauftragung.timeStamp.ToString("d") & ")"
                            .Name = repMessages.getmsg(195) & " " & beauftragung.timeStamp.ToString("d")

                        Else
                            '.name = "Soll (" & beauftragung.timeStamp.ToString("d") & ")"
                            '.Name = repMessages.getmsg(43) & " " & beauftragung.timeStamp.ToString("d")
                            ' Stand vom ...
                            .Name = repMessages.getmsg(43) & " " & beauftragung.timeStamp.ToString("d")

                        End If
                        '.Name = "Version (" & beauftragung.timeStamp.ToString("d") & ")"
                        '.Interior.Color = awinSettings.SollIstFarbeB
                        .Interior.Color = visboFarbeOrange
                        .Values = tdatenreiheB
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlLine

                        With .Format.Line
                            .Weight = 4
                            .ForeColor.RGB = visboFarbeOrange
                            .DashStyle = core.MsoLineDashStyle.msoLineDash
                        End With


                    End With
                End If


                If pastAndFuture Then
                    ' dann muss jetzt die "Ist-Markierung gezeichnet werden 

                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                        '.name = "Istwerte"
                        .Name = repMessages.getmsg(194)
                        .Values = gesterndatenreihe
                        '.XValues = Xgestern
                        .XValues = Xdatenreihe
                        .Interior.Color = awinSettings.SollIstFarbeArea
                        .ChartType = Excel.XlChartType.xlArea

                    End With

                End If


            End With


        End With

        With newChtObj
            .Top = top
            .Left = left
            .Height = height
            .Width = width
        End With

        appInstance.EnableEvents = formerEE
        reportObj = newChtObj

    End Sub

    ''' <summary>
    ''' aktualisiert im SmartInfo Powerpoint das übergebene ChartObject  
    ''' </summary>
    ''' <param name="chtObj"></param>
    ''' <param name="hproj"></param>
    ''' <param name="vProj"></param>
    ''' <param name="auswahl"></param>
    ''' <param name="qualifier"></param>
    ''' <remarks></remarks>
    Public Sub updatePPTSollIstCurveOfProject(ByRef chtObj As Excel.ChartObject, ByVal hproj As clsProjekt, vProj As clsProjekt, _
                                                   ByVal auswahl As Integer, ByVal qualifier As String, ByVal vglBaseline As Boolean)
        Dim xlsChart As Excel.Chart = chtObj.Chart
        Dim i As Integer, ix As Integer = 0
        Dim abbruch As Boolean = False
        Dim pname As String = hproj.name
        Dim fullname As String = hproj.getShapeText
        Dim kennung As String = " "
        Dim diagramTitle As String = " "
        Dim zE As String = "(" & awinSettings.kapaEinheit & ")"
        Dim titelTeile(2) As String
        Dim titelTeilLaengen(2) As Integer
        Dim sumB As Double, sumC As Double
        ' zaehleinheit ist T€ oder PT ...
        Dim zaehlEinheit As String = ""


        Dim maxlenTitle1 As Integer = 20

        Dim heute As Date = Date.Now
        ' aktuell wird es nur von Report Generation aufgerufen ...
        Dim calledFromReporting As Boolean = True
        Dim chartType As Excel.XlChartType
        Dim curmaxScale As Double
        Dim minColumn As Integer, maxColumn As Integer
        Dim gesternColumn As Integer = -1


        ' jetzt muss bestimmt werden, ob und bis wann es Actual Data gibt ...
        If hproj.actualDataUntil > Date.MinValue Then
            If DateDiff(DateInterval.Month, hproj.startDate, hproj.actualDataUntil) > 0 Then
                gesternColumn = getColumnOfDate(hproj.actualDataUntil)
            End If
        End If

        ' tk 31.1.18
        ' nur wenn Projekt bereits beauftragt ist und mind ein Element in der Datenbank ist 
        ' vglBaseline = hproj.Status <> ProjektStatus(0) And projekthistorie.Count > 1
        If Not IsNothing(vProj) Then
            vglBaseline = True
        Else
            vglBaseline = False
        End If

        ' die ganzen Vor-Klärungen machen ...
        With xlsChart
            chartType = .ChartType

            'Dim refName As String = CStr(myChartData.Workbook.name)
            'Dim refWorkbook As xlNS.Workbook = CType(myChartData.Workbook, xlNS.Workbook)
            '.SetSourceData("C:\temp\Mappe1.xlsx")
            'refName = CStr(myChartData.Workbook.name)


            If CBool(.HasAxis(Excel.XlAxisType.xlValue)) Then

                With CType(.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                    ' das ist dann relevant, wenn ein anderes Projekt selektiert wird, das über die aktuelle Skalierung 
                    ' hinausgehende Werte hat 
                    curmaxScale = .MaximumScale
                    .MaximumScaleIsAuto = False
                End With

            End If

        End With



        Dim pastAndFuture As Boolean = False

        Dim werteB(vProj.anzahlRasterElemente - 1) As Double
        Dim werteC(hproj.anzahlRasterElemente - 1) As Double

        Dim Xdatenreihe() As String
        ' die folgenden müssen die gleiche Dimension haben ihre Pendants oben ...
        Dim tdatenreiheB(vProj.anzahlRasterElemente - 1) As Double
        Dim tdatenreiheC(hproj.anzahlRasterElemente - 1) As Double

        Dim gesterndatenreihe() As Double
        Dim Xgestern() As String


        ' wird benötigt, weil xml-texte aktuell noch nicht in DB sind - und sonst kann das nicht aktualisiert werden 
        Dim repMSg(6) As String
        If awinSettings.englishLanguage Then
            repMSg(0) = "cumulated Personnel Cost"
            repMSg(1) = "cumulated Other Cost"
            repMSg(2) = "cumulated Total Cost"
            repMSg(3) = "approved version"
            'repMSg(3) = "version from"
            repMSg(4) = "last version"
            repMSg(5) = "actual values"
            repMSg(6) = "Forecast"
        Else
            repMSg(0) = "kumulierte Personalkosten"
            repMSg(1) = "kumulierte Sonstige Kosten"
            repMSg(2) = "kumulierte Gesamtkosten"
            repMSg(3) = "Beauftragung"
            'repMSg(3) = "Stand vom"
            repMSg(4) = "letzter Stand"
            repMSg(5) = "Ist-Werte"
            repMSg(6) = "Prognose"
        End If


        Select Case auswahl
            Case 1
                ' Personalkosten
                titelTeile(0) = repMSg(0) & " " & qualifier
                zaehlEinheit = "T€"
                If vglBaseline Then
                    If qualifier = "" Then
                        werteB = vProj.getAllPersonalKosten
                        werteC = hproj.getAllPersonalKosten
                    Else
                        werteB = vProj.getRessourcenBedarf(qualifier, inclSubRoles:=True, outPutInEuro:=True)
                        werteC = hproj.getRessourcenBedarf(qualifier, inclSubRoles:=True, outPutInEuro:=True)
                    End If

                End If



            Case 2
                ' Sonstige Kosten

                'titelTeile(0) = "Soll/Ist Sonstige Kosten" 
                titelTeile(0) = repMSg(1)
                If vglBaseline Then
                    werteB = vProj.getGesamtAndereKosten
                End If

                werteC = hproj.getGesamtAndereKosten

            Case 3
                ' Gesamt Kosten
                titelTeile(0) = repMSg(2)

                zaehlEinheit = "T€"
                If vglBaseline Then
                    werteB = vProj.getGesamtKostenBedarf
                End If

                werteC = hproj.getGesamtKostenBedarf

            Case 4
                ' Rollen mit Qualifier
                titelTeile(0) = qualifier
                zaehlEinheit = awinSettings.kapaEinheit

                Try
                    If vglBaseline Then
                        werteB = vProj.getRessourcenBedarf(qualifier, True)
                    End If

                    werteC = hproj.getRessourcenBedarf(qualifier, True)
                Catch ex As Exception
                    'Throw New ArgumentException(ex.Message & vbLf & qualifier & " nicht gefunden")
                    Throw New ArgumentException(ex.Message & vbLf & qualifier & repMessages.getmsg(193))
                End Try

            Case 5
                ' Kostenart mit Qualifier
                titelTeile(0) = qualifier
                zaehlEinheit = "T€"

                Try
                    If vglBaseline Then
                        werteB = vProj.getKostenBedarfNew(qualifier)
                    End If

                    werteC = hproj.getKostenBedarfNew(qualifier)
                Catch ex As Exception
                    'Throw New ArgumentException(ex.Message & vbLf & qualifier & " nicht gefunden")
                    Throw New ArgumentException(ex.Message & vbLf & qualifier & repMessages.getmsg(193))
                End Try

            Case Else
                ' Gesamt Kosten

                'titelTeile(0) = "Soll/Ist Gesamtkosten"
                titelTeile(0) = repMSg(2)

                zaehlEinheit = "T€"
                If vglBaseline Then
                    werteB = vProj.getGesamtKostenBedarf
                End If

                werteC = hproj.getGesamtKostenBedarf
                auswahl = 3

        End Select

        ' tk, 25.1.18 
        Dim tmpSum As String

        If vglBaseline Then
            tmpSum = " (" & werteC.Sum.ToString("##,##0.") & " / " & werteB.Sum.ToString("##,##0.") & " " & zaehlEinheit & ")"
        Else
            tmpSum = " (" & werteC.Sum.ToString("##,##0.") & zaehlEinheit & ")"
        End If




        titelTeile(0) = titelTeile(0) & tmpSum
        titelTeilLaengen(0) = titelTeile(0).Length

        diagramTitle = titelTeile(0)


        minColumn = 10000
        If vProj.Start < minColumn Then
            minColumn = vProj.Start
        End If

        If hproj.Start < minColumn Then
            minColumn = hproj.Start
        End If


        With hproj
            maxColumn = .Start + .anzahlRasterElemente - 1
            ReDim tdatenreiheC(maxColumn - minColumn)
        End With

        With vProj
            If maxColumn < .Start + .anzahlRasterElemente - 1 Then
                maxColumn = .Start + .anzahlRasterElemente - 1
            End If
            ReDim tdatenreiheB(.Start + .anzahlRasterElemente - 1 - minColumn)
        End With

        ReDim Xdatenreihe(maxColumn - minColumn)

        sumB = 0.0
        sumC = 0.0

        For i = minColumn To maxColumn
            Xdatenreihe(i - minColumn) = StartofCalendar.AddMonths(i - 1).ToString("MMM yy", repCult)
            With vProj
                If i >= .Start And i <= .Start + .anzahlRasterElemente - 1 Then
                    tdatenreiheB(i - minColumn) = sumB + werteB(i - .Start)
                    sumB = tdatenreiheB(i - minColumn)
                Else
                    ' tk 25.1.18 nichts machen
                    'tdatenreiheB(i - minColumn) = sumB
                End If
            End With


            With hproj
                If i >= .Start And i <= .Start + .anzahlRasterElemente - 1 Then
                    tdatenreiheC(i - minColumn) = sumC + werteC(i - .Start)
                    sumC = tdatenreiheC(i - minColumn)
                Else
                    ' tk 25.1.18 nichts machen
                    ' tdatenreiheC(i - minColumn) = sumC
                End If
            End With

        Next i


        If gesternColumn >= minColumn And _
            gesternColumn <= maxColumn Then

            pastAndFuture = True
            ReDim gesterndatenreihe(gesternColumn - minColumn)
            ReDim Xgestern(gesternColumn - minColumn)
            For i = minColumn To gesternColumn
                gesterndatenreihe(i - minColumn) = tdatenreiheC(i - minColumn)
                ' tk 23.8.18
                If i < gesternColumn Then
                    tdatenreiheC(i - minColumn) = 0
                End If
                Xgestern(i - minColumn) = Xdatenreihe(i - minColumn)
            Next
        Else
            ReDim gesterndatenreihe(0)
            ReDim Xgestern(0)
            pastAndFuture = False

        End If

        ' jetzt wird das Diagramm gezeichnet 

        With CType(chtObj.Chart, Excel.Chart)
            ' remove old series
            Try
                Dim anz As Integer = CInt(.SeriesCollection.count)
                Do While anz > 0
                    .SeriesCollection(1).Delete()
                    anz = anz - 1
                Loop
            Catch ex As Exception

            End Try

            If .HasTitle Then
                .ChartTitle.Text = diagramTitle
            End If

        End With

        With chtObj.Chart

            ' heutiger stand 
            With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                '.Name = repMessages.getmsg(273) & " " & hproj.timeStamp.ToString("d")
                '.Name = repMSg(6) & " " & hproj.timeStamp.ToString("d")
                .Name = repMSg(6)
                .Interior.Color = visboFarbeBlau
                .Values = tdatenreiheC
                .XValues = Xdatenreihe

                If pastAndFuture Then
                    .Interior.Color = visboFarbeBlau
                    .ChartType = Excel.XlChartType.xlArea
                Else
                    .ChartType = Excel.XlChartType.xlLine
                    .Format.Line.Weight = 4
                    .Format.Line.ForeColor.RGB = visboFarbeBlau
                End If


            End With

            If vglBaseline Then
                With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                    '
                    .Name = repMSg(3) & " " & vProj.timeStamp.ToString("d")
                    .Interior.Color = visboFarbeOrange
                    .Values = tdatenreiheB
                    .XValues = Xdatenreihe
                    .ChartType = Excel.XlChartType.xlLine

                    With .Format.Line
                        .Weight = 4
                        .DashStyle = core.MsoLineDashStyle.msoLineDash
                        .ForeColor.RGB = visboFarbeOrange
                    End With


                End With

            End If

            If pastAndFuture Then
                ' dann muss jetzt die "Ist-Markierung gezeichnet werden 

                With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)

                    .Name = repMSg(5)
                    .Interior.Color = awinSettings.SollIstFarbeArea
                    .Values = gesterndatenreihe

                    .XValues = Xdatenreihe
                    .ChartType = Excel.XlChartType.xlArea

                End With

            End If




        End With




    End Sub

    ''' <summary>
    ''' Methode zeigt zum ausgewählten Projekt die Trendanalyse zu den in der myCollection übergebenen Meilensteinen an 
    ''' </summary>
    ''' <param name="hproj">Verweis auf Projekt</param>
    ''' <param name="repObj">Verweis auf generiertes ChartObject (für Reporting benötigt)</param>
    ''' <param name="myCollection">enthält die NAmen der Meilensteine, für die die Trendanalyse erstellt werden soll</param>
    ''' <param name="top">y-Koordinate linke obere Ecke </param>
    ''' <param name="left">x-Koordinate linke obere Ecke</param>
    ''' <param name="height">Höhe des Charts</param>
    ''' <param name="width">Breite des Charts</param>
    ''' <remarks></remarks>
    Public Sub createMsTrendAnalysisOfProject(ByRef hproj As clsProjekt, ByRef repObj As Excel.ChartObject, ByRef myCollection As Collection, _
                                                 ByVal top As Double, left As Double, height As Double, width As Double)

        Dim kennung As String = " "
        Dim diagramTitle As String = " "
        Dim anzDiagrams As Integer
        Dim found As Boolean
        Dim plen As Integer
        Dim i As Integer
        Dim Xdatenreihe() As String
        Dim tdatenreihe() As Double
        Dim milestoneReached() As Boolean
        Dim prevValueTaken() As Boolean
        Dim ampelfarben() As Long
        Dim tmpdatenreihe() As Date
        Dim chtTitle As String
        Dim pkIndex As Integer = CostDefinitions.Count
        Dim chtobj As Excel.ChartObject
        Dim ErgebnisListeR As New Collection
        Dim msName As String
        Dim zE As String = "(" & awinSettings.kapaEinheit & ")"
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim anzMilestones As Integer
        Dim aufzeichnungsStart As Date
        Dim earliestStart As Date
        Dim von As Integer, bis As Integer


        Dim formerEE As Boolean = appInstance.EnableEvents
        Dim formerSU As Boolean = appInstance.ScreenUpdating
        appInstance.EnableEvents = False



        Dim pname As String = hproj.name

        'titelTeile(0) = "Meilenstein Trend-Analyse " & hproj.getShapeText & vbLf
        titelTeile(0) = repMessages.getmsg(21) & hproj.getShapeText & vbLf
        titelTeilLaengen(0) = titelTeile(0).Length
        titelTeile(1) = " (" & hproj.timeStamp.ToString & ") "
        titelTeilLaengen(1) = titelTeile(1).Length
        diagramTitle = titelTeile(0) & titelTeile(1)
        kennung = "MTA"


        ' neu - neu - neu - neu 

        ' wann wurde mit der Aufzeichnung der Projekt-Historie begonnen ? 
        aufzeichnungsStart = projekthistorie.ElementAt(0).timeStamp

        '
        ' bestimme den seit Beauftragung frühesten Start-Monat 
        '


        If IsNothing(projekthistorie.beauftragung) Then
            earliestStart = projekthistorie.First.timeStamp
        Else
            earliestStart = projekthistorie.beauftragung.startDate
        End If



        ' es beginnt entweder mit dem Monat, wo die Aufzeichnung begann oder mit dem Projekt-Start : nimm das größere von beidem 
        von = System.Math.Max(getColumnOfDate(aufzeichnungsStart), getColumnOfDate(earliestStart))

        ' es endet entweder mit heute oder dem Ende des Projektes : nimm das kleinere von beidem 
        With hproj
            bis = System.Math.Min(getColumnOfDate(Date.Now), getColumnOfDate(.endeDate))
        End With


        ' bestimme die Dimension
        plen = bis - von + 1

        ' wenn nicht mindestens zwei Elemente darstellbar sind, ist kein Trend darzustellen 
        If plen < 2 Then
            appInstance.EnableEvents = formerEE
            'Throw New Exception("Es gibt noch keinen Trend für das Projekt '" & hproj.name & "'")
            Throw New Exception(repMessages.getmsg(39) & hproj.name & "'")
        End If

        ' neu - neu - neu - neu 


        anzMilestones = myCollection.Count

        If anzMilestones = 0 Then
            appInstance.EnableEvents = formerEE
            'Throw New Exception("keine Meilensteine angegeben!")
            Throw New Exception(repMessages.getmsg(40))
        End If


        ReDim Xdatenreihe(plen - 1)
        ReDim tdatenreihe(plen - 1)
        ReDim ampelfarben(plen - 1)
        ReDim milestoneReached(plen - 1)
        ReDim prevValueTaken(plen - 1)


        For i = 1 To plen
            Xdatenreihe(i - 1) = StartofCalendar.AddMonths(von + i - 2).ToString("MMM yy", repCult)
        Next i


        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            found = False
            While i <= anzDiagrams And Not found
                Try
                    chtTitle = CType(.ChartObjects(i), Excel.ChartObject).Chart.ChartTitle.Text
                Catch ex As Exception
                    chtTitle = " "
                End Try

                If chtTitle = diagramTitle Then
                    found = True

                Else
                    i = i + 1
                End If

            End While

            If found Then

                appInstance.EnableEvents = formerEE

                repObj = CType(.ChartObjects(i), Excel.ChartObject)
                Exit Sub
            Else
                appInstance.ScreenUpdating = False

                With appInstance.Charts.Add
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try

                    .HasTitle = True
                    .ChartTitle.Text = diagramTitle
                    .ChartTitle.Font.Size = awinSettings.fontsizeTitle

                    Dim achieved As Boolean = False
                    Dim anzahlVersuche As Integer = 0
                    Dim errmsg As String = ""
                    Do While Not achieved And anzahlVersuche < 10
                        Try
                            'Call Sleep(100)
                            .Location(Where:=xlNS.XlChartLocation.xlLocationAsObject, Name:=CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Name)
                            achieved = True
                        Catch ex As Exception
                            errmsg = ex.Message
                            'Call Sleep(100)
                            anzahlVersuche = anzahlVersuche + 1
                        End Try
                    Loop

                    If Not achieved Then
                        Throw New ArgumentException("Chart-Fehler:" & errmsg)
                    End If


                End With

                chtobj = CType(.ChartObjects(anzDiagrams + 1), Excel.ChartObject)
                chtobj.Name = pname & "#" & kennung & "#" & "1"


            End If

            ' jetzt kommt die Korrektur der Größe; herausfinden, wieviel Raum die Axis Beschriftung einnimmt ... 
            With chtobj
                .Top = top
                .Height = height
                .Left = left
                .Width = width
            End With

            With chtobj.Chart
                ' jetzt wird die Plot-Area so verkleinert, daß links und rechts ausreichend Platz 
                ' für die Bennenung der Meilensteine ist 
                .PlotArea.Left = 0.2 * width
                .PlotArea.Width = 0.8 * width
                '.PlotArea.Height = 0.9 * height
                '.PlotArea.Top = 0.08 * height
            End With

            Dim ms As Integer
            With CType(chtobj.Chart, Excel.Chart)

                .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                    titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend

                ' remove old series
                Try
                    Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                    Do While anz > 0
                        .SeriesCollection(1).Delete()
                        anz = anz - 1
                    Loop
                Catch ex As Exception

                End Try

                Dim colorIndex As Integer
                Dim drawnDates As New SortedList(Of Date, Date)
                Dim drawnMilestones As Integer = 0
                Dim tmpMinScale As Date, tmpMaxScale As Date


                For ms = 1 To anzMilestones
                    msName = CStr(myCollection.Item(ms))

                    Try
                        tmpdatenreihe = projekthistorie.getMtaDates(msName, von, bis)
                        drawnMilestones = drawnMilestones + 1

                        ' tmpMinScale und tmpMaxScale werden zur Bestimmung des optimalen Skalierungsfaktors für das Diagramm benötigt 
                        If ms = 1 Then
                            tmpMinScale = tmpdatenreihe.Min
                            tmpMaxScale = tmpdatenreihe.Max
                        Else
                            If tmpMinScale > tmpdatenreihe.Min Then
                                tmpMinScale = tmpdatenreihe.Min
                            End If

                            If tmpMaxScale < tmpdatenreihe.Max Then
                                tmpMaxScale = tmpdatenreihe.Max
                            End If
                        End If

                        ReDim tdatenreihe(tmpdatenreihe.Length - 1)
                        For qx = 0 To tmpdatenreihe.Length - 1
                            ' nur der Datums-Wert ohne Zeit-Anteil - die Farbe ist als Anzahl Sekunden nach Tagesstart in das Datum kodiert ...
                            tdatenreihe(qx) = tmpdatenreihe(qx).Date.ToOADate

                            ' prüfen, ob der Wert vonm Vormonat übernommen wurde 
                            If DateDiff(DateInterval.Hour, tmpdatenreihe(qx).Date, tmpdatenreihe(qx)) > 11 Then
                                prevValueTaken(qx) = True
                                tmpdatenreihe(qx) = tmpdatenreihe(qx).AddHours(-12) ' Kodierung für "Wert des Vormonats" rausnehmen, sonst ist nachher Farbe auf alle Fälle rot
                            Else
                                prevValueTaken(qx) = False
                            End If

                            If DateDiff(DateInterval.Hour, tmpdatenreihe(qx).Date, tmpdatenreihe(qx)) = 6 Then
                                milestoneReached(qx) = True
                                tmpdatenreihe(qx) = tmpdatenreihe(qx).AddHours(-6) ' Kodierung für "milestone abgeschlossen" rausnehmen, sonst ist nachher Farbe auf alle Fälle rot
                            Else
                                milestoneReached(qx) = False
                            End If

                            colorIndex = CInt(DateDiff(DateInterval.Second, tmpdatenreihe(qx).Date, tmpdatenreihe(qx)))
                            If colorIndex = 0 Then
                                ampelfarben(qx) = awinSettings.AmpelNichtBewertet
                            ElseIf colorIndex = 1 Then
                                ampelfarben(qx) = awinSettings.AmpelGruen
                            ElseIf colorIndex = 2 Then
                                ampelfarben(qx) = awinSettings.AmpelGelb
                            Else
                                ampelfarben(qx) = awinSettings.AmpelRot
                            End If
                        Next

                        'series
                        With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                            .Name = drawnMilestones.ToString & " - " & elemNameOfElemID(msName)
                            .ChartType = Excel.XlChartType.xlLineMarkers
                            .Interior.Color = awinSettings.AmpelNichtBewertet
                            .Values = tdatenreihe
                            .XValues = Xdatenreihe
                            .HasDataLabels = False
                            .MarkerStyle = Excel.XlMarkerStyle.xlMarkerStyleCircle
                            .MarkerForegroundColor = CInt(awinSettings.AmpelNichtBewertet)
                            .MarkerBackgroundColor = CInt(awinSettings.AmpelNichtBewertet)

                            With .Format.Line
                                .Visible = core.MsoTriState.msoTrue
                                .ForeColor.RGB = CInt(awinSettings.AmpelNichtBewertet)
                                .DashStyle = core.MsoLineDashStyle.msoLineDashDot
                            End With
                        End With


                        For px = 1 To tdatenreihe.Length

                            With CType(CType(.SeriesCollection, Excel.SeriesCollection).Item(drawnMilestones), Excel.Series).Points(px)

                                .Interior.Color = ampelfarben(px - 1)
                                .MarkerStyle = Excel.XlMarkerStyle.xlMarkerStyleCircle
                                .MarkerForegroundColor = CInt(ampelfarben(px - 1))
                                .MarkerBackgroundColor = CInt(ampelfarben(px - 1))
                                .MarkerSize = 10

                                ' Schreiben des ersten Planungs-Standes
                                If px = 1 Then

                                    ' wenn es der Wert aus dem Vormonat ist: einen kleineren Marker zeichnen 
                                    If prevValueTaken(px - 1) Then
                                        .Interior.Color = CInt(awinSettings.AmpelNichtBewertet)
                                        .MarkerForegroundColor = CInt(awinSettings.AmpelNichtBewertet)
                                        .MarkerBackgroundColor = CInt(awinSettings.AmpelNichtBewertet)
                                        .MarkerSize = 2
                                    End If

                                    ' wenn der Meilenstein zum zeitpunkt des Planungs-Standes bereits in der Vergangenheit lag, wird er auch so markiert
                                    If milestoneReached(px - 1) Then
                                        .MarkerStyle = Excel.XlMarkerStyle.xlMarkerStyleSquare
                                    End If

                                    .HasDataLabel = True
                                    If anzMilestones > 1 Then
                                        .DataLabel.Text = drawnMilestones.ToString & " - " & tmpdatenreihe(px - 1).ToShortDateString
                                    Else
                                        .DataLabel.Text = elemNameOfElemID(msName) & vbLf & tmpdatenreihe(px - 1).ToShortDateString
                                    End If

                                    .DataLabel.Font.Size = awinSettings.fontsizeItems
                                    Try
                                        .DataLabel.Position = Excel.XlDataLabelPosition.xlLabelPositionLeft
                                    Catch ex As Exception

                                    End Try

                                    Try
                                        drawnDates.Add(tmpdatenreihe(px - 1).Date, tmpdatenreihe(px - 1))
                                    Catch ex As Exception

                                    End Try
                                End If


                                ' wenn mittendrin Daten auftauchen, die noch nicht geschrieben wurden ... 
                                If px > 1 And px < tdatenreihe.Length Then

                                    ' wenn es der Wert aus dem Vormonat ist: einen kleineren Marker zeichnen 
                                    If prevValueTaken(px - 1) Then
                                        .Interior.Color = CInt(awinSettings.AmpelNichtBewertet)
                                        .MarkerForegroundColor = CInt(awinSettings.AmpelNichtBewertet)
                                        .MarkerBackgroundColor = CInt(awinSettings.AmpelNichtBewertet)
                                        .MarkerSize = 2
                                    End If

                                    ' wenn der Meilenstein zum zeitpunkt des Planungs-Standes bereits in der Vergangenheit lag, wird er entsprechend markiert
                                    If milestoneReached(px - 1) Then
                                        .MarkerStyle = Excel.XlMarkerStyle.xlMarkerStyleSquare
                                    End If

                                    If Not drawnDates.ContainsKey(tmpdatenreihe(px - 1).Date) And _
                                        tmpdatenreihe(px - 1).Date <> tmpdatenreihe(tdatenreihe.Length - 1).Date Then

                                        .HasDataLabel = True
                                        .DataLabel.Text = tmpdatenreihe(px - 1).ToShortDateString
                                        '.DataLabel.Text = msName & ": " & tmpdatenreihe(px - 1).ToShortDateString
                                        .DataLabel.Font.Size = awinSettings.fontsizeItems
                                        Try

                                            If tmpdatenreihe(px - 1).Date > tmpdatenreihe(px - 2).Date Then
                                                .DataLabel.Position = Excel.XlDataLabelPosition.xlLabelPositionBelow
                                            Else
                                                .DataLabel.Position = Excel.XlDataLabelPosition.xlLabelPositionAbove
                                            End If

                                        Catch ex As Exception
                                            .DataLabel.Position = Excel.XlDataLabelPosition.xlLabelPositionCenter
                                        End Try

                                        Try
                                            drawnDates.Add(tmpdatenreihe(px - 1).Date, tmpdatenreihe(px - 1))
                                        Catch ex As Exception

                                        End Try

                                    End If
                                End If

                                ' Schreiben des letzten Planungs-Standes
                                If px > 1 And px = tdatenreihe.Length Then

                                    ' wenn es der Wert aus dem Vormonat ist: einen kleineren/ nicht sichtbaren Marker zeichnen 
                                    If prevValueTaken(px - 1) Then
                                        .Interior.Color = CInt(awinSettings.AmpelNichtBewertet)
                                        .MarkerForegroundColor = CInt(awinSettings.AmpelNichtBewertet)
                                        .MarkerBackgroundColor = CInt(awinSettings.AmpelNichtBewertet)
                                        .MarkerSize = 2
                                    End If

                                    ' wenn der Meilenstein zum zeitpunkt des Planungs-Standes bereits in der Vergangenheit lag, wird er auch so markiert
                                    If milestoneReached(px - 1) Then
                                        .MarkerStyle = Excel.XlMarkerStyle.xlMarkerStyleSquare
                                    End If

                                    .HasDataLabel = True
                                    If anzMilestones > 1 Then
                                        .DataLabel.Text = drawnMilestones.ToString & " - " & tmpdatenreihe(px - 1).ToShortDateString
                                    Else
                                        .DataLabel.Text = elemNameOfElemID(msName) & vbLf & tmpdatenreihe(px - 1).ToShortDateString
                                    End If
                                    .DataLabel.Font.Size = awinSettings.fontsizeItems
                                    Try
                                        .DataLabel.Position = Excel.XlDataLabelPosition.xlLabelPositionRight
                                    Catch ex As Exception

                                    End Try

                                    Try
                                        drawnDates.Add(tmpdatenreihe(px - 1).Date, tmpdatenreihe(px - 1))
                                    Catch ex As Exception

                                    End Try


                                End If

                            End With
                        Next

                        drawnDates.Clear()


                    Catch ex As Exception

                    End Try




                Next ms

                ' Bestimmen des optimlaen skalierungsfaktors 
                Dim spread As Integer
                spread = CInt(DateDiff(DateInterval.Day, tmpMinScale, tmpMaxScale) / 10)
                If spread < 1 Then
                    spread = 1
                End If

                tmpMinScale = tmpMinScale.AddDays(-1 * spread)
                tmpMaxScale = tmpMaxScale.AddDays(spread)

                .HasAxis(Excel.XlAxisType.xlCategory) = True
                .HasAxis(Excel.XlAxisType.xlValue) = False


                With CType(.Axes(Excel.XlAxisType.xlCategory), Excel.Axis)
                    .HasTitle = True
                    '.AxisTitle.Text = "Berichtszeiträume"
                    .AxisTitle.Text = repMessages.getmsg(41)
                    .AxisTitle.Format.TextFrame2.TextRange.Font.Size = 14
                    .BaseUnit = Excel.XlTimeUnit.xlMonths
                    .CategoryType = Excel.XlCategoryType.xlTimeScale
                End With

                With CType(.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                    .HasMajorGridlines = False

                    Try
                        .HasTitle = False
                        '.AxisTitle.Text = "Meilenstein Termine"
                        '.AxisTitle.Format.TextFrame2.TextRange.Font.Size = 14
                    Catch ex As Exception

                    End Try

                    .MaximumScale = tmpMaxScale.ToOADate
                    .MinimumScale = tmpMinScale.ToOADate
                    .MajorUnit = 61

                    'Try
                    '    .TickLabels.NumberFormat = "dd-mm-yyyy"
                    'Catch ex As Exception

                    'End Try


                End With

                If anzMilestones > 1 Then
                    .HasLegend = True
                    With .Legend
                        .Position = Excel.XlLegendPosition.xlLegendPositionTop
                        .Font.Size = awinSettings.fontsizeLegend
                    End With
                Else
                    .HasLegend = False
                End If



            End With



        End With



        'Call awinScrollintoView()
        appInstance.EnableEvents = formerEE
        appInstance.ScreenUpdating = formerSU

        repObj = chtobj



    End Sub


    ''' <summary>
    ''' 
    ''' </summary>
    ''' <param name="scInfo"></param>
    ''' <param name="repObj"></param>
    ''' <param name="top"></param>
    ''' <param name="left"></param>
    ''' <param name="height"></param>
    ''' <param name="width"></param>
    ''' <param name="calledFromReporting"></param>
    ''' <param name="calledFromMassEdit"></param>
    Public Sub createRessBalkenOfProject(ByVal scInfo As clsSmartPPTChartInfo, ByVal auswahl As Integer,
                                         ByRef repObj As Excel.ChartObject,
                                            ByVal top As Double, left As Double, height As Double, width As Double,
                                            ByVal calledFromReporting As Boolean,
                                            Optional ByVal calledFromMassEdit As Boolean = False)


        Dim kennung As String = " "

        Dim anzDiagrams As Integer


        Dim i As Integer

        'Dim chtTitle As String
        Dim pkIndex As Integer = CostDefinitions.Count

        Dim tmpcollection As New Collection
        Dim currentSheetName As String
        Dim newChtObj As Excel.ChartObject = Nothing
        Dim maxlenTitle1 As Integer = 20

        Dim diagramTitle As String = " "
        Dim IstCharttype As Excel.XlChartType
        Dim PlanChartType As Excel.XlChartType
        Dim vglChartType As Excel.XlChartType

        Dim hproj As clsProjekt = scInfo.hproj
        Dim vglProj As clsProjekt = scInfo.vglProj

        ' Ende , wenn es kein hproj gibt 
        If IsNothing(hproj) Or IsNothing(scInfo) Then
            repObj = Nothing
            Exit Sub
        End If

        Dim roleName As String = scInfo.q2

        Dim considerIstDaten As Boolean = scInfo.hproj.actualDataUntil > scInfo.hproj.startDate

        If scInfo.chartTyp = PTChartTypen.CurveCumul Then
            IstCharttype = Excel.XlChartType.xlArea

            If considerIstDaten Then
                PlanChartType = Excel.XlChartType.xlArea
            Else
                PlanChartType = Excel.XlChartType.xlLine
            End If

            vglChartType = Excel.XlChartType.xlLine
        Else
            IstCharttype = Excel.XlChartType.xlColumnStacked
            PlanChartType = Excel.XlChartType.xlColumnStacked
            vglChartType = Excel.XlChartType.xlLine
        End If

        Dim plen As Integer
        Dim pstart As Integer

        Dim Xdatenreihe() As String = Nothing
        Dim tdatenreihe() As Double = Nothing
        Dim istDatenReihe() As Double = Nothing
        Dim prognoseDatenReihe() As Double = Nothing
        Dim vdatenreihe() As Double = Nothing
        Dim internKapaDatenreihe() As Double = Nothing
        Dim vDatensumme As Double = 0.0
        Dim tDatenSumme As Double = 0.0


        Dim found As Boolean = False


        If visboZustaende.projectBoardMode = ptModus.graficboard Then
            If calledFromReporting Then
                currentSheetName = arrWsNames(ptTables.repCharts)
            Else
                currentSheetName = arrWsNames(ptTables.mptPrCharts)
            End If

        Else
            currentSheetName = arrWsNames(ptTables.meCharts)
        End If


        Dim formerEE As Boolean = appInstance.EnableEvents
        'Dim formerSU As Boolean = appInstance.ScreenUpdating
        appInstance.EnableEvents = False
        'appInstance.ScreenUpdating = False


        Dim pname As String = hproj.name

        If roleName = "" Then
            tmpcollection.Add(hproj.name & "#" & auswahl.ToString)
        Else
            tmpcollection.Add(hproj.name & "#" & auswahl.ToString & "#" & roleName)
        End If


        kennung = calcChartKennung("pr", scInfo.detailID, tmpcollection)


        '
        ' hole die Projektdauer; berücksichtigen: die können unterschiedlich starten und unterschiedlich lang sein
        ' deshalb muss die Zeitspanne bestimmt werden, die beides umfasst  
        '
        Call bestimmePstartPlen(scInfo, pstart, plen)

        ' hier werden die Istdaten, die Prognosedaten, die Vergleichsdaten sowie die XDaten bestimmt
        Dim errMsg As String = ""
        Call bestimmeXtipvDatenreihen(pstart, plen, scInfo,
                                       Xdatenreihe, tdatenreihe, vdatenreihe, istDatenReihe, prognoseDatenReihe, internKapaDatenreihe, errMsg)

        If errMsg <> "" Then
            ' es ist ein Fehler aufgetreten
            Call MsgBox("Fehler beim Berechnen der chart-Reihen: " & vbLf & errMsg)
            Exit Sub
        End If


        Dim vProjDoesExist As Boolean = Not IsNothing(scInfo.vglProj)

        If scInfo.chartTyp = PTChartTypen.CurveCumul Then
            tDatenSumme = tdatenreihe(tdatenreihe.Length - 1)
            vDatensumme = vdatenreihe(vdatenreihe.Length - 1)
        Else
            tDatenSumme = tdatenreihe.Sum
            vDatensumme = vdatenreihe.Sum

        End If

        Dim startRed As Integer = 0
        Dim lengthRed As Integer = 0
        diagramTitle = bestimmeChartDiagramTitle(scInfo, tDatenSumme, vDatensumme, startRed, lengthRed, calledFromMassEdit:=calledFromMassEdit)



        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(currentSheetName), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            While i <= anzDiagrams And Not found

                If .ChartObjects(i).name = kennung Then
                    found = True
                    repObj = CType(.ChartObjects(i), Excel.ChartObject)
                Else
                    i = i + 1
                End If

            End While

            If found Then

                appInstance.EnableEvents = formerEE
                'appInstance.ScreenUpdating = formerSU
                repObj = CType(.ChartObjects(i), Excel.ChartObject)
                Exit Sub
            Else
                ' die Einstellungen, um später dann den Titel und die Datenreihen zu berechnen 


                newChtObj = CType(.ChartObjects, Excel.ChartObjects).Add(left, top, width, height)

                With CType(newChtObj.Chart, Excel.Chart)
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try

                    .HasAxis(Excel.XlAxisType.xlCategory) = True
                    .HasAxis(Excel.XlAxisType.xlValue) = True

                    With CType(.Axes(Excel.XlAxisType.xlCategory), Excel.Axis)
                        .HasTitle = False
                    End With

                    With .Axes(Excel.XlAxisType.xlValue)
                        .HasTitle = False
                        .MinimumScale = 0
                    End With

                    .HasLegend = True
                    With .Legend
                        .Position = Excel.XlLegendPosition.xlLegendPositionTop
                        .Font.Size = awinSettings.fontsizeLegend
                    End With
                    .HasTitle = True
                    .ChartTitle.Text = " "  ' Platzhalter 

                End With

                newChtObj.Name = kennung



            End If

            With newChtObj.Chart

                ' Planung / Forecast
                ' nur zeigen, wenn hproj.actualdata
                Dim dontShowPlanung As Boolean = False
                If hproj.hasActualValues Then
                    If getColumnOfDate(hproj.actualDataUntil) >= getColumnOfDate(hproj.endeDate) Then
                        ' es kann keine Planwerte mehr geben , also nix zeichnen
                        dontShowPlanung = True
                    End If
                End If

                If Not dontShowPlanung Then
                    With CType(CType(.SeriesCollection, xlNS.SeriesCollection).NewSeries, xlNS.Series)

                        .Name = bestimmeLegendNameIPB("P") & scInfo.hproj.timeStamp.ToShortDateString
                        .Interior.Color = visboFarbeBlau
                        .Values = prognoseDatenReihe
                        .XValues = Xdatenreihe
                        .ChartType = PlanChartType

                        If scInfo.chartTyp = PTChartTypen.CurveCumul And Not considerIstDaten Then
                            ' es handelt sich um eine Line
                            .Format.Line.Weight = 4
                            .Format.Line.ForeColor.RGB = visboFarbeBlau
                            .Format.Line.DashStyle = Microsoft.Office.Core.MsoLineDashStyle.msoLineSolid
                        End If

                    End With
                End If


                ' Beauftragung bzw. Vergleichsdaten
                If Not IsNothing(scInfo.vglProj) Then

                    'series
                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                        .Name = bestimmeLegendNameIPB("B") & scInfo.vglProj.timeStamp.ToShortDateString
                        .Values = vdatenreihe
                        .XValues = Xdatenreihe

                        .ChartType = vglChartType

                        If vglChartType = Excel.XlChartType.xlLine Then
                            With .Format.Line
                                .DashStyle = Microsoft.Office.Core.MsoLineDashStyle.msoLineDash
                                .ForeColor.RGB = visboFarbeOrange
                                .Weight = 4
                            End With
                        Else
                            ' ggf noch was definieren ..
                        End If

                    End With

                End If

                ' jetzt kommt der Neu-Aufbau der Series-Collections
                If considerIstDaten Then

                    ' jetzt die Istdaten zeichnen 
                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                        '.Name = repMessages.getmsg(194) & " " & hproj.timeStamp.ToShortDateString
                        .Name = bestimmeLegendNameIPB("I")
                        .Interior.Color = awinSettings.SollIstFarbeArea
                        .Values = istDatenReihe
                        .XValues = Xdatenreihe
                        .ChartType = IstCharttype
                    End With

                End If


            End With


            With newChtObj.Chart

                .HasTitle = True
                .ChartTitle.Text = diagramTitle
                .ChartTitle.Font.Size = awinSettings.fontsizeTitle
                .ChartTitle.Format.TextFrame2.TextRange.Font.Fill.ForeColor.RGB = Excel.XlRgbColor.rgbBlack

                If startRed > 0 And lengthRed > 0 Then
                    ' die aktuelle Summe muss rot eingefärbt werden 
                    .ChartTitle.Format.TextFrame2.TextRange.Characters(startRed, lengthRed).Font.Fill.ForeColor.RGB = Excel.XlRgbColor.rgbRed
                End If

            End With


        End With


        appInstance.EnableEvents = formerEE
        'appInstance.ScreenUpdating = formerSU

        repObj = newChtObj


    End Sub

    '''' <summary>
    '''' Prozedur zeigt die Ressourcen Struktur des Projektes an (Balken-Diagramm)
    '''' </summary>
    '''' <param name="hproj"></param>
    '''' <param name="repObj">Verweis auf das Grafik Objekt. 
    '''' Das wird dann von der Reporting Engine verwendet </param>
    '''' <param name="auswahl">steuert, was angezeigt wird
    '''' Auswahl = 1 : Diagramm zeigt Mann-Monate
    '''' Auswahl = 2 : Diagramm zeigt Personal-Kosten
    '''' </param>
    '''' <param name="top"></param>
    '''' <param name="left"></param>
    '''' <param name="height"></param>
    '''' <param name="width"></param>
    '''' <remarks>Kennung Phasen, Personalbedarf, Personalkosten, Sonstige Kosten, Gesamtkosten, Strategie, Ergebnis</remarks>
    'Public Sub createRessBalkenOfProject(ByVal hproj As clsProjekt, ByVal vglproj As clsProjekt,
    '                                     ByRef repObj As Excel.ChartObject, ByVal auswahl As Integer,
    '                                        ByVal top As Double, left As Double, height As Double, width As Double,
    '                                        ByVal calledFromReporting As Boolean,
    '                                        Optional ByVal roleName As String = "",
    '                                        Optional ByVal vglTyp As Integer = PTprdk.PersonalBalken,
    '                                        Optional ByVal calledFromMassEdit As Boolean = False)


    '    Dim kennung As String = " "
    '    Dim diagramTitle As String = " "
    '    Dim anzDiagrams As Integer

    '    Dim plen As Integer
    '    Dim i As Integer
    '    Dim Xdatenreihe() As String
    '    Dim tdatenreihe() As Double
    '    Dim istDatenReihe() As Double
    '    Dim prognoseDatenReihe() As Double
    '    Dim vdatenreihe() As Double
    '    Dim vSum As Double = 0.0
    '    Dim hsum() As Double, gesamt_summe As Double
    '    Dim anzRollen As Integer
    '    'Dim chtTitle As String
    '    Dim pkIndex As Integer = CostDefinitions.Count
    '    Dim pstart As Integer
    '    Dim ErgebnisListeR As New Collection
    '    'Dim roleName As String
    '    Dim zE As String = awinSettings.kapaEinheit
    '    Dim titelTeile(1) As String
    '    Dim titelTeilLaengen(1) As Integer
    '    Dim tmpcollection As New Collection
    '    Dim currentSheetName As String
    '    Dim newChtObj As Excel.ChartObject = Nothing
    '    Dim maxlenTitle1 As Integer = 20

    '    Dim found As Boolean = False


    '    If visboZustaende.projectBoardMode = ptModus.graficboard Then
    '        If calledFromReporting Then
    '            currentSheetName = arrWsNames(ptTables.repCharts)
    '        Else
    '            currentSheetName = arrWsNames(ptTables.mptPrCharts)
    '        End If

    '    Else
    '        currentSheetName = arrWsNames(ptTables.meCharts)
    '    End If


    '    Dim formerEE As Boolean = appInstance.EnableEvents
    '    'Dim formerSU As Boolean = appInstance.ScreenUpdating
    '    appInstance.EnableEvents = False
    '    'appInstance.ScreenUpdating = False


    '    Dim pname As String = hproj.name

    '    If roleName = "" Then
    '        tmpcollection.Add(hproj.name & "#" & auswahl.ToString)
    '    Else
    '        tmpcollection.Add(hproj.name & "#" & auswahl.ToString & "#" & roleName)
    '    End If


    '    kennung = calcChartKennung("pr", vglTyp, tmpcollection)


    '    '
    '    ' hole die Projektdauer
    '    '
    '    With hproj
    '        plen = .anzahlRasterElemente
    '        pstart = .Start
    '    End With

    '    If Not IsNothing(vglproj) Then
    '        If plen < vglproj.anzahlRasterElemente Then
    '            plen = vglproj.anzahlRasterElemente
    '        End If
    '    End If
    '    '
    '    ' hole die Anzahl Kostenarten, die in diesem Projekt vorkommen
    '    '
    '    '
    '    ' hole die Anzahl Rollen, die in diesem Projekt vorkommen
    '    '
    '    ErgebnisListeR = hproj.getRoleNames
    '    anzRollen = ErgebnisListeR.Count

    '    If anzRollen = 0 Then
    '        'Throw New Exception("keine Ressourcen Bedarfe definiert")
    '        appInstance.EnableEvents = formerEE
    '        Throw New Exception(repMessages.getmsg(161))
    '    End If


    '    ReDim Xdatenreihe(plen - 1)
    '    ReDim tdatenreihe(plen - 1)
    '    ReDim istDatenReihe(plen - 1)
    '    ReDim prognoseDatenReihe(plen - 1)
    '    ReDim vdatenreihe(plen - 1)

    '    ReDim hsum(anzRollen - 1)


    '    For i = 1 To plen
    '        Xdatenreihe(i - 1) = StartofCalendar.AddMonths(pstart + i - 2).ToString("MMM yy", repCult)
    '    Next i

    '    gesamt_summe = 0
    '    With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(currentSheetName), Excel.Worksheet)
    '        anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
    '        '
    '        ' um welches Diagramm handelt es sich ...
    '        '
    '        i = 1
    '        While i <= anzDiagrams And Not found

    '            If .ChartObjects(i).name = kennung Then
    '                found = True
    '                repObj = CType(.ChartObjects(i), Excel.ChartObject)
    '            Else
    '                i = i + 1
    '            End If

    '        End While

    '        If found Then

    '            appInstance.EnableEvents = formerEE
    '            'appInstance.ScreenUpdating = formerSU
    '            repObj = CType(.ChartObjects(i), Excel.ChartObject)
    '            Exit Sub
    '        Else
    '            ' die Einstellungen, um später dann den Titel und die Datenreihen zu berechnen 

    '            Dim startRed As Integer = 0
    '            Dim lengthRed As Integer = 0
    '            Dim scInfo As New clsSmartPPTChartInfo
    '            With scInfo
    '                .q2 = roleName
    '                .vglProj = vglproj
    '                .vergleichsArt = PTVergleichsArt.beauftragung
    '                .vergleichsTyp = PTVergleichsTyp.letzter
    '                .elementTyp = ptElementTypen.roles
    '                .einheit = PTEinheiten.euro
    '            End With

    '            newChtObj = CType(.ChartObjects, Excel.ChartObjects).Add(left, top, width, height)

    '            With CType(newChtObj.Chart, Excel.Chart)
    '                ' remove old series
    '                Try
    '                    Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
    '                    Do While anz > 0
    '                        .SeriesCollection(1).Delete()
    '                        anz = anz - 1
    '                    Loop
    '                Catch ex As Exception

    '                End Try

    '                .HasAxis(Excel.XlAxisType.xlCategory) = True
    '                .HasAxis(Excel.XlAxisType.xlValue) = True

    '                With CType(.Axes(Excel.XlAxisType.xlCategory), Excel.Axis)
    '                    .HasTitle = False
    '                    '.MinimumScale = 0
    '                    'With .AxisTitle
    '                    '    .Characters.text = "Monate"
    '                    '    .Font.Size = 8
    '                    'End With
    '                End With

    '                With .Axes(Excel.XlAxisType.xlValue)
    '                    .HasTitle = False
    '                    '.MaximumScale = maxscale
    '                    .MinimumScale = 0

    '                    'With .AxisTitle
    '                    '    .Characters.text = "Kosten"
    '                    '    .Font.Size = 8
    '                    'End With
    '                End With

    '                .HasLegend = True
    '                With .Legend
    '                    .Position = Excel.XlLegendPosition.xlLegendPositionTop
    '                    .Font.Size = awinSettings.fontsizeLegend
    '                End With
    '                .HasTitle = True
    '                .ChartTitle.Text = " "  ' Platzhalter 
    '                '.ChartTitle.Font.Size = awinSettings.fontsizeTitle

    '            End With

    '            newChtObj.Name = kennung



    '        End If

    '        With newChtObj.Chart

    '            If auswahl = 1 Then
    '                If roleName = "" Then
    '                    tdatenreihe = hproj.getAlleRessourcen
    '                Else
    '                    tdatenreihe = hproj.getRessourcenBedarf(roleName, True)
    '                End If

    '            Else
    '                If roleName = "" Then
    '                    tdatenreihe = hproj.getAllPersonalKosten
    '                Else
    '                    tdatenreihe = hproj.getRessourcenBedarf(roleName, inclSubRoles:=True, outPutInEuro:=True)

    '                End If

    '            End If
    '            gesamt_summe = tdatenreihe.Sum

    '            ' die Betrachtung der Ist-Daten versus Prognose Daten ...
    '            ' jetzt müssen ggf die IstDaten und PrognoseDaten aufgebaut werden

    '            Call tdatenreihe.CopyTo(prognoseDatenReihe, 0)

    '            Dim considerIstDaten As Boolean = hproj.actualDataUntil > hproj.startDate
    '            Dim actualdataIndex As Integer = -1

    '            If considerIstDaten Then

    '                Call tdatenreihe.CopyTo(istDatenReihe, 0)

    '                actualdataIndex = getColumnOfDate(hproj.actualDataUntil) - getColumnOfDate(hproj.startDate)
    '                ' die Prognose Daten bereinigen
    '                For ix As Integer = 0 To actualdataIndex
    '                    prognoseDatenReihe(ix) = 0
    '                Next

    '                For ix = actualdataIndex + 1 To plen - 1
    '                    istDatenReihe(ix) = 0
    '                Next

    '                ' jetzt die Istdaten zeichnen 
    '                With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
    '                    '.Name = repMessages.getmsg(194) & " " & hproj.timeStamp.ToShortDateString
    '                    .Name = repMessages.getmsg(194)
    '                    '.Interior.Color = visboFarbeBlau
    '                    .Interior.Color = awinSettings.SollIstFarbeArea
    '                    .Values = istDatenReihe
    '                    .XValues = Xdatenreihe
    '                    .ChartType = Excel.XlChartType.xlColumnStacked
    '                End With


    '            End If


    '            'series
    '            With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
    '                '.Name = repMessages.getmsg(273) & " " & hproj.timeStamp.ToShortDateString
    '                '.Name = repMessages.getmsg(38) & " " & hproj.timeStamp.ToShortDateString
    '                .Name = repMessages.getmsg(38)
    '                .Interior.Color = visboFarbeBlau
    '                '.Values = tdatenreihe
    '                .Values = prognoseDatenReihe
    '                .XValues = Xdatenreihe
    '                .ChartType = Excel.XlChartType.xlColumnStacked

    '            End With

    '            If Not IsNothing(vglproj) Then
    '                If auswahl = 1 Then
    '                    If roleName = "" Then
    '                        vdatenreihe = vglproj.getAlleRessourcen
    '                    Else
    '                        'vdatenreihe = vglproj.getRessourcenBedarf(roleName, True)
    '                        vdatenreihe = vglproj.getRessourcenBedarf(roleName, inclSubRoles:=True)
    '                    End If
    '                Else
    '                    If roleName = "" Then
    '                        vdatenreihe = vglproj.getAllPersonalKosten
    '                    Else
    '                        'vdatenreihe = vglproj.getPersonalKosten(roleName, True)
    '                        vdatenreihe = vglproj.getRessourcenBedarf(roleName, inclSubRoles:=True, outPutInEuro:=True)
    '                    End If
    '                End If

    '                vSum = vdatenreihe.Sum

    '                'series
    '                With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
    '                    '.Name = repMessages.getmsg(43).Trim & " " & vglproj.timeStamp.ToShortDateString
    '                    ' Stand vom ... (273)
    '                    .Name = repMessages.getmsg(43).Trim & " " & vglproj.timeStamp.ToShortDateString
    '                    '.Interior.Color = 0
    '                    .Values = vdatenreihe
    '                    .XValues = Xdatenreihe
    '                    .ChartType = Excel.XlChartType.xlLine
    '                    With .Format.Line
    '                        .DashStyle = core.MsoLineDashStyle.msoLineDash
    '                        '.ForeColor.RGB = Excel.XlRgbColor.rgbFireBrick
    '                        .ForeColor.RGB = visboFarbeOrange
    '                        .Weight = 4
    '                    End With
    '                End With
    '            End If



    '        End With


    '        diagramTitle = bestimmeChartDiagramTitle(sCInfo, tdatenreihe.Sum, vdatenreihe.Sum, startRed, lengthRed)

    '        If auswahl = 1 Then
    '            ' tk 12.6.17 
    '            'titelTeile(0) = repMessages.getmsg(159) & " (" & gesamt_summe.ToString("####0.") & " " & zE & ")" & vbLf & hproj.getShapeText & vbLf
    '            Dim anfText As String = repMessages.getmsg(159)
    '            If roleName <> "" Then
    '                anfText = anfText & " " & roleName
    '            End If
    '            If Not IsNothing(vglproj) Then
    '                'titelTeile(0) = repMessages.getmsg(159) & " (" & vSum.ToString("####0.") & " / " & gesamt_summe.ToString("####0.") & " " & zE & ")"
    '                titelTeile(0) = anfText & " (" & gesamt_summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " " & zE & ")"
    '            Else
    '                titelTeile(0) = anfText & " (" & gesamt_summe.ToString("##,##0.") & " " & zE & ")"
    '            End If

    '            titelTeilLaengen(0) = titelTeile(0).Length
    '            titelTeile(1) = ""
    '            'If calledFromReporting Then
    '            '    titelTeile(1) = vbLf & hproj.getShapeText

    '            '    If titelTeile(1).Length > maxlenTitle1 + 3 Then
    '            '        titelTeile(1) = titelTeile(1).Substring(0, maxlenTitle1) & "... (" & hproj.timeStamp.ToString & ") "
    '            '    Else
    '            '        titelTeile(1) = titelTeile(1) & " (" & hproj.timeStamp.ToString & ") "
    '            '    End If
    '            'Else
    '            '    titelTeile(1) = ""
    '            'End If

    '            titelTeilLaengen(1) = titelTeile(1).Length
    '            diagramTitle = titelTeile(0) & titelTeile(1)
    '            'kennung = "Personalbedarf"

    '        ElseIf auswahl = 2 Then
    '            ' tk 12.6.17
    '            'titelTeile(0) = repMessages.getmsg(160) & " (" & gesamt_summe.ToString("####0.") & " T€" & ")" & vbLf & hproj.getShapeText & vbLf

    '            Dim anfText As String = repMessages.getmsg(160)
    '            If roleName <> "" Then
    '                anfText = anfText & " " & roleName
    '            End If

    '            If Not IsNothing(vglproj) Then
    '                'titelTeile(0) = repMessages.getmsg(160) & " (" & vSum.ToString("####0.") & " / " & gesamt_summe.ToString("####0.") & " T€" & ")"
    '                titelTeile(0) = anfText & " (" & gesamt_summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " T€" & ")"
    '            Else
    '                titelTeile(0) = anfText & " (" & gesamt_summe.ToString("##,##0.") & " T€" & ")"
    '            End If

    '            titelTeilLaengen(0) = titelTeile(0).Length

    '            titelTeile(1) = ""
    '            ''If calledFromReporting Then
    '            ''    titelTeile(1) = vbLf & hproj.getShapeText
    '            ''    If titelTeile(1).Length > maxlenTitle1 + 3 Then
    '            ''        titelTeile(1) = titelTeile(1).Substring(0, maxlenTitle1) & "... (" & hproj.timeStamp.ToString & ") "
    '            ''    Else
    '            ''        titelTeile(1) = titelTeile(1) & " (" & hproj.timeStamp.ToString & ") "
    '            ''    End If
    '            ''Else
    '            ''    titelTeile(1) = ""
    '            ''End If

    '            titelTeilLaengen(1) = titelTeile(1).Length
    '            diagramTitle = titelTeile(0) & titelTeile(1)
    '            'kennung = "Personalkosten"
    '        Else
    '            diagramTitle = "--- (T€)" & vbLf & pname
    '            'kennung = "Gesamtkosten"
    '        End If


    '        With newChtObj.Chart
    '            .ChartTitle.Text = diagramTitle
    '            .ChartTitle.Font.Size = awinSettings.fontsizeTitle
    '            .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1,
    '                titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend
    '        End With


    '    End With


    '    appInstance.EnableEvents = formerEE
    '    'appInstance.ScreenUpdating = formerSU

    '    repObj = newChtObj


    'End Sub

    ''' <summary>
    ''' setzt die Time Zone
    ''' gibt false zurück, wenn keine TimeZone gesetzt ist und keine Projekte da sind
    ''' </summary>
    ''' <returns></returns>
    Public Function setTimeZoneIfTimeZonewasOff() As Boolean
        Dim timeZoneWasOff As Boolean = False
        If showRangeLeft > 0 And showRangeRight > showRangeLeft Then
            If ShowProjekte.Count > 0 Then
                timeZoneWasOff = True
            Else
                timeZoneWasOff = False

            End If ' alles ok 
        Else

            If ShowProjekte.Count > 0 Then
                timeZoneWasOff = True
                If selectedProjekte.Count > 0 Then
                    showRangeLeft = selectedProjekte.getMinMonthColumn
                    showRangeRight = selectedProjekte.getMaxMonthColumn
                Else
                    showRangeLeft = ShowProjekte.getMinMonthColumn
                    showRangeRight = ShowProjekte.getMaxMonthColumn
                End If
                Call awinShowtimezone(showRangeLeft, showRangeRight, True)
            End If


        End If

        setTimeZoneIfTimeZonewasOff = timeZoneWasOff

    End Function

    ''' <summary>
    ''' aktualisiert in PPT die Balken Diagramme Rollen (PT oder T€) bzw. Kostenarten (T€)
    ''' </summary>
    ''' <param name="hproj">das Ausgangsprojekt</param>
    ''' <param name="vglProj">das Projekt, mit dem verglichen wird</param>
    ''' <param name="chtobj">das Chart, das aktualisiert werden soll</param>
    ''' <param name="prcTyp">handelt es sich um Rollen, Phasen, Meilensteine oder Kostenarten</param>
    ''' <param name="auswahl">Kosten oder Personalbedarf</param>
    ''' <param name="rcName">leer, oder Rollen oder Kostenart-Name</param>
    ''' <remarks></remarks>
    Public Sub updatePPTBalkenOfProject(ByVal hproj As clsProjekt, ByVal vglProj As clsProjekt,
                                        ByRef chtobj As Excel.ChartObject,
                                        ByVal prcTyp As Integer, ByVal auswahl As Integer, ByVal rcName As String,
                                        ByVal curWS As Excel.Worksheet)

        Dim xlsChart As Excel.Chart = chtobj.Chart
        Dim kennung As String = chtobj.Name
        Dim diagramTitle As String = " "
        Dim plen As Integer
        Dim i As Integer
        Dim Xdatenreihe() As String
        Dim tdatenreihe() As Double
        Dim istDatenReihe() As Double
        Dim prognoseDatenReihe() As Double
        Dim vdatenreihe() As Double
        Dim vSum As Double = 0.0
        'Dim sumdatenreihe() As Double
        Dim hsum(1) As Double, gesamt_summe As Double
        'Dim anzElemente As Integer
        Dim pkIndex As Integer = CostDefinitions.Count
        Dim pstart As Integer
        'Dim ErgebnisListeRC As New Collection
        'Dim roleCostName As String
        Dim zE As String = awinSettings.kapaEinheit
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim tmpCollection As New Collection
        Dim maxlenTitle1 As Integer = 20

        Dim chartType As Excel.XlChartType
        Dim curmaxScale As Double
        Dim considerIstDaten As Boolean = False

        ' für das SetSourceData 
        Dim myRange As Excel.Range = Nothing
        Dim usedRange As Excel.Range = curWS.UsedRange
        ' Ende setsource Vorbereitungen 

        ' die Settings herauslesen ...
        Dim chartTyp As String = ""
        Dim typID As Integer = -1
        Dim projectName As String = ""
        Dim rcNameChk As String = ""
        Call getChartKennungen(chtobj.Name, chartTyp, typID, auswahl, projectName, rcNameChk)

        If rcNameChk <> rcName Then
            Dim a As Integer = 1
        End If

        ' solnage die repMessages noch nicht in der Datenbank sind, muss man sich über dieses Konstrukt behelfen ... 
        ' (,0) ist deutsch, (,1) ist englisch
        ' 0= 
        Dim repmsg() As String
        ReDim repmsg(6)

        If awinSettings.englishLanguage Then
            repmsg(0) = "Personnel Costs" '164
            repmsg(1) = "Forecast" ' 38
            repmsg(2) = "other Costs" ' 165
            repmsg(3) = "approved version from" ' 273, vorher 43
            repmsg(4) = "Personnel Needs" '159
            repmsg(5) = "Total Costs" ' 166
            repmsg(6) = "Actual data"
        Else
            repmsg(0) = "Personalkosten" '164
            repmsg(1) = "Prognose" ' 38
            repmsg(2) = "sonstige Kosten" ' 165
            repmsg(3) = "Beauftragung vom" ' 273 ; Beauftragung 43
            repmsg(4) = "Personalbedarf" '159
            repmsg(5) = "Gesamtkosten" ' 166
            repmsg(6) = "Ist-Werte"
        End If

        Dim series1Name As String = repmsg(1)
        Dim series2Name As String = "-"

        ' die ganzen Vor-Klärungen machen ...
        With xlsChart
            chartType = .ChartType

            If CBool(.HasAxis(Excel.XlAxisType.xlValue)) Then

                With CType(.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                    ' das ist dann relevant, wenn ein anderes Projekt selektiert wird, das über die aktuelle Skalierung 
                    ' hinausgehende Werte hat 
                    curmaxScale = .MaximumScale
                    .MaximumScaleIsAuto = False
                End With

            End If

        End With


        Dim pname As String = hproj.name

        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With

        If Not IsNothing(vglProj) Then
            If plen < vglProj.anzahlRasterElemente Then
                plen = vglProj.anzahlRasterElemente
            End If
        End If

        '
        ' hole die Anzahl Kostenarten, die in diesem Projekt vorkommen
        '
        '
        ' hole die Anzahl Rollen, die in diesem Projekt vorkommen
        '
        ' tk 9.8.18 braucht man hier nicht 
        ''If prcTyp = ptElementTypen.roles Then
        ''    ErgebnisListeRC = hproj.getRoleNames
        ''Else
        ''    ErgebnisListeRC = hproj.getCostNames
        ''End If

        ''anzElemente = ErgebnisListeRC.Count




        ReDim Xdatenreihe(plen - 1)
        ReDim tdatenreihe(plen - 1)
        ReDim istDatenReihe(plen - 1)
        ReDim prognoseDatenReihe(plen - 1)
        ReDim vdatenreihe(plen - 1)
        'ReDim sumdatenreihe(plen - 1)


        For i = 1 To plen
            Xdatenreihe(i - 1) = hproj.startDate.AddDays(-1 * hproj.startDate.Day + 1).AddMonths(i - 1).ToString("MMM yy", repCult)
        Next i



        With CType(xlsChart, Excel.Chart)

            ' remove old series
            Try
                Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                Do While anz > 0
                    .SeriesCollection(1).Delete()
                    anz = anz - 1
                Loop
            Catch ex As Exception

            End Try

            'Dim series1Name As String = repmsg(1) & " " & hproj.timeStamp.ToShortDateString ' Stand vom 

            If Not IsNothing(vglProj) Then
                series2Name = repmsg(3) & " " & vglProj.timeStamp.ToShortDateString ' erste Beauftragung vom 
            End If

            ' roles, auswahl=1: Personalbedarf
            ' roles: auswahl=2: Personalkosten
            ' costs: auswahl=1: andere Kosten
            ' costs: auswahl=2: Gesamtkosten

            If prcTyp = ptElementTypen.roles Then
                If auswahl = 2 Then
                    If rcName = "" Then
                        tdatenreihe = hproj.getAllPersonalKosten
                        If Not IsNothing(vglProj) Then
                            vdatenreihe = vglProj.getAllPersonalKosten
                        End If
                    Else
                        tdatenreihe = hproj.getRessourcenBedarf(rcName, inclSubRoles:=True, outPutInEuro:=True)
                        If Not IsNothing(vglProj) Then
                            vdatenreihe = vglProj.getRessourcenBedarf(rcName, inclSubRoles:=True, outPutInEuro:=True)
                        End If
                    End If

                Else
                    If rcName = "" Then
                        tdatenreihe = hproj.getAlleRessourcen
                        If Not IsNothing(vglProj) Then
                            vdatenreihe = vglProj.getAlleRessourcen
                        End If
                    Else
                        tdatenreihe = hproj.getRessourcenBedarf(rcName, True)
                        If Not IsNothing(vglProj) Then
                            vdatenreihe = vglProj.getRessourcenBedarf(rcName, True)
                        End If
                    End If
                End If

            ElseIf prcTyp = ptElementTypen.costs Then
                If auswahl = 2 Then
                    tdatenreihe = hproj.getGesamtKostenBedarf
                    If Not IsNothing(vglProj) Then
                        vdatenreihe = vglProj.getGesamtKostenBedarf
                    End If
                Else
                    tdatenreihe = hproj.getGesamtAndereKosten
                    If Not IsNothing(vglProj) Then
                        vdatenreihe = vglProj.getGesamtAndereKosten
                    End If
                End If
            Else
                ' darf eigentlich gar nicht sein ... 

            End If

            gesamt_summe = tdatenreihe.Sum
            vSum = 0

            Call tdatenreihe.CopyTo(prognoseDatenReihe, 0)

            considerIstDaten = hproj.actualDataUntil > hproj.startDate
            Dim actualdataIndex As Integer = -1

            If considerIstDaten Then

                Call tdatenreihe.CopyTo(istDatenReihe, 0)

                actualdataIndex = getColumnOfDate(hproj.actualDataUntil) - getColumnOfDate(hproj.startDate)
                ' die Prognose Daten bereinigen
                For ix As Integer = 0 To actualdataIndex
                    prognoseDatenReihe(ix) = 0
                Next

                For ix = actualdataIndex + 1 To plen - 1
                    istDatenReihe(ix) = 0
                Next

                ' jetzt die Istdaten zeichnen 
                With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                    '.Name = repmsg(6) & " " & hproj.timeStamp.ToShortDateString
                    .Name = repmsg(6)
                    '.Interior.Color = visboFarbeBlau
                    .Interior.Color = awinSettings.SollIstFarbeArea
                    .Values = istDatenReihe
                    .XValues = Xdatenreihe
                    .ChartType = Excel.XlChartType.xlColumnStacked
                End With


            End If


            With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)

                .ChartType = Excel.XlChartType.xlColumnStacked
                .Name = series1Name
                .Interior.Color = visboFarbeBlau
                '.Interior.Color = visboFarbeYellow
                '.Values = tdatenreihe
                .Values = prognoseDatenReihe
                .XValues = Xdatenreihe

            End With

            If Not IsNothing(vglProj) Then

                vSum = vdatenreihe.Sum

                'series
                With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                    .ChartType = Excel.XlChartType.xlLine
                    .Name = series2Name

                    .Values = vdatenreihe
                    .XValues = Xdatenreihe

                    With .Format.Line
                        .DashStyle = core.MsoLineDashStyle.msoLineDash
                        '.ForeColor.RGB = Excel.XlRgbColor.rgbFireBrick
                        .ForeColor.RGB = visboFarbeOrange
                        .Weight = 4
                    End With
                End With
            End If


            If CBool(.HasAxis(Excel.XlAxisType.xlValue)) Then

                With CType(.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                    ' das ist dann relevant, wenn ein anderes Projekt selektiert wird, das über die aktuelle Skalierung 
                    ' hinausgehende Werte hat 

                    If System.Math.Max(tdatenreihe.Max, vdatenreihe.Max) > .MaximumScale - 3 Then
                        .MaximumScale = System.Math.Max(tdatenreihe.Max, vdatenreihe.Max) + 3
                    End If


                End With

            End If

            ' nur wenn es auch einen Titel gibt ... 
            If .HasTitle Then
                ' jetzt muss der Header bestimmt werden 
                Dim tmpStr() As String = .ChartTitle.Text.Split(New Char() {CType("(", Char)})
                titelTeile(0) = tmpStr(0).Trim

                If prcTyp = ptElementTypen.roles Then
                    If auswahl = 1 Then

                        Dim anfText As String = repmsg(4)
                        If rcName <> "" Then
                            anfText = anfText & " " & rcName
                        End If

                        If Not IsNothing(vglProj) Then
                            'titelTeile(0) = repMessages.getmsg(159) & " (" & gesamt_summe.ToString("####0.") & " / " & vSum.ToString("####0.") & " " & zE & ")"
                            'titelTeile(0) = repmsg(4) & " (" & vSum.ToString("####0.") & " / " & gesamt_summe.ToString("####0.") & " " & zE & ")"
                            titelTeile(0) = anfText & " (" & gesamt_summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " " & zE & ")"
                        Else
                            'titelTeile(0) = repMessages.getmsg(159) & " (" & gesamt_summe.ToString("####0.") & " " & zE & ")"
                            titelTeile(0) = anfText & " (" & gesamt_summe.ToString("##,##0.") & " " & zE & ")"
                        End If
                        titelTeile(1) = ""

                    ElseIf auswahl = 2 Then

                        Dim anfText As String = repmsg(0)
                        If rcName <> "" Then
                            anfText = anfText & " " & rcName
                        End If

                        If Not IsNothing(vglProj) Then
                            'titelTeile(0) = repMessages.getmsg(160) & " (" & gesamt_summe.ToString("####0.") & " / " & vSum.ToString("####0.") & " T€" & ")"
                            'titelTeile(0) = repmsg(0) & " (" & vSum.ToString("####0.") & " / " & gesamt_summe.ToString("####0.") & " T€" & ")"
                            titelTeile(0) = anfText & " (" & gesamt_summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " T€" & ")"
                        Else
                            'titelTeile(0) = repMessages.getmsg(160) & " (" & gesamt_summe.ToString("####0.") & " T€" & ")"
                            titelTeile(0) = anfText & " (" & gesamt_summe.ToString("##,##0.") & " T€" & ")"
                        End If
                        titelTeile(1) = ""
                    Else
                        titelTeile(0) = "--- (T€)"
                        titelTeile(1) = ""
                    End If
                Else
                    ' jetzt muss das aus Kosten übernommen werden 
                    'titelTeile(0) = repMessages.getmsg(165) & " (" & gesamt_Summe.ToString("####0.") & " T€" & ")"
                    If auswahl = 1 Then
                        If Not IsNothing(vglProj) Then
                            'titelTeile(0) = repMessages.getmsg(165) & " (" & gesamt_summe.ToString("####0.") & " / " & vSum.ToString("####0.") & " T€" & ")"
                            'titelTeile(0) = repmsg(2) & " (" & vSum.ToString("####0.") & " / " & gesamt_summe.ToString("####0.") & " T€" & ")"
                            titelTeile(0) = repmsg(2) & " (" & gesamt_summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " T€" & ")"
                        Else
                            'titelTeile(0) = repMessages.getmsg(165) & " (" & gesamt_summe.ToString("####0.") & " T€" & ")"
                            titelTeile(0) = repmsg(2) & " (" & gesamt_summe.ToString("##,##0.") & " T€" & ")"
                        End If
                    ElseIf auswahl = 2 Then
                        If Not IsNothing(vglProj) Then
                            'titelTeile(0) = repMessages.getmsg(166) & " (" & gesamt_summe.ToString("####0.") & " / " & vSum.ToString("####0.") & " T€" & ")"
                            'titelTeile(0) = repmsg(5) & " (" & vSum.ToString("####0.") & " / " & gesamt_summe.ToString("####0.") & " T€" & ")"
                            titelTeile(0) = repmsg(5) & " (" & gesamt_summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " T€" & ")"
                        Else
                            'titelTeile(0) = repMessages.getmsg(166) & " (" & gesamt_summe.ToString("####0.") & " T€" & ")"
                            titelTeile(0) = repmsg(5) & " (" & gesamt_summe.ToString("##,##0.") & " T€" & ")"
                        End If
                    Else
                        titelTeile(0) = "--- (T€)" & vbLf & pname
                    End If

                    titelTeile(1) = ""
                End If

                titelTeilLaengen(1) = titelTeile(1).Length
                titelTeilLaengen(0) = titelTeile(0).Length
                diagramTitle = titelTeile(0) & titelTeile(1)

                .ChartTitle.Text = diagramTitle
            End If


        End With

        ' tk 21.10.18
        ' jetzt wird myRange gesetzt und setSourceData gesetzt 
        Dim fZeile As Integer = usedRange.Rows.Count + 1
        Dim anzSpalten As Integer = plen + 1
        Dim anzRows As Integer = 0

        With curWS

            .Cells(fZeile, 1).value = ""
            .Range(.Cells(fZeile, 2), .Cells(fZeile, anzSpalten)).Value = Xdatenreihe

            If considerIstDaten Then

                anzRows = 3

                .Cells(fZeile + 1, 1).value = repmsg(6)
                .Range(.Cells(fZeile + 1, 2), .Cells(fZeile + 1, anzSpalten)).Value = istDatenReihe

                .Cells(fZeile + 2, 1).value = series1Name
                .Range(.Cells(fZeile + 2, 2), .Cells(fZeile + 2, anzSpalten)).Value = prognoseDatenReihe

                If Not IsNothing(vglProj) Then

                    anzRows = 4
                    .Cells(fZeile + 3, 1).value = series2Name
                    .Range(.Cells(fZeile + 3, 2), .Cells(fZeile + 3, anzSpalten)).Value = vdatenreihe

                End If

            Else

                anzRows = 2

                .Cells(fZeile + 1, 1).value = series1Name
                .Range(.Cells(fZeile + 1, 2), .Cells(fZeile + 1, anzSpalten)).Value = prognoseDatenReihe

                If Not IsNothing(vglProj) Then
                    anzRows = 3

                    .Cells(fZeile + 2, 1).value = series2Name
                    .Range(.Cells(fZeile + 2, 2), .Cells(fZeile + 2, anzSpalten)).Value = vdatenreihe

                End If

            End If

            myRange = curWS.Range(.Cells(fZeile, 1), .Cells(fZeile + anzRows - 1, anzSpalten))

        End With

        chtobj.Chart.SetSourceData(Source:=myRange)




    End Sub

    ''' <summary>
    ''' übernimmt die updates der Balken Excel Charts
    ''' in scInfo muss all die Information übergeben werden , dann können quasi alle Formen Kosten / rollenbedarfe aktualisiert werden 
    ''' </summary>
    ''' <param name="scInfo"></param>
    ''' <param name="chtobj"></param>
    ''' <param name="changeScale"></param>
    Public Sub updateExcelChartOfProject(ByVal scInfo As clsSmartPPTChartInfo, ByVal chtobj As Excel.ChartObject,
                                         ByVal changeScale As Boolean, Optional ByVal calledFromMassEdit As Boolean = False)



        ' Ende , wenn es kein hproj gibt 
        If IsNothing(scInfo) Then
            Exit Sub
        End If

        If IsNothing(scInfo.hproj) Then
            Exit Sub
        End If

        Dim kennung As String = " "
        Dim maxlenTitle1 As Integer = 20

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False

        Dim fontSize1 As Double = awinSettings.fontsizeTitle
        Dim fontSize2 As Double = awinSettings.fontsizeLegend

        Dim pname As String = scInfo.hproj.name


        'Dim anzRollen As Integer
        Dim pkIndex As Integer = CostDefinitions.Count

        Dim diagramTitle As String = " "
        Dim IstCharttype As xlNS.XlChartType
        Dim PlanChartType As xlNS.XlChartType
        Dim vglChartType As xlNS.XlChartType

        Dim hproj As clsProjekt = scInfo.hproj
        Dim vglProj As clsProjekt = scInfo.vglProj


        Dim roleName As String = scInfo.q2

        Dim considerIstDaten As Boolean = scInfo.hproj.actualDataUntil > scInfo.hproj.startDate

        If scInfo.chartTyp = PTChartTypen.CurveCumul Then
            IstCharttype = xlNS.XlChartType.xlArea

            If considerIstDaten Then
                PlanChartType = xlNS.XlChartType.xlArea
            Else
                PlanChartType = xlNS.XlChartType.xlLine
            End If

            vglChartType = xlNS.XlChartType.xlLine
        Else
            IstCharttype = xlNS.XlChartType.xlColumnStacked
            PlanChartType = xlNS.XlChartType.xlColumnStacked
            vglChartType = xlNS.XlChartType.xlLine
        End If

        Dim plen As Integer
        Dim pstart As Integer

        Dim Xdatenreihe() As String = Nothing
        Dim tdatenreihe() As Double = Nothing
        Dim istDatenReihe() As Double = Nothing
        Dim prognoseDatenReihe() As Double = Nothing
        Dim vdatenreihe() As Double = Nothing
        Dim internKapaDatenreihe() As Double = Nothing
        Dim vDatensumme As Double = 0.0
        Dim tDatenSumme As Double = 0.0



        '
        ' hole die Projektdauer; berücksichtigen: die können unterschiedlich starten und unterschiedlich lang sein
        ' deshalb muss die Zeitspanne bestimmt werden, die beides umfasst  
        '
        Call bestimmePstartPlen(scInfo, pstart, plen)

        ' hier werden die Istdaten, die Prognosedaten, die Vergleichsdaten sowie die XDaten bestimmt
        Dim errMsg As String = ""
        Call bestimmeXtipvDatenreihen(pstart, plen, scInfo,
                                       Xdatenreihe, tdatenreihe, vdatenreihe, istDatenReihe, prognoseDatenReihe, internKapaDatenreihe, errMsg)

        If errMsg <> "" Then
            ' es ist ein Fehler aufgetreten
            Call MsgBox("Fehler beim Berechnen der chart-Reihen: " & vbLf & errMsg)
            Exit Sub
        End If


        Dim vProjDoesExist As Boolean = Not IsNothing(scInfo.vglProj)

        If scInfo.chartTyp = PTChartTypen.CurveCumul Then
            tDatenSumme = tdatenreihe(tdatenreihe.Length - 1)
            ''vDatensumme = vdatenreihe(vdatenreihe.Length - 1)
        Else
            tDatenSumme = tdatenreihe.Sum
            vDatensumme = vdatenreihe.Sum

        End If

        Dim startRed As Integer = 0
        Dim lengthRed As Integer = 0
        diagramTitle = bestimmeChartDiagramTitle(scInfo, tDatenSumme, vDatensumme, startRed, lengthRed, calledFromMassEdit)


        With CType(chtobj.Chart, Excel.Chart)

            ' bestimmen der Fontsize Größen 
            Try
                If .HasTitle Then
                    Dim len As Integer = .ChartTitle.Text.Length
                    fontSize1 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=1, Length:=1).Font.Size
                    fontSize2 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=len - 1, Length:=1).Font.Size
                End If
            Catch ex As Exception

            End Try

            ' remove old series
            Try
                Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                Do While anz > 0
                    .SeriesCollection(1).Delete()
                    anz = anz - 1
                Loop
            Catch ex As Exception

            End Try

            ' Planung / Forecast
            ' nur zeigen, wenn hproj.actualdata
            Dim dontShowPlanung As Boolean = False
            If hproj.hasActualValues Then
                If getColumnOfDate(hproj.actualDataUntil) >= getColumnOfDate(hproj.endeDate) Then
                    ' es kann keine Planwerte mehr geben , also nix zeichnen
                    dontShowPlanung = True
                End If
            End If

            If Not dontShowPlanung Then
                With CType(CType(.SeriesCollection, xlNS.SeriesCollection).NewSeries, xlNS.Series)

                    .Name = bestimmeLegendNameIPB("P") & scInfo.hproj.timeStamp.ToShortDateString
                    .Interior.Color = visboFarbeBlau
                    .Values = prognoseDatenReihe
                    .XValues = Xdatenreihe
                    .ChartType = PlanChartType

                    If scInfo.chartTyp = PTChartTypen.CurveCumul And Not considerIstDaten Then
                        ' es handelt sich um eine Line
                        .Format.Line.Weight = 4
                        .Format.Line.ForeColor.RGB = visboFarbeBlau
                        .Format.Line.DashStyle = Microsoft.Office.Core.MsoLineDashStyle.msoLineSolid
                    End If

                End With
            End If


            ' Beauftragung bzw. Vergleichsdaten
            If Not IsNothing(scInfo.vglProj) Then

                'series
                With CType(CType(.SeriesCollection, xlNS.SeriesCollection).NewSeries, xlNS.Series)
                    .Name = bestimmeLegendNameIPB("B") & scInfo.vglProj.timeStamp.ToShortDateString
                    .Values = vdatenreihe
                    .XValues = Xdatenreihe

                    .ChartType = vglChartType

                    If vglChartType = xlNS.XlChartType.xlLine Then
                        With .Format.Line
                            .DashStyle = Microsoft.Office.Core.MsoLineDashStyle.msoLineDash
                            .ForeColor.RGB = visboFarbeOrange
                            .Weight = 4
                        End With
                    Else
                        ' ggf noch was definieren ..
                    End If

                End With

            End If

            ' jetzt kommt der Neu-Aufbau der Series-Collections
            If considerIstDaten Then

                ' jetzt die Istdaten zeichnen 
                With CType(CType(.SeriesCollection, xlNS.SeriesCollection).NewSeries, xlNS.Series)
                    '.Name = repMessages.getmsg(194) & " " & hproj.timeStamp.ToShortDateString
                    .Name = bestimmeLegendNameIPB("I")
                    .Interior.Color = awinSettings.SollIstFarbeArea
                    .Values = istDatenReihe
                    .XValues = Xdatenreihe
                    .ChartType = IstCharttype
                End With

            End If


            If CBool(.HasAxis(Excel.XlAxisType.xlValue)) Then

                With CType(.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                    ' das ist dann relevant, wenn ein anderes Projekt selektiert wird, das über die aktuelle Skalierung 
                    ' hinausgehende Werte hat 

                    If changeScale Then
                        .MinimumScale = 0
                        .MaximumScaleIsAuto = True
                        ' Skalierung soll sich nur ändern, wenn sie größer werden muss
                        ' ansonsten ist es besser, man erkennt die Verhältnismäßigkeit 
                        'If Not (.MaximumScaleIsAuto) Then

                        Dim tstValue As Double = .MaximumScale

                        If System.Math.Max(tdatenreihe.Max, vdatenreihe.Max) > .MaximumScale - 3 Then
                            .MaximumScale = System.Math.Max(tdatenreihe.Max, vdatenreihe.Max) + 3
                        End If
                        '.MaximumScaleIsAuto = true

                        'End If
                    End If

                End With

            End If

        End With


        With chtobj.Chart
            If .HasTitle Then
                .ChartTitle.Text = diagramTitle
                .ChartTitle.Font.Size = awinSettings.fontsizeTitle
                .ChartTitle.Format.TextFrame2.TextRange.Font.Fill.ForeColor.RGB = Excel.XlRgbColor.rgbBlack

                If startRed > 0 And lengthRed > 0 Then
                    ' die aktuelle Summe muss rot eingefärbt werden 
                    .ChartTitle.Format.TextFrame2.TextRange.Characters(startRed,
                    lengthRed).Font.Fill.ForeColor.RGB = Excel.XlRgbColor.rgbRed
                End If
            End If


        End With


        appInstance.EnableEvents = formerEE
        'appInstance.ScreenUpdating = formerSU

    End Sub

    ''' <summary>
    ''' aktualisiert das Info Chart "Ressourcen Bedarf eines Projektes
    ''' übergeben wird das Projekt sowie das Chart 
    ''' </summary>
    ''' <param name="hproj">selektiertes Projekt</param>
    ''' <param name="chtobj">Chart, das ein Projekt-Info Chart darstellt</param>
    ''' <param name="auswahl">
    ''' 1: Diagramm zeigt Mann-Monate 
    ''' 2: Diagramm zeigt Personal-Kosten</param>
    ''' <param name="changeScale">gibt an, ob der Scale ggf an neue Werte angepasst werden muss</param>
    ''' <remarks>wenn es aus der Time Machine aus aufgerufen wird, darf der Scale gerade nicht angepasst werden </remarks>
    Public Sub updateRessBalkenOfProject(ByVal hproj As clsProjekt, ByVal vglProj As clsProjekt,
                                         ByRef chtobj As Excel.ChartObject,
                                         ByVal auswahl As Integer, ByVal changeScale As Boolean,
                                         ByVal roleName As String)


        Dim kennung As String = " "
        Dim diagramTitle As String = " "
        Dim plen As Integer
        Dim i As Integer
        Dim Xdatenreihe() As String
        Dim tdatenreihe() As Double
        Dim istDatenReihe() As Double
        Dim prognoseDatenReihe() As Double
        Dim vdatenreihe() As Double
        Dim vSum As Double = 0.0
        Dim gesamt_Summe As Double

        'Dim anzRollen As Integer
        Dim pkIndex As Integer = CostDefinitions.Count
        Dim pstart As Integer
        'Dim ErgebnisListeR As New Collection
        'Dim roleName As String
        Dim zE As String = awinSettings.kapaEinheit
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        'Dim tmpCollection As New Collection
        Dim maxlenTitle1 As Integer = 20

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False

        Dim fontSize1 As Double = awinSettings.fontsizeTitle, fontSize2 As Double = awinSettings.fontsizeLegend

        Dim pname As String = hproj.name

        'tmpCollection.Add(hproj.name & "#" & auswahl.ToString)
        'kennung = calcChartKennung("pr", PTprdk.PersonalBalken, tmpCollection)


        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With

        If Not IsNothing(vglProj) Then
            If plen < vglProj.anzahlRasterElemente Then
                plen = vglProj.anzahlRasterElemente
            End If
        End If

        ' tk , braucht man hier nicht 
        ''
        '' hole die Anzahl Kostenarten, die in diesem Projekt vorkommen
        ''
        ''
        '' hole die Anzahl Rollen, die in diesem Projekt vorkommen
        ''
        'ErgebnisListeR = hproj.getRoleNames
        'anzRollen = ErgebnisListeR.Count




        ReDim Xdatenreihe(plen - 1)
        ReDim tdatenreihe(plen - 1)
        ReDim istDatenReihe(plen - 1)
        ReDim prognoseDatenReihe(plen - 1)
        ReDim vdatenreihe(plen - 1)


        For i = 1 To plen
            Xdatenreihe(i - 1) = StartofCalendar.AddMonths(pstart + i - 2).ToString("MMM yy", repCult)
        Next i


        With CType(chtobj.Chart, Excel.Chart)

            ' bestimmen der Fontsize Größen 
            Try
                If .HasTitle Then
                    Dim len As Integer = .ChartTitle.Text.Length
                    fontSize1 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=1, Length:=1).Font.Size
                    fontSize2 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=len - 1, Length:=1).Font.Size
                End If
            Catch ex As Exception

            End Try

            ' remove old series
            Try
                Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                Do While anz > 0
                    .SeriesCollection(1).Delete()
                    anz = anz - 1
                Loop
            Catch ex As Exception

            End Try

            If auswahl = 1 Then
                If roleName = "" Then
                    tdatenreihe = hproj.getAlleRessourcen
                Else
                    tdatenreihe = hproj.getRessourcenBedarf(roleName, True)
                End If

            Else
                If roleName = "" Then
                    tdatenreihe = hproj.getAllPersonalKosten
                Else
                    tdatenreihe = hproj.getRessourcenBedarf(roleName, inclSubRoles:=True, outPutInEuro:=True)

                End If

            End If
            gesamt_Summe = tdatenreihe.Sum


            ' die Betrachtung der Ist-Daten versus Prognose Daten ...
            ' jetzt müssen ggf die IstDaten und PrognoseDaten aufgebaut werden

            Call tdatenreihe.CopyTo(prognoseDatenReihe, 0)

            Dim considerIstDaten As Boolean = hproj.actualDataUntil > hproj.startDate
            Dim actualdataIndex As Integer = -1

            If considerIstDaten Then

                Call tdatenreihe.CopyTo(istDatenReihe, 0)

                actualdataIndex = getColumnOfDate(hproj.actualDataUntil) - getColumnOfDate(hproj.startDate)
                ' die Prognose Daten bereinigen
                For ix As Integer = 0 To actualdataIndex
                    prognoseDatenReihe(ix) = 0
                Next

                For ix = actualdataIndex + 1 To plen - 1
                    istDatenReihe(ix) = 0
                Next

                ' jetzt die Istdaten zeichnen 
                With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                    '.Name = repMessages.getmsg(194) & " " & hproj.timeStamp.ToShortDateString
                    .Name = repMessages.getmsg(194)
                    '.Interior.Color = visboFarbeBlau
                    .Interior.Color = awinSettings.SollIstFarbeArea
                    .Values = istDatenReihe
                    .XValues = Xdatenreihe
                    .ChartType = Excel.XlChartType.xlColumnStacked
                End With


            End If



            'series
            With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                '.Name = repMessages.getmsg(273) & " " & hproj.timeStamp.ToShortDateString
                '.Name = repMessages.getmsg(38) & " " & hproj.timeStamp.ToShortDateString
                .Name = repMessages.getmsg(38)
                .Interior.Color = visboFarbeBlau
                '.Interior.Color = visboFarbeYellow
                '.Values = tdatenreihe
                .Values = prognoseDatenReihe
                .XValues = Xdatenreihe
                .ChartType = Excel.XlChartType.xlColumnStacked
            End With

            If Not IsNothing(vglProj) Then

                If auswahl = 1 Then
                    If roleName = "" Then
                        vdatenreihe = vglProj.getAlleRessourcen
                    Else
                        vdatenreihe = vglProj.getRessourcenBedarf(roleName, True)
                    End If
                Else
                    If roleName = "" Then
                        vdatenreihe = vglProj.getAllPersonalKosten
                    Else
                        vdatenreihe = vglProj.getRessourcenBedarf(roleName, inclSubRoles:=True, outPutInEuro:=True)
                    End If
                End If

                vSum = vdatenreihe.Sum

                'series
                With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                    '.Name = repMessages.getmsg(43) & " " & vglProj.timeStamp.ToShortDateString
                    ' Stand vom (273)
                    .Name = repMessages.getmsg(43) & " " & vglProj.timeStamp.ToShortDateString
                    '.Interior.Color = 0
                    .Values = vdatenreihe
                    .XValues = Xdatenreihe
                    .ChartType = Excel.XlChartType.xlLine
                    With .Format.Line
                        .DashStyle = core.MsoLineDashStyle.msoLineDash
                        '.ForeColor.RGB = Excel.XlRgbColor.rgbFireBrick
                        .ForeColor.RGB = visboFarbeOrange
                        .Weight = 4
                    End With
                End With
            End If


            If CBool(.HasAxis(Excel.XlAxisType.xlValue)) Then

                With CType(.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                    ' das ist dann relevant, wenn ein anderes Projekt selektiert wird, das über die aktuelle Skalierung 
                    ' hinausgehende Werte hat 

                    If changeScale Then
                        .MinimumScale = 0
                        .MaximumScaleIsAuto = True
                        ' Skalierung soll sich nur ändern, wenn sie größer werden muss
                        ' ansonsten ist es besser, man erkennt die Verhältnismäßigkeit 
                        'If Not (.MaximumScaleIsAuto) Then

                        Dim tstValue As Double = .MaximumScale

                        If System.Math.Max(tdatenreihe.Max, vdatenreihe.Max) > .MaximumScale - 3 Then
                            .MaximumScale = System.Math.Max(tdatenreihe.Max, vdatenreihe.Max) + 3
                        End If
                        '.MaximumScaleIsAuto = true

                        'End If
                    End If

                End With

            End If

        End With



        If auswahl = 1 Then
            ' tk 12.6.17 
            'titelTeile(0) = repMessages.getmsg(159) & " (" & gesamt_summe.ToString("####0.") & " " & zE & ")" & vbLf & hproj.getShapeText & vbLf
            Dim anfText As String = repMessages.getmsg(159)
            If roleName <> "" Then
                anfText = anfText & " " & roleName
            End If
            If Not IsNothing(vglProj) Then
                'titelTeile(0) = repMessages.getmsg(159) & " (" & vSum.ToString("####0.") & " / " & gesamt_summe.ToString("####0.") & " " & zE & ")"
                titelTeile(0) = anfText & " (" & gesamt_Summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " " & zE & ")"
            Else
                titelTeile(0) = anfText & " (" & gesamt_Summe.ToString("##,##0.") & " " & zE & ")"
            End If

            titelTeilLaengen(0) = titelTeile(0).Length
            titelTeile(1) = ""

            titelTeilLaengen(1) = titelTeile(1).Length
            diagramTitle = titelTeile(0) & titelTeile(1)

        ElseIf auswahl = 2 Then
            ' tk 12.6.17
            'titelTeile(0) = repMessages.getmsg(160) & " (" & gesamt_summe.ToString("####0.") & " T€" & ")" & vbLf & hproj.getShapeText & vbLf
            Dim anfText As String = repMessages.getmsg(160)
            If roleName <> "" Then
                anfText = anfText & " " & roleName
            End If

            If Not IsNothing(vglProj) Then
                'titelTeile(0) = repMessages.getmsg(160) & " (" & vSum.ToString("####0.") & " / " & gesamt_summe.ToString("####0.") & " T€" & ")"
                titelTeile(0) = anfText & " (" & gesamt_Summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " T€" & ")"
            Else
                titelTeile(0) = anfText & " (" & gesamt_Summe.ToString("##,##0.") & " T€" & ")"
            End If

            titelTeilLaengen(0) = titelTeile(0).Length

            titelTeile(1) = ""
            titelTeilLaengen(1) = titelTeile(1).Length

            diagramTitle = titelTeile(0) & titelTeile(1)

        Else
            diagramTitle = "--- (T€)"
            'kennung = "Gesamtkosten"
        End If

        With chtobj.Chart
            If .HasTitle Then
                .ChartTitle.Text = diagramTitle
                ' Änderung tk: wieder mit reingenmmen, da ja jetzt zu Beginn die fontsize1, ..2 bestimmt werden 
                .ChartTitle.Font.Size = CSng(fontSize1)
                .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1,
                    titelTeilLaengen(1)).Font.Size = CSng(fontSize2)
            End If


        End With

        ' tk, 9.8.18 das hat ja schon den richtigen Namen 
        'chtobj.Name = kennung



        appInstance.EnableEvents = formerEE
        'appInstance.ScreenUpdating = formerSU



    End Sub

    Public Sub createCostBalkenOfProjectInPPT(ByVal hproj As clsProjekt, ByVal vglProj As clsProjekt,
                                              ByVal pptAppl As PowerPoint.Application, ByVal presentationName As String, ByVal currentSlideName As String,
                                              ByVal auswahl As Integer, ByVal chartContainer As PowerPoint.Shape,
                                              ByVal DID As Integer, ByVal qualifier As String, ByVal qualifier2 As String)


        Dim titleFontSize As Single = 14
        If chartContainer.HasTextFrame = core.MsoTriState.msoTrue Then
            titleFontSize = chartContainer.TextFrame2.TextRange.Font.Size
        End If



        Dim top As Single = chartContainer.Top
        Dim left As Single = chartContainer.Left
        Dim height As Single = chartContainer.Height
        Dim width As Single = chartContainer.Width

        Dim currentPresentation As PowerPoint.Presentation = pptAppl.Presentations.Item(presentationName)
        Dim currentSlide As PowerPoint.Slide = currentPresentation.Slides.Item(currentSlideName)


        ' jetzt wird das Chart erzeugt ...

        Dim kennung As String = " "
        Dim diagramTitle As String = " "

        Dim plen As Integer

        Dim Xdatenreihe() As String
        Dim tdatenreihe() As Double
        Dim istDatenReihe() As Double
        Dim prognoseDatenReihe() As Double
        Dim vdatenreihe() As Double
        Dim vSum As Double = 0.0
        Dim gesamt_summe As Double
        'Dim anzKostenarten As Integer

        Dim pkIndex As Integer = CostDefinitions.Count
        Dim pstart As Integer

        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim tmpcollection As New Collection


        Dim found As Boolean = False


        'Dim ErgebnisListeK As Collection


        Dim pname As String = hproj.name

        '
        ' die Kennung für das Chart erstellen ...
        tmpcollection.Add(hproj.name & "#" & auswahl.ToString)
        kennung = calcChartKennung("pr", PTprdk.KostenBalken, tmpcollection)


        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With

        If Not IsNothing(vglProj) Then
            If plen < vglProj.anzahlRasterElemente Then
                plen = vglProj.anzahlRasterElemente
            End If
        End If
        '
        ' hole die Anzahl Kostenarten, die in diesem Projekt vorkommen
        '
        'ErgebnisListeK = hproj.getCostNames
        'anzKostenarten = ErgebnisListeK.Count


        ReDim Xdatenreihe(plen - 1)
        ReDim tdatenreihe(plen - 1)
        ReDim istDatenReihe(plen - 1)
        ReDim prognoseDatenReihe(plen - 1)
        ReDim vdatenreihe(plen - 1)

        For i As Integer = 1 To plen
            Xdatenreihe(i - 1) = StartofCalendar.AddMonths(pstart + i - 2).ToString("MMM yy", repCult)
        Next i


        Dim ik As Integer = 1 ' wird für die Unterscheidung benötigt, ob mit Personal-Kosten oder ohne 
        gesamt_summe = 0


        ' hier werden die Werte-Arrays für die einzelnen Chart-Elemente / SeriesCollectiuon gesetzt 

        If auswahl = 1 Then
            tdatenreihe = hproj.getGesamtAndereKosten
        Else
            tdatenreihe = hproj.getGesamtKostenBedarf
        End If

        gesamt_summe = tdatenreihe.Sum

        ' die Betrachtung der Ist-Daten versus Prognose Daten ...
        ' jetzt müssen ggf die IstDaten und PrognoseDaten aufgebaut werden

        Call tdatenreihe.CopyTo(prognoseDatenReihe, 0)

        Dim considerIstDaten As Boolean = hproj.actualDataUntil > hproj.startDate
        Dim actualdataIndex As Integer = -1

        If considerIstDaten Then

            Call tdatenreihe.CopyTo(istDatenReihe, 0)

            actualdataIndex = getColumnOfDate(hproj.actualDataUntil) - getColumnOfDate(hproj.startDate)
            ' die Prognose Daten bereinigen
            For ix As Integer = 0 To actualdataIndex
                prognoseDatenReihe(ix) = 0
            Next

            For ix = actualdataIndex + 1 To plen - 1
                istDatenReihe(ix) = 0
            Next

        End If

        If Not IsNothing(vglProj) Then
            If auswahl = 1 Then
                vdatenreihe = vglProj.getGesamtAndereKosten
            Else
                vdatenreihe = vglProj.getGesamtKostenBedarf
            End If
            vSum = vdatenreihe.Sum

        End If



        If auswahl = 1 Then
            ' tk 12.6.17 
            If Not IsNothing(vglProj) Then
                titelTeile(0) = repMessages.getmsg(165) & " (" & gesamt_summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " T€" & ")"
            Else
                titelTeile(0) = repMessages.getmsg(165) & " (" & gesamt_summe.ToString("##,##0.") & " T€" & ")"
            End If

            titelTeilLaengen(0) = titelTeile(0).Length
            Dim maxlenTitle1 As Integer = 20
            titelTeile(1) = ""

            titelTeilLaengen(1) = titelTeile(1).Length
            diagramTitle = titelTeile(0) & titelTeile(1)
            'kennung = "Personalbedarf"
        ElseIf auswahl = 2 Then
            ' tk 12.6.17

            If Not IsNothing(vglProj) Then
                'titelTeile(0) = repMessages.getmsg(166) & " (" & vSum.ToString("####0.") & " / " & gesamt_summe.ToString("####0.") & " T€" & ")"
                titelTeile(0) = repMessages.getmsg(166) & " (" & gesamt_summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " T€" & ")"
            Else
                titelTeile(0) = repMessages.getmsg(166) & " (" & gesamt_summe.ToString("##,##0.") & " T€" & ")"
            End If

            titelTeilLaengen(0) = titelTeile(0).Length
            titelTeile(1) = ""
            titelTeilLaengen(1) = titelTeile(1).Length
            diagramTitle = titelTeile(0) & titelTeile(1)

        Else
            diagramTitle = "--- (T€)" & vbLf & pname
            'kennung = "Gesamtkosten"
        End If

        ' Ende der Werte Bestimmung 

        Dim newPPTChart As PowerPoint.Shape = currentSlide.Shapes.AddChart(Type:=core.XlChartType.xlColumnStacked, Left:=left, Top:=top,
                                                                           Width:=width, Height:=height)

        newPPTChart.Name = kennung

        ' ---- ab hier das Setzen der Values per Setsource Data 
        Dim myRange As Excel.Range = Nothing
        Dim myWB As Excel.Workbook = Nothing
        Dim myWS As Excel.Worksheet = Nothing

        Dim usedRange As Excel.Range = Nothing
        Dim fZeile As Integer = 1
        Dim anzSpalten As Integer = 1
        Dim anzRows As Integer = 0


        With newPPTChart.Chart.ChartData
            .Activate()
            myWB = CType(.Workbook, Excel.Workbook)
            myWS = CType(myWB.ActiveSheet, Excel.Worksheet)

            usedRange = myWS.UsedRange
            fZeile = CType(myWB.ActiveSheet.usedRange, Excel.Range).Rows.Count + 1
            anzSpalten = plen + 1
            anzRows = 0

            With myWS

                ' neu 

                .Cells(fZeile, 1).value = ""
                .Range(.Cells(fZeile, 2), .Cells(fZeile, anzSpalten)).Value = Xdatenreihe

                If considerIstDaten Then

                    anzRows = 3

                    .Cells(fZeile + 1, 1).value = repMessages.getmsg(194)
                    .Range(.Cells(fZeile + 1, 2), .Cells(fZeile + 1, anzSpalten)).Value = istDatenReihe

                    .Cells(fZeile + 2, 1).value = repMessages.getmsg(38)
                    .Range(.Cells(fZeile + 2, 2), .Cells(fZeile + 2, anzSpalten)).Value = prognoseDatenReihe

                    If Not IsNothing(vglProj) Then

                        anzRows = 4
                        .Cells(fZeile + 3, 1).value = repMessages.getmsg(43)
                        .Range(.Cells(fZeile + 3, 2), .Cells(fZeile + 3, anzSpalten)).Value = vdatenreihe

                    End If

                Else

                    anzRows = 2

                    .Cells(fZeile + 1, 1).value = repMessages.getmsg(38)
                    .Range(.Cells(fZeile + 1, 2), .Cells(fZeile + 1, anzSpalten)).Value = prognoseDatenReihe

                    If Not IsNothing(vglProj) Then
                        anzRows = 3

                        .Cells(fZeile + 2, 1).value = repMessages.getmsg(43)
                        .Range(.Cells(fZeile + 2, 2), .Cells(fZeile + 2, anzSpalten)).Value = vdatenreihe

                    End If

                End If

                myRange = myWS.Range(.Cells(fZeile, 1), .Cells(fZeile + anzRows - 1, anzSpalten))

                ' Ende neu 

            End With

        End With

        ' tk 21.10.18
        ' jetzt wird myRange gesetzt und setSourceData gesetzt 

        '
        ' Test tk 21.10.18
        Dim chkvalues1() As String
        Dim chkvalues2() As String
        Dim chkvalues3() As String
        Dim chkvalues4() As String
        Try

            ReDim chkvalues1(plen)
            For ix As Integer = 0 To plen
                chkvalues1(ix) = CStr(myRange.Cells(1, ix + 1).value)
            Next


            ReDim chkvalues2(plen)
            For ix As Integer = 0 To plen
                chkvalues2(ix) = CStr(myRange.Cells(2, ix + 1).value)
            Next

            If anzRows > 2 Then

                ReDim chkvalues3(plen)
                For ix As Integer = 0 To plen
                    chkvalues3(ix) = CStr(myRange.Cells(3, ix + 1).value)
                Next

                If anzRows > 3 Then

                    ReDim chkvalues4(plen)
                    For ix As Integer = 0 To plen
                        chkvalues4(ix) = CStr(myRange.Cells(4, ix + 1).value)
                    Next
                End If
            End If
        Catch ex As Exception

        End Try
        '
        ' Ende Test tk 21.10.18 
        '

        Dim rangeString As String = "= '" & myWS.Name & "'!" & myRange.Address & ""


        newPPTChart.Chart.SetSourceData(Source:=rangeString)

        '
        ' ---- ab hier Achsen und Überschrift setzen 

        With CType(newPPTChart.Chart, PowerPoint.Chart)
            '
            .HasAxis(PowerPoint.XlAxisType.xlCategory) = True
            .HasAxis(PowerPoint.XlAxisType.xlValue) = True

            .SetElement(core.MsoChartElementType.msoElementPrimaryValueAxisShow)

            Try
                With CType(.Axes(PowerPoint.XlAxisType.xlCategory), PowerPoint.Axis)

                    .HasTitle = False

                    If titleFontSize - 4 >= 6 Then
                        .Format.TextFrame2.TextRange.Font.Size = titleFontSize - 4
                    Else
                        .Format.TextFrame2.TextRange.Font.Size = 6
                    End If


                End With
            Catch ex As Exception

            End Try

            Try
                With CType(.Axes(PowerPoint.XlAxisType.xlValue), PowerPoint.Axis)

                    .HasTitle = False
                    .MinimumScale = 0

                    If titleFontSize - 4 >= 6 Then
                        .Format.TextFrame2.TextRange.Font.Size = titleFontSize - 4
                    Else
                        .Format.TextFrame2.TextRange.Font.Size = 6
                    End If
                End With
            Catch ex As Exception

            End Try

            Try
                .HasLegend = True
                With .Legend
                    .Position = PowerPoint.XlLegendPosition.xlLegendPositionTop

                    If titleFontSize - 4 >= 6 Then
                        .Font.Size = titleFontSize - 4
                    Else
                        .Font.Size = 6
                    End If

                End With
            Catch ex As Exception

            End Try

            .HasTitle = True
            .ChartTitle.Text = " " ' Platzhalter 

        End With

        '
        ' ---- ab hier die SeriesCollection setzen 
        If considerIstDaten Then
            ' die Istdaten ... 
            With CType(CType(CType(newPPTChart.Chart, PowerPoint.Chart).SeriesCollection, PowerPoint.SeriesCollection).Item(1), PowerPoint.Series)
                .Interior.Color = awinSettings.SollIstFarbeArea
                .ChartType = core.XlChartType.xlColumnStacked
            End With

            ' die Prognose-Daten ... 
            With CType(CType(CType(newPPTChart.Chart, PowerPoint.Chart).SeriesCollection, PowerPoint.SeriesCollection).Item(2), PowerPoint.Series)
                .Interior.Color = visboFarbeBlau
                .ChartType = core.XlChartType.xlColumnStacked
            End With

            If Not IsNothing(vglProj) Then
                With CType(CType(CType(newPPTChart.Chart, PowerPoint.Chart).SeriesCollection, PowerPoint.SeriesCollection).Item(3), PowerPoint.Series)
                    .ChartType = core.XlChartType.xlLine
                    With .Format.Line
                        .DashStyle = core.MsoLineDashStyle.msoLineDash
                        .ForeColor.RGB = visboFarbeOrange
                        .Weight = 4
                    End With
                End With
            End If
        Else
            ' nur die Prognose-Daten ... 
            With CType(CType(CType(newPPTChart.Chart, PowerPoint.Chart).SeriesCollection, PowerPoint.SeriesCollection).Item(1), PowerPoint.Series)
                .Interior.Color = visboFarbeBlau
                .ChartType = core.XlChartType.xlColumnStacked
            End With

            If Not IsNothing(vglProj) Then
                With CType(CType(CType(newPPTChart.Chart, PowerPoint.Chart).SeriesCollection, PowerPoint.SeriesCollection).Item(2), PowerPoint.Series)
                    .ChartType = core.XlChartType.xlLine
                    With .Format.Line
                        .DashStyle = core.MsoLineDashStyle.msoLineDash
                        .ForeColor.RGB = visboFarbeOrange
                        .Weight = 4
                    End With
                End With
            End If
        End If

        ' 
        ' ---- hier dann final den Titel setzen 
        With newPPTChart.Chart
            .HasTitle = True
            .ChartTitle.Text = diagramTitle
            .ChartTitle.Font.Size = titleFontSize
            .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1,
                    titelTeilLaengen(1)).Font.Size = titleFontSize - 2
        End With

        newPPTChart.Chart.Refresh()

        '
        ' jetzt werden die Smart-Infos an das Chart angehängt ...
        Dim bigtype As Integer = ptReportBigTypes.charts
        Call addSmartPPTCompInfo(newPPTChart, hproj, Nothing, ptPRPFType.project, qualifier, qualifier2,
                                                               bigtype, DID)


    End Sub



    Public Sub createCostBalkenOfProjectInPPT2(ByVal hproj As clsProjekt, ByVal vglProj As clsProjekt,
                                              ByVal pptAppl As PowerPoint.Application, ByVal presentationName As String, ByVal currentSlideName As String,
                                              ByVal auswahl As Integer, ByVal chartContainer As PowerPoint.Shape,
                                              ByVal DID As Integer, ByVal qualifier As String, ByVal qualifier2 As String)


        Dim titleFontSize As Single = 14
        If chartContainer.HasTextFrame = core.MsoTriState.msoTrue Then
            titleFontSize = chartContainer.TextFrame2.TextRange.Font.Size
        End If



        Dim top As Single = chartContainer.Top
        Dim left As Single = chartContainer.Left
        Dim height As Single = chartContainer.Height
        Dim width As Single = chartContainer.Width

        Dim currentPresentation As PowerPoint.Presentation = pptAppl.Presentations.Item(presentationName)
        Dim currentSlide As PowerPoint.Slide = currentPresentation.Slides.Item(currentSlideName)


        ' jetzt wird das Chart erzeugt ...

        Dim kennung As String = " "
        Dim diagramTitle As String = " "

        Dim plen As Integer

        Dim Xdatenreihe() As String
        Dim tdatenreihe() As Double
        Dim istDatenReihe() As Double
        Dim prognoseDatenReihe() As Double
        Dim vdatenreihe() As Double
        Dim vSum As Double = 0.0
        Dim gesamt_summe As Double
        Dim anzKostenarten As Integer

        Dim pkIndex As Integer = CostDefinitions.Count
        Dim pstart As Integer

        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim tmpcollection As New Collection


        Dim found As Boolean = False


        Dim ErgebnisListeK As Collection


        Dim pname As String = hproj.name

        '
        ' die Kennung für das Chart erstellen ...
        tmpcollection.Add(hproj.name & "#" & auswahl.ToString)

        ' chg: hier muss Kostenarten und Ressourcen unterschieden werden ..
        kennung = calcChartKennung("pr", PTprdk.KostenBalken, tmpcollection)


        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With

        If Not IsNothing(vglProj) Then
            If plen < vglProj.anzahlRasterElemente Then
                plen = vglProj.anzahlRasterElemente
            End If
        End If
        '
        ' hole die Anzahl Kostenarten, die in diesem Projekt vorkommen
        '

        ' chg: hier muss Kostenarten und Ressourcen unterschieden werden ..
        ErgebnisListeK = hproj.getCostNames
        anzKostenarten = ErgebnisListeK.Count


        ReDim Xdatenreihe(plen - 1)
        ReDim tdatenreihe(plen - 1)
        ReDim istDatenReihe(plen - 1)
        ReDim prognoseDatenReihe(plen - 1)
        ReDim vdatenreihe(plen - 1)

        For i As Integer = 1 To plen
            Xdatenreihe(i - 1) = StartofCalendar.AddMonths(pstart + i - 2).ToString("MMM yy", repCult)
        Next i


        Dim ik As Integer = 1 ' wird für die Unterscheidung benötigt, ob mit Personal-Kosten oder ohne 
        gesamt_summe = 0


        ' hier werden die Werte-Arrays für die einzelnen Chart-Elemente / SeriesCollectiuon gesetzt 
        ' chg: hier muss Kostenarten und Ressourcen unterschieden werden ..
        If auswahl = 1 Then
            tdatenreihe = hproj.getGesamtAndereKosten
        Else
            tdatenreihe = hproj.getGesamtKostenBedarf
        End If

        gesamt_summe = tdatenreihe.Sum

        ' die Betrachtung der Ist-Daten versus Prognose Daten ...
        ' jetzt müssen ggf die IstDaten und PrognoseDaten aufgebaut werden

        Call tdatenreihe.CopyTo(prognoseDatenReihe, 0)

        Dim considerIstDaten As Boolean = hproj.actualDataUntil > hproj.startDate
        Dim actualdataIndex As Integer = -1

        If considerIstDaten Then

            Call tdatenreihe.CopyTo(istDatenReihe, 0)

            actualdataIndex = getColumnOfDate(hproj.actualDataUntil) - getColumnOfDate(hproj.startDate)
            ' die Prognose Daten bereinigen
            For ix As Integer = 0 To actualdataIndex
                prognoseDatenReihe(ix) = 0
            Next

            For ix = actualdataIndex + 1 To plen - 1
                istDatenReihe(ix) = 0
            Next

        End If

        If Not IsNothing(vglProj) Then
            If auswahl = 1 Then
                vdatenreihe = vglProj.getGesamtAndereKosten
            Else
                vdatenreihe = vglProj.getGesamtKostenBedarf
            End If
            vSum = vdatenreihe.Sum

        End If


        ' chg: hier muss Kostenarten und Ressourcen unterschieden werden ..
        If auswahl = 1 Then
            ' tk 12.6.17 
            If Not IsNothing(vglProj) Then
                titelTeile(0) = repMessages.getmsg(165) & " (" & gesamt_summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " T€" & ")"
            Else
                titelTeile(0) = repMessages.getmsg(165) & " (" & gesamt_summe.ToString("##,##0.") & " T€" & ")"
            End If

            titelTeilLaengen(0) = titelTeile(0).Length
            Dim maxlenTitle1 As Integer = 20
            titelTeile(1) = ""

            titelTeilLaengen(1) = titelTeile(1).Length
            diagramTitle = titelTeile(0) & titelTeile(1)
            'kennung = "Personalbedarf"
        ElseIf auswahl = 2 Then
            ' tk 12.6.17

            If Not IsNothing(vglProj) Then
                'titelTeile(0) = repMessages.getmsg(166) & " (" & vSum.ToString("####0.") & " / " & gesamt_summe.ToString("####0.") & " T€" & ")"
                titelTeile(0) = repMessages.getmsg(166) & " (" & gesamt_summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " T€" & ")"
            Else
                titelTeile(0) = repMessages.getmsg(166) & " (" & gesamt_summe.ToString("##,##0.") & " T€" & ")"
            End If

            titelTeilLaengen(0) = titelTeile(0).Length
            titelTeile(1) = ""
            titelTeilLaengen(1) = titelTeile(1).Length
            diagramTitle = titelTeile(0) & titelTeile(1)

        Else
            diagramTitle = "--- (T€)" & vbLf & pname
            'kennung = "Gesamtkosten"
        End If

        ' Ende der Werte Bestimmung 

        Dim newPPTChart As PowerPoint.Shape = currentSlide.Shapes.AddChart(Type:=core.XlChartType.xlColumnStacked, Left:=left, Top:=top,
                                                                           Width:=width, Height:=height)

        newPPTChart.Name = kennung

        ' ---- ab hier das Setzen der Values per Setsource Data 
        Dim myRange As Excel.Range = Nothing
        Dim myWB As Excel.Workbook = Nothing
        Dim myWS As Excel.Worksheet = Nothing

        Dim usedRange As Excel.Range = Nothing
        Dim fZeile As Integer = 1
        Dim anzSpalten As Integer = 1
        Dim anzRows As Integer = 0



        ' das ist der entscheidende Befehl ... 
        ' Prüfung am 1.11.18 ergab: das wird bereits mit addChart gemacht 
        'With newPPTChart.Chart.ChartData
        '    .Activate()
        'End With


        ' jetzt kommt das Löschen der alten SeriesCollections . . 
        With newPPTChart.Chart
            Try
                Dim anz As Integer = CInt(CType(.SeriesCollection, PowerPoint.SeriesCollection).Count)
                Do While anz > 0
                    .SeriesCollection(1).Delete()
                    anz = anz - 1
                Loop
            Catch ex As Exception

            End Try
        End With

        With newPPTChart.Chart

            ' jetzt kommt der Neu-Aufbau der Series-Collections
            If considerIstDaten Then

                Call tdatenreihe.CopyTo(istDatenReihe, 0)

                actualdataIndex = getColumnOfDate(hproj.actualDataUntil) - getColumnOfDate(hproj.startDate)
                ' die Prognose Daten bereinigen
                For ix As Integer = 0 To actualdataIndex
                    prognoseDatenReihe(ix) = 0
                Next

                For ix = actualdataIndex + 1 To plen - 1
                    istDatenReihe(ix) = 0
                Next

                ' jetzt die Istdaten zeichnen 
                With CType(CType(.SeriesCollection, PowerPoint.SeriesCollection).NewSeries, PowerPoint.Series)
                    .Name = repMessages.getmsg(194) & " " & hproj.timeStamp.ToShortDateString
                    .Interior.Color = awinSettings.SollIstFarbeArea
                    .Values = istDatenReihe
                    .XValues = Xdatenreihe
                    .ChartType = Microsoft.Office.Core.XlChartType.xlColumnStacked
                End With


            End If


            With CType(CType(.SeriesCollection, PowerPoint.SeriesCollection).NewSeries, PowerPoint.Series)

                .Name = repMessages.getmsg(38) & " " & hproj.timeStamp.ToShortDateString
                .Interior.Color = visboFarbeBlau
                .Values = prognoseDatenReihe
                .XValues = Xdatenreihe
                .ChartType = Microsoft.Office.Core.XlChartType.xlColumnStacked
            End With

            If Not IsNothing(vglProj) Then
                If auswahl = 1 Then
                    vdatenreihe = vglProj.getGesamtAndereKosten
                Else
                    vdatenreihe = vglProj.getGesamtKostenBedarf
                End If
                vSum = vdatenreihe.Sum

                'series
                With CType(CType(.SeriesCollection, PowerPoint.SeriesCollection).NewSeries, PowerPoint.Series)
                    .Name = repMessages.getmsg(43) & " " & vglProj.timeStamp.ToShortDateString
                    .Values = vdatenreihe
                    .XValues = Xdatenreihe
                    .ChartType = Microsoft.Office.Core.XlChartType.xlLine
                    With .Format.Line
                        .DashStyle = Microsoft.Office.Core.MsoLineDashStyle.msoLineDash
                        .ForeColor.RGB = visboFarbeOrange
                        .Weight = 4
                    End With
                End With

            End If

        End With
        ' Ende Neu-Aufbau der Series-Collections


        '' Anfang des Aufbaus für 
        'myWB = CType(newPPTChart.Chart.ChartData.Workbook, Excel.Workbook)
        'myWS = CType(myWB.ActiveSheet, Excel.Worksheet)

        '    usedRange = myWS.UsedRange
        '    fZeile = CType(myWB.ActiveSheet.usedRange, Excel.Range).Rows.Count + 1
        '    anzSpalten = plen + 1
        '    anzRows = 0

        '    With myWS

        '        ' neu 

        '        .Cells(fZeile, 1).value = ""
        '        .Range(.Cells(fZeile, 2), .Cells(fZeile, anzSpalten)).Value = Xdatenreihe

        '        If considerIstDaten Then

        '            anzRows = 3

        '            .Cells(fZeile + 1, 1).value = repMessages.getmsg(194)
        '            .Range(.Cells(fZeile + 1, 2), .Cells(fZeile + 1, anzSpalten)).Value = istDatenReihe

        '            .Cells(fZeile + 2, 1).value = repMessages.getmsg(38)
        '            .Range(.Cells(fZeile + 2, 2), .Cells(fZeile + 2, anzSpalten)).Value = prognoseDatenReihe

        '            If Not IsNothing(vglProj) Then

        '                anzRows = 4
        '                .Cells(fZeile + 3, 1).value = repMessages.getmsg(43)
        '                .Range(.Cells(fZeile + 3, 2), .Cells(fZeile + 3, anzSpalten)).Value = vdatenreihe

        '            End If

        '        Else

        '            anzRows = 2

        '            .Cells(fZeile + 1, 1).value = repMessages.getmsg(38)
        '            .Range(.Cells(fZeile + 1, 2), .Cells(fZeile + 1, anzSpalten)).Value = prognoseDatenReihe

        '            If Not IsNothing(vglProj) Then
        '                anzRows = 3

        '                .Cells(fZeile + 2, 1).value = repMessages.getmsg(43)
        '                .Range(.Cells(fZeile + 2, 2), .Cells(fZeile + 2, anzSpalten)).Value = vdatenreihe

        '            End If

        '        End If

        '        myRange = myWS.Range(.Cells(fZeile, 1), .Cells(fZeile + anzRows - 1, anzSpalten))

        '        ' Ende neu 

        '    End With



        '    ' tk 21.10.18
        '    ' jetzt wird myRange gesetzt und setSourceData gesetzt 

        '    '
        '    ' Test tk 21.10.18
        '    Dim chkvalues1() As String
        'Dim chkvalues2() As String
        'Dim chkvalues3() As String
        'Dim chkvalues4() As String
        'Try

        '    ReDim chkvalues1(plen)
        '    For ix As Integer = 0 To plen
        '        chkvalues1(ix) = CStr(myRange.Cells(1, ix + 1).value)
        '    Next


        '    ReDim chkvalues2(plen)
        '    For ix As Integer = 0 To plen
        '        chkvalues2(ix) = CStr(myRange.Cells(2, ix + 1).value)
        '    Next

        '    If anzRows > 2 Then

        '        ReDim chkvalues3(plen)
        '        For ix As Integer = 0 To plen
        '            chkvalues3(ix) = CStr(myRange.Cells(3, ix + 1).value)
        '        Next

        '        If anzRows > 3 Then

        '            ReDim chkvalues4(plen)
        '            For ix As Integer = 0 To plen
        '                chkvalues4(ix) = CStr(myRange.Cells(4, ix + 1).value)
        '            Next
        '        End If
        '    End If
        'Catch ex As Exception

        'End Try
        ''
        '' Ende Test tk 21.10.18 
        ''

        'Dim rangeString As String = "= '" & myWS.Name & "'!" & myRange.Address & ""


        'newPPTChart.Chart.SetSourceData(Source:=rangeString)

        '
        ' ---- ab hier Achsen und Überschrift setzen 

        With CType(newPPTChart.Chart, PowerPoint.Chart)
            '
            .HasAxis(PowerPoint.XlAxisType.xlCategory) = True
            .HasAxis(PowerPoint.XlAxisType.xlValue) = True

            .SetElement(core.MsoChartElementType.msoElementPrimaryValueAxisShow)

            Try
                With CType(.Axes(PowerPoint.XlAxisType.xlCategory), PowerPoint.Axis)

                    .HasTitle = False

                    If titleFontSize - 4 >= 6 Then
                        .Format.TextFrame2.TextRange.Font.Size = titleFontSize - 4
                    Else
                        .Format.TextFrame2.TextRange.Font.Size = 6
                    End If


                End With
            Catch ex As Exception

            End Try

            Try
                With CType(.Axes(PowerPoint.XlAxisType.xlValue), PowerPoint.Axis)

                    .HasTitle = False
                    .MinimumScale = 0

                    If titleFontSize - 4 >= 6 Then
                        .Format.TextFrame2.TextRange.Font.Size = titleFontSize - 4
                    Else
                        .Format.TextFrame2.TextRange.Font.Size = 6
                    End If
                End With
            Catch ex As Exception

            End Try

            Try
                .HasLegend = True
                With .Legend
                    .Position = PowerPoint.XlLegendPosition.xlLegendPositionTop

                    If titleFontSize - 4 >= 6 Then
                        .Font.Size = titleFontSize - 4
                    Else
                        .Font.Size = 6
                    End If

                End With
            Catch ex As Exception

            End Try

            .HasTitle = True
            .ChartTitle.Text = " " ' Platzhalter 

        End With

        '
        '' ---- ab hier die SeriesCollection setzen 
        'If considerIstDaten Then
        '    ' die Istdaten ... 
        '    With CType(CType(CType(newPPTChart.Chart, PowerPoint.Chart).SeriesCollection, PowerPoint.SeriesCollection).Item(1), PowerPoint.Series)
        '        .Interior.Color = awinSettings.SollIstFarbeArea
        '        .ChartType = core.XlChartType.xlColumnStacked
        '    End With

        '    ' die Prognose-Daten ... 
        '    With CType(CType(CType(newPPTChart.Chart, PowerPoint.Chart).SeriesCollection, PowerPoint.SeriesCollection).Item(2), PowerPoint.Series)
        '        .Interior.Color = visboFarbeBlau
        '        .ChartType = core.XlChartType.xlColumnStacked
        '    End With

        '    If Not IsNothing(vglProj) Then
        '        With CType(CType(CType(newPPTChart.Chart, PowerPoint.Chart).SeriesCollection, PowerPoint.SeriesCollection).Item(3), PowerPoint.Series)
        '            .ChartType = core.XlChartType.xlLine
        '            With .Format.Line
        '                .DashStyle = core.MsoLineDashStyle.msoLineDash
        '                .ForeColor.RGB = visboFarbeOrange
        '                .Weight = 4
        '            End With
        '        End With
        '    End If
        'Else
        '    ' nur die Prognose-Daten ... 
        '    With CType(CType(CType(newPPTChart.Chart, PowerPoint.Chart).SeriesCollection, PowerPoint.SeriesCollection).Item(1), PowerPoint.Series)
        '        .Interior.Color = visboFarbeBlau
        '        .ChartType = core.XlChartType.xlColumnStacked
        '    End With

        '    If Not IsNothing(vglProj) Then
        '        With CType(CType(CType(newPPTChart.Chart, PowerPoint.Chart).SeriesCollection, PowerPoint.SeriesCollection).Item(2), PowerPoint.Series)
        '            .ChartType = core.XlChartType.xlLine
        '            With .Format.Line
        '                .DashStyle = core.MsoLineDashStyle.msoLineDash
        '                .ForeColor.RGB = visboFarbeOrange
        '                .Weight = 4
        '            End With
        '        End With
        '    End If
        'End If

        ' 
        ' ---- hier dann final den Titel setzen 
        With newPPTChart.Chart
            .HasTitle = True
            .ChartTitle.Text = diagramTitle
            .ChartTitle.Font.Size = titleFontSize
            .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1,
                    titelTeilLaengen(1)).Font.Size = titleFontSize - 2
        End With

        newPPTChart.Chart.Refresh()

        '
        ' jetzt werden die Smart-Infos an das Chart angehängt ...
        Dim bigtype As Integer = ptReportBigTypes.charts
        Call addSmartPPTCompInfo(newPPTChart, hproj, Nothing, ptPRPFType.project, qualifier, qualifier2,
                                                               bigtype, DID)


    End Sub

    ''' <summary>
    ''' auswahl = 1: sonstige Kosten werden gezeigt 
    ''' auswahl = 2: Gesamtkosten werden gezeigt 
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="repObj"></param>
    ''' <param name="auswahl"></param>
    ''' <param name="top"></param>
    ''' <param name="left"></param>
    ''' <param name="height"></param>
    ''' <param name="width"></param>
    ''' <remarks></remarks>
    Public Sub createCostBalkenOfProject(ByVal hproj As clsProjekt, ByVal vglProj As clsProjekt,
                                         ByRef repObj As Excel.ChartObject, ByVal auswahl As Integer,
                                         ByVal top As Double, left As Double, height As Double, width As Double,
                                         ByVal calledFromReporting As Boolean,
                                         ByVal comparisontype As Integer)

        Dim kennung As String = " "
        Dim diagramTitle As String = " "
        Dim anzDiagrams As Integer

        Dim plen As Integer
        Dim i As Integer
        Dim Xdatenreihe() As String
        Dim tdatenreihe() As Double
        Dim istDatenReihe() As Double
        Dim prognoseDatenReihe() As Double
        Dim vdatenreihe() As Double
        Dim vSum As Double = 0.0
        Dim gesamt_summe As Double
        Dim anzKostenarten As Integer
        'Dim costname As String
        'Dim chtTitle As String
        Dim pkIndex As Integer = CostDefinitions.Count
        Dim pstart As Integer

        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim tmpcollection As New Collection
        Dim currentSheetName As String
        Dim newChtObj As Excel.ChartObject = Nothing

        Dim found As Boolean = False

        If visboZustaende.projectBoardMode = ptModus.graficboard Then
            If calledFromReporting Then
                currentSheetName = arrWsNames(ptTables.repCharts)
            Else
                currentSheetName = arrWsNames(ptTables.mptPrCharts)
            End If

        Else
            currentSheetName = arrWsNames(ptTables.meCharts)
        End If


        Dim ErgebnisListeK As Collection

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False


        Dim pname As String = hproj.name

        tmpcollection.Add(hproj.name & "#" & auswahl.ToString)
        kennung = calcChartKennung("pr", comparisontype, tmpcollection)



        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With

        If Not IsNothing(vglProj) Then
            If plen < vglProj.anzahlRasterElemente Then
                plen = vglProj.anzahlRasterElemente
            End If
        End If
        '
        ' hole die Anzahl Kostenarten, die in diesem Projekt vorkommen
        '
        ErgebnisListeK = hproj.getCostNames
        anzKostenarten = ErgebnisListeK.Count


        ReDim Xdatenreihe(plen - 1)
        ReDim tdatenreihe(plen - 1)
        ReDim istDatenReihe(plen - 1)
        ReDim prognoseDatenReihe(plen - 1)
        ReDim vdatenreihe(plen - 1)

        For i = 1 To plen
            Xdatenreihe(i - 1) = StartofCalendar.AddMonths(pstart + i - 2).ToString("MMM yy", repCult)
        Next i


        Dim ik As Integer = 1 ' wird für die Unterscheidung benötigt, ob mit Personal-Kosten oder ohne 
        gesamt_summe = 0
        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(currentSheetName), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            While i <= anzDiagrams And Not found

                If .ChartObjects(i).name = kennung Then
                    found = True
                    repObj = CType(.ChartObjects(i), Excel.ChartObject)
                Else
                    i = i + 1
                End If

            End While

            If found Then
                'Call MsgBox("Chart wird bereits angezeigt ...")
                appInstance.EnableEvents = formerEE
                repObj = CType(.ChartObjects(i), Excel.ChartObject)
                'appInstance.ScreenUpdating = formerSU
                Exit Sub
            Else
                newChtObj = CType(.ChartObjects, Excel.ChartObjects).Add(left, top, width, height)

                With CType(newChtObj.Chart, Excel.Chart)
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try

                    .HasAxis(Excel.XlAxisType.xlCategory) = True
                    .HasAxis(Excel.XlAxisType.xlValue) = True

                    With .Axes(Excel.XlAxisType.xlCategory)
                        .HasTitle = False
                        '.MinimumScale = 0
                        'With .AxisTitle
                        '    .Characters.text = "Monate"
                        '    .Font.Size = 8
                        'End With
                    End With

                    With .Axes(Excel.XlAxisType.xlValue)
                        .HasTitle = False
                        '.MaximumScale = maxscale
                        .MinimumScale = 0

                        'With .AxisTitle
                        '    .Characters.text = "Kosten"
                        '    .Font.Size = 8
                        'End With
                    End With

                    .HasLegend = True
                    With .Legend
                        .Position = Excel.XlLegendPosition.xlLegendPositionTop
                        .Font.Size = awinSettings.fontsizeLegend
                    End With
                    .HasTitle = True
                    .ChartTitle.Text = " " ' Platzhalter 


                End With

                newChtObj.Name = kennung



            End If

            With newChtObj.Chart



                If auswahl = 1 Then
                    tdatenreihe = hproj.getGesamtAndereKosten
                Else
                    tdatenreihe = hproj.getGesamtKostenBedarf
                End If

                gesamt_summe = tdatenreihe.Sum

                ' die Betrachtung der Ist-Daten versus Prognose Daten ...
                ' jetzt müssen ggf die IstDaten und PrognoseDaten aufgebaut werden

                Call tdatenreihe.CopyTo(prognoseDatenReihe, 0)

                Dim considerIstDaten As Boolean = hproj.actualDataUntil > hproj.startDate
                Dim actualdataIndex As Integer = -1

                If considerIstDaten Then

                    Call tdatenreihe.CopyTo(istDatenReihe, 0)

                    actualdataIndex = getColumnOfDate(hproj.actualDataUntil) - getColumnOfDate(hproj.startDate)
                    ' die Prognose Daten bereinigen
                    For ix As Integer = 0 To actualdataIndex
                        prognoseDatenReihe(ix) = 0
                    Next

                    For ix = actualdataIndex + 1 To plen - 1
                        istDatenReihe(ix) = 0
                    Next

                    ' jetzt die Istdaten zeichnen 
                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)

                        '.Name = repMessages.getmsg(194) & " " & hproj.timeStamp.ToShortDateString
                        .Name = repMessages.getmsg(194)

                        .Interior.Color = awinSettings.SollIstFarbeArea
                        .Values = istDatenReihe
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlColumnStacked
                    End With


                End If

                With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)

                    ' sonstige Kosten
                    '.Name = repMessages.getmsg(273) & " " & hproj.timeStamp.ToShortDateString
                    '.Name = repMessages.getmsg(38) & " " & hproj.timeStamp.ToShortDateString
                    .Name = repMessages.getmsg(38)
                    '.Interior.Color = CostDefinitions.getCostdef(pkIndex).farbe

                    .Interior.Color = visboFarbeBlau
                    .Values = prognoseDatenReihe
                    .XValues = Xdatenreihe
                    .ChartType = Excel.XlChartType.xlColumnStacked
                End With

                If Not IsNothing(vglProj) Then
                    If auswahl = 1 Then
                        vdatenreihe = vglProj.getGesamtAndereKosten
                    Else
                        vdatenreihe = vglProj.getGesamtKostenBedarf
                    End If
                    vSum = vdatenreihe.Sum

                    'series
                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)

                        .Name = repMessages.getmsg(43) & " " & vglProj.timeStamp.ToShortDateString

                        .Values = vdatenreihe
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlLine
                        With .Format.Line
                            .DashStyle = core.MsoLineDashStyle.msoLineDash
                            .ForeColor.RGB = visboFarbeOrange
                            .Weight = 4
                        End With
                    End With
                End If


            End With


            If auswahl = 1 Then
                ' tk 12.6.17 
                If Not IsNothing(vglProj) Then
                    titelTeile(0) = repMessages.getmsg(165) & " (" & gesamt_summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " T€" & ")"
                Else
                    titelTeile(0) = repMessages.getmsg(165) & " (" & gesamt_summe.ToString("##,##0.") & " T€" & ")"
                End If

                titelTeilLaengen(0) = titelTeile(0).Length
                Dim maxlenTitle1 As Integer = 20
                titelTeile(1) = ""
                titelTeilLaengen(1) = titelTeile(1).Length
                diagramTitle = titelTeile(0) & titelTeile(1)
            ElseIf auswahl = 2 Then
                ' tk 12.6.17

                If Not IsNothing(vglProj) Then
                    titelTeile(0) = repMessages.getmsg(166) & " (" & gesamt_summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " T€" & ")"
                Else
                    titelTeile(0) = repMessages.getmsg(166) & " (" & gesamt_summe.ToString("##,##0.") & " T€" & ")"
                End If

                titelTeilLaengen(0) = titelTeile(0).Length
                titelTeile(1) = ""
                titelTeilLaengen(1) = titelTeile(1).Length
                diagramTitle = titelTeile(0) & titelTeile(1)

            Else
                diagramTitle = "--- (T€)" & vbLf & pname

            End If


            With newChtObj.Chart
                .ChartTitle.Text = diagramTitle
                .ChartTitle.Font.Size = awinSettings.fontsizeTitle
                .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1,
                    titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend
            End With

        End With

        appInstance.EnableEvents = formerEE

        repObj = newChtObj

    End Sub

    ''' <summary>
    ''' aktualisiert das Auslastungs Chart mit den Über- bzw Unterauslastungs-Details
    ''' </summary>
    ''' <param name="chtobj">Verweis auf Excel Chart Objekt</param>
    ''' <param name="auswahl">
    '''         = 1 : Überauslastung
    '''         = 2 : Unterauslastung
    ''' </param>
    ''' <remarks></remarks>
    Public Sub updateAuslastungsDetailPie(ByVal chtobj As Excel.ChartObject, ByVal auswahl As Integer)

        Dim diagramTitle As String

        Dim Xdatenreihe() As String
        Dim tdatenreihe() As Double

        Dim anzRollen As Integer
        Dim roleName As String

        Dim fontSize1 As Double = awinSettings.fontsizeTitle, fontSize2 As Double = awinSettings.fontsizeLegend

        Dim zE As String = awinSettings.kapaEinheit
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer


        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False

        ' Farben vorbesetzen 
        Dim colors() As Integer
        ReDim colors(5)
        If auswahl = 1 Then
            colors(0) = RGB(99, 37, 35)
            colors(1) = RGB(150, 54, 52)
            colors(2) = RGB(192, 80, 77)
            colors(3) = RGB(218, 150, 148)
            colors(4) = RGB(230, 184, 183)
            colors(5) = RGB(242, 220, 219)
        Else
            colors(0) = RGB(79, 98, 40)
            colors(1) = RGB(118, 147, 16)
            colors(2) = RGB(155, 187, 89)
            colors(3) = RGB(196, 215, 155)
            colors(4) = RGB(216, 228, 188)
            colors(5) = RGB(245, 231, 222)
        End If

        ' es müssen jetzt alle Rollen in eine Collection geholt werden, die keine SammelRolle sind ... 
        'Dim basicRolesCollection As Collection = RoleDefinitions.getBasicRoles

        '
        ' hole die Anzahl Rollen

        'anzRollen = basicRolesCollection.Count
        anzRollen = RoleDefinitions.Count

        If anzRollen = 0 Then
            'Call MsgBox("keine Rollen-Bedarfe definiert")
            Call MsgBox(repMessages.getmsg(96))
            Exit Sub
        End If

        
        Dim sortierteListe As New SortedList(Of Double, String)
        For r = 1 To anzRollen
            roleName = RoleDefinitions.getRoledef(r).name
            'roleName = CStr(basicRolesCollection.Item(r))
            Dim valueUeber As Double = ShowProjekte.getAuslastungsValues(roleName, 1).Sum
            If valueUeber > 0 Then
                Dim valueUnter As Double = ShowProjekte.getAuslastungsValues(roleName, 2).Sum
                Dim sortCriteria As Double = valueUeber - valueUnter
                If sortCriteria > 0 Then
                    While sortierteListe.ContainsKey(sortCriteria)
                        sortCriteria = sortCriteria + 0.0000001
                    End While
                    ' jetzt enthält sortierte Liste nicht mehr den Schlüssel ..
                    sortierteListe.Add(sortCriteria, roleName)
                End If
            End If
        Next r


        ' in der tdaten-Reihe sollen die 5 Rollen stehen, die am meisten über-/unterausgelastet sind
        ' dann als Summe alle anderen ..

        Dim anzItems As Integer = sortierteListe.Count
        Dim anzPieSegments As Integer = awinSettings.anzTopBottlenecks + 1
        If anzItems < anzPieSegments And anzItems > 0 Then
            anzPieSegments = anzItems
        ElseIf anzItems = 0 Then
            anzPieSegments = 1
        End If
        ReDim tdatenreihe(anzPieSegments - 1)
        ReDim Xdatenreihe(anzPieSegments - 1)


        ' jetzt muss die tmpDaten und Xdatenreihen aufgebaut werden  

        For r = 1 To anzItems
            If r <= anzPieSegments - 1 Then
                tdatenreihe(r - 1) = CInt(sortierteListe.ElementAt(anzItems - r).Key)
                Xdatenreihe(r - 1) = sortierteListe.ElementAt(anzItems - r).Value
            Else
                If anzItems = anzPieSegments Then
                    tdatenreihe(r - 1) = CInt(sortierteListe.ElementAt(anzItems - r).Key)
                    Xdatenreihe(r - 1) = sortierteListe.ElementAt(anzItems - r).Value
                Else
                    tdatenreihe(anzPieSegments - 1) = tdatenreihe(anzPieSegments - 1) + CInt(sortierteListe.ElementAt(anzItems - r).Key)
                    Xdatenreihe(anzPieSegments - 1) = "others (" & anzItems - (anzPieSegments - 1) & ")"
                End If

            End If
        Next


        If auswahl = 1 Then
            titelTeile(0) = portfolioDiagrammtitel(PTpfdk.UeberAuslastung) & " (" & awinSettings.kapaEinheit & ")"
        Else
            titelTeile(0) = portfolioDiagrammtitel(PTpfdk.Unterauslastung) & " (" & awinSettings.kapaEinheit & ")"
        End If


        titelTeilLaengen(0) = titelTeile(0).Length + 1
        titelTeile(1) = textZeitraum(showRangeLeft, showRangeRight)
        titelTeilLaengen(1) = titelTeile(1).Length
        diagramTitle = titelTeile(0) & vbLf & titelTeile(1)



        'With appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT))


        Dim tmpValues(1) As Double



        With CType(chtobj.Chart, Excel.Chart)

            ' bestimmen der Fontsize Größen 
            Try
                If .HasTitle Then
                    Dim len As Integer = .ChartTitle.Text.Length
                    fontSize1 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=1, Length:=1).Font.Size
                    fontSize2 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=len - 1, Length:=1).Font.Size
                End If
            Catch ex As Exception

            End Try

            ' remove extra series
            ''Try
            ''    Do Until .SeriesCollection.Count = 0
            ''        .SeriesCollection(1).Delete()
            ''    Loop
            ''Catch ex As Exception

            ''End Try

            ' -----------------------
            ' Schreibe Über- bzw Unterauslastung 

            With CType(CType(.SeriesCollection, Excel.SeriesCollection).Item(1), Excel.Series)
                .Name = "Details"

                .Values = tdatenreihe
                .XValues = Xdatenreihe

                .ChartType = Excel.XlChartType.xlPie
                .HasDataLabels = True

                With .DataLabels
                    .Position = Excel.XlDataLabelPosition.xlLabelPositionOutsideEnd
                    ' ur: 17.7.2014 fontsize kommt vom existierenden chart
                    '.Font.Size = awinSettings.fontsizeItems + 2
                End With

            End With


            For r = 1 To anzPieSegments

                roleName = Xdatenreihe(r - 1)
                With CType(CType(.SeriesCollection, Excel.SeriesCollection).Item(1), Excel.Series).Points(r)
                    '.Interior.color = RoleDefinitions.getRoledef(roleName).farbe
                    .Interior.Color = colors(r - 1)
                    ' ur: 17.7.2014 fontsize kommt vom existierenden chart
                    '.DataLabel.Font.Size = awinSettings.fontsizeItems
                End With

            Next r

            If anzItems > 0 Then
                .HasLegend = True
                With .Legend
                    .Position = Excel.XlLegendPosition.xlLegendPositionRight
                    .Font.Size = awinSettings.fontsizeItems + 2
                End With
            Else
                .HasLegend = False
            End If

            If .HasTitle Then
                .ChartTitle.Text = diagramTitle
                ' Änderung tk: wieder mit reingenmmen, da ja jetzt zu Beginn die fontsize1, ..2 bestimmt werden 
                .ChartTitle.Font.Size = CSng(fontSize1)
                .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                    titelTeilLaengen(1)).Font.Size = CSng(fontSize2)
            End If

        End With

        ' in diesem Fall muss das Chart in der Diagram-Liste aktualisiert werden ...


        Dim prcDiagram As clsDiagramm = Nothing

        If DiagramList.contains(chtobj.Name) Then
            prcDiagram = DiagramList.getDiagramm(chtobj.Name)
        End If

        If Not IsNothing(prcDiagram) Then

        End If

        With prcDiagram

            If anzPieSegments >= 1 Then
                .gsCollection = New Collection
                Dim tmpAnz As Integer = sortierteListe.Count
                For i = 1 To anzPieSegments
                    Try
                        .gsCollection.Add(sortierteListe.ElementAt(tmpAnz - i).Value)
                    Catch ex As Exception

                    End Try

                Next
            Else
                .gsCollection = Nothing
            End If


        End With



        'End With

    End Sub


    ''' <summary>
    ''' Prozedur aktualisiert das Kosten Struktur Chart des Projektes  (Balken-Diagramm)
    ''' </summary>
    ''' <param name="hproj">Verweis auf Projekt</param>
    ''' <param name="chtobj">Verweis auf ChartObject</param>
    ''' <param name="auswahl">
    ''' Auswahl = 1 : Diagramm zeigt nur sonstige Kosten 
    ''' Auswahl = 2 : Diagramm zeigt alle Kosten, inkl Personalkosten 
    ''' </param>
    ''' <remarks>
    ''' kennziffer fest auf 3 gesetzt 
    ''' kennziffer = 0 : Phasen Diagramm
    '''            = 1 : Personal-Bedarfe (Balken)
    '''            = 2 : Personal-Bedarfe (PIE)
    '''            = 3 : Kosten (Balken)
    '''            = 4 : Kosten (Pie)
    '''            = 5 : Strategie / Risiko 
    '''            = 6 : Ergebnis
    ''' </remarks>
    Public Sub updateCostBalkenOfProject(ByVal hproj As clsProjekt, ByVal vglProj As clsProjekt, _
                                         ByRef chtobj As Excel.ChartObject, _
                                         ByVal auswahl As Integer, ByVal changeScale As Boolean)


        Dim kennziffer As Integer = 3
        Dim plen As Integer
        Dim i As Integer
        Dim Xdatenreihe() As String
        Dim tdatenreihe() As Double
        Dim istDatenReihe() As Double
        Dim prognoseDatenReihe() As Double
        Dim vdatenreihe() As Double
        Dim vSum As Double = 0.0
        Dim gesamt_summe As Double = 0.0
        Dim anzKostenarten As Integer

        Dim pkIndex As Integer = CostDefinitions.Count
        Dim pstart As Integer
        Dim diagramTitle As String
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim tmpcollection As New Collection
        Dim kennung As String = " "
        Dim maxlenTitle1 As Integer = 20

        Dim fontSize1 As Double = awinSettings.fontsizeTitle, fontSize2 As Double = awinSettings.fontsizeLegend



        Dim pname As String = hproj.name

        tmpcollection.Add(hproj.name & "#" & auswahl.ToString)



        Dim ErgebnisListeK As Collection

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False

        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With

        If Not IsNothing(vglProj) Then
            If plen < vglProj.anzahlRasterElemente Then
                plen = vglProj.anzahlRasterElemente
            End If
        End If
        '
        ' hole die Anzahl Kostenarten, die in diesem Projekt vorkommen
        '
        ErgebnisListeK = hproj.getCostNames
        anzKostenarten = ErgebnisListeK.Count


        ReDim Xdatenreihe(plen - 1)
        ReDim tdatenreihe(plen - 1)
        ReDim istDatenReihe(plen - 1)
        ReDim prognoseDatenReihe(plen - 1)
        ReDim vdatenreihe(plen - 1)


        For i = 1 To plen
            Xdatenreihe(i - 1) = StartofCalendar.AddMonths(pstart + i - 2).ToString("MMM yy", repCult)
        Next i


        Dim ik As Integer = 1 ' wird für die Unterscheidung benötigt, ob mit Personal-Kosten oder ohne 


        With CType(chtobj.Chart, Excel.Chart)

            ' bestimmen der Fontsize Größen 
            Try
                If .HasTitle Then
                    Dim len As Integer = .ChartTitle.Text.Length
                    fontSize1 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=1, Length:=1).Font.Size
                    fontSize2 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=len - 1, Length:=1).Font.Size
                End If
            Catch ex As Exception

            End Try


            ' remove old series
            Try
                Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                Do While anz > 0
                    .SeriesCollection(1).Delete()
                    anz = anz - 1
                Loop
            Catch ex As Exception

            End Try


            If auswahl = 1 Then
                tdatenreihe = hproj.getGesamtAndereKosten
            Else
                tdatenreihe = hproj.getGesamtKostenBedarf
            End If


            gesamt_summe = tdatenreihe.Sum

            ' die Betrachtung der Ist-Daten versus Prognose Daten ...
            ' jetzt müssen ggf die IstDaten und PrognoseDaten aufgebaut werden

            Call tdatenreihe.CopyTo(prognoseDatenReihe, 0)

            Dim considerIstDaten As Boolean = hproj.actualDataUntil > hproj.startDate
            Dim actualdataIndex As Integer = -1

            If considerIstDaten Then

                Call tdatenreihe.CopyTo(istDatenReihe, 0)

                actualdataIndex = getColumnOfDate(hproj.actualDataUntil) - getColumnOfDate(hproj.startDate)
                ' die Prognose Daten bereinigen
                For ix As Integer = 0 To actualdataIndex
                    prognoseDatenReihe(ix) = 0
                Next

                For ix = actualdataIndex + 1 To plen - 1
                    istDatenReihe(ix) = 0
                Next

                ' jetzt die Istdaten zeichnen 
                With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                    '.Name = repMessages.getmsg(194) & " " & hproj.timeStamp.ToShortDateString
                    .Name = repMessages.getmsg(194)
                    '.Interior.Color = visboFarbeBlau
                    .Interior.Color = awinSettings.SollIstFarbeArea
                    .Values = istDatenReihe
                    .XValues = Xdatenreihe
                    .ChartType = Excel.XlChartType.xlColumnStacked
                End With


            End If


            With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                ' Stand vom sonstige Kosten
                '.Name = repMessages.getmsg(273) & " " & hproj.timeStamp.ToShortDateString
                '.Name = repMessages.getmsg(38) & " " & hproj.timeStamp.ToShortDateString
                .Name = repMessages.getmsg(38)
                '.Interior.Color = CostDefinitions.getCostdef(pkIndex).farbe
                .Interior.Color = visboFarbeBlau
                '.Interior.Color = visboFarbeYellow
                '.Values = tdatenreihe
                '.Values = tdatenreihe
                .Values = prognoseDatenReihe
                .XValues = Xdatenreihe
                .ChartType = Excel.XlChartType.xlColumnStacked
            End With

            If Not IsNothing(vglProj) Then
                If auswahl = 1 Then
                    vdatenreihe = vglProj.getGesamtAndereKosten
                Else
                    vdatenreihe = vglProj.getGesamtKostenBedarf
                End If
                vSum = vdatenreihe.Sum

                'series
                With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                    .Name = repMessages.getmsg(43) & " " & vglProj.timeStamp.ToShortDateString
                    '.Interior.Color = 0
                    .Values = vdatenreihe
                    .XValues = Xdatenreihe
                    .ChartType = Excel.XlChartType.xlLine
                    With .Format.Line
                        .DashStyle = core.MsoLineDashStyle.msoLineDash
                        '.ForeColor.RGB = Excel.XlRgbColor.rgbFireBrick
                        .ForeColor.RGB = visboFarbeOrange
                        .Weight = 4
                    End With
                End With
            End If


            If CBool(.HasAxis(Excel.XlAxisType.xlValue)) Then

                With CType(.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                    ' das ist dann relevant, wenn ein anderes Projekt selektiert wird, das über die aktuelle Skalierung 
                    ' hinausgehende Werte hat 

                    If changeScale Then
                        .MinimumScale = 0
                        .MaximumScaleIsAuto = True

                        ' Skalierung soll sich nur ändern, wenn sie größer werden muss
                        ' ansonsten ist es besser, man erkennt die Verhältnismäßigkeit 
                        'If Not (.MaximumScaleIsAuto) Then

                        Dim tstValue As Double = .MaximumScale

                        If System.Math.Max(tdatenreihe.Max, vdatenreihe.Max) > .MaximumScale - 3 Then
                            .MaximumScale = System.Math.Max(tdatenreihe.Max, vdatenreihe.Max) + 3
                        End If
                    End If


                End With

            End If

            If auswahl = 1 Then
                ' tk 12.6.17 
                'titelTeile(0) = repMessages.getmsg(159) & " (" & gesamt_summe.ToString("####0.") & " " & zE & ")" & vbLf & hproj.getShapeText & vbLf

                If Not IsNothing(vglProj) Then
                    'titelTeile(0) = repMessages.getmsg(165) & " (" & vSum.ToString("####0.") & " / " & gesamt_summe.ToString("####0.") & " T€" & ")"
                    titelTeile(0) = repMessages.getmsg(165) & " (" & gesamt_summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " T€" & ")"
                Else
                    titelTeile(0) = repMessages.getmsg(165) & " (" & gesamt_summe.ToString("##,##0.") & " T€" & ")"
                End If


                titelTeilLaengen(0) = titelTeile(0).Length
                titelTeile(1) = ""
                titelTeilLaengen(1) = titelTeile(1).Length
                diagramTitle = titelTeile(0) & titelTeile(1)
                'kennung = "Personalbedarf"
            ElseIf auswahl = 2 Then
                ' tk 12.6.17
                If Not IsNothing(vglProj) Then
                    'titelTeile(0) = repMessages.getmsg(166) & " (" & vSum.ToString("####0.") & " / " & gesamt_summe.ToString("####0.") & " T€" & ")"
                    titelTeile(0) = repMessages.getmsg(166) & " (" & gesamt_summe.ToString("##,##0.") & " / " & vSum.ToString("##,##0.") & " T€" & ")"
                Else
                    titelTeile(0) = repMessages.getmsg(166) & " (" & gesamt_summe.ToString("##,##0.") & " T€" & ")"
                End If

                titelTeilLaengen(0) = titelTeile(0).Length

                titelTeile(1) = ""
                titelTeilLaengen(1) = titelTeile(1).Length
                diagramTitle = titelTeile(0) & titelTeile(1)

            Else
                diagramTitle = "--- (T€)" & vbLf & pname
                'kennung = "Gesamtkosten"
            End If


            If .HasTitle Then
                .ChartTitle.Text = diagramTitle
                ' Änderung tk: wieder mit reingenmmen, da ja jetzt zu Beginn die fontsize1, ..2 bestimmt werden 
                .ChartTitle.Font.Size = CSng(fontSize1)
                .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                    titelTeilLaengen(1)).Font.Size = CSng(fontSize2)
            End If

        End With


        appInstance.EnableEvents = formerEE
        'appInstance.ScreenUpdating = formerSU


    End Sub


    ''' <summary>
    ''' zeigt die Zusammensetzung der Top3 Überauslastungen bzw Unterauslastungen an 
    ''' wenn keine Sammelrolle angegeben ist, werden alle Rollen untersucht; anonsten nur die Sammelrolle plus Kinden
    ''' 
    ''' </summary>
    ''' <param name="repObj">Verweis auf das erzeugte Chart</param>
    ''' <param name="auswahl">
    ''' 1 = Überauslastung
    ''' 2 = Unterauslastung
    ''' </param>
    ''' <param name="top">Diagramm Koordinate oben</param>
    ''' <param name="left">Diagramm Koordinate links</param>
    ''' <param name="height">Diagramm-Höhe</param>
    ''' <param name="width">Diagramm-Breite</param>
    ''' <remarks></remarks>
    Public Sub createAuslastungsDetailPie(ByRef repObj As Excel.ChartObject, ByVal auswahl As Integer,
                                                ByVal top As Double, left As Double, height As Double, width As Double,
                                                ByVal calledfromReporting As Boolean, Optional ByVal roleCollection As Collection = Nothing)


        Dim diagramTitle As String
        Dim anzDiagrams As Integer
        Dim chtobjname As String
        Dim newChtObj As Excel.ChartObject = Nothing

        Dim farbThemaRot As System.Drawing.Color = System.Drawing.Color.Aqua



        Dim Xdatenreihe() As String
        Dim tdatenreihe() As Double

        ' Farben vorbesetzen 
        Dim colors() As Integer
        ReDim colors(5)
        If auswahl = 1 Then
            colors(0) = RGB(99, 37, 35)
            colors(1) = RGB(150, 54, 52)
            colors(2) = RGB(192, 80, 77)
            colors(3) = RGB(218, 150, 148)
            colors(4) = RGB(230, 184, 183)
            colors(5) = RGB(242, 220, 219)
        Else
            colors(0) = RGB(79, 98, 40)
            colors(1) = RGB(118, 147, 16)
            colors(2) = RGB(155, 187, 89)
            colors(3) = RGB(196, 215, 155)
            colors(4) = RGB(216, 228, 188)
            colors(5) = RGB(245, 231, 222)
        End If



        'Dim anzRollen As Integer
        Dim roleName As String
        'Dim roleIDs As New SortedList(Of Integer, Double)

        Dim kennung As String
        Dim zE As String = awinSettings.kapaEinheit
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer

        Dim myCollection As New Collection
        myCollection.Add("Auslastungs-Details")

        Dim currentSheetName As String

        Dim found As Boolean = False

        If visboZustaende.projectBoardMode = ptModus.graficboard Then
            If calledfromReporting Then
                currentSheetName = arrWsNames(ptTables.repCharts)
            Else
                currentSheetName = arrWsNames(ptTables.mptPfCharts)
            End If

        Else
            currentSheetName = arrWsNames(ptTables.meCharts)
        End If

        If auswahl = 1 Then
            chtobjname = calcChartKennung("pf", PTpfdk.UeberAuslastung, myCollection)
        Else
            chtobjname = calcChartKennung("pf", PTpfdk.Unterauslastung, myCollection)
        End If
        myCollection.Clear()

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False

        ' es müssen jetzt alle Rollen in eine Collection geholt werden, die keine SammelRolle sind ... 
        'Dim basicRolesCollection As Collection = RoleDefinitions.getBasicRoles


        '
        ' hole die Anzahl Rollen


        ' das sollte jetzt als Methode bereitgestellt werden ... 
        ' tk - ersetzt das unten stehende ... ist jetzt neu 
        Dim sortierteListe As SortedList(Of Double, String)

        Try
            sortierteListe = getSortedListOfCapaUtilization(roleCollection, auswahl)
        Catch ex As Exception
            Call MsgBox(ex.Message)
            Exit Sub
        End Try

        ' alt - wurde durch getSortedListOfCapaUtilization, siehe oben , ersetzt 

        ''If IsNothing(roleCollection) Then
        ''    roleIDs = RoleDefinitions.getAllIDs
        ''Else

        ''    For Each tmpRoleName As String In roleCollection
        ''        Dim tmpRoleIds As SortedList(Of Integer, Double) = RoleDefinitions.getSubRoleIDsOf(tmpRoleName, type:=PTcbr.all)

        ''        For Each srKvP As KeyValuePair(Of Integer, Double) In tmpRoleIds
        ''            If Not roleIDs.ContainsKey(srKvP.Key) Then
        ''                roleIDs.Add(srKvP.Key, srKvP.Value)
        ''            End If
        ''        Next

        ''    Next

        ''End If

        ''anzRollen = roleIDs.Count
        ''If anzRollen = 0 Then
        ''    'Call MsgBox("keine Rollen-Bedarfe definiert")
        ''    Call MsgBox(repMessages.getmsg(96))
        ''    Exit Sub
        ''End If



        ''For r = 1 To anzRollen
        ''    roleName = RoleDefinitions.getRoleDefByID(roleIDs.ElementAt(r - 1).Key).name
        ''    'roleName = CStr(basicRolesCollection.Item(r))
        ''    Dim valueUeber As Double
        ''    Dim valueUnter As Double
        ''    Dim sortCriteria As Double

        ''    If auswahl = 1 Then ' Überauslastung
        ''        valueUeber = ShowProjekte.getAuslastungsValues(roleName, 1).Sum
        ''        If valueUeber > 0 Then

        ''            valueUnter = ShowProjekte.getAuslastungsValues(roleName, 2).Sum
        ''            sortCriteria = valueUeber - valueUnter
        ''            If sortCriteria > 0 Then
        ''                While sortierteListe.ContainsKey(sortCriteria)
        ''                    sortCriteria = sortCriteria + 0.0000001
        ''                End While
        ''                ' jetzt enthält sortierte Liste nicht mehr den Schlüssel ..
        ''                sortierteListe.Add(sortCriteria, roleName)
        ''            End If

        ''        End If
        ''    Else ' Unterauslastung 
        ''        valueUnter = ShowProjekte.getAuslastungsValues(roleName, 2).Sum

        ''        If valueUnter > 0 Then

        ''            valueUeber = ShowProjekte.getAuslastungsValues(roleName, 1).Sum
        ''            sortCriteria = valueUnter - valueUeber
        ''            If sortCriteria > 0 Then
        ''                While sortierteListe.ContainsKey(sortCriteria)
        ''                    sortCriteria = sortCriteria + 0.0000001
        ''                End While
        ''                ' jetzt enthält sortierte Liste nicht mehr den Schlüssel ..
        ''                sortierteListe.Add(sortCriteria, roleName)
        ''            End If

        ''        End If
        ''    End If

        ''Next r

        '' in der tdaten-Reihe sollen die 5 Rollen stehen, die am meisten über-/unterausgelastet sind
        '' dann als Summe alle anderen ..


        Dim anzItems As Integer = sortierteListe.Count
        Dim anzPieSegments As Integer = awinSettings.anzTopBottlenecks + 1
        If anzItems < anzPieSegments And anzItems > 0 Then
            anzPieSegments = anzItems
        ElseIf anzItems = 0 Then
            anzPieSegments = 1
        End If
        ReDim tdatenreihe(anzPieSegments - 1)
        ReDim Xdatenreihe(anzPieSegments - 1)


        ' jetzt muss die tmpDaten und Xdatenreihen aufgebaut werden  

        For r = 1 To anzItems
            If (anzItems > anzPieSegments And r <= anzPieSegments - 1) Then
                tdatenreihe(r - 1) = CInt(sortierteListe.ElementAt(anzItems - r).Key)
                Xdatenreihe(r - 1) = sortierteListe.ElementAt(anzItems - r).Value
            Else
                If anzItems = anzPieSegments Then
                    tdatenreihe(r - 1) = CInt(sortierteListe.ElementAt(anzItems - r).Key)
                    Xdatenreihe(r - 1) = sortierteListe.ElementAt(anzItems - r).Value
                Else
                    tdatenreihe(anzPieSegments - 1) = tdatenreihe(anzPieSegments - 1) + CInt(sortierteListe.ElementAt(anzItems - r).Key)
                    Xdatenreihe(anzPieSegments - 1) = "others (" & anzItems - (anzPieSegments - 1) & ")"
                End If

            End If
        Next


        If auswahl = 1 Then
            titelTeile(0) = portfolioDiagrammtitel(PTpfdk.UeberAuslastung) & " (" & awinSettings.kapaEinheit & ")"
        Else
            titelTeile(0) = portfolioDiagrammtitel(PTpfdk.Unterauslastung) & " (" & awinSettings.kapaEinheit & ")"
        End If

        titelTeilLaengen(0) = titelTeile(0).Length + 1
        titelTeile(1) = textZeitraum(showRangeLeft, showRangeRight)
        titelTeilLaengen(1) = titelTeile(1).Length
        diagramTitle = titelTeile(0) & vbLf & titelTeile(1)
        kennung = titelTeile(0)



        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(currentSheetName), Excel.Worksheet)

            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            Dim i As Integer = 1

            While i <= anzDiagrams And Not found

                If .ChartObjects(i).name = chtobjname Then
                    found = True
                Else
                    i = i + 1
                End If

            End While

            If found Then
                'Call MsgBox("Chart wird bereits angezeigt ...")
                appInstance.EnableEvents = formerEE
                repObj = CType(.ChartObjects(i), Excel.ChartObject)
                'appInstance.ScreenUpdating = formerSU
                Exit Sub
            Else
                Dim tmpValues(1) As Double

                newChtObj = CType(.ChartObjects, Excel.ChartObjects).Add(left, top, width, height)

                With newChtObj.Chart
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try


                    ' -----------------------
                    ' Schreibe Über- bzw Unterauslastung 

                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                        .Name = "Details"

                        .Values = tdatenreihe
                        .XValues = Xdatenreihe

                        .ChartType = Excel.XlChartType.xlPie
                        .HasDataLabels = True

                        With .DataLabels
                            .Position = Excel.XlDataLabelPosition.xlLabelPositionOutsideEnd
                            .Font.Size = awinSettings.fontsizeItems + 2
                        End With

                    End With


                    For r = 1 To anzPieSegments

                        'roleName = RoleDefinitions.getRoledef(r).name
                        roleName = Xdatenreihe(r - 1)
                        With CType(CType(.SeriesCollection, Excel.SeriesCollection).Item(1), Excel.Series).Points(r)
                            '.Interior.color = RoleDefinitions.getRoledef(roleName).farbe
                            .Interior.Color = colors(r - 1)
                            .DataLabel.Font.Size = awinSettings.fontsizeItems
                        End With

                    Next r

                    If anzItems > 0 Then
                        .HasLegend = True
                        With .Legend
                            .Position = Excel.XlLegendPosition.xlLegendPositionRight
                            .Font.Size = awinSettings.fontsizeItems + 2
                        End With
                    Else
                        .HasLegend = False
                    End If


                    .HasTitle = True
                    .ChartTitle.Text = diagramTitle
                    .ChartTitle.Font.Size = awinSettings.fontsizeTitle
                    .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1,
                        titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend

                End With



                With newChtObj
                    .Name = chtobjname
                    .Name = chtobjname
                End With
            End If


            repObj = newChtObj

            ' jetzt muss die letzte Position des Diagramms gespeichert werden , wenn es nicht aus der Reporting Engine 
            ' aufgerufen wurde
            If Not calledfromReporting Then

                Dim prcDiagram As New clsDiagramm

                ' Anfang Event Handling für Chart 
                Dim prcChart As New clsEventsPrcCharts
                prcChart.PrcChartEvents = CType(.ChartObjects(anzDiagrams + 1), Excel.ChartObject).Chart
                prcDiagram.setDiagramEvent = prcChart
                ' Ende Event Handling für Chart 


                With prcDiagram
                    .DiagrammTitel = diagramTitle
                    .diagrammTyp = DiagrammTypen(4)
                    If anzPieSegments >= 1 Then
                        .gsCollection = New Collection
                        Dim tmpAnz As Integer = sortierteListe.Count
                        Dim loopNrs As Integer

                        If sortierteListe.Count = anzPieSegments Then
                            loopNrs = sortierteListe.Count
                        Else
                            ' in diesem Fall ist anzPieSegments < sortierteListe.count 
                            loopNrs = anzPieSegments - 1
                        End If

                        For i = 1 To loopNrs
                            Try
                                .gsCollection.Add(sortierteListe.ElementAt(tmpAnz - i).Value)
                            Catch ex As Exception

                            End Try

                        Next
                    Else
                        .gsCollection = Nothing
                    End If

                    .isCockpitChart = False
                    .top = top
                    .left = left
                    .width = width
                    .height = height
                    .kennung = chtobjname
                End With

                ' eintragen in die sortierte Liste mit .kennung als dem Schlüssel 
                ' wenn das Diagramm bereits existiert, muss es gelöscht werden, dann neu ergänzt ... 
                Try
                    DiagramList.Add(prcDiagram)
                Catch ex As Exception

                    Try
                        DiagramList.Remove(prcDiagram.kennung)
                        DiagramList.Add(prcDiagram)
                    Catch ex1 As Exception

                    End Try


                End Try

            End If

        End With

    End Sub

    ''' <summary>
    ''' gibt eine sortierte Liste mit den Top Über- bzw unterausgelasteten Ressourcen zurück
    ''' roleCollection = Nothing: über alles
    ''' Auswahl 1: Überlastung
    ''' Auswahl 2: Unterauslastung
    ''' RoleCollection enthält Rollen: dann nur deren Kinder  
    ''' </summary>
    ''' <param name="roleCollection"></param>
    ''' <param name="auswahl"></param>
    ''' <returns></returns>
    Public Function getSortedListOfCapaUtilization(ByVal roleCollection As Collection, ByVal auswahl As Integer) As SortedList(Of Double, String)
        Dim sortierteListe As New SortedList(Of Double, String)

        Dim anzRollen As Integer
        Dim roleName As String
        Dim roleIDs As New SortedList(Of Integer, Double)

        If IsNothing(roleCollection) Then
            roleIDs = RoleDefinitions.getAllIDs
        Else

            For Each tmpRoleName As String In roleCollection
                Dim teamID As Integer = -1
                Dim tmpRoleID As Integer = RoleDefinitions.getRoleDefByIDKennung(tmpRoleName, teamID).UID

                Dim tmpRoleIds As SortedList(Of Integer, Double) = RoleDefinitions.getSubRoleIDsOf(tmpRoleName, type:=PTcbr.all)
                ' herausnehmen der Rolle, mit der aufgerufen wurde ..
                If tmpRoleIds.ContainsKey(tmpRoleID) Then
                    tmpRoleIds.Remove(tmpRoleID)
                End If

                For Each srKvP As KeyValuePair(Of Integer, Double) In tmpRoleIds
                    If Not roleIDs.ContainsKey(srKvP.Key) Then
                        roleIDs.Add(srKvP.Key, srKvP.Value)
                    End If
                Next

            Next

        End If

        anzRollen = roleIDs.Count
        If anzRollen = 0 Then
            'Call MsgBox("keine Rollen-Bedarfe definiert")
            Dim errMsg As String = "no roles defined ..."
            If Not IsNothing(repMessages) Then
                If repMessages.Liste.Count > 96 Then
                    errMsg = repMessages.getmsg(96)
                End If
            End If
            Throw New ArgumentException(errMsg)
            Exit Function
        End If

        ' tk 30.7.18 Wenn es Zukunftswerte gibt, dann sollen ausschlie0lich zukünftige Bottlenecks betrachtet werden 

        Dim ixLeft As Integer = 0
        Dim ixRight As Integer = 0
        Dim heuteColumn As Integer = getColumnOfDate(Date.Now)

        If heuteColumn > showRangeLeft Then
            ixLeft = heuteColumn - showRangeLeft
            ixRight = showRangeRight - showRangeLeft
        Else
            ixLeft = 0
            ixRight = showRangeRight - showRangeLeft
        End If

        For r = 1 To anzRollen
            roleName = RoleDefinitions.getRoleDefByID(roleIDs.ElementAt(r - 1).Key).name
            'roleName = CStr(basicRolesCollection.Item(r))
            Dim sumValue1 As Double
            Dim sumValue2 As Double

            Dim array1 As Double() = Nothing
            Dim array2 As Double() = Nothing
            Dim myCollection As New Collection From {
                roleName, roleName}

            Dim kapaArray As Double() = ShowProjekte.getRoleKapasInMonth(myCollection)

            Dim sortCriteria As Double = 0.0

            If auswahl = 1 Then
                array1 = ShowProjekte.getAuslastungsValues(roleName, 1)
                If heuteColumn >= showRangeRight Then
                    array2 = ShowProjekte.getAuslastungsValues(roleName, 2)
                End If

            Else
                array1 = ShowProjekte.getAuslastungsValues(roleName, 2)
                If heuteColumn >= showRangeRight Then
                    array2 = ShowProjekte.getAuslastungsValues(roleName, 1)
                End If
            End If

            If heuteColumn >= showRangeRight Then
                ' alte Vorgehensweise 
                sumValue1 = array1.Sum
                If sumValue1 > 0 Then

                    sumValue2 = array2.Sum
                    sortCriteria = sumValue1 - sumValue2

                End If
            Else
                ' jetzt wird das Kriterium etwas anders betrachtet ... 
                ' alle in der Zukunft liegenden Monate, und hier die größten Ausschläge betrachten ... 
                sortCriteria = calcUtilizationSortCriteria(array1, ixLeft, ixRight, kapaArray)
            End If

            If sortCriteria > 0 Then
                While sortierteListe.ContainsKey(sortCriteria)
                    sortCriteria = sortCriteria + 0.0000001
                End While
                ' jetzt enthält sortierte Liste nicht mehr den Schlüssel ..
                sortierteListe.Add(sortCriteria, roleName)
            End If

        Next r


        getSortedListOfCapaUtilization = sortierteListe
    End Function


    ''' <summary>
    ''' 
    ''' </summary>
    ''' <param name="arrayZahlen"></param>
    ''' <param name="ixLeft"></param>
    ''' <param name="ixRight"></param>
    ''' <returns></returns>
    Private Function calcUtilizationSortCriteria(ByVal arrayZahlen() As Double, ByVal ixLeft As Integer, ByVal ixRight As Integer, ByVal kapaArray() As Double) As Double
        Dim tmpResult As Double = 0.0

        Dim dimension1 As Integer = arrayZahlen.Length - 1
        Dim dimension2 As Integer = kapaArray.Length - 1

        If dimension1 <> dimension2 Then
            ' nichts tun 
        Else
            If ixLeft >= 0 And ixRight <= dimension1 Then
                For i As Integer = ixLeft To ixRight

                    If arrayZahlen(i) > 0 Then
                        If kapaArray(i) > 0 Then
                            tmpResult = tmpResult + System.Math.Pow((arrayZahlen(i) + kapaArray(i)) / kapaArray(i), 3)
                        Else
                            tmpResult = tmpResult + System.Math.Pow(arrayZahlen(i), 2)
                        End If

                    End If

                Next
            End If

        End If



        calcUtilizationSortCriteria = tmpResult
    End Function

    ''' <summary>
    ''' auswahl = 1: Ressourcenbedarf in PT
    ''' auswahl = 2: PErsonalkosten
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="repObj"></param>
    ''' <param name="auswahl"></param>
    ''' <param name="top"></param>
    ''' <param name="left"></param>
    ''' <param name="height"></param>
    ''' <param name="width"></param>
    ''' <remarks></remarks>
    Public Sub createRessPieOfProject(ByRef hproj As clsProjekt, ByRef repObj As Excel.ChartObject, ByVal auswahl As Integer, _
                                            ByVal top As Double, left As Double, height As Double, width As Double, _
                                            ByVal calledFromReporting As Boolean)

        'Dim kennziffer As Integer = 4
        Dim diagramTitle As String
        Dim anzDiagrams As Integer

        Dim plen As Integer

        Dim Xdatenreihe() As String
        Dim tdatenreihe() As Double

        Dim anzRollen As Integer
        Dim roleName As String

        'Dim prIndex As Integer = RoleDefinitions.Count
        Dim pstart As Integer
        Dim pname As String = hproj.name

        Dim kennung As String
        Dim currentSheetName As String
        Dim newChtObj As Excel.ChartObject = Nothing
        Dim maxlenTitle1 As Integer = 20

        Dim zE As String = awinSettings.kapaEinheit
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim tmpcollection As New Collection

        Dim found As Boolean = False

        Dim usePieColors As Boolean = True


        Dim tcs As core.ThemeColorScheme = appInstance.ActiveWorkbook.Theme.ThemeColorScheme


        Dim pieColors() As Integer = {tcs.Colors(core.MsoThemeColorSchemeIndex.msoThemeAccent1).RGB,
                                      tcs.Colors(core.MsoThemeColorSchemeIndex.msoThemeAccent2).RGB,
                                      tcs.Colors(core.MsoThemeColorSchemeIndex.msoThemeAccent3).RGB,
                                      tcs.Colors(core.MsoThemeColorSchemeIndex.msoThemeAccent4).RGB,
                                      tcs.Colors(core.MsoThemeColorSchemeIndex.msoThemeAccent5).RGB}

        If visboZustaende.projectBoardMode = ptModus.graficboard Then
            If calledfromReporting Then
                currentSheetName = arrWsNames(ptTables.repCharts)
            Else
                currentSheetName = arrWsNames(ptTables.mptPrCharts)
            End If

        Else
            currentSheetName = arrWsNames(ptTables.meCharts)
        End If

        Dim ErgebnisListeR As Collection

        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With
        '
        ' hole die Anzahl Rollen, die in diesem Projekt vorkommen
        '
        ErgebnisListeR = New Collection
        If myCustomUserRole.customUserRole = ptCustomUserRoles.RessourceManager Or myCustomUserRole.customUserRole = ptCustomUserRoles.TeamManager Then
            Try
                Dim teamID As Integer = -1
                Dim tmpSubRoleListe As SortedList(Of Integer, Double) = RoleDefinitions.getRoleDefByIDKennung(myCustomUserRole.specifics, teamID).getSubRoleIDs

                For Each kvp As KeyValuePair(Of Integer, Double) In tmpSubRoleListe
                    Dim tmpName As String = RoleDefinitions.getRoleDefByID(kvp.Key).name
                    ErgebnisListeR.Add(tmpName)
                Next
            Catch ex As Exception

            End Try


        ElseIf myCustomUserRole.customUserRole = ptCustomUserRoles.ProjektLeitung Then

            Try
                Dim tmpRoleListe() As Integer = RoleDefinitions.getIDArray(myCustomUserRole.specifics)
                If Not IsNothing(tmpRoleListe) Then
                    For Each roleID As Integer In tmpRoleListe
                        Dim tmpName As String = RoleDefinitions.getRoleDefByID(roleID).name
                        If tmpName.Length > 0 Then
                            ErgebnisListeR.Add(tmpName)
                        End If
                    Next
                    usePieColors = False
                End If
            Catch ex As Exception

            End Try

        Else
            ErgebnisListeR = RoleDefinitions.getTopLevelNodeNames(1)
        End If

        If ErgebnisListeR.Count = 0 Then
            ErgebnisListeR = RoleDefinitions.getTopLevelNodeNames(1)
        End If


        'If ErgebnisListeR.Count > 12 Then
        '    ErgebnisListeR = RoleDefinitions.getTopLevelNodeNames(0)
        'End If


        anzRollen = ErgebnisListeR.Count


        If myCustomUserRole.customUserRole = ptCustomUserRoles.RessourceManager Or myCustomUserRole.customUserRole = ptCustomUserRoles.TeamManager Or anzRollen = 0 Then
            ' eine Dimension größer, weil dei Eltern-Rolel noch mitkommt 
            ReDim tdatenreihe(anzRollen)
            ReDim Xdatenreihe(anzRollen)
        Else
            ReDim tdatenreihe(anzRollen - 1)
            ReDim Xdatenreihe(anzRollen - 1)
        End If



        ' Aufbauen der eigentlichen Rolle
        For r = 0 To anzRollen - 1
            roleName = CStr(ErgebnisListeR.Item(r + 1))
            Xdatenreihe(r) = roleName

            If auswahl = 1 Then
                tdatenreihe(r) = hproj.getRessourcenBedarf(roleName, inclSubRoles:=True).Sum
            Else
                tdatenreihe(r) = hproj.getRessourcenBedarf(roleName, inclSubRoles:=True, outPutInEuro:=True).Sum
            End If

        Next r


        If myCustomUserRole.customUserRole = ptCustomUserRoles.RessourceManager Or myCustomUserRole.customUserRole = ptCustomUserRoles.TeamManager Then
            ' jetzt soll die Specifics noch aufgenommen werden 
            anzRollen = anzRollen + 1

            Dim teamID As Integer = -1
            Dim parentRoleName As String = RoleDefinitions.getRoleDefByIDKennung(myCustomUserRole.specifics, teamID).name
            ErgebnisListeR.Add(parentRoleName)

            Xdatenreihe(anzRollen - 1) = parentRoleName

            If auswahl = 1 Then
                tdatenreihe(anzRollen - 1) = hproj.getRessourcenBedarf(myCustomUserRole.specifics, inclSubRoles:=False).Sum
            Else
                tdatenreihe(anzRollen - 1) = hproj.getRessourcenBedarf(myCustomUserRole.specifics, inclSubRoles:=False, outPutInEuro:=True).Sum
            End If
        End If


        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False

        tmpcollection.Add(hproj.name & "#" & auswahl.ToString)
        kennung = calcChartKennung("pr", PTprdk.PersonalPie, tmpcollection)

        If auswahl = 1 Then
            ' tk 12.6.17 
            'titelTeile(0) = repMessages.getmsg(159) & " (" & gesamt_summe.ToString("####0.") & " " & zE & ")" & vbLf & hproj.getShapeText & vbLf
            titelTeile(0) = repMessages.getmsg(159) & " (" & tdatenreihe.Sum.ToString("##,##0.") & " " & zE & ")"
            titelTeilLaengen(0) = titelTeile(0).Length
            titelTeile(1) = ""
            'If calledFromReporting Then
            '    titelTeile(1) = vbLf & hproj.getShapeText

            '    If titelTeile(1).Length > maxlenTitle1 + 3 Then
            '        titelTeile(1) = titelTeile(1).Substring(0, maxlenTitle1) & "... (" & hproj.timeStamp.ToString & ") "
            '    Else
            '        titelTeile(1) = titelTeile(1) & " (" & hproj.timeStamp.ToString & ") "
            '    End If
            'Else
            '    titelTeile(1) = ""
            'End If
            
            'titelTeile(1) = " (" & hproj.timeStamp.ToString & ") "
            titelTeilLaengen(1) = titelTeile(1).Length
            diagramTitle = titelTeile(0) & titelTeile(1)
            'kennung = "Personalbedarf"
        ElseIf auswahl = 2 Then
            ' tk 12.6.17
            'titelTeile(0) = repMessages.getmsg(160) & " (" & gesamt_summe.ToString("####0.") & " T€" & ")" & vbLf & hproj.getShapeText & vbLf
            titelTeile(0) = repMessages.getmsg(164) & " (" & tdatenreihe.Sum.ToString("##,##0.") & " T€" & ")"
            titelTeilLaengen(0) = titelTeile(0).Length
            'titelTeile(1) = " (" & hproj.timeStamp.ToString & ") "
            titelTeile(1) = ""
            'If calledFromReporting Then
            '    titelTeile(1) = vbLf & hproj.getShapeText
            '    If titelTeile(1).Length > maxlenTitle1 + 3 Then
            '        titelTeile(1) = titelTeile(1).Substring(0, maxlenTitle1) & "... (" & hproj.timeStamp.ToString & ") "
            '    Else
            '        titelTeile(1) = titelTeile(1) & " (" & hproj.timeStamp.ToString & ") "
            '    End If
            'Else
            '    titelTeile(1) = ""
            'End If
            
            titelTeilLaengen(1) = titelTeile(1).Length
            diagramTitle = titelTeile(0) & titelTeile(1)
            diagramTitle = titelTeile(0) & titelTeile(1)
            'kennung = "Personalkosten"
        Else
            diagramTitle = "--- (T€)" & vbLf & pname
            'kennung = "Gesamtkosten"
        End If

        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(currentSheetName), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            Dim i As Integer
            i = 1
            While i <= anzDiagrams And Not found

                If .ChartObjects(i).name = kennung Then
                    found = True
                    repObj = CType(.ChartObjects(i), Excel.ChartObject)
                Else
                    i = i + 1
                End If

            End While

            If found Then
                appInstance.EnableEvents = formerEE
                repObj = CType(.ChartObjects(i), Excel.ChartObject)
                'appInstance.ScreenUpdating = formerSU
                Exit Sub
            Else
                newChtObj = CType(.ChartObjects, Excel.ChartObjects).Add(left, top, width, height)

                With CType(newChtObj.Chart, Excel.Chart)
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try

                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                        .Name = pname
                        .Values = tdatenreihe
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlPie

                        If calledFromReporting Then
                            .HasDataLabels = True
                            .DataLabels.Position = Excel.XlDataLabelPosition.xlLabelPositionOutsideEnd
                        Else
                            .HasDataLabels = False
                        End If

                    End With

                    For r = 1 To anzRollen
                        roleName = CStr(ErgebnisListeR.Item(r))
                        With .SeriesCollection(1).Points(r)

                            If usePieColors Then
                                Dim rest As Integer
                                Dim ix As Integer = Math.DivRem(r, 5, rest)
                                If rest > 0 Then
                                    .interior.color = pieColors(rest)
                                Else
                                    .interior.color = pieColors(0)
                                End If
                            Else
                                .Interior.color = RoleDefinitions.getRoledef(roleName).farbe
                            End If

                            If calledFromReporting Then
                                .DataLabel.Font.Size = 10
                            End If

                        End With
                    Next r

                    .HasLegend = True
                    With .Legend
                        .Position = Excel.XlLegendPosition.xlLegendPositionRight
                        .Font.Size = awinSettings.fontsizeItems
                    End With
                    .HasTitle = True
                    .ChartTitle.Text = diagramTitle
                    .ChartTitle.Font.Size = awinSettings.fontsizeTitle
                    .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                        titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend


                End With

                With newChtObj
                    '.Name = pname & "#" & kennung & "#" & "2"
                    .Name = kennung
                End With
            End If


            repObj = newChtObj


        End With




    End Sub

    '
    ' Prozedur zeigt die Kosten Struktur des Projektes an (Balken-Diagramm)
    '
    ' Auswahl = 1 : Diagramm zeigt nur sonstige Kosten 
    ' Auswahl = 2 : Diagramm zeigt alle Kosten, inkl Personalkosten 
    ' kennziffer = 0 : Phasen Diagramm
    '            = 1 : Personal-Bedarfe (Balken)
    '            = 2 : Personal-Bedarfe (PIE)
    '            = 3 : Kosten (Balken)
    '            = 4 : Kosten (Pie)
    '            = 5 : Strategie / Risiko 
    '            = 6 : Ergebnis

    Public Sub updateRessPieOfProject(ByRef hproj As clsProjekt, ByRef chtobj As Excel.ChartObject, ByVal auswahl As Integer)

        'Dim kennziffer As Integer = 4
        Dim diagramTitle As String
        'Dim anzDiagrams As Integer

        Dim plen As Integer

        Dim Xdatenreihe() As String
        Dim tdatenreihe() As Double

        Dim anzRollen As Integer
        Dim roleName As String
        Dim maxlenTitle1 As Integer = 20

        Dim pstart As Integer
        Dim pname As String = hproj.name


        Dim kennung As String = " "
        Dim zE As String = awinSettings.kapaEinheit
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim tmpCollection As New Collection

        Dim fontSize1 As Double = awinSettings.fontsizeTitle, fontSize2 As Double = awinSettings.fontsizeLegend

        Dim ErgebnisListeR As Collection

        Dim usePieColors As Boolean = True

        Dim tcs As core.ThemeColorScheme = appInstance.ActiveWorkbook.Theme.ThemeColorScheme


        Dim pieColors() As Integer = {tcs.Colors(core.MsoThemeColorSchemeIndex.msoThemeAccent1).RGB,
                                      tcs.Colors(core.MsoThemeColorSchemeIndex.msoThemeAccent2).RGB,
                                      tcs.Colors(core.MsoThemeColorSchemeIndex.msoThemeAccent3).RGB,
                                      tcs.Colors(core.MsoThemeColorSchemeIndex.msoThemeAccent4).RGB,
                                      tcs.Colors(core.MsoThemeColorSchemeIndex.msoThemeAccent5).RGB}


        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False


        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With
        '

        '
        ' hole die Anzahl Rollen, die in diesem Projekt vorkommen
        '
        ErgebnisListeR = New Collection
        If myCustomUserRole.customUserRole = ptCustomUserRoles.RessourceManager Or myCustomUserRole.customUserRole = ptCustomUserRoles.TeamManager Then
            Try
                Dim teamID As Integer = -1
                Dim tmpSubRoleListe As SortedList(Of Integer, Double) = RoleDefinitions.getRoleDefByIDKennung(myCustomUserRole.specifics, teamID).getSubRoleIDs

                For Each kvp As KeyValuePair(Of Integer, Double) In tmpSubRoleListe
                    Dim tmpName As String = RoleDefinitions.getRoleDefByID(kvp.Key).name
                    ErgebnisListeR.Add(tmpName)
                Next
            Catch ex As Exception

            End Try


        ElseIf myCustomUserRole.customUserRole = ptCustomUserRoles.ProjektLeitung Then

            Try
                Dim tmpRoleListe() As Integer = RoleDefinitions.getIDArray(myCustomUserRole.specifics)
                If Not IsNothing(tmpRoleListe) Then
                    For Each roleID As Integer In tmpRoleListe
                        Dim tmpName As String = RoleDefinitions.getRoleDefByID(roleID).name
                        If tmpName.Length > 0 Then
                            ErgebnisListeR.Add(tmpName)
                        End If
                    Next
                    usePieColors = False
                End If
            Catch ex As Exception

            End Try

        Else
            ErgebnisListeR = RoleDefinitions.getTopLevelNodeNames(1)
        End If

        If ErgebnisListeR.Count = 0 Then
            ErgebnisListeR = RoleDefinitions.getTopLevelNodeNames(1)
        End If


        'If ErgebnisListeR.Count > 12 Then
        '    ErgebnisListeR = RoleDefinitions.getTopLevelNodeNames(0)
        'End If

        anzRollen = ErgebnisListeR.Count

        If myCustomUserRole.customUserRole = ptCustomUserRoles.RessourceManager Or myCustomUserRole.customUserRole = ptCustomUserRoles.TeamManager Or anzRollen = 0 Then
            ' eine Dimension größer, weil dei Eltern-Rolel noch mitkommt 
            ReDim tdatenreihe(anzRollen)
            ReDim Xdatenreihe(anzRollen)
        Else
            ReDim tdatenreihe(anzRollen - 1)
            ReDim Xdatenreihe(anzRollen - 1)
        End If



        For r = 0 To anzRollen - 1
            roleName = CStr(ErgebnisListeR.Item(r + 1))
            Xdatenreihe(r) = roleName

            If auswahl = 1 Then
                tdatenreihe(r) = hproj.getRessourcenBedarf(roleName, inclSubRoles:=True).Sum
            Else
                tdatenreihe(r) = hproj.getRessourcenBedarf(roleName, inclSubRoles:=True, outPutInEuro:=True).Sum
            End If

        Next r


        If myCustomUserRole.customUserRole = ptCustomUserRoles.RessourceManager Or myCustomUserRole.customUserRole = ptCustomUserRoles.TeamManager Then
            ' jetzt soll die Specifics noch aufgenommen werden 
            anzRollen = anzRollen + 1

            Dim teamID As Integer = -1
            Dim parentRoleName As String = RoleDefinitions.getRoleDefByIDKennung(myCustomUserRole.specifics, teamID).name
            ErgebnisListeR.Add(parentRoleName)

            Xdatenreihe(anzRollen - 1) = parentRoleName

            If auswahl = 1 Then
                tdatenreihe(anzRollen - 1) = hproj.getRessourcenBedarf(myCustomUserRole.specifics, inclSubRoles:=False).Sum
            Else
                tdatenreihe(anzRollen - 1) = hproj.getRessourcenBedarf(myCustomUserRole.specifics, inclSubRoles:=False, outPutInEuro:=True).Sum
            End If
        End If


        tmpCollection.Add(hproj.name & "#" & auswahl.ToString)
        kennung = calcChartKennung("pr", PTprdk.PersonalPie, tmpCollection)

        If auswahl = 1 Then
            ' tk 12.6.17 
            'titelTeile(0) = repMessages.getmsg(159) & " (" & gesamt_summe.ToString("####0.") & " " & zE & ")" & vbLf & hproj.getShapeText & vbLf
            titelTeile(0) = repMessages.getmsg(159) & " (" & tdatenreihe.Sum.ToString("##,##0.") & " " & zE & ")"
            titelTeilLaengen(0) = titelTeile(0).Length
            titelTeile(1) = ""
            'titelTeile(1) = " (" & hproj.timeStamp.ToString & ") "
            titelTeilLaengen(1) = titelTeile(1).Length
            diagramTitle = titelTeile(0) & titelTeile(1)
            'kennung = "Personalbedarf"
        ElseIf auswahl = 2 Then
            ' tk 12.6.17
            'titelTeile(0) = repMessages.getmsg(160) & " (" & gesamt_summe.ToString("####0.") & " T€" & ")" & vbLf & hproj.getShapeText & vbLf
            titelTeile(0) = repMessages.getmsg(164) & " (" & tdatenreihe.Sum.ToString("##,##0.") & " T€" & ")"
            titelTeilLaengen(0) = titelTeile(0).Length
            'titelTeile(1) = " (" & hproj.timeStamp.ToString & ") "
            titelTeile(1) = ""
            titelTeilLaengen(1) = titelTeile(1).Length
            diagramTitle = titelTeile(0) & titelTeile(1)
            diagramTitle = titelTeile(0) & titelTeile(1)
            'kennung = "Personalkosten"
        Else
            diagramTitle = "--- (T€)" & vbLf & pname
            'kennung = "Gesamtkosten"
        End If



        With chtobj.Chart

            ' bestimmen der Fontsize Größen 
            Try
                If .HasTitle Then
                    Dim len As Integer = .ChartTitle.Text.Length
                    fontSize1 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=1, Length:=1).Font.Size
                    fontSize2 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=len - 1, Length:=1).Font.Size
                End If
            Catch ex As Exception

            End Try

            'ur:22.07.2014 wegen Chart-Cockpit
            '' remove extra series
            'Do Until .SeriesCollection.Count = 0
            '    .SeriesCollection(1).Delete()
            'Loop

            'With .SeriesCollection.NewSeries
            With CType(.SeriesCollection(1), Excel.Series)
                .Name = pname
                .Values = tdatenreihe
                .XValues = Xdatenreihe
                .ChartType = Excel.XlChartType.xlPie
                '.HasDataLabels = False
                '.DataLabels.Position = Excel.XlDataLabelPosition.xlLabelPositionOutsideEnd
            End With

            For r = 1 To anzRollen
                roleName = CStr(ErgebnisListeR.Item(r))
                With .SeriesCollection(1).Points(r)

                    If usePieColors Then
                        Dim rest As Integer
                        Dim ix As Integer = Math.DivRem(r, 5, rest)
                        If rest > 0 Then
                            .interior.color = pieColors(rest)
                        Else
                            .interior.color = pieColors(0)
                        End If
                    Else
                        .Interior.color = RoleDefinitions.getRoledef(roleName).farbe
                    End If

                End With
            Next r


            ' Änderung: evtl wurde ja der Titel gelöscht 
            If .HasTitle Then
                .ChartTitle.Text = diagramTitle
                ' Änderung tk: wieder mit reingenmmen, da ja jetzt zu Beginn die fontsize1, ..2 bestimmt werden 
                .ChartTitle.Font.Size = CSng(fontSize1)
                .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                    titelTeilLaengen(1)).Font.Size = CSng(fontSize2)
            End If


        End With

        chtobj.Name = kennung

        appInstance.EnableEvents = formerEE



    End Sub
    '
    ' Prozedur zeigt die Kosten Struktur des Projektes an (Balken-Diagramm)
    '
    ' Auswahl = 1 : Diagramm zeigt nur sonstige Kosten 
    ' Auswahl = 2 : Diagramm zeigt alle Kosten, inkl Personalkosten 
    ' kennziffer = 0 : Phasen Diagramm
    '            = 1 : Personal-Bedarfe (Balken)
    '            = 2 : Personal-Bedarfe (PIE)
    '            = 3 : Kosten (Balken)
    '            = 4 : Kosten (Pie)
    '            = 5 : Strategie / Risiko 
    '            = 6 : Ergebnis

    Public Sub createCostPieOfProject(ByRef hproj As clsProjekt, ByRef repObj As Excel.ChartObject, ByVal auswahl As Integer, _
                                        ByVal top As Double, left As Double, height As Double, width As Double, _
                                        ByVal calledFromReporting As Boolean)

        Dim kennziffer As Integer = 4
        Dim diagramTitle As String
        Dim anzDiagrams As Integer

        Dim plen As Integer

        Dim Xdatenreihe() As String
        Dim tdatenreihe() As Double

        Dim anzKostenarten As Integer
        Dim costname As String

        Dim pkIndex As Integer = CostDefinitions.Count
        Dim pstart As Integer
        Dim pname As String = hproj.name

        Dim kennung As String
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim tmpcollection As New Collection
        Dim currentSheetName As String
        Dim newChtObj As Excel.ChartObject = Nothing
        Dim maxlenTitle1 As Integer = 20

        Dim found As Boolean = False

        If visboZustaende.projectBoardMode = ptModus.graficboard Then
            If calledfromReporting Then
                currentSheetName = arrWsNames(ptTables.repCharts)
            Else
                currentSheetName = arrWsNames(ptTables.mptPrCharts)
            End If

        Else
            currentSheetName = arrWsNames(ptTables.meCharts)
        End If

        Dim ErgebnisListeK As Collection

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False
        'appInstance.ScreenUpdating = False


        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With
        '
        ' hole die Anzahl Kostenarten, die in diesem Projekt vorkommen
        '
        ErgebnisListeK = hproj.getCostNames
        anzKostenarten = ErgebnisListeK.Count


        tmpcollection.Add(hproj.name & "#" & auswahl.ToString)
        kennung = calcChartKennung("pr", PTprdk.KostenPie, tmpcollection)

        If auswahl = 1 Then
            ' Alle Sonstigen Kostenarten 
            If anzKostenarten = 0 Then
                ReDim tdatenreihe(0)
                ReDim Xdatenreihe(0)
            Else
                ReDim tdatenreihe(anzKostenarten - 1)
                ReDim Xdatenreihe(anzKostenarten - 1)
            End If

        Else
            ' alle Kostenarten - inkl Personalkosten 
            ReDim tdatenreihe(anzKostenarten)
            ReDim Xdatenreihe(anzKostenarten)
            'Xdatenreihe(0) = "Personal-Kosten"
            'tdatenreihe(0) = hsum(0)
        End If


        For k = 0 To anzKostenarten - 1
            costname = CStr(ErgebnisListeK.Item(k + 1))
            Xdatenreihe(k) = costname
            tdatenreihe(k) = System.Math.Round(hproj.getKostenBedarf(costname).Sum, mode:=MidpointRounding.ToEven)
        Next k

        If auswahl = 2 Then
            'Xdatenreihe(anzKostenarten) = "Personal-Kosten"
            Xdatenreihe(anzKostenarten) = repMessages.getmsg(164)
            tdatenreihe(anzKostenarten) = System.Math.Round(hproj.getAllPersonalKosten.Sum, mode:=MidpointRounding.ToEven)
        End If


        If auswahl = 1 Then
            ' tk 12.6.17 

            titelTeile(0) = repMessages.getmsg(165) & " (" & tdatenreihe.Sum.ToString("##,##0.") & " T€" & ")"
            titelTeilLaengen(0) = titelTeile(0).Length
            titelTeile(1) = ""
            'If calledFromReporting Then
            '    titelTeile(1) = vbLf & hproj.getShapeText

            '    If titelTeile(1).Length > maxlenTitle1 + 3 Then
            '        titelTeile(1) = titelTeile(1).Substring(0, maxlenTitle1) & "... (" & hproj.timeStamp.ToString & ") "
            '    Else
            '        titelTeile(1) = titelTeile(1) & " (" & hproj.timeStamp.ToString & ") "
            '    End If
            'Else
            '    titelTeile(1) = ""
            'End If
            

            titelTeilLaengen(1) = titelTeile(1).Length
            diagramTitle = titelTeile(0) & titelTeile(1)
            'kennung = "Personalbedarf"
        ElseIf auswahl = 2 Then
            ' tk 12.6.17
            'titelTeile(0) = repMessages.getmsg(160) & " (" & gesamt_summe.ToString("####0.") & " T€" & ")" & vbLf & hproj.getShapeText & vbLf
            titelTeile(0) = repMessages.getmsg(166) & " (" & tdatenreihe.Sum.ToString("##,##0.") & " T€" & ")"
            titelTeilLaengen(0) = titelTeile(0).Length
            titelTeile(1) = ""

            'If calledFromReporting Then
            '    titelTeile(1) = vbLf & hproj.getShapeText
            '    If titelTeile(1).Length > maxlenTitle1 + 3 Then
            '        titelTeile(1) = titelTeile(1).Substring(0, maxlenTitle1) & "... (" & hproj.timeStamp.ToString & ") "
            '    Else
            '        titelTeile(1) = titelTeile(1) & " (" & hproj.timeStamp.ToString & ") "
            '    End If
            'Else
            '    titelTeile(1) = ""
            'End If
            
            titelTeilLaengen(1) = titelTeile(1).Length
            diagramTitle = titelTeile(0) & titelTeile(1)

        Else
            diagramTitle = "--- (T€)" & vbLf & pname
            'kennung = "Gesamtkosten"
        End If


        If tdatenreihe.Sum = 0 And calledFromReporting Then
            appInstance.EnableEvents = formerEE
            Throw New ArgumentException(repMessages.getmsg(167))
            Exit Sub
        End If
        
        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(currentSheetName), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count

            '
            ' um welches Diagramm handelt es sich ...
            '
            Dim i As Integer = 1

            i = 1
            While i <= anzDiagrams And Not found

                If .ChartObjects(i).name = kennung Then
                    found = True
                    repObj = CType(.ChartObjects(i), Excel.ChartObject)
                Else
                    i = i + 1
                End If

            End While

            If found Then
                'Call MsgBox("Chart wird bereits angezeigt ...")
                appInstance.EnableEvents = formerEE
                repObj = CType(.ChartObjects(i), Excel.ChartObject)
                'appInstance.ScreenUpdating = formerSU
            Else
                newChtObj = CType(.ChartObjects, Excel.ChartObjects).Add(left, top, width, height)

                With CType(newChtObj.Chart, Excel.Chart)
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try

                    With CType(CType(.SeriesCollection, Excel.SeriesCollection).NewSeries, Excel.Series)
                        .Name = pname
                        .Values = tdatenreihe
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlPie
                        If calledFromReporting Then
                            .HasDataLabels = True
                            .DataLabels.Position = Excel.XlDataLabelPosition.xlLabelPositionOutsideEnd
                        Else
                            .HasDataLabels = False
                        End If

                    End With

                    For k = 0 To anzKostenarten - 1 + auswahl - 1
                        If k = anzKostenarten Then
                            'costname = "Personal-Kosten"
                            costname = repMessages.getmsg(164)
                            With .SeriesCollection(1).Points(k + 1)
                                .Interior.Color = CostDefinitions.getCostdef(pkIndex).farbe
                                If calledFromReporting Then
                                    .DataLabel.Font.Size = 10
                                End If


                            End With
                        Else
                            costname = CStr(ErgebnisListeK.Item(k + 1))
                            With .SeriesCollection(1).Points(k + 1)
                                .Interior.Color = CostDefinitions.getCostdef(costname).farbe
                                If calledFromReporting Then
                                    .DataLabel.Font.Size = 10
                                End If

                            End With
                        End If

                    Next k

                    .HasLegend = True
                    With .Legend
                        .Position = Excel.XlLegendPosition.xlLegendPositionRight
                        .Font.Size = awinSettings.fontsizeItems
                    End With
                    .HasTitle = True
                    .ChartTitle.Text = diagramTitle
                    .ChartTitle.Font.Size = awinSettings.fontsizeTitle
                    .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                            titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend


                End With

                With newChtObj
                    '.Name = pname & "#" & kennung & "#" & "2"
                    .Name = kennung
                End With

                repObj = newChtObj
            End If

        End With

        appInstance.EnableEvents = formerEE
            'appInstance.ScreenUpdating = True


    End Sub


    ''' <summary>
    ''' aktualisiert im exist. Chart die Kosten Struktur des Projektes (Pie-Chart)
    ''' Kennziffer fest = 4 (Kosten Pie)
    ''' </summary>
    ''' <param name="hproj">Verweis auf das Projekt</param>
    ''' <param name="chtobj">Verweis auf das Chart-Objekt</param>
    ''' <param name="auswahl">
    ''' Auswahl = 1 : Diagramm zeigt nur sonstige Kosten 
    ''' Auswahl = 2 : Diagramm zeigt alle Kosten, inkl Personalkosten 
    ''' </param>
    ''' <remarks>
    ''' kennziffer = 0 : Phasen Diagramm
    '''            = 1 : Personal-Bedarfe (Balken)
    '''            = 2 : Personal-Bedarfe (PIE)
    '''            = 3 : Kosten (Balken)
    '''            = 4 : Kosten (Pie)
    '''            = 5 : Strategie / Risiko 
    '''            = 6 : Ergebnis
    ''' </remarks>
    Public Sub updateCostPieOfProject(ByRef hproj As clsProjekt, ByRef chtobj As Excel.ChartObject, ByVal auswahl As Integer)

        Dim kennziffer As Integer = 4
        Dim diagramTitle As String

        Dim plen As Integer

        Dim Xdatenreihe() As String
        Dim tdatenreihe() As Double

        Dim anzKostenarten As Integer
        Dim costname As String

        Dim pkIndex As Integer = CostDefinitions.Count
        Dim pstart As Integer
        Dim pname As String = hproj.name

        Dim fontSize1 As Double = awinSettings.fontsizeTitle, fontSize2 As Double = awinSettings.fontsizeLegend

        Dim kennung As String = " "
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim tmpCollection As New Collection

        Dim maxlenTitle1 As Integer = 20

        Dim ErgebnisListeK As Collection


        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False
        'appInstance.ScreenUpdating = False




        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With
        '
        ' hole die Anzahl Kostenarten, die in diesem Projekt vorkommen
        '
        ErgebnisListeK = hproj.getCostNames
        anzKostenarten = ErgebnisListeK.Count


        tmpCollection.Add(hproj.name & "#" & auswahl.ToString)
        kennung = calcChartKennung("pr", PTprdk.KostenPie, tmpCollection)

        If auswahl = 1 Then
            ' Alle Sonstigen Kostenarten 
            If anzKostenarten > 0 Then
                ReDim tdatenreihe(anzKostenarten - 1)
                ReDim Xdatenreihe(anzKostenarten - 1)
            Else
                ReDim tdatenreihe(0)
                ReDim Xdatenreihe(0)
            End If

        Else
            ' alle Kostenarten - inkl Personalkosten 
            ReDim tdatenreihe(anzKostenarten)
            ReDim Xdatenreihe(anzKostenarten)
            'Xdatenreihe(0) = "Personal-Kosten"
            'tdatenreihe(0) = hsum(0)
        End If


        For k = 0 To anzKostenarten - 1
            costname = CStr(ErgebnisListeK.Item(k + 1))
            Xdatenreihe(k) = costname
            tdatenreihe(k) = System.Math.Round(hproj.getKostenBedarf(costname).Sum, mode:=MidpointRounding.ToEven)
        Next k

        If auswahl = 2 Then
            'Xdatenreihe(anzKostenarten) = "Personal-Kosten"
            Xdatenreihe(anzKostenarten) = repMessages.getmsg(164)
            tdatenreihe(anzKostenarten) = System.Math.Round(hproj.getAllPersonalKosten.Sum, mode:=MidpointRounding.ToEven)
        End If

        If auswahl = 1 Then
            ' tk 12.6.17 
            'titelTeile(0) = repMessages.getmsg(159) & " (" & gesamt_summe.ToString("####0.") & " " & zE & ")" & vbLf & hproj.getShapeText & vbLf
            titelTeile(0) = repMessages.getmsg(165) & " (" & tdatenreihe.Sum.ToString("##,##0.") & " T€" & ")"
            titelTeilLaengen(0) = titelTeile(0).Length
            titelTeile(1) = ""
            titelTeilLaengen(1) = titelTeile(1).Length
            diagramTitle = titelTeile(0) & titelTeile(1)
            'kennung = "Personalbedarf"
        ElseIf auswahl = 2 Then
            ' tk 12.6.17
            'titelTeile(0) = repMessages.getmsg(160) & " (" & gesamt_summe.ToString("####0.") & " T€" & ")" & vbLf & hproj.getShapeText & vbLf
            titelTeile(0) = repMessages.getmsg(166) & " (" & tdatenreihe.Sum.ToString("##,##0.") & " T€" & ")"
            titelTeilLaengen(0) = titelTeile(0).Length

            titelTeile(1) = ""
            titelTeilLaengen(1) = titelTeile(1).Length
            diagramTitle = titelTeile(0) & titelTeile(1)
            'kennung = "Personalkosten"
        Else
            diagramTitle = "--- (T€)" & vbLf & pname
            'kennung = "Gesamtkosten"
        End If


        With chtobj.Chart
            ' ur: 22.07.2014: ist bereits im Cockpit-Chart enthalten
            '' remove extra series
            'Do Until .SeriesCollection.Count = 0
            '    .SeriesCollection(1).Delete()
            'Loop

            ' bestimmen der Fontsize Größen 
            Try
                If .HasTitle Then
                    Dim len As Integer = .ChartTitle.Text.Length
                    fontSize1 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=1, Length:=1).Font.Size
                    fontSize2 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=len - 1, Length:=1).Font.Size
                End If
            Catch ex As Exception

            End Try


            'With .SeriesCollection.NewSeries
            With .SeriesCollection(1)
                .Name = pname
                .Values = tdatenreihe
                .XValues = Xdatenreihe
                .ChartType = Excel.XlChartType.xlPie
                '.HasDataLabels = True
                '.DataLabels.Position = Excel.XlDataLabelPosition.xlLabelPositionOutsideEnd
            End With

            For k = 0 To anzKostenarten - 1 + auswahl - 1
                If k = anzKostenarten Then
                    costname = "Personal-Kosten"
                    With .SeriesCollection(1).Points(k + 1)
                        .Interior.color = CostDefinitions.getCostdef(pkIndex).farbe
                        ' ur: 21.07.2014 für Chart-Cockpit auskommentiert
                        '.DataLabel.Font.Size = 10

                    End With
                Else
                    costname = CStr(ErgebnisListeK.Item(k + 1))
                    With .SeriesCollection(1).Points(k + 1)
                        .Interior.color = CostDefinitions.getCostdef(costname).farbe
                        ' ur: 21.07.2014 für Chart-Cockpit auskommentiert
                        '.DataLabel.Font.Size = 10

                    End With
                End If

            Next k


            If .HasTitle Then
                .ChartTitle.Text = diagramTitle
                ' Änderung tk: wieder mit reingenmmen, da ja jetzt zu Beginn die fontsize1, ..2 bestimmt werden 
                .ChartTitle.Font.Size = CSng(fontSize1)
                .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                    titelTeilLaengen(1)).Font.Size = CSng(fontSize2)
                ' ur: 21.07.2014 für Chart-Cockpit auskommentiert
                '.ChartTitle.Font.Size = awinSettings.fontsizeTitle
                '.ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                '        titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend
            End If


        End With

        chtobj.Name = kennung

        appInstance.EnableEvents = formerEE



    End Sub


    ''' <summary>
    ''' zeigt die Entwicklung von Werten wie Personal-Kosten, Sonstige Kosten, Budget und Ergebnis an über die gesamte Projekt-Historie an 
    ''' Voraussetzung: die Projekt-Historie ist bestimmt 
    ''' </summary>
    ''' <param name="repObj">Verweis auf das erzeugte Chart</param>
    ''' <param name="top">Diagramm-Koordinate oben</param>
    ''' <param name="left">Diagramm-Koordinate links</param>
    ''' <param name="height">Diagramm-Höhe</param>
    ''' <param name="width">Diagramm-Breite</param>
    ''' <remarks></remarks>
    Public Sub createTrendKPI(ByRef repObj As Excel.ChartObject, ByVal top As Double, left As Double, height As Double, width As Double)

        Dim diagramTitle As String = " "
        Dim anzDiagrams As Integer
        Dim found As Boolean

        Dim i As Integer
        Dim Xdatenreihe() As String


        Dim chtTitle As String
        Dim pkIndex As Integer = CostDefinitions.Count

        Dim chtobj As Excel.ChartObject
        Dim ErgebnisListeR As New Collection

        Dim nrOFSnapshots As Integer = projekthistorie.Count

        If nrOFSnapshots = 0 Then
            Call MsgBox("es gibt keine Historie ...")
        End If

        Dim erloes() As Double
        Dim personalKosten() As Double
        Dim sonstKosten() As Double
        Dim risikoKosten() As Double
        Dim estimProfit() As Double



        Dim formerEE As Boolean = appInstance.EnableEvents
        'Dim formerSU As Boolean = appInstance.ScreenUpdating
        appInstance.EnableEvents = False
        'appInstance.ScreenUpdating = False

        ReDim erloes(nrOFSnapshots)
        ReDim personalKosten(nrOFSnapshots)
        ReDim sonstKosten(nrOFSnapshots)
        ReDim risikoKosten(nrOFSnapshots)
        ReDim estimProfit(nrOFSnapshots)
        ReDim Xdatenreihe(nrOFSnapshots)


        Dim pname As String = projekthistorie.Last.name

        'diagramTitle = "Planungs-Historie Kennzahlen " & vbLf & projekthistorie.Last.getShapeText
        diagramTitle = repMessages.getmsg(172) & vbLf & projekthistorie.Last.getShapeText


        ' jetzt werden die einzelnen Werte aufgefüllt
        Dim ix As Integer = 0
        For Each kvp As KeyValuePair(Of Date, clsProjekt) In projekthistorie.liste

            With kvp.Value
                erloes(ix) = .Erloes
                personalKosten(ix) = .getAllPersonalKosten.Sum
                sonstKosten(ix) = .getGesamtAndereKosten.Sum
                risikoKosten(ix) = .risikoKostenfaktor * (personalKosten(ix) + sonstKosten(ix))
                estimProfit(ix) = erloes(ix) - (personalKosten(ix) + sonstKosten(ix) + risikoKosten(ix))
                Xdatenreihe(ix) = .timeStamp.ToString("d")
            End With

            ix = ix + 1

        Next

        Dim hproj As clsProjekt = ShowProjekte.getProject(pname)
        With hproj
            erloes(nrOFSnapshots) = .Erloes
            personalKosten(nrOFSnapshots) = .getAllPersonalKosten.Sum
            sonstKosten(nrOFSnapshots) = .getGesamtAndereKosten.Sum
            risikoKosten(nrOFSnapshots) = .risikoKostenfaktor * (personalKosten(ix) + sonstKosten(ix))
            estimProfit(nrOFSnapshots) = erloes(ix) - (personalKosten(ix) + sonstKosten(ix) + risikoKosten(ix))
            Xdatenreihe(nrOFSnapshots) = .timeStamp.ToString("d")
        End With


        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            found = False
            While i <= anzDiagrams And Not found
                Try
                    chtTitle = CType(.ChartObjects(i), Excel.ChartObject).Chart.ChartTitle.Text
                Catch ex As Exception
                    chtTitle = " "
                End Try

                If chtTitle = diagramTitle Then
                    found = True

                Else
                    i = i + 1
                End If

            End While

            If found Then
                Call MsgBox("Chart wird bereits angezeigt ...")
                appInstance.EnableEvents = formerEE
                repObj = CType(.ChartObjects(i), Excel.ChartObject)
                'appInstance.ScreenUpdating = formerSU
                Exit Sub
            Else
                With appInstance.Charts.Add
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(.SeriesCollection.count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try

                    .HasAxis(Excel.XlAxisType.xlCategory) = True
                    .HasAxis(Excel.XlAxisType.xlValue) = True

                    With .Axes(Excel.XlAxisType.xlCategory)
                        .HasTitle = False
                        .TickLabelPosition = Excel.XlTickLabelPosition.xlTickLabelPositionHigh
                        '.MinimumScale = 0
                        'With .AxisTitle
                        '    .Characters.text = "Monate"
                        '    .Font.Size = 8
                        'End With
                    End With

                    With .Axes(Excel.XlAxisType.xlValue)
                        .HasTitle = False
                        .HasMajorGridlines = False
                        .HasMinorGridlines = False
                        '.MaximumScale = maxscale
                        '.MinimumScale = 0

                        'With .AxisTitle
                        '    .Characters.text = "Kosten"
                        '    .Font.Size = 8
                        'End With
                    End With

                    .HasLegend = True
                    With .Legend
                        .Position = Excel.Constants.xlRight
                        .Font.Size = awinSettings.fontsizeLegend
                    End With
                    .HasTitle = True
                    .ChartTitle.Text = diagramTitle
                    .ChartTitle.Font.Size = awinSettings.fontsizeTitle

                    Dim achieved As Boolean = False
                    Dim anzahlVersuche As Integer = 0
                    Dim errmsg As String = ""
                    Do While Not achieved And anzahlVersuche < 10
                        Try
                            'Call Sleep(100)
                            .Location(Where:=xlNS.XlChartLocation.xlLocationAsObject, Name:=CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Name)
                            achieved = True
                        Catch ex As Exception
                            errmsg = ex.Message
                            'Call Sleep(100)
                            anzahlVersuche = anzahlVersuche + 1
                        End Try
                    Loop

                    If Not achieved Then
                        Throw New ArgumentException("Chart-Fehler:" & errmsg)
                    End If


                    '.Location(Where:=XlChartLocation.xlLocationAsObject, Name:=appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)).name)

                End With

                chtobj = CType(.ChartObjects(anzDiagrams + 1), Excel.ChartObject)

            End If


            'Dim sc As Excel.Series
            'With sc
            '    .MarkerStyle = Excel.XlMarkerStyle.xlMarkerStyleSquare
            '    .MarkerSize = 5
            '    .MarkerForegroundColor = XlRgbColor.rgbDarkGreen
            '    .Format.Line.ForeColor.RGB = XlRgbColor.rgbDarkGreen
            'End With

            With chtobj.Chart

                ' hier werden jetzt die ganzen Series aufgebaut 
                ' Erloes
                With .SeriesCollection.NewSeries
                    .ChartType = Excel.XlChartType.xlLine
                    '.name = "Budget"
                    .name = repMessages.getmsg(173)
                    .Values = erloes
                    .XValues = Xdatenreihe
                    .MarkerStyle = Excel.XlMarkerStyle.xlMarkerStyleTriangle
                    .MarkerSize = 3
                    .MarkerForegroundColor = xlNS.XlRgbColor.rgbDarkGreen
                    With .Format.Line
                        .ForeColor.RGB = xlNS.XlRgbColor.rgbDarkGreen
                        .Weight = 3
                    End With


                End With

                ' Personalkosten
                With .SeriesCollection.NewSeries
                    .ChartType = Excel.XlChartType.xlLine
                    '.name = "Personalkosten"
                    .name = repMessages.getmsg(164)
                    '.Interior.color = farbeExterne
                    .Values = personalKosten
                    .XValues = Xdatenreihe
                    .MarkerStyle = Excel.XlMarkerStyle.xlMarkerStyleSquare
                    .MarkerSize = 3
                    .MarkerForegroundColor = xlNS.XlRgbColor.rgbDarkRed
                    With .Format.Line
                        .ForeColor.RGB = xlNS.XlRgbColor.rgbDarkRed
                        .Weight = 3
                    End With
                End With

                ' Sonstige Kosten
                With .SeriesCollection.NewSeries
                    '.name = "Sonstige Kosten"
                    .name = repMessages.getmsg(165)
                    '.Interior.color = farbeInternOP
                    .Values = sonstKosten
                    .XValues = Xdatenreihe
                    .ChartType = Excel.XlChartType.xlLine
                    .MarkerStyle = Excel.XlMarkerStyle.xlMarkerStyleCircle
                    .MarkerSize = 3
                    .MarkerForegroundColor = xlNS.XlRgbColor.rgbDarkOrange
                    With .Format.Line
                        .ForeColor.RGB = xlNS.XlRgbColor.rgbDarkOrange
                        .Weight = 3
                    End With
                End With

                ' Risiko Kosten
                With .SeriesCollection.NewSeries
                    '.name = "Risikokosten"
                    .name = repMessages.getmsg(174)
                    '.Interior.color = iProjektFarbe
                    .Values = risikoKosten
                    .XValues = Xdatenreihe
                    .ChartType = Excel.XlChartType.xlLine
                    .MarkerStyle = Excel.XlMarkerStyle.xlMarkerStyleDot
                    .MarkerSize = 3
                    .MarkerForegroundColor = xlNS.XlRgbColor.rgbLightGray
                    With .Format.Line
                        .ForeColor.RGB = xlNS.XlRgbColor.rgbLightGray
                        .Weight = 3
                    End With
                End With

                ' estim Profit
                With .SeriesCollection.NewSeries
                    '.name = "progn.Ergebnis"
                    .name = repMessages.getmsg(175)
                    '.Interior.color = ergebnisfarbe2
                    .Values = estimProfit
                    .XValues = Xdatenreihe
                    .ChartType = Excel.XlChartType.xlLine
                    .MarkerStyle = Excel.XlMarkerStyle.xlMarkerStyleDiamond
                    .MarkerSize = 5
                    .MarkerForegroundColor = xlNS.XlRgbColor.rgbDarkGreen
                    With .Format.Line
                        .ForeColor.RGB = xlNS.XlRgbColor.rgbDarkGreen
                        .Weight = 3
                    End With

                End With

            End With


            With chtobj
                .Top = top
                .Height = height
                .Left = left
                .Width = width
            End With

        End With

        repObj = chtobj

        'Call awinScrollintoView()
        appInstance.EnableEvents = formerEE
        'appInstance.ScreenUpdating = formerSU



    End Sub

    '
    ' 
    '
    ' 

    ''' <summary>
    ''' zeigt die Entwicklung des strategischen Fits / Risikos über die gesamte Projekt-Historie an 
    ''' Voraussetzung: die Projekt-Historie ist bestimmt 
    ''' </summary>
    ''' <param name="repObj">Verweis auf das erzeugte Chart</param>
    ''' <param name="top">Diagramm-Koordinate oben</param>
    ''' <param name="left">Diagramm-Koordinate links</param>
    ''' <param name="height">Diagramm-Höhe</param>
    ''' <param name="width">Diagramm-Breite</param>
    ''' <remarks></remarks>
    Public Sub createTrendSfit(ByRef repObj As Excel.ChartObject, ByVal top As Double, left As Double, height As Double, width As Double)

        Dim diagramTitle As String = " "
        Dim anzDiagrams As Integer
        Dim found As Boolean

        Dim i As Integer
        Dim Xdatenreihe() As String


        Dim chtTitle As String

        Dim chtobj As Excel.ChartObject
        Dim ErgebnisListeR As New Collection

        Dim nrOFSnapshots As Integer = projekthistorie.Count

        If nrOFSnapshots = 0 Then
            Exit Sub
            'Call MsgBox("es gibt keine Historie ...")
        End If

        Dim strategicFit() As Double
        Dim risiko() As Double




        Dim formerEE As Boolean = appInstance.EnableEvents
        'Dim formerSU As Boolean = appInstance.ScreenUpdating
        appInstance.EnableEvents = False
        'appInstance.ScreenUpdating = False

        ReDim strategicFit(nrOFSnapshots)
        ReDim risiko(nrOFSnapshots)
        ReDim Xdatenreihe(nrOFSnapshots)


        Dim pname As String = projekthistorie.Last.name

        'diagramTitle = "Planungs-Historie strategischer Fit & Risiko: " & vbLf & projekthistorie.Last.getShapeText
        diagramTitle = repMessages.getmsg(169) & vbLf & projekthistorie.Last.getShapeText


        ' jetzt werden die einzelnen Werte aufgefüllt
        Dim ix As Integer = 0
        For Each kvp As KeyValuePair(Of Date, clsProjekt) In projekthistorie.liste

            With kvp.Value
                strategicFit(ix) = .StrategicFit
                risiko(ix) = .Risiko
                Xdatenreihe(ix) = .timeStamp.ToString("d")
            End With

            ix = ix + 1

        Next

        Dim hproj As clsProjekt = ShowProjekte.getProject(pname)
        With hproj

            strategicFit(nrOFSnapshots) = .StrategicFit
            risiko(nrOFSnapshots) = .Risiko
            Xdatenreihe(nrOFSnapshots) = .timeStamp.ToString("d")

        End With


        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            found = False
            While i <= anzDiagrams And Not found
                Try
                    chtTitle = CType(.ChartObjects(i), Excel.ChartObject).Chart.ChartTitle.Text
                Catch ex As Exception
                    chtTitle = " "
                End Try

                If chtTitle = diagramTitle Then
                    found = True

                Else
                    i = i + 1
                End If

            End While

            If found Then
                Call MsgBox("Chart wird bereits angezeigt ...")
                appInstance.EnableEvents = formerEE
                'appInstance.ScreenUpdating = formerSU
                repObj = CType(.ChartObjects(i), Excel.ChartObject)
                Exit Sub
            Else
                With appInstance.Charts.Add
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(.SeriesCollection.count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try

                    .HasAxis(Excel.XlAxisType.xlCategory) = True
                    .HasAxis(Excel.XlAxisType.xlValue) = True

                    With .Axes(Excel.XlAxisType.xlCategory)
                        .HasTitle = False
                        .TickLabelPosition = Excel.XlTickLabelPosition.xlTickLabelPositionHigh
                        '.MinimumScale = 0
                        'With .AxisTitle
                        '    .Characters.text = "Monate"
                        '    .Font.Size = 8
                        'End With
                    End With


                    'Dim ax As Excel.Axis
                    'With ax
                    '    .HasMajorGridlines = False
                    '    .HasMinorGridlines = False
                    'End With
                    With .Axes(Excel.XlAxisType.xlValue)
                        .HasTitle = False
                        .HasMajorGridlines = False
                        .HasMinorGridlines = False
                        .MaximumScale = 11
                        .MinimumScale = 0

                        'With .AxisTitle
                        '    .Characters.text = "Kosten"
                        '    .Font.Size = 8
                        'End With
                    End With

                    .HasLegend = True
                    With .Legend
                        .Position = Excel.Constants.xlRight
                        .Font.Size = awinSettings.fontsizeLegend
                    End With
                    .HasTitle = True
                    .ChartTitle.Text = diagramTitle
                    .ChartTitle.Font.Size = awinSettings.fontsizeTitle

                    Dim achieved As Boolean = False
                    Dim anzahlVersuche As Integer = 0
                    Dim errmsg As String = ""
                    Do While Not achieved And anzahlVersuche < 10
                        Try
                            'Call Sleep(100)
                            .Location(Where:=xlNS.XlChartLocation.xlLocationAsObject, Name:=CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Name)
                            achieved = True
                        Catch ex As Exception
                            errmsg = ex.Message
                            'Call Sleep(100)
                            anzahlVersuche = anzahlVersuche + 1
                        End Try
                    Loop

                    If Not achieved Then
                        Throw New ArgumentException("Chart-Fehler:" & errmsg)
                    End If

                    '.Location(Where:=XlChartLocation.xlLocationAsObject, Name:=appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)).name)

                End With

                chtobj = CType(.ChartObjects(anzDiagrams + 1), Excel.ChartObject)

            End If


            'Dim sc As Excel.Series
            'With sc
            '    .MarkerStyle = Excel.XlMarkerStyle.xlMarkerStyleSquare
            '    .MarkerSize = 5
            '    .MarkerForegroundColor = XlRgbColor.rgbDarkGreen
            '    .Format.Line.ForeColor.RGB = XlRgbColor.rgbDarkGreen
            'End With

            With chtobj.Chart

                ' hier werden jetzt die ganzen Series aufgebaut 
                ' Erloes
                With .SeriesCollection.NewSeries
                    .ChartType = Excel.XlChartType.xlLine
                    '.name = "Strategischer Fit"
                    .name = repMessages.getmsg(170)
                    .Values = strategicFit
                    .XValues = Xdatenreihe
                    .MarkerStyle = Excel.XlMarkerStyle.xlMarkerStyleStar
                    .MarkerSize = 5
                    .MarkerForegroundColor = xlNS.XlRgbColor.rgbDarkGreen
                    With .Format.Line
                        .ForeColor.RGB = xlNS.XlRgbColor.rgbDarkGreen
                        .Weight = 3
                    End With


                End With

                ' Personalkosten
                With .SeriesCollection.NewSeries
                    .ChartType = Excel.XlChartType.xlLine
                    '.name = "Risiko"
                    .name = repMessages.getmsg(77)
                    '.Interior.color = farbeExterne
                    .Values = risiko
                    .XValues = Xdatenreihe
                    .MarkerStyle = Excel.XlMarkerStyle.xlMarkerStyleSquare
                    .MarkerSize = 5
                    .MarkerForegroundColor = xlNS.XlRgbColor.rgbDarkOrange
                    With .Format.Line
                        .ForeColor.RGB = xlNS.XlRgbColor.rgbDarkOrange
                        .Weight = 3
                    End With
                End With


            End With


            With chtobj
                .Top = top
                .Height = height
                .Left = left
                .Width = width
            End With

        End With

        repObj = chtobj

        'Call awinScrollintoView()
        appInstance.EnableEvents = formerEE
        'appInstance.ScreenUpdating = formerSU



    End Sub


    ''' <summary>
    ''' zeigt die Charakteristik aufgelöst nach den einzelnen Monaten 
    ''' wird momentan nicht benutzt !
    ''' </summary>
    ''' <param name="pname">Name des Projekts</param>
    ''' <param name="auswahl"></param>
    ''' <remarks></remarks>
    Public Sub createProjektErgebnisCharakteristik(ByVal pname As String, auswahl As Integer)

        Dim diagramTitle As String
        Dim anzDiagrams As Integer
        Dim found As Boolean
        Dim plen As Integer
        Dim i As Integer
        Dim minScale As Double
        Dim Xdatenreihe() As String
        Dim earnedValues() As Double
        Dim earnedValuesWeighted() As Double
        Dim riskValues() As Double
        Dim hsum(1) As Double, gesamtSumme As Double
        Dim top As Double, left As Double, width As Double, height As Double
        Dim chtTitle As String
        Dim pstart As Integer
        Dim mycollection As New Collection

        Dim hproj As clsProjekt
        Dim ErgebnisListeR As New Collection


        appInstance.EnableEvents = False
        appInstance.ScreenUpdating = False

        If auswahl = 1 Then
            diagramTitle = "Projekt Earned Value"
        ElseIf auswahl = 2 Then
            diagramTitle = "Projekt Earned Value mit Risiko-Abschlag"
        Else
            diagramTitle = pname
        End If

        hproj = ShowProjekte.getProject(pname)
        '
        ' hole die Projektdauer
        '
        plen = hproj.anzahlRasterElemente
        pstart = hproj.Start


        ReDim Xdatenreihe(plen - 1)
        ReDim earnedValues(plen - 1)
        ReDim earnedValuesWeighted(plen - 1)
        ReDim riskValues(plen - 1)



        For i = 1 To plen
            Xdatenreihe(i - 1) = StartofCalendar.AddMonths(pstart + i - 2).ToString("MMM yy", repCult)
        Next i


        ' neu 
        '
        ' die Position des Diagramms wird ausgerechnet ...
        '
        top = 48 + (hproj.tfZeile - 1) * 15
        left = (hproj.tfspalte - 1) * boxWidth - 5
        If left < 0 Then
            left = 0
        End If
        height = 180
        width = plen * boxWidth + 10


        gesamtSumme = 0

        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            found = False
            While i <= anzDiagrams And Not found
                Try
                    chtTitle = CType(.ChartObjects(i), Excel.ChartObject).Chart.ChartTitle.Text
                Catch ex As Exception
                    chtTitle = " "
                End Try
                If chtTitle = diagramTitle Then
                    found = True
                Else
                    i = i + 1
                End If

            End While

            If found Then
                MsgBox(" Diagramm wird bereits angezeigt ...")
            Else

                With appInstance.Charts.Add
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(.SeriesCollection.count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try

                    mycollection.Add(ergebnisChartName(0))
                    earnedValues = hproj.getBedarfeInMonths(mycollection, DiagrammTypen(4))
                    mycollection.Clear()

                    If auswahl = 1 Then
                        'minScale = earnedValues.Min
                        'mycollection.Clear()
                    ElseIf auswahl = 2 Then ' es sind die um die Risiko-Abschläge bereinigten Earned Values
                        mycollection.Add(ergebnisChartName(1))
                        earnedValues = hproj.getBedarfeInMonths(mycollection, DiagrammTypen(4))
                        mycollection.Clear()

                        mycollection.Add(ergebnisChartName(3))
                        riskValues = hproj.getBedarfeInMonths(mycollection, DiagrammTypen(4))
                        mycollection.Clear()


                    End If

                    minScale = earnedValues.Min

                    hsum(0) = 0
                    For i = 0 To plen - 1
                        hsum(0) = hsum(0) + earnedValues(i)
                    Next i
                    gesamtSumme = hsum(0)

                    If auswahl = 2 Then
                        hsum(1) = 0
                        For i = 0 To plen - 1
                            hsum(1) = hsum(1) + riskValues(i)
                        Next i
                        gesamtSumme = gesamtSumme + hsum(1)
                    End If


                    'series
                    With .SeriesCollection.NewSeries
                        If auswahl = 1 Then
                            .name = ergebnisChartName(0)
                        Else
                            .name = ergebnisChartName(1)
                        End If
                        .Interior.color = ergebnisfarbe1
                        .Values = earnedValues
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlColumnStacked
                    End With

                    'If auswahl = 2 Then
                    '    With .SeriesCollection.NewSeries
                    '        .name = "Risiko Abschlag"
                    '        .Interior.color = ergebnisfarbe2
                    '        .Values = riskValues
                    '        .XValues = Xdatenreihe
                    '        .ChartType = Excel.XlChartType.xlColumnStacked
                    '    End With
                    'End If


                    .HasAxis(Excel.XlAxisType.xlCategory) = True
                    .HasAxis(Excel.XlAxisType.xlValue) = True

                    With .Axes(Excel.XlAxisType.xlCategory)
                        .HasTitle = False
                        If minScale < 0 Then
                            .TickLabelPosition = Excel.Constants.xlLow
                        End If
                        '.MinimumScale = 0
                        'With .AxisTitle
                        '    .Characters.text = "Monate"
                        '    .Font.Size = 8
                        'End With
                    End With

                    With .Axes(Excel.XlAxisType.xlValue)
                        .HasTitle = False
                        If minScale < 0 Then
                            .MinimumScale = System.Math.Round(minScale - 1, mode:=MidpointRounding.ToEven)
                            '.AxisTitle.Position = Excel.XlChartElementPosition.xlChartElementPositionCustom
                            '.AxisTitle.Position = XlConstants.xlBottom
                        Else
                            .MinimumScale = 0
                        End If

                        'Dim hax As Excel.Axis
                        'With hax
                        '    .AxisTitle.Position = Excel.XlChartElementPosition.xlChartElementPositionCustom
                        'End With

                        'With .AxisTitle
                        '    If auswahl = 1 Then
                        '        .Characters.text = "Ressourcen"
                        '    Else
                        '        .Characters.text = "Personalkosten"
                        '    End If
                        '    .Font.Size = 8
                        'End With
                    End With

                    'If auswahl = 2 Then
                    '    .HasLegend = True
                    '    With .Legend
                    '        .Position = XlConstants.xlTop
                    '        .Font.Size = 8
                    '    End With
                    'Else
                    '    .HasLegend = False
                    'End If
                    .HasLegend = False
                    .HasTitle = True
                    diagramTitle = diagramTitle & " " & Format(hsum(0), "##,##0") & " T€" & vbLf & pname
                    .ChartTitle.Text = diagramTitle
                    .ChartTitle.font.size = 10

                    Dim achieved As Boolean = False
                    Dim anzahlVersuche As Integer = 0
                    Dim errmsg As String = ""
                    Do While Not achieved And anzahlVersuche < 10
                        Try
                            'Call Sleep(100)
                            .Location(Where:=xlNS.XlChartLocation.xlLocationAsObject, Name:=CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Name)
                            achieved = True
                        Catch ex As Exception
                            errmsg = ex.Message
                            'Call Sleep(100)
                            anzahlVersuche = anzahlVersuche + 1
                        End Try
                    Loop

                    If Not achieved Then
                        Throw New ArgumentException("Chart-Fehler:" & errmsg)
                    End If
                    '.Location(Where:=XlChartLocation.xlLocationAsObject, Name:=appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)).name)
                End With

                ' jetzt kommt die Korrektur der Größe; herausfinden, wieviel Raum die Axis Beschriftung einnimmt ... 
                With .ChartObjects(anzDiagrams + 1)
                    .top = top
                    .height = 2 * height

                    Dim axleft As Double, axwidth As Double
                    If .Chart.HasAxis(Excel.XlAxisType.xlValue) = True Then
                        With CType(.Chart.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                            axleft = .Left
                            axwidth = .Width
                        End With
                        If left - axwidth < 1 Then
                            left = 1
                            width = width + left + 9
                        Else
                            left = left - axwidth
                            width = width + axwidth + 9
                        End If

                    End If

                    .left = left
                    .width = width


                End With



            End If


        End With


        appInstance.EnableEvents = True
        appInstance.ScreenUpdating = True


    End Sub

    ''' <summary>
    ''' hier würde Risiko-Kosten noch berücksichtigt werden 
    ''' kann später mal wieder aktiviert werden ... 
    ''' diese Sub zeigt das vorauss. Projektergebnis in einem Chart an - Erloes, Risiko Kosten, Personalkosten, Sonstige Kosten und 
    ''' dann den vermutl. Projekt-Ertrag
    ''' auswahl: 0=beauftragung; 1: letzter Stand; 2: aktueller Stand   
    ''' </summary>
    ''' <param name="hproj">das Projekt</param>
    ''' <param name="reportObj">
    ''' nimmt den Verweis auf das generierte Chart auf; 
    ''' wird für das Reporting benötigt 
    ''' </param>
    ''' <remarks></remarks>
    Public Sub createProjektErgebnisCharakteristik2_deprecated(ByRef hproj As clsProjekt, ByRef reportObj As Excel.ChartObject, ByVal auswahl As Integer)

        Dim diagramTitle As String
        Dim anzDiagrams As Integer
        Dim found As Boolean
        Dim plen As Integer
        Dim i As Integer
        Dim minScale As Double
        Dim Xdatenreihe(4) As String
        Dim valueDatenreihe1(4) As Double
        Dim valueDatenreihe2(4) As Double
        Dim itemColor(4) As Object
        Dim itemValue(4) As Double
        Dim projektErloes As Double, projektPersKosten As Double, projektSonstKosten As Double, projektRisikoKosten As Double
        Dim projektErgebnis As Double
        'Dim earnedValueWeighted As Double
        Dim top As Double, left As Double, width As Double, height As Double
        Dim pstart As Integer
        Dim mycollection As New Collection
        'Dim catName As String
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim kennung As String
        Dim tmpcollection As New Collection


        tmpcollection.Add(hproj.name & "#" & auswahl.ToString)
        kennung = calcChartKennung("pr", PTprdk.Ergebnis, tmpcollection)


        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With


        'Xdatenreihe(0) = "Budget"
        'Xdatenreihe(1) = "Risiko-Abschlag"
        'Xdatenreihe(2) = "Personalkosten"
        'Xdatenreihe(3) = "Sonstige Kosten"
        'Xdatenreihe(4) = "Ergebnis-Prognose"
        Xdatenreihe(0) = repMessages.getmsg(49)
        Xdatenreihe(1) = repMessages.getmsg(50)
        Xdatenreihe(2) = repMessages.getmsg(51)
        Xdatenreihe(3) = repMessages.getmsg(52)
        Xdatenreihe(4) = repMessages.getmsg(53)



        With hproj

            .calculateRoundedKPI(projektErloes, projektPersKosten, projektSonstKosten, projektRisikoKosten, projektErgebnis)

            itemValue(0) = projektErloes
            itemColor(0) = ergebnisfarbe1

            itemValue(1) = projektRisikoKosten
            itemColor(1) = iProjektFarbe

            itemValue(2) = projektPersKosten
            itemColor(2) = farbeExterne

            itemValue(3) = projektSonstKosten
            itemColor(3) = farbeInternOP

            itemValue(4) = projektErgebnis
            If projektErgebnis > 0 Then
                itemColor(4) = ergebnisfarbe2
            Else
                itemColor(4) = farbeExterne
            End If
        End With


        If auswahl = PThis.beauftragung Then
            'titelTeile(0) = hproj.getShapeText & " (Beauftragung)" & vbLf & textZeitraum(pstart, pstart + plen - 1) & vbLf
            titelTeile(0) = hproj.getShapeText & repMessages.getmsg(47) & vbLf & textZeitraum(pstart, pstart + plen - 1) & vbLf
        ElseIf auswahl = PThis.letzterStand Then
            'titelTeile(0) = hproj.getShapeText & " (letzter Stand)" & vbLf & textZeitraum(pstart, pstart + plen - 1) & vbLf
            titelTeile(0) = hproj.getShapeText & repMessages.getmsg(48) & vbLf & textZeitraum(pstart, pstart + plen - 1) & vbLf
        Else
            titelTeile(0) = hproj.getShapeText & vbLf & textZeitraum(pstart, pstart + plen - 1) & vbLf
        End If

        titelTeilLaengen(0) = titelTeile(0).Length
        titelTeile(1) = " (" & hproj.timeStamp.ToString & ") "
        titelTeilLaengen(1) = titelTeile(1).Length

        diagramTitle = titelTeile(0) & titelTeile(1)
        'kennung = pname & "#Ergebnis#1"


        ' neu 
        '
        ' die Position des Diagramms wird ausgerechnet ...
        '
        top = topOfMagicBoard + hproj.tfZeile * boxHeight
        left = hproj.tfspalte * boxWidth - 10
        If left < 0 Then
            left = 1
        End If
        height = awinSettings.ChartHoehe2
        width = 450


        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count

            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            found = False
            While i <= anzDiagrams And Not found


                If kennung = .ChartObjects(i).name Then
                    found = True
                Else
                    i = i + 1
                End If

            End While


            Dim currentWert As Double
            If found Then
                reportObj = CType(.ChartObjects(i), Excel.ChartObject)
            Else

                If projektErgebnis < 0 Then
                    minScale = System.Math.Round(projektErgebnis, mode:=MidpointRounding.ToEven)
                Else
                    minScale = 0
                End If


                Dim valueCrossesNull As Boolean = False


                Dim newChart As Microsoft.Office.Interop.Excel.Chart = Nothing

                Dim achieved As Boolean = False
                Dim anzahlVersuche As Integer = 0

                Do While Not achieved And anzahlVersuche < 10
                    Try
                        newChart = CType(appInstance.Charts.Add, Microsoft.Office.Interop.Excel.Chart)
                        achieved = True
                    Catch ex As Exception
                        'Call Sleep(100)
                        anzahlVersuche = anzahlVersuche + 1
                    End Try
                Loop

                If Not achieved Then
                    Throw New ArgumentException("Chart konnte nicht erzeugt werden ...")
                End If

                With newChart
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(.SeriesCollection.count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try
                    Dim crossindex As Integer = -1

                    ' bestimmen des Anfangs  
                    Dim iv = 0
                    valueDatenreihe1(iv) = 0
                    valueDatenreihe2(iv) = itemValue(iv)
                    currentWert = itemValue(iv)

                    ' alle nächsten Zwischen-Werte 
                    Dim negativeFromNull As Boolean = False
                    Dim formerValue As Double = currentWert
                    For iv = 1 To 3
                        If formerValue <= 0 Then
                            negativeFromNull = True
                        Else
                            negativeFromNull = False
                        End If

                        currentWert = currentWert - itemValue(iv)
                        valueCrossesNull = (currentWert + itemValue(iv) > 0) And (currentWert < 0)

                        If currentWert >= 0 Then
                            valueDatenreihe1(iv) = currentWert
                            valueDatenreihe2(iv) = itemValue(iv)
                        ElseIf valueCrossesNull Then
                            valueDatenreihe1(iv) = currentWert
                            valueDatenreihe2(iv) = itemValue(iv) - currentWert * (-1) ' notwendig da currentWert ja negativ ist ..
                            crossindex = iv + 1
                        ElseIf negativeFromNull Then
                            valueDatenreihe1(iv) = formerValue
                            valueDatenreihe2(iv) = itemValue(iv) * (-1)
                        Else
                            valueDatenreihe1(iv) = currentWert
                            valueDatenreihe2(iv) = itemValue(iv) * (-1)
                        End If

                        formerValue = currentWert
                    Next

                    ' bestimmen des Ende 
                    iv = 4
                    valueDatenreihe1(iv) = 0
                    valueDatenreihe2(iv) = itemValue(iv)



                    'series
                    With .SeriesCollection.NewSeries
                        .name = "Bottom"
                        .HasDataLabels = False
                        .Interior.colorindex = -4142
                        .Values = valueDatenreihe1
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlColumnStacked
                        If crossindex > 0 Then
                            ' es gab einen Übergang , dort muss Bottom auf die entsprechende Farbe gesetzt werden 
                            With .Points(crossindex)
                                .Interior.color = itemColor(crossindex - 1)
                            End With
                        End If

                    End With

                    With .SeriesCollection.NewSeries
                        .name = "Top"
                        .HasDataLabels = True
                        .Values = valueDatenreihe2
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlColumnStacked

                        For iv = 0 To 4

                            With .Points(iv + 1)
                                .HasDataLabel = True
                                .DataLabel.text = Format(itemValue(iv), "###,###0") & " T€"
                                .Interior.color = itemColor(iv)
                                .DataLabel.Font.Size = awinSettings.fontsizeItems + 2
                                'Try
                                '    .DataLabel.Position = Excel.XlDataLabelPosition.xlLabelPositionAbove
                                'Catch ex As Exception

                                'End Try
                            End With

                        Next

                    End With

                    .HasAxis(Excel.XlAxisType.xlCategory) = True
                    .HasAxis(Excel.XlAxisType.xlValue) = False



                    With .Axes(Excel.XlAxisType.xlCategory)
                        .HasTitle = False
                        If minScale < 0 Then
                            .TickLabelPosition = Excel.Constants.xlLow
                        End If
                        '.MinimumScale = 0

                    End With

                    'Dim hax As Excel.Axis
                    'With hax
                    '    .HasMajorGridlines
                    '    .hasminor()
                    'End With

                    Try
                        With .Axes(Excel.XlAxisType.xlValue)
                            .HasTitle = False
                            .HasMajorGridlines = False
                            .hasminorgridlines = False
                            If minScale < 0 Then
                                .MinimumScale = System.Math.Round((minScale - 1), mode:=MidpointRounding.ToEven)
                            Else
                                .MinimumScale = 0
                            End If
                        End With
                    Catch ex As Exception

                    End Try


                    .HasLegend = False
                    'With .Legend
                    '    .Position = XlConstants.xlTop
                    '    .Font.Size = 8
                    'End With
                    .HasTitle = True

                    .ChartTitle.Text = diagramTitle
                    .ChartTitle.Font.Size = awinSettings.fontsizeTitle
                    .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                        titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend

                    achieved = False
                    anzahlVersuche = 0
                    Dim errmsg As String = ""
                    Do While Not achieved And anzahlVersuche < 10
                        Try
                            'Call Sleep(100)
                            newChart.Location(Where:=xlNS.XlChartLocation.xlLocationAsObject, Name:=appInstance.Workbooks.Item("Projectboard.xlsx").Worksheets(arrWsNames(ptTables.MPT)).name)
                            achieved = True
                        Catch ex As Exception
                            errmsg = ex.Message
                            'Call Sleep(100)
                            anzahlVersuche = anzahlVersuche + 1
                        End Try
                    Loop

                    If Not achieved Then
                        Throw New ArgumentException(errmsg)
                    End If


                End With



                With .ChartObjects(anzDiagrams + 1)
                    .top = top
                    .left = left
                    .width = width
                    .height = height
                    .name = kennung

                End With

                reportObj = CType(.ChartObjects(anzDiagrams + 1), Excel.ChartObject)


            End If


        End With





    End Sub

    ''' <summary>
    ''' diese Sub zeigt das vorauss. Projektergebnis in einem Chart an - Erloes, Risiko Kosten, Personalkosten, Sonstige Kosten und 
    ''' dann den vermutl. Projekt-Ertrag
    ''' auswahl: 0=beauftragung; 1: letzter Stand; 2: aktueller Stand  
    ''' top, left, width und height werden nur im Fall massEdit berücksichtigt, andernfalls bestimmt ... 
    ''' </summary>
    ''' <param name="hproj">das Projekt</param>
    ''' <param name="reportObj">
    ''' nimmt den Verweis auf das generierte Chart auf; 
    ''' wird für das Reporting benötigt 
    ''' </param>
    ''' <remarks></remarks>
    Public Sub createProjektErgebnisCharakteristik2(ByVal hproj As clsProjekt, ByRef reportObj As Excel.ChartObject, ByVal auswahl As Integer,
                                                    ByVal top As Double, ByVal left As Double, ByVal width As Double, ByVal height As Double,
                                                    ByVal calledFromReporting As Boolean,
                                                    Optional ByVal calledbyMassEdit As Boolean = False)

        Dim diagramTitle As String
        Dim anzDiagrams As Integer

        Dim plen As Integer
        Dim i As Integer
        Dim minScale As Double
        Dim Xdatenreihe(3) As String
        Dim valueDatenreihe1(3) As Double
        Dim valueDatenreihe2(3) As Double
        Dim itemColor(3) As Object
        Dim itemValue(3) As Double
        Dim projektErloes As Double, projektPersKosten As Double, projektSonstKosten As Double, projektRisikoKosten As Double
        Dim projektErgebnis As Double
        'Dim earnedValueWeighted As Double

        Dim pstart As Integer
        Dim mycollection As New Collection
        'Dim catName As String
        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim kennung As String
        Dim tmpcollection As New Collection
        Dim currentSheetName As String

        Dim maxlenTitle1 As Integer = 20

        Dim found As Boolean = False

        If visboZustaende.projectBoardMode = ptModus.graficboard Then
            If calledFromReporting Then
                currentSheetName = arrWsNames(ptTables.repCharts)
            Else
                currentSheetName = arrWsNames(ptTables.mptPrCharts)
            End If

        Else
            currentSheetName = arrWsNames(ptTables.meCharts)
        End If


        tmpcollection.Add(hproj.name & "#" & auswahl.ToString)
        kennung = calcChartKennung("pr", PTprdk.Ergebnis, tmpcollection)


        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With


        'Xdatenreihe(0) = "Budget"
        'Xdatenreihe(1) = "Risiko-Abschlag"
        'Xdatenreihe(2) = "Personalkosten"
        'Xdatenreihe(3) = "Sonstige Kosten"
        'Xdatenreihe(4) = "Ergebnis-Prognose"
        Xdatenreihe(0) = repMessages.getmsg(49)
        'Xdatenreihe(1) = repMessages.getmsg(50)
        Xdatenreihe(1) = repMessages.getmsg(51)
        Xdatenreihe(2) = repMessages.getmsg(52)
        Xdatenreihe(3) = repMessages.getmsg(53)


        With hproj

            .calculateRoundedKPI(projektErloes, projektPersKosten, projektSonstKosten, projektRisikoKosten, projektErgebnis)

            itemValue(0) = projektErloes
            itemColor(0) = ergebnisfarbe1

            'itemValue(1) = projektRisikoKosten
            'itemColor(1) = iProjektFarbe

            itemValue(1) = projektPersKosten
            itemColor(1) = farbeExterne

            itemValue(2) = projektSonstKosten
            itemColor(2) = farbeExterne

            itemValue(3) = projektErgebnis
            If projektErgebnis > 0 Then
                itemColor(3) = ergebnisfarbe2
            Else
                itemColor(3) = farbeExterne
            End If
        End With

        Dim projektTextTeil As String = ""
        Dim dauerTextTeil As String = ""

        If visboZustaende.projectBoardMode = ptModus.graficboard Then
            If calledFromReporting Then
                dauerTextTeil = vbLf & textZeitraum(pstart, pstart + plen - 1)
            Else
                dauerTextTeil = " " & textZeitraum(pstart, pstart + plen - 1)
            End If

        End If
        If calledFromReporting Then
            If auswahl = PThis.beauftragung Then
                'titelTeile(0) = hproj.getShapeText & " (Beauftragung)" & vbLf & textZeitraum(pstart, pstart + plen - 1) & vbLf
                projektTextTeil = hproj.getShapeText & repMessages.getmsg(47) & dauerTextTeil & vbLf
            ElseIf auswahl = PThis.letzterStand Then
                'titelTeile(0) = hproj.getShapeText & " (letzter Stand)" & vbLf & textZeitraum(pstart, pstart + plen - 1) & vbLf
                projektTextTeil = hproj.getShapeText & repMessages.getmsg(48) & dauerTextTeil & vbLf
            Else
                projektTextTeil = hproj.getShapeText & dauerTextTeil
            End If
        Else
            projektTextTeil = repMessages.getmsg(53)
            'If auswahl = PThis.beauftragung Then
            '    'titelTeile(0) = hproj.getShapeText & " (Beauftragung)" & vbLf & textZeitraum(pstart, pstart + plen - 1) & vbLf
            '    projektTextTeil = repMessages.getmsg(47) & dauerTextTeil
            'ElseIf auswahl = PThis.letzterStand Then
            '    'titelTeile(0) = hproj.getShapeText & " (letzter Stand)" & vbLf & textZeitraum(pstart, pstart + plen - 1) & vbLf
            '    projektTextTeil = repMessages.getmsg(48) & dauerTextTeil
            'Else
            '    projektTextTeil = hproj.getShapeText & dauerTextTeil
            'End If
        End If


        If hproj.endeDate < Date.Now Then
            titelTeile(0) = projektTextTeil
        Else
            titelTeile(0) = "Forecast " & projektTextTeil
        End If

        If visboZustaende.projectBoardMode = ptModus.graficboard And calledFromReporting Then
            titelTeile(1) = " (" & hproj.timeStamp.ToString & ") "
        Else
            titelTeile(1) = ""
        End If

        titelTeilLaengen(0) = titelTeile(0).Length
        titelTeilLaengen(1) = titelTeile(1).Length

        diagramTitle = titelTeile(0) & titelTeile(1)
        'kennung = pname & "#Ergebnis#1"



        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(currentSheetName), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count

            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            found = False
            While i <= anzDiagrams And Not found


                If kennung = .ChartObjects(i).name Then
                    found = True
                Else
                    i = i + 1
                End If

            End While


            Dim currentWert As Double
            If found Then
                reportObj = CType(.ChartObjects(i), Excel.ChartObject)
            Else

                If projektErgebnis < 0 Then
                    minScale = System.Math.Round(projektErgebnis, mode:=MidpointRounding.ToEven)
                Else
                    minScale = 0
                End If


                Dim valueCrossesNull As Boolean = False

                Dim newChtObj As Excel.ChartObject

                newChtObj = CType(CType(CType(appInstance.Workbooks.Item(myProjektTafel), Excel.Workbook).Worksheets.Item(currentSheetName),
                    Excel.Worksheet).ChartObjects, Excel.ChartObjects).Add(left, top, width, height)

                Dim newChart As Microsoft.Office.Interop.Excel.Chart = newChtObj.Chart


                With newChart
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(.SeriesCollection.count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try
                    Dim crossindex As Integer = -1

                    ' bestimmen des Anfangs  
                    Dim iv = 0
                    valueDatenreihe1(iv) = 0
                    valueDatenreihe2(iv) = itemValue(iv)
                    currentWert = itemValue(iv)

                    ' alle nächsten Zwischen-Werte 
                    Dim negativeFromNull As Boolean = False
                    Dim formerValue As Double = currentWert
                    For iv = 1 To 2
                        If formerValue <= 0 Then
                            negativeFromNull = True
                        Else
                            negativeFromNull = False
                        End If

                        currentWert = currentWert - itemValue(iv)
                        valueCrossesNull = (currentWert + itemValue(iv) > 0) And (currentWert < 0)

                        If currentWert >= 0 Then
                            valueDatenreihe1(iv) = currentWert
                            valueDatenreihe2(iv) = itemValue(iv)
                        ElseIf valueCrossesNull Then
                            valueDatenreihe1(iv) = currentWert
                            valueDatenreihe2(iv) = itemValue(iv) - currentWert * (-1) ' notwendig da currentWert ja negativ ist ..
                            crossindex = iv + 1
                        ElseIf negativeFromNull Then
                            valueDatenreihe1(iv) = formerValue
                            valueDatenreihe2(iv) = itemValue(iv) * (-1)
                        Else
                            valueDatenreihe1(iv) = currentWert
                            valueDatenreihe2(iv) = itemValue(iv) * (-1)
                        End If

                        formerValue = currentWert
                    Next

                    ' bestimmen des Ende 
                    iv = 3
                    valueDatenreihe1(iv) = 0
                    valueDatenreihe2(iv) = itemValue(iv)



                    'series
                    With .SeriesCollection.NewSeries
                        .name = "Bottom"
                        .HasDataLabels = False
                        .Interior.colorindex = -4142
                        .Values = valueDatenreihe1
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlColumnStacked
                        If crossindex > 0 Then
                            ' es gab einen Übergang , dort muss Bottom auf die entsprechende Farbe gesetzt werden 
                            With .Points(crossindex)
                                .Interior.color = itemColor(crossindex - 1)
                            End With
                        End If

                    End With

                    With .SeriesCollection.NewSeries
                        .name = "Top"
                        .HasDataLabels = True
                        .Values = valueDatenreihe2
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlColumnStacked

                        For iv = 0 To 3

                            With .Points(iv + 1)
                                .HasDataLabel = True
                                .DataLabel.text = Format(itemValue(iv), "###,###0") & " T€"
                                .Interior.color = itemColor(iv)
                                .DataLabel.Font.Size = awinSettings.fontsizeItems + 2
                                'Try
                                '    .DataLabel.Position = Excel.XlDataLabelPosition.xlLabelPositionAbove
                                'Catch ex As Exception

                                'End Try
                            End With

                        Next

                    End With

                    .HasAxis(Excel.XlAxisType.xlCategory) = True
                    .HasAxis(Excel.XlAxisType.xlValue) = False



                    With CType(.Axes(Excel.XlAxisType.xlCategory), Excel.Axis)
                        .HasTitle = False
                        If minScale < 0 Then
                            .TickLabelPosition = Excel.XlTickLabelPosition.xlTickLabelPositionLow
                        End If
                        .TickLabels.Font.Size = awinSettings.fontsizeLegend
                        '.MinimumScale = 0

                    End With


                    Try
                        With .Axes(Excel.XlAxisType.xlValue)
                            .HasTitle = False
                            .HasMajorGridlines = False
                            .hasminorgridlines = False
                            If minScale < 0 Then
                                .MinimumScale = System.Math.Round((minScale - 1), mode:=MidpointRounding.ToEven)
                            Else
                                .MinimumScale = 0
                            End If
                        End With
                    Catch ex As Exception

                    End Try


                    .HasLegend = False
                    'With .Legend
                    '    .Position = XlConstants.xlTop
                    '    .Font.Size = 8
                    'End With
                    .HasTitle = True

                    ' wenn es vom MassEdit aufgerufen wurde ... 
                    Dim offset As Integer = 0
                    If calledbyMassEdit Then
                        Dim oldlength As Integer = diagramTitle.Length
                        diagramTitle = "Forecast " & hproj.name & vbLf
                        offset = diagramTitle.Length - oldlength
                    End If

                    .ChartTitle.Text = diagramTitle
                    .ChartTitle.Font.Size = awinSettings.fontsizeTitle
                    .ChartTitle.Format.TextFrame2.TextRange.Characters(offset + titelTeilLaengen(0) + 1,
                        titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend


                End With



                'With .ChartObjects(anzDiagrams + 1)
                With newChtObj

                    .Name = kennung

                End With

                reportObj = newChtObj


            End If


        End With


    End Sub



    ''' <summary>
    ''' aktualisiert das Projekt Ergebnis Chart in einer PPT Datei  
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="chtobj"></param>
    ''' <remarks></remarks>
    Public Sub updatePPTProjektErgebnis(ByVal hproj As clsProjekt, ByRef chtobj As Excel.ChartObject)

        Dim xlsChart As Excel.Chart = chtobj.Chart
        'Dim diagramTitle As String
        Dim languageIsGerman As Boolean = False
        Dim plen As Integer
        Dim Xdatenreihe(3) As String
        Dim valueDatenreihe1(3) As Double
        Dim valueDatenreihe2(3) As Double
        Dim itemColor(3) As Object
        Dim itemValue(3) As Double
        Dim projektErloes As Double, projektPersKosten As Double, projektSonstKosten As Double, projektRisikoKosten As Double
        Dim projektErgebnis As Double

        Dim pstart As Integer
        Dim mycollection As New Collection
        Dim maxlenTitle1 As Integer = 20
        Dim fontSize1 As Double = 12, fontsize2 As Double = 8
        Dim minscale As Double

        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim tmpcollection As New Collection


        ' bestimme die Sprache  ...
        With xlsChart.ChartTitle.Format.TextFrame2
            If .HasText = core.MsoTriState.msoTrue Then
                If .TextRange.Text.Contains("Ergebnis") Then
                    languageIsGerman = True
                Else
                    languageIsGerman = False
                End If
            Else
                languageIsGerman = True
            End If
        End With



        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With

        ' das hier muss später wieder auf repMessages gesetzt werden ... 
        If languageIsGerman Then
            'Xdatenreihe(0) = repMessages.getmsg(49)
            Xdatenreihe(0) = "Budget"
            'Xdatenreihe(1) = repMessages.getmsg(50)
            Xdatenreihe(1) = "Personalkosten"
            'Xdatenreihe(2) = repMessages.getmsg(52)
            Xdatenreihe(2) = "sonstige Kosten"
            'Xdatenreihe(3) = repMessages.getmsg(53)
            'Xdatenreihe(3) = "Gewinn/Verlust"

        Else
            'Xdatenreihe(0) = repMessages.getmsg(49)
            Xdatenreihe(0) = "Budget"
            'Xdatenreihe(1) = repMessages.getmsg(50)
            Xdatenreihe(1) = "Personnel Cost"
            'Xdatenreihe(2) = repMessages.getmsg(52)
            Xdatenreihe(2) = "other Cost"
            'Xdatenreihe(3) = repMessages.getmsg(53)
            'Xdatenreihe(3) = "Profit/Loss"
        End If



        With hproj
            Dim gk As Double = .getSummeKosten

            .calculateRoundedKPI(projektErloes, projektPersKosten, projektSonstKosten, projektRisikoKosten, projektErgebnis)

            itemValue(0) = projektErloes
            'itemColor(0) = ergebnisfarbe1

            'itemValue(1) = projektRisikoKosten
            'itemColor(1) = iProjektFarbe

            itemValue(1) = projektPersKosten
            'itemColor(1) = farbeExterne

            itemValue(2) = projektSonstKosten
            'itemColor(2) = farbeExterne

            itemValue(3) = projektErgebnis
            If projektErgebnis >= 0 Then
                If languageIsGerman Then
                    Xdatenreihe(3) = "Gewinn"
                Else
                    Xdatenreihe(3) = "Profit"
                End If
                'itemColor(3) = ergebnisfarbe2
            Else
                If languageIsGerman Then
                    Xdatenreihe(3) = "Verlust"
                Else
                    Xdatenreihe(3) = "Loss"
                End If
                'itemColor(3) = farbeExterne
            End If
        End With

        Dim curMinScale As Double
        Dim curMaxScale As Double
        ' finde den aktuellen Scale heraus 
        ' damit nachher entschieden werden kann, ob Minimum bzw MaximumScale angepasst werden muss 
        Try
            With CType(xlsChart.Axes(Excel.XlAxisType.xlValue), Excel.Axis)

                curMinScale = .MinimumScale
                curMaxScale = .MaximumScale

                .MaximumScaleIsAuto = False
                .MinimumScaleIsAuto = False

            End With
        Catch ex As Exception

        End Try


        If projektErgebnis < 0 Then
            minscale = System.Math.Round(projektErgebnis - 5, mode:=MidpointRounding.ToEven)

            If projektErgebnis < -300 Then
                minscale = Math.Round(projektErgebnis / 50 - 0.6) * 50
            ElseIf projektErgebnis < -80 Then
                minscale = Math.Round(projektErgebnis / 10 - 0.6) * 10
            Else
                minscale = Math.Round(projektErgebnis / 5 - 0.6) * 5
            End If


        Else
            minscale = 0
        End If

        Dim currentWert As Double

        Dim valueCrossesNull As Boolean = False

        With xlsChart

            ' bestimmen der Fontsize Größen 
            Try
                If .HasTitle Then
                    Dim len As Integer = .ChartTitle.Text.Length
                    fontSize1 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=1, Length:=1).Font.Size
                    fontsize2 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=len - 1, Length:=1).Font.Size
                End If
            Catch ex As Exception

            End Try

            ' remove old series
            ' die old series darf nicht gelöscht werden, weil sonst die Farb- uind  sonstige Info weg ist ... 
            'Try
            '    Dim anz As Integer = CInt(CType(.SeriesCollection, pptNS.SeriesCollection).Count)
            '    Do While anz > 0
            '        .SeriesCollection(1).Delete()
            '        anz = anz - 1
            '    Loop
            'Catch ex As Exception

            'End Try

            Dim crossindex As Integer = -1

            ' bestimmen des Anfangs  
            Dim iv = 0
            valueDatenreihe1(iv) = 0
            valueDatenreihe2(iv) = itemValue(iv)
            currentWert = itemValue(iv)

            ' alle nächsten Zwischen-Werte 
            Dim negativeFromNull As Boolean = False
            Dim formerValue As Double = currentWert
            For iv = 1 To 2
                If formerValue <= 0 Then
                    negativeFromNull = True
                Else
                    negativeFromNull = False
                End If

                currentWert = currentWert - itemValue(iv)
                valueCrossesNull = (currentWert + itemValue(iv) > 0) And (currentWert < 0)

                If currentWert >= 0 Then
                    valueDatenreihe1(iv) = currentWert
                    valueDatenreihe2(iv) = itemValue(iv)
                ElseIf valueCrossesNull Then
                    valueDatenreihe1(iv) = currentWert
                    valueDatenreihe2(iv) = itemValue(iv) - currentWert * (-1) ' notwendig da currentWert ja negativ ist ..
                    crossindex = iv + 1
                ElseIf negativeFromNull Then
                    valueDatenreihe1(iv) = formerValue
                    valueDatenreihe2(iv) = itemValue(iv) * (-1)
                Else
                    valueDatenreihe1(iv) = currentWert
                    valueDatenreihe2(iv) = itemValue(iv) * (-1)
                End If

                formerValue = currentWert
            Next

            ' bestimmen des Ende 
            iv = 3
            valueDatenreihe1(iv) = 0
            valueDatenreihe2(iv) = itemValue(iv)

            ' bestimmen der Farben 
            With .SeriesCollection(2)
                For iv = 0 To 2

                    With .Points(iv + 1)
                        itemColor(iv) = .Interior.color
                    End With

                Next
                If projektErgebnis >= 0 Then
                    itemColor(3) = itemColor(0)
                Else
                    itemColor(3) = itemColor(1)
                End If
            End With


            'series
            'With .SeriesCollection.NewSeries
            With .SeriesCollection(1)
                .name = "Bottom"
                .HasDataLabels = False
                .Interior.colorindex = -4142
                .Values = valueDatenreihe1
                .XValues = Xdatenreihe

                If crossindex > 0 Then
                    ' es gab einen Übergang , dort muss Bottom auf die entsprechende Farbe gesetzt werden 
                    With .Points(crossindex)
                        .Interior.color = itemColor(crossindex - 1)
                    End With
                End If

            End With


            'With .SeriesCollection.NewSeries
            With .SeriesCollection(2)
                .name = "Top"
                .HasDataLabels = True
                .Values = valueDatenreihe2
                .XValues = Xdatenreihe
                '.ChartType = PowerPoint.XlChartType.xlColumnStacked

                For iv = 0 To 3

                    With .Points(iv + 1)
                        .HasDataLabel = True
                        .DataLabel.text = Format(itemValue(iv), "###,###0") & " T€"
                        .Interior.color = itemColor(iv)
                    End With

                Next

            End With


            Try
                With CType(.Axes(Excel.XlAxisType.xlValue), Excel.Axis)

                    ' hier muss sichergestellt werden, dass die Skalierung nur verändert wird, wenn notwendg
                    ' es muss für den Anwender ja vergleichbar sein .. 

                    If itemValue(0) > curMaxScale Then
                        .MaximumScale = itemValue(0)
                    End If

                    If itemValue(3) < curMinScale Then
                        .MinimumScale = itemValue(3)
                    End If


                End With
            Catch ex As Exception

            End Try


            'If .HasTitle Then
            '    .ChartTitle.Text = diagramTitle
            '    ' Änderung tk: wieder mit reingenmmen, da ja jetzt zu Beginn die fontsize1, ..2 bestimmt werden 
            '    .ChartTitle.Font.Size = CSng(fontSize1)
            '    .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
            '        titelTeilLaengen(1)).Font.Size = CSng(fontsize2)
            '    ' ur: 21.07.2014 für Chart-Cockpit auskommentiert
            '    '.ChartTitle.Font.Size = awinSettings.fontsizeTitle
            '    '.ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
            '    '        titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend
            'End If

        End With


    End Sub


    ''' <summary>
    ''' aktualisiert das Projekt Ergebnis Chart 
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="chtobj"></param>
    ''' <param name="auswahl"></param>
    ''' <param name="changeScale"></param>
    ''' <remarks></remarks>
    Public Sub updateProjektErgebnisCharakteristik2(ByVal hproj As clsProjekt, ByRef chtobj As Excel.ChartObject,
                                                        ByVal auswahl As Integer, ByVal changeScale As Boolean,
                                                    Optional ByVal calledFromMassEdit As Boolean = False)


        Dim diagramTitle As String

        Dim plen As Integer
        Dim Xdatenreihe(3) As String
        Dim valueDatenreihe1(3) As Double
        Dim valueDatenreihe2(3) As Double
        Dim itemColor(3) As Object
        Dim itemValue(3) As Double
        Dim projektErloes As Double, projektPersKosten As Double, projektSonstKosten As Double, projektRisikoKosten As Double
        Dim projektErgebnis As Double
        'Dim earnedValueWeighted As Double

        Dim pstart As Integer
        Dim mycollection As New Collection
        Dim maxlenTitle1 As Integer = 20

        Dim minscale As Double

        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim kennung As String
        Dim tmpcollection As New Collection

        Dim fontSize1 As Double = awinSettings.fontsizeTitle, fontSize2 As Double = awinSettings.fontsizeLegend

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False

        tmpcollection.Add(hproj.name & "#" & auswahl.ToString)
        kennung = calcChartKennung("pr", PTprdk.Ergebnis, tmpcollection)


        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With


        'Xdatenreihe(0) = "Budget"
        'Xdatenreihe(1) = "Risiko-Abschlag"
        'Xdatenreihe(2) = "Personalkosten"
        'Xdatenreihe(3) = "Sonstige Kosten"
        'Xdatenreihe(4) = "Ergebnis-Prognose"
        Xdatenreihe(0) = repMessages.getmsg(49)
        'Xdatenreihe(1) = repMessages.getmsg(50)
        Xdatenreihe(1) = repMessages.getmsg(51)
        Xdatenreihe(2) = repMessages.getmsg(52)
        Xdatenreihe(3) = repMessages.getmsg(53)
        'Xdatenreihe(4) = repMessages.getmsg(53)



        With hproj
            Dim gk As Double = .getSummeKosten

            .calculateRoundedKPI(projektErloes, projektPersKosten, projektSonstKosten, projektRisikoKosten, projektErgebnis)

            itemValue(0) = projektErloes
            itemColor(0) = ergebnisfarbe1

            'itemValue(1) = projektRisikoKosten
            'itemColor(1) = iProjektFarbe

            itemValue(1) = projektPersKosten
            itemColor(1) = farbeExterne

            itemValue(2) = projektSonstKosten
            itemColor(2) = farbeExterne

            itemValue(3) = projektErgebnis
            If projektErgebnis > 0 Then
                itemColor(3) = ergebnisfarbe2
            Else
                itemColor(3) = farbeExterne
            End If
        End With


        Dim projektTextTeil As String = ""
        Dim dauerTextTeil As String = ""
        If visboZustaende.projectBoardMode = ptModus.graficboard Then
            dauerTextTeil = " " & textZeitraum(pstart, pstart + plen - 1)
        End If

        projektTextTeil = repMessages.getmsg(53)


        If hproj.endeDate < Date.Now Then
            titelTeile(0) = projektTextTeil
        Else
            titelTeile(0) = "Forecast " & projektTextTeil
        End If


        titelTeile(1) = ""


        titelTeilLaengen(0) = titelTeile(0).Length
        titelTeilLaengen(1) = titelTeile(1).Length

        diagramTitle = titelTeile(0) & titelTeile(1)


        If changeScale Then
            If projektErgebnis < 0 Then
                minscale = System.Math.Round(projektErgebnis - 5, mode:=MidpointRounding.ToEven)

                If projektErgebnis < -300 Then
                    minscale = Math.Round(projektErgebnis / 50 - 0.6) * 50
                ElseIf projektErgebnis < -80 Then
                    minscale = Math.Round(projektErgebnis / 10 - 0.6) * 10
                Else
                    minscale = Math.Round(projektErgebnis / 5 - 0.6) * 5
                End If


            Else
                minscale = 0
            End If
        End If



        Dim currentWert As Double



        Dim valueCrossesNull As Boolean = False

        With chtobj.Chart

            ' bestimmen der Fontsize Größen 
            Try
                If .HasTitle Then
                    Dim len As Integer = .ChartTitle.Text.Length
                    fontSize1 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=1, Length:=1).Font.Size
                    fontSize2 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=len - 1, Length:=1).Font.Size
                End If
            Catch ex As Exception

            End Try

            ' remove old series
            Try
                Dim anz As Integer = CInt(CType(.SeriesCollection, Excel.SeriesCollection).Count)
                Do While anz > 0
                    .SeriesCollection(1).Delete()
                    anz = anz - 1
                Loop
            Catch ex As Exception

            End Try

            Dim crossindex As Integer = -1

            ' bestimmen des Anfangs  
            Dim iv = 0
            valueDatenreihe1(iv) = 0
            valueDatenreihe2(iv) = itemValue(iv)
            currentWert = itemValue(iv)

            ' alle nächsten Zwischen-Werte 
            Dim negativeFromNull As Boolean = False
            Dim formerValue As Double = currentWert
            For iv = 1 To 2
                If formerValue <= 0 Then
                    negativeFromNull = True
                Else
                    negativeFromNull = False
                End If

                currentWert = currentWert - itemValue(iv)
                valueCrossesNull = (currentWert + itemValue(iv) > 0) And (currentWert < 0)

                If currentWert >= 0 Then
                    valueDatenreihe1(iv) = currentWert
                    valueDatenreihe2(iv) = itemValue(iv)
                ElseIf valueCrossesNull Then
                    valueDatenreihe1(iv) = currentWert
                    valueDatenreihe2(iv) = itemValue(iv) - currentWert * (-1) ' notwendig da currentWert ja negativ ist ..
                    crossindex = iv + 1
                ElseIf negativeFromNull Then
                    valueDatenreihe1(iv) = formerValue
                    valueDatenreihe2(iv) = itemValue(iv) * (-1)
                Else
                    valueDatenreihe1(iv) = currentWert
                    valueDatenreihe2(iv) = itemValue(iv) * (-1)
                End If

                formerValue = currentWert
            Next

            ' bestimmen des Ende 
            iv = 3
            valueDatenreihe1(iv) = 0
            valueDatenreihe2(iv) = itemValue(iv)



            'series
            'With .SeriesCollection.NewSeries
            With .SeriesCollection.NewSeries
                .name = "Bottom"
                .HasDataLabels = False
                .Interior.colorindex = -4142
                .Values = valueDatenreihe1
                .XValues = Xdatenreihe
                .ChartType = Excel.XlChartType.xlColumnStacked
                If crossindex > 0 Then
                    ' es gab einen Übergang , dort muss Bottom auf die entsprechende Farbe gesetzt werden 
                    With .Points(crossindex)
                        .Interior.color = itemColor(crossindex - 1)
                    End With
                End If

            End With


            'With .SeriesCollection.NewSeries
            With .SeriesCollection.NewSeries
                .name = "Top"
                .HasDataLabels = True
                .Values = valueDatenreihe2
                .XValues = Xdatenreihe
                .ChartType = Excel.XlChartType.xlColumnStacked

                For iv = 0 To 3

                    With .Points(iv + 1)
                        .HasDataLabel = True
                        .DataLabel.text = Format(itemValue(iv), "###,###0") & " T€"
                        .Interior.color = itemColor(iv)
                        '.DataLabel.Font.Size = awinSettings.fontsizeItems + 2
                        'Try
                        '    .DataLabel.Position = Excel.XlDataLabelPosition.xlLabelPositionAbove
                        'Catch ex As Exception

                        'End Try
                    End With

                Next

            End With

            With .Axes(Excel.XlAxisType.xlCategory)
                .HasTitle = False
                If minscale < 0 Then
                    .TickLabelPosition = Excel.Constants.xlLow
                End If


            End With


            Try
                With .Axes(Excel.XlAxisType.xlValue)
                    .HasTitle = False
                    .HasMajorGridlines = False
                    .hasminorgridlines = False
                End With
            Catch ex As Exception

            End Try


            With CType(.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                ' das ist dann relevant, wenn ein anderes Projekt selektiert wird, das über die aktuelle Skalierung 
                ' hinausgehende Werte hat 
                'If Not (.MaximumScaleIsAuto) Then


                If changeScale Then


                    .MinimumScaleIsAuto = True
                    'If (minscale < .MinimumScale) And (minscale < 0) Then
                    '    .MinimumScale = minscale
                    'End If

                    .MaximumScaleIsAuto = True
                    'If itemValue(0) > .MaximumScale - 3 Then
                    '    .MaximumScale = itemValue(0) + 3
                    'End If

                End If

            End With

            If .HasTitle Then

                ' wenn es vom MassEdit aufgerufen wurde ... 
                Dim offset As Integer = 0
                If calledFromMassEdit Then
                    Dim oldlength As Integer = diagramTitle.Length
                    diagramTitle = "Forecast " & hproj.name & vbLf
                    offset = diagramTitle.Length - oldlength
                End If

                .ChartTitle.Text = diagramTitle
                ' Änderung tk: wieder mit reingenmmen, da ja jetzt zu Beginn die fontsize1, ..2 bestimmt werden 
                .ChartTitle.Font.Size = CSng(fontSize1)
                .ChartTitle.Format.TextFrame2.TextRange.Characters(offset + titelTeilLaengen(0) + 1,
                    titelTeilLaengen(1)).Font.Size = CSng(fontSize2)
                ' ur: 21.07.2014 für Chart-Cockpit auskommentiert
                '.ChartTitle.Font.Size = awinSettings.fontsizeTitle
                '.ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                '        titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend
            End If

        End With

        chtobj.Name = kennung

        appInstance.EnableEvents = formerEE

    End Sub

    ''' <summary>
    ''' wenn das mal wieder mit Risiko Kosten  verwendet werden soll ... 
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="chtobj"></param>
    ''' <param name="auswahl"></param>
    ''' <param name="changeScale"></param>
    ''' <remarks></remarks>
    Public Sub updateProjektErgebnisCharakteristik2_deprecated(ByRef hproj As clsProjekt, ByRef chtobj As Excel.ChartObject, _
                                                    ByVal auswahl As Integer, ByVal changeScale As Boolean)


        Dim diagramTitle As String

        Dim plen As Integer
        Dim Xdatenreihe(4) As String
        Dim valueDatenreihe1(4) As Double
        Dim valueDatenreihe2(4) As Double
        Dim itemColor(4) As Object
        Dim itemValue(4) As Double
        Dim projektErloes As Double, projektPersKosten As Double, projektSonstKosten As Double, projektRisikoKosten As Double
        Dim projektErgebnis As Double
        'Dim earnedValueWeighted As Double

        Dim pstart As Integer
        Dim mycollection As New Collection

        Dim minscale As Double

        Dim titelTeile(1) As String
        Dim titelTeilLaengen(1) As Integer
        Dim kennung As String
        Dim tmpcollection As New Collection

        Dim fontSize1 As Double = awinSettings.fontsizeTitle, fontSize2 As Double = awinSettings.fontsizeLegend

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False

        tmpcollection.Add(hproj.name & "#" & auswahl.ToString)
        kennung = calcChartKennung("pr", PTprdk.Ergebnis, tmpcollection)


        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With


        'Xdatenreihe(0) = "Budget"
        'Xdatenreihe(1) = "Risiko-Abschlag"
        'Xdatenreihe(2) = "Personalkosten"
        'Xdatenreihe(3) = "Sonstige Kosten"
        'Xdatenreihe(4) = "Ergebnis-Prognose"
        Xdatenreihe(0) = repMessages.getmsg(49)
        Xdatenreihe(1) = repMessages.getmsg(50)
        Xdatenreihe(2) = repMessages.getmsg(51)
        Xdatenreihe(3) = repMessages.getmsg(52)
        Xdatenreihe(4) = repMessages.getmsg(53)



        With hproj
            Dim gk As Double = .getSummeKosten

            .calculateRoundedKPI(projektErloes, projektPersKosten, projektSonstKosten, projektRisikoKosten, projektErgebnis)

            itemValue(0) = projektErloes
            itemColor(0) = ergebnisfarbe1

            itemValue(1) = projektRisikoKosten
            itemColor(1) = iProjektFarbe

            itemValue(2) = projektPersKosten
            itemColor(2) = farbeExterne

            itemValue(3) = projektSonstKosten
            itemColor(3) = farbeInternOP

            itemValue(4) = projektErgebnis
            If projektErgebnis > 0 Then
                itemColor(4) = ergebnisfarbe2
            Else
                itemColor(4) = farbeExterne
            End If
        End With



        titelTeile(0) = hproj.getShapeText & vbLf & textZeitraum(pstart, pstart + plen - 1) & vbLf
        titelTeilLaengen(0) = titelTeile(0).Length
        titelTeile(1) = " (" & hproj.timeStamp.ToString & ") "
        titelTeilLaengen(1) = titelTeile(1).Length
        diagramTitle = titelTeile(0) & titelTeile(1)
        'kennung = pname & "#Ergebnis#1"


        If changeScale Then
            If projektErgebnis < 0 Then
                minscale = System.Math.Round(projektErgebnis - 5, mode:=MidpointRounding.ToEven)

                If projektErgebnis < -300 Then
                    minscale = Math.Round(projektErgebnis / 50 - 0.6) * 50
                ElseIf projektErgebnis < -80 Then
                    minscale = Math.Round(projektErgebnis / 10 - 0.6) * 10
                Else
                    minscale = Math.Round(projektErgebnis / 5 - 0.6) * 5
                End If


            Else
                minscale = 0
            End If
        End If



        Dim currentWert As Double



        Dim valueCrossesNull As Boolean = False

        With chtobj.Chart

            ' bestimmen der Fontsize Größen 
            Try
                If .HasTitle Then
                    Dim len As Integer = .ChartTitle.Text.Length
                    fontSize1 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=1, Length:=1).Font.Size
                    fontSize2 = .ChartTitle.Format.TextFrame2.TextRange.Characters(Start:=len - 1, Length:=1).Font.Size
                End If
            Catch ex As Exception

            End Try

            'ur:22.07.2014: bereits in Charts enthalten und soll nur mit neuen Daten bestückt werden
            '' remove extra series

            'Do Until .SeriesCollection.Count = 0
            '    .SeriesCollection(1).Delete()
            'Loop

            Dim crossindex As Integer = -1

            ' bestimmen des Anfangs  
            Dim iv = 0
            valueDatenreihe1(iv) = 0
            valueDatenreihe2(iv) = itemValue(iv)
            currentWert = itemValue(iv)

            ' alle nächsten Zwischen-Werte 
            Dim negativeFromNull As Boolean = False
            Dim formerValue As Double = currentWert
            For iv = 1 To 3
                If formerValue <= 0 Then
                    negativeFromNull = True
                Else
                    negativeFromNull = False
                End If

                currentWert = currentWert - itemValue(iv)
                valueCrossesNull = (currentWert + itemValue(iv) > 0) And (currentWert < 0)

                If currentWert >= 0 Then
                    valueDatenreihe1(iv) = currentWert
                    valueDatenreihe2(iv) = itemValue(iv)
                ElseIf valueCrossesNull Then
                    valueDatenreihe1(iv) = currentWert
                    valueDatenreihe2(iv) = itemValue(iv) - currentWert * (-1) ' notwendig da currentWert ja negativ ist ..
                    crossindex = iv + 1
                ElseIf negativeFromNull Then
                    valueDatenreihe1(iv) = formerValue
                    valueDatenreihe2(iv) = itemValue(iv) * (-1)
                Else
                    valueDatenreihe1(iv) = currentWert
                    valueDatenreihe2(iv) = itemValue(iv) * (-1)
                End If

                formerValue = currentWert
            Next

            ' bestimmen des Ende 
            iv = 4
            valueDatenreihe1(iv) = 0
            valueDatenreihe2(iv) = itemValue(iv)



            'series
            'With .SeriesCollection.NewSeries
            With .SeriesCollection(1)
                .name = "Bottom"
                .HasDataLabels = False
                .Interior.colorindex = -4142
                .Values = valueDatenreihe1
                .XValues = Xdatenreihe
                .ChartType = Excel.XlChartType.xlColumnStacked
                If crossindex > 0 Then
                    ' es gab einen Übergang , dort muss Bottom auf die entsprechende Farbe gesetzt werden 
                    With .Points(crossindex)
                        .Interior.color = itemColor(crossindex - 1)
                    End With
                End If

            End With


            'With .SeriesCollection.NewSeries
            With .SeriesCollection(2)
                .name = "Top"
                .HasDataLabels = True
                .Values = valueDatenreihe2
                .XValues = Xdatenreihe
                .ChartType = Excel.XlChartType.xlColumnStacked

                For iv = 0 To 4

                    With .Points(iv + 1)
                        .HasDataLabel = True
                        .DataLabel.text = Format(itemValue(iv), "###,###0") & " T€"
                        .Interior.color = itemColor(iv)
                        '.DataLabel.Font.Size = awinSettings.fontsizeItems + 2
                        'Try
                        '    .DataLabel.Position = Excel.XlDataLabelPosition.xlLabelPositionAbove
                        'Catch ex As Exception

                        'End Try
                    End With

                Next

            End With

            With .Axes(Excel.XlAxisType.xlCategory)
                .HasTitle = False
                If minscale < 0 Then
                    .TickLabelPosition = Excel.Constants.xlLow
                End If


            End With


            Try
                With .Axes(Excel.XlAxisType.xlValue)
                    .HasTitle = False
                    .HasMajorGridlines = False
                    .hasminorgridlines = False
                End With
            Catch ex As Exception

            End Try


            With CType(.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                ' das ist dann relevant, wenn ein anderes Projekt selektiert wird, das über die aktuelle Skalierung 
                ' hinausgehende Werte hat 
                'If Not (.MaximumScaleIsAuto) Then


                If changeScale Then

                    .MinimumScaleIsAuto = False
                    If (minscale < .MinimumScale) And (minscale < 0) Then
                        .MinimumScale = minscale
                    End If

                    .MaximumScaleIsAuto = False
                    If itemValue(0) > .MaximumScale - 3 Then
                        .MaximumScale = itemValue(0) + 3
                    End If


                    'If Not (.MinimumScaleIsAuto) Then
                    '    If (minscale < .MinimumScale) And (minscale < 0) Then
                    '        .MinimumScale = minscale
                    '    End If
                    '    .MinimumScaleIsAuto = True
                    'End If


                    'If Not (.MaximumScaleIsAuto) Then

                    '    'If itemValue(0) > .MaximumScale - 3 Then
                    '    '    .MaximumScale = itemValue(0) + 3
                    '    'End If

                    '    If itemValue(0) > .MaximumScale Then
                    '        If itemValue(0) < 80 Then
                    '            .MaximumScale = Math.Round(itemValue(0) / 5 + 0.6) * 5
                    '        ElseIf itemValue(0) < 300 Then
                    '            .MaximumScale = Math.Round(itemValue(0) / 10 + 0.6) * 10
                    '        Else
                    '            .MaximumScale = Math.Round(itemValue(0) / 50 + 0.6) * 50
                    '        End If
                    '    End If


                    '    .MaximumScaleIsAuto = True
                    'End If
                End If

            End With

            If .HasTitle Then
                .ChartTitle.Text = diagramTitle
                ' Änderung tk: wieder mit reingenmmen, da ja jetzt zu Beginn die fontsize1, ..2 bestimmt werden 
                .ChartTitle.Font.Size = CSng(fontSize1)
                .ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                    titelTeilLaengen(1)).Font.Size = CSng(fontSize2)
                ' ur: 21.07.2014 für Chart-Cockpit auskommentiert
                '.ChartTitle.Font.Size = awinSettings.fontsizeTitle
                '.ChartTitle.Format.TextFrame2.TextRange.Characters(titelTeilLaengen(0) + 1, _
                '        titelTeilLaengen(1)).Font.Size = awinSettings.fontsizeLegend
            End If

        End With

        chtobj.Name = kennung

        appInstance.EnableEvents = formerEE

    End Sub


    '
    ' Sub trägt ein individuelles Projekt ein
    '
    ''' <summary>
    ''' trägt ein neues Projekt in Showprojekte ein
    ''' </summary>
    ''' <param name="pname">Projektname</param>
    ''' <param name="vorlagenName">Vorlagen-Name</param>
    ''' <param name="startdate">Start-Datum des PRojekts</param>
    ''' <param name="budgetVorgabe">Budget des Projekts</param>
    ''' <param name="tafelZeile">
    ''' in welcher Zeile der Projekt-Tafel soll es gezeichnet werden; 
    ''' 0:= finde eine geeignete Stelle
    ''' </param>
    ''' <param name="sfit">Wert für den strategischen Fit</param>
    ''' <param name="risk">Wert für das Risiko</param>
    ''' <param name="profitUserAskedFor">der Ergebnis Forecast in Prozent der Gesamtkosten, den der Nutzer gerne sehen möchte</param>
    ''' <remarks></remarks>
    Public Sub TrageivProjektein(ByVal pname As String, ByVal vorlagenName As String, ByVal startdate As Date,
                                 ByVal endedate As Date, ByVal budgetVorgabe As Double,
                                 ByVal tafelZeile As Integer, ByVal sfit As Double, ByVal risk As Double, ByVal profitUserAskedFor As String,
                                 ByVal kurzBeschreibung As String, ByVal kdNummer As String)

        Dim hproj As clsProjekt = Nothing

        hproj = erstelleProjektAusVorlage(pname, vorlagenName, startdate, endedate, budgetVorgabe,
                                  tafelZeile, sfit, risk, profitUserAskedFor,
                                  kurzBeschreibung, "", kdNr:=kdNummer)



        Dim formerEE As Boolean = appInstance.EnableEvents
        Dim formerSU As Boolean = appInstance.ScreenUpdating
        appInstance.EnableEvents = False
        appInstance.ScreenUpdating = False

        If Not AlleProjekte.hasAnyConflictsWith(calcProjektKey(hproj.name, hproj.variantName), False) Then

            Try
                AlleProjekte.Add(hproj)
            Catch ex As Exception

            End Try

            Try
                ShowProjekte.Add(hproj)
                ' hier ist im hproj das attribut shpUID gesetzt , deswegen muss nicht extra AddShape aufgerufen werden 
            Catch ex As Exception

            End Try

            ' wenn bestimmte Projekte beim Suchen nach einem Platz nicht berücksichtigt werden sollen,
            ' dann müssen sie in einer Collection an ZeichneProjektinPlanTafel übergeben werden 
            Dim tmpCollection As New Collection

            '
            'Call awinClearPlanTafel()
            'Call awinZeichnePlanTafel(True)

            Dim pZeile As Integer = projectboardShapes.getMaxZeile
            Call ZeichneProjektinPlanTafel(tmpCollection, pname, pZeile, tmpCollection, tmpCollection)



            ' ein Projekt wurde eingefügt  - typus = 2
            Call awinNeuZeichnenDiagramme(2)

        Else
            Call MsgBox("Konflikte mit Summary Projekten")
        End If



        ' Call diagramsVisible("True")
        appInstance.ScreenUpdating = formerSU
        appInstance.EnableEvents = formerEE

    End Sub
    ''' <summary>
    ''' legt mit den entsprechenden Angaben ein neues Projekt auf Basis der Vorlage an 
    ''' </summary>
    ''' <param name="pname"></param>
    ''' <param name="vorlagenName">Name der Projekt-Vorlage, die verwendet werden soll </param>
    ''' <param name="startdate">Startdatum</param>
    ''' <param name="endedate">Ende-Datum</param>
    ''' <param name="budgetVorgabe">Budget in T€, darf nicht negativ sein</param>
    ''' <param name="tafelZeile"></param>
    ''' <param name="sfit">Integer Wert für Strategie KPI, zwischen 1 und 9 </param>
    ''' <param name="risk">Integer Wert für Risiko KPI, zwischen 1 und 9</param>
    ''' <param name="profitUserAskedFor">Nothing oder positiver Wert zwischen 0 und 1, 0.1 heisst 10%</param>
    ''' <param name="kurzBeschreibung">Kurzbeschreibung des Projektes</param>
    ''' <param name="kdNr">Frei-Text für vom Kunden vergebene Projekt-Nummer; wird beim Input auf Zulässigkeit überprüft  </param>
    ''' <returns></returns>
    Public Function erstelleProjektAusVorlage(ByVal pname As String, ByVal vorlagenName As String, ByVal startdate As Date,
                                ByVal endedate As Date, ByVal budgetVorgabe As Double,
                                ByVal tafelZeile As Integer, ByVal sfit As Double, ByVal risk As Double, ByVal profitUserAskedFor As String,
                                ByVal kurzBeschreibung As String, ByVal buName As String, Optional ByVal kdNr As String = "") As clsProjekt
        Dim newprojekt As Boolean
        Dim hproj As clsProjekt
        Dim pStatus As String = ProjektStatus(0)
        Dim zeile As Integer = tafelZeile
        'Dim spalte As Integer = start
        Dim plen As Integer
        'Dim top As Double, left As Double, width As Double, height As Double
        'Dim shpElement As Excel.Shape
        Dim pcolor As Object
        Dim heute As Date = Date.Now
        Dim heute1 As Date = Now
        Dim key As String = pname & "#"
        Dim ms As Long = heute.Millisecond
        Dim zielrenditenVorgabe As Double = Nothing
        Dim zielrenditenVorgabe1 As Double = Nothing
        Dim zielrenditenVorgabe2 As Double = Nothing
        newprojekt = True

        '
        ' ein neues Projekt wird als Objekt angelegt ....
        '

        hproj = New clsProjekt

        If Projektvorlagen.Contains(vorlagenName) Then
            ' jetzt wird bestimmt, ob es eine Zielrenditen Vorgabe gibt ... 
            If IsNothing(profitUserAskedFor) Then
                ' nichts weiter tun ... zielrenditenVorgabe ist mit Nothing besetzt 
            Else
                If IsNumeric(profitUserAskedFor) Then
                    Dim referenceBudget As Double = Projektvorlagen.getProject(vorlagenName).getSummeKosten
                    If referenceBudget > 0 Then
                        'Dim verfuegbaresBudget As Double = budgetVorgabe / (CDbl(profitUserAskedFor) / 100 + 1)
                        'zielrenditenVorgabe = verfuegbaresBudget / referenceBudget
                        'zielrenditenVorgabe1 = (budgetVorgabe * (CDbl(profitUserAskedFor) / 100 + 1)) / referenceBudget
                        zielrenditenVorgabe = (budgetVorgabe * (1 - CDbl(profitUserAskedFor) / 100)) / referenceBudget
                    End If

                Else
                    Call MsgBox("keine zulässige Renditen Angabe ...")
                    erstelleProjektAusVorlage = Nothing
                    Exit Function
                End If
            End If
        Else
            Call MsgBox("es gibt keine entsprechende Vorlage: " & vorlagenName)
            erstelleProjektAusVorlage = Nothing
            Exit Function
        End If


        Try
            ' Projektdauer wurde durch Start- und Endedatum im Formular angegeben
            Projektvorlagen.getProject(vorlagenName).korrCopyTo(hproj, startdate, endedate, zielrenditenVorgabe)

        Catch ex As Exception
            Call MsgBox("es gibt keine entsprechende Vorlage ..")
            erstelleProjektAusVorlage = Nothing
            Exit Function
        End Try


        Try
            With hproj
                .name = pname
                .VorlagenName = vorlagenName
                .startDate = startdate
                .kundenNummer = kdNr
                .businessUnit = buName
                .Erloes = budgetVorgabe
                .earliestStartDate = .startDate.AddMonths(.earliestStart)
                .latestStartDate = .startDate.AddMonths(.latestStart)
                .Status = ProjektStatus(PTProjektStati.geplant)
                .description = kurzBeschreibung

                .StrategicFit = sfit
                .Risiko = risk
                plen = .anzahlRasterElemente
                pcolor = .farbe
            End With


            ' nächste Zeile ist ein work-around für Fehler Der Index liegt außerhalb der Array-Grenzen
            ' workaround
            Dim tmpdata As Integer = hproj.dauerInDays
            'Call awinCreateBudgetWerte(hproj)

        Catch ex As Exception
            Call MsgBox(ex.Message)
            erstelleProjektAusVorlage = Nothing
            Exit Function
        End Try

        ' Anpassen der Daten für die Termine 
        ' wenn Samstag oder Sonntag, dann auf den Freitag davor legen 
        ' nein - das darf nicht gemacht werden; evtl liegt ja dann der Meilenstein vor der Phase 
        ' grundsätzlich sollte der Anwender hier bestimmen, nicht das Programm


        '
        ' Ende Objekt Anlage
        erstelleProjektAusVorlage = hproj

    End Function

    ''' <summary>
    ''' erstellt ein Projekt aus den angegebenen Parametern
    ''' </summary>
    ''' <param name="pName"></param>
    ''' <param name="vName"></param>
    ''' <param name="vorlagenName"></param>
    ''' <param name="startDate"></param>
    ''' <param name="endDate"></param>
    ''' <param name="budget"></param>
    ''' <param name="sfit"></param>
    ''' <param name="risk"></param>
    ''' <param name="projectNummer"></param>
    ''' <param name="description"></param>
    ''' <param name="listOfCustomFields"></param>
    ''' <param name="businessUnit"></param>
    ''' <param name="responsible"></param>
    ''' <param name="status"></param>
    ''' <param name="zeile"></param>
    ''' <param name="roleNames"></param>
    ''' <param name="roleValues"></param>
    ''' <param name="costNames"></param>
    ''' <param name="costValues"></param>
    ''' <param name="phNames"></param>
    ''' <param name="przPhasenAnteile"></param>
    ''' <returns></returns>
    Public Function erstelleProjektausParametern(ByVal pName As String, ByVal vName As String, ByVal vorlagenName As String,
                                                 ByVal startDate As Date, ByVal endDate As Date,
                                                 ByVal budget As Double, ByVal sfit As Double, ByVal risk As Double,
                                                 ByVal projectNummer As String, ByVal description As String, ByVal listOfCustomFields As Collection,
                                                 ByVal businessUnit As String, ByVal responsible As String, ByVal status As String, ByVal zeile As Integer,
                                                 ByVal roleNames() As String, ByVal roleValues() As Double,
                                                 ByVal costNames() As String, ByVal costValues() As Double,
                                                 ByVal phNames() As String, ByVal przPhasenAnteile() As Double,
                                                 ByVal combinedName As Boolean)

        Dim hproj As clsProjekt = New clsProjekt

        ' gibt an, ob es überhaupt eine Rolle oder Kostenart gibt mit Bedarf > 0 
        Dim atleastOneRC As Boolean = False

        If Not IsNothing(roleValues) Then
            atleastOneRC = roleValues.Sum > 0
        End If

        If Not IsNothing(costValues) And Not atleastOneRC Then
            atleastOneRC = costValues.Sum > 0
        End If

        ' wenn kein Wert angegeben ist, soll was verwendet werden?
        If status = "" Then
            status = ProjektStatus(0)
        End If

        Try
            Projektvorlagen.getProject(vorlagenName).korrCopyTo(hproj, startDate, endDate)
        Catch ex As Exception
            Call MsgBox("es gibt keine entsprechende Vorlage ..")
            erstelleProjektausParametern = Nothing
            Exit Function
        End Try

        ' jetzt ist in hproj ein neues Projekt mit entsprechendem Name, etc. 
        Try
            With hproj

                If combinedName Then
                    If Not IsNothing(projectNummer) Then
                        .name = projectNummer.Trim & "_" & pName
                    Else
                        .name = "_" & pName
                    End If
                Else
                    .name = pName
                End If

                .variantName = vName
                .kundenNummer = projectNummer
                .getPhase(1).nameID = rootPhaseName
                .VorlagenName = vorlagenName
                .startDate = startDate
                .earliestStartDate = .startDate.AddMonths(.earliestStart)
                .latestStartDate = .startDate.AddMonths(.latestStart)
                ' jedes Projekt zu Beginn als beauftragtes Projekt importieren
                .Status = status
                .StrategicFit = sfit
                .Risiko = risk

                .leadPerson = responsible
                .businessUnit = businessUnit
                .description = description
                .tfZeile = zeile
                If budget > 0 Then
                    .Erloes = budget
                    ' andernfalls wird es ganz am Schluss berechnet ...
                Else
                    .Erloes = 0
                End If


            End With
        Catch ex As Exception
            Throw New Exception("in erstelle InventurProjekte: " & ex.Message)
        End Try

        ' jetzt müssen die Rollen und Kostenarten besetzt werden  
        If atleastOneRC Then
            If przPhasenAnteile.Sum >= 0.99 Then
                ' der Gesamt-Wert der Rollen soll auf die entsprechenden Phasen aufgeteilt werden 
                Dim anzPhasen As Integer = phNames.Length

                For p = 0 To anzPhasen - 1

                    Dim tmpPhName As String = phNames(p)
                    Dim cphase As clsPhase = hproj.getPhase(tmpPhName)

                    If Not IsNothing(cphase) Then
                        If przPhasenAnteile(p) > 0 Then
                            Call cphase.addCostsAndRoles(roleNames, roleValues, costNames, costValues, przPhasenAnteile(p))
                        End If
                    End If


                Next
            Else
                ' der Gesamt-Wert der Rollen soll auf die RootPhase aufgeteilt werden
                Dim cphase As clsPhase = hproj.getPhase(1)
                If Not IsNothing(cphase) Then
                    Call cphase.addCostsAndRoles(roleNames, roleValues, costNames, costValues)
                End If
            End If
        End If


        ' jetzt ggf die Custom Fields eintragen 
        hproj.addListOfCustomFields(listOfCustomFields)

        ' jetzt das Budget so setzen, wie es benötigt wird ... 
        If budget <= 0 And atleastOneRC Then
            hproj.setBudgetAsNeeded()
        End If


        ' Workaround, der nötig ist, um Fehler zu vermeiden - Fehler in Dauer ... 
        Dim tmpValue As Integer = hproj.dauerInDays

        erstelleProjektausParametern = hproj

    End Function

    '
    ' Sub trägt ein individuelles Projekt ein
    '
    ''' <summary>
    ''' trägt ein entsprechendes Projekt ein
    ''' wenn budget = -999 dann soll es aus den Ressourcen und Kostenbedarfen sowie dem Risiko ermittelt werden  
    ''' </summary>
    ''' <param name="pname"></param>
    ''' <param name="vorlagenName"></param>
    ''' <param name="variantName"></param>
    ''' <param name="startdate"></param>
    ''' <param name="endedate"></param>
    ''' <param name="erloes"></param>
    ''' <param name="tafelZeile"></param>
    ''' <param name="sfit"></param>
    ''' <param name="risk"></param>
    ''' <param name="capacityNeeded"></param>
    ''' <param name="externCostInput"></param>
    ''' <param name="businessUnit"></param>
    ''' <param name="description"></param>
    ''' <param name="listOfCustomFields"></param>
    ''' <param name="responsiblePerson"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function erstelleInventurProjekt(ByVal pname As String, ByVal vorlagenName As String, ByVal variantName As String, _
                                           ByVal startdate As Date, ByVal endedate As Date, _
                                           ByVal erloes As Double, ByVal tafelZeile As Integer, ByVal sfit As Double, ByVal risk As Double, _
                                           ByVal capacityNeeded As String, ByVal externCostInput As String, ByVal businessUnit As String, ByVal description As String, _
                                           ByVal listOfCustomFields As Collection, _
                                           ByVal responsiblePerson As String, _
                                           ByVal profitUSerAskedFor As Double) As clsProjekt

        Dim newprojekt As New clsProjekt
        Dim pStatus As String = ProjektStatus(1) ' jedes Projekt soll zu Beginn als beauftragtes Projekt importiert werden 
        Dim zeile As Integer = tafelZeile
        Dim spalte As Integer = getColumnOfDate(startdate)
        Dim heute As Date = Now
        Dim key As String = pname & "#"
        Dim referenceBudget As Double = 0.0

        '
        ' ein neues Projekt wird als Objekt angelegt ....
        '
        If IsNothing(variantName) Then
            variantName = ""
        End If

        Try
            Dim zielrenditenVorgabe As Double
            Dim budgetVorgabe As Double = erloes
            referenceBudget = Projektvorlagen.getProject(vorlagenName).getSummeKosten
            If referenceBudget > 0 Then
                zielrenditenVorgabe = (budgetVorgabe * (1 - CDbl(profitUSerAskedFor) / 100)) / referenceBudget
                Projektvorlagen.getProject(vorlagenName).korrCopyTo(newprojekt, startdate, endedate, zielrenditenVorgabe)
            Else
                Projektvorlagen.getProject(vorlagenName).korrCopyTo(newprojekt, startdate, endedate)
            End If

        Catch ex As Exception
            Call MsgBox("es gibt keine entsprechende Vorlage ..")
            erstelleInventurProjekt = Nothing
            Exit Function
        End Try

        Try
            With newprojekt
                .name = pname
                .variantName = variantName
                '.getPhase(1).name = pname
                .getPhase(1).nameID = rootPhaseName
                .VorlagenName = vorlagenName
                .startDate = startdate
                .earliestStartDate = .startDate.AddMonths(.earliestStart)
                .latestStartDate = .startDate.AddMonths(.latestStart)
                ' jedes Projekt zu Beginn als beauftragtes Projekt importieren
                .Status = ProjektStatus(PTProjektStati.geplant)
                .StrategicFit = sfit
                .Risiko = risk

                .leadPerson = responsiblePerson
                .businessUnit = businessUnit
                .description = description
                .tfZeile = tafelZeile
                If erloes > 0 Then
                    .Erloes = erloes
                    ' andernfalls wird es ganz am Schluss berechnet ...
                Else
                    .Erloes = 0
                End If


            End With
        Catch ex As Exception
            Throw New Exception("in erstelle InventurProjekte: " & ex.Message)
        End Try

        '
        ' wenn benötigte Kapas angegeben sind, dann müssen die jetzt der phase(1) zugewiesen werden 
        '

        Dim rk As Integer = 0
        Dim Xwerte() As Double
        Dim oldXwerte() As Double

        Dim summeCost As Double = 0.0

        Dim cphase As clsPhase = newprojekt.getPhase(1)

        If Not IsNothing(capacityNeeded) Then
            If capacityNeeded.Trim.Length > 0 Then

                Dim completeStr() As String = capacityNeeded.Split(New Char() {CType("#", Char)}, 100)


                ' jetzt die angegebenen Rollenabarbeiten 
                For i As Integer = 1 To completeStr.Length

                    Dim roleStr() As String = completeStr(i - 1).Split(New Char() {CType(":", Char)}, 2)
                    Dim isRole As Boolean = False
                    Dim tagessatz As Double = 0.0

                    If roleStr.Length > 0 Then

                        Try
                            Dim summeBedarfe As Double

                            If roleStr.Length = 1 Then
                                ' Vereinbarung: 
                                ' wenn nur eine Zahl angegeben ist, soll einfach die erste Rolle genommen werden ... 
                                If IsNumeric(roleStr(0)) Then
                                    If CDbl(roleStr(0)) > 0 Then
                                        isRole = True
                                        summeBedarfe = CDbl(roleStr(0))
                                        rk = 1

                                        tagessatz = RoleDefinitions.getRoledef(rk).tagessatzIntern
                                    End If
                                End If
                            Else
                                Dim roleName As String = roleStr(0).Trim

                                If RoleDefinitions.containsNameOrID(roleName) Then
                                    isRole = True
                                    summeBedarfe = CDbl(roleStr(1))
                                    Dim teamID As Integer = -1
                                    rk = CInt(RoleDefinitions.getRoleDefByIDKennung(roleName, teamID).UID)
                                    tagessatz = RoleDefinitions.getRoledef(roleName).tagessatzIntern

                                Else

                                    rk = -1

                                End If
                            End If

                            If rk > -1 And isRole Then



                                If summeBedarfe > 0.0 Then

                                    ReDim oldXwerte(0)
                                    oldXwerte(0) = summeBedarfe

                                    Dim anfang As Integer, ende As Integer

                                    With cphase

                                        anfang = .relStart
                                        ende = .relEnde
                                        ReDim Xwerte(ende - anfang)

                                        .berechneBedarfe(.getStartDate, .getEndDate, oldXwerte, 1, Xwerte)

                                    End With

                                    'Dim crole As New clsRolle(ende - anfang + 1)
                                    ' tk: Änderung 26.7.16
                                    Dim crole As New clsRolle(ende - anfang)
                                    With crole
                                        .uid = rk
                                        .Xwerte = Xwerte
                                    End With

                                    With cphase
                                        .addRole(crole)
                                    End With

                                    summeCost = summeCost + crole.Xwerte.Sum * tagessatz

                                End If

                            End If

                        Catch ex As Exception

                        End Try
                    End If

                Next

            End If
        End If

        ' Anfang neu 

        If Not IsNothing(externCostInput) Then
            If externCostInput.Trim.Length > 0 Then

                Dim completeStr() As String = externCostInput.Split(New Char() {CType("#", Char)}, 100)
                Dim summeExtCost As Double = 0.0

                ' jetzt die angegebenen Rollenabarbeiten 
                For i As Integer = 1 To completeStr.Length

                    Dim costStr() As String = completeStr(i - 1).Split(New Char() {CType(":", Char)}, 2)
                    Dim isCost As Boolean = False

                    If costStr.Length > 0 Then

                        Try
                            If costStr.Length = 1 Then
                                ' Vereinbarung: 
                                ' wenn nur eine Zahl angegeben ist, soll einfach die erste Rolle genommen werden ... 
                                If costStr(0) = "filltobudget" Then
                                    summeExtCost = Math.Truncate(100 * (newprojekt.Erloes * (1 - newprojekt.risikoKostenfaktor) - newprojekt.getGesamtKostenBedarf.Sum)) / 100
                                    isCost = True
                                    rk = 1

                                ElseIf IsNumeric(costStr(0)) Then

                                    If CDbl(costStr(0)) > 0 Then
                                        isCost = True
                                        rk = 1
                                        summeExtCost = CDbl(costStr(0))
                                    End If
                                End If

                            Else
                                Dim costName As String = costStr(0).Trim

                                If CostDefinitions.containsName(costName) Then
                                    isCost = True
                                    rk = CInt(CostDefinitions.getCostdef(costName).UID)
                                    summeExtCost = CDbl(costStr(1))
                                Else

                                    rk = -1

                                End If
                            End If

                            If rk > -1 And isCost Then


                                If summeExtCost > 0.0 Then

                                    ReDim oldXwerte(0)
                                    oldXwerte(0) = summeExtCost

                                    Dim anfang As Integer, ende As Integer

                                    With cphase

                                        anfang = .relStart
                                        ende = .relEnde
                                        ReDim Xwerte(ende - anfang)

                                        .berechneBedarfe(.getStartDate, .getEndDate, oldXwerte, 1, Xwerte)

                                    End With

                                    Dim ccost As New clsKostenart(ende - anfang)
                                    With ccost
                                        .KostenTyp = rk
                                        .Xwerte = Xwerte
                                    End With

                                    With cphase
                                        .AddCost(ccost)
                                    End With

                                    summeCost = summeCost + Xwerte.Sum

                                End If

                            End If

                        Catch ex As Exception

                        End Try
                    End If

                Next

            End If
        End If

        ' Ende neu 


        ' jetzt ggf die Custom Fields eintragen 
        newprojekt.addListOfCustomFields(listOfCustomFields)
        ' wird jetzt in addListOfCustomFields erledigt ... 
        'If Not IsNothing(listOfCustomFields) Then

        '    If listOfCustomFields.Count > 0 Then

        '        For Each cfObj As clsCustomField In listOfCustomFields

        '            Try
        '                Dim uniqueID As Integer = CInt(cfObj.uid)
        '                Dim cfType As Integer = customFieldDefinitions.getTyp(uniqueID)

        '                Select Case cfType

        '                    Case ptCustomFields.Str
        '                        newprojekt.addSetCustomSField(uniqueID, CStr(cfObj.wert))
        '                    Case ptCustomFields.Dbl
        '                        newprojekt.addSetCustomDField(uniqueID, CDbl(cfObj.wert))
        '                    Case ptCustomFields.bool
        '                        newprojekt.addSetCustomBField(uniqueID, CBool(cfObj.wert))
        '                    Case Else

        '                End Select
        '            Catch ex As Exception

        '            End Try

        '        Next

        '    End If

        'End If

        ' jetzt muss ggf das benötigte Budget errechnet werden 

        ' wird jetzt in setBudgetAsNeeded erledigt 
        If erloes = -999 Then
            Try
                newprojekt.setBudgetAsNeeded()
            Catch ex As Exception

                If awinSettings.visboDebug Then
                    Call MsgBox("Fehler in Projekt anlegen, Name: " & newprojekt.name)
                End If

            End Try

        End If

        ' Workaround: 
        Dim tmpValue As Integer = newprojekt.dauerInDays
        ' tk, Änderung 19.1.17 nicht mehr notwendig ..
        ' Call awinCreateBudgetWerte(newprojekt)

        erstelleInventurProjekt = newprojekt
        '
        ' Ende Objekt Anlage
        '


    End Function


    ''' <summary>
    ''' fügt dem Projekt hproj das Modul mit Namen vorlagenName hinzu
    ''' alternativ können ParentID einer Phase oder parentName und startOffset, endoffset angegeben werden
    ''' Achtung: ergänzen zu einer ParentID wird noch nicht unterstützt  - hier muss noch behandelt werden, dass
    ''' die neu hinzugefügten Phasen ja am Ende der AllPhases List angefügt werden; andererseits werden beim Darstellen des Extended Mode die Phasen eines 
    ''' nach dem anderen gezeichnet; notwendig wäre hier eine zusätzliche Struktur, die die Reihenfolge beeinhaltet oder AllPhases und die Hierarchie Struktur muss neu afgebaut bzw. geändert werden 
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="parentNameID"></param>
    ''' <param name="parentName"></param>
    ''' <param name="vorlagenName"></param>
    ''' <param name="startOffset"></param>
    ''' <param name="endOffset"></param>
    ''' <remarks></remarks>
    Public Sub addModuleToProjekt(ByRef hproj As clsProjekt, ByVal vorlagenName As String,
                                      ByVal parentNameID As String, ByVal parentName As String,
                                      ByVal startOffset As Integer, ByVal endOffset As Integer,
                                      ByVal dontStretch As Boolean)

        Dim modulVorlage As clsProjektvorlage
        If ModulVorlagen.Contains(vorlagenName) Then

            If parentNameID.Length > 0 Then
                Throw New ArgumentException("wird noch nicht unterstützt ...")
            ElseIf parentName.Length = 0 Then
                Throw New ArgumentException("Name muss mindestens ein Zeichen enthalten ")
            ElseIf startOffset <= 0 Or endOffset <= 0 Or endOffset - startOffset <= 0 Then
                Throw New ArgumentException("ungültige Start-/Ende Angaben: " & startOffset & " , " & endOffset)
            Else
                ' jetzt kann die Aktion durchgeführt werden 
                modulVorlage = ModulVorlagen.getProject(vorlagenName)
                modulVorlage.moduleCopyTo(project:=hproj, parentID:="", moduleName:=parentName,
                                           modulStartOffset:=startOffset, endOffset:=endOffset, dontStretch:=dontStretch)
            End If

        Else
            Throw New ArgumentException("Vorlage " & vorlagenName & " existiert nicht")
        End If

    End Sub
    '
    '
    '

    Public Sub awinDeleteChart(ByRef chtobj As xlNS.ChartObject)
        Dim kennung As String
        Dim hDiagramm As clsDiagramm

        ' in der DiagramList wird die letzte Position gespeichert , deshlab ist es kontra produktiv , das zu löschen 

        Try
            kennung = chtobj.Name
        Catch ex As Exception
            kennung = "?"
        End Try

        Try

            If DiagramList.contains(kennung) Then
                hDiagramm = DiagramList.getDiagramm(kennung)
                With DiagramList.getDiagramm(kennung)
                    .top = chtobj.Top
                    .left = chtobj.Left
                End With
            End If

        Catch ex As Exception

        End Try

        chtobj.Delete()


    End Sub

    Public Sub awinStoreCockpit(ByVal cockpitname As String)
        'Dim kennung As String

        Dim fileName As String
        Dim found As Boolean = False
        Dim wsfound As Boolean = False
        Dim fileIsOpen As Boolean = False
        Dim anzChartsInCockpit As Integer
        Dim anzPfDiagrams As Integer
        Dim anzPrDiagrams As Integer
        Dim i As Integer
        Dim k As Integer = 1
        Dim maxRows As Integer
        Dim maxColumns As Integer
        Dim logMessage As String = " "
        Dim newchtobj As Excel.ChartObject = Nothing
        Dim oldchtobj As Excel.ChartObject
        Dim chtobj As Excel.ChartObject
        Dim hshape As Excel.Shape
        Dim xlsCockpits As xlNS.Workbook = Nothing
        Dim wsSheet As xlNS.Worksheet = Nothing
        Dim wsPfCharts As xlNS.Worksheet = Nothing
        Dim wsPrCharts As xlNS.Worksheet = Nothing
        Dim sichtbarerBereich As Excel.Range
        Dim maxTop As Double = 0.0
        Dim maxLeft As Double = 0.0

        ' Änderung tk: 5.11.15  
        ' enableEvents = false , enableonUpdate = false; sonst werden stätnig Event getriggert und ausgeführt 

        Dim formerEO As Boolean = enableOnUpdate
        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False
        enableOnUpdate = False
        Dim tmpwindow As Excel.Window = appInstance.ActiveWindow.NewWindow
        Try


            anzPfDiagrams = CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.mptPfCharts)).ChartObjects, Excel.ChartObjects).Count
            anzPrDiagrams = CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.mptPrCharts)).ChartObjects, Excel.ChartObjects).Count


            fileName = awinPath & cockpitsFile

            If My.Computer.FileSystem.FileExists(fileName) Then

                Try
                    If Not fileIsOpen Then
                        xlsCockpits = appInstance.Workbooks.Open(fileName)
                        fileIsOpen = True
                    End If
                Catch ex As Exception

                    i = 1
                    While i <= appInstance.Workbooks.Count And Not fileIsOpen
                        If appInstance.Workbooks(i).Name = fileName Then
                            xlsCockpits = appInstance.Workbooks(i)
                            fileIsOpen = True
                        Else
                            i = i + 1
                        End If
                    End While

                    If Not fileIsOpen Then
                        logMessage = "Öffnen von " & fileName & " fehlgeschlagen" & vbLf &
                                                    "falls die Datei bereits geöffnet ist: Schließen Sie sie bitte"
                        appInstance.EnableEvents = formerEE
                        enableOnUpdate = formerEO
                        Throw New ArgumentException(logMessage)
                    End If

                End Try
            Else
                ' Cockpits-File neu anlegen 
                xlsCockpits = appInstance.Workbooks.Add()
                xlsCockpits.SaveAs(fileName)
            End If

            If anzPrDiagrams + anzPfDiagrams > 0 Then

                ' wenn das richtige Tabellenblatt in Datei "Project Board Cockpits.xlsx" vorhanden, dann löschen 
                Try
                    wsSheet = CType(xlsCockpits.Worksheets(cockpitname), Excel.Worksheet)
                    If wsSheet.Name = cockpitname Then
                        ' Tabellenblatt existiert bereits, es muss gelöscht werden und neu angelegt
                        xlsCockpits.Worksheets.Application.DisplayAlerts = False
                        wsSheet.Delete()
                        xlsCockpits.Worksheets.Application.DisplayAlerts = True
                    End If
                Catch ex As Exception

                End Try

                ' Tabellenblatt muss neu hinzugefügt werden

                wsSheet = CType(xlsCockpits.Worksheets.Add(), Excel.Worksheet)
                wsSheet.Name = cockpitname

                ' Tabellenblatt existiert jetzt sicher

                ' Merken des aktuell gesetzten sichtbaren Bereich in der ProjektTafel
                With appInstance.ActiveWindow
                    sichtbarerBereich = .VisibleRange
                End With

                wsPrCharts = CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.mptPrCharts)), Excel.Worksheet)
                With wsPrCharts
                    ' benötigt um die Spaltenbreite und Zeilenhöhe  zu setzen für die Tabelle in "Project Board Cockpit.xlsx", in die das neue Cockpit gespeichert wird.
                    maxRows = .Rows.Count
                    maxColumns = .Columns.Count
                    ' Anzahl Diagramme, die gespeichert werden zu diesem Cockpit
                    anzPrDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count

                    ' alle Projekt-Charts durchgehen und in "Project Board Cockpits.xlsx" Tabelle "cockpitname" am linken Rand speichern
                    k = 1
                    While k <= anzPrDiagrams

                        'wsPrCharts.Activate()

                        chtobj = CType(wsPrCharts.ChartObjects(k), Excel.ChartObject)

                        oldchtobj = chtobj

                        '  Top/Left Position für Portfolio bestimmen
                        If oldchtobj.Top < maxTop Then
                            maxTop = oldchtobj.Top
                        End If
                        If oldchtobj.Left + oldchtobj.Width > maxLeft Then
                            maxLeft = oldchtobj.Left + oldchtobj.Width
                        End If

                        chtobj.Copy()

                        ' '' wenn Chart vorhanden, dann ersetzen, sonst hinzufügen

                        ''found = False
                        ''i = 1
                        ''anzChartsInCockpit = CType(wsSheet.ChartObjects, Excel.ChartObjects).Count
                        ''While i <= anzChartsInCockpit And Not found
                        ''    hchtobj = CType(wsSheet.ChartObjects(i), Excel.ChartObject)
                        ''    ' an awinLoadCockpit anpassen
                        ''    If hchtobj.Name = chtobj.Name Then
                        ''        hchtobj.Delete()
                        ''        found = True
                        ''    Else
                        ''        i = i + 1
                        ''    End If
                        ''End While

                        'wsSheet.Activate()

                        ' Chart aus dem Buffer nun in das Tabellenblatt einfügen
                        wsSheet.Paste()
                        anzChartsInCockpit = CType(wsSheet.ChartObjects, Excel.ChartObjects).Count

                        ' dem neu eingefügten Chart die richtige Position eintragen, neutralisiert um den sichtbaren Bereich
                        newchtobj = CType(wsSheet.ChartObjects(anzChartsInCockpit), Excel.ChartObject)

                        newchtobj.Top = oldchtobj.Top
                        newchtobj.Left = oldchtobj.Left


                        ' aus der DiagrammList noch DiagrammTyp herausholen und in das Chart bei AlternativText eintragen
                        Dim hdiagramm As clsDiagramm
                        i = 1
                        found = False

                        While i <= DiagramList.Count And Not found

                            hdiagramm = DiagramList.getDiagramm(i)
                            If hdiagramm.kennung = newchtobj.Name Then
                                'newchtobj.Chart.Name = hdiagramm.diagrammTyp
                                found = True
                                hshape = chtobj2shape(newchtobj)
                                hshape.Title = hdiagramm.diagrammTyp
                                Try
                                    If Not IsNothing(hdiagramm.gsCollection) Then
                                        For hi = 1 To hdiagramm.gsCollection.Count
                                            If hi = 1 Then
                                                hshape.AlternativeText = CStr(hdiagramm.gsCollection.Item(hi))
                                            Else
                                                hshape.AlternativeText = hshape.AlternativeText & ";" & CStr(hdiagramm.gsCollection.Item(hi))
                                            End If
                                        Next hi
                                    End If
                                Catch ex As Exception
                                    Throw New Exception("Fehler  Projekt-Cockpits '" & cockpitname & vbLf & ex.Message)
                                End Try

                            End If
                            i = i + 1

                        End While

                        ' aus der DiagrammList noch Collection herausholen und in das Chart bei Beschreibung eintragen
                        k = k + 1

                    End While

                End With


                ' alle Portfolio-Charts durchgehen und in "Project Board Cockpits.xlsx" Tabelle "cockpitname" am linken Rand speichern

                wsPfCharts = CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.mptPfCharts)), Excel.Worksheet)

                With wsPfCharts
                    ' benötigt um die Spaltenbreite und Zeilenhöhe  zu setzen für die Tabelle in "Project Board Cockpit.xlsx", in die das neue Cockpit gespeichert wird.
                    maxRows = .Rows.Count
                    maxColumns = .Columns.Count
                    ' Anzahl Diagramme, die gespeichert werden zu diesem Cockpit
                    anzPfDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count

                    ' löschen der Zwischenablage
                    'Call ClearClipboard()


                    k = 1
                    While k <= anzPfDiagrams

                        'wsPfCharts.Activate()
                        Dim anz As Integer = CType(.ChartObjects, Excel.ChartObjects).Count

                        chtobj = CType(wsPfCharts.ChartObjects(k), Excel.ChartObject)
                        chtobj.Activate()

                        Try
                            chtobj.Copy()
                        Catch ex As Exception
                            chtobj.Copy()
                        End Try

                        oldchtobj = chtobj

                        ' '' wenn Chart vorhanden, dann ersetzen, sonst hinzufügen

                        ''found = False
                        ''i = 1
                        ''anzChartsInCockpit = CType(wsSheet.ChartObjects, Excel.ChartObjects).Count
                        ''While i <= anzChartsInCockpit And Not found
                        ''    hchtobj = CType(wsSheet.ChartObjects(i), Excel.ChartObject)
                        ''    ' an awinLoadCockpit anpassen
                        ''    If hchtobj.Name = chtobj.Name Then
                        ''        hchtobj.Delete()
                        ''        found = True
                        ''    Else
                        ''        i = i + 1
                        ''    End If
                        ''End While

                        ' wsSheet.Activate()

                        ' Chart aus dem Buffer nun in das Tabellenblatt einfügen
                        wsSheet.Paste()

                        anzChartsInCockpit = CType(wsSheet.ChartObjects, Excel.ChartObjects).Count

                        ' dem neu eingefügten Chart die richtige Position eintragen, neutralisiert um den sichtbaren Bereich
                        newchtobj = CType(wsSheet.ChartObjects(anzChartsInCockpit), Excel.ChartObject)

                        newchtobj.Top = oldchtobj.Top + maxTop
                        newchtobj.Left = oldchtobj.Left + maxLeft
                        ' aus der DiagrammList noch DiagrammTyp herausholen und in das Chart bei AlternativText eintragen

                        Dim hdiagramm As clsDiagramm
                        i = 1
                        found = False
                        Try

                            While i <= DiagramList.Count And Not found

                                hdiagramm = DiagramList.getDiagramm(i)
                                If hdiagramm.kennung = newchtobj.Name Then
                                    'newchtobj.Chart.Name = hdiagramm.diagrammTyp
                                    found = True
                                    hshape = chtobj2shape(newchtobj)
                                    hshape.Title = hdiagramm.diagrammTyp
                                    Try
                                        If Not IsNothing(hdiagramm.gsCollection) Then
                                            For hi = 1 To hdiagramm.gsCollection.Count
                                                If hi = 1 Then
                                                    hshape.AlternativeText = CStr(hdiagramm.gsCollection.Item(hi))
                                                Else
                                                    hshape.AlternativeText = hshape.AlternativeText & ";" & CStr(hdiagramm.gsCollection.Item(hi))
                                                End If
                                            Next hi
                                        End If
                                    Catch ex As Exception
                                        Call MsgBox("Fehler Portfolio Cockpits '" & cockpitname & vbLf & ex.Message)
                                        Throw New Exception("Fehler Portfolio Cockpits '" & cockpitname & vbLf & ex.Message)
                                    End Try

                                End If
                                i = i + 1

                            End While

                        Catch ex As Exception
                            Call MsgBox(" in Diagrammlist Schleife")
                        End Try


                        ' aus der DiagrammList noch Collection herausholen und in das Chart bei Beschreibung eintragen
                        k = k + 1

                        ' löschen der Zwischenablage
                        My.Computer.Clipboard.Clear()
                    End While
                End With



                CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Activate()
                projectboardWindows(PTwindows.mpt).Activate()

                'enableOnUpdate = formerEO
                'appInstance.EnableEvents = formerEE

                'appInstance.ActiveWorkbook.Close(SaveChanges:=True)
                xlsCockpits.Close(SaveChanges:=True)

                Try
                    tmpwindow.Close()
                Catch ex As Exception
                    Call MsgBox("Schließen tmpwindow")
                End Try


                If Not cockpitname = "_Last" Then
                    Call MsgBox("Cockpit '" & cockpitname & "' wurde gespeichert")
                End If




            Else
                enableOnUpdate = formerEO
                appInstance.EnableEvents = formerEE
                appInstance.ScreenUpdating = True
                Call MsgBox("Es sind keine Charts vorhanden")
            End If

            enableOnUpdate = formerEO
            appInstance.EnableEvents = formerEE
            appInstance.ScreenUpdating = True

        Catch ex As Exception
            enableOnUpdate = formerEO
            appInstance.EnableEvents = formerEE
            appInstance.ScreenUpdating = True
            Throw New Exception("Fehler beim Speichern des Cockpits; k= '" & k & " i= '" & i & " '" & cockpitname & vbLf & ex.Message)
        End Try

    End Sub

    ''' <summary>
    ''' Es wird ein Cockpit (=Ansammlung von Charts) geladen und angezeigt
    ''' </summary>
    ''' <param name="cockpitname"></param>
    ''' <remarks></remarks>
    Public Sub awinLoadCockpit(ByVal cockpitname As String)
        'Dim kennung As String

        Dim fileName As String
        Dim found As Boolean = False
        Dim wsfound As Boolean = False
        Dim fileIsOpen As Boolean = False
        Dim isPfDiagramm As Boolean = False
        Dim anzDiagrams As Integer
        Dim i As Integer
        Dim k As Integer = 1
        Dim j As Integer = 1
        Dim logMessage As String = " "
        Dim newchtobj As Excel.ChartObject
        Dim hchtobj As Excel.ChartObject
        Dim hshape As Excel.Shape
        Dim chtobj As Excel.ChartObject
        Dim xlsCockpits As xlNS.Workbook = Nothing
        Dim wsSheet As xlNS.Worksheet = Nothing
        Dim currentWS As xlNS.Worksheet = Nothing
        Dim currentWSpf As xlNS.Worksheet = Nothing
        Dim currentWSpr As xlNS.Worksheet = Nothing
        Dim pfTop As Double = 0.0
        Dim pfLeft As Double = 0.0
        Dim pfwidth As Double = 0.0
        Dim pfheight As Double = 0.0
        Dim minPfTop As Double = 0.0
        Dim minPfLeft As Double = 0.0

        Dim prTop As Double = 0.0
        Dim prLeft As Double = 0.0
        Dim prwidth As Double = 0.0
        Dim prheight As Double = 0.0
        Dim minPrTop As Double = 0.0
        Dim minPrLeft As Double = 0.0
        Dim hstring As String

        appInstance.EnableEvents = False
        Try
            currentWS = CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
            'projectboardWindows(PTwindows.mpt).Visible = False
            currentWSpf = CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.mptPfCharts)), Excel.Worksheet)
            currentWSpr = CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.mptPrCharts)), Excel.Worksheet)


            ' TOP/Left - Position der Portfolio-Cockpits-Charts bestimmen
            ' hier sollte eigentlich die Höhe der Cockpit Chars genommen werden 
            Call bestimmeChartPositionAndSize(ptTables.mptPfCharts, 2, minPfTop, minPfLeft, pfwidth, pfheight)
            ' hier sollte eigentlich die Höhe der cockpit Charts genommen werden 
            ' TOP/Left - Position der Projekt-Cockpits-Charts bestimmen
            Call bestimmeChartPositionAndSize(ptTables.mptPrCharts, 2, minPrTop, minPrLeft, prwidth, prheight)


            fileName = awinPath & cockpitsFile

            If My.Computer.FileSystem.FileExists(fileName) Then

                Try

                    xlsCockpits = appInstance.Workbooks.Open(fileName)

                Catch ex As Exception

                    i = 1
                    While i <= appInstance.Workbooks.Count And Not fileIsOpen
                        If appInstance.Workbooks(i).Name = fileName Then
                            xlsCockpits = appInstance.Workbooks(i)
                            fileIsOpen = True
                        Else
                            i = i + 1
                        End If
                    End While

                    If Not fileIsOpen Then
                        logMessage = "Öffnen von " & fileName & " fehlgeschlagen" & vbLf &
                                                    "falls die Datei bereits geöffnet ist: Schließen Sie sie bitte"

                        Throw New ArgumentException(logMessage)
                    End If

                End Try

                ' richtige Tabellenblatt  in Datei "Project Board Cockpits.xlsx" aktivieren
                Try
                    wsSheet = CType(xlsCockpits.Worksheets(cockpitname), Excel.Worksheet)

                    '
                    ' Anfangsposition für Portfolio und Projekt-Charts bestimmen
                    k = 1
                    Dim anzChartObj As Integer = CType(wsSheet.ChartObjects, Excel.ChartObjects).Count

                    pfTop = 1.0E+16
                    pfLeft = 1.0E+16
                    prTop = 1.0E+16
                    prLeft = 1.0E+16

                    While k <= anzChartObj

                        wsSheet.Activate()
                        chtobj = CType(wsSheet.ChartObjects(k), Excel.ChartObject)  ' immer das Chart 1 lesen, da die anderen mit Cut ausgeschnitten wurden

                        Dim CPtmpArray() As String
                        CPtmpArray = chtobj.Name.Split(New Char() {CType("#", Char)}, 5)
                        isPfDiagramm = (CPtmpArray(0) = "pf")

                        If isPfDiagramm Then
                            pfTop = Math.Min(pfTop, chtobj.Top)
                            pfLeft = Math.Min(pfLeft, chtobj.Left)
                        Else
                            prTop = Math.Min(prTop, chtobj.Top)
                            prLeft = Math.Min(prLeft, chtobj.Left)
                        End If
                        k = k + 1

                    End While
                    minPfTop = pfTop - minPfTop
                    minPfLeft = pfLeft - minPfLeft
                    minPrTop = prTop - minPrTop
                    minPrLeft = prLeft - minPrLeft
                    ' Ende Bestimmung der Anfangsposition
                    '

                    ' lesen der Charts und verteilen auf die zwei Sheets und damint Windows
                    k = 1
                    anzChartObj = CType(wsSheet.ChartObjects, Excel.ChartObjects).Count
                    While k <= anzChartObj

                        wsSheet.Activate()
                        chtobj = CType(wsSheet.ChartObjects(1), Excel.ChartObject)  ' immer das Chart 1 lesen, da die anderen mit Cut ausgeschnitten wurden

                        ' löschen der Zwischenablage
                        My.Computer.Clipboard.Clear()

                        Dim CPtmpArray() As String
                        CPtmpArray = chtobj.Name.Split(New Char() {CType("#", Char)}, 5)
                        isPfDiagramm = (CPtmpArray(0) = "pf")

                        If isPfDiagramm Then


                            ' testen, ob dieses Chart bereits im PTwindows.mptpf angezeigt wird, dann ggfalls. löschen
                            found = False
                            j = 1
                            While j <= CType(currentWSpf.ChartObjects, Excel.ChartObjects).Count And Not found
                                hchtobj = CType(currentWSpf.ChartObjects(j), Excel.ChartObject)

                                Dim PTtmpArray() As String
                                PTtmpArray = hchtobj.Name.Split(New Char() {CType("#", Char)}, 5)

                                ' Überprüfen, ob das Chart bereits angezeigt wird, dann ersetzen
                                If Not IsNothing(hchtobj) Then

                                    If hchtobj.Name <> "" Then

                                        If hchtobj.Name <> chtobj.Name Then
                                            ' chtobj name ist aufgebaut: pr#PTprdk.kennung#pName#Auswahl
                                            ' oder
                                            ' chtobj name ist so: pf#zahl#zahl
                                            If CPtmpArray(0) = "pr" And PTtmpArray(0) = "pr" Then
                                                If CPtmpArray(0) = PTtmpArray(0) And CPtmpArray(1) = PTtmpArray(1) And CPtmpArray(3) = PTtmpArray(3) Then
                                                    currentWSpf.ChartObjects(j).Delete()
                                                    found = True
                                                End If
                                            Else
                                                If isPfDiagramm Then
                                                    If hchtobj.Name = chtobj.Name Then

                                                        currentWSpf.ChartObjects(j).Delete()
                                                        found = True
                                                    End If
                                                End If
                                            End If
                                        Else
                                            currentWSpf.ChartObjects(j).Delete()
                                            found = True
                                        End If

                                    End If
                                End If

                                isPfDiagramm = (CPtmpArray(0) = "pf")

                                j = j + 1
                            End While
                        Else
                            ' testen, ob dieses Chart bereits im PTwindows.mptpr angezeigt wird, dann ggfalls. löschen
                            found = False
                            j = 1
                            While j <= CType(currentWSpr.ChartObjects, Excel.ChartObjects).Count And Not found
                                hchtobj = CType(currentWSpr.ChartObjects(j), Excel.ChartObject)

                                Dim PTtmpArray() As String
                                PTtmpArray = hchtobj.Name.Split(New Char() {CType("#", Char)}, 5)

                                ' Überprüfen, ob das Chart bereits angezeigt wird, dann ersetzen
                                If Not IsNothing(hchtobj) Then

                                    If hchtobj.Name <> "" Then

                                        If hchtobj.Name <> chtobj.Name Then
                                            ' chtobj name ist aufgebaut: pr#PTprdk.kennung#pName#Auswahl
                                            ' oder
                                            ' chtobj name ist so: pf#zahl#zahl
                                            If CPtmpArray(0) = "pr" And PTtmpArray(0) = "pr" Then
                                                If CPtmpArray(0) = PTtmpArray(0) And CPtmpArray(1) = PTtmpArray(1) And CPtmpArray(3) = PTtmpArray(3) Then
                                                    currentWSpr.ChartObjects(j).Delete()
                                                    found = True
                                                End If
                                            Else
                                                If isPfDiagramm Then
                                                    If hchtobj.Name = chtobj.Name Then

                                                        currentWSpr.ChartObjects(j).Delete()
                                                        found = True
                                                    End If
                                                End If
                                            End If
                                        Else
                                            currentWSpr.ChartObjects(j).Delete()
                                            found = True
                                        End If

                                    End If
                                End If

                                isPfDiagramm = (CPtmpArray(0) = "pf")

                                j = j + 1
                            End While
                        End If


                        ''  die Position merken
                        Dim chtTop As Double = chtobj.Top
                        Dim chtLeft As Double = chtobj.Left

                        chtobj.Activate()
                        chtobj.Cut()

                        If isPfDiagramm Then
                            Dim formerEvent As Boolean = appInstance.EnableEvents
                            appInstance.EnableEvents = True

                            Dim anzDiagWD As Integer = CType(currentWS.ChartObjects, Excel.ChartObjects).Count

                            'Dim newtestshape As Excel.ChartObject

                            If Not IsNothing(projectboardWindows(PTwindows.mptpf)) Then
                                projectboardWindows(PTwindows.mptpf).Activate()

                            Else
                                Call showVisboWindow(PTwindows.mptpf)
                            End If

                            currentWSpf.Paste()


                            appInstance.EnableEvents = formerEvent


                            anzDiagrams = CType(currentWSpf.ChartObjects, Excel.ChartObjects).Count
                            anzDiagWD = CType(currentWS.ChartObjects, Excel.ChartObjects).Count


                            ' dem neu eingefügten Chart die richtige Position eintragen
                            newchtobj = CType(currentWSpf.ChartObjects(anzDiagrams), Excel.ChartObject)
                            newchtobj.Top = chtTop - minPfTop
                            newchtobj.Left = chtLeft - minPfLeft


                            ' Alternativtext herausbekommen
                            hshape = chtobj2shape(newchtobj)


                            ' hier wird die maximale Anzahl an Phasen oder Rollen oder Kosten herausgefunden
                            Dim maxAnz As Integer = System.Math.Max(RoleDefinitions.Count, PhaseDefinitions.Count)
                            maxAnz = System.Math.Max(maxAnz, CostDefinitions.Count)
                            maxAnz = System.Math.Max(maxAnz, MilestoneDefinitions.Count)

                            Dim tmpArray1() As String
                            Dim myCollection As New Collection
                            tmpArray1 = hshape.AlternativeText.Split(New Char() {CType(";", Char)}, maxAnz)

                            ' myCollection aufbauen mit den verschiedenen Werten die im Diagramm angezeigt werden sollen
                            For hi = 0 To tmpArray1.Length - 1
                                If tmpArray1.Length >= 1 And tmpArray1(hi) <> "" Then
                                    hstring = tmpArray1(hi)
                                    myCollection.Add(hstring, hstring)
                                    'Else
                                    '    myCollection = Nothing
                                End If

                            Next hi

                            ' Diagramme in die diagrammListe einfügen mit allen Angaben

                            Dim prcDiagram As New clsDiagramm

                            ' Anfang Event Handling für Chart 
                            Dim prcChart As New clsEventsPrcCharts
                            prcChart.PrcChartEvents = newchtobj.Chart
                            prcDiagram.setDiagramEvent = prcChart
                            ' Ende Event Handling für Chart 

                            With prcDiagram
                                .DiagrammTitel = newchtobj.Chart.ChartTitle.Text
                                .diagrammTyp = hshape.Title.Trim
                                .gsCollection = myCollection
                                .isCockpitChart = False
                                .top = newchtobj.Top
                                .left = newchtobj.Left
                                .width = newchtobj.Width
                                .height = newchtobj.Height
                                .kennung = newchtobj.Name
                            End With

                            ' eintragen in die sortierte Liste mit .kennung als dem Schlüssel 
                            ' wenn das Diagramm bereits existiert, muss es gelöscht werden, dann neu ergänzt ... 
                            Try
                                DiagramList.Add(prcDiagram)
                            Catch ex As Exception
                                Try
                                    DiagramList.Remove(prcDiagram.kennung)
                                    DiagramList.Add(prcDiagram)
                                Catch ex1 As Exception

                                End Try
                            End Try

                        Else
                            'Dim newtestshape As Excel.ChartObject
                            If Not IsNothing(projectboardWindows(PTwindows.mptpr)) Then
                                projectboardWindows(PTwindows.mptpr).Activate()

                            Else
                                Call showVisboWindow(PTwindows.mptpr)
                            End If

                            'currentWSpr.Activate()
                            currentWSpr.Paste()

                            anzDiagrams = CType(currentWSpr.ChartObjects, Excel.ChartObjects).Count
                            ' dem neu eingefügten Chart die richtige Position eintragen
                            newchtobj = CType(currentWSpr.ChartObjects(anzDiagrams), Excel.ChartObject)
                            newchtobj.Top = chtTop - minPrTop
                            newchtobj.Left = chtLeft - minPrLeft
                        End If


                        If isPfDiagramm Then

                            '' '' Alternativtext herausbekommen
                            ' ''hshape = chtobj2shape(newchtobj)


                            '' '' hier wird die maximale Anzahl an Phasen oder Rollen oder Kosten herausgefunden
                            ' ''Dim maxAnz As Integer = System.Math.Max(RoleDefinitions.Count, PhaseDefinitions.Count)
                            ' ''maxAnz = System.Math.Max(maxAnz, CostDefinitions.Count)

                            ' ''Dim tmpArray1() As String
                            ' ''Dim myCollection As New Collection
                            ' ''tmpArray1 = hshape.AlternativeText.Split(New Char() {CType(";", Char)}, maxAnz)

                            '' '' myCollection aufbauen mit den verschiedenen Werten die im Diagramm angezeigt werden sollen
                            ' ''For hi = 0 To tmpArray1.Length - 1
                            ' ''    If tmpArray1.Length >= 1 And tmpArray1(hi) <> "" Then
                            ' ''        hstring = tmpArray1(hi)
                            ' ''        myCollection.Add(hstring, hstring)
                            ' ''        'Else
                            ' ''        '    myCollection = Nothing
                            ' ''    End If

                            ' ''Next hi

                            '' '' Diagramme in die diagrammListe einfügen mit allen Angaben

                            ' ''Dim prcDiagram As New clsDiagramm

                            '' '' Anfang Event Handling für Chart 
                            ' ''Dim prcChart As New clsEventsPrcCharts
                            ' ''prcChart.PrcChartEvents = newchtobj.Chart
                            ' ''prcDiagram.setDiagramEvent = prcChart
                            '' '' Ende Event Handling für Chart 

                            ' ''With prcDiagram
                            ' ''    .DiagrammTitel = newchtobj.Chart.ChartTitle.Text
                            ' ''    .diagrammTyp = hshape.Title.Trim
                            ' ''    .gsCollection = myCollection
                            ' ''    .isCockpitChart = False
                            ' ''    .top = newchtobj.Top
                            ' ''    .left = newchtobj.Left
                            ' ''    .width = newchtobj.Width
                            ' ''    .height = newchtobj.Height
                            ' ''    .kennung = newchtobj.Name
                            ' ''End With

                            '' '' eintragen in die sortierte Liste mit .kennung als dem Schlüssel 
                            '' '' wenn das Diagramm bereits existiert, muss es gelöscht werden, dann neu ergänzt ... 
                            ' ''Try
                            ' ''    DiagramList.Add(prcDiagram)
                            ' ''Catch ex As Exception
                            ' ''    Try
                            ' ''        DiagramList.Remove(prcDiagram.kennung)
                            ' ''        DiagramList.Add(prcDiagram)
                            ' ''    Catch ex1 As Exception

                            ' ''    End Try
                            ' ''End Try

                        End If                ' Ende der PF-Diagramm Spezialbehandlung

                        k = k + 1

                    End While
                    wsfound = True
                    'Call MsgBox("Es wurden " & k - 1 & " Charts eingefügt")
                Catch ex As Exception
                    appInstance.EnableEvents = True
                    xlsCockpits.Close(SaveChanges:=False)
                    Throw New ArgumentException("Fehler beim Laden des Cockpits '" & cockpitname & vbLf, ex.Message)
                End Try

                xlsCockpits.Close(SaveChanges:=False)

            Else
                ' Project Board Cockpit.xlsx ist nicht vorhanden
                Call MsgBox("Es sind keine Charts vorhanden." & vbLf & "'Project Board Cockpit.xlsx ist nicht vorhanden.")

            End If

        Catch ex As Exception
            appInstance.EnableEvents = True
            xlsCockpits.Close(SaveChanges:=False)
            Throw New ArgumentException("Fehler beim Laden des Cockpits '" & cockpitname & vbLf, ex.Message)
        End Try

        'projectboardWindows(PTwindows.mpt).Visible = True
        appInstance.EnableEvents = True
    End Sub
    '
    ''' <summary>
    ''' gibt die Referenz für dazu zum ChartObject cho gehörige Excel.Shape zurück
    ''' </summary>
    ''' <param name="cho">ChartObject</param>
    ''' <remarks></remarks>
    Function chtobj2shape(ByRef cho As xlNS.ChartObject) As Excel.Shape

        'Dim zo As Long
        Dim ws As Excel.Worksheet
        Dim shc As Excel.Shapes
        Dim sh As Excel.Shape
        Dim found As Boolean = False
        Dim i As Integer = 0
        ws = CType(cho.Parent, Excel.Worksheet)
        shc = ws.Shapes
        While Not found And i <= shc.Count
            i = i + 1
            found = cho.Name = shc.Item(i).Name
        End While

        sh = shc.Item(i)

        chtobj2shape = sh

    End Function
    '
    ''' <summary>
    ''' das Projekt beauftragen bzw. die Änderungen akzeptieren
    ''' type 0 : Acceptchanges
    ''' type 1: Beauftragen 
    ''' </summary>
    ''' <param name="pname">Projektname</param>
    ''' <param name="type">0: Accept Changes; 1: Beauftragung </param>
    ''' <remarks></remarks>
    Public Sub changeProjectStatus(ByVal pname As String, ByVal type As Integer)
        Dim hproj As clsProjekt
        Dim zeile As Integer
        Dim errmsg As String

        ' prüfen, ob es in der ShowProjektListe ist ...
        If ShowProjekte.contains(pname) Then


            Try
                hproj = ShowProjekte.getProject(pname)
                ' Sicherstellen, dass der Status Wechsel nur bei der Basis-Variante vorgenommen werden kann ...
                If hproj.variantName <> "" And hproj.projectType = ptPRPFType.project Then
                    If awinSettings.englishLanguage Then
                        errmsg = hproj.getShapeText & " : status change of a project-variant is not possible!"
                    Else
                        errmsg = hproj.getShapeText & " : Status Wechsel ist für eine Variante nicht möglich!"
                    End If
                    Throw New ArgumentException(errmsg)
                End If

                ' jetzt soll auch der Marker zurückgesetzt werden ..
                hproj.marker = False

                With hproj
                    Dim oldStatus As String = hproj.Status

                    Select Case type
                        Case PTProjektStati.geplant
                            ' old darf beauftragt, aber noch nicht begonnen sein
                            ' changerequest aber noch nicht begonnen 
                            If oldStatus = ProjektStatus(PTProjektStati.geplant) Or oldStatus = ProjektStatus(PTProjektStati.geplanteVorgabe) Or
                                ((oldStatus = ProjektStatus(PTProjektStati.beauftragt) Or oldStatus = ProjektStatus(PTProjektStati.ChangeRequest) Or oldStatus = ProjektStatus(PTProjektStati.beauftragteVorgabe) And
                                 hproj.startDate > Date.Now)) Then
                                hproj.Status = ProjektStatus(type)
                            Else

                                If awinSettings.englishLanguage Then
                                    errmsg = hproj.name & " : status change not possible"
                                Else
                                    errmsg = hproj.name & " : Status Wechsel nicht möglich"
                                End If
                                Throw New ArgumentException(errmsg)
                            End If

                        Case PTProjektStati.beauftragt
                            ' old darf nicht abgebrochen oder abgeschlossen sein 
                            If oldStatus = ProjektStatus(PTProjektStati.geplant) Or
                                oldStatus = ProjektStatus(PTProjektStati.beauftragt) Or
                                 oldStatus = ProjektStatus(PTProjektStati.ChangeRequest) Or
                                 oldStatus = ProjektStatus(PTProjektStati.geplanteVorgabe) Or
                                 oldStatus = ProjektStatus(PTProjektStati.beauftragteVorgabe) Then
                                hproj.Status = ProjektStatus(type)
                            Else
                                If awinSettings.englishLanguage Then
                                    errmsg = hproj.name & " : status change not possible"
                                Else
                                    errmsg = hproj.name & " : Status Wechsel nicht möglich"
                                End If
                                Throw New ArgumentException(errmsg)
                            End If

                        Case PTProjektStati.ChangeRequest

                            If oldStatus = ProjektStatus(PTProjektStati.geplant) Or
                                oldStatus = ProjektStatus(PTProjektStati.beauftragt) Or
                                 oldStatus = ProjektStatus(PTProjektStati.geplanteVorgabe) Or
                                 oldStatus = ProjektStatus(PTProjektStati.beauftragteVorgabe) Or
                                 oldStatus = ProjektStatus(PTProjektStati.ChangeRequest) Or
                                    oldStatus = ProjektStatus(PTProjektStati.abgebrochen) Then
                                ' tk ChangeRequest soll es bis auf weiteres nicht mehr geben ... 
                                ' das muss noch überdacht werden 
                                hproj.Status = ProjektStatus(PTProjektStati.beauftragt)
                                'hproj.Status = ProjektStatus(type)
                            Else
                                If awinSettings.englishLanguage Then
                                    errmsg = hproj.name & " : status change not possible"
                                Else
                                    errmsg = hproj.name & " : Status Wechsel nicht möglich"
                                End If
                                Throw New ArgumentException(errmsg)
                            End If

                        Case PTProjektStati.abgebrochen

                            If ((oldStatus = ProjektStatus(PTProjektStati.beauftragt) Or
                                    oldStatus = ProjektStatus(PTProjektStati.geplanteVorgabe) Or
                                    oldStatus = ProjektStatus(PTProjektStati.beauftragteVorgabe) Or
                                    oldStatus = ProjektStatus(PTProjektStati.ChangeRequest)) And hproj.startDate < Date.Now) Or
                                    oldStatus = ProjektStatus(PTProjektStati.abgebrochen) Then
                                hproj.Status = ProjektStatus(type)
                            Else
                                If awinSettings.englishLanguage Then
                                    errmsg = hproj.name & " : status change not possible"
                                Else
                                    errmsg = hproj.name & " : Status Wechsel nicht möglich"
                                End If
                                Throw New ArgumentException(errmsg)
                            End If

                        Case PTProjektStati.abgeschlossen

                            If ((oldStatus = ProjektStatus(PTProjektStati.beauftragt) Or oldStatus = ProjektStatus(PTProjektStati.beauftragt)) And hproj.endeDate < Date.Now) Then
                                hproj.Status = ProjektStatus(type)
                            Else
                                If awinSettings.englishLanguage Then
                                    errmsg = hproj.name & " : status change not possible"
                                Else
                                    errmsg = hproj.name & " : Status Wechsel nicht möglich"
                                End If
                                Throw New ArgumentException(errmsg)
                            End If
                    End Select
                    zeile = .tfZeile

                    .Status = ProjektStatus(type)
                    .timeStamp = Date.Now
                End With

                ' wenn bestimmte Projekte beim Suchen nach einem Platz nicht berücksichtigt werden sollen,
                ' dann müssen sie in einer Collection an ZeichneProjektinPlanTafel übergeben werden 
                Dim tmpCollection As New Collection
                Call ZeichneProjektinPlanTafel(tmpCollection, pname, zeile, tmpCollection, tmpCollection)

            Catch ex As Exception
                Call MsgBox(" Fehler in Beauftragung " & pname & " , Modul: awinBeauftragung")
                Exit Sub
            End Try


        Else
            Call MsgBox("Projekt " & pname & " wurde nicht gefunden")
        End If

    End Sub


    ''' <summary>
    ''' stellt das Projekt "pname" ims NoShow
    ''' </summary>
    ''' <param name="pname">NAme des Projekts</param>
    ''' <remarks></remarks>
    Public Sub awinShowNoShowProject(ByVal pname As String)
        Dim hproj As clsProjekt

        'Dim tfz As Integer, tfs As Integer



        ' prüfen, ob es in der ShowProjektListe ist ...
        If ShowProjekte.contains(pname) Then

            ' Shape wird gelöscht - ausserdem wird der Verweis in hproj auf das Shape gelöscht 
            Call clearProjektinPlantafel(pname)


            Try
                hproj = ShowProjekte.getProject(pname)
                ' aus Showprojekte rausnehmen
                ShowProjekte.Remove(pname)

                ' tk 21.3.17 wird nicht mehr benötigt ... 
                ' ist es bereits eine andere Variante in NoShowPRojekte?
                ''If noShowProjekte.contains(pname) Then
                ''    noShowProjekte.Remove(pname)
                ''End If
                ''noShowProjekte.Add(hproj, False)

            Catch ex As Exception
                Call MsgBox(" Fehler in NoShow " & pname & " , Modul: NoShowProject")
                Exit Sub
            End Try




            'Dim abstand As Integer ' eigentlich nur Dummy Variable, wird aber in Tabelle2 benötigt ...
            'Call awinClkReset(abstand)

            ' ein Projekt wurde gelöscht bzw aus Showprojekte entfernt  - typus = 3
            Call awinNeuZeichnenDiagramme(3)



        Else
            Call MsgBox("Projekt " & pname & " wurde nicht gefunden")
        End If

    End Sub
    ''' <summary>
    ''' vergleicht das selektierte Projekt, in Abhängigkeit von compareType mit 
    ''' dem Projekt-Template, dem Beauftragungs-Stand, einer Projekt-Variante oder einem anderen Projekt
    ''' compareType = 0 Projekt-Template
    ''' compareType = 1 Projekt-Variante
    ''' compareType = 2 Beauftragung 
    ''' compareType = 3 anderes Projekt
    ''' compareType = 4 zwei zeitliche Versionen eines Projektes 
    ''' </summary>
    ''' <param name="compareType"></param>
    ''' <remarks></remarks>
    Public Sub awinCompareProject(ByRef hproj As clsProjekt, ByRef cproj As clsProjekt, ByVal compareType As Integer, ByVal top As Double, ByVal left As Double)

        'Dim vname As String

        Dim Werte1() As Double, Werte2() As Double
        Dim listeRollen As New Collection
        Dim listeKosten As New Collection
        Dim listeTemp As New Collection
        Dim hvproj As New clsProjektvorlage
        Dim i As Integer
        Dim width As Double, height As Double
        Dim atLeastOne As Boolean = False
        Dim awinMessage As String = " ... es sind keine Unterschiede festzustellen  ..."
        Dim pname2 As String = cproj.name
        Dim pname1 As String = hproj.name
        Dim titel1 As String = pname1, titel2 As String = pname2


        If (pname1 = pname2) And hproj.variantName = cproj.variantName Then
            If compareType = 3 Then
                ' Vergleich mit Beauftragung
                titel1 = pname1 & " (" & hproj.timeStamp.ToString & ")"
                titel2 = "Beauftragung (" & cproj.timeStamp.ToString & ")"
            ElseIf compareType = 4 Then
                ' Vergleich mit Beauftragung
                titel1 = pname1 & " (" & hproj.timeStamp.ToString & ")"
                titel2 = "akt. Stand (" & cproj.timeStamp.ToString & ")"
            End If
            ' die verschiedenen Planungs-Stände eines Projektes werden miteinander verglichen 
        End If


        ' als erstes werden alle entweder in aktueller Stand bzw in Vorlage vorhandenen Rollen/Kostenarten gesucht  
        ' und werden in listeRollen bzw listeKosten gespeichert

        listeRollen = hproj.getRoleNames
        listeTemp = cproj.getRoleNames
        For i = 1 To listeTemp.Count
            Try
                If Not listeRollen.Contains(CStr(listeTemp.Item(i))) Then
                    listeRollen.Add(listeTemp.Item(i))
                End If
            Catch ex As Exception

            End Try

        Next

        listeKosten = hproj.getCostNames
        listeTemp = cproj.getCostNames

        For i = 1 To listeTemp.Count
            Try
                If Not listeKosten.Contains(CStr(listeTemp.Item(i))) Then
                    listeKosten.Add(listeTemp.Item(i))
                End If
            Catch ex As Exception

            End Try

        Next


        ' neu 
        '
        ' die Position des Diagramms wird ausgerechnet ...
        '



        height = 180
        width = hproj.anzahlRasterElemente * boxWidth + 10


        Dim hname As String, mEinheit As String = awinSettings.kapaEinheit


        ' jetzt werden für alle  Rollenbedarfe, sofern unterschiedlich die Diagramme gezeichnet ... 
        Try
            For i = 1 To listeRollen.Count
                hname = CStr(listeRollen.Item(i))
                Werte1 = hproj.getRessourcenBedarf(hname)
                Werte2 = cproj.getRessourcenBedarf(hname)
                If arraysAreDifferent(Werte1, Werte2) Then
                    ' if absolut then 
                    Call ShowDiagramCompare(titel1, Werte1, titel2, Werte2, hname, mEinheit, top, left, width, height)
                    'Else
                    '    Call ShowDiagramCompare2(name1, Werte1, name2, Werte2, hname, mEinheit, top, left, width, height)
                    'End If
                    atLeastOne = True
                    top = top + 10
                    left = left + 10
                End If

            Next
        Catch ex As Exception

        End Try


        ' jetzt werden für alle  Kostenbedarfe, sofern unterschiedlich die Diagramme gezeichnet ... 

        mEinheit = "T€"
        Try
            For i = 1 To listeKosten.Count
                hname = CStr(listeKosten.Item(i))
                Werte1 = hproj.getKostenBedarf(hname)
                Werte2 = cproj.getKostenBedarf(hname)
                If arraysAreDifferent(Werte1, Werte2) Then

                    Call ShowDiagramCompare(titel1, Werte1, titel2, Werte2, hname, mEinheit, top, left, width, height)
                    'Else
                    '    Call ShowDiagramCompare2(name1, Werte1, name2, Werte2, hname, mEinheit, top, left, width, height)
                    'End If
                    atLeastOne = True
                    top = top + 10
                    left = left + 10
                End If

            Next
        Catch ex As Exception

        End Try


        ' jetzt wird für die Gesamt-Kosten, sofern unterschiedlich das Diagramm gezeichnet ... 

        mEinheit = "T€"
        hname = "Gesamtkosten"
        Werte1 = hproj.getGesamtKostenBedarf
        Werte2 = cproj.getGesamtKostenBedarf
        If arraysAreDifferent(Werte1, Werte2) Then
            'If absolut Then
            Try
                Call ShowDiagramCompare(titel1, Werte1, titel2, Werte2, hname, mEinheit, top, left, width, height)
                'Else
                '    Call ShowDiagramCompare2(name1, Werte1, name2, Werte2, hname, mEinheit, top, left, width, height)
                'End If
                atLeastOne = True
                top = top + 10
                left = left + 10
            Catch ex As Exception
                awinMessage = ex.Message
                atLeastOne = False
            End Try

        End If

        If Not atLeastOne Then
            Call MsgBox(awinMessage)
        End If

    End Sub

    ''' <summary>
    ''' vergleicht die Phasen der beiden übergebenen Projekte, in Abhängigkeit von compareType mit 
    ''' dem Projekt-Template, dem Beauftragungs-Stand, einer Projekt-Variante oder einem anderen Projekt
    ''' compareType = 0 Projekt-Template, name2= ""
    ''' compareType = 1 Projekt-Variante, name2=varianten-Name
    ''' compareType = 2 Beauftragung , name=""
    ''' compareType = 3 anderes Projekt, name=Name des Projektes
    ''' </summary>
    ''' <param name="hproj">home-Projekt</param>
    ''' <param name="htitel">Bezeichnung Home Projekt</param>
    ''' <param name="cproj">compare Projekt</param>
    ''' <param name="ctitel">Bezeichnung compare Projekt</param>
    ''' <param name="compareType">
    ''' 0 - mit template vergleichen
    ''' 1 - Projekt-Variante vergleichen
    ''' 2 - mit anderer zeitlicher Version des gleichen Projekts 
    ''' 3 - anderes Projekt
    ''' </param>
    ''' <remarks></remarks>
    Public Sub awinCompareProjectPhases(ByVal hproj As clsProjekt, ByVal htitel As String,
                                        ByVal cproj As clsProjekt, ByVal ctitel As String,
                                        ByVal compareType As Integer,
                                        ByRef chtobj As Excel.ChartObject)

        Dim vname As String, phaseNameID As String
        'Dim Werte1() As Double, Werte2() As Double
        Dim listeRollen As New Collection
        Dim listeKosten As New Collection
        Dim listeTemp As New Collection
        Dim hvproj As New clsProjektvorlage
        Dim i As Integer
        Dim top As Double, left As Double, width As Double, height As Double
        Dim atLeastOne As Boolean = False

        Dim mxAnzPhasen As Integer
        Dim tdatenreihe1() As Double, tdatenreihe2() As Double
        Dim tdatenreihe3() As Double, tdatenreihe4() As Double
        Dim tdatenreihe5() As Double, tdatenreihe6() As Double, tdatenreihe7() As Double

        Dim diagramTitle As String
        Dim anzDiagrams As Integer
        Dim found As Boolean
        Dim plen As Integer

        Dim Xdatenreihe() As String
        Dim valueColor() As Object

        Dim chtTitle As String
        'Dim pstart As Integer
        Dim ergListe As New Collection

        ' der Text, der in der Legende steht
        Dim hlegendText As String, clegendText As String

        ' je nach compare Typ werden jetzt die ChartTitel und Legendentexte gesetzt ...
        Try

            Select Case compareType
                Case 0 ' Vergleich mit Vorlage
                    vname = hproj.VorlagenName

                    hvproj = Projektvorlagen.getProject(vname)
                    hvproj.copyTo(cproj)
                    cproj.name = "Vorlage " & vname.Trim
                    ctitel = cproj.name

                    diagramTitle = "Vergleich mit Vorlage"
                    hlegendText = hproj.name & "( " & hproj.timeStamp.ToShortDateString & " )"
                    clegendText = cproj.name

                Case 1 ' Vergleich mit Projekt-Variante
                    diagramTitle = "Vergleich von zwei Projekt-Varianten"
                    hlegendText = htitel & ", Variante: " & hproj.variantName
                    clegendText = ctitel & ", Variante: " & cproj.variantName

                Case 2 ' Vergleich mit anderer zeitlicher Version 
                    diagramTitle = "Vergleich zeitlicher Versionen" & vbLf & hproj.name
                    hlegendText = htitel
                    clegendText = ctitel

                Case 3 ' Vergleich mit anderem Projekt

                    diagramTitle = "Vergleich von zwei Projekten"
                    hlegendText = htitel
                    clegendText = ctitel

                Case Else

                    Throw New ArgumentException("keine Aktion definiert für Comparetype = " & compareType)

            End Select



        Catch ex As Exception

            Throw New Exception("Fehler in compareProjectPhases: " & ex.Message)

        End Try







        ' in ErgListe werden jetzt alle Phasen-Namen aufgeführt, die entweder in cproj oder in hproj vorkommen 

        For Each cphase In hproj.Liste

            If Not ergListe.Contains(cphase.nameID) Then
                ergListe.Add(cphase.nameID, cphase.nameID)
            End If

        Next









        ' in cproj könnten ja Phasen auftauchen, die in hproj nicht drin sind ...
        For Each cphase In cproj.Liste

            If Not ergListe.Contains(cphase.nameID) Then
                ergListe.Add(cphase.nameID, cphase.nameID)
            End If

        Next


        mxAnzPhasen = ergListe.Count


        appInstance.EnableEvents = False
        appInstance.ScreenUpdating = False

        '
        ' hole die größere der beiden Projektdauern
        '

        plen = System.Math.Max(hproj.dauerInDays, cproj.dauerInDays)


        ReDim Xdatenreihe(mxAnzPhasen - 1)
        ReDim tdatenreihe1(mxAnzPhasen - 1)
        ReDim tdatenreihe2(mxAnzPhasen - 1)
        ReDim tdatenreihe3(mxAnzPhasen - 1)
        ReDim tdatenreihe4(mxAnzPhasen - 1)
        ReDim tdatenreihe5(mxAnzPhasen - 1)
        ReDim tdatenreihe6(mxAnzPhasen - 1)
        ReDim tdatenreihe7(mxAnzPhasen - 1)


        ReDim valueColor(mxAnzPhasen - 1)

        For i = 1 To mxAnzPhasen
            phaseNameID = CStr(ergListe.Item(i))
            Xdatenreihe(i - 1) = elemNameOfElemID(phaseNameID)
        Next i



        'ReDim hsum(anzPhasen - 1)

        Dim p1(1) As Integer, p2(1) As Integer
        Dim vgl(1) As Integer, vgl2(1) As Integer
        Dim p1Vorp2 As Boolean

        For i = 1 To mxAnzPhasen
            ReDim p1(1)
            ReDim p2(1)
            ReDim vgl(1)
            ReDim vgl2(1)
            p1Vorp2 = False
            phaseNameID = CStr(ergListe.Item(i))

            Try
                With hproj.getPhaseByID(phaseNameID)
                    p1(0) = .startOffsetinDays
                    p1(1) = .startOffsetinDays + .dauerInDays - 1
                End With

                Try
                    With cproj.getPhaseByID(phaseNameID)
                        p2(0) = .startOffsetinDays
                        p2(1) = .startOffsetinDays + .dauerInDays - 1
                    End With
                    ' sowohl Projekt 1 als auch Projekt 2 haben die Phase 
                    '
                    ' Bestimmen tdatenreihe1 - Null-Farbe von Anfang bis Start P1 bzw Start P2 
                    vgl(0) = p1(0)
                    vgl(1) = p2(0)
                    tdatenreihe1(i - 1) = vgl.Min - 1

                    ' bestimmen tdatenreihe2(i-1) - wenn p1 vor p2 steht 
                    tdatenreihe2(i - 1) = p2(0) - p1(0)
                    If tdatenreihe2(i - 1) < 0 Then
                        p1Vorp2 = False
                        tdatenreihe2(i - 1) = 0
                    End If

                    ' bestimmen tdatenreihe3(i-1) - wenn p2 vor p1 steht 
                    tdatenreihe3(i - 1) = p1(0) - p2(0)
                    If tdatenreihe3(i - 1) < 0 Then
                        p1Vorp2 = True
                        tdatenreihe3(i - 1) = 0
                    End If

                    ' bestimmen tdatenreihe4 - wie groß ist die Lücke zwischen beiden, wenn sie sich nicht überlappen .. 
                    If p1Vorp2 Then
                        tdatenreihe4(i - 1) = p2(0) - p1(1) - 1
                    Else
                        tdatenreihe4(i - 1) = p1(0) - p2(1) - 1
                    End If

                    If tdatenreihe4(i - 1) < 0 Then
                        tdatenreihe4(i - 1) = 0
                    End If


                    ' bestimmen tdatenreihe5 - wieviel haben beide gemeinsam 
                    vgl(0) = p1(0)
                    vgl(1) = p2(0)
                    vgl2(0) = p1(1)
                    vgl2(1) = p2(1)

                    tdatenreihe5(i - 1) = vgl2.Min - vgl.Max + 1
                    If tdatenreihe5(i - 1) < 0 Then
                        tdatenreihe5(i - 1) = 0
                    End If


                    ' bestimmen tdatenreihe6 - der Teil, um den P1 länger dauert als P2  
                    tdatenreihe6(i - 1) = p1(1) - p2(1)
                    If tdatenreihe6(i - 1) < 0 Then
                        tdatenreihe6(i - 1) = 0
                    End If

                    ' bestimmen tdatenreihe7 - der Teil, um den P2 länger dauert als P1  
                    tdatenreihe7(i - 1) = p2(1) - p1(1)
                    If tdatenreihe7(i - 1) < 0 Then
                        tdatenreihe7(i - 1) = 0
                    End If

                Catch ex1 As Exception

                    ' Projekt2 hat die Phase nicht ...
                    tdatenreihe1(i - 1) = p1(0) - 1
                    tdatenreihe5(i - 1) = p1(1) - p1(0) + 1

                End Try
            Catch ex As Exception

                ' Projekt1 hat die Phase nicht ...
                Try
                    With cproj.getPhaseByID(phaseNameID)
                        p2(0) = .startOffsetinDays
                        p2(1) = .startOffsetinDays + .dauerInDays - 1
                    End With

                    ' Projekt2 hat die Phase, Projekt1 hat sie nicht 
                    tdatenreihe1(i - 1) = p2(0) - 1
                    tdatenreihe6(i - 1) = p2(1) - p2(0) + 1


                Catch ex2 As Exception
                    ' weder Projekt1 noch PRojekt 2 hat die Phase - kann eigentlich nicht sein
                    ' in der ergListe sind per-Definitionem nur Namen, die mind in einem vorkoammen 
                    Throw New ArgumentException("in awinCompareProjectPhases: " & ex2.Message)
                    Exit Sub
                End Try


            End Try

        Next i

        '
        ' die Position des Diagramms wird ausgerechnet ...
        '

        top = 48 + hproj.tfZeile * 15
        left = (hproj.tfspalte - 1) * boxWidth - 5

        If left < 0 Then
            left = 5
        End If

        height = (mxAnzPhasen - 1) * 20 + 90
        width = plen / 365 * 12 * boxWidth + 10




        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            found = False
            While i <= anzDiagrams And Not found
                Try
                    chtTitle = CType(.ChartObjects(i), Excel.ChartObject).Chart.ChartTitle.Text
                Catch ex As Exception
                    chtTitle = " "
                End Try
                If chtTitle = diagramTitle Then
                    found = True
                Else
                    i = i + 1
                End If

            End While

            If found Then
                MsgBox(" Diagramm wird bereits angezeigt ...")
            Else

                With appInstance.Charts.Add
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(.SeriesCollection.count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try

                    'Aufbau der Series 
                    With .SeriesCollection.NewSeries
                        .name = "null"
                        .Interior.colorindex = -4142
                        .Values = tdatenreihe1
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlBarStacked
                    End With

                    With .SeriesCollection.NewSeries
                        .name = "P1 steht vor P2"
                        .Interior.color = vergleichsfarbe1
                        .Values = tdatenreihe2
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlBarStacked
                    End With

                    With .SeriesCollection.NewSeries
                        .name = "P2 steht vor P1"
                        .Interior.color = vergleichsfarbe2
                        .Values = tdatenreihe3
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlBarStacked
                    End With

                    With .SeriesCollection.NewSeries
                        .name = "Lücke zwischen P1 und P2"
                        .Interior.colorindex = -4142
                        .Values = tdatenreihe4
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlBarStacked
                    End With

                    With .SeriesCollection.NewSeries
                        .name = "identisch"
                        .Interior.color = vergleichsfarbe0
                        .Values = tdatenreihe5
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlBarStacked
                    End With

                    With .SeriesCollection.NewSeries
                        .name = "P1 endet nach P2"
                        .Interior.color = vergleichsfarbe1
                        .Values = tdatenreihe6
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlBarStacked
                    End With

                    With .SeriesCollection.NewSeries
                        .name = "P2 endet nach P1"
                        .Interior.color = vergleichsfarbe2
                        .Values = tdatenreihe7
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlBarStacked
                    End With


                    .HasAxis(Excel.XlAxisType.xlCategory) = True
                    .HasAxis(Excel.XlAxisType.xlValue) = True

                    With .Axes(Excel.XlAxisType.xlCategory)
                        .HasTitle = False
                        .ReversePlotOrder = True
                        '.MinimumScale = 0
                        'With .AxisTitle
                        '    .Characters.text = "Phasen"
                        '    .Font.Size = 8
                        'End With
                    End With

                    With .Axes(Excel.XlAxisType.xlValue)
                        .HasTitle = True
                        .MinimumScale = 0
                        .MaximumScale = plen

                        With .AxisTitle
                            .Characters.text = "Tage"
                            .Font.Size = 8
                        End With
                    End With

                    .HasLegend = False

                    'With .Legend
                    '    .Position = XlConstants.xlTop
                    '    .Font.Size = 8
                    'End With

                    .HasTitle = True
                    .ChartTitle.Text = diagramTitle
                    .ChartTitle.font.size = 10

                    Dim achieved As Boolean = False
                    Dim anzahlVersuche As Integer = 0
                    Dim errmsg As String = ""
                    Do While Not achieved And anzahlVersuche < 10
                        Try
                            'Call Sleep(100)
                            .Location(Where:=xlNS.XlChartLocation.xlLocationAsObject, Name:=appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)).name)
                            achieved = True
                        Catch ex As Exception
                            errmsg = ex.Message
                            'Call Sleep(100)
                            anzahlVersuche = anzahlVersuche + 1
                        End Try
                    Loop

                    If Not achieved Then
                        Throw New ArgumentException("Chart-Fehler:" & errmsg)
                    End If


                End With

                ' jetzt kommt die Korrektur der Größe; herausfinden, wieviel Raum die Axis Beschriftung einnimmt ... 
                With .ChartObjects(anzDiagrams + 1)
                    .top = top
                    .height = mxAnzPhasen * 20 + 70

                    Dim axCleft As Double, axCwidth As Double
                    If .Chart.HasAxis(Excel.XlAxisType.xlCategory) = True Then
                        With CType(.Chart.Axes(Excel.XlAxisType.xlCategory), Excel.Axis)
                            axCleft = .Left
                            axCwidth = .Width
                        End With
                        If left - axCwidth < 1 Then
                            .left = 1
                            .width = width + left + 9
                        Else
                            .left = left - axCwidth
                            .width = width + axCwidth + 9
                        End If
                    Else
                        .left = left
                        .width = width
                    End If



                End With


            End If


        End With


        'Call awinScrollintoView()
        appInstance.EnableEvents = True
        appInstance.ScreenUpdating = True



    End Sub

    ''' <summary>
    ''' gibt zurück, ob die beiden sortierten Listen vom Datum her identisch sind; 
    ''' die Namen werden nicht berücksichtigt 
    ''' </summary>
    ''' <param name="liste1"></param>
    ''' <param name="liste2"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function dateListsareDifferent(ByRef liste1 As SortedList(Of Date, String),
                                              ByRef liste2 As SortedList(Of Date, String)) As Boolean
        Dim isDifferent As Boolean = False
        Dim anzItems As Integer = liste1.Count

        If liste1.Count <> liste2.Count Then
            isDifferent = True
        Else
            Dim i As Integer = 1
            Do While i <= anzItems And Not isDifferent
                If DateDiff(DateInterval.Day, liste1.ElementAt(i - 1).Key, liste2.ElementAt(i - 1).Key) <> 0 Then
                    isDifferent = True
                End If
                i = i + 1
            Loop
        End If


        dateListsareDifferent = isDifferent

    End Function
    ''' <summary>
    ''' prüft ob zwei Arrays sowohl in der Länge als auch in den Werten absolut identisch sind
    ''' absolute Identität ist nicht gefordert , es muss auf 0.000001% genau sein 
    ''' </summary>
    ''' <param name="values1"></param>
    ''' <param name="values2"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function arraysAreDifferent(ByVal values1() As Double, ByVal values2() As Double) As Boolean

        Dim istIdentisch As Boolean = True
        Dim i As Integer
        Dim toleranzSchwelle As Double = 0.000001


        Try

            If IsNothing(values1) And IsNothing(values2) Then
                istIdentisch = True

            ElseIf ((Not IsNothing(values1)) And (Not IsNothing(values2))) Then
                If values1.Length <> values2.Length Then
                    istIdentisch = False
                End If
                i = 0
                While i <= values1.Length - 1 And istIdentisch
                    If values1(i) <> values2(i) Then

                        If System.Math.Abs(values1(i) - values2(i)) > toleranzSchwelle Then
                            istIdentisch = False
                        Else
                            i = i + 1
                        End If

                    Else
                        i = i + 1
                    End If
                End While

            Else
                istIdentisch = False
            End If



        Catch ex As Exception
            Call MsgBox(ex.Message & " in arraysAreDifferent")
        End Try

        arraysAreDifferent = Not istIdentisch


    End Function

    ''' <summary>
    ''' prüft ob zwei Collections of string identisch sind 
    ''' </summary>
    ''' <param name="Collection1"></param>
    ''' <param name="Collection2"></param>
    ''' <returns></returns>
    Public Function collectionsAreDifferent(ByVal Collection1 As Collection, ByVal Collection2 As Collection) As Boolean

        Dim isDifferent As Boolean = False

        If Collection1.Count <> Collection2.Count Then
            isDifferent = True
        Else
            For Each item As String In Collection1
                If Not Collection2.Contains(item) Then
                    isDifferent = True
                End If
            Next
        End If

        collectionsAreDifferent = isDifferent
    End Function

    ''' <summary>
    ''' prüft, ob zwei sortierte Listen (string, string) in Ihren Keys identisch sind 
    ''' </summary>
    ''' <param name="type" >0: Deliverables
    ''' 1: String Custom Fields
    ''' 2: Double Custom Fields
    ''' 3: Bool Custom Fields</param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function sortedListsAreDifferent(ByVal slist1 As SortedList(Of String, String),
                                                    ByVal slist2 As SortedList(Of String, String),
                                                    ByVal type As Integer,
                                                    Optional ByVal istVorlage As Boolean = False) As Boolean

        Dim istIdentisch As Boolean = True
        Dim i As Integer
        Dim ok As Boolean = True
        Dim alsoCompareValues As Boolean

        Try
            Select Case type
                Case 0
                    ' sortedlist of String, string, Deliverables
                    alsoCompareValues = False
                Case 1
                    ' String Values
                    If Not istVorlage Then
                        alsoCompareValues = True
                    End If

                Case 2
                    '  Double Values
                    If Not istVorlage Then
                        alsoCompareValues = True
                    End If

                Case 3
                    ' Boolean Values  
                    If Not istVorlage Then
                        alsoCompareValues = True
                    End If
                Case Else
                    ok = False
                    slist1 = New SortedList(Of String, String)
                    slist2 = New SortedList(Of String, String)
                    alsoCompareValues = True

            End Select
        Catch ex As Exception
            istIdentisch = False
            ok = False
        End Try


        Try

            If CBool(slist1.Count <> slist2.Count) Or Not ok Then
                istIdentisch = False

            Else
                i = 0
                While CBool(i <= slist1.Count - 1) And istIdentisch

                    Try
                        If alsoCompareValues Then
                            If CBool(slist1.ElementAt(i).Key <> slist2.ElementAt(i).Key) Or
                                CBool(slist1.ElementAt(i).Value <> slist2.ElementAt(i).Value) Then
                                istIdentisch = False
                            Else
                                i = i + 1
                            End If
                        Else
                            If CBool(slist1.ElementAt(i).Key <> slist2.ElementAt(i).Key) Then
                                istIdentisch = False
                            Else
                                i = i + 1
                            End If
                        End If
                    Catch ex As Exception
                        istIdentisch = False
                    End Try


                End While
            End If

        Catch ex As Exception
            Call MsgBox(ex.Message & " in sortedListsAreDifferent")
        End Try

        sortedListsAreDifferent = Not istIdentisch

    End Function

    ''' <summary>
    ''' prüft ob zwei sortierte Listen (integer, String) in ihren Werte identisch sind
    ''' es wird auf Identität der keys geprüft, je nach type wird auch auch auf Identität values geprüft
    ''' </summary>
    ''' <param name="slist1"></param>
    ''' <param name="slist2"></param>
    ''' <param name="type"></param>
    ''' <param name="istVorlage"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function sortedListsAreDifferent(ByVal slist1 As SortedList(Of Integer, String),
                                                        ByVal slist2 As SortedList(Of Integer, String),
                                                        ByVal type As Integer,
                                                        Optional ByVal istVorlage As Boolean = False) As Boolean

        Dim istIdentisch As Boolean = True
        Dim i As Integer
        Dim ok As Boolean = True
        Dim alsoCompareValues As Boolean


        Try
            Select Case type
                Case 0
                    ' sortedlist of String, string, Deliverables
                    alsoCompareValues = False
                Case 1
                    ' Custom String Fields
                    If Not istVorlage Then
                        alsoCompareValues = True
                    End If

                Case 2
                    ' Custom Double Fields
                    If Not istVorlage Then
                        alsoCompareValues = True
                    End If

                Case 3
                    ' Custom Boolean 
                    If Not istVorlage Then
                        alsoCompareValues = True
                    End If
                Case Else
                    ok = False
                    alsoCompareValues = True

            End Select
        Catch ex As Exception
            istIdentisch = False
            ok = False
        End Try


        Try

            If CBool(slist1.Count <> slist2.Count) Or Not ok Then
                istIdentisch = False

            Else
                i = 0
                While CBool(i <= slist1.Count - 1) And istIdentisch

                    Try
                        If alsoCompareValues Then
                            If CBool(slist1.ElementAt(i).Key <> slist2.ElementAt(i).Key) Or
                                CBool(slist1.ElementAt(i).Value <> slist2.ElementAt(i).Value) Then
                                istIdentisch = False
                            Else
                                i = i + 1
                            End If
                        Else
                            If CBool(slist1.ElementAt(i).Key <> slist2.ElementAt(i).Key) Then
                                istIdentisch = False
                            Else
                                i = i + 1
                            End If
                        End If
                    Catch ex As Exception
                        istIdentisch = False
                    End Try


                End While
            End If

        Catch ex As Exception
            Call MsgBox(ex.Message & " in sortedListsAreDifferent")
        End Try

        sortedListsAreDifferent = Not istIdentisch

    End Function

    ''' <summary>
    ''' prüft ob zwei sortierte Listen (integer, Double) in ihren Werte identisch sind
    ''' es wird auf Identität der keys geprüft, je nach type wird auch auch auf Identität values geprüft
    ''' </summary>
    ''' <param name="slist1"></param>
    ''' <param name="slist2"></param>
    ''' <param name="type"></param>
    ''' <param name="istVorlage"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function sortedListsAreDifferent(ByVal slist1 As SortedList(Of Integer, Double),
                                            ByVal slist2 As SortedList(Of Integer, Double),
                                                        ByVal type As Integer,
                                                        Optional ByVal istVorlage As Boolean = False) As Boolean

        Dim istIdentisch As Boolean = True
        Dim i As Integer
        Dim ok As Boolean = True
        Dim alsoCompareValues As Boolean


        Try
            Select Case type
                Case 0
                    ' sortedlist of String, string, Deliverables
                    alsoCompareValues = False
                Case 1
                    ' Custom String Fields
                    If Not istVorlage Then
                        alsoCompareValues = True
                    End If

                Case 2
                    ' Custom Double Fields
                    If Not istVorlage Then
                        alsoCompareValues = True
                    End If

                Case 3
                    ' Custom Boolean 
                    If Not istVorlage Then
                        alsoCompareValues = True
                    End If
                Case Else
                    ok = False
                    alsoCompareValues = True

            End Select
        Catch ex As Exception
            istIdentisch = False
            ok = False
        End Try


        Try

            If CBool(slist1.Count <> slist2.Count) Or Not ok Then
                istIdentisch = False

            Else
                i = 0
                While CBool(i <= slist1.Count - 1) And istIdentisch

                    Try
                        If alsoCompareValues Then
                            If CBool(slist1.ElementAt(i).Key <> slist2.ElementAt(i).Key) Or
                                CBool(slist1.ElementAt(i).Value <> slist2.ElementAt(i).Value) Then
                                istIdentisch = False
                            Else
                                i = i + 1
                            End If
                        Else
                            If CBool(slist1.ElementAt(i).Key <> slist2.ElementAt(i).Key) Then
                                istIdentisch = False
                            Else
                                i = i + 1
                            End If
                        End If
                    Catch ex As Exception
                        istIdentisch = False
                    End Try


                End While
            End If

        Catch ex As Exception
            Call MsgBox(ex.Message & " in sortedListsAreDifferent")
        End Try

        sortedListsAreDifferent = Not istIdentisch

    End Function

    ''' <summary>
    ''' prüft ob zwei sortierte Listen (integer, Boolean) in ihren Werte identisch sind
    ''' es wird auf Identität der keys geprüft, je nach type wird auch auch auf Identität values geprüft
    ''' </summary>
    ''' <param name="slist1"></param>
    ''' <param name="slist2"></param>
    ''' <param name="type"></param>
    ''' <param name="istVorlage"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function sortedListsAreDifferent(ByVal slist1 As SortedList(Of Integer, Boolean),
                                            ByVal slist2 As SortedList(Of Integer, Boolean),
                                                        ByVal type As Integer,
                                                        Optional ByVal istVorlage As Boolean = False) As Boolean

        Dim istIdentisch As Boolean = True
        Dim i As Integer
        Dim ok As Boolean = True
        Dim alsoCompareValues As Boolean


        Try
            Select Case type
                Case 0
                    ' sortedlist of String, string, Deliverables
                    alsoCompareValues = False
                Case 1
                    ' Custom String Fields
                    If Not istVorlage Then
                        alsoCompareValues = True
                    End If

                Case 2
                    ' Custom Double Fields
                    If Not istVorlage Then
                        alsoCompareValues = True
                    End If

                Case 3
                    ' Custom Boolean 
                    If Not istVorlage Then
                        alsoCompareValues = True
                    End If
                Case Else
                    ok = False
                    alsoCompareValues = True

            End Select
        Catch ex As Exception
            istIdentisch = False
            ok = False
        End Try


        Try

            If CBool(slist1.Count <> slist2.Count) Or Not ok Then
                istIdentisch = False

            Else
                i = 0
                While CBool(i <= slist1.Count - 1) And istIdentisch

                    Try
                        If alsoCompareValues Then
                            If CBool(slist1.ElementAt(i).Key <> slist2.ElementAt(i).Key) Or
                                CBool(slist1.ElementAt(i).Value <> slist2.ElementAt(i).Value) Then
                                istIdentisch = False
                            Else
                                i = i + 1
                            End If
                        Else
                            If CBool(slist1.ElementAt(i).Key <> slist2.ElementAt(i).Key) Then
                                istIdentisch = False
                            Else
                                i = i + 1
                            End If
                        End If
                    Catch ex As Exception
                        istIdentisch = False
                    End Try


                End While
            End If

        Catch ex As Exception
            Call MsgBox(ex.Message & " in sortedListsAreDifferent")
        End Try

        sortedListsAreDifferent = Not istIdentisch

    End Function
    '' braucht man nicht, ist durch andere sortedListsAreDifferent abgelöst ...
    '' ''' <summary>
    '' ''' prüft, ob zwei sortierte Listen in Ihren Keys identisch sind 
    '' ''' </summary>
    '' ''' <param name="list1"></param>
    '' ''' <param name="list2"></param>
    '' ''' <returns></returns>
    '' ''' <remarks></remarks>
    ''Public Function sortedListsAreDifferent(ByRef list1 As SortedList(Of String, String), _
    ''                                            ByRef list2 As SortedList(Of String, String)) As Boolean

    ''    Dim istIdentisch As Boolean = True
    ''    Dim i As Integer


    ''    Try

    ''        If list1.Count <> list2.Count Then
    ''            istIdentisch = False

    ''        Else
    ''            i = 0
    ''            While i <= list1.Count - 1 And istIdentisch
    ''                If list1.ElementAt(0).Key <> list2.ElementAt(0).Key Then
    ''                    istIdentisch = False
    ''                Else
    ''                    i = i + 1
    ''                End If
    ''            End While
    ''        End If

    ''    Catch ex As Exception
    ''        Call MsgBox(ex.Message & " in sortedListsAreDifferent")
    ''    End Try

    ''    sortedListsAreDifferent = Not istIdentisch

    ''End Function


    ''' <summary>
    ''' Prozedur zeigt die Ressourcen Bedarfe des Projektes an
    ''' Auswahl = 1 : zeige den Ressourcen Bedarf
    ''' Auswahl = 2 : zeige den Personalkosten-Bedarf
    ''' Auswahl = 3 : zeige den Gesamt-Kostenbedarf
    ''' </summary>
    ''' <param name="pname">der Projekt-Name</param>
    ''' <param name="auswahl">steuert, was gezeigt wird: Ressourcen (1), Personal-Kosten (2) oder Gesamtkosten (3) </param>
    ''' <remarks></remarks>
    Public Sub ShowDiagramsRess(ByRef projektHistorie As SortedList(Of String, clsProjekt), ByVal pname As String, ByVal auswahl As Integer)
        Dim diagramTitle As String
        Dim anzDiagrams As Integer
        Dim anzRollen As Integer
        Dim found As Boolean
        Dim r As Integer, plen As Integer
        Dim i As Integer
        Dim Xdatenreihe() As String
        Dim tdatenreihe() As Double
        Dim hsum() As Double, gesamt_summe As Double
        Dim top As Double, left As Double, width As Double, height As Double
        Dim chtTitle As String
        Dim pstart As Integer
        Dim hproj As clsProjekt
        Dim ErgebnisListeR As New Collection
        Dim roleName As String
        Dim zE As String = "(" & awinSettings.kapaEinheit & ")"

        appInstance.EnableEvents = False
        appInstance.ScreenUpdating = False

        If auswahl = 1 Then
            diagramTitle = "Ressourcen-Bedarf " & zE & vbLf & pname
        ElseIf auswahl = 2 Then
            diagramTitle = "Personalkosten (T€)" & vbLf & pname
        Else
            diagramTitle = "Gesamt " & pname
        End If

        hproj = ShowProjekte.getProject(pname)
        'projektHistorie = retrie

        '
        ' hole die Projektdauer
        '
        With hproj
            plen = .anzahlRasterElemente
            pstart = .Start
        End With

        '
        ' hole die Anzahl Rollen, die in diesem Projekt vorkommen
        '
        ErgebnisListeR = hproj.getRoleNames
        anzRollen = ErgebnisListeR.Count

        If anzRollen = 0 Then
            MsgBox("keine Ressourcen-Bedarfe definiert")
            Exit Sub
        End If


        ReDim Xdatenreihe(plen - 1)
        ReDim tdatenreihe(plen - 1)


        ReDim hsum(anzRollen - 1)

        'For m = 0 To plen - 1
        '    Xdatenreihe(m) = "" & m + 1
        'Next m

        For i = 1 To plen
            Xdatenreihe(i - 1) = StartofCalendar.AddMonths(pstart + i - 2).ToString("MMM yy", repCult)
        Next i


        ' neu 
        '
        ' die Position des Diagramms wird ausgerechnet ...
        '
        top = 48 + (hproj.tfZeile) * 15
        left = (hproj.tfspalte - 1) * boxWidth - 5
        If left < 0 Then
            left = 0
        End If
        height = awinSettings.ChartHoehe1
        width = plen * boxWidth + 10

        gesamt_summe = 0

        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
            anzDiagrams = CType(.ChartObjects, Excel.ChartObjects).Count
            '
            ' um welches Diagramm handelt es sich ...
            '
            i = 1
            found = False
            While i <= anzDiagrams And Not found
                Try
                    chtTitle = CType(.ChartObjects(i), Excel.ChartObject).Chart.ChartTitle.Text
                Catch ex As Exception
                    chtTitle = " "
                End Try
                If chtTitle = diagramTitle Then
                    found = True
                Else
                    i = i + 1
                End If

            End While

            If found Then
                MsgBox(" Diagramm wird bereits angezeigt ...")
            Else

                With appInstance.Charts.Add
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(.SeriesCollection.count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try



                    For r = 1 To anzRollen
                        roleName = CStr(ErgebnisListeR.Item(r))
                        If auswahl = 1 Then
                            tdatenreihe = hproj.getRessourcenBedarf(roleName)
                        Else
                            tdatenreihe = hproj.getRessourcenBedarf(roleName, outPutInEuro:=True)
                        End If
                        hsum(r - 1) = 0
                        For i = 0 To plen - 1
                            hsum(r - 1) = hsum(r - 1) + tdatenreihe(i)
                        Next i
                        gesamt_summe = gesamt_summe + hsum(r - 1)

                        'series
                        With .SeriesCollection.NewSeries
                            .name = roleName
                            .Interior.color = RoleDefinitions.getRoledef(roleName).farbe
                            .Values = tdatenreihe
                            .XValues = Xdatenreihe
                            .ChartType = Excel.XlChartType.xlColumnStacked
                        End With

                    Next r

                    .HasAxis(Excel.XlAxisType.xlCategory) = True
                    .HasAxis(Excel.XlAxisType.xlValue) = True

                    With .Axes(Excel.XlAxisType.xlCategory)
                        .HasTitle = False
                        '.MinimumScale = 0
                        'With .AxisTitle
                        '    .Characters.text = "Monate"
                        '    .Font.Size = 8
                        'End With
                    End With

                    With .Axes(Excel.XlAxisType.xlValue)
                        .HasTitle = False
                        .MinimumScale = 0

                        'With .AxisTitle
                        '    If auswahl = 1 Then
                        '        .Characters.text = "Ressourcen"
                        '    Else
                        '        .Characters.text = "Personalkosten"
                        '    End If
                        '    .Font.Size = 8
                        'End With
                    End With

                    .HasLegend = True
                    With .Legend
                        .Position = Excel.Constants.xlTop
                        .Font.Size = awinSettings.fontsizeItems
                    End With
                    .HasTitle = True
                    .ChartTitle.Text = diagramTitle
                    .ChartTitle.font.size = awinSettings.fontsizeTitle

                    Dim achieved As Boolean = False
                    Dim anzahlVersuche As Integer = 0
                    Dim errmsg As String = ""
                    Do While Not achieved And anzahlVersuche < 10
                        Try
                            'Call Sleep(100)
                            .Location(Where:=xlNS.XlChartLocation.xlLocationAsObject, Name:=appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)).name)
                            achieved = True
                        Catch ex As Exception
                            errmsg = ex.Message
                            'Call Sleep(100)
                            anzahlVersuche = anzahlVersuche + 1
                        End Try
                    Loop

                    If Not achieved Then
                        Throw New ArgumentException("Chart-Fehler:" & errmsg)
                    End If



                End With

                ' jetzt kommt die Korrektur der Größe; herausfinden, wieviel Raum die Axis Beschriftung einnimmt ... 
                With .ChartObjects(anzDiagrams + 1)
                    .top = top
                    .height = 2 * height

                    Dim axleft As Double, axwidth As Double
                    If .Chart.HasAxis(Excel.XlAxisType.xlValue) = True Then
                        With CType(.Chart.Axes(Excel.XlAxisType.xlValue), Excel.Axis)
                            axleft = .Left
                            axwidth = .Width
                        End With
                        If left - axwidth < 1 Then
                            left = 1
                            width = width + left + 9
                        Else
                            left = left - axwidth
                            width = width + axwidth + 9
                        End If

                    End If

                    .left = left
                    .width = width


                End With


                'With .ChartObjects(anzDiagrams + 1)
                '    .top = top
                '    .left = left
                '    .height = 2 * height
                '    .width = width
                'End With

                '
                ' jetzt wird das zweite Diagramm gezeichnet - Gesamt-Bedarf des Projektes
                '
                If auswahl = 1 Then
                    diagramTitle = "Summe Ressourcen-Bedarf: " & gesamt_summe & zE & vbLf & pname
                Else
                    diagramTitle = "Summe Personalkosten: " & gesamt_summe & " T€" & vbLf & pname
                End If
                ReDim tdatenreihe(anzRollen - 1)
                ReDim Xdatenreihe(anzRollen - 1)
                For r = 1 To anzRollen
                    Xdatenreihe(r - 1) = CStr(ErgebnisListeR.Item(r))
                    tdatenreihe(r - 1) = hsum(r - 1)
                Next r

                With appInstance.Charts.Add
                    ' remove old series
                    Try
                        Dim anz As Integer = CInt(.SeriesCollection.count)
                        Do While anz > 0
                            .SeriesCollection(1).Delete()
                            anz = anz - 1
                        Loop
                    Catch ex As Exception

                    End Try

                    With .SeriesCollection.NewSeries
                        .name = pname
                        .Values = tdatenreihe
                        .XValues = Xdatenreihe
                        .ChartType = Excel.XlChartType.xlPie
                        .HasDataLabels = True
                        .DataLabels.Position = Excel.XlDataLabelPosition.xlLabelPositionOutsideEnd
                    End With
                    For r = 1 To anzRollen
                        roleName = CStr(ErgebnisListeR.Item(r))
                        With .SeriesCollection(1).Points(r)
                            .Interior.color = RoleDefinitions.getRoledef(roleName).farbe
                            .DataLabel.Font.Size = 10
                        End With
                    Next r
                    '.HasLegend = False
                    .HasLegend = True
                    With .Legend
                        .Position = Excel.Constants.xlLeft
                        .Font.Size = awinSettings.fontsizeItems
                    End With

                    .HasTitle = True
                    .ChartTitle.text = diagramTitle
                    .ChartTitle.font.size = 10

                    Dim achieved As Boolean = False
                    Dim anzahlVersuche As Integer = 0
                    Dim errmsg As String = ""
                    Do While Not achieved And anzahlVersuche < 10
                        Try
                            'Call Sleep(100)
                            .Location(Where:=xlNS.XlChartLocation.xlLocationAsObject, Name:=appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)).name)
                            achieved = True
                        Catch ex As Exception
                            errmsg = ex.Message
                            'Call Sleep(100)
                            anzahlVersuche = anzahlVersuche + 1
                        End Try
                    Loop

                    If Not achieved Then
                        Throw New ArgumentException("Chart-Fehler:" & errmsg)
                    End If

                End With
                With .ChartObjects(anzDiagrams + 2)
                    .top = top
                    .left = left + width
                    .height = 10 * boxHeight
                    .width = 14 * boxWidth
                End With

            End If


        End With


        'Call awinScrollintoView()
        appInstance.EnableEvents = True
        appInstance.ScreenUpdating = True


    End Sub


    ''' <summary>
    ''' löscht die Einträge auf der Plantafel 
    ''' meist, um sie dann neu zeichnen zu können 
    ''' </summary>
    ''' <remarks></remarks>
    Public Sub awinClearPlanTafel()

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False


        ' jetzt müssen alle Shapes, die keine Charts sind, gelöscht werden ....


        For Each shp As Excel.Shape In CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Shapes

            Try
                If CBool(shp.HasChart) Then
                    ' do nothing, sollen ja erhalten bleiben 
                Else
                    shp.Delete()

                End If
            Catch ex As Exception

            End Try


        Next shp

        projectboardShapes.clear()


        ' jetzt werden für alle Projekte in Showprojekte die Verweise auf die Shapes gelöscht 
        For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste
            kvp.Value.shpUID = ""
        Next

        ' jetzt wird die Zuordnung Projektname und Shape ID gelöscht ... 
        ShowProjekte.shpListe.Clear()

        appInstance.EnableEvents = formerEE

    End Sub

    Public Sub ClearPlanTafelfromOptArrows()

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False



        ' jetzt müssen alle Shapes, die Optmmierungs-Arrows sind, gelöscht werden ....


        For Each shp As Excel.Shape In CType(appInstance.ActiveSheet, Excel.Worksheet).Shapes
            With shp

                Try
                    If shp.AutoShapeType = core.MsoAutoShapeType.msoShapeRightArrow Or
                    shp.AutoShapeType = core.MsoAutoShapeType.msoShapeLeftArrow Then
                        .Delete()
                    End If
                Catch ex As Exception

                End Try

            End With
        Next shp



        appInstance.EnableEvents = formerEE


    End Sub
    ' ''' <summary>
    ' ''' zeichnet die Plantafel mit den Projekten neu; 
    ' ''' versucht dabei immer die alte Position der Projekte zu übernehmen 
    ' ''' </summary>
    ' ''' <remarks></remarks>
    'Public Sub awinZeichnePlanTafel()

    '    Dim todoListe As New SortedList(Of Double, String)
    '    Dim key As Double
    '    Dim pname As String
    '    Dim zeile As Integer, lastZeile As Integer, curZeile As Integer, max As Integer
    '    Dim lastZeileOld As Integer
    '    Dim hproj As clsProjekt




    '    ' aufbauen der todoListe, so daß nachher die Projekte von oben nach unten gezeichnet werden können 
    '    For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

    '        With kvp.Value
    '            key = 10000 * .tfZeile + kvp.Value.Start
    '            todoListe.Add(key, .name)
    '        End With

    '    Next

    '    zeile = 2
    '    lastZeile = 0

    '    If ProjectBoardDefinitions.My.Settings.drawPhases = True Then
    '        ' dann sollen die Projekte im extended mode gezeichnet werden 
    '        ' jetzt erst mal die Konstellation "last" speichern
    '        Call awinStoreConstellation("Last")

    '        ' jetzt die todoListe abarbeiten
    '        For i = 1 To todoListe.Count
    '            pname = todoListe.ElementAt(i - 1).Value
    '            hproj = ShowProjekte.getProject(pname)

    '            If i = 1 Then
    '                curZeile = hproj.tfZeile
    '                lastZeileOld = hproj.tfZeile
    '                lastZeile = curZeile
    '                max = curZeile
    '            Else
    '                If lastZeileOld = hproj.tfZeile Then
    '                    curZeile = lastZeile
    '                Else
    '                    lastZeile = max
    '                    lastZeileOld = hproj.tfZeile
    '                End If

    '            End If

    '            hproj.tfZeile = curZeile
    '            lastZeile = curZeile
    '            'Call ZeichneProjektinPlanTafel2(pname, curZeile)
    '            Call ZeichneProjektinPlanTafel(pname, curZeile)
    '            curZeile = lastZeile + getNeededSpace(hproj)


    '            If curZeile > max Then
    '                max = curZeile
    '            End If


    '        Next

    '    Else


    '        Dim tryzeile As Integer

    '        For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste
    '            pname = kvp.Key
    '            tryzeile = kvp.Value.tfZeile
    '            If tryzeile <= 1 Then
    '                tryzeile = -1
    '            End If
    '            Call ZeichneProjektinPlanTafel(pname, tryzeile) ' es wird versucht, an der alten Stelle zu zeichnen 
    '        Next


    '    End If





    'End Sub

    ''' <summary>
    ''' lädt die angegebene Projekt-Konstellation hinzu bzw. neu
    ''' funktioniert nur, wenn sowohl Konstellation als auch alle Projekte  im Hauptspeicher sind 
    ''' </summary>
    ''' <param name="constellationName">Name der Konstellation</param>
    ''' <param name="addProjects">gibt an, ob Projekte hinzugefügt werden sollen oder ob komplett neu gezeichnet werden soll</param>
    ''' <param name="updateProjektTafel">gibt an, ob die Projekt-Tafel neu gezeichnet werden soll oder ob die Konstellation nur im Showprojekte geladen werden soll</param> 
    ''' <remarks></remarks>
    Public Sub loadSessionConstellation(ByVal constellationName As String, ByVal addProjects As Boolean,
                                        ByVal updateProjektTafel As Boolean)

        Dim activeConstellation As New clsConstellation
        Dim hproj As New clsProjekt
        Dim tfZeile As Integer
        Dim successMessage As String = ""
        Dim loadDateMessage As String = " * Das Datum kann nicht angepasst werden kann." & vbLf &
                                        "   Das Projekt wurde bereits beauftragt."

        Dim projectDidNotExistYet As Boolean = True
        Dim firstFreeZeile As Integer = projectboardShapes.getMaxZeile + 1
        Dim anzahlNeueProjekte As Integer = 0


        ' prüfen, ob diese Constellation bereits existiert ..
        Try
            activeConstellation = projectConstellations.getConstellation(constellationName)
        Catch ex As Exception
            Call MsgBox(" Projekt-Konstellation " & constellationName & " existiert nicht ")
            Exit Sub
        End Try

        ' ggf die aktuelle Konstellation in "Last" speichern 

        'If storeLast Then
        '    Call storeSessionConstellation("Last")
        'End If

        If Not addProjects And updateProjektTafel Then
            ShowProjekte.Clear()
            tfZeile = 2
        ElseIf addProjects And updateProjektTafel Then
            tfZeile = projectboardShapes.getMaxZeile + 1
        End If


        ' jetzt werden die Start-Values entsprechend gesetzt ..

        For Each kvp As KeyValuePair(Of String, clsConstellationItem) In activeConstellation.Liste

            If AlleProjekte.Containskey(kvp.Key) Then
                ' Projekt ist bereits im Hauptspeicher geladen

                hproj = AlleProjekte.getProject(kvp.Key)

                If ShowProjekte.contains(hproj.name) Then
                    With hproj
                        'Call replaceProjectVariant(.name, .variantName, False, True, 0)
                        Call replaceProjectVariant(.name, .variantName, False, True, kvp.Value.zeile)
                        projectDidNotExistYet = False
                    End With
                ElseIf kvp.Value.show = True Then
                    ShowProjekte.Add(hproj)
                    projectDidNotExistYet = True
                    anzahlNeueProjekte = anzahlNeueProjekte + 1
                End If


                With hproj

                    ' Änderung THOMAS Start 
                    If .Status = ProjektStatus(PTProjektStati.geplant) Then
                        .startDate = kvp.Value.start
                    ElseIf .startDate <> kvp.Value.start Then
                        ' wenn das Datum nicht angepasst werden kann, weil das Projekt bereits beauftragt wurde  
                        successMessage = successMessage & vbLf & vbLf & loadDateMessage & vbLf &
                                            "        " & hproj.name & ": " & kvp.Value.start.ToShortDateString
                    End If
                    ' Änderung THOMAS Ende 

                    .StartOffset = 0

                    If projectDidNotExistYet And updateProjektTafel Then
                        If addProjects Then
                            .tfZeile = firstFreeZeile + anzahlNeueProjekte
                        Else
                            .tfZeile = kvp.Value.zeile
                        End If
                    End If


                End With



            Else

                Call MsgBox("Projekt " & kvp.Value.projectName & ", Variante: " & kvp.Value.variantName & vbLf &
                             "ist nicht geladen!")

            End If


        Next

        If updateProjektTafel Then
            enableOnUpdate = False

            'appInstance.ScreenUpdating = False
            'Call diagramsVisible(False)

            Call awinClearPlanTafel()

            Call awinZeichnePlanTafel(True)

            Call awinNeuZeichnenDiagramme(2)
            'Dim vglName as string = CType(projectboardWindows(PTwindows.mpt).ActiveSheet, Excel.Worksheet).Name
            'Call diagramsVisible(True)
            'appInstance.ScreenUpdating = True


            'Call MsgBox(constellationName & " wurde geladen ..." & vbLf & vbLf & successMessage)

            enableOnUpdate = True
        End If

        ' setzen der public variable, welche Konstellation denn jetzt gesetzt ist
        currentConstellationName = constellationName

    End Sub


    Public Sub awinCalculateOptimization(ByVal diagrammTyp As String, ByRef myCollection As Collection,
                                  ByRef OptimierungsErgebnis As SortedList(Of String, clsOptimizationObject))
        Dim referenceValue As Double, newReferenceValue As Double, currentValue As Double
        Dim bestValue As Double
        Dim startoffset() As Integer
        Dim versatz As Integer
        Dim ErgebnisListe As New SortedList(Of Double, clsOptimizationObject)
        'Dim ErgebnisListe As New SortedDictionary(Of Double, clsOptimizationObject)
        Dim lokalesOptimum As clsOptimizationObject
        Dim hproj As clsProjekt
        Dim saveOffset As Integer, anzahlVersuche As Integer
        Dim NrLoops As Integer
        Dim NrArgExceptions As Integer
        Dim avgValue As Double

        ReDim startoffset(0)

        If diagrammTyp = DiagrammTypen(0) Then ' Phase 
            Call MsgBox("Phasen Optimierung noch nicht implementiert")
        ElseIf diagrammTyp = DiagrammTypen(1) Or diagrammTyp = DiagrammTypen(2) Then

            With ShowProjekte
                If diagrammTyp = DiagrammTypen(1) Then
                    referenceValue = .getbadCostOfRole(myCollection)
                Else
                    referenceValue = .getDeviationfromAverage(myCollection, avgValue, diagrammTyp)
                End If

                newReferenceValue = -1
                NrLoops = 0
                NrArgExceptions = 0


                While newReferenceValue < referenceValue And NrLoops < 5 * ShowProjekte.Count
                    ' notwendig für den zweiten , ..n. durchlauf 
                    If newReferenceValue >= 0 Then
                        referenceValue = newReferenceValue
                    End If

                    For Each kvp As KeyValuePair(Of String, clsProjekt) In .Liste

                        If relevantForOptimization(kvp.Value) Then

                            bestValue = referenceValue  ' als Startwert, der hoffentlich unterboten wird .... 
                            startoffset(0) = 0

                            For versatz = kvp.Value.earliestStart To kvp.Value.latestStart
                                If versatz <> 0 Then
                                    kvp.Value.StartOffset = versatz
                                    If diagrammTyp = DiagrammTypen(1) Then
                                        currentValue = .getbadCostOfRole(myCollection)
                                    Else
                                        currentValue = .getDeviationfromAverage(myCollection, avgValue, diagrammTyp)
                                    End If

                                    If currentValue < bestValue Then
                                        bestValue = currentValue
                                        startoffset(0) = versatz
                                    End If
                                End If
                            Next versatz

                            ' zurücksetzen des StartOffsets im Projekt, weil hier ja erst verschiedene Konstellationen probiert werden  
                            kvp.Value.StartOffset = 0

                            If startoffset(0) <> 0 Then ' es gab eine Verbesserung 
                                lokalesOptimum = New clsOptimizationObject
                                With lokalesOptimum
                                    .projectName = kvp.Key
                                    '.bestValue = bestValue
                                    .offset = startoffset
                                End With

                                Try
                                    ErgebnisListe.Add(bestValue, lokalesOptimum)
                                Catch ex As ArgumentException
                                    NrArgExceptions = NrArgExceptions + 1
                                    bestValue = bestValue + NrArgExceptions * 0.00000017
                                    Try
                                        ErgebnisListe.Add(bestValue, lokalesOptimum)
                                    Catch ex1 As ArgumentException
                                        NrArgExceptions = NrArgExceptions + 1
                                        bestValue = bestValue + NrArgExceptions * 0.00000017
                                        ErgebnisListe.Add(bestValue, lokalesOptimum)
                                    End Try
                                End Try
                            End If
                        End If

                    Next kvp
                    '
                    ' jetzt muss die Ergebnis Liste abgearbeitet werden ... 
                    '
                    anzahlVersuche = 0
                    newReferenceValue = referenceValue

                    For Each ergebnis As KeyValuePair(Of Double, clsOptimizationObject) In ErgebnisListe

                        hproj = ShowProjekte.getProject(ergebnis.Value.projectName)
                        saveOffset = hproj.StartOffset
                        hproj.StartOffset = ergebnis.Value.offset(0)

                        If diagrammTyp = DiagrammTypen(1) Then
                            currentValue = .getbadCostOfRole(myCollection)
                        Else
                            currentValue = .getDeviationfromAverage(myCollection, avgValue, diagrammTyp)
                        End If

                        If currentValue < newReferenceValue Then
                            newReferenceValue = currentValue
                            anzahlVersuche = 0
                            ' hier müssen best, second, third gesetzt werden
                        Else
                            hproj.StartOffset = saveOffset
                            anzahlVersuche = anzahlVersuche + 1
                            If anzahlVersuche > 5 Or ergebnis.Value.offset(0) = 0 Then
                                ' wenn startoffset = 0 , dann konnten keine Verbesserungen mehr erzielt werden , also Abbruch ...
                                Exit For
                            End If
                        End If
                        NrLoops = NrLoops + 1

                    Next

                    ErgebnisListe.Clear()

                End While
                ' hier wird Gold gesetzt, das heißt alle Offsets gemerkt, die für die Optmierung notwendig sind 
                ' anschließend werden alle startoffsets wieder auf 0 (=Ausgangswert) gesetzt 
                Dim tmpOffset() As Integer
                ReDim tmpOffset(0)
                OptimierungsErgebnis.Clear()
                For Each kvp As KeyValuePair(Of String, clsProjekt) In .Liste
                    If kvp.Value.StartOffset <> 0 Then
                        lokalesOptimum = New clsOptimizationObject
                        With lokalesOptimum
                            .projectName = kvp.Value.name
                            '.bestValue = bestValue
                            tmpOffset(0) = kvp.Value.StartOffset
                            .offset = tmpOffset
                        End With
                        OptimierungsErgebnis.Add(kvp.Value.name, lokalesOptimum)
                        'kvp.Value.StartOffset = 0
                    End If
                Next kvp

            End With

            'Case DiagrammTypen(2) ' Cost
            '    Call MsgBox("Kosten-Diagramm Optimierung noch nicht implementiert")
        Else
            Call MsgBox("Sonstige Optimierung noch nicht implementiert")
        End If

    End Sub

    Public Sub awinCalcOptimizationVarianten(ByVal diagrammTyp As String, ByRef myCollection As Collection,
                                             ByVal worker As BackgroundWorker, ByVal e As DoWorkEventArgs)

        Dim anzahlVarianten As Integer
        Dim maxValue() As Integer
        Dim indexValue() As Integer
        Dim anzProjMitVar As Integer
        Dim PPointer As Integer
        Dim anzSchleifen As Integer = 0
        Dim firstValue As Double = 100000000000.0
        Dim secondValue As Double = 100000000000.0
        Dim thirdValue As Double = 100000000000.0
        Dim atleastOne As Boolean = False
        Dim anzKombinationen As Integer = 1
        Dim anzOptimierungen As Integer = 0

        Dim moreThanOne As New Collection
        Dim justOne As New Collection

        ' bestimme die Collection mit Projekten mit mehr als einer Variante
        For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste
            anzahlVarianten = AlleProjekte.getVariantNames(kvp.Key, True).Count
            If anzahlVarianten = 1 Then
                justOne.Add(kvp.Key, kvp.Key)
            ElseIf anzahlVarianten > 1 Then
                moreThanOne.Add(kvp.Key, kvp.Key)
            End If
        Next


        If moreThanOne.Count = 0 Then
            e.Result = "es gibt keine Varianten .. demnach gibt es auch nichts zu optimieren !"
            worker.ReportProgress(0, e)
            Exit Sub
        Else
            ' speichern der letzten Konstellation
            Call storeSessionConstellation(autoSzenarioNamen(0))
        End If


        ' nimmt die Anzahl der Varianten auf
        anzProjMitVar = moreThanOne.Count
        ReDim maxValue(anzProjMitVar - 1)
        ReDim indexValue(anzProjMitVar - 1)

        ' jetzt wird bestimmt: 
        ' wievele Varianten hat das i.-te Element in morethanOne
        ' an welcher Stelle steht der Varianten-Zeiger Zeiger für das die bestimmt werden 
        Dim i As Integer = 0

        anzKombinationen = 1
        For Each pName As String In moreThanOne
            maxValue(i) = AlleProjekte.getVariantZahl(pName)
            ' in maxvalue steht 0, wenn es nur die Basis Variante gibt ..
            If maxValue(i) >= 0 Then
                anzKombinationen = anzKombinationen * (maxValue(i) + 1)
            End If

            indexValue(i) = 0
            i = i + 1
        Next

        PPointer = 0

        ' Start der Rekursion - und die Ausgangs-Konstellation als Vorgabe, als aktuelle "1. Varianten Optimum" behalten 
        firstValue = berechneOptimierungsWert(ShowProjekte, diagrammTyp, myCollection)
        Call storeSessionConstellation(autoSzenarioNamen(1))

        ' die anderen Szenarien sollen jetzt gelöscht werden 
        If projectConstellations.Contains(autoSzenarioNamen(2)) Then
            projectConstellations.Remove(autoSzenarioNamen(2))
        End If

        If projectConstellations.Contains(autoSzenarioNamen(3)) Then
            projectConstellations.Remove(autoSzenarioNamen(3))
        End If



        Call IterateOptimization(PPointer, anzProjMitVar, maxValue, indexValue,
                                diagrammTyp, myCollection, anzKombinationen, anzSchleifen, anzOptimierungen,
                                justOne, moreThanOne,
                                firstValue, secondValue, thirdValue,
                                worker, e)



        If anzOptimierungen > 0 Then
            ' wieder den alten Zustand herstellen 
            Call loadSessionConstellation(autoSzenarioNamen(0), False, True)
        Else
            ' es hat sich eh nichts geändert ... 
            'Call loadSessionConstellation(autoSzenarioNamen(0), False, False)
            e.Result = "in " & anzSchleifen.ToString & " Kombinationen" & vbLf & "konnte keine Verbesserung gefunden werden"
            worker.ReportProgress(0, e)

        End If


        ' erstelle alle Kombinationen der Varianten in der Variablen Current 


    End Sub




    ''' <summary>
    ''' rekursive Funktion, die die Kombinatorik der Varianten ermittelt 
    ''' </summary>
    ''' <param name="PPointer"></param>
    ''' <param name="anzProjMitVar"></param>
    ''' <param name="maxvalue"></param>
    ''' <param name="indexvalue"></param>
    ''' <param name="anzSchleifen"></param>
    ''' <remarks></remarks>
    Private Sub IterateOptimization(ByVal PPointer As Integer, ByVal anzProjMitVar As Integer,
                                           ByVal maxvalue() As Integer, ByVal indexvalue() As Integer,
                                           ByRef diagrammTyp As String, ByRef myCollection As Collection,
                                           ByVal anzKombinationen As Integer, ByRef anzSchleifen As Integer, ByRef anzOptimierungen As Integer,
                                           ByRef justOne As Collection, ByRef moreThanOne As Collection,
                                           ByRef firstValue As Double, ByRef secondValue As Double, ByRef thirdValue As Double,
                                           ByVal worker As BackgroundWorker, ByVal e As DoWorkEventArgs)

        'Dim currentSzenario As New clsProjekte
        Dim currentValue As Double
        Dim tmpConstellation As clsConstellation


        Dim hproj As clsProjekt

        If worker.CancellationPending Then
            e.Cancel = True
            e.Result = "Optimierung  abgebrochen ..."
            Exit Sub
        End If


        If PPointer = anzProjMitVar - 1 Then

            indexvalue(anzProjMitVar - 1) = 0

            While indexvalue(anzProjMitVar - 1) <= maxvalue(anzProjMitVar - 1)


                ' jetzt die Aktion ausführen 

                Dim txtMSG As String = ""
                'currentSzenario = New clsProjekte
                For i = 1 To anzProjMitVar

                    If i = 1 Then
                        txtMSG = indexvalue(i - 1).ToString & ", "
                    ElseIf i = anzProjMitVar Then
                        txtMSG = txtMSG & indexvalue(i - 1).ToString
                    Else
                        txtMSG = txtMSG & indexvalue(i - 1).ToString & ", "
                    End If

                    hproj = AlleProjekte.getProject(CStr(moreThanOne.Item(i)), indexvalue(i - 1))
                    'currentSzenario.Add(hproj)

                    Call replaceProjectVariant(hproj.name, hproj.variantName, False, False, 0)

                Next

                'For Each pName As String In justOne
                '    hproj = AlleProjekte.getProject(calcProjektKey(pName, ""))
                '    currentSzenario.Add(hproj)
                'Next

                ' jetzt muss der Wert für current bestimmt werden 
                currentValue = berechneOptimierungsWert(ShowProjekte, diagrammTyp, myCollection)
                anzSchleifen = anzSchleifen + 1

                If currentValue < firstValue Then
                    thirdValue = secondValue
                    secondValue = firstValue
                    firstValue = currentValue

                    anzOptimierungen = anzOptimierungen + 1


                    If projectConstellations.Contains(autoSzenarioNamen(2)) Then
                        tmpConstellation = projectConstellations.getConstellation(autoSzenarioNamen(2))

                        If projectConstellations.Contains(autoSzenarioNamen(3)) Then
                            projectConstellations.Remove(autoSzenarioNamen(3))
                        End If

                        tmpConstellation.constellationName = autoSzenarioNamen(3)
                        projectConstellations.Add(tmpConstellation)

                        If projectConstellations.Contains(autoSzenarioNamen(1)) Then
                            tmpConstellation = projectConstellations.getConstellation(autoSzenarioNamen(1))

                            If projectConstellations.Contains(autoSzenarioNamen(2)) Then
                                projectConstellations.Remove(autoSzenarioNamen(2))
                            End If

                            tmpConstellation.constellationName = autoSzenarioNamen(2)
                            projectConstellations.Add(tmpConstellation)
                        End If


                    End If

                    Call storeSessionConstellation(autoSzenarioNamen(1))
                    'Call awinNeuZeichnenDiagramme(2)

                ElseIf currentValue < secondValue Then

                    anzOptimierungen = anzOptimierungen + 1

                    thirdValue = secondValue
                    secondValue = currentValue

                    If projectConstellations.Contains(autoSzenarioNamen(2)) Then
                        tmpConstellation = projectConstellations.getConstellation(autoSzenarioNamen(2))

                        If projectConstellations.Contains(autoSzenarioNamen(3)) Then
                            projectConstellations.Remove(autoSzenarioNamen(3))
                        End If

                        tmpConstellation.constellationName = autoSzenarioNamen(3)
                        projectConstellations.Add(tmpConstellation)

                    End If

                    Call storeSessionConstellation(autoSzenarioNamen(2))

                ElseIf currentValue < thirdValue Then

                    anzOptimierungen = anzOptimierungen + 1

                    thirdValue = currentValue
                    Call storeSessionConstellation(autoSzenarioNamen(3))
                End If

                e.Result = anzSchleifen.ToString & " / " & anzKombinationen.ToString & " Berechnungen; " &
                            anzOptimierungen.ToString & " Optimierung(en"
                worker.ReportProgress(0, e)
                indexvalue(PPointer) = indexvalue(PPointer) + 1


            End While

            indexvalue(anzProjMitVar - 1) = 0


        Else

            For i = 0 To maxvalue(PPointer)
                indexvalue(PPointer) = i
                Call IterateOptimization(PPointer + 1, anzProjMitVar, maxvalue, indexvalue,
                                        diagrammTyp, myCollection, anzKombinationen, anzSchleifen, anzOptimierungen,
                                        justOne, moreThanOne, firstValue, secondValue, thirdValue,
                                        worker, e)

                If worker.CancellationPending Then
                    e.Cancel = True
                    e.Result = "Optimierung  abgebrochen ..."
                    Exit For
                End If

            Next


        End If




    End Sub

    ''' <summary>
    ''' bereichnet auf Basis der Freiheitsgrade der Projekte die beste Konstellation
    ''' </summary>
    ''' <param name="diagrammTyp"></param>
    ''' <param name="myCollection"></param>
    ''' <param name="OptimierungsErgebnis"></param>
    ''' <remarks></remarks>
    Public Sub awinCalcOptimizationFreiheitsgrade(ByVal diagrammTyp As String, ByRef myCollection As Collection,
                                       ByRef OptimierungsErgebnis As SortedList(Of String, clsOptimizationObject))
        Dim currentValue As Double
        Dim bestValue As Double
        Dim startoffset As Integer
        Dim versatz As Integer
        Dim lokalesOptimum As New clsOptimizationObject
        Dim hproj As clsProjekt
        Dim NrArgExceptions As Integer
        Dim toDoListe As New Collection
        Dim NrLoops As Integer


        If myCollection.Count >= 1 Then


            If diagrammTyp = DiagrammTypen(0) Or diagrammTyp = DiagrammTypen(1) Or diagrammTyp = DiagrammTypen(2) Or diagrammTyp = DiagrammTypen(4) Then

                ' to do Liste aufbauen
                For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

                    If relevantForOptimization(kvp.Value) Then
                        toDoListe.Add(kvp.Key, kvp.Key)
                    End If
                Next kvp

                bestValue = berechneOptimierungsWert(ShowProjekte, diagrammTyp, myCollection)
                lokalesOptimum.bestValue = bestValue
                lokalesOptimum.projectName = " "
                OptimierungsErgebnis.Clear()

                NrLoops = 0
                NrArgExceptions = 0


                'While newReferenceValue < referenceValue And toDoListe.Count > 0
                Dim Abbruch As Boolean = False
                While toDoListe.Count > 0 And Not Abbruch

                    Dim i As Integer
                    Dim curProj As clsProjekt

                    For i = 1 To toDoListe.Count
                        curProj = ShowProjekte.getProject(CStr(toDoListe.Item(i)))

                        startoffset = 0

                        ' hier wird der beste Wert für das einzelne Projekt gesucht ....  

                        For versatz = curProj.earliestStart To curProj.latestStart
                            If versatz <> 0 Then
                                curProj.StartOffset = versatz
                                currentValue = berechneOptimierungsWert(ShowProjekte, diagrammTyp, myCollection)

                                If currentValue < bestValue Then
                                    bestValue = currentValue
                                    startoffset = versatz
                                End If
                            End If
                        Next versatz

                        ' zurücksetzen des StartOffsets im Projekt, weil hier ja erst verschiedene Konstellationen probiert werden  
                        curProj.StartOffset = 0

                        Dim tmpOffset() As Integer
                        ReDim tmpOffset(0)

                        If startoffset <> 0 Then ' es gab eine Verbesserung 
                            'lokalesOptimum = New clsOptimizationObject
                            With lokalesOptimum
                                If bestValue < .bestValue Then
                                    .projectName = curProj.name
                                    .bestValue = bestValue
                                    tmpOffset(0) = startoffset
                                    .offset = tmpOffset
                                    ' Call awinVisualizeProject
                                End If
                            End With

                        End If

                    Next i
                    '
                    ' jetzt muss das Ergebnis abgearbeitet werden ... 
                    '
                    If lokalesOptimum.projectName <> " " Then

                        hproj = ShowProjekte.getProject(lokalesOptimum.projectName)
                        hproj.StartOffset = lokalesOptimum.offset(0)
                        OptimierungsErgebnis.Add(lokalesOptimum.projectName, lokalesOptimum)
                        toDoListe.Remove(lokalesOptimum.projectName)
                        Call visualisiereTeilErgebnis(lokalesOptimum.projectName)
                    Else
                        Abbruch = True
                    End If

                    lokalesOptimum.projectName = " "
                    NrLoops = NrLoops + 1

                End While

            Else
                Call MsgBox("Optimierung noch nicht implementiert")
            End If
        Else
            Call MsgBox("Optimierung nicht implementiert")
        End If


    End Sub


    ''' <summary>
    ''' bereichnet auf Basis der Freiheitsgrade der Plan-Elemente Elemente  die beste Konstellation
    ''' </summary>
    ''' <param name="diagrammTyp"></param>
    ''' <param name="myCollection"></param>
    ''' <param name="OptimierungsErgebnis"></param>
    ''' <remarks></remarks>
    Public Sub awinCalcOptimizationElemFreiheitsgrade(ByVal diagrammTyp As String, ByVal myCollection As Collection,
                                       ByRef OptimierungsErgebnis As SortedList(Of String, clsOptimizationObject),
                                       ByVal worker As BackgroundWorker, ByVal e As DoWorkEventArgs)
        Dim currentValue As Double
        Dim fullname As String = ""
        Dim elemName As String = ""
        Dim elemID As String
        Dim breadcrumb As String = ""
        Dim bestValue As Double
        Dim versatz As Integer
        Dim lokalesOptimum As New clsOptimizationObject
        Dim deltaValues() As Integer
        Dim hproj As clsProjekt
        Dim NrArgExceptions As Integer
        Dim toDoListe As New Collection
        Dim NrLoops As Integer
        Dim cphase As clsPhase
        Dim zaehler As Integer = 1
        Dim anzImprovements As Integer = 0
        Dim backgroundMsg As String = ""
        Dim i As Integer
        Dim notAdded As Boolean = True
        Dim phaseIndices() As Integer


        If myCollection.Count = 1 Then


            If diagrammTyp = DiagrammTypen(0) And myCollection.Count = 1 Then

                ' to do Liste aufbauen
                For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

                    ' tk 18.11.15 checken ob eines der angegebenen Elemente vorkommt 
                    notAdded = True
                    fullname = CStr(myCollection.Item(1))

                    elemName = ""
                    breadcrumb = ""
                    Dim pvName As String = ""
                    Dim type As Integer = -1
                    Dim weiter As Boolean = True
                    Call splitHryFullnameTo2(fullname, elemName, breadcrumb, type, pvName)

                    If type = PTItemType.projekt Then

                        If pvName <> kvp.Value.name Then
                            weiter = False
                        End If

                    ElseIf type = PTItemType.vorlage Then

                        If pvName <> kvp.Value.VorlagenName Then
                            weiter = False
                        End If

                    End If

                    If weiter Then
                        phaseIndices = kvp.Value.hierarchy.getPhaseIndices(elemName, breadcrumb)
                        If phaseIndices(0) > 0 Then

                            i = 1
                            While i <= phaseIndices.Length And notAdded
                                elemID = kvp.Value.getPhase(phaseIndices(i - 1)).nameID
                                If relevantForOptimization(kvp.Value, elemID, False) Then
                                    If Not toDoListe.Contains(kvp.Key) Then
                                        toDoListe.Add(kvp.Key, kvp.Key)
                                    End If
                                    notAdded = False
                                Else
                                    i = i + 1
                                End If
                            End While

                        End If
                    End If

                Next kvp

                bestValue = berechneOptimierungsWert(ShowProjekte, diagrammTyp, myCollection)
                lokalesOptimum.bestValue = bestValue
                lokalesOptimum.projectName = " "
                OptimierungsErgebnis.Clear()

                NrLoops = 0
                NrArgExceptions = 0


                Dim Abbruch As Boolean = False
                While toDoListe.Count > 0 And Not Abbruch

                    backgroundMsg = "Iteration " & zaehler.ToString("###0") &
                                    "; gefundene Verbesserungen: " & anzImprovements.ToString("###0")

                    e.Result = backgroundMsg
                    worker.ReportProgress(0, e)

                    Dim curProj As clsProjekt
                    fullname = CStr(myCollection.Item(1))

                    elemName = ""
                    breadcrumb = ""
                    Dim pvName As String = ""
                    Dim type As Integer = -1
                    Call splitHryFullnameTo2(fullname, elemName, breadcrumb, type, pvName)

                    For i = 1 To toDoListe.Count

                        curProj = ShowProjekte.getProject(CStr(toDoListe.Item(i)))
                        Dim weiter As Boolean = True

                        If type = PTItemType.projekt Then

                            If pvName <> curProj.name Then
                                weiter = False
                            End If

                        ElseIf type = PTItemType.vorlage Then

                            If pvName <> curProj.VorlagenName Then
                                weiter = False
                            End If

                        End If

                        If weiter Then
                            phaseIndices = curProj.hierarchy.getPhaseIndices(elemName, breadcrumb)

                            ' in den deltaValues sind jetzt die Werte drin, die sich für die Phasen-Verschiebungen ergeben 

                            ReDim deltaValues(phaseIndices.Length - 1)

                            Dim optimizationFound As Boolean = False

                            If phaseIndices(0) > 0 Then
                                ' nur dann wurde die Phase wenigstens einmal gefunden ...
                                For ik As Integer = 1 To phaseIndices.Length

                                    ' jetzt die Phase holen

                                    cphase = curProj.getPhase(phaseIndices(ik - 1))
                                    Dim phaseNameID As String = cphase.nameID

                                    ' hier wird der beste Wert für das einzelne Projekt gesucht ....  

                                    For versatz = curProj.earliestStart To curProj.latestStart
                                        If versatz <> 0 Then
                                            ' jetzt die Phase entsprechend verschieben ...
                                            cphase.changeStartandDauer(cphase.startOffsetinDays + versatz, cphase.dauerInDays)

                                            currentValue = berechneOptimierungsWert(ShowProjekte, diagrammTyp, myCollection)

                                            If currentValue < bestValue Then
                                                bestValue = currentValue
                                                deltaValues(ik - 1) = versatz
                                                optimizationFound = True
                                                anzImprovements = anzImprovements + 1
                                            End If
                                        End If

                                    Next versatz



                                Next

                                ' zurücksetzen des Offsets in den einzelnen Phasen wieder auf ihre alte Position zurückgesetzt werden 

                                For ik As Integer = 1 To phaseIndices.Length
                                    cphase = curProj.getPhase(phaseIndices(ik - 1))
                                    Dim phaseNameID As String = cphase.nameID

                                    If deltaValues(ik - 1) <> 0 Then
                                        With cphase
                                            .changeStartandDauer(.startOffsetinDays - deltaValues(ik - 1), .dauerInDays)
                                        End With
                                    End If

                                Next


                                If optimizationFound Then ' es gab eine Verbesserung 

                                    With lokalesOptimum
                                        If bestValue < .bestValue Then
                                            .projectName = curProj.name
                                            .bestValue = bestValue
                                            .offset = deltaValues
                                            ' Call awinVisualizeProject
                                        End If
                                    End With

                                End If

                            End If

                        End If

                    Next i


                    '
                    ' jetzt muss das Ergebnis abgearbeitet werden ... 
                    '
                    If lokalesOptimum.projectName <> " " Then

                        hproj = ShowProjekte.getProject(lokalesOptimum.projectName)
                        ' jetzt müssen die Phasen wieder auf Ihre optimierte Position gebracht werden

                        phaseIndices = hproj.hierarchy.getPhaseIndices(elemName, breadcrumb)
                        If phaseIndices(0) > 0 Then

                            For ik As Integer = 1 To phaseIndices.Length
                                cphase = hproj.getPhase(phaseIndices(ik - 1))
                                Dim phaseNameID As String = cphase.nameID
                                If lokalesOptimum.offset(ik - 1) <> 0 Then
                                    cphase.changeStartandDauer(cphase.startOffsetinDays + lokalesOptimum.offset(ik - 1),
                                                                cphase.dauerInDays)
                                End If

                            Next

                            OptimierungsErgebnis.Add(lokalesOptimum.projectName, lokalesOptimum)
                            Call visualisiereTeilErgebnis(lokalesOptimum.projectName)

                        End If


                        toDoListe.Remove(lokalesOptimum.projectName)

                    Else
                        Abbruch = True
                    End If

                    lokalesOptimum.projectName = " "
                    NrLoops = NrLoops + 1

                End While

            Else
                Call MsgBox("Optimierung noch nicht implementiert")
            End If
        Else
            Call MsgBox("Optimierung für mehr als 1 Namen noch nicht implementiert")
        End If


    End Sub

    Public Function berechneOptimierungsWert(ByRef currentProjektListe As clsProjekte, ByRef DiagrammTyp As String, ByRef myCollection As Collection) As Double
        Dim value As Double
        Dim kennzahl1 As Double
        Dim kennzahl2 As Double
        Dim avgValue As Double

        If DiagrammTyp = DiagrammTypen(1) Then
            value = currentProjektListe.getbadCostOfRole(myCollection)

        ElseIf DiagrammTyp = DiagrammTypen(0) Then

            kennzahl1 = currentProjektListe.getAverage(myCollection, DiagrammTyp)
            kennzahl2 = currentProjektListe.getPhaseSchwellWerteInMonth(myCollection).Sum
            avgValue = System.Math.Max(kennzahl1, kennzahl2)
            value = currentProjektListe.getDeviationfromAverage(myCollection, avgValue, DiagrammTyp)

        ElseIf DiagrammTyp = DiagrammTypen(2) Then
            avgValue = currentProjektListe.getAverage(myCollection, DiagrammTyp)
            value = currentProjektListe.getDeviationfromAverage(myCollection, avgValue, DiagrammTyp)

        ElseIf DiagrammTyp = DiagrammTypen(4) Then
            ' da der Optimierungs-Algorithmus die kleinste Zahl sucht , muss mit -1 multipliziert werden, 
            ' damit tatsächlich der größte Ertrag heraus kommt 
            value = currentProjektListe.getErgebniskennzahl * (-1)

        ElseIf DiagrammTyp = DiagrammTypen(5) Then
            'Throw New ArgumentException("Optimierung ist für diesen Diagramm-Typ nicht implementiert")
            ' tk: das folgende kann aktiviert werden, sobald 
            kennzahl1 = currentProjektListe.getAverage(myCollection, DiagrammTyp)
            kennzahl2 = currentProjektListe.getMilestoneSchwellWerteInMonth(myCollection).Sum
            avgValue = System.Math.Max(kennzahl1, kennzahl2)
            value = currentProjektListe.getDeviationfromAverage(myCollection, avgValue, DiagrammTyp)
        Else
            Throw New ArgumentException("Optimierung ist für diesen Diagramm-Typ nicht implementiert")
        End If

        berechneOptimierungsWert = value

    End Function
    ''' <summary>
    ''' bestimmt für ein übergebenes Projekt und eine optional übergebene Phasen-ID, ob dieses Projekt überhaupt betrachtet werden soll; 
    ''' </summary>
    ''' <param name="project"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function relevantForOptimization(ByVal project As clsProjekt, Optional ByVal elemID As String = "", Optional ByVal isMilestone As Boolean = False) As Boolean
        Dim relevant As Boolean = False
        Dim bereichsAnfang As Integer = -1, bereichsEnde As Integer = -1
        ' hier können dann auch weitere Bedingungen abgefragt werden, ob bspweise das Projekt denn überhaupt Freiheitsgrade besitzt  


        With project

            If elemID.Length = 0 Then
                ' es soll das Projekt betrachtet werden 
                If .Status = ProjektStatus(PTProjektStati.geplant) Then

                    ' nur dann darf das Projekt noch verschoben werden ...

                    bereichsAnfang = .Start + .earliestStart
                    bereichsEnde = .Start + .anzahlRasterElemente - 1 + .latestStart

                    If project.StartOffset = 0 And (project.earliestStart < 0 Or project.latestStart > 0) _
                                                   And istBereichInTimezone(bereichsAnfang, bereichsEnde) Then
                        relevant = True
                    Else
                        relevant = False
                    End If
                Else
                    relevant = False
                End If

            Else
                ' es soll die Phase oder ein Meilenstein betrachtet werden 

                If isMilestone Then
                    Dim cMilestone As clsMeilenstein = project.getMilestoneByID(elemID)
                    If IsNothing(cMilestone) Then
                        relevant = False
                    Else
                        If .Status = ProjektStatus(PTProjektStati.geplant) Then

                            bereichsAnfang = getColumnOfDate(cMilestone.getDate.AddDays(-15))
                            bereichsEnde = getColumnOfDate(cMilestone.getDate.AddDays(15))
                            ' nur dann darf das Projekt noch verschoben werden ...
                        Else
                            relevant = False
                        End If
                    End If

                Else
                    Dim cphase As clsPhase = project.getPhaseByID(elemID)

                    If IsNothing(cphase) Then
                        relevant = False
                    Else
                        If .Status = ProjektStatus(PTProjektStati.geplant) Then

                            bereichsAnfang = getColumnOfDate(cphase.getStartDate.AddDays(cphase.earliestStart))
                            bereichsEnde = getColumnOfDate(cphase.getEndDate.AddDays(cphase.latestStart))
                            ' nur dann darf das Projekt noch verschoben werden ...
                        Else
                            relevant = False
                        End If
                    End If
                End If

                If istBereichInTimezone(bereichsAnfang, bereichsEnde) Then
                    relevant = True
                Else
                    relevant = False
                End If

            End If


        End With

        relevantForOptimization = relevant

    End Function

    ''' <summary>
    ''' zeichnet für alle selektierten Projekte die Phasen, die in Namelist angegeben sind;  
    ''' wenn namelist leer ist, werden alle Phasen des Projektes angezeigt
    ''' </summary>
    ''' <param name="nameList">enthält die Namen plus die Breadcrumbs der Phasen, die gezeichnet werden sollen; alle, wenn leer</param>
    ''' <param name="numberIt">gibt an, ob di ePhasen nummeriert werden sollen</param>
    ''' <param name="deleteOtherShapes">gibt an, ob die anderen Phasen-Shapes gelöscht werden sollen</param>
    ''' <remarks></remarks>
    Public Sub awinZeichnePhasen(ByVal nameList As Collection, ByVal numberIt As Boolean, ByVal deleteOtherShapes As Boolean)

        'Dim request As New Request(awinSettings.databaseName)
        Dim singleShp As Excel.Shape
        Dim hproj As New clsProjekt
        Dim vglName As String = " "
        Dim pName As String
        Dim ok As Boolean = True
        Dim msNumber As Integer = 1

        Dim awinSelection As Excel.ShapeRange

        Dim formerEE As Boolean = appInstance.EnableEvents
        Dim formerSU As Boolean = appInstance.ScreenUpdating
        appInstance.EnableEvents = False
        appInstance.ScreenUpdating = True

        enableOnUpdate = False

        Try
            awinSelection = CType(appInstance.ActiveWindow.Selection.ShapeRange, Excel.ShapeRange)
        Catch ex As Exception
            awinSelection = Nothing
        End Try


        If Not awinSelection Is Nothing Then

            Dim anzSelect As Integer = awinSelection.Count

            ' jetzt die Aktion durchführen ...

            For Each singleShp In awinSelection
                ok = True
                With singleShp
                    If isProjectType(kindOfShape(singleShp)) Then


                        Try
                            hproj = ShowProjekte.getProject(singleShp.Name, True)
                        Catch ex As Exception
                            ok = False
                        End Try

                        If ok Then

                            If deleteOtherShapes Then
                                Call awinDeleteProjectChildShapes(singleShp, 3)
                            End If

                            Try
                                pName = hproj.name
                                Call zeichnePhasenInProjekt(hproj, nameList, False, msNumber)

                            Catch ex As Exception

                            End Try


                        End If

                    End If
                End With
            Next

            If msNumber = 1 Then
                If nameList.Count > 1 Then
                    Call MsgBox("Auswahl enthält diese Phasen nicht")
                Else
                    Call MsgBox("Auswahl enthält diese Phase nicht:  " & nameList.Item(1))
                End If
            End If

        Else
            ' tue es für alle Projekte in Showprojekte 


            Dim todoListe As New SortedList(Of Long, clsProjekt)
            Dim key As Long

            For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

                key = 10000 * kvp.Value.tfZeile + kvp.Value.tfspalte
                todoListe.Add(key, kvp.Value)

            Next


            For Each kvp As KeyValuePair(Of Long, clsProjekt) In todoListe

                If deleteOtherShapes Then
                    singleShp = ShowProjekte.getShape(kvp.Value.name)
                    Call awinDeleteProjectChildShapes(singleShp, 3)
                End If

                Call zeichnePhasenInProjekt(kvp.Value, nameList, False, msNumber, showRangeLeft, showRangeRight)

            Next


            If msNumber = 1 Then
                If nameList.Count > 1 Then
                    Call MsgBox("im gewählten Zeitraum gibt es diese Phasen nicht")
                Else
                    Call MsgBox("im gewählten Zeitraum gibt es diese Phase nicht: " & nameList.Item(1))
                End If
            End If


        End If


        'ur: 17.7.2015: für PlanElemente visualisieren für Einzelprojekt-Info sollte nach zeichnen der Phasen nicht deselektiert werden
        '' ''Call awinDeSelect()


        enableOnUpdate = True
        appInstance.EnableEvents = formerEE
        appInstance.ScreenUpdating = formerSU



    End Sub

    ' ''' <summary>
    ' ''' zeichnet die Ressourcen- bzw. Kostenbedarfe in die Projekt-Tafel 
    ' ''' </summary>
    ' ''' <param name="nameList"></param>
    ' ''' <param name="prcTyp"></param>
    ' ''' <remarks></remarks>
    'Public Sub awinZeichneBedarfe(ByVal nameList As Collection, ByVal prcTyp As String)

    '    Dim tmpName As String = ""

    '    If nameList.Count < 1 Then
    '        tmpName = ""
    '    ElseIf nameList.Count = 1 Then
    '        tmpName = CStr(nameList.Item(1))
    '    ElseIf nameList.Count > 1 Then
    '        tmpName = "Collection"

    '    End If

    '    With roentgenBlick
    '        If .isOn Then
    '            'Call awinNoshowProjectNeeds()
    '        End If
    '        .isOn = True
    '        .name = tmpName
    '        .myCollection = nameList
    '        .type = prcTyp
    '        'Call awinShowProjectNeeds1(nameList, prcTyp)
    '    End With
    'End Sub

    ''' <summary>
    ''' zeichnet für interaktiven wie Report Modus die Milestones 
    ''' 0: grau, 1: grün, 2: gelb, 3:rot, 4: alle
    ''' </summary>
    ''' <param name="farbTyp">welcher Typus soll gezeichnet werden </param>
    ''' <remarks></remarks>
    Public Sub awinZeichneMilestones(ByVal nameList As Collection, ByVal farbTyp As Integer, ByVal numberIt As Boolean, ByVal deleteOtherShapes As Boolean)

        'Dim request As New Request(awinSettings.databaseName)
        Dim singleShp As Excel.Shape
        Dim hproj As New clsProjekt
        Dim vglName As String = " "
        Dim pName As String
        Dim ok As Boolean = True
        Dim msNumber As Integer = 1

        Dim awinSelection As Excel.ShapeRange

        Dim formerEE As Boolean = appInstance.EnableEvents
        Dim formerSU As Boolean = appInstance.ScreenUpdating
        appInstance.EnableEvents = False
        appInstance.ScreenUpdating = False

        enableOnUpdate = False

        Try
            awinSelection = CType(appInstance.ActiveWindow.Selection.ShapeRange, Excel.ShapeRange)
        Catch ex As Exception
            awinSelection = Nothing
        End Try

        If Not awinSelection Is Nothing Then

            ' jetzt die Aktion durchführen ...

            For Each singleShp In awinSelection
                ok = True
                With singleShp

                    If isProjectType(kindOfShape(singleShp)) Then

                        Try
                            hproj = ShowProjekte.getProject(singleShp.Name, True)
                        Catch ex As Exception
                            ok = False
                        End Try

                        If ok Then

                            If deleteOtherShapes Then
                                Call awinDeleteProjectChildShapes(singleShp, 1)
                            End If

                            Try
                                pName = hproj.name
                                Call zeichneMilestonesInProjekt(hproj, nameList, farbTyp, 0, 0, False, msNumber, False)
                            Catch ex As Exception
                                Dim a As Integer = 0
                            End Try


                        End If

                    End If
                End With
            Next

            If msNumber = 1 Then
                If nameList.Count > 1 Then
                    Call MsgBox("Auswahl enthält  diese Meilensteine nicht")
                ElseIf nameList.Count = 1 Then
                    Call MsgBox("Auswahl enthält keinen Meilenstein " & nameList.Item(1))

                End If
            End If

        Else


            If ShowProjekte.Count > 0 Then

                ' tue es für alle Projekte in Showprojekte 


                Dim todoListe As New SortedList(Of Long, clsProjekt)
                Dim key As Long

                For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

                    key = 10000 * kvp.Value.tfZeile + kvp.Value.tfspalte
                    todoListe.Add(key, kvp.Value)

                Next


                For Each kvp As KeyValuePair(Of Long, clsProjekt) In todoListe

                    If deleteOtherShapes Then
                        singleShp = ShowProjekte.getShape(kvp.Value.name)
                        Call awinDeleteProjectChildShapes(singleShp, 1)
                    End If

                    Call zeichneMilestonesInProjekt(kvp.Value, nameList, farbTyp, showRangeLeft, showRangeRight, numberIt, msNumber, False)

                Next


                If msNumber = 1 Then
                    If nameList.Count > 1 Then
                        Call MsgBox("im gewählten Zeitraum gibt es diese Meilensteine nicht")
                    ElseIf nameList.Count = 1 Then
                        Call MsgBox("im gewählten Zeitraum gibt es keinen Meilenstein " & nameList.Item(1))
                    End If
                End If

            Else
                Call MsgBox("Es sind keine Projekte geladen!")
            End If


        End If

        'ur: 17.7.2015: für PlanElemente visualisieren sollte nach zeichnen der Meilensteine nicht deselektiert werden
        '' ''Call awinDeSelect()

        enableOnUpdate = True
        appInstance.EnableEvents = formerEE
        appInstance.ScreenUpdating = formerSU



    End Sub


    ''' <summary>
    ''' bringt alle charts in den Vordergrund, so daß sie nicht von einem neu gezeichneten Projekt überdeckt werden 
    ''' </summary>
    ''' <remarks></remarks>
    Public Sub bringChartsToFront(ByVal projectShape As Excel.Shape)

        Dim worksheetShapes As Excel.Shapes = Nothing
        'Dim chtobj As Excel.ChartObject

        ' sicherstellen, dass projectshape auch etwas enthält ... 
        If IsNothing(projectShape) Then
            Exit Sub
        End If

        ' Änderung tk, 6.12.17 Charts sind jetzt alle auf extra sheets und in extra window, ist nicht mehr notwendig ??

        'Try

        '    worksheetShapes = CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Shapes

        'Catch ex As Exception
        '    Throw New Exception("in bringChartstoFront : keine Shapes Zuordnung möglich ")
        'End Try


        'For Each chtobj In CType(CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).ChartObjects, Excel.ChartObjects)

        '    Try
        '        With chtobj
        '            If ((projectShape.Top >= .Top And projectShape.Top <= .Top + .Height) Or _
        '                (.Top >= projectShape.Top And .Top <= projectShape.Top + projectShape.Height)) And _
        '                ((projectShape.Left >= .Left And projectShape.Left <= .Left + .Width) Or _
        '                (.Left >= projectShape.Left And .Left <= projectShape.Left + projectShape.Width)) Then

        '                CType(worksheetShapes.Item(chtobj.Name), Excel.Shape).ZOrder(core.MsoZOrderCmd.msoBringToFront)

        '            End If
        '        End With
        '    Catch ex As Exception

        '    End Try


        'Next


    End Sub

    ''' <summary>
    ''' zeichnet die Plantafel mit den Projekten neu; 
    ''' zeichnet bei fromScratch = true: zuerst in Reihenfolge der Business Units, 
    ''' dann sortiert nach Anfangsdatum, dann sortiert nach Projektdauer
    ''' im fall fromScratch = false: versucht dabei immer die alte Position der Projekte zu übernehmen 
    ''' </summary>
    ''' <remarks></remarks>
    Public Sub awinZeichnePlanTafel_old(ByVal fromScratch As Boolean)

        Dim todoListe As New SortedList(Of Double, String)
        Dim key As Double
        Dim pname As String

        Dim lastZeileOld As Integer
        Dim hproj As clsProjekt
        Dim positionsKennzahl As Double

        Dim notOK As Boolean = True
        Dim tryExceptionCounts As Integer = 0


        If fromScratch Then
            Dim zeile As Integer
            Dim lastBU As String = ""

            For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

                notOK = True

                With kvp.Value

                    'positionsKennzahl = calcKennziffer(kvp.Value)
                    If projectConstellations.Contains(currentConstellationName) Then
                        positionsKennzahl = projectConstellations.getConstellation(currentConstellationName).getBoardZeile(kvp.Key)
                    Else
                        positionsKennzahl = currentSessionConstellation.getBoardZeile(kvp.Key)
                    End If


                    Do While notOK
                        Try
                            If todoListe.ContainsKey(positionsKennzahl) Then
                                positionsKennzahl = positionsKennzahl + 0.00001
                            Else
                                todoListe.Add(positionsKennzahl, .name)
                                notOK = False
                            End If
                        Catch ex As Exception
                            positionsKennzahl = positionsKennzahl + 0.00001
                            tryExceptionCounts = tryExceptionCounts + 1
                        End Try
                    Loop


                End With

            Next

            zeile = 2
            Dim i As Integer

            For i = 1 To todoListe.Count

                pname = todoListe.ElementAt(i - 1).Value

                Try
                    hproj = ShowProjekte.getProject(pname)

                    hproj.tfZeile = zeile

                    Dim tmpCollection As New Collection
                    Call ZeichneProjektinPlanTafel(tmpCollection, pname, zeile, tmpCollection, tmpCollection)

                    ' zeile soviel weiterschalten, wie Platz benötigt wird ...
                    zeile = zeile + hproj.calcNeededLines(tmpCollection, tmpCollection, hproj.extendedView Or awinSettings.drawphases, False)

                Catch ex As Exception
                    tryExceptionCounts = tryExceptionCounts + 1
                End Try

            Next


        Else

            Dim zeile As Integer, lastzeile As Integer, curzeile As Integer, max As Integer
            ' so wurde es bisher gemacht ... bis zum 17.1.15
            ' aufbauen der todoListe, so daß nachher die Projekte von oben nach unten gezeichnet werden können 
            For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

                Try
                    With kvp.Value
                        key = 10000 * .tfZeile + kvp.Value.Start
                        Do While todoListe.ContainsKey(key)
                            key = key + 0.000001
                        Loop
                        todoListe.Add(key, .name)
                    End With
                Catch ex As Exception

                    tryExceptionCounts = tryExceptionCounts + 1
                    'Call MsgBox("Fehler in awinZeichnePlanTafel")

                End Try


            Next

            zeile = 2
            lastzeile = 0


            'If ProjectBoardDefinitions.My.Settings.drawPhases = True Then
            ' dann sollen die Projekte im extended mode gezeichnet werden 
            ' jetzt erst mal die Konstellation "last" speichern
            ' 3.11.14 Auskommentiert: Zeichnen sollte nichts zu tun haben mit dem Verwalten von Konstellationen 
            ' Call storeSessionConstellation(ShowProjekte, "Last")

            ' jetzt die todoListe abarbeiten
            Dim i As Integer
            For i = 1 To todoListe.Count
                pname = todoListe.ElementAt(i - 1).Value

                Try
                    hproj = ShowProjekte.getProject(pname)

                    If i = 1 Then
                        curzeile = hproj.tfZeile
                        lastZeileOld = hproj.tfZeile
                        lastzeile = curzeile
                        max = curzeile
                    Else
                        If lastZeileOld = hproj.tfZeile Then
                            curzeile = lastzeile
                        Else
                            lastzeile = max
                            lastZeileOld = hproj.tfZeile
                        End If

                    End If

                    ' Änderung 9.10.14, damit die Spaces in einer 
                    'If hproj.tfZeile >= curZeile + 1 Then
                    '    curZeile = curZeile + 1
                    'End If
                    ' Ende Änderung
                    hproj.tfZeile = curzeile
                    lastzeile = curzeile
                    'Call ZeichneProjektinPlanTafel2(pname, curZeile)
                    ' wenn bestimmte Projekte beim Suchen nach einem Platz nicht berücksichtigt werden sollen,
                    ' dann müssen sie in einer Collection an ZeichneProjektinPlanTafel übergeben werden 
                    Dim tmpCollection As New Collection
                    Call ZeichneProjektinPlanTafel(tmpCollection, pname, curzeile, tmpCollection, tmpCollection)
                    curzeile = lastzeile + hproj.calcNeededLines(tmpCollection, tmpCollection, hproj.extendedView Or awinSettings.drawphases, False)


                    If curzeile > max Then
                        max = curzeile
                    End If
                Catch ex As Exception
                    tryExceptionCounts = tryExceptionCounts + 1
                End Try



            Next
        End If

        'If tryExceptionCounts > 0 Then
        '    Call MsgBox("Anzahl: " & tryExceptionCounts)
        'End If

        'Call MsgBox("Ende: " & Date.Now.TimeOfDay.ToString)

    End Sub

    Public Sub awinZeichnePlanTafel(ByVal fromScratch As Boolean,
                                    Optional ByVal cstl As clsConstellation = Nothing)

        Dim todoListe As New SortedList(Of Double, String)
        Dim key As Double
        Dim pname As String

        Dim lastZeileOld As Integer
        Dim hproj As clsProjekt
        Dim positionsKennzahl As Double

        Dim notOK As Boolean = True
        Dim tryExceptionCounts As Integer = 0


        If fromScratch Then
            Dim zeile As Integer
            Dim lastBU As String = ""

            For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

                notOK = True

                With kvp.Value

                    'positionsKennzahl = calcKennziffer(kvp.Value)
                    If projectConstellations.Contains(currentConstellationName) Then
                        positionsKennzahl = projectConstellations.getConstellation(currentConstellationName).getBoardZeile(kvp.Key)
                    Else
                        positionsKennzahl = currentSessionConstellation.getBoardZeile(kvp.Key)
                    End If


                    Do While notOK
                        Try
                            If todoListe.ContainsKey(positionsKennzahl) Then
                                positionsKennzahl = positionsKennzahl + 0.00001
                            Else
                                todoListe.Add(positionsKennzahl, .name)
                                notOK = False
                            End If
                        Catch ex As Exception
                            positionsKennzahl = positionsKennzahl + 0.00001
                            tryExceptionCounts = tryExceptionCounts + 1
                        End Try
                    Loop


                End With

            Next

            zeile = 2
            Dim i As Integer

            For i = 1 To todoListe.Count

                pname = todoListe.ElementAt(i - 1).Value

                Try
                    hproj = ShowProjekte.getProject(pname)

                    hproj.tfZeile = zeile

                    Dim tmpCollection As New Collection
                    Call ZeichneProjektinPlanTafel(tmpCollection, pname, zeile, tmpCollection, tmpCollection)

                    ' zeile soviel weiterschalten, wie Platz benötigt wird ...
                    zeile = zeile + hproj.calcNeededLines(tmpCollection, tmpCollection, hproj.extendedView Or awinSettings.drawphases, False)

                Catch ex As Exception
                    tryExceptionCounts = tryExceptionCounts + 1
                End Try

            Next


        Else

            Dim zeile As Integer, lastzeile As Integer, curzeile As Integer, max As Integer
            ' so wurde es bisher gemacht ... bis zum 17.1.15
            ' aufbauen der todoListe, so daß nachher die Projekte von oben nach unten gezeichnet werden können 
            For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

                Try
                    With kvp.Value
                        key = 10000 * .tfZeile + kvp.Value.Start
                        Do While todoListe.ContainsKey(key)
                            key = key + 0.000001
                        Loop
                        todoListe.Add(key, .name)
                    End With
                Catch ex As Exception

                    tryExceptionCounts = tryExceptionCounts + 1
                    'Call MsgBox("Fehler in awinZeichnePlanTafel")

                End Try


            Next

            zeile = 2
            lastzeile = 0


            'If ProjectBoardDefinitions.My.Settings.drawPhases = True Then
            ' dann sollen die Projekte im extended mode gezeichnet werden 
            ' jetzt erst mal die Konstellation "last" speichern
            ' 3.11.14 Auskommentiert: Zeichnen sollte nichts zu tun haben mit dem Verwalten von Konstellationen 
            ' Call storeSessionConstellation(ShowProjekte, "Last")

            ' jetzt die todoListe abarbeiten
            Dim i As Integer
            For i = 1 To todoListe.Count
                pname = todoListe.ElementAt(i - 1).Value

                Try
                    hproj = ShowProjekte.getProject(pname)

                    If i = 1 Then
                        curzeile = hproj.tfZeile
                        lastZeileOld = hproj.tfZeile
                        lastzeile = curzeile
                        max = curzeile
                    Else
                        If lastZeileOld = hproj.tfZeile Then
                            curzeile = lastzeile
                        Else
                            lastzeile = max
                            lastZeileOld = hproj.tfZeile
                        End If

                    End If

                    ' Änderung 9.10.14, damit die Spaces in einer 
                    'If hproj.tfZeile >= curZeile + 1 Then
                    '    curZeile = curZeile + 1
                    'End If
                    ' Ende Änderung
                    hproj.tfZeile = curzeile
                    lastzeile = curzeile
                    'Call ZeichneProjektinPlanTafel2(pname, curZeile)
                    ' wenn bestimmte Projekte beim Suchen nach einem Platz nicht berücksichtigt werden sollen,
                    ' dann müssen sie in einer Collection an ZeichneProjektinPlanTafel übergeben werden 
                    Dim tmpCollection As New Collection
                    Call ZeichneProjektinPlanTafel(tmpCollection, pname, curzeile, tmpCollection, tmpCollection)
                    curzeile = lastzeile + hproj.calcNeededLines(tmpCollection, tmpCollection, hproj.extendedView Or awinSettings.drawphases, False)


                    If curzeile > max Then
                        max = curzeile
                    End If
                Catch ex As Exception
                    tryExceptionCounts = tryExceptionCounts + 1
                End Try



            Next
        End If

        'If tryExceptionCounts > 0 Then
        '    Call MsgBox("Anzahl: " & tryExceptionCounts)
        'End If

        'Call MsgBox("Ende: " & Date.Now.TimeOfDay.ToString)

    End Sub

    ' am 22.3.17 durch obige Routine ersetzt 
    '' ''' <summary>
    '' ''' zeichnet die Plantafel mit den Projekten neu; 
    '' ''' zeichnet bei fromScratch = true: zuerst in Reihenfolge der Business Units, 
    '' ''' dann sortiert nach Anfangsdatum, dann sortiert nach Projektdauer
    '' ''' im fall fromScratch = false: versucht dabei immer die alte Position der Projekte zu übernehmen 
    '' ''' </summary>
    '' ''' <remarks></remarks>
    ''Public Sub awinZeichnePlanTafel_deprecated(ByVal fromScratch As Boolean)

    ''    Dim todoListe As New SortedList(Of Double, String)
    ''    Dim key As Double
    ''    Dim pname As String

    ''    Dim lastZeileOld As Integer
    ''    Dim hproj As clsProjekt
    ''    Dim positionsKennzahl As Double

    ''    Dim notOK As Boolean = True
    ''    Dim tryExceptionCounts As Integer = 0

    ''    'Call MsgBox("Start: " & Date.Now.TimeOfDay.ToString)

    ''    If fromScratch Then
    ''        Dim zeile As Integer
    ''        Dim lastBU As String = ""

    ''        For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

    ''            notOK = True

    ''            With kvp.Value

    ''                positionsKennzahl = calcKennziffer(kvp.Value)

    ''                Do While notOK
    ''                    Try
    ''                        If todoListe.ContainsKey(positionsKennzahl) Then
    ''                            positionsKennzahl = positionsKennzahl + 0.00001
    ''                        Else
    ''                            todoListe.Add(positionsKennzahl, .name)
    ''                            notOK = False
    ''                        End If
    ''                    Catch ex As Exception
    ''                        positionsKennzahl = positionsKennzahl + 0.00001
    ''                        tryExceptionCounts = tryExceptionCounts + 1
    ''                    End Try
    ''                Loop


    ''            End With

    ''        Next

    ''        zeile = 2
    ''        Dim i As Integer

    ''        For i = 1 To todoListe.Count

    ''            pname = todoListe.ElementAt(i - 1).Value

    ''            Try
    ''                hproj = ShowProjekte.getProject(pname)

    ''                If i = 1 Then
    ''                    lastBU = hproj.businessUnit
    ''                ElseIf lastBU <> hproj.businessUnit Then
    ''                    lastBU = hproj.businessUnit
    ''                    zeile = zeile + 1
    ''                End If

    ''                hproj.tfZeile = zeile

    ''                Dim tmpCollection As New Collection
    ''                Call ZeichneProjektinPlanTafel(tmpCollection, pname, zeile, tmpCollection, tmpCollection)

    ''                zeile = zeile + hproj.calcNeededLines(tmpCollection, tmpCollection, hproj.extendedView Or awinSettings.drawphases, False)

    ''            Catch ex As Exception
    ''                tryExceptionCounts = tryExceptionCounts + 1
    ''            End Try

    ''        Next


    ''    Else

    ''        Dim zeile As Integer, lastzeile As Integer, curzeile As Integer, max As Integer
    ''        ' so wurde es bisher gemacht ... bis zum 17.1.15
    ''        ' aufbauen der todoListe, so daß nachher die Projekte von oben nach unten gezeichnet werden können 
    ''        For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

    ''            Try
    ''                With kvp.Value
    ''                    key = 10000 * .tfZeile + kvp.Value.Start
    ''                    Do While todoListe.ContainsKey(key)
    ''                        key = key + 0.000001
    ''                    Loop
    ''                    todoListe.Add(key, .name)
    ''                End With
    ''            Catch ex As Exception

    ''                tryExceptionCounts = tryExceptionCounts + 1
    ''                'Call MsgBox("Fehler in awinZeichnePlanTafel")

    ''            End Try


    ''        Next

    ''        zeile = 2
    ''        lastzeile = 0


    ''        'If ProjectBoardDefinitions.My.Settings.drawPhases = True Then
    ''        ' dann sollen die Projekte im extended mode gezeichnet werden 
    ''        ' jetzt erst mal die Konstellation "last" speichern
    ''        ' 3.11.14 Auskommentiert: Zeichnen sollte nichts zu tun haben mit dem Verwalten von Konstellationen 
    ''        ' Call storeSessionConstellation(ShowProjekte, "Last")

    ''        ' jetzt die todoListe abarbeiten
    ''        Dim i As Integer
    ''        For i = 1 To todoListe.Count
    ''            pname = todoListe.ElementAt(i - 1).Value

    ''            Try
    ''                hproj = ShowProjekte.getProject(pname)

    ''                If i = 1 Then
    ''                    curzeile = hproj.tfZeile
    ''                    lastZeileOld = hproj.tfZeile
    ''                    lastzeile = curzeile
    ''                    max = curzeile
    ''                Else
    ''                    If lastZeileOld = hproj.tfZeile Then
    ''                        curzeile = lastzeile
    ''                    Else
    ''                        lastzeile = max
    ''                        lastZeileOld = hproj.tfZeile
    ''                    End If

    ''                End If

    ''                ' Änderung 9.10.14, damit die Spaces in einer 
    ''                'If hproj.tfZeile >= curZeile + 1 Then
    ''                '    curZeile = curZeile + 1
    ''                'End If
    ''                ' Ende Änderung
    ''                hproj.tfZeile = curzeile
    ''                lastzeile = curzeile
    ''                'Call ZeichneProjektinPlanTafel2(pname, curZeile)
    ''                ' wenn bestimmte Projekte beim Suchen nach einem Platz nicht berücksichtigt werden sollen,
    ''                ' dann müssen sie in einer Collection an ZeichneProjektinPlanTafel übergeben werden 
    ''                Dim tmpCollection As New Collection
    ''                Call ZeichneProjektinPlanTafel(tmpCollection, pname, curzeile, tmpCollection, tmpCollection)
    ''                curzeile = lastzeile + hproj.calcNeededLines(tmpCollection, tmpCollection, hproj.extendedView Or awinSettings.drawphases, False)


    ''                If curzeile > max Then
    ''                    max = curzeile
    ''                End If
    ''            Catch ex As Exception
    ''                tryExceptionCounts = tryExceptionCounts + 1
    ''            End Try



    ''        Next
    ''    End If

    ''    'If tryExceptionCounts > 0 Then
    ''    '    Call MsgBox("Anzahl: " & tryExceptionCounts)
    ''    'End If

    ''    'Call MsgBox("Ende: " & Date.Now.TimeOfDay.ToString)

    ''End Sub

    ''' <summary>
    ''' schnelles Zeichnen der Projekte von Scratch bzw. Update eines Projektes 
    ''' ist aber eigentlich nicht notwendig, weil der Perfromance Gewinn gegenüber der awinzeichnePlanTafel marginal ist
    ''' </summary>
    ''' <param name="fromScratch"></param>
    ''' <remarks></remarks>
    Public Sub awinZeichnePlanTafelNeu(ByVal fromScratch As Boolean)


        Dim pname As String
        Dim hproj As clsProjekt


        Dim notOK As Boolean = True
        Dim tryExceptionCounts As Integer = 0

        'Call MsgBox("Start: " & Date.Now.TimeOfDay.ToString)

        If fromScratch Then
            Dim zeile As Integer = 2
            Dim lastBU As String = ""

            For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

                pname = kvp.Value.name
                hproj = kvp.Value

                Dim tmpCollection As New Collection
                Call ZeichneProjektinPlanTafel(tmpCollection, pname, zeile, tmpCollection, tmpCollection)

                zeile = zeile + 1
            Next

        Else

            Call MsgBox("noch nicht implementiert ")

        End If


        'Call MsgBox("Ende: " & Date.Now.TimeOfDay.ToString)

    End Sub


    ''' <summary>
    ''' zeichnet das Projekt "pname" in die Plantafel; 
    ''' wenn es bereits vorhanden ist: keine Aktion  
    ''' noCollection ist eine Collection von Projekt-Namen, die beim Suchen nach einem Platz 
    ''' auf der Projekt-Tafel nicht berücksichtigt werden soll
    ''' ist insbesondere wichtig, wenn mehrere Projekte selektiert wurden und verschoben werden 
    ''' </summary>
    ''' <param name="pname"></param>
    ''' <remarks></remarks>
    Public Sub ZeichneProjektinPlanTafel(ByVal noCollection As Collection, ByVal pname As String, ByVal tryzeile As Integer,
                                         ByVal drawPhaseList As Collection, ByVal drawMilestoneList As Collection,
                                         Optional useTryZeileAnyway As Boolean = True)


        Dim drawphases As Boolean = awinSettings.drawphases
        Dim phasenNameID As String
        Dim phaseShapeName As String
        Dim msShapeName As String

        Dim start As Integer
        Dim laenge As Integer
        Dim status As String
        Dim pMarge As Double
        Dim pcolor As Object, schriftfarbe As Object
        Dim schriftgroesse As Integer
        Dim zeile As Integer
        Dim hproj As clsProjekt
        Dim top As Double, left As Double, width As Double, height As Double
        Dim projectShape As Excel.Shape
        Dim phaseShape As Excel.Shape, milestoneShape As Excel.Shape
        Dim shpUID As String
        'Dim tmpshapes As Excel.Shapes = appInstance.ActiveSheet.shapes
        Dim worksheetShapes As Excel.Shapes
        Dim heute As Date = Date.Now
        Dim tmpShapeRange As Excel.ShapeRange
        Dim vorlagenShape As xlNS.Shape
        Dim isMissingPhaseDefinition As Boolean = False
        Dim isMissingMilestoneDefinition As Boolean = False

        Dim shpExists As Boolean
        Dim oldAlternativeText As String = ""
        Dim isSummaryProject As Boolean


        Try

            worksheetShapes = CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Shapes

        Catch ex As Exception
            Throw New Exception("in ZeichneProjektinPlanTafel : keine Shapes Zuordnung möglich ")
        End Try

        Try
            hproj = ShowProjekte.getProject(pname)
            With hproj
                laenge = .anzahlRasterElemente
                shpUID = .shpUID
                start = .Start + .StartOffset
                pcolor = .farbe
                schriftfarbe = .Schriftfarbe
                schriftgroesse = .Schrift
                status = .Status
                pMarge = .ProjectMarge
                isSummaryProject = (.projectType = ptPRPFType.portfolio)
            End With
        Catch ex As Exception
            Throw New ArgumentException("in zeichneProjektinBoard - Projektname existiert nicht: " & pname)
        End Try

        If isSummaryProject Then
            pcolor = visboFarbeOrange
            drawphases = False
            hproj.extendedView = False
        End If

        ' prüfen, ob das Shape bereits existiert ...
        If shpUID <> "" Then
            Try
                projectShape = worksheetShapes.Item(pname)
                shpExists = True
                ' merken, weil bei Variante erzeugen der Alternative Text nicht geändert werden soll 
                oldAlternativeText = projectShape.AlternativeText
            Catch ex As Exception
                shpExists = False
                projectShape = Nothing
            End Try
        Else
            shpExists = False
            projectShape = Nothing
        End If



        '
        ' ist dort überhaupt Platz ? wenn nicht, dann Zeile mit freiem Platz suchen ...
        If tryzeile < 2 Then
            tryzeile = projectboardShapes.getMaxZeile
        End If

        If useTryZeileAnyway Then
            zeile = tryzeile
        Else
            zeile = findeMagicBoardPosition(noCollection, pname, tryzeile, start, laenge)
        End If



        Dim formerEE As Boolean = appInstance.EnableEvents
        enableOnUpdate = False
        appInstance.EnableEvents = False



        If shpExists Then

            If drawphases Or hproj.extendedView Then

                ' ungroup Shape, damit die einzelnen Phasen- bzw Milestone Shapes im Zugriff sind 
                Try
                    tmpShapeRange = projectShape.Ungroup
                Catch ex As Exception
                    tmpShapeRange = Nothing
                End Try

                Dim cphase As clsPhase

                For i = 1 To hproj.CountPhases
                    cphase = hproj.getPhase(i)
                    phasenNameID = cphase.nameID

                    isMissingPhaseDefinition = Not PhaseDefinitions.Contains(cphase.name)

                    '''' tk/ur: 28.9.15 
                    '''' damit die Phase (1) gefunden werden kann.  muss bei Phase(1) der Name anders zusammengesetzt sein als bei den anderen 
                    If phasenNameID = rootPhaseName Then
                        phaseShapeName = projectboardShapes.calcPhaseShapeName(pname, phasenNameID)
                    Else
                        phaseShapeName = projectboardShapes.calcPhaseShapeName(pname, phasenNameID) & "#" & i.ToString
                    End If

                    'phaseShapeName = pname & "#" & phasenName & "#" & i.ToString

                    Try
                        phaseShape = worksheetShapes.Item(phaseShapeName)
                        Call definePhaseAppearance(hproj, cphase, 0, phaseShape, isMissingPhaseDefinition)
                    Catch ex As Exception

                    End Try

                    For r = 1 To cphase.countMilestones

                        Dim cMilestone As clsMeilenstein
                        Dim cBewertung As clsBewertung

                        cMilestone = cphase.getMilestone(r)
                        cBewertung = cMilestone.getBewertung(1)

                        isMissingMilestoneDefinition = Not MilestoneDefinitions.Contains(cMilestone.name)

                        msShapeName = projectboardShapes.calcMilestoneShapeName(hproj.name, cMilestone.nameID)

                        ' existiert das schon ? 
                        Try
                            milestoneShape = worksheetShapes.Item(msShapeName)
                            Call defineResultAppearance(hproj, 0, milestoneShape, cBewertung, isMissingMilestoneDefinition, cMilestone.farbe)
                        Catch ex As Exception

                        End Try


                    Next


                Next

                ' Gruppieren des Shapes 
                projectShape = tmpShapeRange.Group
                projectShape.Name = hproj.name



            Else

                Call defineShapeAppearance(hproj, projectShape)

            End If


        Else

            ' ///////////////
            ' Shape existiert noch nicht 
            ' ///////////////

            ' hier wird der vorher bestimmte Wert gesetzt, wo das Shape gezeichnet werden kann 
            hproj.tfZeile = zeile

            If (drawphases And (hproj.CountPhases > 1)) Or (hproj.extendedView And (hproj.CountPhases > 1)) Then
                ' stelle das Projekt im Extended Mode dar  
                'Dim shapeGroupListe() As Object
                Dim shapeGroupListe() As String
                Dim arrayOfMSNames() As String
                Dim msShapeNames As New Collection
                Dim anzGroupElemente As Integer = 0
                Dim projectShapesCollection As New Collection



                'oldShape = Nothing
                phaseShape = Nothing

                Dim zeilenOffset As Integer = 0
                Dim lastEndDate As Date = StartofCalendar.AddDays(-1)

                For i = 1 To hproj.CountPhases

                    Dim cphase As clsPhase = hproj.getPhase(i)
                    With cphase

                        phasenNameID = .nameID

                    End With

                    isMissingPhaseDefinition = Not PhaseDefinitions.Contains(cphase.name)

                    Try
                        zeilenOffset = 0
                        Call hproj.calculateShapeCoord(i, zeilenOffset, top, left, width, height)

                        If i = 1 Then

                            If awinSettings.drawProjectLine Then

                                phaseShape = worksheetShapes.AddConnector(core.MsoConnectorType.msoConnectorStraight, CSng(left), CSng(top),
                                                                            CSng(left + width), CSng(top))
                            Else

                                phaseShape = worksheetShapes.AddShape(Type:=Microsoft.Office.Core.MsoAutoShapeType.msoShapeRoundedRectangle,
                                                        Left:=CSng(left), Top:=CSng(top), Width:=CSng(width), Height:=CSng(height))
                            End If

                        Else

                            'Dim tmpName As String = elemNameOfElemID(phasenNameID)
                            'If PhaseDefinitions.Contains(tmpName) Then
                            '    vorlagenShape = PhaseDefinitions.getShape(tmpName)
                            'Else
                            '    vorlagenShape = missingPhaseDefinitions.getShape(tmpName)
                            'End If


                            'phaseShape = worksheetShapes.AddShape(Type:=vorlagenShape.AutoShapeType,
                            '    Left:=CSng(left), Top:=CSng(top), Width:=CSng(width), Height:=CSng(height))
                            'vorlagenShape.PickUp()
                            'phaseShape.Apply()

                            'ur:190725
                            Dim appear As New clsAppearance
                            Dim tmpName As String = elemNameOfElemID(phasenNameID)
                            If PhaseDefinitions.Contains(tmpName) Then

                                appear = appearanceDefinitions(PhaseDefinitions.getAppearance(tmpName))
                            Else
                                appear = appearanceDefinitions(missingPhaseDefinitions.getAppearance(tmpName))
                            End If

                            phaseShape = worksheetShapes.AddShape(Type:=appear.shpType,
                              Left:=CSng(left), Top:=CSng(top), Width:=CSng(width), Height:=CSng(height))


                        End If


                    Catch ex As Exception
                        Throw New Exception("in zeichneProjektinPlantafel2 : keine Shape-Erstellung möglich ...  ")
                    End Try

                    phaseShapeName = projectboardShapes.calcPhaseShapeName(pname, phasenNameID) & "#" & i.ToString
                    'phaseShapeName = pname & "#" & phasenName & "#" & i.ToString
                    With phaseShape
                        .Name = phaseShapeName
                        .Title = phasenNameID
                        .AlternativeText = CInt(PTshty.phaseE).ToString
                    End With



                    If i = 1 Then
                        Call defineShapeAppearance(hproj, phaseShape)
                    Else
                        Call definePhaseAppearance(hproj, cphase, 0, phaseShape, isMissingPhaseDefinition)
                    End If


                    ' jetzt der Liste der ProjectboardShapes hinzufügen
                    projectboardShapes.add(phaseShape)

                    Try
                        projectShapesCollection.Add(phaseShapeName, Key:=phaseShapeName)
                    Catch ex As Exception

                    End Try


                    ' jetzt müssen alle Meilensteine dieser Phase gezeichnet werden 

                    With CType(hproj.getPhase(i), clsPhase)
                        Dim msName As String
                        Dim msShape As Excel.Shape

                        For r = 1 To .countMilestones

                            Dim cMilestone As clsMeilenstein
                            Dim cBewertung As clsBewertung

                            cMilestone = .getMilestone(r)
                            cBewertung = cMilestone.getBewertung(1)

                            isMissingMilestoneDefinition = Not MilestoneDefinitions.Contains(cMilestone.name)

                            ' Änderung tk 26.11.15
                            'If MilestoneDefinitions.Contains(cMilestone.name) Then
                            '    vorlagenShape = MilestoneDefinitions.getShape(cMilestone.name)
                            'Else
                            '    vorlagenShape = missingMilestoneDefinitions.getShape(cMilestone.name)
                            'End If
                            'Dim factorB2H As Double = vorlagenShape.Width / vorlagenShape.Height

                            'ur:190725
                            Dim appear As New clsAppearance
                            If MilestoneDefinitions.Contains(cMilestone.name) Then
                                appear = appearanceDefinitions(cMilestone.appearance)
                            Else
                                appear = appearanceDefinitions(cMilestone.appearance)
                            End If
                            Dim factorB2H As Double = appear.width / appear.height


                            hproj.calculateMilestoneCoord(cMilestone.getDate, zeilenOffset, factorB2H, top, left, width, height)

                            msName = projectboardShapes.calcMilestoneShapeName(hproj.name, cMilestone.nameID)
                            'msName = hproj.name & "#" & .name & "#M" & r.ToString
                            ' existiert das schon ? 
                            Try
                                msShape = worksheetShapes.Item(msName)
                            Catch ex As Exception
                                msShape = Nothing
                            End Try

                            If msShape Is Nothing Then


                                msShape = worksheetShapes.AddShape(Type:=appear.shpType,
                                                                Left:=CSng(left), Top:=CSng(top), Width:=CSng(width), Height:=CSng(height))
                                'ur:190725
                                'msShape = worksheetShapes.AddShape(Type:=vorlagenShape.AutoShapeType,
                                '                                Left:=CSng(left), Top:=CSng(top), Width:=CSng(width), Height:=CSng(height))
                                'vorlagenShape.PickUp()
                                'msShape.Apply()

                                With msShape
                                    .Name = msName
                                    .Title = cMilestone.nameID
                                    .AlternativeText = CInt(PTshty.milestoneE).ToString
                                End With


                                ' tk 24.3.2015 um nachher die Milestone Shapes nach vorne zu holen
                                If Not msShapeNames.Contains(msName) Then
                                    msShapeNames.Add(msName, msName)
                                End If

                                Call defineResultAppearance(hproj, 0, msShape, cBewertung, isMissingMilestoneDefinition,
                                                            cMilestone.farbe, appear)

                                ' jetzt der Liste der ProjectboardShapes hinzufügen
                                projectboardShapes.add(msShape)

                            Else
                                ' Koordinaten anpassen 
                                msShape.Top = CSng(top)
                            End If

                            Try
                                projectShapesCollection.Add(msName, Key:=msName)
                            Catch ex As Exception

                            End Try

                        Next


                    End With

                Next

                ' Änderung tk 24.3.2015
                ' jetzt müssen ggf die Meilensteine noch nach vorne gebracht werden ...
                Dim anzElements As Integer
                anzElements = msShapeNames.Count

                If anzElements > 0 Then

                    ReDim arrayOfMSNames(anzElements - 1)
                    For ix = 1 To anzElements
                        arrayOfMSNames(ix - 1) = CStr(msShapeNames.Item(ix))
                    Next

                    Try
                        CType(worksheetShapes.Range(arrayOfMSNames), Excel.ShapeRange).ZOrder(core.MsoZOrderCmd.msoBringToFront)
                    Catch ex As Exception

                    End Try

                End If


                ' hier werden die Shapes gruppiert
                anzGroupElemente = projectShapesCollection.Count

                If anzGroupElemente > 1 Then
                    ' es macht nur Sinn zu gruppieren, wenn es mehr als 1 Element ist ....

                    ReDim shapeGroupListe(anzGroupElemente - 1)
                    For i = 1 To anzGroupElemente
                        shapeGroupListe(i - 1) = CStr(projectShapesCollection.Item(i))
                    Next

                    Dim ShapeGroup As Excel.ShapeRange
                    ShapeGroup = worksheetShapes.Range(shapeGroupListe)
                    projectShape = ShapeGroup.Group()

                Else
                    ' in diesem Fall besteht das Projekt nur aus einer einzigen Phase
                    projectShape = phaseShape

                End If
                projectShape.Name = pname


            Else
                ' stelle das Projekt im Einzeilen Modus dar

                With hproj
                    .tfZeile = zeile ' calculateShapeCoord verwendet .tfzeile ! 
                    .CalculateShapeCoord(top, left, width, height)
                End With

                'If awinSettings.drawProjectLine Then
                If awinSettings.drawProjectLine Then

                    projectShape = worksheetShapes.AddConnector(core.MsoConnectorType.msoConnectorStraight, CSng(left), CSng(top),
                                                                CSng(left + width), CSng(top))

                    projectShape.AlternativeText = CInt(PTshty.projektL).ToString

                Else
                    projectShape = worksheetShapes.AddShape(Type:=Microsoft.Office.Core.MsoAutoShapeType.msoShapeRoundedRectangle,
                        Left:=CSng(left), Top:=CSng(top), Width:=CSng(width), Height:=CSng(height))

                End If

                projectShape.Name = pname
                Call defineShapeAppearance(hproj, projectShape)

            End If


        End If

        With projectShape
            If shpExists Then
                .AlternativeText = oldAlternativeText
            Else
                If hproj.extendedView Or drawphases Then
                    .AlternativeText = CInt(PTshty.projektE).ToString
                Else
                    If awinSettings.drawProjectLine Then
                        .AlternativeText = CInt(PTshty.projektL).ToString
                    Else
                        .AlternativeText = CInt(PTshty.projektN).ToString
                    End If
                End If
            End If


            hproj.shpUID = .ID.ToString
            hproj.tfZeile = calcYCoordToZeile(projectShape.Top)
        End With

        ' jetzt der Liste der ProjectboardShapes hinzufügen
        projectboardShapes.add(projectShape)

        ' jetzt muss das neue Shape in der ShowProjekte.ShapeListe eingetragen werden ..
        ShowProjekte.AddShape(pname, shpUID:=projectShape.ID.ToString)


        ' zu guter Letzt, 
        ' aber noch vor den Meilensteinen und Phasen  muss der Projekt-Name gezeichnet werden ; 
        If awinSettings.drawProjectLine Then
            Call zeichneNameInProjekt(hproj)
        End If

        ' jetzt müssen ggf die noch zu zeichnenden Meilensteine und Phasen eingezeichnet werden  
        ' das wird jetzt nach zeichneNameInProjekt gemacht, damit die Meilensteine / Phasen nicht vom Projekt-Namen überdeckt werden 

        Dim msNumber As Integer = 0
        If drawPhaseList.Count > 0 And Not (drawphases Or hproj.extendedView) Then
            Call zeichnePhasenInProjekt(hproj:=hproj, namenListe:=drawPhaseList, numberIt:=False, msNumber:=msNumber,
                                        vonMonth:=showRangeLeft, bisMonth:=showRangeRight)
            'Call zeichnePhasenInProjekt(hproj, drawPhaseList, False, msNumber)
        End If

        msNumber = 0
        If drawMilestoneList.Count > 0 And Not (drawphases Or hproj.extendedView) Then
            Call zeichneMilestonesInProjekt(hproj, drawMilestoneList, 4, showRangeLeft, showRangeRight, False, msNumber, False)
            'Call zeichneMilestonesInProjekt(hproj, drawMilestoneList, 4, 0, 0, False, msNumber, False)
        End If


        'If roentgenBlick.isOn Then
        '    With roentgenBlick
        '        Call awinShowNeedsofProject1(mycollection:=.myCollection, type:=.type, projektname:=pname)
        '    End With
        'End If

        If drawPhaseList.Count = 0 And drawMilestoneList.Count = 0 Then
            ' jetzt müssen die Charts, die vom Projekt evtl überdeckt werden in den Vordergrund geholt werden 
            ' das muss jedoch nur gemacht werden, wenn nicht vorher schon zeichnePhasenInProjekt oder zeichneMilestonesInProjekt aufgerufen wurde 
            Call bringChartsToFront(projectShape)
        End If



        appInstance.EnableEvents = formerEE
        enableOnUpdate = True

    End Sub


    '' '' ''' <summary>
    '' '' ''' gibt die Anzahl Zeilen zurück, die das Projekt im "expanded View Mode" benötigt 
    '' '' ''' </summary>
    '' '' ''' <param name="hproj"></param>
    '' '' ''' <returns></returns>
    '' '' ''' <remarks></remarks>
    '' ''Public Function calculateNeededLines(ByVal hproj As clsProjekt) As Integer


    '' ''    Dim phasenName As String
    '' ''    Dim zeilenOffset As Integer = 1
    '' ''    Dim lastEndDate As Date = StartofCalendar.AddDays(-1)
    '' ''    Dim tmpValue As Integer


    '' ''    If awinSettings.drawphases Then

    '' ''        For i = 1 To hproj.CountPhases

    '' ''            With hproj.getPhase(i)

    '' ''                phasenName = .name
    '' ''                If DateDiff(DateInterval.Day, lastEndDate, .getStartDate) < 0 Then
    '' ''                    zeilenOffset = zeilenOffset + 1
    '' ''                    lastEndDate = StartofCalendar.AddDays(-1)
    '' ''                End If


    '' ''                If DateDiff(DateInterval.Day, lastEndDate, .getEndDate) > 0 Then
    '' ''                    lastEndDate = .getEndDate
    '' ''                End If

    '' ''            End With


    '' ''        Next

    '' ''        If hproj.CountPhases > 1 Then
    '' ''            tmpValue = zeilenOffset
    '' ''        Else
    '' ''            tmpValue = 1
    '' ''        End If


    '' ''    Else
    '' ''        tmpValue = 1
    '' ''    End If


    '' ''    calculateNeededLines = tmpValue


    '' ''End Function


    ''' <summary>
    ''' gibt die Anzahl Zeilen zurück, die das angegebene Shape benötigt  
    ''' </summary>
    ''' <param name="shpElement"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function getNeededSpace(ByVal shpElement As Excel.Shape) As Integer

        Dim tmpValue As Integer
        Dim zeileTop As Integer, zeileBottom As Integer

        zeileTop = calcYCoordToZeile(shpElement.Top)
        zeileBottom = calcYCoordToZeile(shpElement.Top + shpElement.Height)

        tmpValue = System.Math.Max(zeileBottom - zeileTop, 1)

        getNeededSpace = tmpValue


    End Function


    ''' <summary>
    ''' verschiebt ab Zeile "von" um "anzahlZeilen" alle Projekt-Shapes nach unten 
    ''' aktualisiert auch die tfzeile in den Projekten entsprechend
    ''' die Projekte, die in der collection selCollection enthalten sind, werden nicht nach unten verschoben 
    ''' Projekte, die ab Zeile Stoppzeile stehen, werden nicht nach unten verschoben 
    ''' </summary>
    ''' <param name="anzahlZeilen"></param>
    ''' <remarks></remarks>
    Public Sub moveShapesDown(ByVal selCollection As Collection,
                              ByVal vonZeile As Integer, ByVal anzahlZeilen As Integer, ByVal stoppzeile As Integer)

        Dim worksheetShapes As Excel.Shapes
        Dim shpElement As Excel.Shape
        Dim formerEOU As Boolean = enableOnUpdate
        Dim shapeType As Integer
        Dim obererRand As Double = calcZeileToYCoord(vonZeile)
        Dim stoppRand As Double = calcZeileToYCoord(stoppzeile)
        Dim differenz As Double = anzahlZeilen * boxHeight
        Dim hproj As clsProjekt

        enableOnUpdate = False

        ' eine maximale Größe, um sicherzugehen, daß in diesem Fall alle Projekte verschoben werden 
        If stoppzeile = 0 Then
            stoppRand = calcZeileToYCoord(40000)
        End If

        Try

            worksheetShapes = CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Shapes

        Catch ex As Exception
            Throw New Exception("in moveShapesDown : keine Shapes Zuordnung möglich ")
        End Try


        ' jetzt werden die Shapes verschoben ...
        For i = 1 To worksheetShapes.Count
            shpElement = worksheetShapes.Item(i)

            With shpElement

                If Not CBool(.HasChart) Then

                    shapeType = -1
                    If Not IsNothing(.AlternativeText) Then
                        If .AlternativeText.Length > 0 Then
                            shapeType = CInt(.AlternativeText)
                        End If
                    End If


                    If .Top >= obererRand And (Not selCollection.Contains(shpElement.Name)) _
                        And .Top < stoppRand Then
                        .Top = CSng(.Top + differenz)

                        ' Ergänzung 11.5.2014: Projekte Anpassen und projectboardShapes Einträge korrigieren 
                        If shapeType = PTshty.phaseE Or shapeType = PTshty.phaseN Or shapeType = PTshty.phase1 Or
                        shapeType = PTshty.milestoneE Or shapeType = PTshty.milestoneN Or
                        shapeType = PTshty.status Then

                            projectboardShapes.add(shpElement)

                        ElseIf isProjectType(shapeType) Then

                            projectboardShapes.add(shpElement)
                            hproj = ShowProjekte.getProject(shpElement.Name, True)
                            'hproj.tfZeile = calcYCoordToZeile(shpElement.Top)
                            hproj.tfZeile = hproj.tfZeile + anzahlZeilen


                        End If

                    End If

                End If

            End With

        Next


        enableOnUpdate = formerEOU

    End Sub

    ''' <summary>
    ''' verschiebt alle Shapes, die ab vonZeile liegen um eins nach oben
    ''' vorher wird aber geprüft, on das frei ist 
    ''' wenn doItAnyWay = true, wird keine Prüfung vorgenommen, ob frei ...   
    ''' </summary>
    ''' <param name="vonZeile"></param>
    ''' <remarks></remarks>
    Public Sub moveShapesUp(ByVal vonZeile As Integer, ByVal anzahlZeilen As Integer, Optional doItAnyway As Boolean = False)

        Dim worksheetShapes As Excel.Shapes
        Dim shpElement As Excel.Shape
        Dim formerEOU As Boolean = enableOnUpdate
        Dim zielZeileIsFrei As Boolean = False
        Dim zielZeile As Integer = vonZeile
        Dim shapeType As Integer
        Dim hproj As clsProjekt
        Dim ok As Boolean
        Dim obererRand As Double = calcZeileToYCoord(vonZeile)
        Dim differenz As Double = anzahlZeilen * boxHeight

        enableOnUpdate = False

        If doItAnyway Then
            ok = True
        Else
            ok = magicBoardZeileIstFrei(zielZeile)
        End If

        If ok Then

            Try

                worksheetShapes = CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Shapes

            Catch ex As Exception
                Throw New Exception("in moveShapesUp : keine Shapes Zuordnung möglich ")
            End Try


            ' jetzt werden die Shapes verschoben ...
            For i = 1 To worksheetShapes.Count
                shpElement = worksheetShapes.Item(i)

                With shpElement

                    If Not CBool(.HasChart) Then

                        If .Top >= obererRand Then
                            .Top = CSng(.Top - differenz)

                            ' Ergänzung 11.5.2014: Projekte Anpassen und projectboardShapes Einträge korrigieren 
                            If shapeType = PTshty.phaseE Or shapeType = PTshty.phaseN Or shapeType = PTshty.phase1 Or
                            shapeType = PTshty.milestoneE Or shapeType = PTshty.milestoneN Or
                            shapeType = PTshty.status Then

                                projectboardShapes.add(shpElement)

                            ElseIf isProjectType(shapeType) Then

                                projectboardShapes.add(shpElement)
                                hproj = ShowProjekte.getProject(shpElement.Name, True)
                                hproj.tfZeile = calcYCoordToZeile(shpElement.Top)

                            End If

                        End If

                    End If

                End With

            Next

            ' jetzt werden die Projekte angepasst 
            ' das unten folgende ist durch die Ergänzung oben vom 11.5.14 nicht mehr notwendig 

            'For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

            '    With kvp.Value
            '        If .tfZeile >= vonZeile And .tfZeile - anzahlZeilen >= 2 Then
            '            .tfZeile = .tfZeile - anzahlZeilen
            '        End If
            '    End With

            'Next

        End If



        enableOnUpdate = formerEOU

    End Sub

    ''' <summary>
    ''' zeichnet für das Projekt das Status Shape; wenn es bereits existiert, wird das alte gelöscht, das neue gezeichnet 
    ''' wenn number > 0 , wird diese Zahl in das Symbol geschrieben 
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="number"></param>
    ''' <remarks></remarks>
    Public Sub zeichneStatusSymbolInPlantafel(ByVal hproj As clsProjekt, ByVal number As Integer)
        Dim top As Double, left As Double, height As Double, width As Double
        Dim worksheetShapes As Excel.Shapes
        Dim statusShape As Excel.Shape
        Dim shpName As String
        Dim timeAtStatus As Date = hproj.timeStamp
        Dim heuteColumn As Integer = getColumnOfDate(timeAtStatus)

        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
            worksheetShapes = .Shapes

            shpName = projectboardShapes.calcStatusShapeName(hproj.name, heuteColumn)
            ' existiert das schon ? 
            Try
                statusShape = worksheetShapes.Item(shpName)
                statusShape.Delete()
            Catch ex As Exception
                'statusShape = Nothing
            End Try

            'If statusShape Is Nothing Then

            hproj.calculateStatusCoord(timeAtStatus, top, left, width, height)
            statusShape = .Shapes.AddShape(Type:=Microsoft.Office.Core.MsoAutoShapeType.msoShapeOval,
                                            Left:=CSng(left), Top:=CSng(top), Width:=CSng(width), Height:=CSng(height))

            With statusShape
                .Name = shpName
                .Title = "Status"
                .AlternativeText = CInt(PTshty.status).ToString
            End With

            Call defineStatusAppearance(hproj, number, statusShape)

            ' jetzt der Liste der ProjectboardShapes hinzufügen
            projectboardShapes.add(statusShape)

            'shapesCollection.Add(resultShape.Name)

            'End If


        End With

        ' jetzt müssen die Charts ggf wieder nach vorne gebracht werden 
        Call bringChartsToFront(statusShape)


    End Sub

    ''' <summary>
    ''' wird von der WPFPIE Vorage aufgerufen !
    ''' </summary>
    ''' <param name="nameList"></param>
    ''' <param name="farbTyp"></param>
    ''' <param name="numberIt"></param>
    ''' <remarks></remarks>
    Public Sub zeichneMilestones(ByVal nameList As Collection, ByVal farbTyp As Integer, ByVal numberIt As Boolean)
        ' tue es für alle Projekte in Showprojekte 


        Dim todoListe As New SortedList(Of Long, clsProjekt)
        Dim key As Long
        Dim formerEE As Boolean = appInstance.EnableEvents
        Dim formereO As Boolean = enableOnUpdate

        appInstance.EnableEvents = False
        enableOnUpdate = False

        If selectedProjekte.Count > 0 Then
            For Each kvp As KeyValuePair(Of String, clsProjekt) In selectedProjekte.Liste

                key = 10000 * kvp.Value.tfZeile + kvp.Value.tfspalte
                todoListe.Add(key, kvp.Value)

            Next
        Else
            For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

                key = 10000 * kvp.Value.tfZeile + kvp.Value.tfspalte
                todoListe.Add(key, kvp.Value)

            Next
        End If


        Dim msNumber As Integer = 1

        For Each kvp As KeyValuePair(Of Long, clsProjekt) In todoListe

            Call zeichneMilestonesInProjekt(kvp.Value, nameList, farbTyp, showRangeLeft, showRangeRight, numberIt, msNumber, False)

        Next

        Call awinSelect()

        appInstance.EnableEvents = formerEE
        enableOnUpdate = formereO

    End Sub


    ''' <summary>
    ''' zeichnet die Meilensteine eines Projektes
    ''' </summary>
    ''' <param name="hproj">
    ''' das Projekt, das die Meilensteine enthält</param>
    ''' <param name="namenListe">
    ''' enthält die Namen,der Meilensteine die gezeichnet werden sollen
    ''' wenn leer, werden alle gezeichnet</param>
    ''' <param name="farbTyp">
    ''' gibt an , welche Farbe gezeichnet werden soll; bei 4 werden alle gezeichnet </param>
    ''' <param name="tmpShowrangeleft">
    ''' gibt den linken Rand des Zeitraums an, sofern einer betrachtet werden soll </param>
    ''' <param name="tmpShowrangeRight">gibt den rechten Rand des Zeitraums an, sofern einer betrachtet werden soll </param>
    ''' <param name="numberIt">
    ''' gibt an, ob der Meilenstein nummeriert werden soll</param>
    ''' <param name="msNumber">
    ''' gibt die Nummer an, aber nummeriert werden soll</param>
    ''' <param name="report">
    ''' gibt an, ob vom Reporting aufgerufen
    ''' </param>
    ''' <remarks></remarks>
    Public Sub zeichneMilestonesInProjekt(ByVal hproj As clsProjekt, ByVal namenListe As Collection, ByVal farbTyp As Integer, ByVal tmpShowRangeLeft As Integer, ByVal tmpShowrangeRight As Integer,
                                                      ByVal numberIt As Boolean, ByRef msNumber As Integer, ByVal report As Boolean)

        Dim top As Double, left As Double, width As Double, height As Double
        Dim resultShape As Excel.Shape
        Dim worksheetShapes As Excel.Shapes
        Dim heute As Date = Date.Now
        Dim alreadyGroup As Boolean = False
        Dim shpElement As Excel.Shape
        Dim shpName As String
        Dim resultColumn As Integer
        Dim onlyFew As Boolean
        Dim projectShape As Excel.Shape
        Dim shapeGruppe As Excel.ShapeRange
        Dim newShape As Excel.ShapeRange = Nothing
        Dim listOFShapes As New Collection
        Dim found As Boolean = True
        Dim showOnlyWithinTimeFrame As Boolean
        Dim vorlagenShape As xlNS.Shape
        Dim realNameList As New Collection

        Try
            If namenListe.Count > 0 Then
                onlyFew = True
                realNameList = hproj.getElemIdsOf(namenListe, True)
            Else
                onlyFew = False
                realNameList = hproj.getAllElemIDs(True)
            End If
        Catch ex As Exception
            onlyFew = False
        End Try

        ' jetzt wurde aus der Liste von Namen / oder IDs gesichert eine Liste von IDs gemacht 


        ' es muss abgefangen werden, daß nicht alle Meilensteine gezeichnet werden, wenn namenListe.count > 0, aber später 
        ' die neue namenliste.count  = 0 ; dass wird dadurch sichergestellt, dass onlyFew bereits vor Bearbeitung / Ersetzung der Namenliste gesetzt ist  


        If tmpShowRangeLeft <= 0 Or
            tmpShowrangeRight <= 0 Or
            tmpShowRangeLeft > tmpShowrangeRight Then

            showOnlyWithinTimeFrame = False

        Else

            showOnlyWithinTimeFrame = True

        End If



        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)

            worksheetShapes = .Shapes
            ' Änderung 12.7.14 Alle Milestone Shapes in ein gruppiertes Shape
            ' jetzt muss das Projekt-Shape gesucht werden
            Try
                projectShape = worksheetShapes.Item(hproj.name)
            Catch ex As Exception
                found = False
                projectShape = Nothing
            End Try


            ' found=true bedeutet, dass das Shape bereits angezeigt wird  
            If found Then

                ' jetzt muss die Liste an Shapes aufgebaut werden 
                If projectShape.AlternativeText = CInt(PTshty.projektL).ToString Or
                    projectShape.AutoShapeType = core.MsoAutoShapeType.msoShapeRoundedRectangle Then

                    listOFShapes.Add(projectShape.Name)

                Else
                    shapeGruppe = projectShape.Ungroup
                    Dim anzElements As Integer = shapeGruppe.Count

                    Dim i As Integer
                    For i = 1 To anzElements
                        listOFShapes.Add(shapeGruppe.Item(i).Name)
                    Next


                End If

                ' hier muss jetzt ausgenutzt werden, dass man bereits die direkten IDs der Meilensteine hat ... 

                ' es muss aber auch berücksichtigt werden, wenn alle gezeigt werden sollen ... 

                For m As Integer = 1 To realNameList.Count

                    Dim cMilestone As clsMeilenstein = hproj.getMilestoneByID(CStr(realNameList.Item(m)))
                    Dim isMissingDefinition As Boolean = Not MilestoneDefinitions.Contains(cMilestone.name)

                    If Not IsNothing(cMilestone) Then
                        Dim cBewertung As clsBewertung

                        cBewertung = cMilestone.getBewertung(1)
                        resultColumn = getColumnOfDate(cMilestone.getDate)

                        If farbTyp = 4 Or farbTyp = cBewertung.colorIndex Then
                            ' es muss nur etwas gemacht werden , wenn entweder alle Farben gezeichnet werden oder eben die übergebene

                            If (showOnlyWithinTimeFrame And (resultColumn < tmpShowRangeLeft Or resultColumn > tmpShowrangeRight)) Then
                                ' nichts machen 
                            Else
                                Dim zeilenoffset As Integer = 0
                                ' hier die übergeordnete Phase holen ...

                                ' Änderung tk 25.11.15: sofern die Definition in definitions.. enthalten ist: auch berücksichtigen
                                'If MilestoneDefinitions.Contains(cMilestone.name) Then
                                '    vorlagenShape = MilestoneDefinitions.getShape(cMilestone.name)

                                'Else
                                '    vorlagenShape = missingMilestoneDefinitions.getShape(cMilestone.name)

                                'End If


                                'Dim factorB2H As Double = vorlagenShape.Width / vorlagenShape.Height
                                'ur:190725
                                Dim appear As New clsAppearance
                                If MilestoneDefinitions.Contains(cMilestone.name) Then
                                    appear = appearanceDefinitions(cMilestone.appearance)
                                Else
                                    appear = appearanceDefinitions(cMilestone.appearance)
                                End If
                                Dim factorB2H As Double = appear.width / appear.height


                                hproj.calculateMilestoneCoord(cMilestone.getDate, zeilenoffset, factorB2H, top, left, width, height)
                                'hproj.calculateResultCoord(cResult.getDate, zeilenoffset, top, left, width, height)

                                shpName = projectboardShapes.calcMilestoneShapeName(hproj.name, cMilestone.nameID)

                                ' existiert das schon ? 
                                Try
                                    shpElement = worksheetShapes.Item(shpName)
                                Catch ex As Exception
                                    shpElement = Nothing
                                End Try

                                If shpElement Is Nothing Then

                                    If report Then
                                        top = top - boxWidth
                                    End If

                                    '' Alt - Start 
                                    'resultShape = .Shapes.AddShape(Type:=vorlagenShape.AutoShapeType,
                                    '                                Left:=CSng(left), Top:=CSng(top), Width:=CSng(width), Height:=CSng(height))
                                    'vorlagenShape.PickUp()
                                    'resultShape.Apply()

                                    'resultShape.Rotation = vorlagenShape.Rotation

                                    'With resultShape
                                    '    .Name = shpName
                                    '    .Title = cMilestone.nameID
                                    '    .AlternativeText = CInt(PTshty.milestoneN).ToString
                                    'End With
                                    '' Alt - Ende
                                    'Neu - Start
                                    Try
                                        resultShape = worksheetShapes.Item(shpName)
                                    Catch ex As Exception
                                        resultShape = Nothing
                                    End Try

                                    If resultShape Is Nothing Then


                                        resultShape = worksheetShapes.AddShape(Type:=appear.shpType,
                                                                        Left:=CSng(left), Top:=CSng(top), Width:=CSng(width), Height:=CSng(height))
                                        'ur:190725
                                        'msShape = worksheetShapes.AddShape(Type:=vorlagenShape.AutoShapeType,
                                        '                                Left:=CSng(left), Top:=CSng(top), Width:=CSng(width), Height:=CSng(height))
                                        'vorlagenShape.PickUp()
                                        'msShape.Apply()

                                        resultShape.Rotation = appear.Rotation
                                        With resultShape
                                            .Name = shpName
                                            .Title = cMilestone.nameID
                                            .AlternativeText = CInt(PTshty.milestoneE).ToString
                                        End With

                                        ' Neu - Ende



                                        msNumber = msNumber + 1
                                        If numberIt Then
                                            Call defineResultAppearance(hproj, msNumber, resultShape, cBewertung, isMissingDefinition, cMilestone.farbe)

                                        Else
                                            Call defineResultAppearance(hproj, 0, resultShape, cBewertung, isMissingDefinition, cMilestone.farbe)
                                        End If

                                        ' jetzt der Liste der ProjectboardShapes hinzufügen
                                        projectboardShapes.add(resultShape)

                                        ' jetzt der Liste von Shapes hinzufügen, die dann nachher zum ProjektShape gruppiert werden sollen 
                                        listOFShapes.Add(resultShape.Name)

                                    End If

                                End If
                            End If
                        End If

                    End If

                Next


            End If


            If listOFShapes.Count > 1 Then
                ' hier werden die Shapes gruppiert
                projectShape = projectboardShapes.groupShapes(listOFShapes, hproj.name)

                ' jetzt der Liste der ProjectboardShapes hinzufügen
                projectboardShapes.add(projectShape)
            End If


        End With


        ' jetzt müssen ggf die Charts wieder in den Vordergrund gebracht werden 
        Call bringChartsToFront(projectShape)

    End Sub

    ''' <summary>
    ''' zeichnet die Werte der Rollen und Kosten auf die Projekt-Tafel
    ''' </summary>
    ''' <param name="hproj">das Projekt, das gezeichnet werden soll </param>
    ''' <param name="namenListe">die Liste der Rollen bzw. Kosten</param>
    ''' <param name="tmpShowRangeLeft">linke Spalte des Bereiches, in dem gezeichnet werden soll</param>
    ''' <param name="tmpShowrangeRight">rechte Spalte des Bereiches, in dem gezeichnet werden soll</param>
    ''' <param name="type">gibt an den Type an, damit lässt sich entscheiden, ob Rolle / Kosten in der Namenliste stehen</param>
    ''' <remarks></remarks>
    Public Sub zeichneRollenKostenWerteInProjekt(ByVal hproj As clsProjekt, ByVal namenListe As Collection, ByVal tmpShowRangeLeft As Integer, ByVal tmpShowrangeRight As Integer,
                                                          ByVal type As String)

        ' aktuell wird das nur im Fall nicht-extended Mode angezeigt 
        If awinSettings.drawphases Then
            ' nichts tun 
            Call MsgBox("wird aktuell nur im Einzeilen - Modus unterstützt" & vbLf &
                         "Wählen Sie Extended Mode = Nein")
            Exit Sub
        End If

        ' aktuell wird nur unterstützt, einen Monat anzuzeigen 
        If tmpShowRangeLeft <> tmpShowrangeRight Then
            Call MsgBox("aktuell wird nur ein Monat unterstützt")
            Exit Sub
        End If

        ' bestimme die Zeile und die Spalte 
        Dim currentRow As Integer = hproj.tfZeile + 1
        Dim currentColumn As Integer = tmpShowRangeLeft

        ' bestimme den Wert
        Dim currentValue As Double = hproj.getBedarfeInMonth(namenListe, type, tmpShowRangeLeft, True)

        ' schreibe jetzt den Wert in die Zelle
        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False

        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
            If currentValue > 0 Then
                .Cells(currentRow, currentColumn).value = CInt(currentValue)

            End If

        End With

        appInstance.EnableEvents = formerEE


    End Sub

    ''' <summary>
    ''' trägt bei Projektlinie den Namen ein ... 
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <remarks></remarks>
    Public Sub zeichneNameInProjekt(ByVal hproj As clsProjekt)

        Dim projectTop As Single, projectLeft As Single, projectHeight As Single, projectWidth As Single
        Dim txtTop As Single, txtLeft As Single, txtwidth As Single, txtHeight As Single
        Dim pNameShape As Excel.Shape
        Dim worksheetShapes As Excel.Shapes

        Dim projectShape As Excel.Shape
        Dim shapeGruppe As Excel.ShapeRange

        Dim listOFShapes As New Collection
        Dim found As Boolean = True

        Dim pvName As String = calcProjektKey(hproj.name, hproj.variantName)

        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)

            worksheetShapes = .Shapes
            ' Änderung 12.7.14 Alle Milestone Shapes in ein gruppiertes Shape
            ' jetzt muss das Projekt-Shape gesucht werden
            Try
                projectShape = worksheetShapes.Item(hproj.name)
            Catch ex As Exception
                found = False
                projectShape = Nothing
            End Try


            ' found=true bedeutet, dass das Shape bereits angezeigt wird  
            If found Then

                ' Merken der Koordinaten 
                ' bestimmen der Text Koordinaten 
                With projectShape
                    projectTop = .Top
                    projectLeft = .Left
                    projectWidth = .Width
                    projectHeight = .Height
                End With

                txtTop = projectTop
                txtLeft = projectLeft + 7
                txtwidth = 30
                txtHeight = 30

                ' jetzt muss die Liste an Shapes aufgebaut werden 

                If projectShape.AlternativeText = CInt(PTshty.projektL).ToString Or
                    projectShape.AutoShapeType = core.MsoAutoShapeType.msoShapeRoundedRectangle Then
                    listOFShapes.Add(projectShape.Name)
                Else
                    shapeGruppe = projectShape.Ungroup
                    Dim anzElements As Integer = shapeGruppe.Count
                    ' hier muss der alte Shape Text rausgelöscht werdewn 

                    Dim oldTxtxShape As Excel.Shape = Nothing
                    For Each tmpshape As Excel.Shape In shapeGruppe
                        If tmpshape.AlternativeText = "(Projektname)" Then
                            oldTxtxShape = tmpshape
                        Else
                            listOFShapes.Add(tmpshape.Name)
                        End If
                    Next

                    ' jetzt muss der alte Text gelöscht werden ...
                    If Not IsNothing(oldTxtxShape) Then
                        oldTxtxShape.Delete()
                    End If


                End If



                ' ab jetzt darf auf projectShape nicht mehr zugegriffen werden, da es ggf bereits im Else-Zweig aufgelöst wurde ...


                ' jetzt muss das Textshape erzeugt werden 
                pNameShape = worksheetShapes.AddLabel(core.MsoTextOrientation.msoTextOrientationHorizontal,
                                                        txtLeft, txtTop, txtwidth, txtHeight)

                With pNameShape
                    .AlternativeText = "(Projektname)"
                    .TextFrame2.AutoSize = core.MsoAutoSize.msoAutoSizeShapeToFitText
                    .TextFrame2.WordWrap = core.MsoTriState.msoFalse
                    .TextFrame2.TextRange.Text = hproj.getShapeText
                    .TextFrame2.TextRange.Font.Size = hproj.Schrift
                    .TextFrame2.MarginLeft = 4
                    .TextFrame2.MarginRight = 4
                    .TextFrame2.MarginTop = 0
                    .TextFrame2.MarginBottom = 0
                    .TextFrame2.VerticalAnchor = core.MsoVerticalAnchor.msoAnchorMiddle
                    .TextFrame2.HorizontalAnchor = core.MsoHorizontalAnchor.msoAnchorCenter
                    ' braucht man für die Update Routine 
                    .Name = calcProjectTextShapeName(hproj.name)

                    ' hier werden die Farben und Fonts gemäß dem Protection Status bestimmt 
                    If writeProtections.isProtected(pvName) Then
                        If writeProtections.isPermanentProtected(pvName) Then
                            ' use permanent Font
                            .TextFrame.Characters.Font.FontStyle = awinSettings.protectedPermanentFont

                            If writeProtections.isProtected(pvName, dbUsername) Then
                                ' use byOtherProtectedColor 
                                .TextFrame.Characters.Font.Color = awinSettings.protectedByOtherColor
                            Else
                                ' use byMeProtected Color 
                                .TextFrame.Characters.Font.Color = awinSettings.protectedByMeColor
                            End If
                        Else
                            ' use normal font
                            If writeProtections.isProtected(pvName, dbUsername) Then
                                ' use byOtherProtectedColor 
                                .TextFrame.Characters.Font.Color = awinSettings.protectedByOtherColor
                            Else
                                ' use byMeProtected Color 
                                .TextFrame.Characters.Font.Color = awinSettings.protectedByMeColor
                            End If
                        End If
                    Else
                        ' es ist nicht protected, also muss nichts verändert werden 
                    End If

                    .Fill.Visible = core.MsoTriState.msoTrue
                    .Fill.ForeColor.RGB = RGB(255, 255, 255)
                    .Fill.Transparency = 0
                    .Fill.Solid()

                End With

                ' jetzt muss das Shape noch in der Höhe richtig positioniert werden 
                Dim diff As Single
                If awinSettings.drawphases Or hproj.extendedView Then
                    diff = CSng(0.3 * boxHeight)
                Else
                    diff = (pNameShape.Height - projectHeight) / 2
                End If
                pNameShape.Top = projectTop - diff

                Try
                    If pNameShape.Width > projectWidth Then
                        Dim newName As String = pNameShape.TextFrame2.TextRange.Text
                        Dim anzZeichen As Integer = newName.Length
                        Do Until pNameShape.Width < projectWidth Or anzZeichen < 3
                            pNameShape.TextFrame2.TextRange.Text = newName.Substring(0, anzZeichen - 2)
                            anzZeichen = anzZeichen - 1
                        Loop
                    End If
                Catch ex As Exception
                    pNameShape.TextFrame2.TextRange.Text = ""
                End Try


                ' jetzt wird das Shape aufgenommen 
                listOFShapes.Add(pNameShape.Name)


            End If


            If listOFShapes.Count > 1 Then
                ' hier werden die Shapes gruppiert
                projectShape = projectboardShapes.groupShapes(listOFShapes, hproj.name)

                ' jetzt der Liste der ProjectboardShapes hinzufügen
                projectboardShapes.add(projectShape)
            End If


        End With


        ' jetzt müssen ggf die Charts wieder in den Vordergrund gebracht werden 
        Call bringChartsToFront(projectShape)


    End Sub


    ''' <summary>
    ''' zeichnet die Abhängigkeiten zu dem übergebenen Projekt 
    ''' </summary>
    ''' <param name="hproj">Projekt, dessen Abhängigkeiten dargestellt werden sollen</param>
    ''' <param name="type">welche Art Abhängigkeit soll dargestellt werden</param>
    ''' <param name="auswahl">0: sowohl incoming als outgoing Abhängigkeiten
    ''' 1: nur outgoing Abhängigkeiten
    ''' 2: nur incoming abhängigkeiten</param>
    ''' <remarks></remarks>
    Public Sub zeichneDependenciesOfProject(ByVal hproj As clsProjekt, ByVal type As Integer, ByVal auswahl As Integer)

        Dim listeDep As Collection ' nimmt die Liste der abhängigen Projekte auf
        Dim depListe As Collection ' nimmt die Liste der Projekte auf, von denen hproj abhängig ist 
        Dim pShape As Excel.Shape
        Dim dpShape As Excel.Shape
        Dim newConnector As Excel.Shape
        Dim X1, X2, Y1, Y2 As Single
        Dim dProj As clsProjekt
        Dim curDependency As clsDependency

        Dim pName As String = hproj.name, dpName As String

        Dim tmpshapes As Excel.Shapes
        Dim formerEE As Boolean = appInstance.EnableEvents
        Dim formerEOU As Boolean = enableOnUpdate



        listeDep = allDependencies.activeListe(hproj.name, PTdpndncyType.inhalt)
        depListe = allDependencies.passiveListe(hproj.name, PTdpndncyType.inhalt)

        If listeDep.Count = 0 And depListe.Count = 0 Then
            ' es gibt keine Abhängigkeiten
            Throw New Exception("keine Abhängigkeiten vorhanden")
        Else
            ' jetzt werden die Abhängigkeiten gezeichnet ...


            ' Event Behandlung ausschalten 
            enableOnUpdate = False
            appInstance.EnableEvents = False

            tmpshapes = CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Shapes
            pShape = tmpshapes.Item(pName)

            ' outgoing dependencies
            If auswahl = 0 Or auswahl = 1 Then

                For d = 1 To listeDep.Count

                    Try
                        dpName = CStr(listeDep.Item(d))
                        dpShape = tmpshapes.Item(dpName)
                        dProj = ShowProjekte.getProject(dpName, True)
                        Dim curDegree As Integer
                        curDependency = allDependencies.getDependency(PTdpndncyType.inhalt, pName, dpName)
                        If Not IsNothing(curDependency) Then
                            curDegree = curDependency.degree
                        Else
                            curDegree = PTdpndncy.schwach
                        End If

                        'Dim newShapeName As String = pName.Trim & "#" & dpName.Trim
                        Dim newShapeName As String = projectboardShapes.calcDependencyShapeName(pName, dpName)

                        ' prüfen , ob das Shape schon existiert ? 
                        Try

                            newConnector = tmpshapes.Item(newShapeName)

                            With newConnector
                                If curDegree = PTdpndncy.schwach Then
                                    .Line.Weight = 4.0
                                    .Line.DashStyle = core.MsoLineDashStyle.msoLineLongDash
                                Else
                                    .Line.Weight = 4.0
                                    .Line.DashStyle = core.MsoLineDashStyle.msoLineSolid
                                End If
                            End With



                        Catch ex As Exception

                            Call calculateDepCoord(pShape, dpShape, X1, Y1, X2, Y2)
                            newConnector = tmpshapes.AddConnector(core.MsoConnectorType.msoConnectorStraight, X1, Y1, X2, Y2)

                            With newConnector
                                .Line.EndArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadTriangle
                                .ConnectorFormat.BeginConnect(pShape, 3)
                                .ConnectorFormat.EndConnect(dpShape, 1)
                                .Line.ForeColor.RGB = CInt(awinSettings.AmpelRot)
                                If curDegree = PTdpndncy.schwach Then
                                    .Line.Weight = 4.0
                                    .Line.DashStyle = core.MsoLineDashStyle.msoLineLongDash
                                Else
                                    .Line.Weight = 4.0
                                    .Line.DashStyle = core.MsoLineDashStyle.msoLineSolid
                                End If
                                .Name = newShapeName
                                .AlternativeText = CInt(PTshty.dependency).ToString
                            End With

                            Call bringChartsToFront(newConnector)

                        End Try



                    Catch ex As Exception

                    End Try

                Next


            End If

            ' incoming dependencies
            dpShape = tmpshapes.Item(pName)
            dpName = pName
            dProj = hproj
            If auswahl = 0 Or auswahl = 2 Then

                For d = 1 To depListe.Count

                    Try
                        pName = CStr(depListe.Item(d))
                        pShape = tmpshapes.Item(pName)
                        hproj = ShowProjekte.getProject(pName)

                        Dim curDegree As Integer
                        curDependency = allDependencies.getDependency(PTdpndncyType.inhalt, pName, dpName)
                        If Not IsNothing(curDependency) Then
                            curDegree = curDependency.degree
                        Else
                            curDegree = PTdpndncy.schwach
                        End If

                        Dim newShapeName As String = projectboardShapes.calcDependencyShapeName(pName, dpName)
                        'Dim newShapeName As String = pName.Trim & "#" & dpName.Trim

                        ' prüfen , ob das Shape schon existiert ? 
                        Try

                            newConnector = tmpshapes.Item(newShapeName)

                            With newConnector
                                If curDegree = PTdpndncy.schwach Then
                                    .Line.Weight = 4.0
                                    .Line.DashStyle = core.MsoLineDashStyle.msoLineLongDash
                                Else
                                    .Line.Weight = 4.0
                                    .Line.DashStyle = core.MsoLineDashStyle.msoLineSolid
                                End If
                            End With


                        Catch ex As Exception

                            Call calculateDepCoord(pShape, dpShape, X1, Y1, X2, Y2)
                            newConnector = tmpshapes.AddConnector(core.MsoConnectorType.msoConnectorStraight, X1, Y1, X2, Y2)

                            With newConnector
                                .Line.EndArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadTriangle
                                .ConnectorFormat.BeginConnect(pShape, 3)
                                .ConnectorFormat.EndConnect(dpShape, 1)
                                .Line.ForeColor.RGB = CInt(awinSettings.AmpelRot)
                                If curDegree = PTdpndncy.schwach Then
                                    .Line.Weight = 4.0
                                    .Line.DashStyle = core.MsoLineDashStyle.msoLineLongDash
                                Else
                                    .Line.Weight = 4.0
                                    .Line.DashStyle = core.MsoLineDashStyle.msoLineSolid
                                End If
                                .Name = newShapeName
                                .Title = "Dependency"
                            End With

                            Call bringChartsToFront(newConnector)

                        End Try

                    Catch ex As Exception

                    End Try

                Next


            End If

            ' Event Behandlung auf vorherigen Zustand setzen ...
            appInstance.EnableEvents = formerEE
            enableOnUpdate = formerEOU
        End If
    End Sub


    ''' <summary>
    ''' berechnet die Koordinaten des Abhängigkeit-Konnektors - der Linie
    ''' </summary>
    ''' <param name="pShape"></param>
    ''' <param name="dpShape"></param>
    ''' <param name="X1"></param>
    ''' <param name="Y1"></param>
    ''' <param name="X2"></param>
    ''' <param name="Y2"></param>
    ''' <remarks></remarks>
    Public Sub calculateDepCoord(ByVal pShape As Excel.Shape, ByVal dpShape As Excel.Shape,
                                     ByRef X1 As Single, ByRef Y1 As Single, ByRef X2 As Single, ByRef Y2 As Single)

        With pShape
            X1 = .Left + .Width / 2
            Y1 = .Top + .Height
        End With

        With dpShape
            X2 = .Left + .Width / 2
            Y2 = .Top
        End With

    End Sub

    ' nicht mehr notwendig, da eine zeichnePhasenInProjekt mit optionalen Paramtern das selbe erledigt 
    ' ''' <summary>
    ' ''' zeichnet für das angegebene Projekt hproj alle in namenliste enthaltenen Phasen
    ' ''' wenn namenliste leer ist, werden alle Phasen des Projekts gezeichnet
    ' ''' numberit steuet, ob die Phase für Reporting Zwecke eine Nummerierung erhalten soll 
    ' ''' </summary>
    ' ''' <param name="hproj"></param>
    ' ''' <param name="namenListe"></param>
    ' ''' <param name="numberIt"></param>
    ' ''' <param name="msNumber"></param>
    ' ''' <remarks></remarks>
    'Public Sub zeichnePhasenInProjekt(ByVal hproj As clsProjekt, ByVal namenListe As Collection, ByVal numberIt As Boolean, ByRef msNumber As Integer)

    '    'Dim top1 As Double, left1 As Double, top2 As Double, left2 As Double
    '    Dim top As Double, left As Double, width As Double, height As Double
    '    Dim nummer As Integer, gesamtZahl As Integer
    '    Dim phasenShape As Excel.Shape
    '    Dim worksheetShapes As Excel.Shapes
    '    Dim heute As Date = Date.Now
    '    Dim alreadyGroup As Boolean = False
    '    Dim shpElement As Excel.Shape
    '    Dim vorlagenShape As xlNS.Shape
    '    Dim shpName As String

    '    Dim onlyFew As Boolean
    '    Dim projectShape As Excel.Shape
    '    Dim shapeGruppe As Excel.ShapeRange
    '    Dim listOFShapes As New Collection
    '    Dim found As Boolean = True


    '    Dim nameIstInListe As Boolean
    '    Dim linienDicke As Double = 2.0


    '    ' als wievielte Phase wird das Shape gezeichnet ... 
    '    nummer = 1

    '    ' sollen nur die in der Namenliste aufgeführten Phasen gezeichnet werden ? 
    '    Try
    '        If namenListe.Count > 0 Then
    '            onlyFew = True
    '            gesamtZahl = namenListe.Count
    '        Else
    '            onlyFew = False
    '            gesamtZahl = hproj.CountPhases
    '        End If
    '    Catch ex As Exception
    '        onlyFew = False
    '    End Try


    '    With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)

    '        worksheetShapes = .Shapes

    '        ' Änderung 12.7.14 Alle Phasen Shapes in ein gruppiertes Shape
    '        ' jetzt muss das Projekt-Shape gesucht werden
    '        Try
    '            projectShape = worksheetShapes.Item(hproj.name)
    '        Catch ex As Exception
    '            found = False
    '            projectShape = Nothing
    '        End Try

    '        ' nur wenn das Projektshape überhaupt existiert, wird gezeichnet 
    '        If found Then


    '            ' jetzt muss die Liste an Shapes aufgebaut werden 
    '            If projectShape.AutoShapeType = MsoAutoShapeType.msoShapeRoundedRectangle Then

    '                listOFShapes.Add(projectShape.Name)

    '            Else
    '                shapeGruppe = projectShape.Ungroup
    '                Dim anzElements As Integer = shapeGruppe.Count

    '                Dim i As Integer
    '                For i = 1 To anzElements
    '                    listOFShapes.Add(shapeGruppe.Item(i).Name)
    '                Next
    '            End If


    '            For p = 1 To hproj.CountPhases

    '                Dim cphase As clsPhase = hproj.getPhase(p)

    '                Try
    '                    nameIstInListe = namenListe.Contains(cphase.name)
    '                Catch ex As Exception
    '                    nameIstInListe = False
    '                End Try



    '                If onlyFew And Not nameIstInListe Then
    '                    ' nichts machen 
    '                Else

    '                    linienDicke = boxHeight * 0.3
    '                    vorlagenShape = PhaseDefinitions.getShape(cphase.name)

    '                    Try
    '                        'cphase.calculateLineCoord(hproj.tfZeile, nummer, gesamtZahl, top1, left1, top2, left2, linienDicke)
    '                        cphase.calculatePhaseShapeCoord(top, left, width, height)

    '                    Catch ex As Exception
    '                        Throw New ArgumentException(ex.Message)
    '                    End Try

    '                    nummer = nummer + 1

    '                    shpName = projectboardShapes.calcPhaseShapeName(hproj.name, cphase.nameID)

    '                    Try
    '                        shpElement = worksheetShapes.Item(shpName)
    '                    Catch ex As Exception
    '                        shpElement = Nothing
    '                    End Try

    '                    If shpElement Is Nothing Then


    '                        'phasenShape = .Shapes.AddConnector(MsoConnectorType.msoConnectorStraight, CSng(left1), CSng(top1), CSng(left2), CSng(top2))
    '                        phasenShape = .Shapes.AddShape(Type:=vorlagenShape.AutoShapeType, _
    '                                                                Left:=CSng(left), Top:=CSng(top), Width:=CSng(width), Height:=CSng(height))
    '                        vorlagenShape.PickUp()
    '                        phasenShape.Apply()

    '                        With phasenShape
    '                            .Name = shpName
    '                            .Title = cphase.nameID
    '                            .AlternativeText = CInt(PTshty.phaseN).ToString
    '                        End With

    '                        msNumber = msNumber + 1
    '                        'If numberIt Then
    '                        '    Call defineLineAppearance(hproj, cphase, msNumber, phasenShape, linienDicke)

    '                        'Else
    '                        '    Call defineLineAppearance(hproj, cphase, 0, phasenShape, linienDicke)
    '                        'End If

    '                        ' jetzt der Liste der ProjectboardShapes hinzufügen
    '                        projectboardShapes.add(phasenShape)

    '                        ' jetzt der Liste von Shapes hinzufügen, die dann nachher zum ProjektShape gruppiert werden sollen 
    '                        listOFShapes.Add(phasenShape.Name)

    '                    End If


    '                End If

    '            Next

    '        End If



    '        If listOFShapes.Count > 1 Then
    '            ' hier werden die Shapes gruppiert
    '            projectShape = projectboardShapes.groupShapes(listOFShapes, hproj.name)

    '            ' jetzt der Liste der ProjectboardShapes hinzufügen
    '            projectboardShapes.add(projectShape)

    '        End If

    '    End With


    '    ' jetzt müssen die Charts ggf wieder nach vorne gebracht werden 
    '    Call bringChartsToFront(projectShape)

    'End Sub

    ''' <summary>
    ''' aktualisiert mit dem angegebenen Projekt die evtl angezeigten Info Forms zu Phase, Meilenstein oder Status
    ''' wenn das Objekt mit dem Namen nicht existiert, dann wird es entsprechend dort vermerkt 
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <remarks></remarks>
    Public Sub aktualisierePMSForms(ByVal hproj As clsProjekt)

        'Dim phaseNameID As String
        'Dim milestoneNameID As String

        ' tk 9.4.19 nicht mehr zeigen
        'If formPhase.Visible Then
        '    phaseNameID = formPhase.phaseNameID
        '    Call updatePhaseInformation(hproj, phaseNameID)
        'End If

        'If formMilestone.Visible Then

        '    milestoneNameID = formMilestone.milestone.nameID
        '    Call updateMilestoneInformation(hproj, milestoneNameID)

        'End If



        'If formStatus.Visible Then

        '    Call zeichneStatusSymbolInPlantafel(hproj, 0)
        '    Call updateStatusInformation(hproj)

        'End If





    End Sub




    ''' <summary>
    ''' zeichnet für das angegebene Projekt hproj alle in namenliste enthaltenen Phasen, sofern die Phase innerhalb 
    ''' der vonMonth, bisMonth aufgespannten Grenzen liegt 
    ''' wenn namenliste leer ist, werden alle Phasen des Projekts gezeichnet
    ''' numberit steuet, ob die Phase für Reporting Zwecke eine Nummerierung erhalten soll 
    ''' </summary>
    ''' <param name="hproj">das Projekt-Objekt</param>
    ''' <param name="namenListe">Liste der Phasen, die gezeichnet werden sollen</param>
    ''' <param name="vonMonth">linker rand des Kalenderzeitraums, der betrachtet werden soll</param>
    ''' <param name="bisMonth">rechter Rand des Kalenderzeitraums, der betrachtet werden soll</param>
    ''' <param name="numberIt">soll nummeriert werden </param>
    ''' <param name="msNumber">Start der Nummerierung</param>
    ''' <remarks></remarks>
    Public Sub zeichnePhasenInProjekt(ByVal hproj As clsProjekt, ByVal namenListe As Collection,
                                      ByVal numberIt As Boolean, ByRef msNumber As Integer,
                                      Optional ByVal vonMonth As Integer = 0, Optional ByVal bisMonth As Integer = 0)

        'Dim top1 As Double, left1 As Double, top2 As Double, left2 As Double
        Dim top As Double, left As Double, width As Double, height As Double
        Dim nummer As Integer
        Dim phasenShape As xlNS.Shape
        Dim worksheetShapes As xlNS.Shapes
        Dim heute As Date = Date.Now
        Dim alreadyGroup As Boolean = False
        Dim shpElement As xlNS.Shape
        Dim vorlagenshape As xlNS.Shape
        Dim appear As clsAppearance
        Dim shpName As String
        Dim todoListe As New Collection
        Dim realNameList As New Collection
        Dim phasenSchriftgroesse As Double = 5.0

        Dim onlyFew As Boolean
        Dim projectShape As xlNS.Shape
        Dim shapeGruppe As xlNS.ShapeRange
        Dim listOFShapes As New Collection
        Dim found As Boolean = True


        Dim ok As Boolean = True

        ' alle Phasen auslesen , die NameIDs dazu holen 
        Try
            If namenListe.Count > 0 Then
                onlyFew = True
                realNameList = hproj.getElemIdsOf(namenListe, False)
            Else
                onlyFew = False
                realNameList = hproj.getAllElemIDs(False)
            End If
        Catch ex As Exception
            onlyFew = False
        End Try


        ' als wievielte Phase wird das Shape gezeichnet ... 
        nummer = 1




        Try
            If vonMonth = 0 Or bisMonth = 0 Then
                ' alle Phasen betrachten 
                todoListe = realNameList
            Else
                'bringt eine List von Phasen ElemIDs zurück, die den angegebenen Zeitraum berühren / überdecken

                todoListe = hproj.phasesWithinTimeFrame(False, vonMonth, bisMonth, realNameList)

            End If



        Catch ex As Exception

        End Try

        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)

            worksheetShapes = .Shapes

            ' Änderung 12.7.14 Alle Phasen Shapes in ein gruppiertes Shape
            ' jetzt muss das Projekt-Shape gesucht werden
            Try
                projectShape = worksheetShapes.Item(hproj.name)
            Catch ex As Exception
                found = False
                projectShape = Nothing
            End Try


            If found Then

                ' jetzt muss die Liste an Shapes aufgebaut werden 
                If projectShape.AlternativeText = CInt(PTshty.projektL).ToString Or
                    projectShape.AutoShapeType = core.MsoAutoShapeType.msoShapeRoundedRectangle Then

                    listOFShapes.Add(projectShape.Name)

                Else
                    shapeGruppe = projectShape.Ungroup
                    Dim anzElements As Integer = shapeGruppe.Count

                    Dim i As Integer
                    For i = 1 To anzElements
                        listOFShapes.Add(shapeGruppe.Item(i).Name)
                    Next
                End If


                Dim cphase As clsPhase

                ' in der todoListe stehen jetzt nur Phasen, die den angegeben Zeitraum betreffen 
                For p = 1 To todoListe.Count

                    Dim phaseNameID As String = CStr(todoListe(p))


                    If realNameList.Contains(phaseNameID) Then

                        cphase = hproj.getPhaseByID(phaseNameID)
                        Dim isMissingDefinition As Boolean = Not PhaseDefinitions.Contains(cphase.name)

                        ' Änderung tk 25.11.15: sofern die Definition in definitions.. enthalten ist: auch berücksichtigen
                        If PhaseDefinitions.Contains(cphase.name) Then
                            'vorlagenshape = PhaseDefinitions.getShape(cphase.name)
                            appear = PhaseDefinitions.getShapeapp(cphase.name)
                        Else
                            'vorlagenshape = missingPhaseDefinitions.getShape(cphase.name)
                            appear = missingPhaseDefinitions.getShapeApp(cphase.name)
                        End If


                        Try
                            'cphase.calculateLineCoord(hproj.tfZeile, nummer, gesamtZahl, top1, left1, top2, left2, linienDicke)
                            cphase.calculatePhaseShapeCoord(top, left, width, height)
                        Catch ex As Exception
                            ok = False
                        End Try



                        If ok Then
                            nummer = nummer + 1

                            shpName = projectboardShapes.calcPhaseShapeName(hproj.name, cphase.nameID)
                            'shpName = hproj.name & "#" & cphase.name
                            ' existiert das schon ? 
                            Try
                                shpElement = worksheetShapes.Item(shpName)
                            Catch ex As Exception
                                shpElement = Nothing
                            End Try

                            If shpElement Is Nothing Then


                                'phasenShape = .Shapes.AddConnector(MsoConnectorType.msoConnectorStraight, CSng(left1), CSng(top1), CSng(left2), CSng(top2))

                                'phasenShape = .Shapes.AddShape(Type:=vorlagenshape.AutoShapeType,
                                '                                    Left:=CSng(left), Top:=CSng(top), Width:=CSng(width), Height:=CSng(height))
                                'vorlagenshape.PickUp()
                                'phasenShape.Apply()
                                phasenShape = .Shapes.AddShape(Type:=appear.shpType,
                                                                    Left:=CSng(left), Top:=CSng(top), Width:=CSng(width), Height:=CSng(height))
                                With phasenShape
                                    .Name = shpName
                                    .Title = cphase.nameID
                                    .AlternativeText = CInt(PTshty.phaseN).ToString
                                End With

                                msNumber = msNumber + 1
                                If numberIt Then
                                    Call definePhaseAppearance(hproj, cphase, msNumber, phasenShape, isMissingDefinition)

                                Else
                                    Call definePhaseAppearance(hproj, cphase, 0, phasenShape, isMissingDefinition)
                                End If

                                ' jetzt der Liste der ProjectboardShapes hinzufügen
                                projectboardShapes.add(phasenShape)

                                ' jetzt der Liste von Shapes hinzufügen, die dann nachher zum ProjektShape gruppiert werden sollen 
                                listOFShapes.Add(phasenShape.Name)


                            End If

                        End If

                    End If

                    ok = True

                Next

            End If

            If listOFShapes.Count > 1 Then
                ' hier werden die Shapes gruppiert
                projectShape = projectboardShapes.groupShapes(listOFShapes, hproj.name)

                ' jetzt der Liste der ProjectboardShapes hinzufügen
                projectboardShapes.add(projectShape)

            End If

        End With

        ' jetzt müssen die Charts ggf wieder nach vorne gebracht werden 
        Call bringChartsToFront(projectShape)


    End Sub

    Public Sub defineStatusAppearance(ByVal myproject As clsProjekt, ByVal number As Integer, ByRef myShape As Excel.Shape)
        Dim pColor As Long

        With myproject

            If .ampelStatus = 0 Then
                pColor = awinSettings.AmpelNichtBewertet
            ElseIf .ampelStatus = 1 Then
                pColor = awinSettings.AmpelGruen
            ElseIf .ampelStatus = 2 Then
                pColor = awinSettings.AmpelGelb
            Else
                pColor = awinSettings.AmpelRot
            End If

        End With

        With myShape

            With .Line
                .Visible = Microsoft.Office.Core.MsoTriState.msoTrue
                'If pMarge < 0 Then
                '    .ForeColor.RGB = RGB(255, 0, 0)
                '    .Weight = 2.0
                'Else
                '    .ForeColor.RGB = pcolor
                'End If
                .ForeColor.RGB = CInt(pColor)
                .Transparency = 0
            End With

            With .Fill
                '.Visible = msoTrue
                .ForeColor.RGB = CInt(pColor)
                .ForeColor.TintAndShade = 0
                .ForeColor.Brightness = -0.25

                'If roentgenBlick.isOn Then
                '    .Transparency = 0.8
                'Else
                '    .Transparency = 0.0
                'End If

                .Solid()

            End With

            Try

                If .TextFrame2.HasText <> core.MsoTriState.msoFalse Then
                    .TextFrame2.TextRange.Text = ""
                End If

                If number > 0 Then

                    With .TextFrame2
                        .MarginLeft = 3
                        .MarginRight = 3
                        .MarginBottom = 0
                        .MarginTop = 0
                        .WordWrap = Microsoft.Office.Core.MsoTriState.msoFalse
                        .VerticalAnchor = core.MsoVerticalAnchor.msoAnchorMiddle
                        .HorizontalAnchor = core.MsoHorizontalAnchor.msoAnchorCenter
                        .TextRange.Text = number.ToString
                        .TextRange.Font.Size = awinSettings.fontsizeLegend
                        .TextRange.Font.Fill.ForeColor.RGB = RGB(255, 255, 255)
                    End With


                End If
            Catch ex As Exception

            End Try



        End With


    End Sub

    ''' <summary>
    ''' bestimmt das Aussehen der Phase 
    ''' </summary>
    ''' <param name="myproject"></param>
    ''' <param name="myphase"></param>
    ''' <param name="lnumber"></param>
    ''' <param name="myShape"></param>
    ''' <remarks></remarks>
    Public Sub definePhaseAppearance(ByVal myproject As clsProjekt, ByVal myphase As clsPhase, ByVal lnumber As Integer, ByRef myShape As Excel.Shape,
                                      ByVal isMissingDefinition As Boolean)


        With myShape

            If isMissingDefinition Then

                If awinSettings.missingDefinitionColor <> xlNS.XlRgbColor.rgbWhite Then
                    .Line.Visible = core.MsoTriState.msoTrue
                    .Line.ForeColor.RGB = CInt(awinSettings.missingDefinitionColor)
                    .Line.Transparency = 0
                    .Line.Weight = 2
                    .Fill.ForeColor.RGB = CInt(myphase.farbe)


                End If
            Else
                Dim appear As clsAppearance = appearanceDefinitions(PhaseDefinitions.getAppearance(myphase.name))
                myShape.Rotation = appear.Rotation
                myShape.Fill.BackColor.RGB = appear.BGcolor
                myShape.Fill.ForeColor.RGB = appear.FGcolor
                myShape.Glow.Color.RGB = appear.Glowcolor
                myShape.Glow.Radius = appear.Glowradius
                myShape.Shadow.ForeColor.RGB = appear.ShadowFG
                'myShape.Shadow.Transparency = appear.ShadowTransp
                myShape.Line.BackColor.RGB = appear.LineBGColor
                myShape.Line.ForeColor.RGB = appear.LineFGColor
                myShape.Line.Weight = appear.LineWeight
            End If

        End With


    End Sub


    ''' <summary>
    ''' setzt das Aussehen des Meilensteines fest; kann für Reporting Zwecke auch nummeriert werden; der optionale Parameter bestimmt, 
    ''' ob die Phase/der Meilenstein ein dem System unbekannter Name ist 
    ''' </summary>
    ''' <param name="myproject"></param>
    ''' <param name="number"></param>
    ''' <param name="resultShape"></param>
    ''' <param name="bewertung"></param>
    ''' <param name="isMissingDefinition"></param>
    ''' <remarks></remarks>
    Public Sub defineResultAppearance(ByVal myproject As clsProjekt, ByVal number As Integer, ByRef resultShape As Excel.Shape, ByVal bewertung As clsBewertung,
                                          ByVal isMissingDefinition As Boolean, ByVal farbe As Long, Optional ByVal appear As clsAppearance = Nothing)



        With resultShape

            If awinSettings.mppShowAmpel = True Then
                .Glow.Radius = 5
                .Glow.Color.RGB = CInt(bewertung.color)
            End If

            If isMissingDefinition Then

                If awinSettings.missingDefinitionColor <> xlNS.XlRgbColor.rgbWhite Then
                    .Line.Visible = core.MsoTriState.msoTrue
                    .Line.ForeColor.RGB = CInt(awinSettings.missingDefinitionColor)
                    .Line.Weight = 2
                    .Fill.ForeColor.RGB = CInt(farbe)
                End If
            Else
                If Not IsNothing(appear) Then
                    resultShape.Rotation = appear.Rotation
                    resultShape.Fill.BackColor.RGB = appear.BGcolor
                    resultShape.Fill.ForeColor.RGB = appear.FGcolor
                    resultShape.Glow.Color.RGB = appear.Glowcolor
                    resultShape.Glow.Radius = appear.Glowradius
                    resultShape.Shadow.ForeColor.RGB = appear.ShadowFG
                    'resultShape.Shadow.Transparency = appear.ShadowTransp
                    resultShape.Line.BackColor.RGB = appear.LineBGColor
                    resultShape.Line.ForeColor.RGB = appear.LineFGColor
                    resultShape.Line.Weight = appear.LineWeight

                End If

            End If


            Try
                If .TextFrame2.HasText <> core.MsoTriState.msoFalse Then
                    .TextFrame2.TextRange.Text = ""
                End If

                If number > 0 Then

                    With .TextFrame2
                        .MarginLeft = 0
                        .MarginRight = 0
                        .MarginBottom = 0
                        .MarginTop = 0
                        .WordWrap = Microsoft.Office.Core.MsoTriState.msoFalse
                        .VerticalAnchor = core.MsoVerticalAnchor.msoAnchorMiddle
                        .HorizontalAnchor = core.MsoHorizontalAnchor.msoAnchorCenter
                        .TextRange.Text = number.ToString
                        .TextRange.Font.Size = awinSettings.fontsizeLegend
                        .TextRange.Font.Fill.ForeColor.RGB = RGB(255, 255, 255)
                    End With


                End If

            Catch ex As Exception

            End Try


        End With

    End Sub

    ''' <summary>
    ''' ist ausgelegt werden, dass es ausschließlich die Projektlinie bzw. das Projektshape zeichnet  
    ''' das Erscheinungsbild einer Phase wird separat bestimmt  
    ''' </summary>
    ''' <param name="myproject"></param>
    ''' <param name="projectShape"></param>
    ''' <remarks>
    ''' am 7.3.17 Änderung: parameter myProject wird als byval nicht als byref übergeben</remarks>
    Public Sub defineShapeAppearance(ByVal myproject As clsProjekt, ByRef projectShape As Excel.Shape)

        Dim pcolor As Object = xlNS.XlRgbColor.rgbAqua
        Dim schriftFarbe As Long
        Dim schriftGroesse As Integer
        Dim status As String = ""
        Dim pMarge As Double
        Dim pname As String
        Dim markTheShape As Boolean
        Dim ampel As Integer
        Dim showAmpel As Boolean = False
        Dim showResults As Boolean = True
        Dim myshape As Excel.Shape


        Try

            If projectShape.AlternativeText = CInt(PTshty.projektL).ToString Or
                    projectShape.AutoShapeType = core.MsoAutoShapeType.msoShapeRoundedRectangle Then
                myshape = projectShape
            Else

                If IsNothing(CType(CType(projectShape, Excel.Shape).GroupItems, Excel.GroupShapes)) Then
                    myshape = projectShape
                Else
                    myshape = CType(projectShape.GroupItems.Item(1), Excel.Shape)
                End If

            End If
        Catch ex As Exception

            myshape = projectShape

        End Try



        Try
            With myproject
                If (.projectType = ptPRPFType.portfolio) Then
                    pcolor = visboFarbeOrange
                Else
                    pcolor = .farbe
                End If

                schriftFarbe = CLng(.Schriftfarbe)
                schriftGroesse = .Schrift
                status = .Status
                pMarge = .ProjectMarge
                pname = .name
                ampel = .ampelStatus
                markTheShape = .marker
            End With
        Catch ex As Exception

        End Try


        With myshape

            Try
                If markTheShape Then
                    ' beauftragt, aber noch nicht wieder freigegeben ... 

                    .Glow.Color.RGB = CInt(awinSettings.glowColor)
                    .Glow.Color.TintAndShade = 0
                    .Glow.Color.Brightness = 0
                    .Glow.Transparency = 0.4
                    .Glow.Radius = 10

                Else
                    .Glow.Color.RGB = RGB(255, 255, 255)
                    .Glow.Transparency = 1.0
                End If
            Catch ex As Exception

            End Try

            ' hier muss jetzt unterschieden werden, ob die Projektlinie gezeichnet wurde oder der Balken 

            If awinSettings.drawProjectLine Then

                Try
                    With .Line
                        .ForeColor.RGB = CInt(pcolor)
                        .Transparency = 0
                        If myproject.projectType = ptPRPFType.portfolio Then
                            .Weight = 5.5
                        Else
                            .Weight = 4.0
                        End If

                        If status = ProjektStatus(PTProjektStati.geplant) Or
                            status = ProjektStatus(PTProjektStati.abgebrochen) Then
                            .DashStyle = core.MsoLineDashStyle.msoLineDash
                        Else
                            .DashStyle = core.MsoLineDashStyle.msoLineSolid
                        End If

                    End With
                Catch ex As Exception

                End Try

                ' Darstellung an den Linien-Enden, fixiert oder nicht fixiert 
                Try

                    With .Line
                        If status = ProjektStatus(PTProjektStati.geplant) Then

                            If myproject.movable Then
                                .BeginArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadOval
                                .EndArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadOval
                            Else
                                .BeginArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadDiamond
                                .EndArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadDiamond
                            End If


                        ElseIf status = ProjektStatus(PTProjektStati.beauftragt) Then

                            If myproject.movable Then
                                .BeginArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadOval
                                .EndArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadOval
                            Else
                                .BeginArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadDiamond
                                .EndArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadDiamond
                            End If

                        ElseIf status = ProjektStatus(PTProjektStati.ChangeRequest) Then

                            If myproject.movable Then
                                .BeginArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadOval
                                .EndArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadOval
                            Else
                                .BeginArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadTriangle
                                .EndArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadTriangle
                            End If

                        ElseIf status = ProjektStatus(PTProjektStati.abgebrochen) Then

                            .BeginArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadStealth
                            .EndArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadStealth

                        ElseIf status = ProjektStatus(PTProjektStati.abgeschlossen) Then

                            .BeginArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadOpen
                            .EndArrowheadStyle = core.MsoArrowheadStyle.msoArrowheadOpen
                        End If

                    End With

                Catch ex As Exception

                End Try

            Else

                Try
                    With .Fill

                        .ForeColor.RGB = CInt(pcolor)
                        .ForeColor.TintAndShade = 0
                        .ForeColor.Brightness = -0.25
                        .Transparency = 0.0


                        .Solid()

                    End With
                Catch ex As Exception

                End Try


                Try
                    With .TextFrame2
                        .VerticalAnchor = core.MsoVerticalAnchor.msoAnchorMiddle
                        .HorizontalAnchor = core.MsoHorizontalAnchor.msoAnchorNone
                        .TextRange.Font.Size = schriftGroesse
                        .TextRange.Font.Fill.ForeColor.RGB = CInt(schriftFarbe)
                    End With

                    .TextFrame2.TextRange.Text = myproject.getShapeText
                    .TextFrame2.MarginLeft = 4
                    .TextFrame2.MarginRight = 4
                Catch ex As Exception

                End Try
                ' nur verändern, wenn es auch veränderbar ist 
                Try

                    If .Adjustments.Count > 0 Then
                        If status = ProjektStatus(0) Then
                            .Adjustments.Item(1) = 0.5
                        Else
                            .Adjustments.Item(1) = 0.25
                        End If
                    End If

                Catch ex As Exception

                End Try


            End If


        End With


    End Sub

    ' ''ur:18.09.2015: wurde in defineShapeAppearance integriert '' ''' <summary>
    ' '' '' ''' definiert das Aussehen eines Shapes im Modus , wenn alles Shapes gezeichnet werden 
    ' '' '' ''' </summary>
    ' '' '' ''' <param name="myproject"></param>
    ' '' '' ''' <param name="projectShape"></param>
    ' '' '' ''' <param name="phasenIndex"></param>
    ' '' '' ''' <remarks></remarks>
    ' '' ''Public Sub defineShapeAppearance1(ByVal myproject As clsProjekt, ByRef projectShape As Excel.Shape, ByVal phasenIndex As Integer)

    ' '' ''    Dim projectColor As Object = Nothing, phaseColor As Object = RGB(255, 255, 255)
    ' '' ''    Dim whiteColor As Object = RGB(255, 255, 255)
    ' '' ''    Dim status As String = ""
    ' '' ''    Dim pMarge As Double
    ' '' ''    Dim pname As String
    ' '' ''    Dim ampel As Integer
    ' '' ''    Dim showAmpel As Boolean = False
    ' '' ''    Dim showResults As Boolean = True
    ' '' ''    Dim myshape As Excel.Shape
    ' '' ''    Dim myphase As clsPhase


    ' '' ''    Try
    ' '' ''        myphase = myproject.getPhase(phasenIndex)


    ' '' ''    Catch ex As Exception
    ' '' ''        Throw New ArgumentException("Phase " & phasenIndex.ToString & _
    ' '' ''                                    " existiert nicht ...")
    ' '' ''    End Try

    ' '' ''    Try

    ' '' ''        myshape = CType(projectShape.GroupItems.Item(phasenIndex), Excel.Shape)

    ' '' ''    Catch ex As Exception
    ' '' ''        myshape = projectShape
    ' '' ''    End Try

    ' '' ''    Try
    ' '' ''        With myproject
    ' '' ''            projectColor = .farbe
    ' '' ''            status = .Status
    ' '' ''            pMarge = .ProjectMarge
    ' '' ''            pname = .name
    ' '' ''            ampel = .ampelStatus
    ' '' ''        End With

    ' '' ''    Catch ex As Exception

    ' '' ''    End Try


    ' '' ''    With myshape


    ' '' ''        Try
    ' '' ''            If status = ProjektStatus(2) Then

    ' '' ''                If phasenIndex = 1 Then
    ' '' ''                    ' beauftragt, aber noch nicht wieder freigegeben ... 

    ' '' ''                    .Glow.Color.RGB = CInt(awinSettings.glowColor)
    ' '' ''                    .Glow.Color.TintAndShade = 0
    ' '' ''                    .Glow.Color.Brightness = 0
    ' '' ''                    .Glow.Transparency = 0.4
    ' '' ''                    .Glow.Radius = 10
    ' '' ''                Else
    ' '' ''                    .Glow.Color.RGB = RGB(255, 255, 255)
    ' '' ''                    .Glow.Transparency = 1.0
    ' '' ''                End If
    ' '' ''            Else
    ' '' ''                .Glow.Color.RGB = RGB(255, 255, 255)
    ' '' ''                .Glow.Transparency = 1.0
    ' '' ''            End If
    ' '' ''        Catch ex As Exception

    ' '' ''        End Try


    ' '' ''        Try
    ' '' ''            With .Line
    ' '' ''                '.Visible = Microsoft.Office.Core.MsoTriState.msoTrue
    ' '' ''                '.Visible = Microsoft.Office.Core.MsoTriState.msoFalse
    ' '' ''                'If pMarge < 0 Then
    ' '' ''                '    .ForeColor.RGB = RGB(255, 0, 0)
    ' '' ''                '    .Weight = 2.0
    ' '' ''                'Else
    ' '' ''                '    .ForeColor.RGB = pcolor
    ' '' ''                'End If
    ' '' ''                If phasenIndex = 1 Then
    ' '' ''                    .ForeColor.RGB = CInt(projectColor)
    ' '' ''                    .Transparency = 0
    ' '' ''                Else
    ' '' ''                    '.ForeColor.RGB = CInt(phaseColor)
    ' '' ''                    .Transparency = 0
    ' '' ''                End If

    ' '' ''            End With
    ' '' ''        Catch ex As Exception

    ' '' ''        End Try

    ' '' ''        Try
    ' '' ''            With .Fill

    ' '' ''                ' geändert wegen Änder
    ' '' ''                If phasenIndex = 1 Then
    ' '' ''                    .ForeColor.RGB = CInt(projectColor)
    ' '' ''                    'Else
    ' '' ''                    '    .ForeColor.RGB = CInt(phaseColor)
    ' '' ''                End If

    ' '' ''                '.ForeColor.TintAndShade = 0
    ' '' ''                '.ForeColor.Brightness = -0.25

    ' '' ''                If roentgenBlick.isOn Then
    ' '' ''                    .Transparency = 0.8
    ' '' ''                Else
    ' '' ''                    .Transparency = 0.0
    ' '' ''                End If

    ' '' ''                If phasenIndex = 1 Then
    ' '' ''                    .Solid()
    ' '' ''                End If


    ' '' ''            End With

    ' '' ''        Catch ex As Exception

    ' '' ''        End Try


    ' '' ''        Try

    ' '' ''            If phasenIndex = 1 Then
    ' '' ''                If roentgenBlick.isOn Then

    ' '' ''                    .TextFrame2.TextRange.Text = ""

    ' '' ''                Else

    ' '' ''                    With .TextFrame2
    ' '' ''                        .VerticalAnchor = MsoVerticalAnchor.msoAnchorMiddle
    ' '' ''                        .HorizontalAnchor = MsoHorizontalAnchor.msoAnchorNone
    ' '' ''                        .WordWrap = MsoTriState.msoFalse
    ' '' ''                    End With

    ' '' ''                    .TextFrame2.TextRange.Text = myproject.getShapeText


    ' '' ''                End If
    ' '' ''            End If


    ' '' ''        Catch ex As Exception

    ' '' ''        End Try


    ' '' ''        Try
    ' '' ''            If .Adjustments.Count > 0 Then

    ' '' ''                If status = ProjektStatus(0) Then
    ' '' ''                    .Adjustments.Item(1) = 0.5
    ' '' ''                Else
    ' '' ''                    .Adjustments.Item(1) = 0.25
    ' '' ''                End If

    ' '' ''            End If
    ' '' ''        Catch ex As Exception

    ' '' ''        End Try



    ' '' ''    End With


    ' '' ''End Sub

    ' ''' <summary>
    ' ''' passt die Shape Darstellung dem veränderten Projekt pname an  
    ' ''' </summary>
    ' ''' <remarks></remarks>
    'Public Sub updateShapeinPlantafel(ByVal pname As String)
    '    Dim eeWasTrue As Boolean = False
    '    Dim suWasTrue As Boolean = False
    '    Dim zeile As Integer, spalte As Integer
    '    Dim laenge As Integer
    '    Dim status As String
    '    Dim top As Double, left As Double, width As Double, height As Double
    '    Dim magicBoardShapes As Excel.Shapes = appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)).shapes
    '    Dim shpelement As Excel.Shape



    '    Dim hproj As New clsProjekt


    '    ' bestimmen der X- bzw. Y Position in der Plantafel 
    '    Try
    '        hproj = ShowProjekte.getProject(pname)
    '        With hproj
    '            zeile = .tfZeile
    '            spalte = .tfspalte
    '            laenge = .Dauer
    '            status = .Status
    '        End With
    '    Catch ex As Exception
    '        Call MsgBox("Fehler in clearProjektinPlantafel (Auslesen XPos, YPos, Dauer) von " & pname)
    '        Exit Sub
    '    End Try

    '    '
    '    ' hier wird in Plan Tafel das entsprechende Shape von der Erscheinung angepasst, ggf auch auf eine neue Zeile gesetzt ... 
    '    '
    '    Dim formerEE As Boolean = appInstance.EnableEvents
    '    Dim formerSU As Boolean = appInstance.ScreenUpdating
    '    appInstance.EnableEvents = False
    '    appInstance.ScreenUpdating = False

    '    With appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT))
    '        Try
    '            shpelement = magicBoardShapes.Item(pname)
    '            Dim myCollection As New Collection
    '            myCollection.Add(pname)
    '            zeile = findeMagicBoardPosition(myCollection, pname, zeile, spalte, laenge)

    '            ' jetzt ist eine passende Position gefunden ... die zugehörigen Shape Koordinaten werden berechnet 
    '            With hproj
    '                .tfZeile = zeile
    '                .CalculateShapeCoord(top, left, width, height)
    '            End With

    '            With shpelement
    '                .Top = top
    '                .Left = left
    '                .Width = width
    '                .Height = height
    '            End With

    '        Catch ex As Exception
    '            appInstance.EnableEvents = formerEE
    '            appInstance.ScreenUpdating = formerSU
    '            Throw New ArgumentException("updateProjektinPlantafel: kein Shape für Projekt " & pname & " gefunden")
    '        End Try


    '    End With

    '    appInstance.EnableEvents = formerEE
    '    appInstance.ScreenUpdating = formerSU


    'End Sub


    ''' <summary>
    ''' löscht die zeicherische Darstellung des Projektes auf der Plantafel 
    ''' </summary>
    ''' <remarks></remarks>
    Public Sub clearProjektinPlantafel(ByVal pname As String)
        Dim eeWasTrue As Boolean = False
        Dim suWasTrue As Boolean = False
        'Dim XPos As Integer, YPos As Integer
        'Dim laenge As Integer
        'Dim tmpshapes As Excel.Shapes = appInstance.ActiveSheet.shapes
        Dim tmpshapes As Excel.Shapes = CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Shapes
        Dim shpelement As Excel.Shape

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False


        'Dim formerSU As Boolean = appInstance.ScreenUpdating
        'appInstance.ScreenUpdating = False

        ' Lösche das Shape Element
        Try
            shpelement = tmpshapes.Item(pname)
            With shpelement
                projectboardShapes.remove(shpelement)
            End With
        Catch ex As Exception

        End Try

        Try

            If ShowProjekte.contains(pname) Then
                Dim hproj As clsProjekt = ShowProjekte.getProject(pname)
                Dim shpuid As String = hproj.shpUID
                hproj.shpUID = ""
                ShowProjekte.shpListe.Remove(shpuid)
            End If

        Catch ex As Exception

        End Try



        appInstance.EnableEvents = formerEE
        'appInstance.ScreenUpdating = formerSU


    End Sub
    ''' <summary>
    ''' zeichnet den Pfeil, der anzeigt, um wieviel ein Projekt bei Optimierung verschoben werden würde
    ''' </summary>
    ''' <param name="pname"></param>
    ''' <remarks></remarks>
    Public Sub ZeichneMoveLineOfProjekt(ByRef pname As String)

        Dim start As Integer
        Dim laenge As Integer
        Dim pcolor As Integer, schriftfarbe As Object, fillColor As Integer, borderColor As Integer
        Dim schriftgroesse As Integer
        Dim zeilenOffset As Integer = 1
        Dim spaltenOffset As Integer = 0
        Dim hproj As clsProjekt
        Dim leftDrawn As Boolean
        Dim moveLength As Integer
        Dim tfz As Integer, tfs As Integer
        Dim top As Double, left As Double, width As Double, height As Double

        Dim straightLine As core.MsoConnectorType = core.MsoConnectorType.msoConnectorStraight


        hproj = ShowProjekte.getProject(pname)
        With hproj
            laenge = .anzahlRasterElemente
            start = .Start + .StartOffset
            moveLength = .StartOffset
            pcolor = CInt(.farbe)
            schriftfarbe = .Schriftfarbe
            schriftgroesse = .Schrift
            tfz = .tfZeile
            tfs = .tfspalte
        End With

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False


        If moveLength <> 0 Then
            height = 0.4 * boxHeight

            If moveLength < 0 Then
                leftDrawn = True
                left = (tfs - 1 + 0.5) * boxWidth + moveLength * boxWidth ' movelength ist negativ , deshalb "+"
                width = moveLength * boxWidth * (-1)
                top = topOfMagicBoard + (tfz - 1 + 0.75) * boxHeight
            Else
                leftDrawn = False
                left = (tfs + laenge - 1 - 0.5) * boxWidth
                top = topOfMagicBoard + (tfz - 1 + 0.25) * boxHeight
                width = moveLength * boxWidth
            End If

            Dim shp As Excel.Shape
            With appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT))


                fillColor = RGB(255, 255, 255)
                borderColor = pcolor

                If leftDrawn Then
                    shp = CType(.Shapes, Excel.Shapes).AddShape(Type:=Microsoft.Office.Core.MsoAutoShapeType.msoShapeLeftArrow,
                                Left:=CSng(left), Top:=CSng(top), Width:=CSng(width), Height:=CSng(height))

                Else
                    shp = CType(.Shapes, Excel.Shapes).AddShape(Type:=Microsoft.Office.Core.MsoAutoShapeType.msoShapeRightArrow,
                                Left:=CSng(left), Top:=CSng(top), Width:=CSng(width), Height:=CSng(height))
                End If

                ' jetzt wird der Pfeil gezeichnet




                With shp
                    With .Fill
                        .ForeColor.RGB = fillColor
                        .Transparency = 0.0
                    End With
                    With .Line
                        '.Visible = True
                        .Weight = 1.5
                        .ForeColor.RGB = borderColor
                        .Transparency = 0
                    End With

                End With



            End With



        End If

        appInstance.EnableEvents = formerEE

    End Sub

    Public Sub aktualisiereZeilenNrInProjekt(ByVal zeile As Integer, ByVal anzahl As Integer)

        For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste
            With kvp.Value
                If .tfZeile >= zeile Then
                    .tfZeile = .tfZeile + anzahl
                End If
            End With
        Next kvp

    End Sub

    Public Sub visualisiereTeilErgebnis(ByVal pname As String)

        appInstance.ScreenUpdating = False
        Call diagramsVisible(False)
        'Call ZeichneProjektinPlanTafel(pname)
        'Call ZeichneMoveLineOfProjekt(pname)
        Call awinNeuZeichnenDiagramme(1)
        Call diagramsVisible(True)
        appInstance.ScreenUpdating = True

    End Sub


    Public Sub visualisiereErgebnis()

        appInstance.ScreenUpdating = False
        Call diagramsVisible(False)
        'Call awinZeichnePlanTafel()
        Call awinNeuZeichnenDiagramme(1)
        Call diagramsVisible(True)
        appInstance.ScreenUpdating = True
    End Sub


    Public Sub insertZeile(ByVal zeilenNr As Integer)

        With appInstance.ActiveSheet
            .Rows(zeilenNr).Insert()
            .Rows(zeilenNr).Interior.ColorIndex = -4142
            .Rows(900).delete()
            Call aktualisiereZeilenNrInProjekt(zeilenNr, 1)
        End With
    End Sub

    ''' <summary>
    ''' selektiert in der Projekt Tafel das Projekt mit Namen pname
    ''' </summary>
    ''' <param name="pname"></param>
    ''' <remarks></remarks>
    Public Sub awinSelectProjectiST(ByRef pname As String, ByVal calledFromPf As Boolean)
        Dim hproj As clsProjekt
        Dim tfz As Integer, tfs As Integer
        Dim projektfarbe As Object
        Dim schriftfarbe As Object
        Dim realname As String = ""
        Dim tmparray() As String
        Dim allShapes As Excel.Shapes
        Dim selShape As Excel.Shape
        Dim shpUID As String


        Try
            allShapes = CType(appInstance.ActiveSheet, Excel.Worksheet).Shapes
        Catch ex As Exception
            allShapes = Nothing
        End Try

        If Not allShapes Is Nothing Then


            If calledFromPf Then
                ' der Name muss jetzt um das (xy.z%) bereinigt werden
                tmparray = pname.Split(New Char() {CChar("(")}, 10)
                Dim i As Integer
                For i = 0 To UBound(tmparray) - 1
                    realname = realname & tmparray(i)
                Next
                pname = realname.Trim
            End If

            If ShowProjekte.contains(pname) Then
                hproj = ShowProjekte.getProject(pname)
                With hproj
                    shpUID = .shpUID
                    'projektLaenge = .Dauer
                    projektfarbe = .farbe
                    schriftfarbe = .Schriftfarbe
                    tfz = .tfZeile
                    tfs = .tfspalte
                End With


                appInstance.EnableEvents = False

                Try
                    selShape = allShapes.Item(pname)
                    selShape.Select()
                Catch ex As Exception

                End Try



                appInstance.EnableEvents = True



            Else
                Call MsgBox("Projekt " & pname & " wurde nicht gefunden")
            End If


        End If
    End Sub

    Public Sub awinSelectProjectiPF(ByRef pname As String)
        Dim chtobj As xlNS.ChartObject, rightObject As xlNS.ChartObject = Nothing
        Dim found As Boolean = False
        Dim diagramTitle As String = "strategischer Fit, Risiko & Marge"
        Dim ptNr As Integer
        Dim chartPT As xlNS.Point
        Dim anzPts As Integer

        ' das kann hier auskommentiert werden, da ab jetzt die Labels immer angezeigt werden 
        ' evtl wird es später wieder reingenommen ... 


        Try
            anzPts = UBound(PfChartBubbleNames)
        Catch ex As Exception
            Exit Sub
        End Try

        If anzPts >= 0 Then
            With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
                For Each chtobj In CType(.ChartObjects, Excel.ChartObjects)
                    If chtobj.Chart.ChartTitle.Text = diagramTitle Then
                        found = True
                        rightObject = chtobj
                    End If
                Next
            End With

            ' jetzt muss bestimmt werden, die "wievielte Bubble " pname ist ...
            If found Then
                ptNr = 1
                While PfChartBubbleNames(ptNr - 1) <> pname And ptNr <= anzPts
                    ptNr = ptNr + 1
                End While

                If ptNr <= anzPts Then

                    Dim formerUpdate As Boolean = appInstance.ScreenUpdating
                    appInstance.ScreenUpdating = False

                    Try
                        With rightObject.Chart.SeriesCollection(1)
                            .ApplyDataLabels(Type:=Excel.XlDataLabelsType.xlDataLabelsShowNone)
                            chartPT = CType(.points(ptNr), Excel.Point)
                            chartPT.ApplyDataLabels(Type:=Excel.XlDataLabelsType.xlDataLabelsShowLabel)
                            chartPT.DataLabel.Text = pname
                        End With
                    Catch ex As Exception

                    End Try


                    appInstance.ScreenUpdating = formerUpdate
                End If

            End If
        End If
    End Sub



    ' ''' <summary>
    ' ''' speichert alle Projekte, die aktuell in Show- bzw NoShow sind
    ' ''' </summary>
    ' ''' <remarks></remarks>
    'Public Sub awinExportAllProjects()
    '    '
    '    Dim dateinameQ As String, dateinameZ As String


    '    appInstance.ScreenUpdating = False
    '    Try
    '        ' hier muss jetzt das File Projekt Detail aufgemacht werden ...
    '        appInstance.Workbooks.Open(awinPath & projektAustausch)


    '        For Each kvp As KeyValuePair(Of String, clsProjekt) In AlleProjekte.liste

    '            Try

    '                Call awinExportProject(kvp.Value)

    '            Catch ex As Exception

    '            End Try


    '        Next kvp

    '        For Each kvp As KeyValuePair(Of String, clsProjekt) In DeletedProjekte.Liste
    '            dateinameQ = awinPath & projektFilesOrdner & "\" & kvp.Key & ".xlsm"
    '            dateinameZ = awinPath & deletedFilesOrdner & "\" & kvp.Key & ".xlsm"
    '            Try
    '                My.Computer.FileSystem.MoveFile(dateinameQ, dateinameZ, True)
    '            Catch ex As Exception

    '            End Try


    '        Next kvp

    '    Catch ex As Exception
    '        Call MsgBox(ex.Message)
    '        Throw New ArgumentException("Abbruch - es konnten nicht ale Projekte gesichert werden ...")
    '        Exit Sub
    '    End Try

    '    appInstance.ActiveWorkbook.Close(SaveChanges:=False)  'UR:06.05.2014 PROJEKTSteckbrief darf nicht geändert werden
    '    appInstance.ScreenUpdating = True

    'End Sub


    ''' <summary>
    ''' Exportiert die Daten eines Projektes in einen Projekt-Steckbrief, ohne Berücksichtigung der Hierarchie
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <remarks></remarks>
    Public Sub awinExportProject(hproj As clsProjekt)

        Dim fileName As String
        Dim rng As Excel.Range, destinationRange As Excel.Range
        Dim zeile As Integer, spalte As Integer
        Dim rowOffset As Integer, columnOffset As Integer
        Dim delimiter As String = "."

        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False


        zeile = 1
        spalte = 1

        ' Dateiname des Projectfiles '
        ' ur: 14.01.2015: Dateiname gleich dem Shape-Namen einschließlich VariantenNamen

        fileName = hproj.getShapeText & ".xlsx"

        'ur: 13.01.2015:  aus "fileName" werden die illegale Sonderzeichen eliminiert
        fileName = cleanFileName(fileName)

        ' fileName wird nun ergänzt mit dem passenden Pfad
        'fileName = awinPath & projektFilesOrdner & "\" & fileName
        fileName = exportOrdnerNames(PTImpExp.visbo) & "\" & fileName


        ' -------------------------------------------------
        ' hier werden die einzelnen Stamm-Daten in das entsprechende File geschrieben 
        ' -------------------------------------------------
        Try
            With appInstance.ActiveWorkbook.Worksheets("Stammdaten")

                .Unprotect(Password:="x")       ' Blattschutz aufheben

                ' Projekt-Name

                .range("Projekt_Name").value = hproj.name
                .range("Projekt_Name").interior.color = hproj.farbe
                .range("Projekt_Name").font.size = hproj.Schrift
                .range("Projekt_Name").font.color = hproj.Schriftfarbe


                ' Start

                .range("StartDatum").value = hproj.startDate

                ' Ende

                .range("EndeDatum").value = hproj.startDate.AddDays(hproj.dauerInDays - 1)


                'Projektleiter

                .range("Projektleiter").value = hproj.leadPerson

                ' Budget
                rng = CType(.range("Budget"), Excel.Range)
                .range("Budget").value = hproj.Erloes.ToString("#####.#")
                Try

                Catch ex As Exception

                End Try

                'Kurzbeschreibung'

                .range("ProjektBeschreibung").value = hproj.description

                ' Ampel-Farbe

                .range("Bewertung").interior.color = awinSettings.AmpelNichtBewertet
                .range("Bewertung").value = hproj.ampelStatus


                ' Ampel-Bewertung 

                .range("BewertgErläuterung").value = hproj.ampelErlaeuterung


                '' Blattschutz setzen
                '.Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True, Contents:=True, Scenarios:=True)

            End With
        Catch ex As Exception
            '' Blattschutz setzen
            'appInstance.Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True, Contents:=True, Scenarios:=True)

            appInstance.EnableEvents = formerEE
            Throw New ArgumentException("Fehler in awinExportProject, Schreiben Stammdaten")
        End Try

        ' --------------------------------------------------
        ' jetzt werden die Ressourcen Bedarfe weggeschrieben 

        ' --------------------------------------------------

        Try
            With CType(appInstance.ActiveWorkbook.Worksheets("Ressourcen"), Excel.Worksheet)

                Dim tbl As Excel.Range

                .Unprotect(Password:="x")       ' Blattschutz aufheben

                zeile = 1
                spalte = 1

                ' die Monate eintragen 

                If awinSettings.zeitEinheit = "PM" Then

                    ' Dim htxt As String = hproj.startDate.ToShortDateString

                    ' Zeilen und Spalten-Offset für die Zeitleiste herausfinden
                    tbl = .Range("Zeitleiste")
                    rowOffset = tbl.Row         ' Reihen-Offset für die Zeitleiste
                    columnOffset = tbl.Column   ' Spalten-Offset für die Zeitleiste

                    ' Monat und Jahreszahl in die ersten beiden Felder der Zeitleiste eintragen'
                    .Range("Zeitleiste").Cells(columnOffset).value = "= StartDatum"

                    .Range("Zeitleiste").Cells(columnOffset + 1).value = "= EDATUM(D" & rowOffset & ",1"
                    .Range("Zeitleiste").Cells(columnOffset + 2).value = "= EDATUM(E" & rowOffset & ",1"

                    ' die ersten beiden Felder der Zeitleiste formatieren
                    rng = .Range(.Cells(rowOffset, columnOffset + 1), .Cells(rowOffset, columnOffset + 2))
                    rng.NumberFormat = "mmm-yy"
                    ' Die restliche Zeitleiste  formatieren
                    'rng = .range(.cells(startZeile, spalte), .cells(endZeile, spalte))
                    destinationRange = .Range(.Cells(rowOffset, columnOffset + 1), .Cells(rowOffset, columnOffset + 200))
                    With destinationRange
                        .HorizontalAlignment = Excel.XlHAlign.xlHAlignCenter
                        .VerticalAlignment = Excel.XlVAlign.xlVAlignBottom
                        .NumberFormat = "mmm-yy"
                        .WrapText = False
                        .Orientation = 90
                        .AddIndent = False
                        .IndentLevel = 0
                        .ShrinkToFit = False
                        .ReadingOrder = Excel.Constants.xlContext
                        .MergeCells = False
                        .ColumnWidth = 4
                    End With

                    ' die Zeitleiste mit den Monatsangaben automatisch befüllen
                    rng.AutoFill(Destination:=destinationRange, Type:=xlNS.XlAutoFillType.xlFillDefault)


                ElseIf awinSettings.zeitEinheit = "PW" Then
                ElseIf awinSettings.zeitEinheit = "PT" Then

                End If

                ' hier über alle Phasen ... 
                Dim cphase As clsPhase
                Dim p As Integer
                Dim phasenFarbe As Object
                Dim values() As Double
                Dim ErgebnisListe As New Collection
                Dim anzahlItems As Integer
                Dim r As Integer
                Dim d As Integer
                Dim itemNameID As String
                Dim dimension As Integer

                ' evtl hier vorher prüfen, ob es eine Phase mit Name hproj.name oder hproj.vorlagenName gibt; wenn nein , 
                ' muss hier der Projektname mit farbiger Gesamtdauer stehen 

                rowOffset = 1
                columnOffset = 1

                If hproj.CountPhases = 0 Then
                    ' Projekt-Name eintragen, Dauer einfärben, 28.2. genaues Start- und Endedatum in Kommentar eintragen

                    .Range("Phasen_des_Projekts").Cells(rowOffset, columnOffset).value = hproj.name
                    .Range("Phasen_des_Projekts").Cells(rowOffset, columnOffset).Interior.Color = hproj.farbe
                    rng = CType(.Range("Zeitmatrix")(.Cells(rowOffset, columnOffset), .Cells(rowOffset, columnOffset + hproj.anzahlRasterElemente - 1)), Excel.Range)
                    rng.Interior.Color = hproj.farbe
                    .Cells(rowOffset, columnOffset).AddComment()
                    With .Cells(rowOffset, columnOffset).Comment
                        .Visible = False
                        .Text(Text:="Start:" & Chr(10) & hproj.startDate)
                        .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                    End With
                    .Cells(rowOffset, columnOffset + hproj.anzahlRasterElemente - 1).AddComment()
                    With .Cells(rowOffset, columnOffset + hproj.anzahlRasterElemente - 1).Comment
                        .Visible = False
                        .Text(Text:="Ende:" & Chr(10) & hproj.endeDate)
                        .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                    End With
                    rowOffset = rowOffset + 1
                End If

                For p = 1 To hproj.CountPhases
                    cphase = hproj.getPhase(p)

                    ' Phasen-Name eintragen, Dauer einfärben
                    itemNameID = cphase.nameID

                    Try
                        phasenFarbe = cphase.farbe
                    Catch ex As Exception
                        phasenFarbe = hproj.farbe
                    End Try

                    If itemNameID = rootPhaseName Then
                        ' Projekt-Name eintragen, Dauer einfärben
                        .Range("Phasen_des_Projekts").Cells(rowOffset, columnOffset).value = elemNameOfElemID(rootPhaseName)
                        .Range("Phasen_des_Projekts").Cells(rowOffset, columnOffset).Interior.Color = hproj.farbe
                        For d = 1 To hproj.anzahlRasterElemente
                            .Range("Zeitmatrix").Cells(rowOffset, columnOffset + d - 1).Interior.Color = hproj.farbe
                        Next d
                        ' Startdatum in Kommentar eintragen
                        .Range("Zeitmatrix").Cells(rowOffset, columnOffset).AddComment()
                        With .Range("Zeitmatrix").Cells(rowOffset, columnOffset).Comment
                            .Visible = False
                            .Text(Text:="Start:" & Chr(10) & hproj.startDate)
                            .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                        End With
                        .Range("Zeitmatrix").Cells(rowOffset, columnOffset + hproj.anzahlRasterElemente - 1).AddComment()
                        With .Range("Zeitmatrix").Cells(rowOffset, columnOffset + hproj.anzahlRasterElemente - 1).Comment
                            .Visible = False
                            .Text(Text:="Ende:" & Chr(10) & hproj.endeDate)
                            .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                        End With


                        d = CInt(appInstance.WorksheetFunction.CountA(.Range("Phasen_des_Projekts")))

                    Else
                        .Range("Phasen_des_Projekts").Cells(rowOffset, columnOffset).value = elemNameOfElemID(itemNameID)
                        For d = 1 To cphase.relEnde - cphase.relStart + 1
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart + d - 1).Interior.Color = phasenFarbe
                        Next d

                        ' Kommentar mit Start- und Endedatum eintragen
                        If cphase.relStart = cphase.relEnde Then
                            ' cphase ist nur ein Kästchen breit, d.h. Start-und EndeDatum müssen in einem Kommentar stehen
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart).AddComment()
                            With .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart).Comment
                                .Visible = False
                                .Text(Text:="Start:" & Chr(10) & cphase.getStartDate & Chr(10) & "Ende:" & Chr(10) & cphase.getEndDate)
                            End With
                        Else
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart).AddComment()
                            With .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart).Comment
                                .Visible = False
                                .Text(Text:="Start:" & Chr(10) & cphase.getStartDate)
                                .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                            End With
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relEnde).AddComment()
                            With .Range("Zeitmatrix").Cells(rowOffset, cphase.relEnde).Comment
                                .Visible = False
                                .Text(Text:="Ende:" & Chr(10) & cphase.getEndDate)
                                .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                            End With
                        End If
                        ' ende Kommentar eintragen in Ressourcen
                    End If

                    rowOffset = rowOffset + 1



                    anzahlItems = cphase.countRoles

                    Dim itemName As String
                    ' jetzt werden Rollen geschrieben 
                    For r = 1 To anzahlItems
                        itemName = cphase.getRole(r).name
                        dimension = cphase.getRole(r).getDimension
                        'ReDim values(cphase.relEnde - cphase.relStart)
                        ReDim values(dimension)
                        values = cphase.getRole(r).Xwerte
                        .Range("RollenKosten_des_Projekts").Cells(rowOffset, columnOffset).value = itemName

                        For d = 1 To dimension + 1
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart + d - 1).Interior.Color = phasenFarbe
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart + d - 1).Value = values(d - 1)
                        Next d
                        rowOffset = rowOffset + 1
                    Next r


                    ' jetzt werden Kosten geschrieben 

                    anzahlItems = cphase.countCosts

                    For k = 1 To anzahlItems
                        itemName = cphase.getCost(k).name
                        dimension = cphase.getCost(k).getDimension
                        ReDim values(dimension)
                        values = cphase.getCost(k).Xwerte
                        .Range("RollenKosten_des_Projekts").Cells(rowOffset, columnOffset).value = itemName
                        For d = 1 To dimension + 1
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart + d - 1).Interior.Color = phasenFarbe
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart + d - 1).Value = values(d - 1)
                        Next d
                        rowOffset = rowOffset + 1
                    Next
                    rowOffset = rowOffset + 1
                Next p

                '' Blattschutz setzen
                '.Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True, Contents:=True, Scenarios:=True)

            End With
        Catch ex As Exception
            ' Blattschutz setzen
            appInstance.ActiveWorkbook.Worksheets("Ressourcen").Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True, Contents:=True, Scenarios:=True)

            appInstance.EnableEvents = formerEE
            Throw New ArgumentException("Fehler in awinExportProject, Schreiben Ressourcen")
        End Try

        ' --------------------------------------------------
        ' jetzt werden die Settings in das unsichtbare Worksheet ("Settings") geschrieben 
        '
        Try

            With appInstance.ActiveWorkbook.Worksheets("Settings")

                .Unprotect(Password:="x")       ' Blattschutz aufheben

                zeile = 3
                Dim startZeile As Integer, endZeile As Integer
                Dim startRollen As Integer, startKosten As Integer
                spalte = 1
                Dim anzZeilen As Integer = 0
                rng = CType(.Range(.Cells(zeile, spalte), .Cells(zeile + 2000, spalte + 120)), Excel.Range)
                rng.Clear()

                ' ----------------------------------------- 
                ' Schreiben der Projektvorlagen
                '
                .cells(zeile, spalte).value = "Projekt-Vorlagen"
                .cells(zeile, spalte).interior.color = RGB(180, 180, 180)

                zeile = zeile + 1
                startZeile = zeile

                For Each kvp As KeyValuePair(Of String, clsProjektvorlage) In Projektvorlagen.Liste
                    .cells(zeile, spalte).value = kvp.Key
                    zeile = zeile + 1
                Next
                endZeile = zeile - 1

                If endZeile >= startZeile Then

                    If endZeile = startZeile Then
                        rng = CType(.cells(startZeile, spalte), Excel.Range)
                    Else
                        rng = CType(.range(.cells(startZeile, spalte), .cells(endZeile, spalte)), Excel.Range)
                    End If

                    appInstance.ActiveWorkbook.Names.Add(Name:="ProjektVorlagen", RefersTo:=rng)

                End If

                ' Schreiben des Delimiters
                .cells(zeile, spalte).value = delimiter
                zeile = zeile + 1

                ' ----------------------------------------- 
                ' Schreiben der Phasen
                '
                .cells(zeile, spalte).value = "Phasen"
                .cells(zeile, spalte).interior.color = RGB(180, 180, 180)

                zeile = zeile + 1
                startZeile = zeile

                For i = 1 To PhaseDefinitions.Count
                    .cells(zeile, spalte).value = PhaseDefinitions.getPhaseDef(i).name
                    .cells(zeile, spalte + 1).interior.color = PhaseDefinitions.getPhaseDef(i).farbe
                    zeile = zeile + 1
                Next

                endZeile = zeile - 1

                If endZeile >= startZeile Then

                    If endZeile = startZeile Then
                        rng = CType(.cells(startZeile, spalte), Excel.Range)
                    Else
                        rng = CType(.range(.cells(startZeile, spalte), .cells(endZeile, spalte)), Excel.Range)
                    End If
                    appInstance.ActiveWorkbook.Names.Add(Name:="Phasen", RefersTo:=rng)

                End If

                ' Schreiben des Delimiters
                .cells(zeile, spalte).value = delimiter
                zeile = zeile + 1


                ' ----------------------------------------- 
                ' Schreiben der Rollen und Kostenarten
                '

                .cells(zeile, spalte).value = "Rollen/Kostenarten"
                .cells(zeile, spalte).interior.color = RGB(180, 180, 180)

                zeile = zeile + 1
                startZeile = zeile
                startRollen = zeile

                For i = 1 To RoleDefinitions.Count
                    .cells(zeile, spalte).value = RoleDefinitions.getRoledef(i).name
                    zeile = zeile + 1
                Next

                endZeile = zeile - 1

                If endZeile >= startZeile Then

                    If endZeile = startZeile Then
                        rng = CType(.cells(startZeile, spalte), Excel.Range)
                    Else
                        rng = CType(.range(.cells(startZeile, spalte), .cells(endZeile, spalte)), Excel.Range)
                    End If
                    appInstance.ActiveWorkbook.Names.Add(Name:="Rollen", RefersTo:=rng)

                End If


                startKosten = zeile

                For i = 1 To CostDefinitions.Count - 1
                    ' die Personalkosten sind die letzte Kostenart, wird nicht mit aufgenommen, da sie 
                    ' automatisch berücksichtigt wird 
                    .cells(zeile, spalte).value = CostDefinitions.getCostdef(i).name
                    zeile = zeile + 1
                Next

                endZeile = zeile - 1
                If endZeile >= startKosten Then
                    rng = CType(.range(.cells(startKosten, spalte), .cells(endZeile, spalte)), Excel.Range)
                    appInstance.ActiveWorkbook.Names.Add(Name:="Kosten", RefersTo:=rng)

                End If

                If endZeile >= startZeile Then
                    rng = CType(.range(.cells(startZeile, spalte), .cells(endZeile, spalte)), Excel.Range)
                    appInstance.ActiveWorkbook.Names.Add(Name:="Rollen_Kostenarten", RefersTo:=rng)

                End If

                ' Schreiben des Delimiters
                .cells(zeile, spalte).value = delimiter
                zeile = zeile + 1


                ' -------------------------------------------
                ' Schreiben der Ampel-Farben 
                '


                .cells(zeile, spalte).value = "Ampel-Farben"
                .cells(zeile, spalte).interior.color = RGB(180, 180, 180)

                zeile = zeile + 1
                startZeile = zeile
                For i = 0 To 3
                    Select Case i
                        Case 0
                            .cells(zeile, spalte).value = "Ampel nicht bewertet"
                            .cells(zeile, spalte).interior.color = awinSettings.AmpelNichtBewertet
                        Case 1
                            .cells(zeile, spalte).value = "Ampel Grün"
                            .cells(zeile, spalte).interior.color = awinSettings.AmpelGruen
                        Case 2
                            .cells(zeile, spalte).value = "Ampel Gelb"
                            .cells(zeile, spalte).interior.color = awinSettings.AmpelGelb
                        Case 3
                            .cells(zeile, spalte).value = "Ampel Rot"
                            .cells(zeile, spalte).interior.color = awinSettings.AmpelRot
                    End Select
                    zeile = zeile + 1
                Next

                endZeile = zeile - 1

                If endZeile >= startZeile Then
                    rng = CType(.range(.cells(startZeile, spalte), .cells(endZeile, spalte)), Excel.Range)
                    appInstance.ActiveWorkbook.Names.Add(Name:="AmpelFarben", RefersTo:=rng)

                End If

                ' Schreiben des Delimiters
                .cells(zeile, spalte).value = delimiter
                zeile = zeile + 1


                ' ----------------------------------------- 
                ' Unsichtbarmachen des Tabellenblattes
                '

                .Visible = Excel.XlSheetVisibility.xlSheetHidden

            End With

        Catch ex As Exception
            appInstance.EnableEvents = formerEE
            Throw New ArgumentException("Fehler in awinExportProject, Schreiben Settings")
        End Try

        ' ----------------------------------------------
        ' jetzt werden die Termine weggeschrieben ....

        Try
            With appInstance.ActiveWorkbook.Worksheets("Termine")


                .Unprotect(Password:="x")       ' Blattschutz aufheben

                zeile = 1
                spalte = 1

            End With
        Catch ex As Exception
            With appInstance.ActiveWorkbook.Worksheets.Add
                .name = "Termine"
                ' Tabelle ErgebnTabelle muss hier eigentlich erzeugt werden
                appInstance.EnableEvents = formerEE
                Throw New ArgumentException("Fehler in awinExportProject, Schreiben Termine, Worksheet Termine existiert nicht")
            End With
        End Try

        ' --------------------------------------
        ' Worksheet Termine existriert jetzt ...

        With CType(appInstance.ActiveWorkbook.Worksheets("Termine"), Excel.Worksheet)

            .Unprotect(Password:="x")       ' Blattschutz aufheben

            Dim cphase As New clsPhase(hproj)
            Dim phaseName As String
            Dim r As Integer
            Dim cResult As New clsMeilenstein(parent:=cphase)
            Dim cBewertung As clsBewertung
            Dim phaseStart As Date
            Dim phaseEnde As Date
            Dim tbl As Excel.Range
            Dim tablename As String

            tablename = .ListObjects("ErgebnTabelle").Name
            tbl = .ListObjects("ErgebnTabelle").Range
            rowOffset = tbl.Row
            columnOffset = tbl.Column


            For p = 1 To hproj.CountPhases
                cphase = hproj.getPhase(p)

                If awinSettings.zeitEinheit = "PM" Then
                    phaseStart = hproj.startDate.AddDays(cphase.startOffsetinDays)
                    phaseEnde = hproj.startDate.AddDays(cphase.startOffsetinDays + cphase.dauerInDays - 1)
                ElseIf awinSettings.zeitEinheit = "PW" Then
                    phaseStart = hproj.startDate.AddDays((cphase.relStart - 1) * 7)
                    phaseEnde = hproj.startDate.AddDays((cphase.relEnde - 1) * 7)
                ElseIf awinSettings.zeitEinheit = "PT" Then
                    phaseStart = hproj.startDate.AddDays(cphase.relStart - 1)
                    phaseEnde = hproj.startDate.AddDays(cphase.relEnde - 1)
                End If


                phaseName = cphase.name

                ' hier muss die Phase geschrieben werden
                .Cells(rowOffset + zeile, columnOffset).value = zeile
                .Cells(rowOffset + zeile, columnOffset + 1).value = phaseName
                .Cells(rowOffset + zeile, columnOffset + 2).value = ""
                .Cells(rowOffset + zeile, columnOffset + 3).value = phaseStart
                .Cells(rowOffset + zeile, columnOffset + 4).value = phaseEnde
                '.Cells(rowOffset + zeile, columnOffset + 5).value = " "
                .Cells(rowOffset + zeile, columnOffset + 5).value = "0"
                .Cells(rowOffset + zeile, columnOffset + 5).interior.color = awinSettings.AmpelNichtBewertet
                .Cells(rowOffset + zeile, columnOffset + 6).value = " "

                zeile = zeile + 1

                For r = 1 To cphase.countMilestones
                    cResult = cphase.getMilestone(r)

                    cBewertung = cResult.getBewertung(1)
                    'Try
                    '    cBewertung = cResult.getBewertung(1)
                    'Catch ex As Exception
                    '    cBewertung = New clsBewertung
                    'End Try
                    ' --------------------------------------------------------------------------------
                    ' Termine müssen in Tabelle eingetragen werden
                    '----------------------------------------------------------------------------------

                    .Cells(rowOffset + zeile, columnOffset).value = zeile
                    .Cells(rowOffset + zeile, columnOffset + 1).value = cResult.name
                    With CType(.Cells(rowOffset + zeile, columnOffset + 1), Excel.Range)
                        .IndentLevel = 2
                        .HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                    End With
                    .Cells(rowOffset + zeile, columnOffset + 2).value = phaseName
                    .Cells(rowOffset + zeile, columnOffset + 3).value = ""
                    .Cells(rowOffset + zeile, columnOffset + 4).value = cResult.getDate
                    ' .Cells(rowOffset + zeile, columnOffset + 4).value = cResult.verantwortlich
                    .Cells(rowOffset + zeile, columnOffset + 5).value = cBewertung.colorIndex
                    .Cells(rowOffset + zeile, columnOffset + 5).interior.color = cBewertung.color
                    ' Zelle für Beschreibung in der Höhe anpassen, autom. Zeilenumbruch
                    .Cells(rowOffset + zeile, columnOffset + 6).value = cBewertung.description
                    .Cells(rowOffset + zeile, columnOffset + 6).Rows.Autofit()
                    .Cells(rowOffset + zeile, columnOffset + 6).WrapText = True

                    zeile = zeile + 1
                Next

            Next

            '' Blattschutz setzen
            '.Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True, Contents:=True, Scenarios:=True)

        End With


        ' ----------------------------------------------
        ' jetzt werden die Attribute weggeschrieben ....

        Try
            With CType(appInstance.ActiveWorkbook.Worksheets("Attribute"), Excel.Worksheet)

                .Unprotect(Password:="x")       ' Blattschutz aufheben


                ' Projekt-Typ

                .Range("Projekt_Typ").Value = hproj.VorlagenName
                rng = .Range("Projekt_Typ")
                With rng
                    .HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                    .IndentLevel = 1
                    .WrapText = False
                End With

                ' Status

                .Range("Status").Value = hproj.Status
                rng = .Range("Status")
                With rng
                    .HorizontalAlignment = Excel.XlHAlign.xlHAlignRight
                    .IndentLevel = 1
                    .WrapText = False
                End With

                ' Business_Unit

                .Range("Business_Unit").Value = hproj.businessUnit
                rng = .Range("Business_Unit")
                With rng
                    .HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                    .IndentLevel = 1
                    .WrapText = False
                End With

                ' Strategischer Fit

                .Range("Strategischer_Fit").Value = hproj.StrategicFit
                rng = .Range("Strategischer_Fit")
                With rng
                    .HorizontalAlignment = Excel.XlHAlign.xlHAlignRight
                    .IndentLevel = 1
                    .WrapText = False
                End With

                ' Risiko

                .Range("Risiko").Value = hproj.Risiko
                rng = .Range("Risiko")
                With rng
                    .HorizontalAlignment = Excel.XlHAlign.xlHAlignRight
                    .IndentLevel = 1
                    .WrapText = False
                End With

                ' ur: 13.01.2015: Varianten_Name wird hier in das Tabellenblatt Attribute des Projekt-Steckbriefes eingetragen

                If Not IsNothing(hproj.variantName) And hproj.variantName <> "" Then

                    .Range("Variant_Name").Value = hproj.variantName
                    rng = .Range("Variant_Name")
                    With rng
                        .HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                        .IndentLevel = 1
                        .WrapText = False
                    End With

                End If

                '' Blattschutz setzen
                '.Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True, Contents:=True, Scenarios:=True)

            End With
        Catch ex As Exception
            '' Blattschutz setzen
            'appInstance.ActiveWorkbook.Worksheets("Attribute").Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True, Contents:=True, Scenarios:=True)
            appInstance.EnableEvents = formerEE
            Throw New ArgumentException("Fehler in awinExportProject, Schreiben Attribute")
        End Try


        Try

            My.Computer.FileSystem.DeleteFile(fileName)
        Catch ex As Exception

        End Try

        Try

            appInstance.ActiveWorkbook.SaveAs(fileName,
                                          ConflictResolution:=xlNS.XlSaveConflictResolution.xlLocalSessionChanges
                                          )

        Catch ex As Exception
            appInstance.EnableEvents = formerEE
            Throw New ArgumentException("Fehler beim Datei-Schreiben")
        End Try


        appInstance.EnableEvents = formerEE


    End Sub



    ''' <summary>
    ''' Exportiert das Projekt hproj in einen Projektsteckbrief mit verwendeter Hierarchischem Aufbau der Phasen und Meilensteine
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <remarks></remarks>
    Public Sub awinExportProjectmitHrchy(hproj As clsProjekt)

        Dim fileName As String
        Dim rng As Excel.Range, destinationRange As Excel.Range
        Dim zeile As Integer, spalte As Integer
        Dim rowOffset As Integer, columnOffset As Integer
        Dim delimiter As String = "."
        Dim einrückJeStufe As String = "  "


        Dim formerEE As Boolean = appInstance.EnableEvents
        appInstance.EnableEvents = False


        zeile = 1
        spalte = 1

        ' Dateiname des Projectfiles '
        ' ur: 14.01.2015: Dateiname gleich dem Shape-Namen einschließlich VariantenNamen

        fileName = hproj.getShapeText & ".xlsx"

        'ur: 13.01.2015:  aus "fileName" werden die illegale Sonderzeichen eliminiert
        fileName = cleanFileName(fileName)

        ' fileName wird nun ergänzt mit dem passenden Pfad
        'fileName = awinPath & projektFilesOrdner & "\" & fileName
        fileName = exportOrdnerNames(PTImpExp.visbo) & "\" & fileName

        ' -------------------------------------------------
        ' hier werden die einzelnen Stamm-Daten in das entsprechende File geschrieben 
        ' -------------------------------------------------
        Try
            With appInstance.ActiveWorkbook.Worksheets("Stammdaten")

                .Unprotect(Password:="x")       ' Blattschutz aufheben

                ' Projekt-Name

                .range("Projekt_Name").value = hproj.name
                .range("Projekt_Name").interior.color = hproj.farbe
                .range("Projekt_Name").font.size = hproj.Schrift
                .range("Projekt_Name").font.color = hproj.Schriftfarbe
                Try
                    If hproj.kundenNummer <> "" Then
                        .range("Projekt_Nr").value = hproj.kundenNummer
                    Else

                    End If
                Catch ex As Exception
                    Call MsgBox("Vorlage von VISBO-Steckbrief enthält den ExcelNamen 'Projekt_Nr' nicht!")

                    appInstance.ActiveWorkbook.Names.Add(Name:="Projekt_Nr", RefersTo:="=Stammdaten!$C$8")
                    .range("Projekt_Nr").value = hproj.kundenNummer
                End Try



                ' Start

                .range("StartDatum").value = hproj.startDate

                ' Ende

                .range("EndeDatum").value = hproj.startDate.AddDays(hproj.dauerInDays - 1)


                'Projektleiter

                .range("Projektleiter").value = hproj.leadPerson

                ' Budget

                .range("Budget").value = hproj.Erloes.ToString("#####.#")

                'Kurzbeschreibung'

                .range("ProjektBeschreibung").value = hproj.description

                ' Ampel-Farbe

                .range("Bewertung").interior.color = awinSettings.AmpelNichtBewertet
                .range("Bewertung").value = hproj.ampelStatus


                ' Ampel-Bewertung 

                .range("BewertgErläuterung").value = hproj.ampelErlaeuterung


                ' Blattschutz setzen
                .Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True, Contents:=True, Scenarios:=True)

            End With
        Catch ex As Exception
            '' Blattschutz setzen
            appInstance.ActiveWorkbook.Worksheets("Stammdaten").Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True, Contents:=True, Scenarios:=True)

            appInstance.EnableEvents = formerEE
            Throw New ArgumentException("Fehler in awinExportProject, Schreiben Stammdaten")
        End Try

        ' --------------------------------------------------
        ' jetzt werden die Ressourcen Bedarfe weggeschrieben 

        ' --------------------------------------------------

        Try
            With CType(appInstance.ActiveWorkbook.Worksheets("Ressourcen"), Excel.Worksheet)

                Dim tbl As Excel.Range

                .Unprotect(Password:="x")       ' Blattschutz aufheben

                zeile = 1
                spalte = 1

                ' die Monate eintragen 

                If awinSettings.zeitEinheit = "PM" Then

                    ' Dim htxt As String = hproj.startDate.ToShortDateString

                    ' Zeilen und Spalten-Offset für die Zeitleiste herausfinden
                    tbl = .Range("Zeitleiste")
                    rowOffset = tbl.Row         ' Reihen-Offset für die Zeitleiste
                    columnOffset = tbl.Column   ' Spalten-Offset für die Zeitleiste

                    ' Monat und Jahreszahl in die ersten beiden Felder der Zeitleiste eintragen'
                    .Range("Zeitleiste").Cells(columnOffset).value = "= StartDatum"

                    .Range("Zeitleiste").Cells(columnOffset + 1).value = "= EDATUM(D" & rowOffset & ",1"
                    .Range("Zeitleiste").Cells(columnOffset + 2).value = "= EDATUM(E" & rowOffset & ",1"

                    ' die ersten beiden Felder der Zeitleiste formatieren
                    rng = .Range(.Cells(rowOffset, columnOffset + 1), .Cells(rowOffset, columnOffset + 2))
                    rng.NumberFormat = "mmm-yy"
                    ' Die restliche Zeitleiste  formatieren
                    'rng = .range(.cells(startZeile, spalte), .cells(endZeile, spalte))
                    destinationRange = .Range(.Cells(rowOffset, columnOffset + 1), .Cells(rowOffset, columnOffset + 200))
                    With destinationRange
                        .HorizontalAlignment = Excel.XlHAlign.xlHAlignCenter
                        .VerticalAlignment = Excel.XlVAlign.xlVAlignBottom
                        .NumberFormat = "mmm-yy"
                        .WrapText = False
                        .Orientation = 90
                        .AddIndent = False
                        .IndentLevel = 0
                        .ShrinkToFit = False
                        .ReadingOrder = Excel.Constants.xlContext
                        .MergeCells = False
                        .ColumnWidth = 4
                    End With

                    ' die Zeitleiste mit den Monatsangaben automatisch befüllen
                    rng.AutoFill(Destination:=destinationRange, Type:=xlNS.XlAutoFillType.xlFillDefault)


                ElseIf awinSettings.zeitEinheit = "PW" Then
                ElseIf awinSettings.zeitEinheit = "PT" Then

                End If

                ' hier über alle Phasen ... 
                Dim cphase As clsPhase
                Dim p As Integer
                Dim phasenFarbe As Object
                Dim values() As Double
                Dim ErgebnisListe As New Collection
                Dim anzahlItems As Integer
                Dim r As Integer
                Dim d As Integer
                Dim itemNameID As String
                Dim dimension As Integer

                ' evtl hier vorher prüfen, ob es eine Phase mit Name hproj.name oder hproj.vorlagenName gibt; wenn nein , 
                ' muss hier der Projektname mit farbiger Gesamtdauer stehen 

                rowOffset = 1
                columnOffset = 1

                If hproj.CountPhases = 0 Then
                    ' Projekt-Name eintragen, Dauer einfärben, 28.2. genaues Start- und Endedatum in Kommentar eintragen

                    .Range("Phasen_des_Projekts").Cells(rowOffset, columnOffset).value = hproj.name
                    .Range("Phasen_des_Projekts").Cells(rowOffset, columnOffset).Interior.Color = hproj.farbe
                    rng = CType(.Range("Zeitmatrix")(.Cells(rowOffset, columnOffset), .Cells(rowOffset, columnOffset + hproj.anzahlRasterElemente - 1)), Excel.Range)
                    rng.Interior.Color = hproj.farbe
                    .Cells(rowOffset, columnOffset).AddComment()
                    With .Cells(rowOffset, columnOffset).Comment
                        .Visible = False
                        .Text(Text:="Start:" & Chr(10) & hproj.startDate)
                        .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                    End With
                    .Cells(rowOffset, columnOffset + hproj.anzahlRasterElemente - 1).AddComment()
                    With .Cells(rowOffset, columnOffset + hproj.anzahlRasterElemente - 1).Comment
                        .Visible = False
                        .Text(Text:="Ende:" & Chr(10) & hproj.endeDate)
                        .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                    End With
                    rowOffset = rowOffset + 1
                End If

                For p = 1 To hproj.CountPhases
                    cphase = hproj.getPhase(p)

                    ' Phasen-Name eintragen, Dauer einfärben
                    itemNameID = cphase.nameID

                    Try
                        phasenFarbe = cphase.farbe
                    Catch ex As Exception
                        phasenFarbe = hproj.farbe
                    End Try

                    If itemNameID = rootPhaseName Then  ' rootPhaseName = "0§.§" als Konstante definiert

                        ' Projekt-Name eintragen, Dauer einfärben

                        .Range("Phasen_des_Projekts").Cells(rowOffset, columnOffset).value = elemNameOfElemID(rootPhaseName)
                        .Range("Phasen_des_Projekts").Cells(rowOffset, columnOffset).Interior.Color = hproj.farbe
                        For d = 1 To hproj.anzahlRasterElemente
                            .Range("Zeitmatrix").Cells(rowOffset, columnOffset + d - 1).Interior.Color = hproj.farbe
                        Next d
                        ' Startdatum in Kommentar eintragen
                        .Range("Zeitmatrix").Cells(rowOffset, columnOffset).AddComment()
                        With .Range("Zeitmatrix").Cells(rowOffset, columnOffset).Comment
                            .Visible = False
                            .Text(Text:="Start:" & Chr(10) & hproj.startDate)
                            .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                        End With
                        .Range("Zeitmatrix").Cells(rowOffset, columnOffset + hproj.anzahlRasterElemente - 1).AddComment()
                        With .Range("Zeitmatrix").Cells(rowOffset, columnOffset + hproj.anzahlRasterElemente - 1).Comment
                            .Visible = False
                            .Text(Text:="Ende:" & Chr(10) & hproj.endeDate)
                            .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                        End With


                        d = CInt(appInstance.WorksheetFunction.CountA(.Range("Phasen_des_Projekts")))

                    Else
                        ' ur:06.05.2015: hier müssen die Einrückungen erfolgen

                        Dim indlevel As Integer = hproj.hierarchy.getIndentLevel(itemNameID)
                        Dim phstr As String = ""

                        .Range("Phasen_des_Projekts").Cells(rowOffset, columnOffset).value = elemNameOfElemID(itemNameID)
                        With CType(.Range("Phasen_des_Projekts").Cells(rowOffset, columnOffset), Excel.Range)
                            .IndentLevel = indlevel * einrückTiefe
                            .HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                        End With

                        For d = 1 To cphase.relEnde - cphase.relStart + 1
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart + d - 1).Interior.Color = phasenFarbe
                        Next d

                        ' Kommentar mit Start- und Endedatum eintragen
                        If cphase.relStart = cphase.relEnde Then
                            ' cphase ist nur ein Kästchen breit, d.h. Start-und EndeDatum müssen in einem Kommentar stehen
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart).AddComment()
                            With .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart).Comment
                                .Visible = False
                                .Text(Text:="Start:" & Chr(10) & cphase.getStartDate & Chr(10) & "Ende:" & Chr(10) & cphase.getEndDate)
                            End With
                        Else
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart).AddComment()
                            With .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart).Comment
                                .Visible = False
                                .Text(Text:="Start:" & Chr(10) & cphase.getStartDate)
                                .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                            End With
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relEnde).AddComment()
                            With .Range("Zeitmatrix").Cells(rowOffset, cphase.relEnde).Comment
                                .Visible = False
                                .Text(Text:="Ende:" & Chr(10) & cphase.getEndDate)
                                .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                            End With
                        End If
                        ' ende Kommentar eintragen in Ressourcen
                    End If

                    rowOffset = rowOffset + 1



                    anzahlItems = cphase.countRoles

                    Dim itemName As String
                    ' jetzt werden Rollen geschrieben 
                    For r = 1 To anzahlItems
                        itemName = cphase.getRole(r).name
                        dimension = cphase.getRole(r).getDimension
                        'ReDim values(cphase.relEnde - cphase.relStart)
                        ReDim values(dimension)
                        values = cphase.getRole(r).Xwerte
                        .Range("RollenKosten_des_Projekts").Cells(rowOffset, columnOffset).value = itemName

                        For d = 1 To dimension + 1
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart + d - 1).Interior.Color = phasenFarbe
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart + d - 1).Value = values(d - 1)
                        Next d
                        rowOffset = rowOffset + 1
                    Next r


                    ' jetzt werden Kosten geschrieben 

                    anzahlItems = cphase.countCosts

                    For k = 1 To anzahlItems
                        itemName = cphase.getCost(k).name
                        dimension = cphase.getCost(k).getDimension
                        ReDim values(dimension)
                        values = cphase.getCost(k).Xwerte
                        .Range("RollenKosten_des_Projekts").Cells(rowOffset, columnOffset).value = itemName
                        For d = 1 To dimension + 1
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart + d - 1).Interior.Color = phasenFarbe
                            .Range("Zeitmatrix").Cells(rowOffset, cphase.relStart + d - 1).Value = values(d - 1)
                        Next d
                        rowOffset = rowOffset + 1
                    Next
                    rowOffset = rowOffset + 1
                Next p

                ' Blattschutz setzen
                appInstance.ActiveWorkbook.Worksheets("Ressourcen").Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True,
                                                                       Contents:=True, Scenarios:=True, AllowFormattingCells:=True, AllowFormattingRows:=True,
                                                                       AllowInsertingRows:=True, AllowDeletingRows:=True)
                '. Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True, Contents:=True, Scenarios:=True)


            End With
        Catch ex As Exception
            ' Blattschutz setzen
            appInstance.ActiveWorkbook.Worksheets("Ressourcen").Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True,
                                                                       Contents:=True, Scenarios:=True, AllowFormattingCells:=True, AllowFormattingRows:=True,
                                                                       AllowInsertingRows:=True, AllowDeletingRows:=True)
            '.Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True, Contents:=True, Scenarios:=True)

            appInstance.EnableEvents = formerEE
            Throw New ArgumentException("Fehler in awinExportProject, Schreiben Ressourcen")
        End Try

        ' --------------------------------------------------
        ' jetzt werden die Settings in das unsichtbare Worksheet ("Settings") geschrieben 
        '
        Try

            With appInstance.ActiveWorkbook.Worksheets("Settings")

                .Unprotect(Password:="x")       ' Blattschutz aufheben

                zeile = 3
                Dim startZeile As Integer, endZeile As Integer
                Dim startMeilensteine As Integer
                Dim startRollen As Integer, startKosten As Integer
                spalte = 1
                Dim anzZeilen As Integer = 0
                rng = CType(.Range(.Cells(zeile, spalte), .Cells(zeile + 2000, spalte + 120)), Excel.Range)
                rng.Clear()

                ' ----------------------------------------- 
                ' Schreiben der Projektvorlagen
                '
                .cells(zeile, spalte).value = "Projekt-Vorlagen"
                .cells(zeile, spalte).interior.color = RGB(180, 180, 180)

                zeile = zeile + 1
                startZeile = zeile

                For Each kvp As KeyValuePair(Of String, clsProjektvorlage) In Projektvorlagen.Liste
                    .cells(zeile, spalte).value = kvp.Key
                    zeile = zeile + 1
                Next
                endZeile = zeile - 1

                If endZeile >= startZeile Then

                    If endZeile = startZeile Then
                        rng = CType(.cells(startZeile, spalte), Excel.Range)
                    Else
                        rng = CType(.range(.cells(startZeile, spalte), .cells(endZeile, spalte)), Excel.Range)
                    End If

                    appInstance.ActiveWorkbook.Names.Add(Name:="ProjektVorlagen", RefersTo:=rng)

                End If

                ' Schreiben des Delimiters
                .cells(zeile, spalte).value = delimiter
                zeile = zeile + 1


                ' -----------------------------------------
                ' Schreiben der Business Units 
                '
                .cells(zeile, spalte).value = "Business Units"
                .cells(zeile, spalte).interior.color = RGB(180, 180, 180)

                zeile = zeile + 1
                startZeile = zeile

                For Each kvp As KeyValuePair(Of Integer, clsBusinessUnit) In businessUnitDefinitions
                    .cells(zeile, spalte).value = kvp.Value.name
                    zeile = zeile + 1
                Next

                endZeile = zeile - 1

                If endZeile >= startZeile Then

                    If endZeile = startZeile Then
                        rng = CType(.cells(startZeile, spalte), Excel.Range)
                    Else
                        rng = CType(.range(.cells(startZeile, spalte), .cells(endZeile, spalte)), Excel.Range)
                    End If
                    appInstance.ActiveWorkbook.Names.Add(Name:="BusinessUnits", RefersTo:=rng)

                End If


                ' -----------------------------------------
                ' Schreiben der Projekt-Stati 
                '
                .cells(zeile, spalte).value = "Projekt-Stati"
                .cells(zeile, spalte).interior.color = RGB(180, 180, 180)

                zeile = zeile + 1
                startZeile = zeile

                Dim anzahlS As Integer = ProjektStatus.Length
                For i = 1 To ProjektStatus.Length
                    .cells(zeile, spalte).value = ProjektStatus(i - 1)
                    zeile = zeile + 1
                Next

                endZeile = zeile - 1

                If endZeile >= startZeile Then

                    If endZeile = startZeile Then
                        rng = CType(.cells(startZeile, spalte), Excel.Range)
                    Else
                        rng = CType(.range(.cells(startZeile, spalte), .cells(endZeile, spalte)), Excel.Range)
                    End If
                    appInstance.ActiveWorkbook.Names.Add(Name:="ProjektStatus", RefersTo:=rng)

                End If



                ' ----------------------------------------- 
                ' Schreiben der Phasen
                '
                .cells(zeile, spalte).value = "Phasen"
                .cells(zeile, spalte).interior.color = RGB(180, 180, 180)

                zeile = zeile + 1
                startZeile = zeile

                For i = 1 To PhaseDefinitions.Count

                    Dim cphaseDef As clsPhasenDefinition = PhaseDefinitions.getPhaseDef(i)
                    .cells(zeile, spalte).value = cphaseDef.name
                    .cells(zeile, spalte + 1).interior.color = cphaseDef.farbe
                    zeile = zeile + 1
                Next

                endZeile = zeile - 1

                If endZeile >= startZeile Then

                    If endZeile = startZeile Then
                        rng = CType(.cells(startZeile, spalte), Excel.Range)
                    Else
                        rng = CType(.range(.cells(startZeile, spalte), .cells(endZeile, spalte)), Excel.Range)
                    End If
                    appInstance.ActiveWorkbook.Names.Add(Name:="Phasen", RefersTo:=rng)

                End If

                ' ----------------------------------------- 
                ' Schreiben der Meilensteine
                '
                .cells(zeile, spalte + 2).value = "Meilensteine"
                .cells(zeile, spalte + 2).interior.color = RGB(180, 180, 180)

                startMeilensteine = zeile


                For i = 1 To MilestoneDefinitions.Count
                    .cells(zeile, spalte).value = MilestoneDefinitions.getMilestoneDef(i).name
                    zeile = zeile + 1
                Next

                endZeile = zeile - 1

                If endZeile >= startMeilensteine Then
                    rng = CType(.range(.cells(startMeilensteine, spalte), .cells(endZeile, spalte)), Excel.Range)
                    appInstance.ActiveWorkbook.Names.Add(Name:="Meilensteine", RefersTo:=rng)

                End If

                If endZeile >= startZeile Then

                    If endZeile = startZeile Then
                        rng = CType(.cells(startZeile, spalte), Excel.Range)
                    Else
                        rng = CType(.range(.cells(startZeile, spalte), .cells(endZeile, spalte)), Excel.Range)
                    End If
                    appInstance.ActiveWorkbook.Names.Add(Name:="Phasen_Meilensteine", RefersTo:=rng)

                End If

                ' Schreiben des Delimiters
                .cells(zeile, spalte).value = delimiter
                zeile = zeile + 1


                ' ----------------------------------------- 
                ' Schreiben der Rollen und Kostenarten
                '

                .cells(zeile, spalte).value = "Rollen/Kostenarten"
                .cells(zeile, spalte).interior.color = RGB(180, 180, 180)

                zeile = zeile + 1
                startZeile = zeile
                startRollen = zeile

                For i = 1 To RoleDefinitions.Count
                    .cells(zeile, spalte).value = RoleDefinitions.getRoledef(i).name
                    zeile = zeile + 1
                Next

                endZeile = zeile - 1

                If endZeile >= startZeile Then

                    If endZeile = startZeile Then
                        rng = CType(.cells(startZeile, spalte), Excel.Range)
                    Else
                        rng = CType(.range(.cells(startZeile, spalte), .cells(endZeile, spalte)), Excel.Range)
                    End If
                    appInstance.ActiveWorkbook.Names.Add(Name:="Rollen", RefersTo:=rng)

                End If


                startKosten = zeile

                For i = 1 To CostDefinitions.Count - 1
                    ' die Personalkosten sind die letzte Kostenart, wird nicht mit aufgenommen, da sie 
                    ' automatisch berücksichtigt wird 
                    .cells(zeile, spalte).value = CostDefinitions.getCostdef(i).name
                    zeile = zeile + 1
                Next

                endZeile = zeile - 1
                If endZeile >= startKosten Then
                    rng = CType(.range(.cells(startKosten, spalte), .cells(endZeile, spalte)), Excel.Range)
                    appInstance.ActiveWorkbook.Names.Add(Name:="Kosten", RefersTo:=rng)

                End If

                If endZeile >= startZeile Then
                    rng = CType(.range(.cells(startZeile, spalte), .cells(endZeile, spalte)), Excel.Range)
                    appInstance.ActiveWorkbook.Names.Add(Name:="Rollen_Kostenarten", RefersTo:=rng)

                End If

                ' Schreiben des Delimiters
                .cells(zeile, spalte).value = delimiter
                zeile = zeile + 1


                ' -------------------------------------------
                ' Schreiben der Ampel-Farben 
                '


                .cells(zeile, spalte).value = "Ampel-Farben"
                .cells(zeile, spalte).interior.color = RGB(180, 180, 180)

                zeile = zeile + 1
                startZeile = zeile
                For i = 0 To 3
                    Select Case i
                        Case 0
                            .cells(zeile, spalte).value = "Ampel nicht bewertet"
                            .cells(zeile, spalte).interior.color = awinSettings.AmpelNichtBewertet
                        Case 1
                            .cells(zeile, spalte).value = "Ampel Grün"
                            .cells(zeile, spalte).interior.color = awinSettings.AmpelGruen
                        Case 2
                            .cells(zeile, spalte).value = "Ampel Gelb"
                            .cells(zeile, spalte).interior.color = awinSettings.AmpelGelb
                        Case 3
                            .cells(zeile, spalte).value = "Ampel Rot"
                            .cells(zeile, spalte).interior.color = awinSettings.AmpelRot
                    End Select
                    zeile = zeile + 1
                Next

                endZeile = zeile - 1

                If endZeile >= startZeile Then
                    rng = CType(.range(.cells(startZeile, spalte), .cells(endZeile, spalte)), Excel.Range)
                    appInstance.ActiveWorkbook.Names.Add(Name:="AmpelFarben", RefersTo:=rng)

                End If

                ' Schreiben des Delimiters
                .cells(zeile, spalte).value = delimiter
                zeile = zeile + 1

                ' ----------------------------------------- 
                ' Schreiben der Custom Field Namen
                '
                .cells(zeile, spalte).value = "Custom Fields"
                .cells(zeile, spalte).interior.color = RGB(180, 180, 180)

                zeile = zeile + 1
                startZeile = zeile

                For Each kvp As KeyValuePair(Of Integer, clsCustomFieldDefinition) In customFieldDefinitions.liste
                    .cells(zeile, spalte).value = kvp.Value.name
                    zeile = zeile + 1
                Next
                endZeile = zeile - 1

                If endZeile >= startZeile Then

                    If endZeile = startZeile Then
                        rng = CType(.cells(startZeile, spalte), Excel.Range)
                    Else
                        rng = CType(.range(.cells(startZeile, spalte), .cells(endZeile, spalte)), Excel.Range)
                    End If

                    appInstance.ActiveWorkbook.Names.Add(Name:="Custom_Fields", RefersTo:=rng)

                End If

                ' Schreiben des Delimiters
                .cells(zeile, spalte).value = delimiter
                zeile = zeile + 1


                ' ----------------------------------------- 
                ' Unsichtbarmachen des Tabellenblattes
                '

                .Visible = Excel.XlSheetVisibility.xlSheetHidden

                ' Blattschutz setzen
                appInstance.ActiveWorkbook.Worksheets("Settings").Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True, Contents:=True, Scenarios:=True)

            End With

        Catch ex As Exception

            ' Blattschutz setzen
            appInstance.ActiveWorkbook.Worksheets("Settings").Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True, Contents:=True, Scenarios:=True)
            appInstance.EnableEvents = formerEE
            Throw New ArgumentException("Fehler in awinExportProject, Schreiben Settings")
        End Try

        ' ----------------------------------------------
        ' jetzt werden die Termine weggeschrieben ....

        Try
            With appInstance.ActiveWorkbook.Worksheets("Termine")


                .Unprotect(Password:="x")       ' Blattschutz aufheben

                zeile = 1
                spalte = 1

            End With
        Catch ex As Exception
            With appInstance.ActiveWorkbook.Worksheets.Add
                .name = "Termine"
                ' Tabelle ErgebnTabelle muss hier eigentlich erzeugt werden
                appInstance.EnableEvents = formerEE
                Throw New ArgumentException("Fehler in awinExportProject, Schreiben Termine, Worksheet Termine existiert nicht")
            End With
        End Try

        ' --------------------------------------
        ' Worksheet Termine existiert jetzt ...

        With CType(appInstance.ActiveWorkbook.Worksheets("Termine"), Excel.Worksheet)

            .Unprotect(Password:="x")       ' Blattschutz aufheben

            Dim cphase As New clsPhase(hproj)
            Dim phaseName As String
            Dim r As Integer
            Dim cResult As New clsMeilenstein(parent:=cphase)
            Dim cBewertung As clsBewertung = Nothing
            Dim phaseStart As Date
            Dim phaseEnde As Date
            Dim tbl As Excel.Range
            Dim itemNameID As String
            Dim tmpDeliverables As String

            tbl = .Range("ErgebnTabelle")
            rowOffset = tbl.Row
            columnOffset = tbl.Column

            zeile = 0

            For p = 1 To hproj.CountPhases

                cphase = hproj.getPhase(p)

                ' Phasen-Name eintragen, Dauer einfärben
                itemNameID = cphase.nameID

                If awinSettings.zeitEinheit = "PM" Then
                    phaseStart = hproj.startDate.AddDays(cphase.startOffsetinDays)
                    phaseEnde = hproj.startDate.AddDays(cphase.startOffsetinDays + cphase.dauerInDays - 1)
                ElseIf awinSettings.zeitEinheit = "PW" Then
                    phaseStart = hproj.startDate.AddDays((cphase.relStart - 1) * 7)
                    phaseEnde = hproj.startDate.AddDays((cphase.relEnde - 1) * 7)
                ElseIf awinSettings.zeitEinheit = "PT" Then
                    phaseStart = hproj.startDate.AddDays(cphase.relStart - 1)
                    phaseEnde = hproj.startDate.AddDays(cphase.relEnde - 1)
                End If


                phaseName = cphase.name

                ' hier muss die Phase geschrieben werden


                If itemNameID = rootPhaseName Then

                    .Cells(rowOffset + zeile, columnOffset).value = elemNameOfElemID(rootPhaseName)

                Else
                    ' ur:06.05.2015: hier müssen die Einrückungen erfolgen

                    Dim indlevel As Integer = hproj.hierarchy.getIndentLevel(itemNameID)

                    .Cells(rowOffset + zeile, columnOffset).value = elemNameOfElemID(itemNameID)
                    With CType(.Cells(rowOffset + zeile, columnOffset), Excel.Range)
                        .HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                        .VerticalAlignment = Excel.XlVAlign.xlVAlignCenter
                        .IndentLevel = indlevel * einrückTiefe
                    End With

                End If

                ' ur: 06.05 2015:Bezug fällt weg:.Cells(rowOffset + zeile, columnOffset + 2).value = ""
                .Cells(rowOffset + zeile, columnOffset + 2).value = phaseStart
                .Cells(rowOffset + zeile, columnOffset + 3).value = phaseEnde
                .Cells(rowOffset + zeile, columnOffset + 4).value = "0"

                ' Änderung tk 
                .Cells(rowOffset + zeile, columnOffset + 4).value = cphase.ampelStatus
                '.Cells(rowOffset + zeile, columnOffset + 4).interior.color = cBewertung.color
                .Cells(rowOffset + zeile, columnOffset + 5).value = cphase.ampelErlaeuterung
                .Cells(rowOffset + zeile, columnOffset + 5).WrapText = True

                'If cphase.bewertungsListe.Count > 0 Then
                '    For Each kvp As KeyValuePair(Of String, clsBewertung) In cphase.bewertungsListe
                '        cBewertung = kvp.Value
                '        .Cells(rowOffset + zeile, columnOffset + 4).value = cBewertung.colorIndex
                '        .Cells(rowOffset + zeile, columnOffset + 4).interior.color = cBewertung.color
                '        ' Zelle für Beschreibung in der Höhe anpassen, autom. Zeilenumbruch
                '        .Cells(rowOffset + zeile, columnOffset + 5).value = cBewertung.description
                '        .Cells(rowOffset + zeile, columnOffset + 5).WrapText = True
                '    Next
                'End If


                ' Änderung tk 2.11 Ergänzung um Deliverables 
                tmpDeliverables = cphase.getAllDeliverables
                .Cells(rowOffset + zeile, columnOffset + 6).value = tmpDeliverables
                .Cells(rowOffset + zeile, columnOffset + 6).WrapText = True

                '
                ' Änderung tk 1.11.15: immer die vollen Inhalte zeigen ...
                Try
                    CType(.Rows(rowOffset + zeile), Excel.Range).AutoFit()
                Catch ex As Exception

                End Try


                .Cells(rowOffset + zeile, columnOffset + 7).value = cphase.verantwortlich
                .Cells(rowOffset + zeile, columnOffset + 8).value = cphase.percentDone
                .Cells(rowOffset + zeile, columnOffset + 8).NumberFormat = "0%"
                .Cells(rowOffset + zeile, columnOffset + 8).HorizontalAlignment = Excel.XlHAlign.xlHAlignCenter
                ' Änderung tk 11.5.18 Ergänzung Document Link 

                If Not IsNothing(cphase.DocURL) Then
                    .Cells(rowOffset + zeile, columnOffset + 9).value = cphase.DocURL
                End If

                Try
                    For offs As Integer = 2 To 9
                        .Cells(rowOffset + zeile, columnOffset + offs).VerticalAlignment = Excel.XlVAlign.xlVAlignCenter
                    Next
                Catch ex As Exception

                End Try

                zeile = zeile + 1

                For r = 1 To cphase.countMilestones
                    cResult = cphase.getMilestone(r)

                    cBewertung = cResult.getBewertung(1)
                    'Try
                    '    cBewertung = cResult.getBewertung(1)
                    'Catch ex As Exception
                    '    cBewertung = New clsBewertung
                    'End Try
                    ' --------------------------------------------------------------------------------
                    ' Termine müssen in Tabelle eingetragen werden
                    '----------------------------------------------------------------------------------

                    itemNameID = cResult.nameID

                    ' ur:06.05.2015: hier müssen die Einrückungen erfolgen

                    Dim indlevel As Integer = hproj.hierarchy.getIndentLevel(itemNameID)

                    .Cells(rowOffset + zeile, columnOffset).value = elemNameOfElemID(itemNameID)
                    With CType(.Cells(rowOffset + zeile, columnOffset), Excel.Range)

                        .HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                        .VerticalAlignment = Excel.XlVAlign.xlVAlignCenter
                        .IndentLevel = indlevel * einrückTiefe
                        .Font.Bold = True

                    End With
                    '.Cells(rowOffset + zeile, columnOffset + 2).value = cResult.getDate
                    .Cells(rowOffset + zeile, columnOffset + 3).value = cResult.getDate
                    .Cells(rowOffset + zeile, columnOffset + 4).value = cBewertung.colorIndex
                    .Cells(rowOffset + zeile, columnOffset + 4).interior.color = cBewertung.color
                    ' Zelle für Beschreibung in der Höhe anpassen, autom. Zeilenumbruch
                    .Cells(rowOffset + zeile, columnOffset + 5).value = cBewertung.description
                    .Cells(rowOffset + zeile, columnOffset + 5).WrapText = True
                    ' Änderung tk 2.11 Ergänzung um Deliverables 
                    tmpDeliverables = cResult.getAllDeliverables
                    .Cells(rowOffset + zeile, columnOffset + 6).value = tmpDeliverables
                    .Cells(rowOffset + zeile, columnOffset + 6).WrapText = True

                    ' Änderung tk 4.12. Schreiben verantwortlich und percentDone
                    .Cells(rowOffset + zeile, columnOffset + 7).value = cResult.verantwortlich

                    .Cells(rowOffset + zeile, columnOffset + 8).value = cResult.percentDone
                    .Cells(rowOffset + zeile, columnOffset + 8).NumberFormat = "0%"
                    .Cells(rowOffset + zeile, columnOffset + 8).HorizontalAlignment = Excel.XlHAlign.xlHAlignCenter

                    ' Schreiben des Dokumenten-Links
                    If Not IsNothing(cResult.DocURL) Then
                        .Cells(rowOffset + zeile, columnOffset + 9).value = cResult.DocURL
                    End If
                    '
                    ' Änderung tk 1.11.15: immer die vollen Inhalte zeigen ...
                    Try
                        If Not IsNothing(cBewertung.description) Or Not IsNothing(tmpDeliverables) Then
                            If cBewertung.description.Length > 0 Or tmpDeliverables.Length > 0 Then
                                If cBewertung.description.Contains(vbLf) Or cBewertung.description.Contains(vbCr) Or
                                    tmpDeliverables.Contains(vbLf) Or tmpDeliverables.Contains(vbCr) Then
                                    CType(.Rows(rowOffset + zeile), Excel.Range).AutoFit()
                                End If
                            End If
                        End If


                        For offs As Integer = 2 To 9
                            .Cells(rowOffset + zeile, columnOffset + offs).VerticalAlignment = Excel.XlVAlign.xlVAlignCenter
                        Next
                    Catch ex As Exception

                    End Try
                    ' Ende Änderung tk 1.11.15 
                    '

                    zeile = zeile + 1
                Next

            Next


            ' Blattschutz setzen
            appInstance.ActiveWorkbook.Worksheets("Termine").Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True,
                                                                       Contents:=True, Scenarios:=True, AllowFormattingCells:=True, AllowFormattingRows:=True,
                                                                       AllowInsertingRows:=True, AllowDeletingRows:=True)
            '.Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True, Contents:=True, Scenarios:=True)


        End With


        ' ----------------------------------------------
        ' jetzt werden die Attribute weggeschrieben ....

        Try
            With CType(appInstance.ActiveWorkbook.Worksheets("Attribute"), Excel.Worksheet)

                .Unprotect(Password:="x")       ' Blattschutz aufheben


                ' Projekt-Typ

                .Range("Projekt_Typ").Value = hproj.VorlagenName
                rng = .Range("Projekt_Typ")
                With rng
                    .HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                    .IndentLevel = 1
                    .WrapText = False

                    Try
                        .Validation.Delete()
                        .Validation.Add(Type:=xlNS.XlDVType.xlValidateList, AlertStyle:=xlNS.XlDVAlertStyle.xlValidAlertStop,
                                           Formula1:="=ProjektVorlagen")
                        .Validation.InputMessage = "bitte nicht ändern! Dient nur als Hinweis, mit welcher Vorlage das Projekt verglichen werden soll."
                    Catch ex As Exception

                    End Try

                End With




                ' Status

                .Range("Status").Value = hproj.Status
                rng = .Range("Status")
                With rng
                    .HorizontalAlignment = Excel.XlHAlign.xlHAlignRight
                    .IndentLevel = 1
                    .WrapText = False

                    Try
                        .Validation.Delete()
                        .Validation.Add(Type:=xlNS.XlDVType.xlValidateList, AlertStyle:=xlNS.XlDVAlertStyle.xlValidAlertStop,
                                           Formula1:="=ProjektStatus")
                        .Validation.InputMessage = ""
                    Catch ex As Exception

                    End Try

                End With

                ' Business_Unit

                .Range("Business_Unit").Value = hproj.businessUnit
                rng = .Range("Business_Unit")
                With rng
                    .HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                    .IndentLevel = 1
                    .WrapText = False

                    Try
                        .Validation.Delete()
                        .Validation.Add(Type:=xlNS.XlDVType.xlValidateList, AlertStyle:=xlNS.XlDVAlertStyle.xlValidAlertStop,
                                           Formula1:="=BusinessUnits")
                        .Validation.InputMessage = ""
                    Catch ex As Exception

                    End Try

                End With

                ' Strategischer Fit

                .Range("Strategischer_Fit").Value = hproj.StrategicFit
                rng = .Range("Strategischer_Fit")
                With rng
                    .HorizontalAlignment = Excel.XlHAlign.xlHAlignRight
                    .IndentLevel = 1
                    .WrapText = False

                    Try
                        .Validation.Delete()
                        .Validation.Add(Type:=xlNS.XlDVType.xlValidateDecimal, AlertStyle:=xlNS.XlDVAlertStyle.xlValidAlertStop,
                                           Formula1:="0,1", Formula2:="9,9", [Operator]:=xlNS.XlFormatConditionOperator.xlBetween)
                        .Validation.InputMessage = "Werte zwischen 0.1 und 9.9"
                    Catch ex As Exception

                    End Try

                End With

                ' Risiko

                .Range("Risiko").Value = hproj.Risiko
                rng = .Range("Risiko")
                With rng
                    .HorizontalAlignment = Excel.XlHAlign.xlHAlignRight
                    .IndentLevel = 1
                    .WrapText = False

                    Try
                        .Validation.Delete()
                        .Validation.Add(Type:=xlNS.XlDVType.xlValidateDecimal, AlertStyle:=xlNS.XlDVAlertStyle.xlValidAlertStop,
                                           Formula1:="0,1", Formula2:="9,9", [Operator]:=xlNS.XlFormatConditionOperator.xlBetween)
                        .Validation.InputMessage = "Werte zwischen 0.1 und 9.9"
                    Catch ex As Exception

                    End Try

                End With

                ' ur: 13.01.2015: Varianten_Name wird hier in das Tabellenblatt Attribute des Projekt-Steckbriefes eingetragen

                If Not IsNothing(hproj.variantName) Then

                    .Range("Variant_Name").Value = hproj.variantName
                    rng = .Range("Variant_Name")
                    With rng
                        .HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                        .IndentLevel = 1
                        .WrapText = False
                    End With

                End If

                Try   ' Try catch, da in manchen Projekte bzw. Steckbriefen keine Variant_Description vorhanden

                    ' tk: 14.10.16 Varianten Beschreibung wird geschrieben 
                    If Not IsNothing(hproj.variantDescription) Then

                        .Range("Variant_Description").Value = hproj.variantDescription
                        rng = .Range("Variant_Description")
                        With rng
                            .HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                            .IndentLevel = 1
                            .WrapText = True
                        End With

                    End If
                Catch ex As Exception

                End Try

                Try
                    ' jetzt werden die weiteren Custom Fields weggeschrieben ....
                    ' und zwar immer in der Form <name> <Wert> <type>

                    rng = .Range("IndivName2")
                    Dim startZeileOfCFs As Integer = rng.Row
                    Dim zeilenoffset As Integer = 0

                    If customFieldDefinitions.count > 0 Then
                        ' nur dann kann es Custom Fields geben 



                        With hproj

                            ' jetzt alle String Fields rausschreiben 
                            For i As Integer = 1 To .customStringFields.Count
                                Dim uid As Integer = .customStringFields.ElementAt(i - 1).Key
                                Dim cfValue As String = .customStringFields.ElementAt(i - 1).Value

                                ' Name und Typ muss über uid aus Definitions ausgelesen werden 
                                Dim cfName As String = customFieldDefinitions.getName(uid)
                                Dim cfType As Integer = customFieldDefinitions.getTyp(uid)

                                rng.Offset(zeilenoffset, -1).Value = cfName
                                rng.Offset(zeilenoffset, 0).Value = cfValue
                                rng.Offset(zeilenoffset, 0).NumberFormat = "@"
                                rng.Offset(zeilenoffset, 2).Value = "String"


                                zeilenoffset = zeilenoffset + 1
                            Next

                            ' jetzt alle Double Fields rausschreiben 
                            For i As Integer = 1 To .customDblFields.Count
                                Dim uid As Integer = .customDblFields.ElementAt(i - 1).Key
                                Dim cfValue As Double = .customDblFields.ElementAt(i - 1).Value

                                ' Name und Typ muss über uid aus Definitions ausgelesen werden 
                                Dim cfName As String = customFieldDefinitions.getName(uid)
                                Dim cfType As Integer = customFieldDefinitions.getTyp(uid)

                                rng.Offset(zeilenoffset, -1).Value = cfName
                                rng.Offset(zeilenoffset, 0).Value = cfValue.ToString
                                rng.Offset(zeilenoffset, 0).NumberFormat = "#0.00"
                                rng.Offset(zeilenoffset, 2).Value = "Zahl"

                                zeilenoffset = zeilenoffset + 1
                            Next

                            ' jetzt alle Flag Fields rausschreiben 
                            For i As Integer = 1 To .customBoolFields.Count
                                Dim uid As Integer = .customBoolFields.ElementAt(i - 1).Key
                                Dim cfValue As Boolean = .customBoolFields.ElementAt(i - 1).Value

                                ' Name und Typ muss über uid aus Definitions ausgelesen werden 
                                Dim cfName As String = customFieldDefinitions.getName(uid)
                                Dim cfType As Integer = customFieldDefinitions.getTyp(uid)

                                rng.Offset(zeilenoffset, -1).Value = cfName
                                rng.Offset(zeilenoffset, 0).Value = cfValue.ToString
                                rng.Offset(zeilenoffset, 2).Value = "Flag"

                                zeilenoffset = zeilenoffset + 1
                            Next

                        End With

                    End If



                    ' jetzt werden noch die Validation. also Auswahl aus Liste gesetzt ...
                    For iz As Integer = startZeileOfCFs To startZeileOfCFs + zeilenoffset + customFieldDefinitions.count
                        Try
                            rng.Validation.Add(Type:=xlNS.XlDVType.xlValidateList, AlertStyle:=xlNS.XlDVAlertStyle.xlValidAlertStop,
                                           Formula1:="=Custom_Fields")
                        Catch ex As Exception

                        End Try
                    Next



                    ' Blattschutz setzen
                    .Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True, Contents:=True, Scenarios:=True)

                Catch ex As Exception

                End Try


            End With
        Catch ex As Exception
            '' Blattschutz setzen
            appInstance.ActiveWorkbook.Worksheets("Attribute").Protect(Password:="x", UserInterfaceOnly:=True, DrawingObjects:=True,
                                                                       Contents:=True, Scenarios:=True)


            appInstance.EnableEvents = formerEE
            Throw New ArgumentException("Fehler in awinExportProject, Schreiben Attribute")
        End Try


        Try

            My.Computer.FileSystem.DeleteFile(fileName)
        Catch ex As Exception

        End Try

        Try

            appInstance.ActiveWorkbook.SaveAs(fileName,
                                          ConflictResolution:=xlNS.XlSaveConflictResolution.xlLocalSessionChanges
                                          )

        Catch ex As Exception
            appInstance.EnableEvents = formerEE
            Throw New ArgumentException("Fehler beim Datei-Schreiben")
        End Try


        appInstance.EnableEvents = formerEE


    End Sub
    '' '' '' ur: 13.01.2015: Funktion checkt ob ein String ein legaler DateiNamen ist( funktioniert aber nicht)
    ' '' ''Function IsLegalFileName(ByVal str As String) As Boolean
    ' '' ''    If (str Like "[/\:*?""<>]") Then
    ' '' ''        IsLegalFileName = True
    ' '' ''    Else
    ' '' ''        IsLegalFileName = False
    ' '' ''    End If
    ' '' ''End Function


    'ur: 13.01.2015: Funktion streicht die illegalen Zeigen heraus
    'entnommen von folgendem Link: http://www.jpsoftwaretech.com/excel-vba/validate-filenames/

    Function cleanFileName(stringToClean As String) As String
        ' remove illegal characters from filenames
        Dim newString As String

        newString = Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(stringToClean, "|", ""), "[", ""), "]", ""), ">", ""), "<", ""), Chr(34), ""), "?", ""), "*", ""), ":", ""), "/", ""), "\", "")

        cleanFileName = newString

    End Function

    ' Vorbedingung: das Active-workbook ist bereits das ProjektDetail File 
    Public Sub awinStoreProjForEditRess(hproj As clsProjekt)
        Dim rng As Excel.Range
        Dim zeile As Integer, spalte As Integer
        Dim delimiter As String = "."
        Dim tmpStart As Date
        Dim pwd As String = "projekttafel"
        Dim laenge As Integer = hproj.anzahlRasterElemente
        Dim summenspalte As Integer
        Dim leadingColumns As Integer = 2

        Dim pstart As Integer = hproj.Start


        spalte = 1

        With CType(appInstance.Worksheets(arrWsNames(ptTables.meRC)), Excel.Worksheet)
            ' Blattschutz aufheben 
            .Unprotect(Password:=pwd)

            ' Änderung 3.7.14 Bereich von Zelle(1,1) bis Zelle(2000,2000) schützen
            rng = .Range(.Cells(1, 1), .Cells(2000, 2000))
            rng.Clear()
            rng.Locked = True

            ' hier wird die Headerzeile beschrieben und sonstiges für Layout wichtiges Struktur 
            If laenge > 1 Then
                .Cells(1, 1).offset(0, leadingColumns).value = hproj.startDate
                .Cells(1, 1).offset(0, leadingColumns + 1).value = hproj.startDate.AddMonths(1)
            End If

            'For i = 1 To laenge
            '    '.cells(1, i + 2).value = StartofCalendar.AddMonths(pstart + i - 2).ToString("MMM yy")
            '    .Cells(1, i + 2).value = StartofCalendar.AddMonths(pstart + i - 2)
            'Next i

            rng = .Range(.Cells(1, 1).offset(0, leadingColumns), .Cells(1, 1).offset(0, leadingColumns + 1))

            If awinSettings.zeitEinheit = "PM" Then

                '.Cells(1, 1).value = "Monate"


                rng.NumberFormat = "mmm-yy"

                Dim destinationRange As Excel.Range

                destinationRange = .Range(.Cells(1, 1).offset(0, leadingColumns),
                                          .Cells(1, 1).offset(0, leadingColumns + laenge - 1))
                summenspalte = spalte + 2 + laenge

                With destinationRange
                    .HorizontalAlignment = Excel.XlHAlign.xlHAlignCenter
                    .VerticalAlignment = Excel.XlVAlign.xlVAlignBottom
                    .NumberFormat = "mmm-yy"
                    .WrapText = False
                    .Orientation = 90
                    .AddIndent = False
                    .IndentLevel = 0
                    .ShrinkToFit = False
                    .ReadingOrder = Excel.Constants.xlContext
                    .MergeCells = False
                    .Interior.Color = noshowtimezone_color
                End With

                rng.AutoFill(Destination:=destinationRange, Type:=Excel.XlAutoFillType.xlFillMonths)


            ElseIf awinSettings.zeitEinheit = "PW" Then
                .Cells(1, 1).value = "Wochen"
                For i = 1 To 210
                    CType(.Cells(1, i), Global.Microsoft.Office.Interop.Excel.Range).Value = StartofCalendar.AddDays((i - 1) * 7)
                Next

            ElseIf awinSettings.zeitEinheit = "PT" Then
                .Cells(1, 1).value = "Tage"
                Dim workOnSat As Boolean = False
                Dim workOnSun As Boolean = False


                If Weekday(StartofCalendar, FirstDayOfWeek.Monday) > 3 Then
                    tmpStart = StartofCalendar.AddDays(8 - Weekday(StartofCalendar, FirstDayOfWeek.Monday))
                Else
                    tmpStart = StartofCalendar.AddDays(Weekday(StartofCalendar, FirstDayOfWeek.Monday) - 8)
                End If
                '
                ' jetzt ist tmpstart auf Montag ... 
                Dim tmpDay As Date
                Dim i As Integer, w As Integer
                i = 1
                For w = 1 To 30
                    For d = 0 To 4
                        ' das sind Montag bis Freitag
                        tmpDay = tmpStart.AddDays(d)
                        If Not feierTage.Contains(tmpDay) Then
                            CType(.Cells(1, i), Global.Microsoft.Office.Interop.Excel.Range).Value = tmpDay.ToString("d")
                            i = i + 1
                        End If
                    Next
                    tmpDay = tmpStart.AddDays(5)
                    If workOnSat Then
                        CType(.Cells(1, i), Global.Microsoft.Office.Interop.Excel.Range).Value = tmpDay.ToString("d")
                        i = i + 1
                    End If
                    tmpDay = tmpStart.AddDays(6)
                    If workOnSun Then
                        CType(.Cells(1, i), Global.Microsoft.Office.Interop.Excel.Range).Value = tmpDay.ToString("d")
                        i = i + 1
                    End If
                    tmpStart = tmpStart.AddDays(7)
                Next


            End If


            ' hier werden jetzt die Spaltenbreiten und Zeilenhöhen gesetzt 

            Dim maxRows As Integer = .Rows.Count
            Dim maxColumns As Integer = .Columns.Count


            CType(.Rows(1), Global.Microsoft.Office.Interop.Excel.Range).RowHeight = awinSettings.zeilenhoehe1
            CType(.Range(.Cells(2, 1), .Cells(maxRows, maxColumns)), Global.Microsoft.Office.Interop.Excel.Range).RowHeight = awinSettings.zeilenhoehe2
            CType(.Range(.Cells(1, 3), .Cells(maxRows, maxColumns)), Global.Microsoft.Office.Interop.Excel.Range).ColumnWidth = awinSettings.spaltenbreite


            ' Ende einfügen aus Tabelle2 Activate Event, 3.7.2014

            ' hier wird die erste Zeile beschrieben 

            'For i = 1 To laenge
            '    '.cells(1, i + 2).value = StartofCalendar.AddMonths(pstart + i - 2).ToString("MMM yy")
            '    .Cells(1, i + 2).value = StartofCalendar.AddMonths(pstart + i - 2)
            'Next i

            'rng = .Range(.Cells(1, 3), .Cells(1, maxProjektdauer + 2))

            'Try
            '    rng.Columns.AutoFit()
            'Catch ex As Exception

            'End Try


            zeile = 2


            Dim k As Integer
            k = 0
            ' wenn es noch keine Phasen gibt: Projekt-Name eintragen, Dauer einfärben
            If hproj.CountPhases = 0 Then
                ' Projekt-Name eintragen, Dauer einfärben
                .Cells(zeile, spalte).value = hproj.name
                rng = .Range(.Cells(zeile, spalte + 2), .Cells(zeile, spalte + 1 + hproj.anzahlRasterElemente))
                rng.Interior.Color = hproj.farbe
                ' Kommentar am Anfang und am Ende der Phase mit Datum
                .Cells(zeile, spalte + 2).AddComment()
                With .Cells(zeile, spalte + 2).Comment
                    .Visible = False
                    .Text(Text:="Start:" & Chr(10) & hproj.startDate)
                    .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                End With

                .Cells(zeile, spalte + 1 + hproj.anzahlRasterElemente).AddComment()
                With .Cells(zeile, spalte + 1 + hproj.anzahlRasterElemente).Comment
                    .Visible = False
                    .Text(Text:="Ende:" & Chr(10) & hproj.endeDate)
                    .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                End With

                ' Änderung 3.7.14 Zellen sollen gesperrt sein für Änderungen
                rng.Locked = True

                zeile = zeile + 1
            End If

            ' hier über alle Phasen ... 
            Dim cphase As clsPhase
            Dim p As Integer
            Dim phasenFarbe As Object
            Dim values() As Double
            Dim ErgebnisListe As New Collection
            Dim anzahlItems As Integer
            Dim r As Integer
            Dim itemName As String
            Dim dimension As Integer
            'Dim atleastOne As Boolean = False


            For p = 1 To hproj.CountPhases
                cphase = hproj.getPhase(p)
                ' Phasen-Name eintragen, Dauer einfärben
                itemName = cphase.name

                Try
                    phasenFarbe = cphase.farbe
                Catch ex As Exception
                    phasenFarbe = hproj.farbe
                End Try


                If itemName = elemNameOfElemID(rootPhaseName) Then
                    ' Projekt-Name eintragen, Dauer einfärben
                    .Cells(zeile, spalte).value = itemName
                    rng = .Range(.Cells(zeile, spalte + 2), .Cells(zeile, spalte + 1 + hproj.anzahlRasterElemente))
                    rng.Interior.Color = hproj.farbe

                    .Cells(zeile, spalte + 2).AddComment()
                    With .Cells(zeile, spalte + 2).Comment
                        .Visible = False
                        .Text(Text:="Start:" & Chr(10) & hproj.startDate)
                        .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                    End With

                    .Cells(zeile, spalte + 1 + hproj.anzahlRasterElemente).AddComment()
                    With .Cells(zeile, spalte + 1 + hproj.anzahlRasterElemente).Comment
                        .Visible = False
                        .Text(Text:="Ende:" & Chr(10) & hproj.endeDate)
                        .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                    End With

                    zeile = zeile + 1
                Else
                    ' Phasen Name eintragen, Dauer der Phase einfärben
                    .Cells(zeile, spalte).value = itemName
                    rng = .Range(.Cells(zeile, spalte + 1 + cphase.relStart), .Cells(zeile, spalte + 1 + cphase.relEnde))
                    rng.Interior.Color = phasenFarbe

                    .Cells(zeile, spalte + 1 + cphase.relStart).AddComment()
                    If cphase.relStart = cphase.relEnde Then
                        With .Cells(zeile, spalte + 1 + cphase.relStart).Comment
                            .Visible = False
                            .Text(Text:="Start:" & Chr(10) & cphase.getStartDate & Chr(10) & "Ende:" & Chr(10) & cphase.getEndDate)
                        End With
                    Else
                        With .Cells(zeile, spalte + 1 + cphase.relStart).Comment
                            .Visible = False
                            .Text(Text:="Start:" & Chr(10) & cphase.getStartDate)
                            .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                        End With
                        .Cells(zeile, spalte + 1 + cphase.relEnde).AddComment()
                        With .Cells(zeile, spalte + 1 + cphase.relEnde).Comment
                            .Visible = False
                            .Text(Text:="Ende:" & Chr(10) & cphase.getEndDate)
                            .Shape.ScaleHeight(0.45, Microsoft.Office.Core.MsoTriState.msoFalse)
                        End With
                    End If

                    zeile = zeile + 1
                End If



                anzahlItems = cphase.countRoles


                Dim startEingabebereich As Integer = zeile
                Dim endeEingabebereich As Integer
                Dim eingabeBereich As Excel.Range

                For r = 1 To anzahlItems
                    itemName = cphase.getRole(r).name
                    dimension = cphase.getRole(r).getDimension
                    ReDim values(dimension)
                    values = cphase.getRole(r).Xwerte
                    .Cells(zeile, spalte + 1).value = itemName
                    rng = .Range(.Cells(zeile, spalte + 1 + cphase.relStart), .Cells(zeile, spalte + 1 + cphase.relStart + dimension))
                    rng.Value = values
                    zeile = zeile + 1
                Next r


                ' jetzt werden Kosten geschrieben 

                anzahlItems = cphase.countCosts

                For k = 1 To anzahlItems
                    itemName = cphase.getCost(k).name
                    dimension = cphase.getCost(k).getDimension
                    ReDim values(dimension)
                    values = cphase.getCost(k).Xwerte
                    .Cells(zeile, spalte + 1).value = itemName
                    rng = .Range(.Cells(zeile, spalte + 1 + cphase.relStart), .Cells(zeile, spalte + 1 + cphase.relStart + dimension))
                    rng.Value = values
                    zeile = zeile + 1
                Next k


                ' Änderung 3.7 diese Zeilen sollen änderbar sein 
                ' hier werden nun die Validation Kriterien für den Eingabebereich festgelegt 
                endeEingabebereich = zeile - 1

                If endeEingabebereich >= startEingabebereich Then
                    eingabeBereich = .Range(.Cells(startEingabebereich, spalte + 1 + cphase.relStart),
                                        .Cells(endeEingabebereich, spalte + 1 + cphase.relStart + dimension))
                    eingabeBereich.Locked = False
                    eingabeBereich.Interior.Color = iProjektFarbe
                    Call InputZahlValidationforRange(eingabeBereich)
                End If

                zeile = zeile + 1
            Next p



            ' Phasen und Rollen sollen ja gar nicht mehr eingegeben werden können, deshalb ist das hier nicht mehr notwendig 

            ' hier werden nun die Phasen in einer Dropbox fixiert
            'rng = .Range(.Cells(2, 1), .Cells(200, 1))
            'InputValidationforRange(rng, 2, True)

            '' hier werden nun die Rollen und Kosten in Dropbox (2.Spalte) eingetragen
            'rng = .Range(.Cells(2, 2), .Cells(200, 2))
            'InputValidationforRange(rng, 1, True)


            ' Blattschutz aktivieren 
            .Protect(Password:="x", UserInterfaceOnly:=True,
                                AllowFormattingCells:=True,
                                AllowFormattingColumns:=True,
                                AllowInsertingColumns:=False,
                                AllowInsertingRows:=True,
                                AllowDeletingColumns:=False,
                                AllowDeletingRows:=True,
                                AllowSorting:=True,
                                AllowFiltering:=True)
            .EnableSelection = Excel.XlEnableSelection.xlUnlockedCells
            .EnableAutoFilter = True

            '.Protect(Password:=pwd,
            '         AllowFormattingCells:=True,
            '         AllowFormattingColumns:=True,
            '         UserInterfaceOnly:=True,
            '         DrawingObjects:=True,
            '         Contents:=True,
            '         Scenarios:=True)

            ' jetzt noch die ersten beiden Spalten so dimensionieren, daß die Texte zu lesen sind
            CType(.Columns(1), Global.Microsoft.Office.Interop.Excel.Range).AutoFit()
            CType(.Columns(2), Global.Microsoft.Office.Interop.Excel.Range).AutoFit()

        End With



    End Sub
    '


    Public Sub awinReadProjFromEditRess(ByRef hproj As clsProjekt)
        Dim lastRow As Integer
        Dim rng As Excel.Range
        Dim zelle As Excel.Range
        Dim chkPhase As Boolean = True
        Dim Xwerte As Double()
        Dim crole As clsRolle
        Dim cphase As New clsPhase(hproj)
        Dim ccost As clsKostenart
        Dim phaseName As String
        Dim anfang As Integer, ende As Integer
        Dim farbeAktuell As Object
        Dim r As Integer, k As Integer
        'Dim zeile As Integer
        Dim newProj As New clsProjekt


        With appInstance.ActiveSheet

            'Dim valueRange As Excel.Range

            'zeile = 2
            'lastRow = .range(.Cells(1, 1), .cells(2000, 1)).End(XlDirection.xlUp).row
            lastRow = System.Math.Max(CType(.cells(2000, 1), Excel.Range).End(xlNS.XlDirection.xlUp).Row, CType(.cells(2000, 2), Excel.Range).End(xlNS.XlDirection.xlUp).Row) + 1
            rng = CType(.range(.cells(2, 1), .cells(lastRow, 1)), Excel.Range)
            'If .cells(zeile, 1).value <> hproj.name Then
            '    hproj.name = .cells(zeile, 1).value
            'End If

            'zeile = 3
            For Each zelle In rng
                Select Case chkPhase
                    Case True
                        ' hier wird die Phasen Information ausgelesen

                        If Len(CType(zelle.Value, String)) > 0 Then
                            phaseName = CType(zelle.Value, String).Trim

                            If Len(phaseName) > 0 Then

                                cphase = New clsPhase(hproj)

                                ' Auslesen der Phasen Dauer
                                anfang = 1
                                While zelle.Offset(0, anfang + 1).Interior.ColorIndex = -4142
                                    anfang = anfang + 1
                                End While

                                ende = anfang + 1
                                farbeAktuell = zelle.Offset(0, ende).Interior.Color
                                While zelle.Offset(0, ende + 1).Interior.Color = farbeAktuell
                                    ende = ende + 1
                                End While
                                ende = ende - 1

                                chkPhase = False


                                With cphase
                                    .nameID = hproj.hierarchy.findUniqueElemKey(phaseName, False)
                                    ' Änderung 28.11.13: jetzt wird die Phasen Länge exakt bestimmt , über startoffset in Tagen und dauerinDays als Länge
                                    Dim startOffset As Integer
                                    Dim dauerIndays As Integer
                                    startOffset = CInt(DateDiff(DateInterval.Day, hproj.startDate, hproj.startDate.AddMonths(anfang - 1)))
                                    dauerIndays = calcDauerIndays(hproj.startDate.AddDays(startOffset), ende - anfang + 1, True)


                                    .changeStartandDauer(startOffset, dauerIndays)
                                    .offset = 0
                                End With

                            End If

                        End If



                    Case False ' auslesen Rollen- bzw. Kosten-Information

                        ' hier wird die Rollen bzw Kosten Information ausgelesen
                        Dim hname As String
                        Try
                            hname = CType(zelle.Offset(0, 1).Value, String).Trim
                        Catch ex1 As Exception
                            hname = ""
                        End Try


                        If Len(hname) > 0 Then

                            '
                            ' handelt es sich um die Ressourcen Definition?
                            '
                            If RoleDefinitions.containsName(hname) Then
                                Try
                                    r = CInt(RoleDefinitions.getRoledef(hname).UID)

                                    ReDim Xwerte(ende - anfang)


                                    'valueRange = .Range(zelle.Offset(0, anfang + 1), zelle.Offset(0, ende + 1))
                                    'Xwerte = CType(valueRange.Value, Double())

                                    For m = anfang To ende
                                        Xwerte(m - anfang) = CDbl(CType(zelle.Offset(0, m + 1), Excel.Range).Value)
                                    Next m

                                    crole = New clsRolle(ende - anfang)
                                    With crole
                                        .uid = r
                                        .Xwerte = Xwerte
                                    End With

                                    With cphase
                                        .addRole(crole)
                                    End With
                                Catch ex As Exception
                                    '
                                    ' handelt es sich um die Kostenart Definition?
                                    ' 


                                End Try

                            ElseIf CostDefinitions.containsName(hname) Then

                                Try

                                    k = CInt(CostDefinitions.getCostdef(hname).UID)

                                    ReDim Xwerte(ende - anfang)

                                    'valueRange = .Range(zelle.Offset(0, anfang + 1), zelle.Offset(0, ende + 1))
                                    'Xwerte = valueRange.Value

                                    For m = anfang To ende
                                        Xwerte(m - anfang) = CDbl(zelle.Offset(0, m + 1).Value)
                                    Next m

                                    ccost = New clsKostenart(ende - anfang)
                                    With ccost
                                        .KostenTyp = k
                                        .Xwerte = Xwerte
                                    End With


                                    With cphase
                                        .AddCost(ccost)
                                    End With

                                Catch ex As Exception

                                End Try

                            End If


                        Else

                            chkPhase = True
                            hproj.AddPhase(cphase)

                        End If


                End Select
                'zeile = zeile + 1
            Next zelle



        End With



    End Sub


    ''' <summary>
    ''' ändert die Ressourcen Zuweisungen entsprechend den Eingaben in Editieren Ressourcen
    ''' Phase existiert und hat die gleiche Anzahl Monate: Behalten Start und Ende Datum
    ''' etwas anderes ist erst mal gar nicht erlaubt ; das wird schon durch die Protect Massnahme im Vorfeld erreicht 
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <remarks></remarks>
    Public Sub awinChangeProjFromEditRess(ByRef hproj As clsProjekt)
        Dim lastRow As Integer
        Dim rng As Excel.Range
        Dim zelle As Excel.Range
        Dim chkPhase As Boolean = True
        Dim Xwerte As Double()
        Dim crole As clsRolle
        Dim cphase As New clsPhase(hproj)
        Dim ccost As clsKostenart
        Dim phaseName As String, phaseNameID As String
        Dim anfang As Integer, ende As Integer
        Dim newProj As New clsProjekt
        Dim roleNr As Integer = 0, costNr As Integer = 0
        Dim checkliste As New SortedList(Of String, Integer)
        Dim lfdNr As Integer

        With appInstance.ActiveSheet


            lastRow = System.Math.Max(CType(.cells(2000, 1), Excel.Range).End(xlNS.XlDirection.xlUp).Row, CType(.cells(2000, 2), Excel.Range).End(xlNS.XlDirection.xlUp).Row) + 1
            rng = CType(.range(.cells(2, 1), .cells(lastRow, 1)), Excel.Range)

            For Each zelle In rng
                Select Case chkPhase
                    Case True
                        ' hier wird die Phasen Information ausgelesen

                        If Len(CType(zelle.Value, String)) > 0 Then
                            phaseName = CType(zelle.Value, String).Trim

                            ' prüfen, ob die schon mal da war 
                            If checkliste.ContainsKey(phaseName) Then
                                lfdNr = checkliste.Item(phaseName) + 1
                                checkliste.Item(phaseName) = lfdNr
                            Else
                                lfdNr = 1
                                checkliste.Add(phaseName, lfdNr)
                            End If

                            If Len(phaseName) > 0 Then

                                phaseNameID = calcHryElemKey(phaseName, False, lfdNr)
                                Try
                                    cphase = hproj.getPhaseByID(phaseNameID)
                                Catch ex As Exception

                                End Try

                                ' Auslesen der Phasen Dauer
                                anfang = cphase.relStart
                                ende = cphase.relEnde

                                chkPhase = False



                            End If

                        End If



                    Case False ' auslesen Rollen- bzw. Kosten-Information
                        ' durch EditStoreProjfor Ress wird sichergestellt, daß die 
                        ' rollen und Phasen in Ihrer Reihenfolge im Datenmodell ausgelesen werden 

                        ' hier wird die Rollen bzw Kosten Information ausgelesen
                        Dim hname As String
                        Try
                            hname = CType(zelle.Offset(0, 1).Value, String).Trim
                        Catch ex1 As Exception
                            hname = ""
                        End Try


                        If Len(hname) > 0 Then

                            '
                            ' handelt es sich um die Ressourcen Definition?
                            '
                            If RoleDefinitions.containsName(hname) Then

                                roleNr = roleNr + 1

                                Try
                                    crole = cphase.getRole(roleNr)

                                    ReDim Xwerte(ende - anfang)

                                    For m = anfang To ende

                                        Try
                                            Xwerte(m - anfang) = CDbl(zelle.Offset(0, m + 1).Value)
                                        Catch ex As Exception
                                            Xwerte(m - anfang) = 0.0
                                        End Try

                                    Next m

                                    With crole
                                        .Xwerte = Xwerte
                                    End With

                                Catch ex As Exception
                                    '
                                    ' handelt es sich um die Kostenart Definition?
                                    ' 


                                End Try

                            ElseIf CostDefinitions.containsName(hname) Then

                                costNr = costNr + 1

                                Try
                                    ccost = cphase.getCost(costNr)

                                    ReDim Xwerte(ende - anfang)

                                    For m = anfang To ende

                                        Try
                                            Xwerte(m - anfang) = CDbl(zelle.Offset(0, m + 1).Value)
                                        Catch ex As Exception
                                            Xwerte(m - anfang) = 0.0
                                        End Try

                                    Next m

                                    With ccost
                                        .Xwerte = Xwerte
                                    End With


                                Catch ex As Exception

                                End Try

                            End If


                        Else

                            chkPhase = True
                            roleNr = 0
                            costNr = 0

                        End If


                End Select

            Next zelle



        End With



    End Sub



    'Public Sub awinReadProjectTemplate(ByVal pname As String, ByVal intern As Boolean)


    '    Dim lastRow As Integer
    '    Dim rng As Excel.Range
    '    Dim zelle As Excel.Range
    '    Dim zeile As Integer, spalte As Integer
    '    Dim hproj As New clsProjektvorlage

    '    zeile = 1
    '    spalte = 1


    '    Try
    '        With appInstance.ActiveWorkbook.Worksheets("General Information")

    '            hproj.VorlagenName = CType(.cells(zeile, spalte + 1).value, String).Trim
    '            hproj.Schrift = .cells(zeile, spalte + 1).font.size
    '            hproj.Schriftfarbe = .cells(zeile, spalte + 1).font.color
    '            hproj.farbe = .cells(zeile, spalte + 1).interior.color

    '            ' earliest
    '            hproj.earliestStart = -6
    '            ' latest
    '            hproj.latestStart = 6


    '        End With
    '    Catch ex As Exception
    '        Throw New ArgumentException("Fehler beim auslesen General Information")
    '    End Try


    '    Try
    '        With appInstance.ActiveWorkbook.Worksheets("Project Needs")

    '            Dim chkPhase As Boolean = True
    '            Dim Xwerte As Double()
    '            Dim crole As clsRolle
    '            Dim cphase As New clsPhase(hproj, True)
    '            Dim ccost As clsKostenart
    '            Dim phaseName As String
    '            Dim anfang As Integer, ende As Integer
    '            Dim farbeAktuell As Object
    '            Dim r As Integer, k As Integer
    '            'Dim valueRange As Excel.Range

    '            zeile = 2

    '            lastRow = System.Math.Max(.cells(2000, 1).End(XlDirection.xlUp).row, .cells(2000, 2).End(XlDirection.xlUp).row) + 1
    '            rng = .range(.cells(2, 1), .cells(lastRow, 1))

    '            For Each zelle In rng
    '                Select Case chkPhase
    '                    Case True
    '                        ' hier wird die Phasen Information ausgelesen

    '                        If Len(CType(zelle.Value, String)) > 1 Then
    '                            phaseName = CType(zelle.Value, String).Trim

    '                            If Len(phaseName) > 0 Then

    '                                cphase = New clsPhase(hproj, True)

    '                                ' Auslesen der Phasen Dauer
    '                                anfang = 1
    '                                While zelle.Offset(0, anfang + 1).Interior.ColorIndex = -4142
    '                                    anfang = anfang + 1
    '                                End While

    '                                ende = anfang + 1
    '                                farbeAktuell = zelle.Offset(0, ende).Interior.Color
    '                                While zelle.Offset(0, ende + 1).Interior.Color = farbeAktuell
    '                                    ende = ende + 1
    '                                End While
    '                                ende = ende - 1

    '                                chkPhase = False


    '                                With cphase
    '                                    .name = phaseName
    '                                    ' Änderung 28.11.13: jetzt wird die Phasen Länge exakt bestimmt , über startoffset in Tagen und dauerinDays als Länge
    '                                    Dim startOffset As Integer = DateDiff(DateInterval.Day, StartofCalendar, StartofCalendar.AddMonths(anfang - 1))
    '                                    'Dim dauerIndays As Integer = DateDiff(DateInterval.Day, StartofCalendar.AddMonths(anfang - 1), _
    '                                    '                                                        StartofCalendar.AddMonths(ende).AddDays(-1)) + 1
    '                                    Dim dauerIndays As Integer = calcDauerIndays(StartofCalendar.AddDays(startOffset), ende - anfang + 1, True)
    '                                    .changeStartandDauer(startOffset, dauerIndays)

    '                                    .Offset = 0
    '                                End With

    '                            End If

    '                        End If



    '                    Case False ' auslesen Rollen- bzw. Kosten-Information

    '                        ' hier wird die Rollen bzw Kosten Information ausgelesen
    '                        Dim hname As String
    '                        Try
    '                            hname = CType(zelle.Offset(0, 1).Value, String).Trim
    '                        Catch ex1 As Exception
    '                            hname = ""
    '                        End Try


    '                        If Len(hname) > 0 Then

    '                            '
    '                            ' handelt es sich um die Ressourcen Definition?
    '                            '
    '                            If RoleDefinitions.Contains(hname) Then
    '                                Try
    '                                    r = RoleDefinitions.getRoledef(hname).UID

    '                                    ReDim Xwerte(ende - anfang)


    '                                    For m = anfang To ende
    '                                        Xwerte(m - anfang) = zelle.Offset(0, m + 1).Value
    '                                    Next m

    '                                    crole = New clsRolle(ende - anfang)
    '                                    With crole
    '                                        .RollenTyp = r
    '                                        .Xwerte = Xwerte
    '                                    End With

    '                                    With cphase
    '                                        .AddRole(crole)
    '                                    End With
    '                                Catch ex As Exception
    '                                    '
    '                                    ' handelt es sich um die Kostenart Definition?
    '                                    ' 


    '                                End Try

    '                            ElseIf CostDefinitions.Contains(hname) Then

    '                                Try

    '                                    k = CostDefinitions.getCostdef(hname).UID

    '                                    ReDim Xwerte(ende - anfang)

    '                                    For m = anfang To ende
    '                                        Xwerte(m - anfang) = zelle.Offset(0, m + 1).Value
    '                                    Next m

    '                                    ccost = New clsKostenart(ende - anfang)
    '                                    With ccost
    '                                        .KostenTyp = k
    '                                        .Xwerte = Xwerte
    '                                    End With


    '                                    With cphase
    '                                        .AddCost(ccost)
    '                                    End With

    '                                Catch ex As Exception

    '                                End Try

    '                            End If


    '                        Else

    '                            chkPhase = True
    '                            hproj.AddPhase(cphase)

    '                        End If


    '                End Select
    '                zeile = zeile + 1
    '            Next zelle



    '        End With
    '    Catch ex As Exception
    '        Throw New ArgumentException("Fehler in awinImportProject, Lesen Project Needs")
    '    End Try


    '    ' hier werden die mit den Phasen verbundenen Results ausgelesen ...

    '    Try
    '        With appInstance.ActiveWorkbook.Worksheets("Settings")
    '            rng = .Range("Phasen")
    '            Dim rngZeile As Excel.Range
    '            Dim lastColumn As Integer
    '            Dim resultName As String = ""
    '            Dim phaseName As String
    '            Dim tmpPhase As New clsPhase(hproj, True)
    '            Dim tmpStr() As String
    '            Dim defaultOffset As Integer


    '            Dim anzTage As Integer

    '            For Each zelle In rng

    '                Try
    '                    phaseName = zelle.Value.trim

    '                    tmpPhase = hproj.getPhase(phaseName)
    '                    defaultOffset = tmpPhase.dauerInDays
    '                Catch ex As Exception

    '                End Try

    '                If Not tmpPhase Is Nothing Then

    '                    rngZeile = rng.Rows(zelle.Row)
    '                    lastColumn = .cells(zelle.Row, 2000).End(XlDirection.xlToLeft).column

    '                    Dim specified As Boolean
    '                    For i = 4 To lastColumn

    '                        specified = False
    '                        Try
    '                            resultName = .cells(zelle.Row, i).value.ToString.Trim

    '                            tmpStr = resultName.Split(New Char() {"(", ")"}, 10)

    '                            If tmpStr.Length > 1 Then

    '                                Try
    '                                    If awinSettings.offsetEinheit = "d" Then
    '                                        anzTage = CType(tmpStr(1), Integer)
    '                                    Else
    '                                        anzTage = CType(tmpStr(1), Integer) * 7
    '                                    End If

    '                                    resultName = tmpStr(0).Trim
    '                                    specified = True
    '                                Catch ex1 As Exception
    '                                    resultName = .cells(zelle.Row, i).value.ToString.Trim
    '                                    anzTage = defaultOffset
    '                                End Try

    '                            End If


    '                            Dim tmpResult As New clsResult(parent:=tmpPhase)

    '                            If resultName.Length > 0 Then
    '                                With tmpResult
    '                                    .name = resultName
    '                                    If specified Then
    '                                        .offset = anzTage
    '                                    Else
    '                                        .offset = defaultOffset
    '                                    End If
    '                                End With

    '                                tmpPhase.AddResult(tmpResult)

    '                            End If
    '                        Catch ex As Exception

    '                        End Try
    '                    Next

    '                End If

    '            Next

    '        End With
    '    Catch ex As Exception

    '    End Try



    '    Projektvorlagen.Add(hproj)


    'End Sub

    ''' <summary>
    ''' gibt einen String zurück, z.Bsp Jan 16 - Dez 16
    ''' Inout sind zwei Datumsangaben 
    ''' </summary>
    ''' <param name="start"></param>
    ''' <param name="ende"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function textZeitraum(ByVal start As Date, ByVal ende As Date) As String
        Dim tmpResult As String = ""
        If start < ende Then
            tmpResult = start.ToString("MMM yy", repCult) & " - " & ende.ToString("MMM yy", repCult)
        ElseIf start = ende Then
            tmpResult = start.ToString("MMM yy", repCult)
        Else
            tmpResult = ende.ToString("MMM yy", repCult) & " - " & start.ToString("MMM yy", repCult)
        End If

        textZeitraum = tmpResult

    End Function

    Public Function textZeitraum(start As Integer, ende As Integer) As String
        Dim htxt As String = " "
        Dim von As Date, bis As Date

        If start <= 0 Then
            start = 1
        End If

        Try
            ' ur: 13.12.2016: für ReportGen, darf nicht aus der ProjektTafel das Raster abgelesen werden
            von = getDateofColumn(start, False)
            bis = getDateofColumn(ende, True)

            If start < ende Then
                htxt = von.ToString("MMM yy", repCult) & " - " & bis.ToString("MMM yy", repCult)
            ElseIf start = ende Then
                htxt = von.ToString("MMM yy", repCult)
            Else
                htxt = bis.ToString("MMM yy", repCult) & " - " & von.ToString("MMM yy", repCult)
            End If


            ' ''With appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT))
            ' ''    von = CDate(.cells(1, start).value)
            ' ''    bis = CDate(.cells(1, ende).value)
            ' ''    If start < ende Then
            ' ''        htxt = von.ToString("MMM yy", repCult) & " - " & bis.ToString("MMM yy", repCult)
            ' ''    ElseIf start = ende Then
            ' ''        htxt = von.ToString("MMM yy", repCult)
            ' ''    Else
            ' ''        htxt = bis.ToString("MMM yy", repCult) & " - " & von.ToString("MMM yy", repCult)
            ' ''    End If
            ' ''End With
        Catch ex As Exception

        End Try


        textZeitraum = htxt

        'textZeitraum = StartofCalendar.AddMonths(start - 1).ToString("MMM yy") & " - " & _
        '                StartofCalendar.AddMonths(ende - 1).ToString("MMM yy")
    End Function

    ''' <summary>
    ''' gibt die Rasterspalte der Projekt-Tafel zurück, in der sich das angegebene Datum befindet 
    ''' die Einstellung awinsettings.zeiteinheit gibt dabei an, ob Monate , Wochen oder Tage das Raster sind
    ''' Aktuell werden nur Monate unterstützt
    ''' </summary>
    ''' <param name="datum"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function getColumnOfDate(ByVal datum As Date) As Integer
        Dim spalte As Integer = 1

        Select Case awinSettings.zeitEinheit
            Case "PM"
                spalte = CInt(DateDiff(DateInterval.Month, StartofCalendar, datum) + 1)
            Case "PW"
                Call MsgBox("noch nicht implementiert")
                spalte = 0
            Case "PT"
                Call MsgBox("noch nicht implementiert")
                spalte = 0
        End Select

        If spalte < 1 Then
            'ur: 2019.06.03 auskommentiert versuchsweise
            'Throw New ArgumentException("Datum kann nicht vor dem Start des Kalenders liegen")
        End If

        getColumnOfDate = spalte

    End Function



    ''' <summary>
    ''' gibt das  Datum zurück, das der Rasterspalte in der Projekt-Tafel entspricht
    ''' die Einstellung awinsettings.zeiteinheit gibt dabei an, ob Monate , Wochen oder Tage das Raster sind
    ''' Aktuell werden nur Monate unterstützt
    ''' </summary>
    ''' <param name="raster"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>

    Public Function getDateofColumn(ByVal raster As Integer, ByVal isBisDate As Boolean) As Date
        Dim datum As Date = StartofCalendar

        Select Case awinSettings.zeitEinheit
            Case "PM"
                If isBisDate Then
                    Dim bisdate = datum.AddMonths(raster)
                    getDateofColumn = bisdate.AddDays(-1)
                Else
                    getDateofColumn = datum.AddMonths(raster - 1)
                End If

                'spalte = CInt(DateDiff(DateInterval.Month, StartofCalendar, datum) + 1)
            Case "PW"
                Call MsgBox("noch nicht implementiert")
                If isBisDate Then
                    Dim bisdate = datum.AddMonths((raster) * 7)
                    getDateofColumn = bisdate.AddDays(-1)
                Else
                    getDateofColumn = datum.AddDays((raster - 1) * 7)
                    'spalte = 1
                End If

            Case "PT"
                Call MsgBox("noch nicht implementiert")
                getDateofColumn = datum.AddDays(raster)
                'spalte = 1
            Case Else
                getDateofColumn = StartofCalendar

        End Select

    End Function

    Public Function getIndexBeauftragung(ByRef pHistorie As SortedList(Of Date, clsProjekt)) As Integer

        Dim abbruch As Boolean = False
        Dim tmpIndex As Integer = 0

        Dim anzSnapshots = pHistorie.Count

        ' jetzt wird der Planungs-Stand der Beauftragung gesucht 
        Do While pHistorie.ElementAt(tmpIndex).Value.Status <> ProjektStatus(PTProjektStati.beauftragt) And Not abbruch
            If tmpIndex + 1 < anzSnapshots Then
                tmpIndex = tmpIndex + 1
            Else
                abbruch = True
            End If
        Loop

        If abbruch Then
            ' es gibt keine Beauftragung ... 
            tmpIndex = -1
        Else
            ' index steht jetzt auf der Beauftragung 
        End If

        getIndexBeauftragung = tmpIndex

    End Function

    Public Function getIndexPrevFreigabe(ByRef pHistorie As SortedList(Of Date, clsProjekt),
                                         ByVal currentIndex As Integer) As Integer

        Dim tmpIndex As Integer = currentIndex - 1
        Dim abbruch As Boolean = False

        If tmpIndex < 0 Then
            tmpIndex = -1
        Else

            Do While pHistorie.ElementAt(tmpIndex).Value.Status <> ProjektStatus(PTProjektStati.beauftragt) And Not abbruch
                If tmpIndex > 0 Then
                    tmpIndex = tmpIndex - 1
                Else
                    abbruch = True
                    tmpIndex = -1
                End If
            Loop

        End If

        getIndexPrevFreigabe = tmpIndex

    End Function

    Public Function getIndexNextFreigabe(ByRef pHistorie As SortedList(Of Date, clsProjekt),
                                         ByVal currentIndex As Integer) As Integer

        Dim tmpIndex As Integer = currentIndex + 1
        Dim abbruch As Boolean = False

        If tmpIndex > pHistorie.Count - 1 Then
            tmpIndex = -1
        Else

            Do While pHistorie.ElementAt(tmpIndex).Value.Status <> ProjektStatus(PTProjektStati.beauftragt) And Not abbruch
                If tmpIndex < pHistorie.Count - 1 Then
                    tmpIndex = tmpIndex + 1
                Else
                    abbruch = True
                    tmpIndex = -1
                End If
            Loop

        End If

        getIndexNextFreigabe = tmpIndex

    End Function

    Public Function getIndexStartProject(ByRef pHistorie As SortedList(Of Date, clsProjekt)) As Integer

        ' noch nicht implementiert 
        getIndexStartProject = -1

    End Function

    Public Function getIndexEndProject(ByRef pHistorie As SortedList(Of Date, clsProjekt)) As Integer

        ' noch nicht implementiert 
        getIndexEndProject = -1

    End Function

    Public Function istLaufendesProjekt(ByRef hproj As clsProjekt) As Boolean

        Dim erg As Boolean = False

        Try
            With hproj
                If .Start <= getColumnOfDate(Date.Now) And
                    .Start + .anzahlRasterElemente - 1 >= getColumnOfDate(Date.Now) And
                    .Status <> ProjektStatus(PTProjektStati.abgebrochen) And
                    .Status <> ProjektStatus(PTProjektStati.abgeschlossen) Then
                    erg = True
                End If
            End With
        Catch ex As Exception
            erg = False
        End Try

        istLaufendesProjekt = erg

    End Function

    ''' <summary>
    ''' gibt die einzelnen im CahrtNamen codierten Bestandteile zurück 
    ''' bei pr: chartTyp: pr, typID , auswahl, qualifier, pName
    ''' bei pf: 
    ''' </summary>
    ''' <param name="chartName"></param>
    ''' <param name="chartTyp"></param>
    ''' <param name="typID"></param>
    ''' <param name="auswahl"></param>
    ''' <param name="pName"></param>
    ''' <remarks></remarks>
    Public Sub getChartKennungen(ByVal chartName As String,
                                     ByRef chartTyp As String,
                                     ByRef typID As Integer,
                                     ByRef auswahl As Integer,
                                     ByRef pName As String,
                                     ByRef rcName As String)

        Dim tmpArray() As String = chartName.Split(New Char() {CType("#", Char)})
        If tmpArray.Length >= 4 Then
            If tmpArray(0) = "pr" Then
                chartTyp = tmpArray(0)
                Try
                    typID = CInt(tmpArray(1))
                Catch ex As Exception
                    typID = -1
                End Try

                pName = tmpArray(2)
                Try
                    auswahl = CInt(tmpArray(3))
                Catch ex As Exception
                    auswahl = -1
                End Try

                ' tk 6.10.18 ergänzt, um einem Chart die Rolle / Kostenart beim Update mitgeben zu können
                Try
                    If tmpArray.Length > 4 Then
                        rcName = tmpArray(4)
                    End If
                Catch ex As Exception

                End Try

            End If
        Else
            chartTyp = ""
            typID = -1
            pName = ""
            auswahl = -1
        End If

    End Sub

    ''' <summary>
    ''' errechnet die Kennung, die dem Chart als Namen mitgegeben wird; darf nicht größer als 31 in der Länge sein; 
    ''' das erlaubt Excel.Chart.name nicht
    ''' Typ ist entweder PF für Portfolio Kennung oder PR für die Projekt Charts  
    ''' 
    ''' </summary>
    ''' <param name="typ">ist Portfolio Chart (pf) oder Projekt-Chart (pr)</param>
    ''' <param name="index">gibt den Enumeration Wert an, der den Typ des Diagramms charakterisiert</param>
    ''' <param name="mycollection">enthält die Namen der Phasen/Rollen/Kostenarten bzw den Namen des Projektes oder 
    ''' wenn es sich um mehrere Projekte handelt: "x"</param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function calcChartKennung(ByVal typ As String, ByVal index As Integer, ByVal mycollection As Collection) As String
        Dim IDkennung As String
        Dim cName As String = ""
        Dim breadcrumb As String = ""

        IDkennung = typ & "#" & index.ToString

        If typ = "pf" Then


            Try
                Select Case index
                    Case PTpfdk.Phasen

                        If mycollection.Count = PhaseDefinitions.Count Then
                            IDkennung = IDkennung & "#Alle"

                        Else

                            For i = 1 To mycollection.Count

                                cName = splitHryFullnameTo1(CStr(mycollection.Item(i)))
                                'cName = CStr(mycollection.Item(i)).Replace("#", "-")
                                ' der evtl vorhandenen Breadcrumb hat als Trennzeichen das #
                                Try
                                    IDkennung = IDkennung & "#" & cName
                                Catch ex As Exception
                                    IDkennung = IDkennung & "#"
                                End Try

                            Next

                        End If

                    Case PTpfdk.PhaseCategories

                        For i = 1 To mycollection.Count

                            cName = splitHryFullnameTo1(CStr(mycollection.Item(i)))
                            'cName = CStr(mycollection.Item(i)).Replace("#", "-")
                            ' der evtl vorhandenen Breadcrumb hat als Trennzeichen das #
                            Try
                                IDkennung = IDkennung & "#" & cName
                            Catch ex As Exception
                                IDkennung = IDkennung & "#"
                            End Try

                        Next

                    Case PTpfdk.Meilenstein

                        For i = 1 To mycollection.Count
                            ' Änderung tk 30.5.17
                            cName = splitHryFullnameTo1(CStr(mycollection.Item(i)))
                            'cName = CStr(mycollection.Item(i)).Replace("#", "-")
                            IDkennung = IDkennung & "#" & cName

                        Next


                    Case PTpfdk.MilestoneCategories
                        For i = 1 To mycollection.Count
                            ' Änderung tk 30.5.17
                            cName = splitHryFullnameTo1(CStr(mycollection.Item(i)))
                            'cName = CStr(mycollection.Item(i)).Replace("#", "-")
                            IDkennung = IDkennung & "#" & cName

                        Next

                    Case PTpfdk.Rollen

                        If mycollection.Count = RoleDefinitions.Count Then
                            IDkennung = IDkennung & "#Alle"

                        Else

                            For i = 1 To mycollection.Count
                                cName = CStr(mycollection.Item(i))
                                ' bei den cNames ist es jetzt roleUid;teamUid bzw roleUid; von daher einfach umverändert übernehmen 
                                'IDkennung = IDkennung & "#" & RoleDefinitions.getRoledef(cName).UID.ToString
                                IDkennung = IDkennung & "#" & cName
                            Next

                        End If

                    Case PTpfdk.Kosten

                        If mycollection.Count = CostDefinitions.Count Then
                            IDkennung = IDkennung & "#Alle"

                        Else

                            For i = 1 To mycollection.Count
                                cName = CStr(mycollection.Item(i))
                                IDkennung = IDkennung & "#" & CostDefinitions.getCostdef(cName).UID.ToString
                            Next

                        End If

                    Case PTpfdk.ErgebnisWasserfall

                        If mycollection.Count > 0 Then
                            cName = CStr(mycollection.Item(1))
                            IDkennung = IDkennung & "#" & cName
                        End If

                    Case PTpfdk.Budget

                        If mycollection.Count > 0 Then
                            cName = CStr(mycollection.Item(1))
                            IDkennung = IDkennung & "#" & cName
                        End If

                End Select
            Catch ex As Exception

                IDkennung = IDkennung & "#?"
            End Try



        ElseIf typ = "pr" Then

            IDkennung = IDkennung & "#" & CStr(mycollection.Item(1))
            If mycollection.Count >= 2 Then
                IDkennung = IDkennung & "#" & CStr(mycollection.Item(2))
            End If

        End If


        calcChartKennung = IDkennung


    End Function
    ''' <summary>
    ''' errechnet den für Showprojekte und AlleProjekte benötigten Schlüssel
    ''' setzt sich zusammen aus pName und variantName
    ''' </summary>
    ''' <param name="pName"></param>
    ''' <param name="variantName"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function calcProjektKey(ByVal pName As String, ByVal variantName As String) As String

        Dim trennzeichen As String = "#"

        ' Konsistenzbedingungen gewährleisten
        If IsNothing(pName) Then
            Throw New ArgumentException("Projekt-Name kann nicht Nothing sein")
        ElseIf pName.Length < 2 Then
            Throw New ArgumentException("Projekt-Name muss mindestens zwei Zeichen lang sein: " & pName)
        ElseIf IsNothing(variantName) Then
            variantName = ""
        End If

        calcProjektKey = pName & trennzeichen & variantName


    End Function

    ''' <summary>
    ''' berechnet den Key für eine customUserRole , setzt sich zusammen aus userName, Kennung CustomRole und ggf specifics, 
    ''' falls es sich um eine RessourceManager Rolle handelt 
    ''' </summary>
    ''' <param name="userName"></param>
    ''' <param name="customRoleType"></param>
    ''' <param name="specifics"></param>
    ''' <returns></returns>
    Public Function calcCurKey(ByVal userName As String, ByVal customRoleType As ptCustomUserRoles, ByVal specifics As String) As String

        Dim key As String = userName.Trim & CInt(customRoleType).ToString.Trim
        If customRoleType = ptCustomUserRoles.RessourceManager Or
           customRoleType = ptCustomUserRoles.TeamManager Or
           customRoleType = ptCustomUserRoles.InternalViewer Or
           customRoleType = ptCustomUserRoles.ExternalViewer Then

            key = key & specifics

        End If

        calcCurKey = key

    End Function


    ''' <summary>
    ''' eine Zahl wird in einen achstelligen String mit führenden Nullen gewandelt, 
    ''' damit das im Falle customTF als sortkey verwendet werden kann 
    ''' </summary>
    ''' <param name="zeile"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function calcSortKeyCustomTF(ByVal zeile As Integer) As String
        If zeile >= 2 Then
            calcSortKeyCustomTF = zeile.ToString("00000000")
        Else
            zeile = 2
            calcSortKeyCustomTF = zeile.ToString("00000000")
        End If

    End Function

    ''' <summary>
    ''' falls ein TF-key bereits existiert, wird durch Append von "x" ein neuer key erzeugt
    ''' </summary>
    ''' <param name="oldStr"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function calcSortKeyCustomTF1(ByVal oldStr As String) As String
        calcSortKeyCustomTF1 = oldStr & "x"
    End Function

    ''' <summary>
    ''' ein CustomTF Schlüssel ist immer aufgebaut zeile.toString("00000000"), evtl ergänzt um "x", um den key eindeutig zu machen 
    ''' um die Zeile herauszufinden, muss demzufolge der .-Anteil weggenommen werden und die Zeile extrahiert werden 
    ''' </summary>
    ''' <param name="key"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function getTFzeilefromSortKeyCustomTF(ByVal key As String) As Integer
        Dim tmpResult As Integer = 0
        If IsNothing(key) Then
            ' nichts tun 
        Else
            Try
                If Not key.Contains("x") Then
                    tmpResult = CInt(key)
                Else
                    Dim pPosition As Integer = key.IndexOf("x")
                    If pPosition = 0 Then
                        tmpResult = 0
                    Else
                        tmpResult = CInt(key.Substring(0, pPosition))
                    End If
                End If
            Catch ex As Exception
                tmpResult = 0
            End Try

        End If

        getTFzeilefromSortKeyCustomTF = tmpResult

    End Function

    ''' <summary>
    ''' gibt den Standard-Last Complete Session Scenario Namen des Nutzers zurück 
    ''' </summary>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function calcLastSessionScenarioName() As String
        Dim tmpResult As String = "_last Session (by " & dbUsername & ")"
        calcLastSessionScenarioName = tmpResult
    End Function

    ' tk geändert: es gibt nur noch die lastSession und eine gespeicherte Konstellation
    ' ''' <summary>
    ' ''' gibt den Standard last Editor Szenario Namen zurück 
    ' ''' </summary>
    ' ''' <returns></returns>
    ' ''' <remarks></remarks>
    'Public Function calcLastEditorScenarioName() As String
    '    Dim tmpResult As String = "_last Scenario-Editor (by " & dbUsername & ")"
    '    calcLastEditorScenarioName = tmpResult
    'End Function

    ''' <summary>
    ''' errechnet den Namen, den das Text Shape eines Projektes hat; Input ist der Projekt-Name
    ''' </summary>
    ''' <param name="pName"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function calcProjectTextShapeName(ByVal pName As String) As String
        Dim tmpResult As String = "DummyName"
        If Not IsNothing(pName) Then
            tmpResult = "t0a1" & pName
        End If
        calcProjectTextShapeName = tmpResult
    End Function

    ''' <summary>
    ''' errechnet den für Showprojekte und AlleProjekte benötigten Schlüssel
    ''' verwendet dazu die in hproj vorhandenen Attribute Name und variantName
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function calcProjektKey(ByVal hproj As clsProjekt) As String

        Dim trennzeichen As String = "#"
        With hproj

            ' Konsistenzbedingungen gewährleisten
            If IsNothing(.name) Then
                Throw New ArgumentException("Projekt-Name kann nicht Nothing sein")
            ElseIf .name.Length < 2 Then
                Throw New ArgumentException("Projekt-Name muss mindestens zwei Zeichen lang sein: " & .name)
            ElseIf IsNothing(.variantName) Then
                .variantName = ""
            End If

            calcProjektKey = .name & trennzeichen & .variantName

        End With


    End Function

    ''' <summary>
    ''' berechnet die ID für die Datenbank, bestehend aus Projektname, Variant-Name und TimeStamp
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="datum"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function calcProjektUidDB(ByVal hproj As clsProjekt, ByVal datum As Date) As String

        Dim trennzeichen As String = "#"

        With hproj

            ' Konsistenzbedingungen gewährleisten
            If IsNothing(.name) Then
                Throw New ArgumentException("Projekt-Name kann nicht Nothing sein")
            ElseIf .name.Length < 2 Then
                Throw New ArgumentException("Projekt-Name muss mindestens zwei Zeichen lang sein: " & .name)
            ElseIf IsNothing(.variantName) Then
                .variantName = ""
            End If

            If IsNothing(datum) Then
                datum = Date.Now
            End If

            calcProjektUidDB = .name & trennzeichen & .variantName & trennzeichen & datum.ToString

        End With


    End Function


    Public Function calcProjektKeyDB(ByVal pName As String, ByVal vName As String) As String

        Dim tmpName As String



        ' Konsistenzbedingungen gewährleisten
        If IsNothing(pName) Then
            Throw New ArgumentException("Projekt-Name kann nicht Nothing sein")
        ElseIf pName.Length < 2 Then
            Throw New ArgumentException("Projekt-Name muss mindestens zwei Zeichen lang sein: " & pName)
        ElseIf IsNothing(vName) Then
            vName = ""
        End If

        If vName <> "" And vName.Trim.Length > 0 Then
            tmpName = calcProjektKey(pName, vName)
        Else
            tmpName = pName
        End If

        calcProjektKeyDB = tmpName




    End Function

    ''' <summary>
    ''' gibt den Projekt-Namen zurück, der in dem Projekt-Key steckt 
    ''' </summary>
    ''' <param name="key"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function getPnameFromKey(ByVal key As String) As String
        Dim tmpStr(5) As String
        Dim trennzeichen As String = "#"
        Dim tmpValue As String = ""

        If Not IsNothing(key) Then
            If key.Trim.Length > 0 Then
                tmpStr = key.Split(New Char() {CChar(trennzeichen)}, 4)
                tmpValue = tmpStr(0)
            End If
        End If

        getPnameFromKey = tmpValue

    End Function

    ''' <summary>
    ''' gibt den Variant-Namen zurück, der in dem Projekt-Key steckt 
    ''' </summary>
    ''' <param name="key"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function getVariantnameFromKey(ByVal key As String) As String
        Dim tmpStr(5) As String
        Dim trennzeichen As String = "#"
        Dim tmpValue As String = ""

        If Not IsNothing(key) Then
            If key.Trim.Length > 0 Then
                tmpStr = key.Split(New Char() {CChar(trennzeichen)}, 4)
                If tmpStr.Length > 1 Then
                    tmpValue = tmpStr(1)

                    If IsNothing(tmpValue) Then
                        tmpValue = ""
                    End If
                End If
            End If
        End If

        getVariantnameFromKey = tmpValue

    End Function

    ''' <summary>
    ''' beschriftet ein Projekt mit seinen Phasen und / oder Meilenstein Namen
    ''' orientiert sich an dem Shape des Projektes , es wird nur beschriftet, was im Shape vorhanden ist
    ''' es kann angegeben werden, ob die Original- oder die Standard-Namen angezeigt werden sollen 
    ''' Alle Beschriftungen zusammen werden als ein zusammengesetztes Shape erzeugt
    ''' </summary>
    ''' <param name="projectShape"></param>
    ''' <param name="annotatePhases"></param>
    ''' <param name="annotateMilestones"></param>
    ''' <param name="showStdNames"></param>
    ''' <remarks></remarks>
    Public Sub annotateProject(ByVal projectShape As Excel.Shape, ByVal annotatePhases As Boolean, ByVal annotateMilestones As Boolean,
                                   ByVal showStdNames As Boolean, ByVal showAbbrev As Boolean)


        Dim shapeSammlung As Excel.ShapeRange
        Dim descriptionGruppe As Excel.ShapeRange
        Dim descriptionShape As Excel.Shape
        Dim descriptionShapeName As String = "Description#" & projectShape.Name
        ' nimmt die Namen der Shapes auf, die zur Project Description gemacht werden sollen 
        Dim arrayOfNames() As String
        Dim anzahlElements As Integer

        Dim oldAlternativeText As String
        Dim oldTitle As String
        Dim oldName As String
        Dim hproj As clsProjekt
        Dim elemShape As Excel.Shape
        Dim txtShape As Excel.Shape
        Dim top As Single, left As Single, width As Single, height As Single
        Dim worksheetShapes As Excel.Shapes
        Dim nameID As String
        Dim description As String = ""

        Dim ok As Boolean
        Dim index As Integer = 0



        With CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet)
            worksheetShapes = .Shapes
        End With

        ' prüfen , ob es bereits ein Description Shape für dieses Projekt gibt; wenn ja, dann löschen
        Try
            descriptionShape = worksheetShapes.Item(descriptionShapeName)
            If Not IsNothing(descriptionShape) Then
                descriptionShape.Delete()
            End If
        Catch ex As Exception

        End Try

        With projectShape
            oldAlternativeText = .AlternativeText
            oldTitle = .Title
            oldName = .Name
        End With

        hproj = ShowProjekte.getProject(oldName, True)

        If isSingleProjectShape(projectShape) Then

            'Call MsgBox("es gibt keine Phasen oder Meilensteine zu beschriften ...")

        Else
            Try
                Try
                    anzahlElements = projectShape.GroupItems.Count
                Catch ex As Exception
                    Call MsgBox("ProjektShape.GroupItems.Count kann nicht abgerufen werden")
                End Try

                ReDim arrayOfNames(anzahlElements - 1)

                shapeSammlung = projectShape.Ungroup()

                ' hier muss dann die Aktion passieren
                index = 0
                For Each elemShape In shapeSammlung

                    ' zurücksetzen 
                    description = ""
                    txtShape = Nothing
                    ok = False
                    nameID = ""


                    If isPhaseType(kindOfShape(elemShape)) And annotatePhases Then
                        nameID = extractName(elemShape.Name, PTshty.phaseN)
                        ok = True

                    ElseIf isMilestoneType(kindOfShape(elemShape)) And annotateMilestones Then
                        nameID = extractName(elemShape.Name, PTshty.milestoneN)
                        ok = True

                    End If

                    If nameID = rootPhaseName Then
                        ok = False
                    End If

                    ' jetzt wird das Description Shape erzeugt 
                    If ok Then
                        ' nur, wenn es entweder ein Meilenstein oder eine Phase war ... 

                        description = hproj.getBestNameOfID(nameID, showStdNames, showAbbrev)

                        top = elemShape.Top
                        left = elemShape.Left
                        width = 30
                        height = 30

                        txtShape = worksheetShapes.AddLabel(core.MsoTextOrientation.msoTextOrientationHorizontal,
                                                                left, top, width, height)

                        With txtShape
                            .TextFrame2.AutoSize = core.MsoAutoSize.msoAutoSizeShapeToFitText
                            .TextFrame2.WordWrap = core.MsoTriState.msoFalse
                            .TextFrame2.TextRange.Text = description
                            .TextFrame2.TextRange.Font.Size = hproj.Schrift - 2
                            .TextFrame2.MarginLeft = 2
                            .TextFrame2.MarginRight = 2
                            .TextFrame2.MarginTop = 0
                            .TextFrame2.MarginBottom = 0
                            .TextFrame2.VerticalAnchor = core.MsoVerticalAnchor.msoAnchorMiddle
                            .TextFrame2.HorizontalAnchor = core.MsoHorizontalAnchor.msoAnchorCenter

                            If description = "-" Then
                                .Fill.Visible = core.MsoTriState.msoFalse
                            Else
                                .Fill.Visible = core.MsoTriState.msoTrue
                                .Fill.ForeColor.RGB = RGB(255, 255, 255)
                                .Fill.Transparency = 0
                                .Fill.Solid()
                            End If


                        End With

                        ' jetzt muss das Shape noch in der Höhe richtig positioniert werden 
                        Dim diff As Single
                        Dim zeile As Integer

                        If istMeilensteinShape(elemShape) Then
                            'zeile = calcYCoordToZeile(elemShape.Top)
                            'txtShape.Top = CSng(calcZeileToYCoord(zeile)) + 1
                            txtShape.Top = elemShape.Top - txtShape.Height - 1
                            diff = (txtShape.Width - elemShape.Width) / 2
                            txtShape.Left = elemShape.Left - diff
                        Else
                            zeile = calcYCoordToZeile(elemShape.Top)
                            txtShape.Top = CSng(calcZeileToYCoord(zeile + 1)) - txtShape.Height - 1
                            'txtShape.Top = elemShape.Top + elemShape.Height
                            txtShape.Left = elemShape.Left
                        End If

                        ' jetzt wird das Shape aufgenommen 
                        arrayOfNames(index) = txtShape.Name
                        index = index + 1

                    End If

                Next

                Try
                    If index > 0 Then
                        If index < anzahlElements Then
                            anzahlElements = index
                            ReDim Preserve arrayOfNames(anzahlElements - 1)
                        End If

                        If anzahlElements > 1 Then
                            ' jetzt wird das neue zusammengesetzte Beschriftungs-Shape erzeugt ... 
                            descriptionGruppe = worksheetShapes.Range(arrayOfNames)
                            descriptionShape = descriptionGruppe.Group
                        Else
                            descriptionShape = worksheetShapes.Item(arrayOfNames(0))
                        End If

                        If Not IsNothing(descriptionShape) Then
                            With descriptionShape
                                .Name = descriptionShapeName
                                .AlternativeText = CInt(PTshty.beschriftung).ToString
                            End With
                        End If
                    End If
                Catch ex As Exception

                End Try

                ' hier muss das alte Shape wieder restauriert werden 
                projectShape = shapeSammlung.Group

                With projectShape
                    .Name = oldName
                    .AlternativeText = oldAlternativeText
                    .Title = oldTitle
                    hproj.shpUID = .ID.ToString
                End With

                ' jetzt muss das auch in der Liste Showprojekte eingetragen werden 
                ShowProjekte.AddShape(hproj.name, hproj.shpUID)

            Catch ex As Exception
                'Call MsgBox(ex.Message & vbLf & "... keine Phasen oder Meilensteine zu beschriften ...")
            End Try


        End If



    End Sub

    ''' <summary>
    ''' gibt true zurück, wenn es sich bei dem Element um einen Projekt-Meilenstein handelt 
    ''' false, sonst
    ''' </summary>
    ''' <param name="elemShape"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function istMeilensteinShape(ByVal elemShape As Excel.Shape) As Boolean

        With elemShape
            If .AlternativeText = CInt(PTshty.milestoneN).ToString Or
                .AlternativeText = CInt(PTshty.milestoneE).ToString Then
                istMeilensteinShape = True
            Else
                istMeilensteinShape = False
            End If
        End With

    End Function

    ''' <summary>
    ''' gibt true zurück, wenn es sich bei dem Element um eine Projekt-Phase handelt
    ''' false, sonst
    ''' </summary>
    ''' <param name="elemShape"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function istPhasenShape(ByVal elemShape As Excel.Shape) As Boolean

        With elemShape
            If .AlternativeText = CInt(PTshty.phase1).ToString Or
                    .AlternativeText = CInt(PTshty.phaseN).ToString Or
                    .AlternativeText = CInt(PTshty.phaseE).ToString Then
                istPhasenShape = True
            Else
                istPhasenShape = False
            End If
        End With

    End Function

    ''' <summary>
    ''' aktualisiert das ProjektInfo1 Fenster mit Profit/Loss Anzeige 
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="dbProj"></param>
    ''' <remarks></remarks>
    Public Sub updateProjectInfo1(ByVal hproj As clsProjekt, ByVal dbProj As clsProjekt)


        If Not IsNothing(formProjectInfo1) Then

            Dim lblDBVersion As String = ""
            Dim currentV As String = ""
            Dim currentDB As String = ""
            Dim pname As String = ""
            Dim budget As Double, pk As Double, sk As Double, rk As Double, erg As Double
            If Not IsNothing(dbProj) Then
                lblDBVersion = "DB (" & dbProj.timeStamp.ToShortDateString & ")"
                Call dbProj.calculateRoundedKPI(budget, pk, sk, rk, erg, True)
                currentDB = erg.ToString & " T€"
            End If

            If Not IsNothing(hproj) Then
                Call hproj.calculateRoundedKPI(budget, pk, sk, rk, erg, True)
                currentV = erg.ToString & " T€"
                pname = hproj.name
            End If

            With formProjectInfo1
                .lblProjectName.Text = pname
                .lblDBVersion.Text = lblDBVersion
                .currentForecast.Text = currentV
                .dbForecast.Text = currentDB
            End With

        End If

    End Sub

    ''' <summary>
    ''' aktualisiert bzw. zeigt das Status Fenster zur Ampel-Erläuterung eines Projektes 
    ''' </summary>
    ''' <param name="hproj">übergeben wird das betreffende Projekt</param>
    ''' <remarks></remarks>
    Public Sub updateStatusInformation(ByVal hproj As clsProjekt)

        Dim description As String

        Try

            description = hproj.ampelErlaeuterung


            If awinSettings.createIfNotThere Then
                ' prüfen, ob das Shape bereits angezeigt wird 
                Dim tstshpName = projectboardShapes.calcStatusShapeName(hproj.name, getColumnOfDate(hproj.timeStamp))
                If Not projectboardShapes.contains(tstshpName) Then
                    ' jetzt muss das Shape gezeichnet werden 
                    Dim tmpNr As Integer = 0

                    Dim formerEoU As Boolean = enableOnUpdate
                    Dim formerEE As Boolean = appInstance.EnableEvents

                    enableOnUpdate = False
                    appInstance.EnableEvents = False

                    Call zeichneStatusSymbolInPlantafel(hproj, tmpNr)


                    appInstance.EnableEvents = formerEE
                    enableOnUpdate = formerEoU

                End If
            End If

            ' tk 9.4.19 nicht zeigen 
            'With formStatus

            '    '.projectName.Text = hproj.name
            '    .projectName.Text = hproj.getShapeText

            '    '
            '    ' Änderung tk: die Zeilen, die durch CRLF getrennt sind, sollen auch so dargestellt werden 
            '    Dim tmpstr() As String = description.Split(New Char() {CChar(vbLf), CChar(vbCr)}, 100)
            '    Dim newString As String = ""
            '    If tmpstr.Length > 0 Then
            '        .bewertungsText.Lines = tmpstr
            '    Else
            '        .bewertungsText.Text = description
            '    End If


            '    If .Visible Then
            '    Else
            '        .Visible = True
            '        .Show()
            '    End If

            'End With

        Catch ex As Exception


        End Try


    End Sub


    ''' <summary>
    ''' aktualisiert die Meilenstein Information; 
    ''' </summary>
    ''' <param name="hproj">das Projekt</param>
    ''' <param name="milestoneNameID">ID des Meilensteins</param>
    ''' <remarks></remarks>
    Public Sub updateMilestoneInformation(ByVal hproj As clsProjekt, ByVal milestoneNameID As String)

        Dim cMilestone As clsMeilenstein = Nothing
        Dim bewertung As New clsBewertung
        Dim ok As Boolean = True

        Dim projektName As String = ""
        Dim explanation As String = ""
        Dim deliverables As String = ""
        Dim milestoneName As String = "-"
        Dim breadCrumb As String = "-"
        Dim dateText As String = ""
        Dim farbe As System.Drawing.Color
        Dim lfdNr As Integer
        'Dim msNr As Integer, msNr2 As Integer

        Dim elemName As String
        Dim phaseName As String = ""
        Dim phaseName2 As String = ""
        Dim found As Boolean
        Dim tryoutName As String


        Try
            projektName = hproj.name
        Catch ex As Exception

        End Try

        Try
            cMilestone = hproj.getMilestoneByID(milestoneNameID)

            ' new Code

            ' es kann sein , dass es diesen Meilenstein nicht gibt, jedenfalls nicht mit der aktuellen lfdNr
            If IsNothing(cMilestone) Then
                lfdNr = lfdNrOfElemID(milestoneNameID)
                elemName = elemNameOfElemID(milestoneNameID)
                found = False
                Do While lfdNr > 1 And Not found
                    lfdNr = lfdNr - 1
                    tryoutName = calcHryElemKey(elemName, True, lfdNr)
                    cMilestone = hproj.getMilestoneByID(tryoutName)
                    If Not IsNothing(cMilestone) Then
                        found = True
                        milestoneNameID = tryoutName
                    End If
                Loop
            End If

            If Not IsNothing(cMilestone) Then
                ok = True

                If awinSettings.showOrigName Then
                    ' es gibt jetzt dazu eine Methode - siehe weiter unten 
                    'Dim tmpNode As clsHierarchyNode
                    'tmpNode = hproj.hierarchy.nodeItem(milestoneNameID)
                    'If Not IsNothing(tmpNode) Then
                    '    milestoneName = tmpNode.origName
                    'Else
                    '    milestoneName = elemNameOfElemID(milestoneNameID)
                    'End If

                    milestoneName = cMilestone.originalName
                Else
                    milestoneName = cMilestone.name
                End If

                breadCrumb = hproj.hierarchy.getBreadCrumb(milestoneNameID).Replace("#", "-")
                lfdNr = lfdNrOfElemID(milestoneNameID)
                dateText = cMilestone.getDate.ToShortDateString

            Else
                ok = False
                milestoneName = "-"
                breadCrumb = "-"
                lfdNr = 0
                dateText = "-"
            End If

            ' Nicht ausliefern!
            ' das folgende dient auch Testzwecken ... wenn die beiden verschiedenen Arten, die Meilenstein Index Nummer zu bestimmen , 
            ' nicht übereinstimmen, wird einn  eine Fehlermeldung ausgegeben werden 

            'Try
            '    Dim cphase As clsPhase
            '    Dim parentPhaseNameID As String
            '    parentPhaseNameID = hproj.hierarchy.nodeItem(milestoneNameID).parentNodeKey
            '    cphase = hproj.getPhaseByID(parentPhaseNameID)
            '    msNr = cphase.getlfdNr(milestoneNameID)
            '    phaseName = cphase.name

            '    ' die elegantere, und neue Methode basierend auf der Hierarchie Liste
            '    msNr2 = hproj.hierarchy.nodeItem(milestoneNameID).indexOfElem
            '    phaseName2 = elemNameOfElemID(hproj.hierarchy.nodeItem(milestoneNameID).parentNodeKey)

            '    If msNr <> msNr2 Then
            '        Call MsgBox("hier stimmt was nicht: " & vbLf & msNr & " <> " & msNr2)
            '    End If

            '    If phaseName <> phaseName2 Then
            '        Call MsgBox("hier stimmt was nicht: " & vbLf & phaseName & " <> " & phaseName2)
            '    End If
            'Catch ex1 As Exception
            '    Call MsgBox("hier stimmt was nicht: (mit Fehler)" & vbLf & msNr & " <> " & msNr2 & vbLf & _
            '                phaseName & " <> " & phaseName2)
            'End Try




        Catch ex As Exception
            explanation = milestoneNameID & " existiert nicht"
            deliverables = milestoneNameID & " existiert nicht"
            ok = False
        End Try


        If ok Then

            If awinSettings.createIfNotThere Then
                ' prüfen, ob das Shape bereits angezeigt wird 
                Dim tstshpName = projectboardShapes.calcMilestoneShapeName(projektName, milestoneNameID)
                If Not projectboardShapes.contains(tstshpName) Then
                    ' jetzt muss das Shape gezeichnet werden 
                    Dim tmpNr As Integer = 1
                    Dim tmpCollection As New Collection
                    tmpCollection.Add(milestoneNameID, milestoneNameID)

                    Dim formerEoU As Boolean = enableOnUpdate
                    Dim formerEE As Boolean = appInstance.EnableEvents
                    enableOnUpdate = False
                    appInstance.EnableEvents = False

                    Call zeichneMilestonesInProjekt(hproj, tmpCollection, 4, 0, 0, False, tmpNr, False)

                    appInstance.EnableEvents = formerEE
                    enableOnUpdate = formerEoU

                End If
            End If

            If cMilestone.bewertungsListe.Count > 0 Then

                Dim hb As clsBewertung = cMilestone.bewertungsListe.ElementAt(0).Value
                farbe = System.Drawing.Color.FromArgb(CInt(hb.color))

                explanation = hb.description
                deliverables = cMilestone.getAllDeliverables


            Else

                farbe = System.Drawing.Color.FromArgb(CInt(awinSettings.AmpelNichtBewertet))
                explanation = ""
                deliverables = ""

            End If

            dateText = cMilestone.getDate.ToShortDateString


        End If

        ' tk 9.4.19 nicht mehr zeigen 
        'With formMilestone

        '    .milestone = cMilestone
        '    .curProject = hproj

        '    .projectName.Text = hproj.getShapeText
        '    .breadCrumb.Text = breadCrumb

        '    .resultDate.Text = dateText
        '    .resultName.Text = milestoneName

        '    '
        '    ' Änderung tk: die Zeilen, die durch CRLF getrennt sind, sollen auch so dargestellt werden 

        '    '' tk 29.5.16 das braucht man doch jetzt nicht mehr ..? 
        '    ''Dim tmpstr() As String
        '    ''If .rdbDeliverables.Checked Then
        '    ''    tmpstr = deliverables.Split(New Char() {CChar(vbLf), CChar(vbCr)}, 100)
        '    ''Else
        '    ''    tmpstr = explanation.Split(New Char() {CChar(vbLf), CChar(vbCr)}, 100)
        '    ''End If

        '    ''Dim newString As String = ""
        '    ''If tmpstr.Length > 0 Then
        '    ''    .bewertungsText.Lines = tmpstr
        '    ''Else
        '    Dim tmpstr() As String

        '    If .rdbDeliverables.Checked Then
        '        tmpstr = deliverables.Split(New Char() {CChar(vbLf), CChar(vbCr)}, 100)
        '    Else
        '        tmpstr = explanation.Split(New Char() {CChar(vbLf), CChar(vbCr)}, 100)
        '    End If

        '    .bewertungsText.Lines = tmpstr
        '    ''End If


        '    If .Visible Then
        '    Else
        '        .Visible = True
        '        .Show()
        '    End If

        'End With


    End Sub

    ''' <summary>
    ''' überprüft, ob sich das Shape in Breite bzw. Position verändert hat
    ''' wenn ja, werden die Phasen Daten entsprechend geändert 
    ''' </summary>
    ''' <param name="phaseShape"></param>
    ''' <remarks></remarks>
    Public Sub updatePhaseStartDuration(ByVal phaseShape As Excel.Shape)

        Dim tmpstr() As String
        Dim projectName As String
        Dim phaseNameID As String
        Dim phaseNr As Integer
        Dim cPhase As clsPhase
        Dim zeilenoffset As Integer
        Dim oldType As String

        Dim ok As Boolean = True
        Dim hproj As New clsProjekt

        'Dim top1 As Double, top2 As Double, left1 As Double, left2 As Double
        'Dim ld As Double

        Dim phasenStart As Integer
        Dim phasenDauer As Integer
        Dim actionNeeded As Boolean = False

        Dim sollLeft As Double, sollWidth As Double, sollTop As Double, sollHeight As Double
        Dim istLeft As Double, istWidth As Double

        Dim projectShapes As Excel.Shapes = CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Shapes
        Dim suchstring = phaseShape.Name

        Dim projectShape As Excel.ShapeRange, shapeSammlung As Excel.ShapeRange
        Dim pShape As Excel.Shape


        With phaseShape

            istLeft = .Left
            istWidth = .Width

            tmpstr = .Name.Split(New Char() {CChar("#")}, 10)
            projectName = tmpstr(0)
            oldType = .AlternativeText

        End With

        Try
            hproj = ShowProjekte.getProject(projectName)
        Catch ex As Exception
            hproj = Nothing
            ok = False
        End Try




        If ok Then



            cPhase = New clsPhase(hproj)
            Try
                phaseNameID = tmpstr(1).Trim
                cPhase = hproj.getPhaseByID(phaseNameID)

                ' jetzt muss geprüft werden, ob sich die Start-Position, Länge oder Endposition geändert hat 

                If awinSettings.drawphases Or hproj.extendedView Then

                    projectShape = projectShapes.Range(projectName)
                    shapeSammlung = projectShape.Ungroup()

                    ' muss hier gemacht werden, weil die Koordinaten andere sind, wenn das Shape noch gruppiert ist 
                    With phaseShape

                        istLeft = .Left
                        istWidth = .Width

                    End With


                    phaseNr = CInt(tmpstr(2))
                    zeilenoffset = 0
                    Call hproj.calculateShapeCoord(phaseNr, zeilenoffset, sollTop, sollLeft, sollWidth, sollHeight)

                    'Dim korrfaktorleft As Double = istLeft - sollLeft
                    'Dim korrfakttorwidth As Double = istWidth - sollWidth
                    'Dim korr1 As Double = istLeft / sollLeft
                    'Dim korr2 As Double = istWidth / sollWidth
                    '' ggf Height und Top anpassen 

                    'sollLeft = istLeft
                    'sollWidth = istWidth
                    With phaseShape

                        If .Height <> sollHeight Then
                            .Height = CSng(sollHeight)
                        End If

                        If .Top <> sollTop Then
                            .Top = CSng(sollTop)
                        End If

                    End With

                    ' jetzt wird wieder regruppiert
                    pShape = shapeSammlung.Regroup
                    With pShape

                        .Name = projectName
                        .AlternativeText = oldType
                        hproj.shpUID = .ID.ToString

                    End With

                    ' jetzt muss das auch in der Liste Showprojekte eingetragen werden 
                    ShowProjekte.AddShape(projectName, hproj.shpUID)


                Else
                    'Call cPhase.calculateLineCoord(hproj.tfZeile, 1, 1, top1, left1, top2, left2, ld)
                    Call cPhase.calculatePhaseShapeCoord(sollTop, sollLeft, sollWidth, sollHeight)
                    'sollLeft = left1
                    'sollWidth = left2 - left1
                    'sollTop = top1 - boxHeight * 0.3 * 0.5
                End If

                If System.Math.Abs(sollLeft - istLeft) > 0.5 Or
                    System.Math.Abs(sollWidth - istWidth) > 0.5 Then
                    ' dann muss der Start bzw. die Duration geändert werden  

                    phasenStart = CInt(365 * istLeft / (12 * boxWidth)) - CInt(DateDiff(DateInterval.Day, StartofCalendar, hproj.startDate))
                    If phasenStart < 0 Then
                        phasenStart = 0
                    End If

                    phasenDauer = CInt(365 * (istLeft + istWidth) / (12 * boxWidth)) - CInt(DateDiff(DateInterval.Day, StartofCalendar, hproj.startDate)) - phasenStart

                    Call cPhase.changeStartandDauer(phasenStart, phasenDauer)
                    actionNeeded = True
                    ' dann der Ordnung halber auf die Soll-Werte setzen 

                    With phaseShape
                        .Top = CSng(sollTop)
                    End With



                Else
                    ' dann der Ordnung halber auf die Soll-Werte setzen 

                    If Not (awinSettings.drawphases Or hproj.extendedView) Then

                        With phaseShape

                            .Left = CSng(sollLeft)
                            .Width = CSng(sollWidth)
                            .Top = CSng(sollTop)

                        End With

                    End If

                End If


            Catch ex As Exception
                phaseNameID = ""
                ok = False
            End Try


        Else
            'Call MsgBox("keine Information abrufbar ...")
        End If

        If actionNeeded Then
            Call awinNeuZeichnenDiagramme(1)
        End If




    End Sub


    'Public Sub updatePhaseInformation(ByVal phaseShape As Excel.Shape)

    '    Dim tmpstr() As String
    '    Dim projectName As String
    '    Dim phaseName As String
    '    Dim cPhase As clsPhase

    '    Dim ok As Boolean = True
    '    Dim hproj As New clsProjekt

    '    Dim phaseStartdate As Date
    '    Dim phaseEnddate As Date
    '    Dim phaseDauerDays As Integer



    '    With phaseShape

    '        tmpstr = .Name.Split(New Char() {CChar("#")}, 10)
    '        projectName = tmpstr(0)

    '    End With

    '    Try
    '        hproj = ShowProjekte.getProject(projectName)
    '    Catch ex As Exception
    '        hproj = Nothing
    '        ok = False
    '    End Try

    '    If ok Then

    '        cPhase = New clsPhase(hproj)
    '        Try
    '            phaseName = tmpstr(1).Trim
    '            cPhase = hproj.getPhase(phaseName)
    '            'phaseStartdate = hproj.startDate.AddMonths(cPhase.relStart - 1)

    '            phaseStartdate = cPhase.getStartDate
    '            phaseEnddate = cPhase.getEndDate
    '            phaseDauerDays = cPhase.dauerInDays


    '            With formPhase

    '                If specialListofPhases.Contains(phaseName) Then

    '                    .projectName.Text = projectName
    '                    .phaseName.Text = phaseName
    '                    .Height = 440
    '                    .lessonsLearnedControl.Visible = True
    '                    .erlaeuterung.Visible = True
    '                    .erlaeuterung.Text = " ... hier werden die Prämissen angezeigt bzw. verändert "
    '                    .explSonderabl.Text = "Sonderabläufe der Phase " & phaseName & _
    '                        ", Projekt " & projectName
    '                    .explEnabler.Text = "Enabler der Phase " & phaseName & _
    '                        ", Projekt " & projectName
    '                    .explRisiken.Text = "Zusatzrisiken der Phase " & phaseName & _
    '                        ", Projekt " & projectName

    '                    .phaseStart.Text = phaseStartdate.ToShortDateString
    '                    .phaseStart.TextAlign = HorizontalAlignment.Left

    '                    .phaseEnde.Text = phaseEnddate.ToShortDateString
    '                    .phaseEnde.TextAlign = HorizontalAlignment.Right

    '                    .phaseDauer.Text = phaseDauerDays.ToString & " Tage"
    '                    .phaseDauer.TextAlign = HorizontalAlignment.Center


    '                    If .Visible Then
    '                    Else
    '                        .Visible = True
    '                        .Show()
    '                    End If


    '                Else

    '                    .projectName.Text = projectName
    '                    .phaseName.Text = phaseName
    '                    .Height = 220
    '                    .erlaeuterung.Visible = False

    '                    .phaseStart.Text = phaseStartdate.ToShortDateString
    '                    .phaseStart.TextAlign = HorizontalAlignment.Left

    '                    .phaseEnde.Text = phaseEnddate.ToShortDateString
    '                    .phaseEnde.TextAlign = HorizontalAlignment.Right

    '                    .phaseDauer.Text = phaseDauerDays.ToString & " Tage"
    '                    .phaseDauer.TextAlign = HorizontalAlignment.Center

    '                    If .Visible Then
    '                    Else
    '                        .Visible = True
    '                        .Show()
    '                    End If


    '                End If


    '            End With


    '        Catch ex As Exception
    '            phaseName = ""
    '            ok = False
    '        End Try


    '    Else
    '        'Call MsgBox("keine Information abrufbar ...")
    '    End If






    'End Sub

    ''' <summary>
    ''' aktualisiert die Phasen-Information zu dem Projekt; 
    ''' wenn die Phase nicht existiert, werden  
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="phaseNameID"></param>
    ''' <remarks></remarks>
    Public Sub updatePhaseInformation(ByVal hproj As clsProjekt, phaseNameID As String)

        Dim projectName As String = hproj.name
        Dim lfdNr As Integer
        Dim elemName As String
        Dim tryoutName As String
        Dim found As Boolean
        Dim cPhase As clsPhase

        Dim ok As Boolean = True

        Dim phaseName As String = "-"
        Dim breadCrumb As String = "-"
        Dim startdateText As String = "-"
        Dim enddateText As String = "-"
        Dim dauerText = "-"


        Try
            cPhase = hproj.getPhaseByID(phaseNameID)
            ' es kann sein , dass es diese Phase nicht gibt, jedenfalls nicht mit der aktuellen lfdNr
            If IsNothing(cPhase) Then
                lfdNr = lfdNrOfElemID(phaseNameID)
                elemName = elemNameOfElemID(phaseNameID)
                found = False
                Do While lfdNr > 1 And Not found
                    lfdNr = lfdNr - 1
                    tryoutName = calcHryElemKey(elemName, False, lfdNr)
                    cPhase = hproj.getPhaseByID(tryoutName)
                    If Not IsNothing(cPhase) Then
                        found = True
                        phaseNameID = tryoutName
                    End If
                Loop
            End If

            If Not IsNothing(cPhase) Then
                ok = True
                If awinSettings.showOrigName Then
                    ' Änderung tk 6.2.16 es gibt dazu jetzt eine Methode - siehe weiter unten 
                    'Dim tmpNode As clsHierarchyNode
                    'tmpNode = hproj.hierarchy.nodeItem(cPhase.nameID)
                    'If Not IsNothing(tmpNode) Then
                    '    phaseName = tmpNode.origName
                    'Else
                    '    phaseName = elemNameOfElemID(phaseNameID)
                    'End If
                    phaseName = cPhase.originalName

                Else
                    phaseName = elemNameOfElemID(phaseNameID)
                End If

                breadCrumb = hproj.hierarchy.getBreadCrumb(phaseNameID).Replace("#", "-")
                lfdNr = lfdNrOfElemID(phaseNameID)
                startdateText = cPhase.getStartDate.ToShortDateString
                enddateText = cPhase.getEndDate.ToShortDateString
                dauerText = cPhase.dauerInDays.ToString & " Tage"

            Else
                ok = False
                phaseName = "-"
                breadCrumb = "-"
                lfdNr = 0
                startdateText = "-"
                enddateText = "-"
                dauerText = "-"
            End If



        Catch ex As Exception
            phaseName = ""
            ok = False
        End Try


        If ok Then
            If awinSettings.createIfNotThere And Not (awinSettings.drawphases Or hproj.extendedView) Then
                ' prüfen, ob das Shape bereits angezeigt wird 
                Dim tstshpName = projectboardShapes.calcPhaseShapeName(projectName, phaseNameID)
                If Not projectboardShapes.contains(tstshpName) Then
                    ' jetzt muss das Shape gezeichnet werden 
                    Dim tmpNr As Integer = 1
                    Dim tmpCollection As New Collection
                    tmpCollection.Add(phaseNameID, phaseNameID)

                    Dim formerEoU As Boolean = enableOnUpdate
                    Dim formerEE As Boolean = appInstance.EnableEvents

                    enableOnUpdate = False
                    appInstance.EnableEvents = False

                    Call zeichnePhasenInProjekt(hproj, tmpCollection, False, tmpNr)

                    appInstance.EnableEvents = formerEE
                    enableOnUpdate = formerEoU

                End If
            End If
        End If



        ' tk 9.4.19 nicht mehr zeigen 
        'With formPhase

        '    .phaseNameID = phaseNameID
        '    .curProject = hproj

        '    .projectName.Text = hproj.getShapeText
        '    .breadCrumb.Text = breadCrumb

        '    .phaseName.Text = phaseName


        '    .phaseStart.Text = startdateText
        '    .phaseStart.TextAlign = HorizontalAlignment.Left

        '    .phaseEnde.Text = enddateText
        '    .phaseEnde.TextAlign = HorizontalAlignment.Right

        '    .phaseDauer.Text = dauerText
        '    .phaseDauer.TextAlign = HorizontalAlignment.Center

        '    If .Visible Then
        '    Else
        '        .Visible = True
        '        .Show()
        '    End If



        'End With


    End Sub

    ''' <summary>
    ''' bringt eine Liste von Phasen Namen zurück, die in den beiden Projekten einander identisch sind 
    ''' Wenn die Collection leer ist, dann unterscheiden sich beide Projekte in allen Phasen 
    ''' </summary>
    ''' <param name="hproj">Projekt 1</param>
    ''' <param name="cproj">Projekt 2</param>
    ''' <returns>Liste von Phasen Namen, die identisch sind </returns>
    ''' <remarks></remarks>
    Public Function getPhasenUnterschiede(ByVal hproj As clsProjekt, ByVal cproj As clsProjekt) As Collection
        Dim noColorCollection As New Collection
        Dim hphase As clsPhase, cphase As clsPhase
        Dim phaseNameID As String


        For p = 1 To hproj.CountPhases

            Try
                If p = 1 Then
                    hphase = hproj.getPhase(1)
                    cphase = cproj.getPhase(1)

                    If hphase.startOffsetinDays = cphase.startOffsetinDays And
                            hphase.dauerInDays = cphase.dauerInDays Then
                        Try
                            ' in diesem Fall müssen beide Phase(1) Namen, die ja evtl unterschiedlich sind, aufgenommen werden 
                            ' 'nderung 13.4.15 jetzt muss das nur noch einmal aufgenommen werden ..., da die Root Phase jetzt immer gleich heisst
                            'noColorCollection.Add(hphase.name, hphase.name)
                            noColorCollection.Add(cphase.nameID, cphase.nameID)
                        Catch ex As Exception

                        End Try
                    End If
                Else

                    hphase = hproj.getPhase(p)
                    phaseNameID = hphase.nameID

                    Try
                        cphase = cproj.getPhaseByID(phaseNameID)

                        If hphase.startOffsetinDays = cphase.startOffsetinDays And
                            hphase.dauerInDays = cphase.dauerInDays Then
                            Try
                                noColorCollection.Add(phaseNameID, phaseNameID)
                            Catch ex As Exception

                            End Try
                        End If
                    Catch ex As Exception
                        ' in diesem Fall gibt es die Phase in hproj, nicht aber in cproj ... 
                        ' das heisst, es muss farbig gezeichnet werden ... also nicht in NoColorCollection aufnehmen 
                    End Try
                End If

            Catch ex As Exception
                ' in diesem Fall ist gar nichts zu tun ... 
            End Try


        Next

        getPhasenUnterschiede = noColorCollection


    End Function

    ''' <summary>
    ''' speichert die aktuelle Konstellation in AlleProjekte in eine Konstellation
    ''' wenn die fullProjectNames vom Typ Collection übergeben wird, dann wird die hergenommen, um die Constellation aufzubauen
    ''' wenn takeWhat angegeben wird (vom Typ Enumeration ptSzenarioConsider) dann wird das entsprechend dargestellt 
    ''' </summary>
    ''' <param name="constellationName"></param>
    ''' <remarks></remarks>
    Public Sub storeSessionConstellation(ByVal constellationName As String,
                                         Optional ByVal fullProjectNames As SortedList(Of String, String) = Nothing,
                                         Optional ByVal takeWhat As Integer = ptSzenarioConsider.all)

        Dim newC As clsConstellation

        ' es soll nur dann etwas gemacht werden, wenn AlleProjekte überhaupt Projekte enthält ... 

        If AlleProjekte.Count = 0 Then
            ' nichts tun 
        Else

            ' prüfen, ob diese Constellation bereits existiert ..
            If projectConstellations.Contains(constellationName) Then

                Try
                    projectConstellations.Remove(constellationName)
                Catch ex As Exception

                End Try

            End If


            newC = New clsConstellation(projektListe:=AlleProjekte,
                                            fullProjectNames:=Nothing,
                                            cName:=constellationName,
                                            takeWhat:=takeWhat)


            Try
                projectConstellations.Add(newC)

            Catch ex As Exception
                Call MsgBox("Fehler bei Add projectConstellations in awinStoreConstellations")
            End Try

        End If





    End Sub

    ''' <summary>
    ''' aktiviert die angegebene Projekt-Variante und zeichnet das entsprechende Shape in der Projekt-Tafel 
    ''' selektiert ggf das Shape, um die Aktualisierung gleich durchzuführen 
    ''' wenn replaceAnyhow, dann wird auf alle Fälle ersetzt, andernfalls nur, wenn der Varianten-Name nicht schon geladen ist
    ''' </summary>
    ''' <param name="pname"></param>
    ''' <param name="newVariant"></param>
    ''' <param name="selectIT" >gibt an, ob das Shape gleich selektiert werden soll</param>
    ''' <param name="replaceAnyhow">gibt an, ob die Ersetzung auf alle Fälle erfolgen soll oder nur wenn nicht diese Variante 
    ''' bereits in Showprojekte geladen ist </param>
    ''' <param name="tfzeile">gibt an, ab welcher Zeile auf der Projekttafel versucht werden soll, zu zeichnen
    ''' </param>
    ''' <remarks></remarks>
    Sub replaceProjectVariant(ByVal pname As String, ByVal newVariant As String,
                              ByVal selectIT As Boolean, ByVal replaceAnyhow As Boolean,
                              ByVal tfzeile As Integer)

        Dim newProj As clsProjekt
        Dim hproj As clsProjekt
        Dim key As String = calcProjektKey(pname, newVariant)

        'Dim tfzeile As Integer = 0
        'Dim projectshape As Excel.ShapeRange

        Dim phaseList As New Collection
        Dim milestoneList As New Collection


        ' gibt es die neue Variante überhaupt ? 
        If AlleProjekte.Containskey(key) Then
            newProj = AlleProjekte.getProject(key)

            ' jetzt muss die bisherige Variante aus Showprojekte rausgenommen werden ..
            If ShowProjekte.contains(pname) Then
                hproj = ShowProjekte.getProject(pname)

                ' welche Phasen werden angezeigt , welche Meilensteine werden angezeigt ? 
                phaseList = projectboardShapes.getPhaseList(pname)
                milestoneList = projectboardShapes.getMilestoneList(pname)

                ' prüfen, ob es überhaupt eine andere Variante ist 
                ' Änderung 09.10.14: das sollte dann ein Abbruch-Kriterium sein, wenn nicht ohnehin ersetzt werden soll 
                ' denn wenn das Projekt aus der Datenbank neu geladen wird, kann es ggf unterschiedlich sein; 
                ' also sollte es bei replaceAnyhow auf alle Fälle geladen werden 
                If hproj.variantName = newVariant And Not replaceAnyhow Then
                    Exit Sub
                End If

                ' bestimme die bisher angezeigten Phasen und Meilensteine 


                tfzeile = hproj.tfZeile

                ' tk/ur : sicherstellen, dass die neue Variante in der gleichen Art(extendedView) angezeigt wird wie die 
                ' bisherige Variante 
                newProj.extendedView = hproj.extendedView

                ' die Darstellung in der Projekt-Tafel löschen
                Call clearProjektinPlantafel(pname)

                ' Änderung tk 4.7.15 erst clear auf Tafel, dann Remove aus Showprojekte 
                ' andernfalls macht der Clear mit Röntgen-Blick Schwierigkeiten 
                ' Projekt aus Showprojekte rausnehmen
                ShowProjekte.Remove(pname)

            End If


            ' die  Variante wird aufgenommen
            ShowProjekte.Add(newProj)


            ' neu zeichnen des Projekts 
            Dim tmpCollection As New Collection
            Call ZeichneProjektinPlanTafel(tmpCollection, newProj.name, tfzeile, phaseList, milestoneList)

            If selectIT Then

                Try
                    CType(appInstance.Workbooks.Item(myProjektTafel).Worksheets(arrWsNames(ptTables.MPT)), Excel.Worksheet).Shapes.Item(newProj.name).Select()
                Catch ex As Exception

                End Try

            End If

        Else
            'Throw New ArgumentException("Projektvariante existiert nicht")
        End If





    End Sub



    ''' <summary>
    ''' überprüft, ob die Eingabe eine Dezimal Zahl > 0 ist 
    ''' </summary>
    ''' <param name="selrange"></param>
    ''' <remarks></remarks>
    Private Sub InputZahlValidationforRange(ByRef selrange As xlNS.Range)

        With selrange.Validation
            .Delete()
            .Add(Type:=xlNS.XlDVType.xlValidateDecimal, AlertStyle:=xlNS.XlDVAlertStyle.xlValidAlertStop,
                 Operator:=xlNS.XlFormatConditionOperator.xlGreaterEqual, Formula1:="0")
            .IgnoreBlank = True
            .InCellDropdown = True
            .InputTitle = ""
            .ErrorTitle = ""
            .InputMessage = ""
            .ErrorMessage = "bitte nur Zahlen >= 0 eingeben"
            .ShowInput = True
            .ShowError = True
        End With

    End Sub


    '
    Private Sub InputValidationforRange(ByRef selrange As xlNS.Range, ByVal stage As Integer, showvalidation As Boolean)

        ' Diese Subroutine erstellt ein Dropdownliste für die Felder von selrange mit den Phasen und Rollen als Auswahl
        ' für stage = 1: Rollen-Kostenarten-Liste

        ' für stage = 2: Phasen-Liste

        Dim inputstr As String = " ", iTitle As String = " ", eMessage As String = " "
        Dim i As Integer
        Dim wasTrue As Boolean

        wasTrue = False


        If appInstance.Application.EnableEvents = True Then
            wasTrue = True
            appInstance.Application.EnableEvents = False
        End If

        If showvalidation = True Then

            If stage = 1 Then
                'Rollen in die Auswahlliste aufnehmen
                inputstr = RoleDefinitions.getRoledef(1).name
                For i = 2 To RoleDefinitions.Count
                    inputstr = inputstr & ";" & RoleDefinitions.getRoledef(i).name
                Next i
                'Kostenarten zur Auswahlliste hinzufügen
                For i = 2 To CostDefinitions.Count - 1
                    inputstr = inputstr & ";" & CostDefinitions.getCostdef(i).name
                Next i
                iTitle = "Rollen/Kostenarten"
                eMessage = "nur Rollen/Kostenarten aus der Liste sind zugelassen ! "
            ElseIf stage = 2 Then
                ' Phasen in die Auswahlliste aufnehmen
                inputstr = PhaseDefinitions.getPhaseDef(1).name
                For i = 2 To PhaseDefinitions.Count
                    inputstr = inputstr & ";" & PhaseDefinitions.getPhaseDef(i).name
                Next
                iTitle = "Phasen"
                eMessage = "nur Phasen aus der Liste sind zugelassen ! "
            End If


            With selrange.Validation
                .Delete()
                .Add(Type:=xlNS.XlDVType.xlValidateList, AlertStyle:=xlNS.XlDVAlertStyle.xlValidAlertStop, Operator:=
                           xlNS.XlFormatConditionOperator.xlBetween, Formula1:=inputstr)
                .IgnoreBlank = True
                .InCellDropdown = True
                .InputTitle = iTitle
                .ErrorTitle = "Fehler"
                .InputMessage = "bitte auswählen"
                .ErrorMessage = eMessage
                .ShowInput = True
                .ShowError = True
            End With

        Else
            With selrange.Validation
                .Delete()
            End With
            selrange.Locked = True
        End If

        If wasTrue Then
            appInstance.Application.EnableEvents = True
        End If

    End Sub

    ''' <summary>
    ''' bestimmt die Art des Shapes, ob es ein Projekt, Phasen, Meilenstein, Status oder
    ''' Dependency Shape ist 
    ''' </summary>
    ''' <param name="shape"></param>
    ''' <returns>gibt den Wert gemäß Enumeration PTshty zurück</returns>
    ''' <remarks></remarks>
    Public Function kindOfShape(ByVal shape As Excel.Shape) As Integer

        Dim tmpValue As Integer = -1


        With shape

            If CBool(.HasChart) Then
                tmpValue = -999
            Else

                Try
                    If .AlternativeText.Length > 0 Then
                        tmpValue = CInt(.AlternativeText)
                    End If
                Catch ex As Exception

                End Try

            End If


        End With

        kindOfShape = tmpValue

    End Function

    ''' <summary>
    ''' gibt aus dem String Visbo Center 1#Visbo Center 2#Visbo Center 3 eine Collection zurück, in der alle durch # getrennten Einträge enthalten sind 
    ''' </summary>
    ''' <param name="dbNames"></param>
    ''' <returns></returns>
    Public Function getPossibleVCNames(ByVal dbNames As String) As Collection
        Dim resultCollection As New Collection

        If Not IsNothing(dbNames) Then
            Dim tmpNames() As String = dbNames.Split(New Char() {CChar("#")})

            For Each tmpName As String In tmpNames
                If Not resultCollection.Contains(tmpName) Then
                    resultCollection.Add(tmpName, tmpName)
                End If
            Next
        End If

        getPossibleVCNames = resultCollection
    End Function

    ''' <summary>
    ''' extrahiert den Projekt-, Phasen- Namen bzw. die Meilenstein Nummer
    ''' je nachdem was als type angegeben wurde 
    ''' </summary>
    ''' <param name="shapeName"></param>
    ''' <param name="type">kann einer der ptshty Enumeration Werte sein</param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function extractName(ByVal shapeName As String, ByVal type As Integer) As String

        Dim shpNameParts() As String
        Dim tmpName As String = ""

        shpNameParts = shapeName.Split(New Char() {CChar("#")}, 5)

        If isProjectType(type) Or type = CInt(PTshty.status) Then

            tmpName = shpNameParts(0)

        ElseIf type = PTshty.phaseE Or type = PTshty.phaseN Or type = PTshty.phase1 Then

            ' ergänzt tk/28.9.15 wg Fehler Beschriften
            If shpNameParts.Length > 1 Then
                tmpName = shpNameParts(1)
            Else
                tmpName = rootPhaseName
            End If


        ElseIf type = PTshty.milestoneE Or type = PTshty.milestoneN Then

            ' Änderung tk 17.4. Meilenstein - Name wird genauso extrahiert wie Phasen-Name
            tmpName = shpNameParts(1)

            ' alter Code
            'msNameParts = shpNameParts(2).Split(New Char() {CChar("M")}, 2)
            'tmpName = msNameParts(1)

        End If

        extractName = tmpName

    End Function


    ''' <summary>
    ''' gibt zurück, ob es sich bei dem angegebenen Typ um einen Projekt-Typ handelt
    ''' </summary>
    ''' <param name="type"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function isProjectType(ByVal type As Integer) As Boolean

        If type = PTshty.projektE Or type = PTshty.projektN Or type = PTshty.projektC Or type = PTshty.projektL Then
            isProjectType = True
        Else
            isProjectType = False
        End If

    End Function

    ''' <summary>
    ''' gibt zurück, ob es sich bei dem angegebenen Shape um einen Meilenstein handelt 
    ''' </summary>
    ''' <param name="type"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function isMilestoneType(ByVal type As Integer) As Boolean

        If type = PTshty.milestoneN Or type = PTshty.milestoneE Then
            isMilestoneType = True
        Else
            isMilestoneType = False
        End If

    End Function

    ''' <summary>
    ''' gibt zurück, ob es sich bei dem angegebenen Shape um eine Phase handelt 
    ''' </summary>
    ''' <param name="type"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function isPhaseType(ByVal type As Integer) As Boolean

        If type = PTshty.phase1 Or type = PTshty.phaseE Or type = PTshty.phaseN Then
            isPhaseType = True
        Else
            isPhaseType = False
        End If

    End Function

    ''' <summary>
    ''' gibt true zurück , wenn es sich um ein einzelnes , d.h nicht gruppiertes Projekt-Shape handelt
    ''' false in allen anderen Fällen
    ''' </summary>
    ''' <param name="shpElement"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function isSingleProjectShape(ByVal shpElement As Excel.Shape) As Boolean

        Dim tmpErg As Boolean = False

        With shpElement
            If .AlternativeText = CInt(PTshty.projektL).ToString Then
                tmpErg = True
            ElseIf .AutoShapeType = core.MsoAutoShapeType.msoShapeRoundedRectangle Then
                If .AlternativeText = CInt(PTshty.projektN).ToString Then
                    tmpErg = True
                End If
            End If
        End With

        isSingleProjectShape = tmpErg

    End Function

    ''' <summary>
    ''' gibt für das Projekt zurück, ob es in dem angegebenen Zeitraum liegt oder nicht 
    ''' wenn kein Zeitraum angegeben ist, wird true zurürkgegeben 
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function projectWithinTimeFrame(ByVal hproj As clsProjekt) As Boolean
        Dim within As Boolean = False

        Dim startM As Integer = getColumnOfDate(hproj.startDate)
        Dim endM As Integer = getColumnOfDate(hproj.endeDate)

        Dim relStart As Integer = 1
        Dim relEnde As Integer = relStart + (endM - startM)

        within = phaseWithinTimeFrame(hproj.Start, relStart, relEnde,
                                       showRangeLeft, showRangeRight)

        projectWithinTimeFrame = within
    End Function

    ''' <summary>
    ''' gibt für die Phase zurück, ob Sie in dem angegebenen Zeitraum liegt oder nicht
    ''' wenn kein Timeframe definiert ist, dann wird true zurückgegeben  
    ''' wenn completeWithin angegeben ist, dann wird nur true zurückgegeben, wenn die Phase vollständig im Zeitraum liegt 
    ''' </summary>
    ''' <param name="projektstart">Monat, in dem das Projekt startet</param>
    ''' <param name="relstart">Relativer Monats-Index Phasenstart</param>
    ''' <param name="relEnde">Relative Monats-Index Phasenende</param>
    ''' <param name="von">Monats-Index des linken Randes</param>
    ''' <param name="bis">Monats-Index des rechten Randes</param>
    ''' <returns>true: wenn die Phase diesen Zeitraum berührt
    ''' false: wenn nicht</returns>
    ''' <remarks></remarks>
    Public Function phaseWithinTimeFrame(ByVal projektstart As Integer, ByVal relStart As Integer, ByVal relEnde As Integer,
                                             ByVal von As Integer, ByVal bis As Integer,
                                             Optional completeWithin As Boolean = False) As Boolean

        Dim within As Boolean = False

        If completeWithin Then
            If von = 0 And bis = 0 Then
                ' wenn kein Zeitraum definiert ist, soll true zurückgegeben werden
                within = True
            Else
                If (projektstart + relStart - 1 >= von) And (projektstart + relEnde - 1 <= bis) Then
                    ' dann liegt die Phase vollständig innerhalb des betrachteten Zeitraums 
                    within = True
                Else
                    within = False
                End If
            End If
        Else
            If von = 0 And bis = 0 Then
                ' wenn kein Zeitraum definiert ist, soll true zurückgegeben werden
                within = True
            Else
                If (projektstart + relStart - 1 > bis) Or (projektstart + relEnde - 1 < von) Then
                    ' dann liegt die Phase ausserhalb des betrachteten Zeitraums 
                    within = False
                Else
                    within = True
                End If
            End If
        End If



        phaseWithinTimeFrame = within

    End Function

    ''' <summary>
    ''' gibt für das angegebene Datum zurück, ob es in dem angegebenen Zeitraum liegt oder nicht 
    ''' wenn kein Zeitraum definiert ist, wird true zurückgegeben 
    ''' </summary>
    ''' <param name="msDate">Datum</param>
    ''' <param name="von">Monats-Index des linken Randes</param>
    ''' <param name="bis">Monats-Index des rechten Randes</param>
    ''' <returns>true: wenn das Datum innerhalb liegt
    ''' false: sonst</returns>
    ''' <remarks></remarks>
    Public Function milestoneWithinTimeFrame(ByVal msDate As Date,
                                                 ByVal von As Integer, ByVal bis As Integer) As Boolean

        Dim within As Boolean = False

        If von = 0 And bis = 0 Then
            within = True
        Else
            If DateDiff(DateInterval.Day, StartofCalendar, msDate) >= 0 Then
                If getColumnOfDate(msDate) > bis Or getColumnOfDate(msDate) < von Then
                    within = False
                Else
                    within = True
                End If
            End If
        End If

        milestoneWithinTimeFrame = within

    End Function


    ''' <summary>
    ''' sorgt dafür. daß Projekte immer im gleichen Muster angezeigt werden 
    ''' Erst sortiert nach BU, dann nach ProjektStart-Datum, dann nach Länge  
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function calcKennziffer(ByVal hproj As clsProjekt) As Double

        Dim wertigkeitBU As Integer = 100000
        Dim wertigkeitDate As Double = 100
        Dim wertigkeitLaenge As Double = 0.1
        Dim zwErg As Double = 0.0

        Dim found As Boolean = False
        Dim i As Integer = 1

        While i <= businessUnitDefinitions.Count And Not found

            If businessUnitDefinitions.ElementAt(i - 1).Value.name = hproj.businessUnit Then
                found = True
            Else
                i = i + 1
            End If

        End While

        zwErg = i * wertigkeitBU

        ' Berücksichtigung ProjektstartDatum 
        zwErg = zwErg + DateDiff(DateInterval.Day, StartofCalendar, hproj.startDate) / 30.4 * wertigkeitDate

        ' Berücksichtigung Länge
        zwErg = zwErg + hproj.dauerInDays / 30.4 * wertigkeitLaenge

        calcKennziffer = zwErg

    End Function


    ''' <summary>
    ''' kopiert eine Collection , die Strings enthält
    ''' </summary>
    ''' <param name="original"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function copyCollection(ByVal original As Collection) As Collection
        Dim i As Integer
        Dim element As String
        Dim kopie As New Collection

        If Not IsNothing(original) Then
            For i = 1 To original.Count
                element = CStr(original.Item(i))
                If Not kopie.Contains(element) Then
                    kopie.Add(element, element)
                End If

            Next
        End If
        copyCollection = kopie

    End Function



    ''' <summary>
    ''' kopiert eine sortierte Liste , die Strings enthält
    ''' </summary>
    ''' <param name="original"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function copyList(ByVal original As SortedList(Of String, String)) As SortedList(Of String, String)

        Dim element As String
        Dim kopie As New SortedList(Of String, String)

        If Not IsNothing(original) Then
            For Each kvp As KeyValuePair(Of String, String) In original
                element = kvp.Key
                If Not kopie.ContainsKey(element) Then
                    kopie.Add(element, kvp.Value)
                End If

            Next
        End If
        copyList = kopie

    End Function


    ''' <summary>
    ''' kopiert eine sortierte Liste , die Strings enthält
    ''' </summary>
    ''' <param name="original"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function copyColltoSortedList(ByVal original As Collection) As SortedList(Of String, String)
        Dim i As Integer
        Dim element As String
        Dim kopie As New SortedList(Of String, String)

        If Not IsNothing(original) Then
            For i = 1 To original.Count
                element = CStr(original.Item(i))
                If Not kopie.ContainsKey(element) Then
                    kopie.Add(element, element)
                End If

            Next
        End If
        copyColltoSortedList = kopie

    End Function

    ''' <summary>
    ''' kopiert eine sortierte Liste , die Strings enthält in eine Collection mit Strings
    ''' </summary>
    ''' <param name="original"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function copySortedListtoColl(ByVal original As SortedList(Of String, String)) As Collection

        Dim element As String
        Dim kopie As New Collection

        If Not IsNothing(original) Then
            For Each kvp As KeyValuePair(Of String, String) In original
                element = kvp.Value
                If Not kopie.Contains(element) Then
                    kopie.Add(element, element)
                End If

            Next
        End If
        copySortedListtoColl = kopie

    End Function

    ''' <summary>
    ''' addiert die Hierarchie hry zur bereits existierenden Super-Hierarchie
    ''' wenn die Super Hierarchie noch leer ist, wird die Rootphase angelegt 
    ''' </summary>
    ''' <param name="superHry"></param>
    ''' <remarks></remarks>
    Public Sub addToSuperHierarchy(ByRef superHry As clsHierarchy,
                                   ByVal hproj As clsProjekt,
                                   Optional vorlagenIndex As Integer = -1)

        Dim superNode As clsHierarchyNode
        Dim elemID As String
        Dim hry As clsHierarchy = hproj.hierarchy

        ' hier muss später noch ergänzt werden, dass evtl eine Vorlage übergeben werden kann 


        ' ist es eine 
        ' Starten mit dem Rootkey, der ist bei beiden definitiv nur einmal vorhanden und jeweils gleich 

        If superHry.count = 0 Then
            superHry = New clsHierarchy

            superNode = New clsHierarchyNode
            With superNode
                .elemName = elemNameOfElemID(rootPhaseName)
                .indexOfElem = 1 'eigentlich nicht relevant , wird einfach immer auf 1 gesetzt
                .parentNodeKey = ""
                '.origName = .elemName
            End With

            superHry.addNode(superNode, rootPhaseName)

        End If

        If IsNothing(hproj) Then
            Exit Sub
        ElseIf IsNothing(hry) Then
            Exit Sub
        ElseIf hry.count <= 1 Then
            Exit Sub
        End If


        ' Schleife über alle Elemente 

        For px As Integer = 1 To hproj.CountPhases

            Dim cphase As clsPhase = hproj.getPhase(px)

            If Not IsNothing(cphase) Then

                elemID = cphase.nameID
                Call addElementToSuperHry(hry, elemID, superHry)

                For mx As Integer = 1 To cphase.countMilestones

                    Dim cMilestone = cphase.getMilestone(mx)
                    If Not IsNothing(cMilestone) Then
                        elemID = cMilestone.nameID
                        Call addElementToSuperHry(hry, elemID, superHry)
                    End If

                Next

            End If



        Next
        'For ix As Integer = 1 To hry.count

        '    hrynode = hry.nodeItem(ix)
        '    curElemID = hry.getIDAtIndex(ix)
        '    curElemName = elemNameOfElemID(curElemID)
        '    isMilestone = elemIDIstMeilenstein(curElemID)
        '    breadcrumb = hry.getBreadCrumb(curElemID)
        '    Dim newBreadcrumb As String = ""

        '    If isMilestone Then
        '        elemIndices = superHry.getMilestoneHryIndices(curElemName, breadcrumb)
        '    Else
        '        elemIndices = superHry.getPhaseHryIndices(curElemName, breadcrumb)
        '    End If



        '    If elemIndices(0) > 0 Then
        '        ' dann wurde ein Element mit dem komplett identischen Breadcrumb gefunden; es ist also gar nichts zu tun 

        '    Else
        '        Dim ptr As Integer = 1
        '        Dim itemExists As Boolean = True
        '        parentNodeID = rootPhaseName
        '        bcItems = breadcrumb.Split((New Char() {CChar("#")}), 30)
        '        Dim anzahlEbenen As Integer = bcItems.Length - 1
        '        Dim lastFoundID As String = rootPhaseName

        '        Do While ptr <= anzahlEbenen And itemExists

        '            tmpElemName = bcItems(ptr)
        '            For i As Integer = 0 To ptr - 1
        '                If i = 0 Then
        '                    newBreadcrumb = "."
        '                Else
        '                    newBreadcrumb = newBreadcrumb & "#" & bcItems(i)
        '                End If

        '            Next

        '            elemIndices = superHry.getPhaseHryIndices(tmpElemName, newBreadcrumb)
        '            If elemIndices(0) > 0 Then
        '                itemExists = True
        '                ptr = ptr + 1
        '                parentNodeID = superHry.nodeItem(elemIndices(0)).parentNodeKey
        '                lastFoundID = superHry.getIDAtIndex(elemIndices(0))
        '            Else
        '                itemExists = False
        '                parentNodeID = lastFoundID
        '            End If

        '        Loop

        '        If ptr > anzahlEbenen Then
        '            parentNodeID = lastFoundID
        '        End If

        '        ' jetzt ist man an der Stelle angelangt, wo die Phase schon nicht mehr existiert 
        '        For i As Integer = ptr To anzahlEbenen
        '            tmpElemName = bcItems(i)
        '            ' lege die Phase an 
        '            superNode = New clsHierarchyNode
        '            With superNode
        '                .elemName = tmpElemName
        '                .parentNodeKey = parentNodeID
        '                .origName = ""
        '                .isMilestone = False ' es handelt sich hier noch um die Hierarchie-Stufen, also Phasen
        '                .indexOfElem = 1 ' eigentlich in diesem Kontext nicht relevant 
        '            End With
        '            elemID = superHry.findUniqueElemKey(tmpElemName, False)
        '            superHry.addNode(superNode, elemID)

        '            ' weiterschalten 
        '            parentNodeID = elemID
        '        Next

        '        ' jetzt muss noch das Element selber angelegt werde 
        '        superNode = New clsHierarchyNode
        '        With superNode
        '            .elemName = curElemName
        '            .parentNodeKey = parentNodeID
        '            .origName = ""
        '            .isMilestone = isMilestone  ' es handelt sich hier noch um die Hierarchie-Stufen, also Phasen
        '            .indexOfElem = 1 ' eigentlich in diesem Kontext nicht relevant 
        '        End With
        '        elemID = superHry.findUniqueElemKey(curElemName, False)
        '        superHry.addNode(superNode, elemID)

        '    End If



        'Next


    End Sub

    ''' <summary>
    ''' trägt das Element mit der übergebenen ElemID in die Super-Hierarchie ein  
    ''' </summary>
    ''' <param name="hry"></param>
    ''' <param name="elemID"></param>
    ''' <param name="superHry"></param>
    ''' <remarks></remarks>
    Private Sub addElementToSuperHry(ByVal hry As clsHierarchy, ByVal elemID As String, ByRef superHry As clsHierarchy)

        Dim hryNode As clsHierarchyNode
        Dim superNode As clsHierarchyNode
        Dim elemIndices() As Integer
        Dim curElemID As String
        Dim curElemName As String
        Dim breadcrumb As String
        Dim isMilestone As Boolean
        Dim parentNodeID As String

        Dim bcItems() As String
        Dim tmpElemName As String



        'hryNode = hry.nodeItem(ix)
        'curElemID = hry.getIDAtIndex(ix)
        hryNode = hry.nodeItem(elemID)
        curElemID = elemID
        curElemName = elemNameOfElemID(curElemID)
        isMilestone = elemIDIstMeilenstein(curElemID)
        breadcrumb = hry.getBreadCrumb(curElemID)

        Dim newBreadcrumb As String = ""

        If isMilestone Then
            elemIndices = superHry.getMilestoneHryIndices(curElemName, breadcrumb)
        Else
            elemIndices = superHry.getPhaseHryIndices(curElemName, breadcrumb)
        End If


        If elemIndices(0) > 0 Then
            ' dann wurde ein Element mit dem komplett identischen Breadcrumb gefunden; es ist also gar nichts zu tun 

        Else
            Dim ptr As Integer = 1
            Dim itemExists As Boolean = True
            parentNodeID = rootPhaseName
            bcItems = breadcrumb.Split((New Char() {CChar("#")}), 30)
            Dim anzahlEbenen As Integer = bcItems.Length - 1
            Dim lastFoundID As String = rootPhaseName

            Do While ptr <= anzahlEbenen And itemExists

                tmpElemName = bcItems(ptr)
                For i As Integer = 0 To ptr - 1
                    If i = 0 Then
                        newBreadcrumb = "."
                    Else
                        newBreadcrumb = newBreadcrumb & "#" & bcItems(i)
                    End If

                Next

                elemIndices = superHry.getPhaseHryIndices(tmpElemName, newBreadcrumb)
                If elemIndices(0) > 0 Then
                    itemExists = True
                    ptr = ptr + 1
                    parentNodeID = superHry.nodeItem(elemIndices(0)).parentNodeKey
                    lastFoundID = superHry.getIDAtIndex(elemIndices(0))
                Else
                    itemExists = False
                    parentNodeID = lastFoundID
                End If

            Loop

            If ptr > anzahlEbenen Then
                parentNodeID = lastFoundID
            End If

            ' jetzt ist man an der Stelle angelangt, wo die Phase schon nicht mehr existiert 
            For i As Integer = ptr To anzahlEbenen
                tmpElemName = bcItems(i)
                ' lege die Phase an 
                superNode = New clsHierarchyNode
                With superNode
                    .elemName = tmpElemName
                    .parentNodeKey = parentNodeID
                    ''.origName = ""
                    .indexOfElem = 1 ' eigentlich in diesem Kontext nicht relevant 
                End With
                curElemID = superHry.findUniqueElemKey(tmpElemName, False)
                superHry.addNode(superNode, curElemID)

                ' weiterschalten 
                parentNodeID = curElemID
            Next

            ' jetzt muss noch das Element selber angelegt werde 
            superNode = New clsHierarchyNode
            With superNode
                .elemName = curElemName
                .parentNodeKey = parentNodeID
                ''.origName = ""
                .indexOfElem = 1 ' eigentlich in diesem Kontext nicht relevant 
            End With
            curElemID = superHry.findUniqueElemKey(curElemName, isMilestone)
            superHry.addNode(superNode, curElemID)

        End If

    End Sub

    ''' <summary>
    ''' wird nur zum Aufsetzen von zufälligen Bewertungen in Demo-Szenarien benötigt ... 
    ''' alle nach dem übergebenen Datum liegenden Meilensteine werden neu auf Zufallsbasis bewertet 
    ''' alle vor dem Datum liegenden nur dann, wenn sie noch keine Bewertung haben 
    ''' 
    ''' </summary>
    ''' <param name="yellowPercentage">gibt an wieviele Meilensteine gelb bewertet werden sollen</param>
    ''' <param name="redPercentage">gibt an, wieviele Meilensteine rot bewertet werden sollen</param>
    ''' <param name="heute">gibt das Datum an, das als das heutige gelten soll</param> 
    ''' <remarks></remarks>
    Public Sub createInitialRandomBewertungen(ByVal yellowPercentage As Double, ByVal redPercentage As Double, ByVal heute As Date)

        Dim expl As String = "Erläuterung ..."
        Dim redBaseValue As Double = 0.3
        Dim yellowBaseValue As Double = 0.7
        Dim zufall As New Random(10)


        Dim allMilestones As Integer
        Dim redMilestones As Integer
        Dim yellowMilestones As Integer
        Dim greenMilestones As Integer
        Dim firstMS As Integer
        Dim lastMS As Integer
        Dim currentValue As Double
        Dim heuteColumn As Integer = getColumnOfDate(heute)

        If menuCult.Name = ReportLang(PTSprache.deutsch).Name Then
            expl = "Erläuterung ..."
        Else
            expl = "Explanation ..."
        End If

        For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

            allMilestones = 0
            redMilestones = 0
            yellowMilestones = 0
            greenMilestones = 0

            With kvp.Value
                firstMS = .hierarchy.getIndexOf1stMilestone
                lastMS = .hierarchy.count

                ' wenn es überhaupt keine Meilensteine gibt ...
                If firstMS = 0 Then
                    ' dann gar nichts machen, weiter mit nächstem Projekt 
                Else

                    For i As Integer = firstMS To lastMS
                        Dim msID As String = .hierarchy.getIDAtIndex(i)
                        Dim milestone As clsMeilenstein = .getMilestoneByID(msID)

                        If Not IsNothing(milestone) Then

                            Dim msColumn As Integer = getColumnOfDate(milestone.getDate)

                            If msColumn > heuteColumn Then



                                currentValue = zufall.NextDouble
                                With milestone
                                    If currentValue >= redBaseValue And
                                        currentValue <= redBaseValue + redPercentage Then

                                        Dim b As clsBewertung
                                        Dim tmpDescription As String
                                        If menuCult.Name = ReportLang(PTSprache.deutsch).Name Then
                                            tmpDescription = "Termin und Lieferumfänge nicht zu erreichen; " & vbLf &
                                                "Gründe:  ... " & vbLf & "Massnahmen: ...."
                                        Else
                                            tmpDescription = "Date and Deliverables will most probably not be achieved; " & vbLf &
                                                "Reasons:  ... " & vbLf & "Measures: ...."
                                        End If

                                        If .bewertungsCount = 0 Then
                                            b = New clsBewertung
                                            b.description = tmpDescription
                                            'b.color = awinSettings.AmpelRot
                                            b.colorIndex = PTfarbe.red
                                            .addBewertung(b)
                                        Else
                                            b = .getBewertung(1)
                                            b.description = tmpDescription
                                            'b.color = awinSettings.AmpelRot
                                            b.colorIndex = PTfarbe.red
                                        End If


                                        redMilestones = redMilestones + 1




                                    ElseIf currentValue >= yellowBaseValue And
                                        currentValue <= yellowBaseValue + yellowPercentage Then
                                        Dim b As clsBewertung
                                        Dim tmpDescription As String
                                        If menuCult.Name = ReportLang(PTSprache.deutsch).Name Then
                                            tmpDescription = "es gibt Risiken, Termin und Lieferumfänge zu erreichen;" & vbLf &
                                                "Risiken: ... " & vbLf & "Massnahmen: ..."
                                        Else
                                            tmpDescription = "there are risks to achieve date and deliverables;" & vbLf &
                                                "Risks: ... " & vbLf & "Measures: ..."
                                        End If


                                        If .bewertungsCount = 0 Then
                                            b = New clsBewertung
                                            b.description = tmpDescription
                                            'b.color = awinSettings.AmpelGelb
                                            b.colorIndex = PTfarbe.yellow
                                            .addBewertung(b)
                                        Else
                                            b = .getBewertung(1)
                                            b.description = tmpDescription
                                            'b.color = awinSettings.AmpelGelb
                                            b.colorIndex = PTfarbe.yellow
                                        End If


                                        yellowMilestones = yellowMilestones + 1



                                    Else
                                        Dim b As clsBewertung
                                        Dim tmpDescription As String
                                        If menuCult.Name = ReportLang(PTSprache.deutsch).Name Then
                                            tmpDescription = "Forecast für Termin / Qualität aktuell grün"
                                        Else
                                            tmpDescription = "positive Forecast for date and deliverables"
                                        End If


                                        If .bewertungsCount = 0 Then
                                            b = New clsBewertung
                                            b.description = tmpDescription
                                            'b.color = awinSettings.AmpelGruen
                                            b.colorIndex = PTfarbe.green
                                            .addBewertung(b)
                                        Else
                                            b = .getBewertung(1)
                                            b.description = tmpDescription
                                            'b.color = awinSettings.AmpelGruen
                                            b.colorIndex = PTfarbe.green
                                        End If


                                        greenMilestones = greenMilestones + 1


                                    End If


                                End With
                            Else
                                ' hier sind wir in der Vergangenheit : nur dann etwas tun, wenn der Meilenstein noch keine Bewertung hat 
                                ' oder aber eine graue Bewertung hat 
                                Dim b As clsBewertung
                                Dim tmpDescription As String



                                Dim notYetDone As Boolean = False
                                If milestone.bewertungsCount = 0 Then
                                    b = New clsBewertung
                                    notYetDone = True
                                Else
                                    b = milestone.getBewertung(1)
                                    If b.color = awinSettings.AmpelNichtBewertet Then
                                        notYetDone = True
                                    End If
                                End If

                                If notYetDone Then
                                    ' jetzt muss eine zufallsgesteuerte Bewertung her ...
                                    currentValue = zufall.NextDouble

                                    With milestone
                                        If currentValue >= redBaseValue And
                                            currentValue <= redBaseValue + redPercentage Then

                                            If menuCult.Name = ReportLang(PTSprache.deutsch).Name Then
                                                tmpDescription = "abgeschlossen: Ziele wurden in wesentlichen Umfängen reduziert, weil ..."
                                            Else
                                                tmpDescription = "finished: deliverables were reduced considerably, due to ..."
                                            End If

                                            If .bewertungsCount = 0 Then
                                                b.description = tmpDescription
                                                'b.color = awinSettings.AmpelRot
                                                b.colorIndex = PTfarbe.red
                                                .addBewertung(b)
                                            Else
                                                b.description = tmpDescription
                                                'b.color = awinSettings.AmpelRot
                                                b.colorIndex = PTfarbe.red
                                            End If


                                        ElseIf currentValue >= yellowBaseValue And
                                            currentValue <= yellowBaseValue + yellowPercentage Then

                                            If menuCult.Name = ReportLang(PTSprache.deutsch).Name Then
                                                tmpDescription = "abgeschlossen: Lieferumfänge/Ziele wurden in Absprache etwas reduziert, und zwar: ...."
                                            Else
                                                tmpDescription = "finished: deliverables were not achieved completely, due to ..."
                                            End If

                                            If .bewertungsCount = 0 Then
                                                b.description = tmpDescription
                                                'b.color = awinSettings.AmpelGelb
                                                b.colorIndex = PTfarbe.yellow
                                                .addBewertung(b)
                                            Else
                                                b = .getBewertung(1)
                                                b.description = tmpDescription
                                                'b.color = awinSettings.AmpelGelb
                                                b.colorIndex = PTfarbe.yellow
                                            End If



                                        Else

                                            If menuCult.Name = ReportLang(PTSprache.deutsch).Name Then
                                                tmpDescription = "abgeschlossen: alle Lieferumfänge / Ziele erfüllt"
                                            Else
                                                tmpDescription = "finished: all deliverables achieved"
                                            End If

                                            If .bewertungsCount = 0 Then
                                                b.description = tmpDescription
                                                'b.color = awinSettings.AmpelGruen
                                                b.colorIndex = PTfarbe.green
                                                .addBewertung(b)
                                            Else
                                                b = .getBewertung(1)
                                                b.description = tmpDescription
                                                'b.color = awinSettings.AmpelGruen
                                                b.colorIndex = PTfarbe.green
                                            End If


                                            greenMilestones = greenMilestones + 1


                                        End If


                                    End With
                                End If

                            End If
                        Else
                            ' Test-Stelle/Break Punkt setzen für Debug , hat sonst keine Bedeutung 
                            Dim checkDebug As Boolean = True
                        End If



                    Next

                End If

                Dim tmpDescription1 As String
                Dim tmpDescription2 As String
                Dim tmpDescription3 As String

                If menuCult.Name = ReportLang(PTSprache.deutsch).Name Then
                    tmpDescription3 = "aktuell sehr kritische Lage des Projektes" & vbLf &
                            "Gründe: ...." &
                            "Massnahmen: ...."
                    tmpDescription2 = "es gibt Risiken im weiteren Projektverlauf" & vbLf &
                            "Risiken: ...." &
                            "Massnahmen: ...."
                    tmpDescription1 = "aktuell alles plangemäß"
                Else
                    tmpDescription3 = "currently very critical project situation" & vbLf &
                            "Reasons: ...." &
                            "Measures: ...."
                    tmpDescription2 = "existing risks in project" & vbLf &
                            "Risks: ...." &
                            "Measures: ...."
                    tmpDescription1 = "currently positiv forecast for project"
                End If

                ' jetzt noch die Ampel-Farbe setzen 
                If redMilestones > 0 Then

                    If greenMilestones > 0 Then
                        If redMilestones / greenMilestones > 0.02 Then
                            .ampelErlaeuterung = tmpDescription3
                            .ampelStatus = 3
                        Else
                            .ampelErlaeuterung = tmpDescription2
                            .ampelStatus = 2
                        End If
                    Else
                        ' in diesem Fall wird es unmittelbar vor Projekt-Abschluss sein ... 
                        .ampelErlaeuterung = tmpDescription2
                        .ampelStatus = 2
                    End If


                ElseIf yellowMilestones > 0 Then
                    If greenMilestones > 0 Then

                        If yellowMilestones / greenMilestones > 0.05 Then
                            .ampelErlaeuterung = tmpDescription2
                            .ampelStatus = 2
                        Else
                            .ampelErlaeuterung = tmpDescription1
                            .ampelStatus = 1
                        End If
                    Else
                        .ampelErlaeuterung = tmpDescription2
                        .ampelStatus = 2
                    End If
                Else
                    .ampelErlaeuterung = tmpDescription1
                    .ampelStatus = 1
                End If

            End With

        Next

    End Sub


    ''' <summary>
    ''' es werden zufällig Phasen verschoben, verkürzt bzw. verlängert 
    ''' dadurch werden auch Meilensteine, die in den Phasen sind, vorgezogen oder nach hinten geschoben 
    ''' ausserdem werden dadurch auch Ressourcen durch die proportionale Anpassung weniger / mehr.  
    ''' es werden allerdings nur Phasen verlängert/verkürzt die
    ''' noch nicht beendet sind 
    ''' die bereits begonnen haben bzw. deren Start nicht weiter weg als 2 M ist.  
    ''' </summary>
    ''' <param name="shorterPercentage"></param>
    ''' <param name="longerPercentage"></param>
    ''' <param name="heute"></param>
    ''' <remarks></remarks>
    Public Sub createRandomChanges(ByVal shorterPercentage As Double, ByVal longerPercentage As Double, ByVal heute As Date)

        Dim expl As String = "Erläuterung ..."
        Dim redBaseValue As Double = 0.3
        Dim yellowBaseValue As Double = 0.7
        Dim zufall As New Random(10)

        Dim moveForward As Double = 0.1
        Dim moveBackward As Double = 0.8
        Dim makeItShorter As Double = 0.1
        Dim makeItLonger As Double = 0.8
        Dim currentValue As Double

        Dim cphase As clsPhase
        Dim previousSetting As Boolean = awinSettings.propAnpassRess
        Dim startColumn As Integer, endColumn As Integer
        Dim heuteColumn As Integer = getColumnOfDate(heute)

        ' bisheriges Setting merken 
        awinSettings.propAnpassRess = True

        For Each kvp As KeyValuePair(Of String, clsProjekt) In ShowProjekte.Liste

            With kvp.Value

                For pi As Integer = 1 To .CountPhases
                    cphase = .getPhase(pi)
                    startColumn = getColumnOfDate(cphase.getStartDate)
                    endColumn = getColumnOfDate(cphase.getEndDate)

                    ' wenn die Ausgangsbedingung für nach vorne /hinten verschieben zutrifft: noch nicht gestartet, aber Start weniger als 2 Monate entfernt  
                    If heuteColumn <= startColumn And heuteColumn + 2 >= startColumn Then
                        ' Start nach vorne bzw hinten verschieben
                        currentValue = zufall.NextDouble
                        If currentValue <= moveForward Then
                            Dim anzahlTage As Long = DateDiff(DateInterval.Day, heute, cphase.getStartDate)
                            If anzahlTage > 0 Then
                                Dim newStartOffset As Integer = cphase.startOffsetinDays - CInt(anzahlTage * currentValue)

                            End If


                        ElseIf currentValue >= moveBackward Then

                        End If
                    End If

                    ' wenn die Ausgangsbedingung für verkürzen / verlängern zutrifft: bereits gestartet, aber noch nicht beendet 
                Next

            End With

        Next

        ' altes Setting wiederherstellen 
        awinSettings.propAnpassRess = previousSetting

    End Sub

    ''' <summary>
    ''' Funktion, um die Kalenderwoche in aktuellen Länderset zu bestimmen 
    ''' </summary>
    ''' <param name="Datum"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function getKW(ByVal Datum As Date) As Integer
        Dim CUI As New CultureInfo(CultureInfo.CurrentCulture.Name)
        Return CUI.Calendar.GetWeekOfYear(Datum,
                CUI.DateTimeFormat.CalendarWeekRule,
                CUI.DateTimeFormat.FirstDayOfWeek)
    End Function

    ''' <summary>
    ''' Funktion, um die Kalenderwoche zu bestimmen 
    ''' </summary>
    ''' <param name="datum"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function calcKW(ByVal datum As Date) As Integer

        Dim kw As Integer

        kw = DatePart(DateInterval.WeekOfYear, datum, FirstDayOfWeek.Monday,
          FirstWeekOfYear.FirstFourDays)

        calcKW = kw

    End Function

    ''' <summary>
    ''' gibt den Schnittmengen-Array zurück, der Array tmpValues hat die Dimension pEnde-PStart
    ''' und stellt die Werte dar, die im Monat pStart .. PEnde gelten. 
    ''' Im Schnittmengen Array sind die Werte der Dimension bis-von
    ''' </summary>
    ''' <param name="von"></param>
    ''' <param name="bis"></param>
    ''' <param name="pStart"></param>
    ''' <param name="pEnde"></param>
    ''' <param name="tmpValues"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function calcArrayIntersection(ByVal von As Integer, ByVal bis As Integer,
                                              ByVal pStart As Integer, ByVal pEnde As Integer,
                                              ByVal tmpValues As Double()) As Double()
        Dim intersectionArray() As Double
        ReDim intersectionArray(bis - von)
        Dim startIX As Integer, endIX As Integer
        Dim sonderfall As Boolean = False
        Dim noOverlap As Boolean = False

        If pStart > bis Or von > pEnde Then
            ' es gibt überhaupt keine Überlappung 
            noOverlap = True

        ElseIf von = pStart And bis = pEnde Then
            startIX = 1
            endIX = tmpValues.Length

        ElseIf von <= pStart Then
            startIX = pStart - von + 1

            If bis <= pEnde Then
                endIX = startIX + bis - pStart
            Else
                ' bis ist größer als pEnde, es gilt das Gleiche wie oben  
                endIX = startIX + pEnde - pStart
            End If

            sonderfall = True

        Else
            ' von ist größer als pStart 
            startIX = von - pStart + 1

            If bis <= pEnde Then
                endIX = startIX + bis - von
            Else
                endIX = startIX + pEnde - von
            End If

        End If

        If noOverlap Then
            ' nichts tun 
        Else
            If sonderfall Then
                For i = startIX To endIX
                    intersectionArray(i - 1) = tmpValues(i - startIX)
                Next
            Else
                For i As Integer = startIX To endIX
                    intersectionArray(i - startIX) = tmpValues(i - 1)
                Next
            End If
        End If

        calcArrayIntersection = intersectionArray

    End Function

    ''' <summary>
    ''' wird benutzt, um die Anzahl Zeilen, die für die Darstellung einer Swimlane benötigt werden, zu minimieren
    ''' </summary>
    ''' <param name="matrix">ist so dimensioniert, dass es die maximale Anzahl Zeilen, die in einer Swimlane überhaupt vorkommen können, darstellen kann; 
    ''' matrix(i) enthält das letzte Datum, das in Zeile i vorkam; i läuft von 0 an</param>
    ''' <param name="bestStart" >enthält die Zeile, bis zu der nach oben gegangen werden kann; 0: die Swimlane selber; 
    ''' x: di ezeile, in der die (Groß-)Eltern Phase ist ... es soll keine 
    ''' keine Phase über ihrer Eltern-Phase gezeichnet werden </param>
    ''' <param name="maxZeile">das ist die bisher maximal aufgetretene Anzahl Zeilen, die notwendig war</param>
    ''' <param name="startdate">das Startdatum der neuen Phase</param>
    ''' <param name="requiredZeilen">die Anzahl Zeilen, die die Phase inkl ihrer Kinder benötigt</param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function findeBesteZeile(ByVal matrix() As Date, ByVal bestStart As Integer, ByVal maxZeile As Integer,
                                        ByVal startdate As Date,
                                        ByVal requiredZeilen As Integer) As Integer


        Dim dimension As Integer = matrix.Length - 1
        Dim found As Boolean

        Do While bestStart <= dimension And Not found

            found = True
            For i As Integer = 1 To requiredZeilen
                If bestStart + i - 1 <= dimension Then
                    found = found And (matrix(bestStart + i - 1) <= startdate)
                End If
            Next

            If Not found Then
                bestStart = bestStart + 1
            End If

        Loop

        If found Then
            findeBesteZeile = bestStart + 1
        Else
            findeBesteZeile = maxZeile + 1
        End If

    End Function

    ''' <summary>
    ''' gibt Menge aller auftretenden Rollen NameIDs der Form roleID;teamID oder roleID in hproj, lproj, bproj zurück 
    ''' wird unter anderem für die TableBudgetCostAPVCV benötigt
    ''' dabei wird auch berücksichtigt, ob es sich um eine Rolle 'RessourceManager'> handelt; denn der darf nur die eigenen Leute sehen
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="lproj"></param>
    ''' <param name="bproj"></param>
    ''' <returns></returns>
    Public Function getCommonListOfRoleNameIDs(ByVal hproj As clsProjekt, ByVal lproj As clsProjekt, ByVal bproj As clsProjekt) As Collection

        ' bestimme die Menge an vorkommenden Role-NameIDs in hproj, lproj, bproj
        ' tmpRListe nimmt jetzt roleNameIDs der Form roleID;teamID auf 
        Dim resultCollection As New Collection
        Dim tmpRListe As New SortedList(Of Integer, String)
        Dim includingVirtualChilds As Boolean = False

        'Dim onlyConsiderTeamMembers As Boolean = False
        If myCustomUserRole.customUserRole = ptCustomUserRoles.RessourceManager Or myCustomUserRole.customUserRole = ptCustomUserRoles.TeamManager Then
            includingVirtualChilds = True
        End If

        Dim sRoles As New Collection

        For i As Integer = 1 To 3
            If i = 1 Then
                sRoles = hproj.getRoleNameIDs
            ElseIf i = 2 Then
                If Not IsNothing(lproj) Then
                    sRoles = lproj.getRoleNameIDs
                Else
                    sRoles = New Collection
                End If
            Else
                If Not IsNothing(bproj) Then
                    sRoles = bproj.getRoleNameIDs
                Else
                    sRoles = New Collection
                End If
            End If

            For Each tmpRNameID As String In sRoles

                If myCustomUserRole.isAllowedToSee(tmpRNameID, includingVirtualChilds:=includingVirtualChilds) Then
                    Dim posIX As Integer = RoleDefinitions.getPositionIndex(tmpRNameID)
                    If Not tmpRListe.ContainsKey(posIX) Then
                        tmpRListe.Add(posIX, tmpRNameID)
                    End If
                End If

                'End If


            Next


        Next

        ' jetzt muss umkopiert werden - das war alles notwendig, um die Sortierung in der Collection zu behalten 
        For Each kvp As KeyValuePair(Of Integer, String) In tmpRListe

            'If Not resultCollection.Contains(kvp.Key) Then
            '    resultCollection.Add(kvp.Key, kvp.Key)
            'End If
            ' tk 25.7.19
            ' damit wird jetzt die Reihenfolge erhalten 
            resultCollection.Add(kvp.Value)

        Next

        getCommonListOfRoleNameIDs = resultCollection

    End Function

    ''' <summary>
    ''' 
    ''' </summary>
    ''' <param name="hproj"></param>
    ''' <param name="lproj"></param>
    ''' <param name="bproj"></param>
    ''' <returns></returns>
    Public Function getCommonListOfCostNames(ByVal hproj As clsProjekt, ByVal lproj As clsProjekt, ByVal bproj As clsProjekt) As Collection

        Dim resultCollection As New Collection

        ' bestimme die Menge an vorkommenden Namen in hproj, lproj, bproj
        ' tmpCListe nimmt jetzt die Kostenarten der Form Name of Kostenart 

        Dim tmpCListe As New SortedList(Of Integer, String)

        Dim sCosts As New Collection

        For i As Integer = 1 To 3
            If i = 1 Then
                sCosts = hproj.getCostNames
            ElseIf i = 2 Then
                If Not IsNothing(lproj) Then
                    sCosts = lproj.getCostNames
                Else
                    sCosts = New Collection
                End If
            Else
                If Not IsNothing(bproj) Then
                    sCosts = bproj.getCostNames
                Else
                    sCosts = New Collection
                End If
            End If


            For Each tmpCName As String In sCosts
                Dim tmpUiD As Integer = CostDefinitions.getCostdef(tmpCName).UID
                If Not tmpCListe.ContainsKey(tmpUiD) Then
                    tmpCListe.Add(tmpUiD, tmpCName)
                End If
            Next

        Next

        For Each kvp As KeyValuePair(Of Integer, String) In tmpCListe

            If Not resultCollection.Contains(kvp.Value) Then
                resultCollection.Add(kvp.Value, kvp.Value)
            End If

        Next

        getCommonListOfCostNames = resultCollection


    End Function



End Module
